<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>Apache FreeMarker Manual</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header>
<h1 class="title">Apache FreeMarker Manual</h1>
</header>
<h1 id="preface">What is Apache FreeMarker?</h1>
<p>FreeMarker is a <em>template engine</em>: a generic tool to generate text output (HTML web pages, e-mails, configuration files, source code, etc.) based on templates and changing data. It's not an application for end-users in itself, but a Java library, a component that programmers can embed into their products.</p>
<p>Templates are written in the FreeMarker Template Language (FTL). It's a simple, specialized language, <em>not</em> a full-blown programming language like PHP. You are meant to prepare the data to display in a real programming language, like issue database queries and do business calculations, and then the template displays that already prepared data. In the template you are focusing on how to present the data, and outside the template you are focusing on what data to present.</p>
<p><img src="figures/overview.png" /></p>
<p>This approach is often referred to as the <a href="#gloss.MVC">MVC (Model View Controller) pattern</a>, and is particularly popular for dynamic web pages. It helps in separating web page designers (HTML authors) from developers (Java programmers usually). Designers won't face complicated logic in templates, and can change the appearance of a page without programmers having to change or recompile code.</p>
<p>While FreeMarker was originally created for generating HTML pages in MVC web application frameworks, it isn't bound to servlets or HTML or anything web-related. It's used in non-web application environments as well.</p>
<p>FreeMarker is <a href="http://www.fsf.org/philosophy/free-sw.html">Free</a>, released under the Apache License, Version 2.0.</p>
<p><strong>Disclaimer:</strong><em>Apache FreeMarker is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the <a href="http://incubator.apache.org">Apache Incubator</a>. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</em></p>
<h1 id="dgui_quickstart">Getting Started</h1>
<p>This chapter is a very rough introduction to FreeMarker. The chapters after this will go over things in much greater detail. Nonetheless, once you have read this chapter, you will be able to write simple but useful FreeMarker templates.</p>
<h2 id="dgui_quickstart_basics">Template + data-model = output</h2>
<p>Let's assume that you need a HTML page on a website, similar to this:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Welcome!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Welcome John Doe!&lt;/h1&gt;
  &lt;p&gt;Our latest product:
  &lt;a href=&quot;products/greenmouse.html&quot;&gt;green mouse&lt;/a&gt;!
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>But the user's name (&quot;John Doe&quot; above) depends on who the logged-in user is, and the latest product information should come from a database. Because this data changes, you cannot you cannot use static HTML. Instead, you can use a <em>template</em> of the desired output. The template is the same as the static HTML would be, except that it contains some instructions to FreeMarker that makes it dynamic:</p>
<pre id="example.first"><code>&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Welcome!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Welcome ${user}!&lt;/h1&gt;
  &lt;p&gt;Our latest product:
  &lt;a href=&quot;${latestProduct.url}&quot;&gt;${latestProduct.name}&lt;/a&gt;!
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>The template is stored on the Web server, usually just like the static HTML page would be. But whenever someone visits this page, FreeMarker will step in and transform the template on-the-fly to plain HTML by replacing the <code>${...}</code>-s with up-to-date content, and send the result to the visitor's Web browser. So the visitor's Web browser will receive something like the first example HTML (i.e., plain HTML without FreeMarker instructions), and it will not perceive that FreeMarker is used on the server. (Of course, the template file stored on the Web server is not changed by this; the substitutions only appear in the Web server's response.)</p>
<p>Note that the template doesn't contain the programming logic to find out who the current visitor is, or to query the database to get the latest product. The data to be displayed is prepared outside FreeMarker, usually by parts written in some “real” programming language like Java. The template author needn't know how these values were calculated. In fact, the way these values are calculated can be completely changed while the templates can remain exactly the same, and also, the look of the page can be completely changed without touching anything but the template. This separation of presentation logic and business logic can be especially useful when the template authors (designers) and the programmers are different individuals, but also helps managing application complexity if they are the same person. Keeping templates focused on presentation issues (visual design, layout and formatting) is a key for using template engines like FreeMarker efficiently.</p>
<p>data-modelThe totality of data that was prepared for the template is called the <em>data-model</em>. As far as the template author is concerned, the data-model is a tree-like structure (like folders and files on your hard disk), which, in this case, could be visualized as:</p>
<pre><code>(root)
  |
  +- user = &quot;Big Joe&quot;
  |
  +- latestProduct
      |
      +- url = &quot;products/greenmouse.html&quot;
      |
      +- name = &quot;green mouse&quot;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>The above is just a visualization; the data-model is not in a textual format, it's from Java objects. For the Java programmers, the root is perhaps a Java object with <code>getUser()</code> and <code>getLatestProduct()</code> methods, or maybe a Java <code>Map</code> with <code>&quot;user&quot;</code> and <code>&quot;latestProducts&quot;</code> keys. Similarly, <code>latestProduct</code> is perhaps a Java Object with <code>getUrl()</code> and <code>getName()</code> methods.</p>
</blockquote>
<p>Earlier, you have picked values from this data-model, with the <code>user</code> and <code>latestProduct.name</code> expressions. If we go on with the analogy that the data model is like a file system, then “(root)” and <code>latestProduct</code> correspond to directories (folders), and <code>user</code>, <code>url</code> and <code>name</code> are files in those directories.</p>
<p>To recapitulate, a template and a data-model is needed for FreeMarker to generate the output (like the HTML shown first):</p>
<p>Template + data-model = output</p>
<h2 id="dgui_quickstart_datamodel">The data-model at a glance</h2>
<p>As you have seen, the data-model is basically a tree. This tree can be arbitrarily complicated and deep, for example:</p>
<pre id="example.qStart.dataModelWithHashes"><code>(root)
  |
  +- animals
  |   |
  |   +- mouse
  |   |   |
  |   |   +- size = &quot;small&quot;
  |   |   |
  |   |   +- price = 50
  |   |
  |   +- elephant
  |   |   |
  |   |   +- size = &quot;large&quot;
  |   |   |
  |   |   +- price = 5000
  |   |
  |   +- python
  |       |
  |       +- size = &quot;medium&quot;
  |       |
  |       +- price = 4999
  |
  +- message = &quot;It is a test&quot;
  |
  +- misc
      |
      +- foo = &quot;Something&quot;</code></pre>
<p>The variables that act like directories (the root, <code>animals</code>, <code>mouse</code>, <code>elephant</code>, <code>python</code>, <code>misc</code>) are called <em>hashes</em>. Hashes store other variables (the so called <em>sub variables</em>) by a lookup name (e.g., “animals”, “mouse” or “price”).</p>
<p>The variables that store a single value (<code>size</code>, <code>price</code>, <code>message</code> and <code>foo</code>) are called <em>scalars</em>.</p>
<p>When you want to use a subvariable in a template, you specify its path from the root, and separate the steps with dots. To access the <code>price</code> of a <code>mouse</code>, you start from the root and go into <code>animals</code>, and then go into <code>mouse</code> then go into <code>price</code>. So you write <code>animals.mouse.price</code>.</p>
<p>Another important kind of variables are <em>sequences</em>. They store subvariables like hashes, but here subvariables doesn't have a name, they are just items in a list. For example, in this data-model, <code>animals</code> and <code>misc.fruits</code> are sequences:</p>
<pre id="example.qStart.dataModelWithSequences"><code>(root)
  |
  +- animals
  |   |
  |   +- (1st)
  |   |   |
  |   |   +- name = &quot;mouse&quot;
  |   |   |
  |   |   +- size = &quot;small&quot;
  |   |   |
  |   |   +- price = 50
  |   |
  |   +- (2nd)
  |   |   |
  |   |   +- name = &quot;elephant&quot;
  |   |   |
  |   |   +- size = &quot;large&quot;
  |   |   |
  |   |   +- price = 5000
  |   |
  |   +- (3rd)
  |       |
  |       +- name = &quot;python&quot;
  |       |
  |       +- size = &quot;medium&quot;
  |       |
  |       +- price = 4999
  |
  +- misc
      |
      +- fruits
          |
          +- (1st) = &quot;orange&quot;
          |
          +- (2nd) = &quot;banana&quot;</code></pre>
<p>To access a subvariable of a sequence you use a numerical index in square brackets. Indexes start from 0 (it's a programmer tradition to start with 0), thus the index of the 1st item is 0, the index of the 2nd item is 1, and so on. So to get the name of the first animal you write <code>animals[0].name</code>. To get the second item in <code>misc.fruits</code> (the string <code>&quot;banana&quot;</code>) you write <code>misc.fruits[1]</code>. (In practice, you usually just walk through sequences in order, not caring about the index, but that will be <a href="#topic.tutorial.list">shown later</a>.)</p>
<p>Scalars can be further divided into these categories:</p>
<ul>
<li><p>String: Text, that is, an arbitrary sequence of characters such as ''m'', ''o'', ''u'', ''s'', ''e'' above. For example the <code>name</code>-s and <code>size</code>-s are strings above.</p></li>
<li><p>Number: It's a numerical value, like the <code>price</code>-s above. The string <code>&quot;50&quot;</code> and the number <code>50</code> are two totally different things in FreeMarker. The former is just a sequence of two characters (which happens to be readable as a number for humans), while the latter is a numerical value that you can use in arithmetical calculations.</p></li>
<li><p>Date-like: Either a date-time (stores a date with time of the day), or a date (no time of day), or a time (time of day, no date).</p></li>
<li><p>Boolean: A true/false (yes/no, on/off, etc.) thing. Like animals could have a <code>protected</code> subvariable, which store if the animal is protected or not.</p></li>
</ul>
<p>Summary:</p>
<ul>
<li><p>The data-model can be visualized as a tree.</p></li>
<li><p>Scalars store a single value. The value can be a string or a number or a date-time/date/time or a boolean.</p></li>
<li><p>Hashes are containers that store other variables and associate them with a unique lookup name.</p></li>
<li><p>Sequences are containers that store other variables in an ordered sequence. The stored variables can be retrieved via their numerical index, starting from 0.</p></li>
</ul>
<blockquote>
<p><strong>Note</strong></p>
<p>There are other, more advanced value types that we don't cover here, such as methods and directives.</p>
</blockquote>
<h2 id="dgui_quickstart_template">The template at a glance</h2>
<p>The simplest template is a plain HTML file (or whatever text file; FreeMarker is not confined to HTML). When the client visits that page, FreeMarker will send that HTML to the client as is. However if you want that page to be more dynamic then you begin to put special parts into the HTML which will be understood by FreeMarker:</p>
<ul>
<li><p><code>${...}</code>: FreeMarker will replace it in the output with the actual value of the expression inside the curly brackets. They are called <em>interpolation</em>s.</p></li>
<li><p><em>FTL tags</em> (for FreeMarker Template Language tags): FTL tags are a bit similar to HTML tags, but they are instructions to FreeMarker and will not be printed to the output. The name of these tags start with <code>#</code>. (User-defined FTL tags use <code>@</code> instead of <code>#</code>, but they are an advanced topic.)</p></li>
<li><p><em>Comments:</em> Comments are similar to HTML comments, but they are delimited by <code>&lt;#--</code> and <code>--&gt;</code>. Unlike HTML comments, FTL comments won't get into the output (won't be visible in the page source for the visitor), because FreeMarker skips them.</p></li>
</ul>
<p>Anything not an FTL tag or an interpolation or comment is considered static text and will not be interpreted by FreeMarker; it is just printed to the output as-is.</p>
<p>With FTL tags you refer to so-called <em>directives</em>. This is the same kind of relationship as between HTML tags (e.g.: <code>&lt;table&gt;</code> and <code>&lt;/table&gt;</code>) and HTML elements (e.g., the <code>table</code> element) to which you refer to with the HTML tags. (If you don't understand this difference then consider &quot;FTL tag&quot; and &quot;directive&quot; synonyms.)</p>
<blockquote>
<p><strong>Note</strong></p>
<p>You can easily try writing templates on <a href="http://freemarker-online.kenshoo.com/" class="uri">http://freemarker-online.kenshoo.com/</a></p>
</blockquote>
<h3>Some basic directives</h3>
<p>Here we will look at some of the most commonly used directives (<a href="#ref_directives">but there are much more</a>).</p>
<h4>The if directive</h4>
<p>With the <code>if</code> directive you can conditionally skip a section of the template. For example, assume that in the <a href="#example.first">very first example</a> you want to greet your boss, Big Joe, differently than other users:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Welcome!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;
    Welcome ${user}&lt;#if user == &quot;Big Joe&quot;&gt;, our beloved leader&lt;/#if&gt;!
  &lt;/h1&gt;
  &lt;p&gt;Our latest product:
  &lt;a href=&quot;${latestProduct.url}&quot;&gt;${latestProduct.name}&lt;/a&gt;!
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>Here you have told FreeMarker that the “, our beloved leader” should be there only if the value of the variable <code>user</code> is equal to the string <code>&quot;Big
            Joe&quot;</code>. In general, things between <code>&lt;#if
            condition&gt;</code> and <code>&lt;/#if&gt;</code> tags are skipped if <code>condition</code> is false (the boolean value).</p>
<p>Let's look at <code>condition</code> more closely: <code>==</code> is an operator that tests if the values at its left and right side are equivalent, and the results is a boolean value, true or false accordingly. On the left side of <code>==</code> I have <a href="#topic.qStart.accessVariables">referenced a variable</a> with the syntax that should be already familiar; this will be replaced with the value of the variable. In general, unquoted words inside directives or interpolations are treated as references to variables. On the right side I have specified a literal string. Literal strings in templates must <em>always</em> be put inside quotation marks.</p>
<p>This will print “Pythons are free today!” if their price is 0:</p>
<pre><code>&lt;#if animals.python.price == 0&gt;
  Pythons are free today!
&lt;/#if&gt;</code></pre>
<p>Similarly as earlier when a string was specified directly, here a number is specified directly (<code>0</code>). Note that the number is <em>not</em> quoted. If you quoted it (<code>&quot;0&quot;</code>), FreeMarker would misinterpret it as a string literal, and because the price to compare it to is a number, you get an error.</p>
<p>This will print &quot;Pythons are not free today!&quot; if their price is not 0:</p>
<pre><code>&lt;#if animals.python.price != 0&gt;
  Pythons are not free today!
&lt;/#if&gt;</code></pre>
<p>As you probably guessed, <code>!=</code> means “not equals”.</p>
<p>You can write things like this too (using <a href="#example.qStart.dataModelWithHashes">the data-model used to demonstrate hashes</a>):</p>
<pre><code>&lt;#if animals.python.price &lt; animals.elephant.price&gt;
  Pythons are cheaper than elephants today.
&lt;/#if&gt;</code></pre>
<p>With the <code>&lt;#else&gt;</code> tag you can specify what to do if the condition is false. For example:</p>
<pre><code>&lt;#if animals.python.price &lt; animals.elephant.price&gt;
  Pythons are cheaper than elephants today.
&lt;#else&gt;
  Pythons are not cheaper than elephants today.
&lt;/#if&gt;</code></pre>
<p>This prints “Pythons are cheaper than elephants today.” if the price of python is less than the price of elephant, or else it prints “Pythons are not cheaper than elephants today.” You can refine this further by using <code>elseif</code>:</p>
<pre><code>&lt;#if animals.python.price &lt; animals.elephant.price&gt;
  Pythons are cheaper than elephants today.
&lt;#elseif animals.elephant.price &lt; animals.python.price&gt;
  Elephants are cheaper than pythons today.
&lt;#else&gt;
  Elephants and pythons cost the same today.
&lt;/#if&gt;</code></pre>
<p>If you have a variable with boolean value (a true/false thing) then you can use it directly as the <code>condition</code> of <code>if</code>:</p>
<pre><code>&lt;#if animals.python.protected&gt;
  Pythons are protected animals!
&lt;/#if&gt;</code></pre>
<h4>The list directive</h4>
<p>This is needed when you want to list something. For example if you merge this template with the <a href="#example.qStart.dataModelWithSequences">data-model used earlier to demonstrate sequences</a>:</p>
<pre><code>&lt;p&gt;We have these animals:
&lt;table border=1&gt;
  &lt;#list animals as animal&gt;
    &lt;tr&gt;&lt;td&gt;${animal.name}&lt;td&gt;${animal.price} Euros
  &lt;/#list&gt;
&lt;/table&gt;</code></pre>
<p>then the output will be:</p>
<pre><code>&lt;p&gt;We have these animals:
&lt;table border=1&gt;
    &lt;tr&gt;&lt;td&gt;mouse&lt;td&gt;50 Euros
    &lt;tr&gt;&lt;td&gt;elephant&lt;td&gt;5000 Euros
    &lt;tr&gt;&lt;td&gt;python&lt;td&gt;4999 Euros
&lt;/table&gt;</code></pre>
<p>The generic form of the <code>list</code> directive is:<code> &lt;#list sequence as
            loopVariable&gt;repeatThis&lt;/#list&gt;</code>. The <code>repeatThis</code> part will be repeated for each item in the sequence that you have specified with <code>sequence</code>, one after the other, starting from the first item. In all repetitions <code>loopVariable</code> will hold the value of the current item. This variable exists only between the <code>&lt;#list
            ...&gt;</code> and <code>&lt;/#list&gt;</code> tags.</p>
<p>The <code>sequence</code> can be any kind of expression. For example we could list the fruits of the example data model like this:</p>
<pre><code>&lt;ul&gt;
&lt;#list misc.fruits as fruit&gt;
  &lt;li&gt;${fruit}
&lt;/#list&gt;
&lt;/ul&gt;</code></pre>
<p>The <code>misc.fruits</code> expression should be familiar to you; it <a href="#topic.qStart.accessVariables">references a variable in the data-model</a>.</p>
<p>A problem with the above example is that if we happen to have 0 fruits, it will still print an empty <code>&lt;ul&gt;&lt;/ul&gt;</code> instead of just nothing. To avoid that, you can use this form of <code>list</code>:</p>
<pre><code>&lt;#list misc.fruits&gt;
  &lt;ul&gt;
    &lt;#items as fruit&gt;
      &lt;li&gt;${fruit}
    &lt;/#items&gt;
  &lt;/ul&gt;
&lt;/#list&gt;</code></pre>
<p>Here, the <code>list</code> directive represents the listing as a whole, and only the part inside the <code>items</code> directive is repeated for each fruit. If we have 0 fruits, everything inside <code>list</code> is skipped, hence we will not have <code>ul</code> tags in case.</p>
<p>Another frequent listing-related task: let's list the fruits separating them with something, like a comma:</p>
<pre><code>&lt;p&gt;Fruits: &lt;#list misc.fruits as fruit&gt;${fruit}&lt;#sep&gt;, &lt;/#list&gt;</code></pre>
<pre><code>&lt;p&gt;Fruits: orange, banana</code></pre>
<p>The section covered by <code>sep</code> (which we could be written like this too: <code>...&lt;#sep&gt;,
            &lt;/#sep&gt;&lt;/#list&gt;</code>) will be only executed when there will be a next item. Hence there's no comma after the last fruit.</p>
<p>Here again, what if we have 0 fruits? Just printing “Fruits:” and then nothing is awkward. A <code>list</code>, just like an <code>if</code>, can have an <code>else</code>, which is executed if there were 0 list items:</p>
<pre><code>&lt;p&gt;Fruits: &lt;#list misc.fruits as fruit&gt;${fruit}&lt;#sep&gt;, &lt;#else&gt;None&lt;/#list&gt;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>As a matter of fact, this simplistic example could be written like this, but it uses language devices that are off topic here:</p>
<pre><code>&lt;p&gt;Fruits: ${fruits?join(&quot;, &quot;, &quot;None&quot;)}</code></pre>
</blockquote>
<p>All these directives (<code>list</code>, <code>items</code>, <code>sep</code>, <code>else</code>) can be used together:</p>
<pre><code>&lt;#list misc.fruits&gt;
  &lt;p&gt;Fruits:
  &lt;ul&gt;
    &lt;#items as fruit&gt;
      &lt;li&gt;${fruit}&lt;#sep&gt; and&lt;/#sep&gt;
    &lt;/#items&gt;
  &lt;/ul&gt;
&lt;#else&gt;
  &lt;p&gt;We have no fruits.
&lt;/#list&gt;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>You can read more about these directives <a href="#ref_directive_list">in the Reference</a>.</p>
</blockquote>
<h4>The include directive</h4>
<p>With the <code>include</code> directive you can insert the content of another file into the template.</p>
<p>Suppose you have to show the same copyright notice on several pages. You can create a file that contains the copyright notice only, and insert that file everywhere where you need that copyright notice. Say, you store this copyright notice in <code>copyright_footer.html</code>:</p>
<pre><code>&lt;hr&gt;
&lt;i&gt;
Copyright (c) 2000 &lt;a href=&quot;http://www.acmee.com&quot;&gt;Acmee Inc&lt;/a&gt;,
&lt;br&gt;
All Rights Reserved.
&lt;/i&gt;</code></pre>
<p>Whenever you need that file you simply insert it with the <code>include</code> directive:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Test page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Test page&lt;/h1&gt;
  &lt;p&gt;Blah blah...
  &lt;#include &quot;/copyright_footer.html&quot;&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>and the output will be:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Test page&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Test page&lt;/h1&gt;
  &lt;p&gt;Blah blah...
&lt;hr&gt;
&lt;i&gt;
Copyright (c) 2000 &lt;a href=&quot;http://www.acmee.com&quot;&gt;Acmee Inc&lt;/a&gt;,
&lt;br&gt;
All Rights Reserved.
&lt;/i&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>If you change the <code>copyright_footer.html</code>, then the visitor will see the new copyright notice on all pages.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>A much more powerful way of reusing snippets is using macros, but that's an advanced topic <a href="#dgui_misc_userdefdir">discussed later</a>.</p>
</blockquote>
<h3>Using directives together</h3>
<p>You can use directives as many times on a page as you want, and you can nest directives into each other freely. For example, here you nest <code>if</code> directive inside a <code>list</code> directive:</p>
<pre><code>&lt;#list animals as animal&gt;
      &lt;div&lt;#if animal.protected&gt; class=&quot;protected&quot;&lt;/#if&gt;&gt;
        ${animal.name} for ${animal.price} Euros
      &lt;/div&gt;
&lt;/#list&gt;</code></pre>
<p>Note that since FreeMarker does not interpret text outside FTL tags, interpolations and FTL comments, above you could use the FTL tags inside HTML attributes without problem.</p>
<h3>Using built-ins</h3>
<p>The so-called built-ins are like subvariables (or rather like methods, if you know that Java term) that aren't coming from the data-model, but added by FreeMarker to the values. In order to make it clear where subvariables comes from, you have to use <code>?</code> (question mark) instead of <code>.</code> (dot) to access them. Examples with some of the most commonly used built-ins:</p>
<ul>
<li><p><code>user?upper_case</code> gives the upper case version of the value of <code>user</code> (like “JOHN DOE” instead of “John Doe”)</p></li>
<li><p><code>animal.name?cap_first</code> give the <code>animal.name</code> with its first letter converted to upper case (like “Mouse” instead of “mouse”)</p></li>
<li><p><code>user?length</code> gives the number of <em>characters</em> in the value of <code>user</code> (8 for “John Doe”)</p></li>
<li><p><code>animals?size</code> gives the number of <em>items</em> in the <code>animals</code> sequence (3 in our example data-model)</p></li>
<li><p>If you are between <code>&lt;#list animals as
              animal&gt;</code> and the corresponding <code>&lt;/#list&gt;</code> tag:</p>
<ul>
<li><p><code>animal?index</code> gives the 0-based index of <code>animal</code> inside <code>animals</code></p></li>
<li><p><code>animal?counter</code> is like <code>index</code>, but gives the 1-based index</p></li>
<li><p><code>animal?item_parity</code> gives the strings “odd” or “even”, depending on the current counter parity. This is commonly used for coloring rows with alternating colors, like in <code>&lt;td
                  class=&quot;${animal?item_parity}Row&quot;&gt;</code>.</p></li>
</ul></li>
</ul>
<p>Some built-ins require parameters to specify the behavior more, for example:</p>
<ul>
<li><p><code>animal.protected?string(&quot;Y&quot;, &quot;N&quot;)</code> return the string “Y” or “N” depending on the boolean value of <code>animal.protected</code>.</p></li>
<li><p><code>animal?item_cycle('lightRow',
              'darkRow')</code> is the more generic variant of <code>item_parity</code> from earlier.</p></li>
<li><p><code>fruits?join(&quot;, &quot;)</code>: converts the list to a string by concatenating items, and inserting the parameter separator between each items (like “orange, banana”)</p></li>
<li><p><code>user?starts_with(&quot;J&quot;)</code> gives boolean true of false depending on if <code>user</code> starts with the letter “J” or not.</p></li>
</ul>
<p>Built-in applications can be chained, like <code>fruits?join(&quot;, &quot;)?upper_case</code> will first convert the list a to a string, then converts it to upper case. (This is just like you can chain <code>.</code>-s (dots) too.)</p>
<p>You can find the <a href="#ref_builtins">full set of built-ins in the Reference</a>.</p>
<h3>Dealing with missing variables</h3>
<p>The data-model often has variables that are optional (i.e., sometimes missing). To spot some typical human mistakes, FreeMarker doesn't tolerate references to missing variables unless you tell explicitly what to do if the variable is missing. Here we will show the two most typical ways of doing that.</p>
<p>Note for programmers: A non-existent variable and a variable with <code>null</code> value is the same for FreeMarker. The &quot;missing&quot; term used here covers both cases.</p>
<p>Wherever you refer to a variable, you can specify a default value for the case the variable is missing by following the variable name with a <code>!</code> and the default value. Like in the following example, when <code>user</code> is missing from data model, the template will behave like if <code>user</code>'s value were the string <code>&quot;visitor&quot;</code>. (When <code>user</code> isn't missing, this template behaves exactly like with <code>${user}</code>):</p>
<pre><code>&lt;h1&gt;Welcome ${user!&quot;visitor&quot;}!&lt;/h1&gt;</code></pre>
<p>You can ask whether a variable isn't missing by putting <code>??</code> after its name. Combining this with the already introduced <code>if</code> directive you can skip the whole greeting if the <code>user</code> variable is missing:</p>
<pre><code>&lt;#if user??&gt;&lt;h1&gt;Welcome ${user}!&lt;/h1&gt;&lt;/#if&gt;</code></pre>
<p>Regarding variable accessing with multiple steps, like <code>animals.python.price</code>, writing <code>animals.python.price!0</code> is correct only if <code>animals.python</code> is never missing and only the last subvariable, <code>price</code>, is possibly missing (in which case here we assume it's <code>0</code>). If <code>animals</code> or <code>python</code> is missing, the template processing will stop with an &quot;undefined variable&quot; error. To prevent that, you have to write <code>(animals.python.price)!0</code>. In that case the expression will be <code>0</code> even if <code>animals</code> or <code>python</code> is missing. Same logic goes for <code>??</code>; <code>animals.python.price??</code> versus <code>(animals.python.price)??</code>.</p>
<h3 id="dgui_quickstart_template_autoescaping">Escaping for HTML, XML and other markup</h3>
<p>Let's say the template generates HTML, and you insert values with <code>${...}</code> that are plain text (not HTML), like company names coming from a database. Characters that has special meaning in HTML must be <em>escaped</em> in such values, like if <code>name</code> is “Someone &amp; Co.” then <code>${name}</code> should print “Someone <em>&amp;amp;</em> Co.”.</p>
<p>FreeMarker automatically escapes all values printed with <code>${...}</code> <em>if it's properly configured</em> (that's the responsibility of the programmers; <a href="#pgui_config_outputformatsautoesc">see here how</a>). The recommended practice is using <code>ftlh</code> file extension to activate HTML auto-escaping, and <code>ftlx</code> file extension to activate XML auto-escaping.</p>
<p>You can try if auto-escaping is on like <code>${&quot;&lt;&quot;}</code> and then checking the raw output (for HTML or XML escaping). If it's not, and the configuration won't be adjusted, add this as the very first line of the template:</p>
<pre><code>&lt;#ftl output_format=&quot;HTML&quot;&gt;</code></pre>
<p>(Use <code>&quot;XML&quot;</code> instead of <code>&quot;HTML&quot;</code> above if you generate XML.)</p>
<p>If the string value to print deliberately contains markup, auto-escaping must be prevented like <code>${value?no_esc}</code>.</p>
<p>You can find out much more about auto-escaping and output formats <a href="#dgui_misc_autoescaping">here...</a></p>
<blockquote>
<p><strong>Note</strong></p>
<p>The kind of automatic escaping described here requires at least FreeMarker 2.3.24. If you have to use an earlier version, use the deprecated <a href="#ref_directive_escape"><code>escape</code> directive</a> instead.</p>
</blockquote>
<h1 id="dgui_datamodel">Values, Types</h1>
<h2 id="dgui_datamodel_basics">Basics</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>It is assumed that you have already read the <a href="#dgui_quickstart">Getting Started</a> chapter.</p>
</blockquote>
<p>Understanding the concept of values and types is crucial for the understanding of data-models. However, the concept of values and types is not confined to data-models, as you will see.</p>
<h3 id="topic.value">What is a value?</h3>
value
<p>Real programmers can safely skip this section.</p>
<p>Examples of <em>values</em> as you know the term from the everyday math are 16, 0.5, and so on, i.e. numbers. In the case of computer languages the value term has a wider meaning, as a value needn't be a number. For example, take this data-model:</p>
<pre id="example.stdDataModel"><code>(root)
 |
 +- user = &quot;Big Joe&quot;
 |
 +- today = Jul 6, 2007
 |
 +- todayHoliday = false
 |
 +- lotteryNumbers
 |   |
 |   +- (1st) = 20
 |   |
 |   +- (2nd) = 14
 |   |
 |   +- (3rd) = 42
 |   |
 |   +- (4th) = 8
 |   |
 |   +- (5th) = 15
 |
 +- cargo
     |
     +- name = &quot;coal&quot;
     |
     +- weight = 40</code></pre>
<p>We say that the <em>value</em> of the the <code>user</code> variable is &quot;Big Joe&quot; (a string), the <em>value</em> of <code>today</code> is Jul 6, 2007 (a date), the <em>value</em> of <code>todayHoliday</code> is false (a boolean, ie. a yes/no thing). The <em>value</em> of <code>lotteryNumbers</code> is the sequence that contains 20, 14, 42, 8, 15. Surely <code>lotteryNumbers</code> is multiple values in the sense that it <em>contains</em> multiple values (for example, the 2nd item in it is a the <em>value</em> 14), but still, <code>lotteryNumbers</code> itself is a single value. It's like a box that contains many other items; the whole box can be seen as a single item. Last not least we also have the <em>value</em> of <code>cargo</code>, which is a hash (a box-like thing again).So, a value is something that can be stored in a variable (e.g., in <code>user</code> or <code>cargo</code> or <code>cargo.name</code>). But a value need not be stored in a variable to be called a value, for example we have the value 100 here:</p>
<pre><code>&lt;#if cargo.weight &lt; 100&gt;Light cargo&lt;/#if&gt;</code></pre>
<p>The temporaly result of a calculations are also called values, like 20 and 120 when this template is executed (it will print 120):</p>
<pre><code>${cargo.weight / 2 + 100}</code></pre>
<p>Explanation for this last: As the result of dividing the two values, 40 (the weight of the cargo) and 2, a new value 20 is created. Then 100 is added to it, so the value 120 is created. Then 120 is printed (<code>${...}</code>), and the template execution goes on and all these values gone.</p>
<p>Certainly now you feel what the value term means.</p>
<h3>What is type?</h3>
<p>Values have an important aspect, their type. For example the type of the value of the <code>user</code> variable is string, and the type of the value of the <code>lotteryNumbers</code> variable is sequence. The type of a value is important because it determines to a large extent how and where you can use the value. Like <code>${user / 2}</code> is an error, but <code>${cargo.weight / 2}</code> works and prints 20, since division only does make sense for a number, but not for a string. Or, using dot like in <code>cargo.name</code> does make sense only if <code>cargo</code> is a hash. Or, you can list with <code>&lt;#list ...&gt;</code> sequences only. Or, the condition of <code>&lt;#if
          ...&gt;</code> must be a boolean. And so on.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>A little terminology... Saying &quot;a boolean&quot; or &quot;a boolean value&quot; or &quot;a value of type boolean&quot; are all the same.</p>
</blockquote>
<p>Multi-typed valueA value can have multiple types at the same time, although it's rarely utilized. For example in the data-model below <code>mouse</code> is both a string and a hash:</p>
<pre><code>(root)
 |
 +- mouse = &quot;Yerri&quot;
     |
     +- age = 12
     |
     +- color = &quot;brown&quot;</code></pre>
<p>If you merge this template with the above data-model:</p>
<pre><code>${mouse}       &lt;#-- uses mouse as a string --&gt;
${mouse.age}   &lt;#-- uses mouse as a hash --&gt;
${mouse.color} &lt;#-- uses mouse as a hash --&gt;</code></pre>
<p>the output will be:</p>
<pre><code>Yerri
12
brown</code></pre>
<h3>The data-model is a hash</h3>
<p>Looking at the various data-model examples you may already realized: the thing marked as &quot;(root)&quot; is just a value of type hash. When you write something like <code>user</code>, that means that you want the &quot;user&quot; variable stored in the root hash. Like if you were writing <code>root.user</code>, except that there is no variable called &quot;root&quot; so that wouldn't work.</p>
<p>Some may get confused by the fact that our example data-model, that is, the root hash, contains further hashes and sequences (<code>lotteryNumbers</code> and <code>cargo</code>). There is nothing special in that. A hash contains other variables, and those variables have a value, which can be a string, a number, etc., and of course it can be a hash or sequence as well. Because, as it was explained earlier, a sequence or a hash is just a value, like a string or a number is.</p>
<h2 id="dgui_datamodel_types">The types</h2>
<p>The suppored types are:</p>
<ul>
<li><p><a href="#dgui_datamodel_scalar">Scalars:</a></p>
<ul>
<li><p>String</p></li>
<li><p>Number</p></li>
<li><p>Boolean</p></li>
<li><p>Date-like (date, time, or date-time)</p></li>
</ul></li>
<li><p><a href="#dgui_datamodel_container">Containers:</a></p>
<ul>
<li><p>Hash</p></li>
<li><p>Sequence</p></li>
<li><p>Collection</p></li>
</ul></li>
<li><p>Subroutines:</p>
<ul>
<li><p><a href="#dgui_datamodel_method">Methods and functions</a></p></li>
<li><p><a href="#dgui_datamodel_userdefdir">User-defined directives</a></p></li>
</ul></li>
<li><p>Miscellaneous/seldom used:</p>
<ul>
<li><p><a href="#dgui_datamodel_node">Node</a></p></li>
<li><p><a href="#dgui_datamodel_markupoutput">Markup output</a></p></li>
</ul></li>
</ul>
<h3 id="dgui_datamodel_scalar">Scalars</h3>
<p>These are the basic, simple kind of values. They can be:</p>
<ul>
<li><p>string the FTL value typeString: It is simple text, e.g., the name of a product.</p>
<p>If you want to give a string value directly in the template, rather than use a variable that comes from the data model, you write the text between quotation marks, e.g., <code>&quot;green mouse&quot;</code> or <code>'green
              mouse'</code>. (More details regarding the syntax can be found <a href="#dgui_template_exp_direct_string">later</a>.)</p></li>
<li><p>number the FTL value typeNumber: For example the price of a product. Whole numbers and non-whole numbers are not distinguished; there is only a single number type. So for example 3/2 will be always 1.5, and never 1. Just like if you are using a calculator.</p>
<p>If you want to give a numerical value directly in the template, then you write for example: <code>150</code> or <code>-90.05</code> or <code>0.001</code>. (More details regarding the syntax can be found <a href="#dgui_template_exp_direct_number">later</a>.)</p></li>
<li><p>boolean the FTL value typeBoolean: A boolean value represents a logical true or false (yes or no). For example, if a the visitor has been logged in or not. Typically you use booleans as the condition of the <code>if</code> directive, like <code>&lt;#if
              loggedIn
              &gt;...&lt;/#if&gt;</code> or <code>&lt;#if price ==
              0&gt;...&lt;/#if&gt;</code>; in the last case the result of the <code>price == 0</code> part is a boolean value.</p>
<p>In the templates you can directly specify a boolean with the reserved words <code>true</code> and <code>false</code>.</p></li>
<li><p>date the FTL value typetime the FTL value typedate-time the FTL value typeDate: A date-like value stores date/time related data. It has three variations:</p>
<ul>
<li><p>Date: Like April 4, 2003. Day precision, no time of day part.</p></li>
<li><p>Time: Like 10:19:18 PM. Millisecond precision, no date part.</p></li>
<li><p>Date-time (sometimes called &quot;time stamp&quot;) as April 4, 2003 10:19:18 PM. Both date and time, with millisecond precision.</p></li>
</ul>
<p>Unfortunately, because of the limitations of the Java platform, FreeMarker sometimes can't decide which parts of the date are in use (i.e., if it is date-time, a date or a time). The solution for this problem is an advanced topic that will be discussed <a href="#ref_builtin_date_datetype">later</a>.</p>
<p>It is possible to define date-like values directly in templates, but this is an advanced topic that will be explained <a href="#ref_builtin_string_date">later</a>.</p></li>
</ul>
<p>Bear in mind that FreeMarker distinguishes strings from numbers, booleans and date-like values. For example, while the string <code>&quot;150&quot;</code> looks like the number <code>150</code>, a string is still just arbitrary sequence of characters, and you can't do arithmetic with it, can't compare it with another number, etc.</p>
<h3 id="dgui_datamodel_container">Containers</h3>
Re-explanation of hashes and sequences from a more ''professional'' viewpoint as earlier, and some meditation about them.
<p>These are the values whose purpose is to contain other variables; they are just containers. The contained variables are often referred as <em>sub variables</em>. The container types are:</p>
<ul>
<li><p>hash the FTL value typeHash: Associates a unique lookup name with each of its sub variables. The name is an unrestricted string. A hash <em>doesn't define an ordering</em> for the sub variables in it. That is, there is no such thing as the first subvariable, and the second subvariable, etc.; the variables are just accessed by name.</p></li>
<li><p>sequence the FTL value typeSequence: Associates an integer number with each of its sub variables. The first subvariable is associated with 0, the second with 1, the third to 2, and so on; the sub variables are ordered. These numbers are often called the <em>indexes</em> of the sub variables. Sequences are usually dense, i.e., all indexes up to the index of the last subvariable have an associated subvariable, but it's not strictly necessary. The type of the subvariable values need not be the same.</p></li>
<li><p>collection the FTL value typeCollection: A collection, from the viewpoint of the template author, is a restricted sequence. You cannot access its size or retrieve its sub variables by index, but they can be still listed with the <a href="#ref.directive.list"><code>list</code> directive</a>.</p></li>
</ul>
<p>Note that since <a href="#topic.multitype">a value can have multiple types</a>, it is possible for a value to be both a hash and a sequence, in which case it would support index-based access as well as access by lookup name. However, typically a container will be either a hash or a sequence, not both.</p>
<p>As the value of the variables stored in hashes and sequences (and collections) can be anything, it can be a hash or sequence (or collection) as well. This way you can build arbitrarily deep structures.</p>
<p>The data-model itself (or better said the root of it) is a hash.</p>
<p>FreeMarker templates don't support modifying the contents of containers (such as adding, removing or replacing sub variables), and it assumes that their content won't change during template processing. (But you can make new container values by adding together two existing container values with <code>+</code>; see that in the <a href="#exp_cheatsheet">chapter about expressions</a>, and please note the performance consequences.)</p>
<h3>Subroutines</h3>
<h4 id="dgui_datamodel_method">Methods and functions</h4>
method
the FTL value type
<p>A value that is a method or a function is used to calculate another value, influenced by the parameters you give to it.</p>
<p>For programmer types: Methods/functions are first-class values, just like in functional programming languages. This means that functions/methods can be the parameters or return values of other functions/methods, you can assign them to variables, and so on.</p>
<p>Suppose that programmers have put the method variable <code>avg</code> in the data-model that can be used to calculate the average of numbers. If you give the 3 and 5 as parameters when you access <code>avg</code>, then you get the value 4.</p>
<p>The usage of methods will be explained <a href="#dgui_template_exp_methodcall">later</a>, but perhaps this example helps to understand what methods are:</p>
<pre><code>The average of 3 and 5 is: ${avg(3, 5)}
The average of 6 and 10 and 20 is: ${avg(6, 10, 20)}
The average of the price of a python and an elephant is:
${avg(animals.python.price, animals.elephant.price)}</code></pre>
<p>this will output:</p>
<pre><code>The average of 3 and 5 is: 4
The average of 6 and 10 and 20 is: 12
The average of the price of a python and an elephant is:
4999.5</code></pre>
<p>What is the difference between a method and a function? As far as the template author is concerned, nothing. Well not really nothing, as methods typically come from the data-model (as they reflect the methods of Java objects), and functions are defined in templates (with the <a href="#ref.directive.function"><code>function</code> directive</a> -- an advanced topic), but both can be used on the same way.</p>
<h4 id="dgui_datamodel_userdefdir">User-defined directives</h4>
macro
the FTL value type
directive
the FTL value type
user-defined directive
the FTL value type
<p>A value of this type can be used as user-defined directive (with other words, as FreeMarker tag). An user-defined directive is a subroutine, something like a little reusable template fragment. But this is an advanced topic that will be explained <a href="#dgui_misc_userdefdir">later</a> in its own chapter.</p>
<p>For programmer types: user-defined directives (such as macros), are first-class values too, just like functions/methods are.</p>
<p>Just to get an idea about user-defined directives (so just ignore this if you won't understand), assume we have a variable, <code>box</code>, whose value is a user-defined directive that prints some kind of fancy HTML message box with a title bar and a message in it. The <code>box</code> variable could be used in the template like this (for example):</p>
<pre><code>&lt;@box title=&quot;Attention!&quot;&gt;
  Too much copy-pasting may leads to
  maintenance headaches.
&lt;/@box&gt;</code></pre>
<h4>Function/method versus user-defined directive</h4>
<p>This is for advanced users again (so ignore it if you don't understand). It's a frequent dilemma if you should use a function/method or an user-defined directive to implement something. The rule of thumb is: Implement the facility as user-defined directive instead of as function/method if:</p>
<ul>
<li><p>... the purpose of it is generating a piece of the output that's not just a single value, and typically involves markup. The template language was designed for printing to the output directly, piece by piece, as it goes though <code>list</code> loops, <code>if</code>-s, etc. Building up a string value in a variable then returning it is much less convenient.</p></li>
<li><p>... it's the side-effect that is important and not the return value. For example, a directive whose purpose is to add an entry to the server log is like that. (In fact you can't have a return value for a user-defined directive, but some kind of feedback is still possible by setting non-local variables.)</p></li>
<li><p>... it will do flow control on the caller side (like for example <code>list</code> or <code>if</code> directives do). You just can't do that with a function/method.</p></li>
<li><p>... you are using legacy escaping via the <code>escape</code> directive (instead of <a href="#dgui_misc_autoescaping">auto-escaping</a>), and the result contains markup. When you print the result with <code>${...}</code>, the markup will be escaped and thus ruined, but if it's printed by a directive call (<code>&lt;@...&gt;</code>), it won't be.</p></li>
</ul>
<p>The Java methods of FreeMarker-unaware Java objects are normally visible as methods in templates, regardless of the nature of the Java method; you have no choice there.</p>
<h3>Miscellaneous</h3>
<h4 id="dgui_datamodel_node">Nodes</h4>
node
the FTL value type
<p>Node variables represent a node in a tree structure, and are used mostly with <a href="#xgui">XML processing</a>, which is an advanced, and specialized topic.</p>
<p>Still, a quick overview <em>for advanced users</em>: A node is similar to a sequence that stores other nodes, which are often referred as the children nodes. A node stores a reference to its container node, which is often referred as the parent node. The main point of being a node is the topological information; other data must be stored by utilizing that a value can have multiple types. Like, a value may be both a node and a number, in which case it can store a number as the &quot;pay-load&quot;. Apart from the topological information, a node can store some metainformation as well: a node name, a node type (string), and a node namespace (string). For example, if the node symbolizes a <code>h1</code> element in an XHTML document, then its name could be <code>&quot;h1&quot;</code>, it's node type could be <code>&quot;element&quot;</code>, and it's namespace could be <code>&quot;http://www.w3.org/1999/xhtml&quot;</code>. But it's up to the designer of the data-model if what meaning these metainformations have, and if they are used at all. The way of retrieving the topological and metainformations is described <a href="#ref_builtins_node">in a later chapter</a> (that you don't have to understand at this point).</p>
<h4 id="dgui_datamodel_markupoutput">Markup output</h4>
markup output
the FTL value type
<p>This type is related to <a href="#dgui_misc_autoescaping">auto-escaping mechanism</a> introduced FreeMarker 2.3.24; you can <a href="#dgui_misc_autoescaping_movalues">read about this type there</a>. But in short, this is a value that stores text that's already in the output markup format (like HTML, XML, RTF, etc.), and hence must not be auto-escaped.</p>
<p>Values of this type are usually produced inside the templates (like with <a href="#ref_builtin_no_esc"><code>no_esc</code> built-in</a> or <a href="#ref_directive_assign">output capturing assignments</a>), but can also be part of the data-model. Such values in the data-model are useful for example if you have message resources that sometimes contain the message in HTML format, rather than in plain text. If the data-model uses HTML markup output values for those messages instead of strings, then the template author need not know which messages contain HTML and which plain text, as double escaping will be avoided automatically when the message is inserted with <code>${...}</code>.</p>
<h1 id="dgui_template">The Template</h1>
template
<blockquote>
<p><strong>Note</strong></p>
<p>It is assumed that you have already read the <a href="#dgui_quickstart">Getting Started</a> and the <a href="#dgui_datamodel">Values, Types</a> chapter.</p>
</blockquote>
<h2 id="dgui_template_overallstructure">Overall structure</h2>
<p>Templates are in fact programs you write in a language called FTL<em>FTL</em> (for FreeMarker Template Language). This is a quite simple programming language designed for writing templates and nothing else.</p>
<p>A template (= FTL program) is a mix of the following sections:</p>
<ul>
<li><p><em>Text</em>text: Text that will be printed to the output as is.</p></li>
<li><p><em>Interpolation</em>interpolation: These sections will be replaced with a calculated value in the output. Interpolations are delimited by <code>${</code> and <code>}</code> (or with <code>#{</code> and <code>}</code>, but that shouldn't be used anymore; <a href="#ref_depr_numerical_interpolation">see more here</a>).</p></li>
<li><p><em>FTL tags</em>FTL tag: FTL tags are a bit similar to HTML tags, but they are instructions to FreeMarker and will not be printed to the output.</p></li>
<li><p><em>Comments</em>comment&lt;#--...--&gt;#: Comments are similar to HTML comments, but they are delimited by <code>&lt;#--</code> and <code>--&gt;</code>. Comments will be ignored by FreeMarker, and will not be written to the output.</p></li>
</ul>
<p>Let's see a concrete template. I have marked the template's components with colors: text, interpolation, FTL tag, comment. With the [BR]-s I intend to visualize the <a href="#gloss.lineBreak">line breaks</a>.</p>
<pre><code>&lt;html&gt;[BR]
&lt;head&gt;[BR]
  &lt;title&gt;Welcome!&lt;/title&gt;[BR]
&lt;/head&gt;[BR]
&lt;body&gt;[BR]
  &lt;#-- Greet the user with his/her name --&gt;[BR]
  &lt;h1&gt;Welcome ${user}!&lt;/h1&gt;[BR]
  &lt;p&gt;We have these animals:[BR]
  &lt;ul&gt;[BR]
  &lt;#list animals as animal&gt;[BR]
    &lt;li&gt;${animal.name} for ${animal.price} Euros[BR]
  &lt;/#list&gt;[BR]
  &lt;/ul&gt;[BR]
&lt;/body&gt;[BR]
&lt;/html&gt;</code></pre>
<p>FTL distinguishes upper case and lower case letters. So <code>list</code> is good directive name, while <code>List</code> is not. Similarly <code>${name}</code> is not the same as <code>${Name}</code> or <code>${NAME}</code></p>
<p>It is important to realize that interpolations can be used in text (and in string literal expressions; see <a href="#dgui_template_exp_stringop_interpolation">later</a>) only.</p>
<p>An FTL tag can't be inside another FTL tag nor inside an interpolation. For example this is <em>WRONG</em>: <code>&lt;#if &lt;#include
        'foo'&gt;='bar'&gt;...&lt;/#if&gt;</code></p>
<p>Comments can be placed inside FTL tags and interpolations. For example:</p>
<pre><code>&lt;h1&gt;Welcome ${user &lt;#-- The name of user --&gt;}!&lt;/h1&gt;[BR]
&lt;p&gt;We have these animals:[BR]
&lt;ul&gt;[BR]
&lt;#list &lt;#-- some comment... --&gt; animals as &lt;#-- again... --&gt; animal&gt;[BR]
...</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>For those of you who have tried the above examples: You may notice that some of spaces, tabs and line breaks are missing from the template output, even though we said that text is printed as is. Don't bother with it now. This is because the feature called ''white-space stripping'' is turned on, and that automatically removes some superfluous spaces, tabs and line breaks. This will be explained <a href="#dgui_misc_whitespace">later</a>.</p>
</blockquote>
<h2 id="dgui_template_directives">Directives</h2>
&lt;#...&gt;
#
Note that the Expressions chapter depends on this chapter, and Interpolations chapter depends on Expressions chapter. Thus Directives must be the first chapter after Basics.
<p>directiveYou use FTL tags to call <em>directives</em>. In the example you have called the <code>list</code> directive. Syntactically you have done it with two tags: <code>&lt;#list animals as animal&gt;</code> and <code>&lt;/#list&gt;</code>.</p>
<p>FTL tagThere are two kind of FTL tags:</p>
<ul>
<li><p>Start-tag: <code>&lt;#directivename
            parameters&gt;</code></p></li>
<li><p>End-tag: <code>&lt;/#directivename&gt;</code></p></li>
</ul>
<p>This is similar to HTML or XML syntax, except that the tag name starts with <code>#</code>. If the directive doesn't have nested content (content between the start-tag and the end-tag), you must use the start-tag with no end-tag. For example you write <code>&lt;#if
        something&gt;...&lt;/#if&gt;</code>, but just <code>&lt;#include
        something&gt;</code> as FreeMarker knows that the <code>include</code> directive can't have nested content.</p>
<p>The format of the <code>parameters</code> depends on the <code>directivename</code>.</p>
<p>In fact there are two types of directives: <a href="#gloss.predefinedDirective">predefined directives</a> and <a href="#gloss.userDefinedDirective">user-defined directives</a>. For user-defined directives you use <code>@</code> instead of <code>#</code>, for example <code>&lt;@mydirective
        parameters&gt;...&lt;/@mydirective&gt;</code>. Further difference is that if the directive has no nested content, you must use a tag like <code>&lt;@mydirective
        parameters /&gt;</code>, similarly as in XML (e.g. <code>&lt;img ...
        /&gt;</code>). But user-defined directives is an advanced topic that will be discussed <a href="#dgui_misc_userdefdir">later</a>.</p>
<p>FTL tags, like HTML tags, must be properly nested. So the code below is wrong, as the <code>if</code> directive is both inside and outside of the nested content of the <code>list</code> directive:</p>
<pre><code>&lt;ul&gt;
&lt;#list animals as animal&gt;
  &lt;li&gt;${animal.name} for ${animal.price} Euros
  &lt;#if user == &quot;Big Joe&quot;&gt;
     (except for you)
&lt;/#list&gt; &lt;#-- WRONG! The &quot;if&quot; has to be closed first. --&gt;
&lt;/#if&gt;
&lt;/ul&gt;</code></pre>
<p>Note that FreeMarker doesn't care about the nesting of HTML tags, only about the nesting of FTL tags. It just sees HTML as flat text, it doesn't interpret it in any way.</p>
<p>If you try to use a non-existing directive (e.g., you mistype the directive name), FreeMarker will decline to use the template and produce an error message.</p>
<p>FreeMarker ignores superfluous <a href="#gloss.whiteSpace">white-space</a> inside FTL tags. So you can write this:</p>
<pre><code>&lt;#list[BR]
  animals       as[BR]
     animal[BR]
&gt;[BR]
${animal.name} for ${animal.price} Euros[BR]
&lt;/#list    &gt;</code></pre>
<p>You may not, however, insert white-space between the <code>&lt;</code> or <code>&lt;/</code> and the directive name.</p>
<p>The complete list and description of all directives can be found in the <a href="#ref_directives">Directive Reference</a> (but I recommend that you look at the chapter about expressions first).</p>
<blockquote>
<p><strong>Note</strong></p>
<p>FreeMarker can be configured to use <code>[</code> and <code>]</code> instead of <code>&lt;</code> and <code>&gt;</code> in the FTL tags and FTL comments, like <code>[#if user == &quot;Big
          Joe&quot;]...[/#if]</code>. For more information read: <a href="#dgui_misc_alternativesyntax">section_title</a>.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>FreeMarker can be configured so that it understands predefined directives without <code>#</code> (like <code>&lt;if user
          == &quot;Big
          Joe&quot;&gt;...&lt;/if&gt;</code>). However we don't recommend the usage of this mode. For more information read: <a href="#ref_depr_oldsyntax">section_title</a></p>
</blockquote>
<h2 id="dgui_template_exp">Expressions</h2>
<p>expressionWhen you supply values for interpolations or directive parameters you can use variables or more complex expressions. For example, if x is the number 8 and y is 5, the value of <code>(x +
        y)/2</code> resolves to the numerical value 6.5.</p>
<p>Before we go into details, let's see some concrete examples:</p>
<ul>
<li><p>When you supply value for interpolations: The usage of interpolations is <code>${expression}</code> where expression gives the value you want to insert into the output as text. So <code>${(5 + 8)/2}</code> prints “6.5” to the output (or possibly “6,5” if the language of your output is not US English).</p></li>
<li><p>When you supply a value for the directive parameter: You have already seen the <code>if</code> directive in the Getting Started section. The syntax of this directive is: <code>&lt;#if
            expression&gt;...&lt;/#if&gt;</code>. The expression here must evaluate to a boolean value. For example in <code>&lt;#if 2 &lt; 3&gt;</code> the <code>2 &lt;
            3</code> (2 is less than 3) is an expression which evaluates to <code>true</code>.</p></li>
</ul>
<h3 id="exp_cheatsheet">Quick overview (cheat sheet)</h3>
<p>This is a reminder for those of you who already know FreeMarker or are just experienced programmers:</p>
<ul>
<li><p><a href="#dgui_template_exp_direct">Specify values directly</a></p>
<ul>
<li><p><a href="#dgui_template_exp_direct_string">Strings</a>: <code>&quot;Foo&quot;</code> or <code>'Foo'</code> or <code>&quot;It's \&quot;quoted\&quot;&quot;</code> or <code>'It\'s
                  &quot;quoted&quot;'</code> or <code>r&quot;C:\raw\string&quot;</code></p></li>
<li><p><a href="#dgui_template_exp_direct_number">Numbers</a>: <code>123.45</code></p></li>
<li><p><a href="#dgui_template_exp_direct_boolean">Booleans</a>: <code>true</code>, <code>false</code></p></li>
<li><p><a href="#dgui_template_exp_direct_seuqence">Sequences</a>: <code>[&quot;foo&quot;, &quot;bar&quot;, 123.45]</code>; Ranges: <code>0..9</code>, <code>0..&lt;10</code> (or <code>0..!10</code>), <code>0..</code></p></li>
<li><p><a href="#dgui_template_exp_direct_hash">Hashes</a>: <code>{&quot;name&quot;:&quot;green mouse&quot;,
                  &quot;price&quot;:150}</code></p></li>
</ul></li>
<li><p><a href="#dgui_template_exp_var">Retrieving variables</a></p>
<ul>
<li><p><a href="#dgui_template_exp_var_toplevel">Top-level variables</a>: <code>user</code></p></li>
<li><p><a href="#dgui_template_exp_var_hash">Retrieving data from a hash</a>: <code>user.name</code>, <code>user[&quot;name&quot;]</code></p></li>
<li><p><a href="#dgui_template_exp_var_sequence">Retrieving data from a sequence</a>: <code>products[5]</code></p></li>
<li><p><a href="#dgui_template_exp_var_special">Special variable</a>: <code>.main</code></p></li>
</ul></li>
<li><p><a href="#dgui_template_exp_stringop">String operations</a></p>
<ul>
<li><p><a href="#dgui_template_exp_stringop_interpolation">Interpolation and concatenation</a>: <code>&quot;Hello ${user}!&quot;</code> (or <code>&quot;Hello
                  &quot; + user + &quot;!&quot;</code>)</p></li>
<li><p><a href="#dgui_template_exp_get_character">Getting a character</a>: <code>name[0]</code></p></li>
<li><p><a href="#dgui_template_exp_stringop_slice">String slice:</a> Inclusive end: <code>name[0..4]</code>, Exclusive end: <code>name[0..&lt;5]</code>, Length-based (lenient): <code>name[0..*5]</code>, Remove starting: <code>name[5..]</code></p></li>
</ul></li>
<li><p><a href="#dgui_template_exp_sequenceop">Sequence operations</a></p>
<ul>
<li><p><a href="#dgui_template_exp_sequenceop_cat">Concatenation</a>: <code>users + [&quot;guest&quot;]</code></p></li>
<li><p><a href="#dgui_template_exp_seqenceop_slice">Sequence slice</a>: Inclusive end: <code>products[20..29]</code>, Exclusive end: <code>products[20..&lt;30]</code>, Length-based (lenient): <code>products[20..*10]</code>, Remove starting: <code>products[20..]</code></p></li>
</ul></li>
<li><p><a href="#dgui_template_exp_hashop">Hash operations</a></p>
<ul>
<li><p><a href="#dgui_template_exp_hashop_cat">Concatenation</a>: <code>passwords + { &quot;joe&quot;: &quot;secret42&quot; }</code></p></li>
</ul></li>
<li><p><a href="#dgui_template_exp_arit">Arithmetical calculations</a>: <code>(x * 1.5 + 10) / 2 - y %
              100</code></p></li>
<li><p><a href="#dgui_template_exp_comparison">Comparison</a>: <code>x == y</code>, <code>x != y</code>, <code>x &lt; y</code>, <code>x &gt; y</code>, <code>x &gt;= y</code>, <code>x &lt;= y</code>, <code>x lt y</code>, <code>x lte y</code>, <code>x gt y</code>, <code>x gte y</code>, ...etc.</p></li>
<li><p><a href="#dgui_template_exp_logicalop">Logical operations</a>: <code>!registered &amp;&amp; (firstVisit
              || fromEurope)</code></p></li>
<li><p><a href="#dgui_template_exp_builtin">Built-ins</a>: <code>name?upper_case</code>, <code>path?ensure_starts_with('/')</code></p></li>
<li><p><a href="#dgui_template_exp_methodcall">Method call</a>: <code>repeat(&quot;What&quot;, 3)</code></p></li>
<li><p><a href="#dgui_template_exp_missing">Missing value handler operators</a>:</p>
<ul>
<li><p><a href="#dgui_template_exp_missing_default">Default value</a>: <code>name!&quot;unknown&quot;</code> or <code>(user.name)!&quot;unknown&quot;</code> or <code>name!</code> or <code>(user.name)!</code></p></li>
<li><p><a href="#dgui_template_exp_missing_test">Missing value test</a>: <code>name??</code> or <code>(user.name)??</code></p></li>
</ul></li>
<li><p><a href="#dgui_template_exp_assignment">Assignment operators</a>: <code>=</code>, <code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code>, <code>%=</code>, <code>++</code>, <code>--</code></p></li>
</ul>
<p>See also: <a href="#dgui_template_exp_precedence">Operator precedence</a></p>
<h3 id="dgui_template_exp_direct">Specify values directly</h3>
literal
constant
<p>Often you want to specify a value directly and not as a result of some calculations.</p>
<h4 id="dgui_template_exp_direct_string">Strings</h4>
string
literal
<p>To specify a string value directly you give the text in quotation marks, e.g.: <code>&quot;some text&quot;</code> or in apostrophe-quote, e.g. <code>'some text'</code>. The two forms are equivalent. If the text itself contains the character used for the quoting (either <code>&quot;</code> or <code>'</code>) or backslashes, you have to precede them with a backslash; this is called escaping. You can type any other character, including <a href="#gloss.lineBreak">line breaks</a>, in the text directly. Example:</p>
<pre><code>${&quot;It&#39;s \&quot;quoted\&quot; and
this is a backslash: \\&quot;}

${&#39;It\&#39;s &quot;quoted&quot; and
this is a backslash: \\&#39;}</code></pre>
<p>will print:</p>
<pre><code>It&#39;s &quot;quoted&quot; and
this is a backslash: \

It&#39;s &quot;quoted&quot; and
this is a backslash: \</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Of course, you could simply type the above text into the template, without using <code>${...}</code>. But we do it here just for the sake of example, to demonstrate expressions.</p>
</blockquote>
escape sequences
<p>This is the list of all supported escape sequences. All other usage of backlash in string literals is an error and any attempt to use the template will fail.</p>
<table>
<thead>
<tr class="header">
<th>Escape sequence</th>
<th>Meaning</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>\&quot;</code></td>
<td>Quotation mark (u0022)</td>
</tr>
<tr class="even">
<td><code>\'</code></td>
<td>Apostrophe (a.k.a. apostrophe-quote) (u0027)</td>
</tr>
<tr class="odd">
<td><code>\{</code></td>
<td>Opening curly brace: <code>{</code></td>
</tr>
<tr class="even">
<td><code>\\</code></td>
<td>Back slash (u005C)</td>
</tr>
<tr class="odd">
<td><code>\n</code></td>
<td>Line feed (u000A)</td>
</tr>
<tr class="even">
<td><code>\r</code></td>
<td>Carriage return (u000D)</td>
</tr>
<tr class="odd">
<td><code>\t</code></td>
<td>Horizontal tabulation (a.k.a. tab) (u0009)</td>
</tr>
<tr class="even">
<td><code>\b</code></td>
<td>Backspace (u0008)</td>
</tr>
<tr class="odd">
<td><code>\f</code></td>
<td>Form feed (u000C)</td>
</tr>
<tr class="even">
<td><code>\l</code></td>
<td>Less-than sign: <code>&lt;</code></td>
</tr>
<tr class="odd">
<td><code>\g</code></td>
<td>Greater-than sign: <code>&gt;</code></td>
</tr>
<tr class="even">
<td><code>\a</code></td>
<td>Ampersand: <code>&amp;</code></td>
</tr>
<tr class="odd">
<td><code>\xCode</code></td>
<td>Character given with its hexadecimal <a href="#gloss.unicode">Unicode</a> code (<a href="#gloss.UCS">UCS</a> code)</td>
</tr>
</tbody>
</table>
<p>The <code>Code</code> after the <code>\x</code> is 1 to 4 hexadecimal digits. For example this all put a copyright sign into the string: <code>&quot;\xA9 1999-2001&quot;</code>, <code>&quot;\x0A9 1999-2001&quot;</code>, <code>&quot;\x00A9 1999-2001&quot;</code>. When the character directly after the last hexadecimal digit can be interpreted as hexadecimal digit, you must use all 4 digits or else FreeMarker will misunderstand you.</p>
<p>Note that the character sequence <code>${</code> (and <code>#{</code>) has special meaning. It's used to insert the value of expressions (typically: the value of variables, as in <code>&quot;Hello ${user}!&quot;</code>). This will be explained <a href="#dgui_template_exp_stringop_interpolation">later</a>. If you want to print <code>${</code> or <code>#{</code>, you should either use raw string literals as explained below, or escape the <code>{</code> like in <code>&quot;foo $\{bar}&quot;</code>.</p>
raw string literal
<p>A special kind of string literals is the raw string literals. In raw string literals, backslash and <code>${</code> have no special meaning, they are considered as plain characters. To indicate that a string literal is a raw string literal, you have to put an <code>r</code> directly before the opening quotation mark or apostrophe-quote. Example:</p>
<pre><code>${r&quot;${foo}&quot;}
${r&quot;C:\foo\bar&quot;}</code></pre>
<p>will print:</p>
<pre><code>${foo}
C:\foo\bar</code></pre>
<h4 id="dgui_template_exp_direct_number">Numbers</h4>
number
literal
<p>To specify a numerical value directly you type the number without quotation marks. You have to use the dot as your decimal separator and must not use any grouping separator symbols. You can use <code>-</code> or <code>+</code> to indicate the sign (<code>+</code> is redundant). Scientific notation is not yet supported (so <code>1E3</code> is wrong). Also, you cannot omit the 0 before the decimal separator (so <code>.5</code> is wrong).</p>
<p>Examples of valid number literals: <code>0.08</code>, <code>-5.013</code>, <code>8</code>, <code>008</code>, <code>11</code>, <code>+11</code></p>
<p>Note that numerical literals like <code>08</code>, <code>+8</code>, <code>8.00</code> and <code>8</code> are totally equivalent as they all symbolize the number eight. Thus, <code>${08}</code>, <code>${+8}</code>, <code>${8.00}</code> and <code>${8}</code> will all print exactly same.</p>
<h4 id="dgui_template_exp_direct_boolean">Booleans</h4>
boolean
literal
literal
boolean
<p>To specify a boolean value you write <code>true</code> or <code>false</code>. Don't use quotation marks.</p>
<h4 id="dgui_template_exp_direct_seuqence">Sequences</h4>
sequence
literal
numerical sequence
numerical range expression
range expression
<p>To specify a literal sequence, you list the <a href="#topic.dataModel.subVar">sub variables</a> separated by commas, and put the whole list into square brackets. For example:</p>
<pre><code>&lt;#list [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;] as x&gt;
${x}
&lt;/#list&gt;</code></pre>
<p>will print:</p>
<pre><code>foo
bar
baz
 </code></pre>
<p>The items in the list are expressions, so you can do this for example: <code>[2 + 2, [1, 2, 3, 4], &quot;foo&quot;]</code>. Here the first subvariable will be the number 4, the second will be another sequence, and the third subvariable will be the string “foo”.</p>
<h4 id="dgui_template_exp_direct_ranges">Ranges</h4>
<p>Ranges are just sequences, but they are created by specifying what range of whole numbers they contain, instead of specifying their items one by one. For example, <code>0..&lt;m</code>, assuming the <code>m</code> variable stores 5, will give a sequence that contains <code>[0,
            1, 2, 3, 4]</code>. Ranges are primarily used for iterating over a range of numbers with <code>&lt;#list
            ...&gt;</code> and for <a href="#dgui_template_exp_seqenceop_slice">slicing sequences</a> and <a href="#dgui_template_exp_stringop_slice">slicing strings</a>.</p>
<p>The generic forms of range expressions are (where <code>start</code> and <code>end</code> can be any expression that evaluates to a number):</p>
<ul>
<li><p><code>start..end</code>: Range with inclusive end. For example, <code>1..4</code> gives <code>[1, 2, 3, 4]</code>, and <code>4..1</code> gives <code>[4, 3, 2, 1]</code>. Beware, ranges with inclusive end never give an empty sequence, so <code>0..length-1</code> is <em>WRONG</em>, because when length is <code>0</code> it gives <code>[0,
                -1]</code>.</p></li>
<li><p><code>start..&lt;end</code> or <code>start..!end</code>: Range with exclusive end. For example, <code>1..&lt;4</code> gives <code>[1, 2,
                3]</code>, <code>4..&lt;1</code> gives <code>[4,
                3, 2]</code>, and <code>1..&lt;1</code> gives <code>[]</code>. Note the last example; the result can be an empty sequence. There's no difference between <code>..&lt;</code> and <code>..!</code>; the last form is used in applications where using the <code>&lt;</code> character causes problems (for HTML editors and such).</p></li>
<li><p><code>start..*length</code>: Length limited range. For example, <code>10..*4</code> gives <code>[10, 11, 12, 13]</code>, <code>10..*-4</code> gives <code>[10, 9, 8,
                7]</code>, and <code>10..*0</code> gives <code>[]</code>. When these kind of ranges are used for slicing, the slice will end without error if the end of the sliced sequence or string is reached before the specified range length was reached; see <a href="#dgui_template_exp_seqenceop_slice">slicing sequences</a> for more.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Length limited ranges were introduced in FreeMarker 2.3.21.</p>
</blockquote></li>
<li><p><code>start..</code>: Right-unbounded range. This are like length limited ranges with infinite length. For example <code>1..</code> gives <code>[1, 2, 3, 4, 5, 6, ... ]</code>, up to infinity. Be careful when processing (like listing) such ranges, as processing all items of it it would take forever or until the application runs out of memory and crashes. Just like with length limited ranges, when these kind of ranges are used for slicing, the slice will end when the end of the sliced sequence or string is reached.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Right-unbounded ranges before FreeMarker 2.3.21 were only used for slicing, and behaved like an empty sequence for other purposes. To activate the new behavior, it's not enough to use FreeMarker 2.3.21, the programmer also have to set the <code>incompatible_improvements</code> configuration setting to at least 2.3.21.</p>
</blockquote></li>
</ul>
<p>Further notes on ranges:</p>
<ul>
<li><p>Range expressions themselves don't have square brackets, for example, you write <code>&lt;#assign myRange =
                0..&lt;x</code>, NOT <code>&lt;#assign myRange =
                [0..&lt;x]&gt;</code>. The last would create a sequence that contains an item that's a range. The square brackets are part of the slicing syntax, like <code>seq[myRange]</code>.</p></li>
<li><p>You can write arithmetical expression on the sides of the <code>..</code> without parenthesis, like <code>n
                + 1 ..&lt; m / 2 - 1</code>.</p></li>
<li><p><code>..</code>, <code>..&lt;</code>, <code>..!</code> and <code>..*</code> are operators, so you can't have space inside them. Like <code>n .. &lt;m</code> is WRONG, but <code>n ..&lt;
                m</code> is good.</p></li>
<li><p>The reported size of right-unbounded ranges is 2147483647 (or 0 if <code>incompatible_improvements</code> is less than 2.3.21) due to a technical limitation (32 bits). However, when listing them, their actual size is infinite.</p></li>
<li><p>Ranges don't really store the numbers they consist of, thus for example <code>0..1</code> and <code>0..100000000</code> is equally fast to create and takes the same amount of memory.</p></li>
</ul>
<h4 id="dgui_template_exp_direct_hash">Hashes</h4>
hash
literal
literal
hash
<p>To specify a hash in a template, you list the key/value pairs separated by commas, and put the list into curly brackets. The key and value within a key/value pair are separated with a colon. Here is an example: <code>{ &quot;name&quot;: &quot;green mouse&quot;,
            &quot;price&quot;: 150 }</code>. Note that both the names and the values are expressions. The keys must be strings. The values can be if any type.</p>
<h3 id="dgui_template_exp_var">Retrieving variables</h3>
<h4 id="dgui_template_exp_var_toplevel">Top-level variables</h4>
subvariable
accessing
<p>To access a top-level variable, you simply use the variable name. For example, the expression <code>user</code> will evaluate to the value of variable stored with name “user” in the root. So this will print what you store there:</p>
<pre><code>${user}</code></pre>
<p>If there is no such top-level variable, then an error will result when FreeMarker tries to evaluate the expression, and it aborts template processing (unless programmers has configured FreeMarker differently).</p>
<p>In this kind of expression, the variable name can only contain letters (including non-Latin letters), digits (including non-Latin digits), underline (<code>_</code>), dollar (<code>$</code>), at sign (<code>@</code>). Furthermore, the first character can't be a ASCII digit (<code>0</code>-<code>9</code>). Starting from FreeMarker 2.3.22, the variable name can also contain minus (<code>-</code>), dot (<code>.</code>), and colon (<code>:</code>) at any position, but these must be escaped with a preceding backslash (<code>\</code>), or else they would be interpreted as operators. For example, to read the variable whose name is “data-id”, the expression is <code>data\-id</code>, as <code>data-id</code> would be interpreted as “data minus id”. (Note that these escapes only work in identifiers, not in string literals.)</p>
<h4 id="dgui_template_exp_var_hash">Retrieving data from a hash</h4>
subvariable
accessing
hash
accessing subvariable
<p>If we already have a hash as a result of an expression, then we can get its subvariable with a dot and the name of the subvariable. Assume that we have this data-model:</p>
<pre><code>(root)
 |
 +- book
 |   |
 |   +- title = &quot;Breeding green mouses&quot;
 |   |
 |   +- author
 |       |
 |       +- name = &quot;Julia Smith&quot;
 |       |
 |       +- info = &quot;Biologist, 1923-1985, Canada&quot;
 |
 +- test = &quot;title&quot;</code></pre>
<p>Now we can read the <code>title</code> with <code>book.title</code>, since the book expression will return a hash (as explained in the last chapter). Applying this logic further, we can read the name of the author with this expression: <code>book.author.name</code>.</p>
<p>There is an alternative syntax if we want to specify the subvariable name with an expression: <code>book[&quot;title&quot;]</code>. In the square brackets you can give any expression as long as it evaluates to a string. So with this data-model you can also read the title with <code>book[test]</code>. More examples; these are all equivalent: <code>book.author.name</code>, <code>book[&quot;author&quot;].name</code>, <code>book.author[&quot;name&quot;]</code>, <code>book[&quot;author&quot;][&quot;name&quot;]</code>.</p>
<p>When you use the dot syntax, the same restrictions apply regarding the variable name as with top-level variables (name can contain only letters, digits, <code>_</code>, <code>$</code>, <code>@</code> but can't start with <code>0</code>-<code>9</code>, also starting from 2.3.22 you can also use <code>\-</code>, <code>\.</code> and <code>\:</code>). There are no such restrictions when you use the square bracket syntax, since the name is the result of an arbitrary expression. (Note, that to help the FreeMarker XML support, if the subvariable name is <code>*</code> (asterisk) or <code>**</code>, then you do not have to use square bracket syntax.)</p>
<p>As with the top-level variables, trying to access a non-existent subvariable causes an error and aborts the processing of the template (unless programmers has configured FreeMarker differently).</p>
<h4 id="dgui_template_exp_var_sequence">Retrieving data from a sequence</h4>
subvariable
accessing
sequence
accessing subvariable
<p>This is the same as for hashes, but you can use the square bracket syntax only, and the expression in the brackets must evaluate to a number, not a string. For example to get the name of the first animal of the <a href="#example.stdDataModel">example data-model</a> (remember that the number of the first item is 0, not 1): <code>animals[0].name</code></p>
<h4 id="dgui_template_exp_var_special">Special variables</h4>
special variables
<p>Special variables are variables defined by the FreeMarker engine itself. To access them, you use the <code>.variable_name</code> syntax.</p>
<p>Normally you don't need to use special variables. They are for expert users. The complete list of special variables can be found in the <a href="#ref_specvar">reference</a>.</p>
<h3 id="dgui_template_exp_stringop">String operations</h3>
string
operations
<h4 id="dgui_template_exp_stringop_interpolation">Interpolation and concatenation</h4>
interpolation
concatenate strings
joining strings
string
concatenate
string
interpolation
adding strings
<p>If you want to insert the value of an expression into a string, you can use <code>${...}</code> (and the deprecated <code>#{...}</code>) in string literals. <code>${...}</code> in string literals <a href="#dgui_template_valueinsertion">behaves similarly as in text sections</a> (so it goes through the same <em>locale sensitive</em> number and date/time formatting).</p>
<p>Example (assume that user is “Big Joe”):</p>
<pre><code>&lt;#assign s = &quot;Hello ${user}!&quot;&gt;
${s} &lt;#-- Just to see what the value of s is --&gt;</code></pre>
<p>This will print:</p>
<pre><code>Hello Big Joe!</code></pre>
<blockquote>
<p><strong>Warning</strong></p>
<p>A frequent mistake of users is the usage of interpolations in places where they needn't/shouldn't/can't be used. Interpolations work <em>only</em> in <a href="#dgui_template_overallstructure">text sections</a> (e.g. <code>&lt;h1&gt;Hello ${name}!&lt;/h1&gt;</code>) and in string literals (e.g. <code>&lt;#include
              &quot;/footer/${company}.html&quot;&gt;</code>). A typical <em>WRONG</em> usage is <code>&lt;#if
              ${big}&gt;...&lt;/#if&gt;</code>, which will cause a syntactical error. You should simply write <code>&lt;#if
              big&gt;...&lt;/#if&gt;</code>. Also, <code>&lt;#if
              &quot;${big}&quot;&gt;...&lt;/#if&gt;</code> is <em>WRONG</em>, since it converts the parameter value to string and the <code>if</code> directive wants a boolean value, so it will cause a runtime error.</p>
</blockquote>
<p>Alternatively, you can use the <code>+</code> operator to achieve similar result:</p>
<pre><code>&lt;#assign s = &quot;Hello &quot; + user + &quot;!&quot;&gt;</code></pre>
<p>This gives the same result as the earlier example with the <code>${...}</code>.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Because <code>+</code> follows similar rules as <code>${...}</code>, the appended string is influenced by the <code>locale</code>, <code>number_format</code>, <code>date_format</code>, <code>time_format</code>, <code>datetime_format</code> and <code>boolean_format</code>, etc. settings, and thus the result targets humans and isn't in generally machine parseable. This mostly leads to problems with numbers, as many locales use grouping (thousands separators) by default, and so <code>&quot;someUrl?id=&quot; + id</code> becomes to something like <code>&quot;someUrl?id=1 234&quot;</code>. To prevent this, use the <code>?c</code> (for Computer audience) built-in, like in <code>&quot;someUrl?id=&quot; + id?c</code> or <code>&quot;someUrl?id=${id?c}&quot;</code>, which will evaluate to something like <code>&quot;someUrl?id=1234&quot;</code>, regardless of locale and format settings.</p>
</blockquote>
<p>As when <code>${...}</code> is used inside string <em>expressions</em> it's just a shorthand of using the <code>+</code> operator, <a href="#dgui_misc_autoescaping">auto-escaping</a> is not applied on it.</p>
<h4 id="dgui_template_exp_get_character">Getting a character</h4>
charAt
get character
<p>You can get a single character of a string at a given index similarly as you can <a href="#dgui_template_exp_var_sequence">read the subvariable of a sequence</a>, e.g. <code>user[0]</code>. The result will be a string whose length is 1; FTL doesn't have a separate character type. As with sequence sub variables, the index must be a number that is at least 0 and less than the length of the string, or else an error will abort the template processing.</p>
<p>Since the sequence subvariable syntax and the character getter syntax clashes, you can use the character getter syntax only if the variable is not a sequence as well (which is possible because FTL supports multi-typed values), since in that case the sequence behavior prevails. (To work this around, you can use <a href="#ref_builtin_string_for_string">the <code>string</code> built-in</a>, e.g. <code>user?string[0]</code>. Don't worry if you don't understand this yet; built-ins will be discussed later.)</p>
<p>Example (assume that user is “Big Joe”):</p>
<pre><code>${user[0]}
${user[4]}</code></pre>
<p>will print (note that the index of the first character is 0):</p>
<pre><code>B
J</code></pre>
<h4 id="dgui_template_exp_stringop_slice">String slicing (substrings)</h4>
string slicing
substring
string
slice
string
substring
<p>You can slice a string in the same way as you <a href="#dgui_template_exp_seqenceop_slice">slice a sequence</a> (see there), only here instead of sequence items you work with characters. Some differences are:</p>
<ul>
<li><p>Decreasing ranges aren't allowed for string slicing. (That's because unlike sequences, you seldom if ever want to show a string reversed, so if that happens, that's almost always the result of an oversight.)</p></li>
<li><p>If a value is both a string and a sequence (a multi-typed value), then slicing will slice the sequence instead of the string. When you are processing XML, such values are common. In such cases you can use <code>someXMLnode?string[range]</code> to fore string slicing.</p></li>
<li><p>There's a legacy bug where a range with <em>inclusive</em> end that's one less than the starting index and is non-negative (like in <code>&quot;abc&quot;[1..0]</code>) will give an empty string instead of an error. (It should be an error as it's a decreasing range.) Currently this bug is emulated for backward compatibility, but you shouldn't utilize it, as in the future it will be certainly an error.</p></li>
</ul>
<p>Example:</p>
<pre><code>&lt;#assign s = &quot;ABCDEF&quot;&gt;
${s[2..3]}
${s[2..&lt;4]}
${s[2..*3]}
${s[2..*100]}
${s[2..]}</code></pre>
<p>will print:</p>
<pre><code>CD
CD
CDE
CDEF
CDEF</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Some of the typical use-cases of string slicing is covered by convenient built-ins: <a href="#ref_builtin_remove_beginning"><code>remove_beginning</code></a>, <a href="#ref_builtin_remove_ending"><code>remove_ending</code></a>, <a href="#ref_builtin_keep_before"><code>keep_before</code></a>, <a href="#ref_builtin_keep_after"><code>keep_after</code></a>, <a href="#ref_builtin_keep_before_last"><code>keep_before_last</code></a>, <a href="#ref_builtin_keep_after_last"><code>keep_after_last</code></a></p>
</blockquote>
<h3 id="dgui_template_exp_sequenceop">Sequence operations</h3>
sequence
operations
<h4 id="dgui_template_exp_sequenceop_cat">Concatenation</h4>
concatenate sequences
joining sequences
sequence
concatenate
adding sequences
<p>You can concatenate sequences in the same way as strings, with <code>+</code>. Example:</p>
<pre><code>&lt;#list [&quot;Joe&quot;, &quot;Fred&quot;] + [&quot;Julia&quot;, &quot;Kate&quot;] as user&gt;
- ${user}
&lt;/#list&gt;</code></pre>
<p>will print:</p>
<pre><code>- Joe
- Fred
- Julia
- Kate
 </code></pre>
<p>Note that sequence concatenation is not to be used for many repeated concatenations, like for appending items to a sequence inside a loop. It's just for things like <code>&lt;#list users
            + admins as person&gt;</code>. Although concatenating sequences is fast and is constant time (it's speed is independently of the size of the concatenated sequences), the resulting sequence will be always a little bit slower to read than the original two sequences were. Thus, after tens or hundreds of repeated concatenations the result can be impractically slow to reader.</p>
<h4 id="dgui_template_exp_seqenceop_slice">Sequence slicing</h4>
sequence slice
sequence
slice
subsequence
<p>With <code>seq[range]</code>, were <code>range</code> is a range value <a href="#dgui_template_exp_direct_ranges">as described here</a>, you can take a slice of the sequence. The resulting sequence will contain the items from the original sequence (<code>seq</code>) whose indexes are in the range. For example:</p>
<pre><code>&lt;#assign seq = [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;, &quot;D&quot;, &quot;E&quot;]&gt;
&lt;#list seq[1..3] as i&gt;${i}&lt;/#list&gt;</code></pre>
<p>will print</p>
<pre><code>BCD </code></pre>
<p>Furthermore, the items in the slice will be in the same order as in the range. Thus for example the above example with the <code>3..1</code> range would print <code>DCB</code>.</p>
<p>The numbers in the range must be valid indexes in the sequence, or else the processing of the template will be aborted with error. Like in the last example, <code>seq[-1..0]</code> would be an error as <code>seq[-1]</code> is invalid, also <code>seq[1..5]</code> would be because <code>seq[5]</code> is invalid. (Note that <code>seq[100..&lt;100]</code> or <code>seq[100..*0]</code> would be valid despite that 100 is out of bounds, because those ranges are empty.)</p>
<p>Length limited ranges (<code>start..*length</code>) and right-unbounded ranges (<code>start..</code>) adapt to the length of the sliced sequence. They will slice out at most as many items as there is available:</p>
<pre><code>&lt;#assign seq = [&quot;A&quot;, &quot;B&quot;, &quot;C&quot;]&gt;

Slicing with length limited ranges:
- &lt;#list seq[0..*2] as i&gt;${i}&lt;/#list&gt;
- &lt;#list seq[1..*2] as i&gt;${i}&lt;/#list&gt;
- &lt;#list seq[2..*2] as i&gt;${i}&lt;/#list&gt; &lt;#-- Not an error --&gt;
- &lt;#list seq[3..*2] as i&gt;${i}&lt;/#list&gt; &lt;#-- Not an error --&gt;

Slicing with right-unlimited ranges:
- &lt;#list seq[0..] as i&gt;${i}&lt;/#list&gt;
- &lt;#list seq[1..] as i&gt;${i}&lt;/#list&gt;
- &lt;#list seq[2..] as i&gt;${i}&lt;/#list&gt;
- &lt;#list seq[3..] as i&gt;${i}&lt;/#list&gt;</code></pre>
<p>This will print:</p>
<pre><code>Slicing with length limited ranges:
- AB
- BC
- C
-

Slicing with right-unlimited ranges:
- ABC
- BC
- C
-</code></pre>
<p>Note above that slicing with length limited and right unbounded ranges allow the starting index to be past the last item <em>by one</em> (but no more).</p>
<blockquote>
<p><strong>Note</strong></p>
<p>To split a sequence to slices of a given size, you should use the <a href="#ref_builtin_chunk"><code>chunk</code></a> built-in.</p>
</blockquote>
<h3 id="dgui_template_exp_hashop">Hash operations</h3>
hash
operations
<h4 id="dgui_template_exp_hashop_cat">Concatenation</h4>
concatenate hashes
joining hashes
hash
concatenate
adding hashes
<p>You can concatenate hashes in the same way as strings, with <code>+</code>. If both hashes contain the same key, the hash on the right-hand side of the <code>+</code> takes precedence. Example:</p>
<pre><code>&lt;#assign ages = {&quot;Joe&quot;:23, &quot;Fred&quot;:25} + {&quot;Joe&quot;:30, &quot;Julia&quot;:18}&gt;
- Joe is ${ages.Joe}
- Fred is ${ages.Fred}
- Julia is ${ages.Julia}</code></pre>
<p>will print:</p>
<pre><code>- Joe is 30
- Fred is 25
- Julia is 18</code></pre>
<p>Note that hash concatenation is not to be used for many repeated concatenations, like for adding items to a hash inside a loop. While adding together hashes is fast and is constant time (independent of the size of the hashes added), the resulting hash is a bit slower to read than the hashes added together. Thus after tens or hundreds of additions the result can be impractically slow to read.</p>
<h3 id="dgui_template_exp_arit">Arithmetical calculations</h3>
arithmetic
math
addition
subtraction
division
modulus
<p>This is the basic 4-function calculator arithmetic plus the modulus operator. So the operators are:</p>
<ul>
<li><p>Addition: <code>+</code></p></li>
<li><p>Subtraction: <code>-</code></p></li>
<li><p>Multiplication: <code>*</code></p></li>
<li><p>Division: <code>/</code></p></li>
<li><p>Modulus (remainder) of integer operands: <code>%</code></p></li>
</ul>
<p>Example:</p>
<pre><code>${100 - x * x}
${x / 2}
${12 % 10}</code></pre>
<p>Assuming that <code>x</code> is 5, it will print:</p>
<pre><code>75
2.5
2</code></pre>
<p>Both operands must be expressions which evaluate to a numerical value. So the example below will cause an error when FreeMarker tries to evaluate it, since <code>&quot;5&quot;</code> is a string and not the number 5:</p>
<pre><code>${3 * &quot;5&quot;} &lt;#-- WRONG! --&gt;</code></pre>
<p>There is an exception to the above rule. The <code>+</code> operator, is used to <a href="#dgui_template_exp_stringop_interpolation">concatenate strings</a> as well. If on one side of <code>+</code> is a string and on the other side of <code>+</code> is a numerical value, then it will convert the numerical value to string (using the format appropriate for language of the page) and then use the <code>+</code> as string concatenation operator. Example:</p>
<pre><code>${3 + &quot;5&quot;}</code></pre>
<pre><code>35</code></pre>
<p>Generally, FreeMarker never converts a string to a number automatically, but it may convert a number to a string automatically.</p>
<p>integer divisioninteger part People often want only the integer part of the result of a division (or of other calculations). This is possible with the <code>int</code> built-in. (Built-ins are explained <a href="#dgui_template_exp_builtin">later</a>):</p>
<pre><code>${(x/2)?int}
${1.1?int}
${1.999?int}
${-1.1?int}
${-1.999?int}</code></pre>
<p>Assuming that <code>x</code> is 5, it will print:</p>
<pre><code>2
1
1
-1
-1</code></pre>
<p>Due to historical reasons, the <code>%</code> operator works by first truncating the operands to an integer number, and then returning the remainder of the division:</p>
<pre><code>${12 % 5}   &lt;#-- Prints 2 --&gt;
${12.9 % 5} &lt;#-- Prints 2 --&gt;
${12.1 % 5} &lt;#-- Prints 2 --&gt;

${12 % 6}   &lt;#-- Prints 0 --&gt;
${12 % 6.9} &lt;#-- Prints 0 --&gt;</code></pre>
<p>The sign of the result of <code>%</code> is the same as the sign of the left hand operand, and its absolute value is the same as if both operands where positive:</p>
<pre><code>${-12 % -5} &lt;#-- Prints -2 --&gt;
${-12 % 5} &lt;#-- Prints -2 --&gt;
${12 % -5} &lt;#-- Prints 2 --&gt;</code></pre>
<p>About the precision of the operations: By default FreeMarker uses <code>BigDecimal</code>-s for all arithmetical calculations, to avoid rounding and overflow/underflow artifacts, and also keeps the result as <code>BigDecimal</code>-s. So <code>+</code> (addition), <code>-</code> (subtraction) and <code>*</code> (multiplication) are “lossless”. Again by default, <code>/</code> (division) results are calculated to 12 decimals with half-up rounding (unless some operands have even more decimals, in which case it's calculated with that much decimals). All this behavior depends on the <code>arithmetic_engine</code> configuration setting (<code>Configurable.setArithmericEngine(ArithmericEngine)</code>) though, and some application might use a different value than the default, although that's highly uncommon.</p>
<h3 id="dgui_template_exp_comparison">Comparison</h3>
comparison operators
<p>Sometimes you want to know if two values are equal or not, or which value is the greater.</p>
<p>To show concrete examples I will use the <code>if</code> directive here. The usage of <code>if</code> directive is: <code>&lt;#if
          expression&gt;...&lt;/#if&gt;</code>, where expression must evaluate to a boolean value or else an error will abort the processing of the template. If the value of expression is <code>true</code> then the things between the begin and end-tag will be processed, otherwise they will be skipped.</p>
<p>To test two values for equality you use <code>==</code> (or <code>=</code> as a <em>deprecated</em> alternative) To test two values for inequality you use <code>!=</code>. For example, assume that <code>user</code> is “Big Joe”:</p>
<pre><code>&lt;#if user == &quot;Big Joe&quot;&gt;
  It is Big Joe
&lt;/#if&gt;
&lt;#if user != &quot;Big Joe&quot;&gt;
  It is not Big Joe
&lt;/#if&gt;</code></pre>
<p>The <code>user == &quot;Big Joe&quot;</code> expression in the <code>&lt;#if ...&gt;</code> will evaluate to the boolean <code>true</code>, so the above will say “It is Big Joe”.</p>
<p>The expressions on both sides of the <code>==</code> or <code>!=</code> must evaluate to a scalar (not a sequence or hash). Furthermore, the two scalars must have the same type (i.e. strings can only be compared to strings and numbers can only be compared to numbers, etc.) or else an error will abort template processing. For example <code>&lt;#if 1 == &quot;1&quot;&gt;</code> will cause an error. Note that FreeMarker does exact comparison, so string comparisons are case and white-space sensitive: <code>&quot;x&quot;</code> and <code>&quot;x &quot;</code> and <code>&quot;X&quot;</code> are not equal values.</p>
<p>For numerical and date, time and date-time values you can also use <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;=</code> and <code>&gt;</code>. You can't use them for strings! Example:</p>
<pre><code>&lt;#if x &lt;= 12&gt;
  x is less or equivalent with 12
&lt;/#if&gt;</code></pre>
<p>There's a problem with <code>&gt;=</code> and <code>&gt;</code>. FreeMarker interprets the <code>&gt;</code> character as the closing character of the FTL tag. To prevent this, you can use <code>lt</code> instead of <code>&lt;</code>, <code>lte</code> instead of <code>&lt;=</code>, <code>gt</code> instead of <code>&gt;</code> and <code>gte</code> instead of <code>&gt;=</code>, like in <code>&lt;#if x gt
          y&gt;</code>. Another trick it to put the expression into <a href="#dgui_template_exp_parentheses">parentheses</a> like in <code>&lt;#if (x &gt; y)&gt;</code>, although it's considered to be less elegant.</p>
<p>FreeMarker supports some more syntactical alternatives:</p>
<ul>
<li><p><code>&amp;gt;</code> and <code>&amp;lt;</code> can also be used, like in: <code>&lt;#if x &amp;gt; y&gt;</code> or <code>&lt;#if
              x &amp;gt;= y&gt;</code>. This isn't meant to be entered manually; it's to work around cases where the template gets XML/HTML escaped and the user can't easily prevent that happening. Note that in general FTL does not support entity references (the <code>&amp;...;</code> things) in FTL tags; it's just an exception with these operators.</p></li>
<li><p>Deprecated forms: <code>\lt</code>, <code>\lte</code>, <code>\gt</code> and <code>\gte</code>. These are the same as the ones without the backslash.</p></li>
</ul>
<h3 id="dgui_template_exp_logicalop">Logical operations</h3>
boolean
operations
logical operations
or
and
not
<p>Just the usual logical operators:</p>
<ul>
<li><p>Logical or: <code>||</code></p></li>
<li><p>Logical and: <code>&amp;&amp;</code></p></li>
<li><p>Logical not: <code>!</code></p></li>
</ul>
<p>The operators will work with boolean values only. Otherwise an error will abort the template processing.</p>
<p>Example:</p>
<pre><code>&lt;#if x &lt; 12 &amp;&amp; color == &quot;green&quot;&gt;
  We have less than 12 things, and they are green.
&lt;/#if&gt;
&lt;#if !hot&gt; &lt;#-- here hot must be a boolean --&gt;
  It&#39;s not hot.
&lt;/#if&gt;</code></pre>
<p>FreeMarker supports some more syntactical alternatives:</p>
<ul>
<li><p><code>\and</code> (since FreeMarker 2.3.27): In some applications using <code>&amp;&amp;</code> causes problems as it's not valid in XML or HTML. While FreeMarker templates was never intended to be valid XML/HTML, only their output should be that, in reality there are some applications that expect the template itself to be valid XML/HTML regardless. This syntax is a workaround for such cases. Also note that unlike with the comparison operators, <code>and</code> without <code>\</code> is not supported due to backward compatibility restrictions.</p></li>
<li><p><code>&amp;amp;&amp;amp;</code> (since FreeMarker 2.3.27): This isn't meant to be entered manually; it's to work around cases where the template gets XML/HTML escaped and the user can't easily prevent that happening. Note that in general FTL does not support entity references (the <code>&amp;...;</code> things) in FTL tags; it's just an exception with these operators.</p></li>
<li><p>Deprecated forms: <code>&amp;</code> and <code>|</code>. Don't use them anymore.</p></li>
</ul>
<h3 id="dgui_template_exp_builtin">Built-ins</h3>
built-in
<p>Built-ins are like methods that are added to the objects by FreeMarker. To prevent name clashes with actual methods and other sub-variables, instead of dot (<code>.</code>), you separate them from the parent object with question mark (<code>?</code>). For example, if you want to ensure that <code>path</code> has an initial <code>/</code> then you could write <code>path?ensure_starts_with('/')</code>. The Java object behind <code>path</code> (a <code>String</code> most certainly) doesn't have such method, FreeMarker adds it. For brevity, if the method has no parameters, you <em>must</em> omit the <code>()</code>, like, to get the length of <code>path</code>, you have to write <code>path?length</code>, <em>not</em> <code>path?length()</code>.</p>
<p>The other reason why built-ins are crucial is that normally (though it depends on configuration settings), FreeMarker doesn't expose the Java API of the objects. So despite that Java's <code>String</code> has a <code>length()</code> method, it's hidden from the template, you <em>have to</em> use <code>path?length</code> instead. The advantage of that is that thus the template doesn't depend on the exactly type of the underlying Java objects. (Like <code>path</code> is maybe a <code>java.nio.Path</code> behind the scenes, but if the programmers has configure FreeMarker to expose <code>Path</code> objects as FTL strings, the template won't be aware of that, and <code>?length</code> will work, despite that <code>java.nio.Path</code> has no similar method.)</p>
<p>You can find some of the <a href="#topic.commonlyUsedBuiltIns">most commonly used built-ins mentioned here</a>, and the <a href="#ref_builtins">complete list of built-ins in the Reference</a>. For now, just a few of the more important ones:</p>
<p>Example:</p>
<pre><code>${testString?upper_case}
${testString?html}
${testString?upper_case?html}

${testSequence?size}
${testSequence?join(&quot;, &quot;)}</code></pre>
<p>Assuming that <code>testString</code> stores the string “Tom &amp; Jerry”, and testSequnce stores the strings “foo”, “bar” and “baz”, the output will be:</p>
<pre><code>TOM &amp; JERRY
Tom &amp;amp; Jerry
TOM &amp;amp; JERRY

3
foo, bar, baz</code></pre>
<p>Note the <code>test?upper_case?html</code> above. Since the result of <code>test?upper_case</code> is a string, you can apply the <code>html</code> built-in on it.</p>
<p>Naturally, the left side of the built-in can be arbitrary expression, not just a variable name:</p>
<pre><code>${testSeqence[1]?cap_first}
${&quot;horse&quot;?cap_first}
${(testString + &quot; &amp; Duck&quot;)?html}</code></pre>
<pre><code>Bar
Horse
Tom &amp;amp; Jerry &amp;amp; Duck</code></pre>
<h3 id="dgui_template_exp_methodcall">Method call</h3>
call a method
method
call
<p>If you have a method then you can use the method call operation on it. The method call operation is a comma-separated list of expressions in parentheses. These values are called parameters. The method call operation passes these values to the method which will in turn return a result. This result will be the value of the whole method call expression.</p>
<p>For example, assume the programmers have made available a method variable called <code>repeat</code>. You give a string as the first parameter, and a number as the second parameter, and it returns a string which repeats the first parameter the number of times specified by the second parameter.</p>
<pre><code>${repeat(&quot;Foo&quot;, 3)}</code></pre>
<p>will print:</p>
<pre><code>FooFooFoo</code></pre>
<p>Here <code>repeat</code> was evaluated to the method variable (according to how you <a href="#dgui_template_exp_var_toplevel">access top-level variables</a>) and then <code>(&quot;What&quot;, 3)</code> invoked that method.</p>
<p>I would like to emphasize that method calls are just plain expressions, like everything else. So this:</p>
<pre><code>${repeat(repeat(&quot;x&quot;, 2), 3) + repeat(&quot;Foo&quot;, 4)?upper_case}</code></pre>
<p>will print this:</p>
<pre><code>xxxxxxFOOFOOFOOFOO</code></pre>
<h3 id="dgui_template_exp_missing">Handling missing values</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>These operators exist since FreeMarker 2.3.7 (replacing the <code>default</code>, <code>exists</code> and <code>if_exists</code> built-ins).</p>
</blockquote>
undefined variable
missing variable
null
handling null-s
error handling
<p>As we explained earlier, an error will occur and abort the template processing if you try to access a missing variable. However two special operators can suppress this error, and handle the problematic situation. The handled variable can be top-level variable, hash subvariable, or sequence subvariable as well. Furthermore these operators handle the situation when a method call doesn't return a value (from the viewpoint of Java programmers: it returns <code>null</code> or it's return type is <code>void</code>), so it's more correct to say that these operators handle missing values in general, rather than just missing variables.</p>
<p>For those who know what's Java <code>null</code>, FreeMarker 2.3.x treats them as missing values. Simply, the template language doesn't know the concept of <code>null</code>. For example, if you have a bean that has a <code>maidenName</code> property, and the value of that property is <code>null</code>, then that's the same as if there were no such property at all, as far as the template is concerned (assuming you didn't configured FreeMarker to use some extreme object wrapper, that is). The result of a method call that returns <code>null</code> is also treated as a missing variable (again, assuming that you use some usual object wrapper). See more <a href="#faq_null">in the FAQ</a>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>If you wonder why is FreeMarker so picky about missing variables, <a href="#faq_picky_about_missing_vars">read this FAQ entry</a>.</p>
</blockquote>
<h4 id="dgui_template_exp_missing_default">Default value operator</h4>
default value operator
<p>Synopsis: <code>unsafe_expr!default_expr</code> or <code>unsafe_expr!</code> or <code>(unsafe_expr)!default_expr</code> or <code>(unsafe_expr)!</code></p>
<p>This operator allows you to specify a default value for the case when the value is missing.</p>
<p>Example. Assume no variable called <code>mouse</code> is present:</p>
<pre><code>${mouse!&quot;No mouse.&quot;}
&lt;#assign mouse=&quot;Jerry&quot;&gt;
${mouse!&quot;No mouse.&quot;}</code></pre>
<p>The output will be:</p>
<pre><code>No mouse.
Jerry</code></pre>
<p>The default value can be any kind of expression, so it doesn't have to be a string. For example you can write <code>hits!0</code> or <code>colors![&quot;red&quot;, &quot;green&quot;,
            &quot;blue&quot;]</code>. There is no restriction regarding the complexity of the expression that specifies the default value, for example you can write: <code>cargo.weight!(item.weight *
            itemCount + 10)</code>.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>If you have a composite expression after the <code>!</code>, like <code>1 + x</code>, <em>always</em> use parenthesses, like <code>${x!(1 + y)}</code> or <code>${(x!1) +
              y)}</code>, depending on which interpretation you meant. That's needed because due to a programming mistake in FreeMarker 2.3.x, the precedence of <code>!</code> (when it's used as default value operator) is very low at its right side. This means that, for example, <code>${x!1 + y}</code> is misinterpreted by FreeMarker as <code>${x!(1 + y)}</code> while it should mean <code>${(x!1) + y}</code>. This programming error will be fixed in FreeMarker 2.4, so you should not utilize this wrong behavior, or else your templates will break with FreeMarker 2.4!</p>
</blockquote>
<p>If the default value is omitted, then it will be empty string and empty sequence and empty hash at the same time. (This is possible because FreeMarker allows multi-type values.) Note the consequence that you can't omit the default value if you want it to be <code>0</code> or <code>false</code>. Example:</p>
<pre><code>(${mouse!})
&lt;#assign mouse = &quot;Jerry&quot;&gt;
(${mouse!})</code></pre>
<p>The output will be:</p>
<pre><code>()
(Jerry)</code></pre>
<blockquote>
<p><strong>Warning</strong></p>
<p>Due to syntactical ambiguities <code>&lt;@something
              a=x! b=y /&gt;</code> will be interpreted as <code>&lt;@something a=x!(b=y) /&gt;</code>, that is, the <code>b=y</code> will be interpreted as a comparison that gives the default value for <code>x</code>, rather than the specification of the <code>b</code> parameter. To prevent this, write: <code>&lt;@something a=(x!) b=y
              /&gt;</code></p>
</blockquote>
<p>You can use this operator in two ways with non-top-level variables:</p>
<pre><code>product.color!&quot;red&quot;</code></pre>
<p>This will handle if <code>color</code> is missing inside <code>product</code> (and returns <code>&quot;red&quot;</code> if so), but will not handle if <code>product</code> is missing. That is, the <code>product</code> variable itself must exist, otherwise the template processing will die with error.</p>
<pre><code>(product.color)!&quot;red&quot;</code></pre>
<p>This will handle if <code>product.color</code> is missing. That is, if <code>product</code> is missing, or <code>product</code> exists but it does not contain <code>color</code>, the result will be <code>&quot;red&quot;</code>, and no error will occur. The important difference between this and the previous example is that when surrounded with parentheses, it is allowed for any component of the expression to be undefined, while without parentheses only the last component of the expression is allowed to be undefined.</p>
<p>Of course, the default value operator can be used with sequence sub variables as well:</p>
<pre><code>&lt;#assign seq = [&#39;a&#39;, &#39;b&#39;]&gt;
${seq[0]!&#39;-&#39;}
${seq[1]!&#39;-&#39;}
${seq[2]!&#39;-&#39;}
${seq[3]!&#39;-&#39;}</code></pre>
<p>the outpur will be:</p>
<pre><code>a
b
-
-</code></pre>
<p>A negative sequence index (as <code>seq[-1]!'-'</code>) will always cause an error, you can't suppress that with this or any other operator.</p>
<h4 id="dgui_template_exp_missing_test">Missing value test operator</h4>
existence test operator
missing value test operator
testing for null
testing for missing
testing for undefined
is null
<p>Synopsis: <code>unsafe_expr??</code> or <code>(unsafe_expr)??</code></p>
<p>This operator tells if a value is missing or not. Depending on that, the result is either <code>true</code> or <code>false</code>.</p>
<p>Example. Assume no variable called <code>mouse</code> is present:</p>
<pre><code>&lt;#if mouse??&gt;
  Mouse found
&lt;#else&gt;
  No mouse found
&lt;/#if&gt;
Creating mouse...
&lt;#assign mouse = &quot;Jerry&quot;&gt;
&lt;#if mouse??&gt;
  Mouse found
&lt;#else&gt;
  No mouse found
&lt;/#if&gt;</code></pre>
<p>The output will be:</p>
<pre><code>  No mouse found
Creating mouse...
  Mouse found</code></pre>
<p>With non-top-level variables the rules are the same as with the default value operator, that is, you can write <code>product.color??</code> and <code>(product.color)??</code>.</p>
<h3 id="dgui_template_exp_assignment">Assignment Operators</h3>
<p>These are actually not expressions, but parts of the syntax of the assignment directives, such as <a href="#ref_directive_assign"><code>assign</code></a>, <a href="#ref_directive_local"><code>local</code></a> and <a href="#ref_directive_global"><code>global</code></a>. As such, they can't be used anywhere else.</p>
<p><code>&lt;#assign x += y&gt;</code> is shorthand for <code>&lt;#assign x = x + y&gt;</code>, <code>&lt;#assign x
          *= y&gt;</code> is shorthand for <code>&lt;#assign x = x *
          y&gt;</code>, and so on.</p>
<p><code>&lt;#assign x++&gt;</code> differs from <code>&lt;#assign x += 1&gt;</code> (or <code>&lt;#assign x
          = x + 1&gt;</code>) in that it always does arithmetical addition (and fails if the variable is not a number), while the others are overloaded to do string and sequence concatenation and hash addition. <code>&lt;#assign x--&gt;</code> is shorthand for <code>&lt;#assign x -= 1&gt;</code>.</p>
<h3 id="dgui_template_exp_parentheses">Parentheses</h3>
parentheses
<p>Parentheses can be used to group any expressions. Some examples:</p>
<pre><code>                               &lt;#-- Output will be: --&gt;
${3 * 2 + 2}                   &lt;#-- 8 --&gt;
${3 * (2 + 2)}                 &lt;#-- 12 --&gt;
${3 * ((2 + 2) * (1 / 2))}     &lt;#-- 6 --&gt;
${&quot;green &quot; + &quot;mouse&quot;?upper_case}    &lt;#-- green MOUSE --&gt;
${(&quot;green &quot; + &quot;mouse&quot;)?upper_case}  &lt;#-- GREEN MOUSE --&gt;
&lt;#if !(color == &quot;red&quot; || color == &quot;green&quot;)&gt;
  The color is nor red nor green
&lt;/#if&gt;</code></pre>
<p>Note that the parentheses of a <a href="#dgui_template_exp_methodcall">method call expressions</a> have nothing to do with the parentheses used for grouping.</p>
<h3 id="dgui_template_exp_whitespace">White-space in expressions</h3>
<p>FTL ignores superfluous <a href="#gloss.whiteSpace">white-space</a> in expressions. So these are totally equivalent:</p>
<pre><code>${x + &quot;:&quot; + book.title?upper_case}</code></pre>
<p>and</p>
<pre><code>${x+&quot;:&quot;+book.title?upper_case}</code></pre>
<p>and</p>
<pre><code>${
   x
 + &quot;:&quot;   +  book   .   title
   ?   upper_case
      }</code></pre>
<h3 id="dgui_template_exp_comment">Comments in expressions</h3>
comment
<p>Expression may contain comments anywhere where they can contain ignored white-space (<a href="#dgui_template_exp_whitespace">see above</a>). Comments look like <code>&lt;#-- ... --&gt;</code> or as <code>[#--
          ... --]</code>. Example:</p>
<pre><code>&lt;#assign x &lt;#-- A comment --&gt; = 123 &lt;#-- A comment --&gt;&gt;
&lt;#function f(x &lt;#-- A comment --&gt;, y &lt;#-- A comment --&gt;)&gt;
  &lt;#return &lt;#-- A comment --&gt; 1 &lt;#-- A comment --&gt;&gt;
&lt;/#function&gt;
&lt;#assign someHash = {
    &quot;foo&quot;: 123, &lt;#-- A comment --&gt;
    &quot;bar&quot;: x &lt;#-- A comment --&gt; + 1,
    &lt;#-- A comment --&gt;
    &quot;baaz&quot;: f(1 &lt;#-- A comment --&gt;, 2 &lt;#-- A comment --&gt;)
} &lt;#-- A comment --&gt;&gt;</code></pre>
<h3 id="dgui_template_exp_precedence">Operator precedence</h3>
precedence
operator precedence
<p>The following table shows the precedence assigned to the operators. The operators in this table are listed in precedence order: the higher in the table an operator appears, the higher its precedence. Operators with higher precedence are evaluated before operators with a relatively lower precedence. Operators on the same line have equal precedence. When binary operators (operators with two “parameters”, as <code>+</code> and <code>-</code>) of equal precedence appear next to each other, they are evaluated in left-to-right order.</p>
<table>
<thead>
<tr class="header">
<th>Operator group</th>
<th>Operators</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>highest precedence operators</td>
<td><code>[subvarName]
                [subStringRange] . ?
                (methodParams)
                expr!
                expr??</code></td>
</tr>
<tr class="even">
<td>unary prefix operators</td>
<td><code>+expr
                -expr !expr</code></td>
</tr>
<tr class="odd">
<td>multiplicative operators</td>
<td><code>* / %</code></td>
</tr>
<tr class="even">
<td>additive operators</td>
<td><code>+ -</code></td>
</tr>
<tr class="odd">
<td>numerical ranges</td>
<td><code>..</code> <code>..&lt;</code> <code>..!</code> <code>..*</code></td>
</tr>
<tr class="even">
<td>relational operators</td>
<td><code>&lt; &gt; &lt;= &gt;=</code> (and equivalents: <code>gt</code>, <code>lt</code>, etc.)</td>
</tr>
<tr class="odd">
<td>equality operators</td>
<td><code>== !=</code> (and equivalents: <code>=</code>)</td>
</tr>
<tr class="even">
<td>logical “and” operator</td>
<td><code>&amp;&amp;</code></td>
</tr>
<tr class="odd">
<td>logical “or” operator</td>
<td><code>||</code></td>
</tr>
</tbody>
</table>
<p>For those of you who know C, Java language or JavaScript, note that the precedence rules are the same as in those languages, except that FTL has some operators that do not exist in those languages.</p>
<p>The default value operator (<code>exp!exp</code>) is not yet in the table because of a programming mistake, which will be only fixed in FreeMarker 2.4 due to backward compatibility constraints. It meant to be a &quot;highest precedence operator&quot;, but in FreeMarker 2.3.x the precedence on its right side is very low by accident. So if you have a composite expression on the right side, always use paranthesses, etiher like <code>x!(y + 1)</code> or like <code>(x!y) + 1</code>. Never write just <code>x!y +
          1</code>.</p>
<h2 id="dgui_template_valueinsertion">Interpolations</h2>
interpolation
${...}
<h3>Overview</h3>
<p>The format of interpolations is <code>${expression}</code>, where <code>expression</code> can be all kind of expression (e.g. <code>${100 + x}</code>).</p>
<p>The interpolation is used to insert the value of the <code>expression</code> converted to text (to string). Interpolations can be used only on two places: in <a href="#dgui_template_overallstructure">text sections</a> (e.g., <code>&lt;h1&gt;Hello ${name}!&lt;/h1&gt;</code>) and <a href="#dgui_template_exp_stringop_interpolation">in string literal expressions</a> (e.g., <code>&lt;#include
          &quot;/footer/${company}.html&quot;&gt;</code>).</p>
<p>The result of the expression must be a string, number or date/time/date-time value, because (by default) only these types are converted to string by interpolation automatically. Values of other types (such as booleans, sequences) must be converted to string “manually” (see some advices later), or an error will stop the template processing.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>It's a frequent mistake to use interpolations on places where they needn't/shouldn't/can't be used. Interpolations work <em>only</em> in <a href="#dgui_template_overallstructure">text sections</a> (e.g. <code>&lt;h1&gt;Hello ${name}!&lt;/h1&gt;</code>) and in <a href="#dgui_template_exp_direct_string">string literals</a> (e.g. <code>&lt;#include
            &quot;/footer/${company}.html&quot;&gt;</code>). A typical <em>WRONG</em> usage is <code>&lt;#if
            ${big}&gt;...&lt;/#if&gt;</code>, which will give syntactical error. You should simply write <code>&lt;#if
            big&gt;...&lt;/#if&gt;</code>. Also, <code>&lt;#if
            &quot;${big}&quot;&gt;...&lt;/#if&gt;</code> is <em>WRONG</em>, since it converts the parameter value to string and the <code>if</code> directive wants a boolean value, so it will cause a runtime error.</p>
</blockquote>
<h3>Automatic escaping</h3>
<p>If the interpolation is in a <a href="#dgui_template_overallstructure">text section</a> (not in a <a href="#dgui_template_exp_stringop_interpolation">string literal expression</a>), the text that it inserts goes through automatically escaping, <em>if FreeMarker was properly configured</em>. <a href="#dgui_quickstart_template_autoescaping">See more about escaping here...</a>.</p>
<h3>Guide to inserting numerical values</h3>
<p>If the expression evaluates to a number then the numerical value will be converted to string according the default number format. This may includes the maximum number of decimals, grouping, and like. Usually the programmer should set the default number format; the template author doesn't have to deal with it (but he can with the <code>number_format</code> setting; see in the <a href="#ref_directive_setting">documentation of <code>setting</code> directive</a>). Also, you can override the default number format for a single interpolation with the <a href="#ref_builtin_string_for_number"><code>string</code> built-in</a>.</p>
<p>The decimal separator used (and other such symbols, like the group separator) depends on the current locale (language, country), that also should be set by the programmer. For example, this template:</p>
<pre><code>${1.5}</code></pre>
<p>will print something like this if the current locale is English:</p>
<pre><code>1.5</code></pre>
<p>but if the current locale is German then it will print something like:</p>
<pre><code>1,5</code></pre>
<p>since German people use comma as decimal separator.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>As you can see, interpolations print for human audience (by default at least), as opposed to ''computer audience''. In some cases this is not good, like when you print a database record ID as the part of an URL or as an invisible field value in a HTML form, or when you print CSS/JavaScript numerical literals, because these printed values will be read by computer programs and not by humans. Most computer programs are very particular about the format of the numbers, and understand only a kind of simple US number formatting. For that, use the <a href="#ref_builtin_c"><code>c</code></a> (stands for ''computer audience'') built-in, for example:</p>
<pre><code>&lt;a href=&quot;/shop/productdetails?id=${product.id?c}&quot;&gt;Details...&lt;/a&gt;</code></pre>
</blockquote>
<h3 id="dgui_template_valueinserion_universal_date">Guide to inserting date/time/date-time values</h3>
<p>If the expression evaluates to a date-like value then that will be transformed to a text according to a default format. Usually the programmer should set the default format; the template author doesn't have to deal with it (but if you care, <a href="#topic.dateTimeFormatSettings">see the <code>date_format</code>, <code>time_format</code> and <code>datetime_format</code> settings</a> in the documentation of the <a href="#ref.directive.setting"><code>setting</code> directive</a>). Also, you can override the default formatting for a single interpolation with the <a href="#ref_builtin_string_for_date"><code>string</code> built-in</a>.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>To display a date-like value as text, FreeMarker must know which parts of it are in use, that is, if only the date part (year, month, day), or only the time part (hour, minute, second, millisecond), or both. Unfortunately, because of the technical limitations of Java platform, for some variables it is not possible to detect this automatically; ask the programmer if the data-model contains such problematic variables. When it's not possible to find out which parts of the date are in use, then you must help FreeMarker with the <a href="#ref_builtin_date_datetype"><code>date</code>, <code>time</code> and <code>datetime</code></a> built-ins (like <code>${lastUpdated?datetime}</code>), or it will stop with error.</p>
</blockquote>
<h3>Guide to inserting boolean values</h3>
<p>By default an attempt to print boolean values with interpolation causes an error and aborts template processing. For example this will cause an error: <code>${a == 2}</code> and will not print ''true'' or something like that. That's because there's no universally useful way of representing booleans (sometimes you want to print yes/no, sometimes enabled/disabled, on/off, etc.).</p>
<p>However, you can convert booleans to strings with the <a href="#ref_builtin_string_for_boolean"><code>?string</code> built-in</a>. For example, to print the value of the &quot;married&quot; variable (assuming it's a boolean), you could write <code>${married?string(&quot;yes&quot;, &quot;no&quot;)}</code>.</p>
<p>FreeMarker can be configured with a default boolean format with the <code>boolean_format</code> setting, then <code>${married}</code> and such will work. However, in most applications it's not recommended, as boolean should be rendered differently on different places, and leaving the formatting on the default is possibly just an oversight and thus should generate error.</p>
<p>When you want to generate JavaScript or other computer language parts, then <code>${someBoolean?c}</code> (“c” stands for computer audience) should be used to print true/false. (Remember that <code>?c</code> was also used to print numbers for computer audience.)</p>
<h3>Exact conversion rules</h3>
<p>For those who are interested, the exact rules of conversion from the expression value to string (which is then still subject to escaping) are these, in this order:</p>
<ol type="1">
<li><p>If the value is a number, then it is converted to string in the format specified with the <code>number_format</code> setting. So this usually formats for human audience, as opposed to computer audience.</p></li>
<li><p>Else if the value is date, time or date-time, then it is converted to string in the format specified with the <code>date_format</code>, <code>time_format</code> or <code>datetime_format</code> setting, respectively. If it can't be detected what kind of date-like value it is (date vs time vs date-time), an error will occur.</p></li>
<li><p>Else if the value is a string, then there is no conversion.</p></li>
<li><p>Else if the engine is in classic compatibility mode:</p>
<ol type="1">
<li><p>If the value is a boolean, true values are converted to &quot;true&quot;, false values are converted to an empty string.</p></li>
<li><p>If the expression is undefined (<code>null</code> or a variable is undefined), it is converted to an empty string.</p></li>
<li><p>Else an error will abort the template processing.</p></li>
</ol></li>
<li><p>Else an error will abort the template processing.</p></li>
</ol>
<h1 id="dgui_misc">Miscellaneous</h1>
Do we need a short chapter on i18n/charset issues in general, with the introduction of FreeMarker facilities on this field at the end?
<h2 id="dgui_misc_userdefdir">Defining your own directives</h2>
macro
transform
custom directive
user-defined directive
directive
user-defined
tag
user-defined
<p>As far as template authors are concerned, user-defined directives can be defined using the <code>macro</code> directive. Java programmers who want to implement directives in Java Language, rather than in a template, should use <code>freemarker.template.TemplateDirectiveModel</code> (see <a href="#pgui_datamodel_directive">more here...</a>).</p>
<h3>Basics</h3>
defining macro
<p>A macro is a template fragment associated with a variable. You can use that variable in your template as a user-defined directive, so it helps in repetitive tasks. For example, this creates a macro variable that prints a big “Hello Joe!”:</p>
<pre><code>&lt;#macro greet&gt;
  &lt;font size=&quot;+2&quot;&gt;Hello Joe!&lt;/font&gt;
&lt;/#macro&gt;</code></pre>
<p>The <code>macro</code> directive itself does not print anything; it just creates the macro variable, so there will be a variable called <code>greet</code>. Things between the <code>&lt;#macro greet&gt;</code> and <code>&lt;/#macro&gt;</code> (called <em>macro definition body</em>) will be executed only when you use the variable as directive. You use user-defined directives by writing <code>@</code> instead of <code>#</code> in the FTL tag. Use the variable name as the directive name. Also, the <a href="#gloss.endTag">end-tag</a> for user-defined directives is mandatory. So you use <code>greet</code> like this:</p>
<pre><code>&lt;@greet&gt;&lt;/@greet&gt;</code></pre>
<p>But since <code>&lt;anything&gt;&lt;/anything&gt;</code> is equivalent with <code>&lt;anything/&gt;</code> you should use this shorter form (that is familiar for you if you know <a href="#gloss.XML">XML</a>):</p>
<pre><code>&lt;@greet/&gt;</code></pre>
<p>This will print:</p>
<pre><code>  &lt;font size=&quot;+2&quot;&gt;Hello Joe!&lt;/font&gt;
  </code></pre>
<p>But macros can do much more, since the thing between <code>&lt;#macro ...&gt;</code> and <code>&lt;/#macro&gt;</code> is a template fragment, thus it can contain interpolations (<code>${...}</code>) and FTL tags (e.g. <code>&lt;#if
          ...&gt;...&lt;/#if&gt;</code>).</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Programmers will say on <code>&lt;@...&gt;</code> that you <em>call</em> the macro.</p>
</blockquote>
<h3>Parameters</h3>
<p>Let's improve the <code>greet</code> macro so it can use arbitrary name, not only “Joe”. For this purpose you can use <em>parameters</em>. You define the parameters after the name of the macro in the <code>macro</code> directive. Here we define one parameter for the <code>greet</code> macro, <code>person</code>:</p>
<pre><code>&lt;#macro greet person&gt;
  &lt;font size=&quot;+2&quot;&gt;Hello ${person}!&lt;/font&gt;
&lt;/#macro&gt;</code></pre>
<p>and then you can use this macro as:</p>
<pre><code>&lt;@greet person=&quot;Fred&quot;/&gt; and &lt;@greet person=&quot;Batman&quot;/&gt;</code></pre>
<p>which is similar to HTML syntax. This will print:</p>
<pre><code>  &lt;font size=&quot;+2&quot;&gt;Hello Fred!&lt;/font&gt;
 and   &lt;font size=&quot;+2&quot;&gt;Hello Batman!&lt;/font&gt;
 </code></pre>
<p>As you can see, the actual value of the macro parameter is accessible in the macro definition body as a variable (<code>person</code>). As with <a href="#gloss.predefinedDirective">predefined directives</a>, the value of a parameter (the right side of <code>=</code>) is an <a href="#dgui_template_exp">FTL expression</a>. Thus, unlike with HTML, the quotation marks around <code>&quot;Fred&quot;</code> and <code>&quot;Batman&quot;</code> are not optional. <code>&lt;@greet person=Fred/&gt;</code> would mean that you use the value of variable <code>Fred</code> for the <code>person</code> parameter, rather than the string <code>&quot;Fred&quot;</code>. Of course parameter value need not be a string, it can be number, boolean, hash, sequence, etc., also you can use complex expression on the right side of <code>=</code> (e.g. <code>someParam=(price + 50)*1.25</code>).</p>
<p>User-defined directives can have multiple parameters. For example, add a new parameter <code>color</code>:</p>
<pre><code>&lt;#macro greet person color&gt;
  &lt;font size=&quot;+2&quot; color=&quot;${color}&quot;&gt;Hello ${person}!&lt;/font&gt;
&lt;/#macro&gt;</code></pre>
<p>and then you can use this macro like:</p>
<pre><code>&lt;@greet person=&quot;Fred&quot; color=&quot;black&quot;/&gt;</code></pre>
<p>The order of parameters is not important, so this is equivalent with the previous:</p>
<pre><code>&lt;@greet color=&quot;black&quot; person=&quot;Fred&quot;/&gt;</code></pre>
<p>When you call the macro, you can use only parameters that you have defined in the <code>macro</code> directive (in this case: <code>person</code> and <code>color</code>). So if you try <code>&lt;@greet person=&quot;Fred&quot; color=&quot;black&quot;
          background=&quot;green&quot;/&gt;</code> then you will get an error, since you haven't mentioned parameter <code>background</code> in the <code>&lt;#macro
          ...&gt;</code>.</p>
<p>Also, you must give value for all parameters that you have defined for the macro. So if you try <code>&lt;@greet
          person=&quot;Fred&quot;/&gt;</code> then you will get an error, since you forgot to specify the value of <code>color</code>. However, it often happens that you would specify the same value for a parameter in most cases, so you want to specify the value only when you want a different value for it than the usual. This can be achieved if you specify the parameter in the <code>macro</code> directive as <code>param_name=usual_value</code>. For example, you want to use <code>&quot;black&quot;</code> for <code>color</code> if you don't specify value for that parameter when you use the <code>greet</code> directive:</p>
<pre><code>&lt;#macro greet person color=&quot;black&quot;&gt;
  &lt;font size=&quot;+2&quot; color=&quot;${color}&quot;&gt;Hello ${person}!&lt;/font&gt;
&lt;/#macro&gt;</code></pre>
<p>Now <code>&lt;@greet person=&quot;Fred&quot;/&gt;</code> is OK, since it is equivalent with <code>&lt;@greet person=&quot;Fred&quot;
          color=&quot;black&quot;/&gt;</code>, thus the value of <code>color</code> parameter is known. If you want <code>&quot;red&quot;</code> for <code>color</code>, then you write <code>&lt;@greet person=&quot;Fred&quot; color=&quot;red&quot;/&gt;</code>, and this value will override the usual value specified with the <code>macro</code> directive, so the value of <code>color</code> parameter will be <code>&quot;red&quot;</code>.</p>
<p>Also, it is important to realize that -- according to the already explained <a href="#dgui_template_exp">FTL expression rules</a> -- <code>someParam=foo</code> and <code>someParam=&quot;${foo}&quot;</code> are very different. In the fist case, you use the value of variable <code>foo</code> as the value of the parameter. In the second case, you use a <a href="#dgui_template_exp_stringop_interpolation">string literal with interpolation</a>, so the value of the parameter will be a string -- in this case, the value of <code>foo</code> rendered to text -- regardless of the type (as number, date, etc.) of <code>foo</code>. Or, another example: <code>someParam=3/4</code> and <code>someParam=&quot;${3/4}&quot;</code> are different. If the directive wants a numerical value for <code>someParam</code>, it will not like the second variation. Do not exchange these.</p>
<p>A very important aspect of macro parameters is that they are local variables. For more information about local variables please read: <a href="#dgui_misc_var">section_title</a></p>
<h3>Nested content</h3>
<p>Custom directive can have nested content, similarly as predefined directives like <code>&lt;#if
          ...&gt;nested
          content&lt;/#if&gt;</code> can have. For example, this creates a macro that draws borders around its nested content:</p>
<pre><code>&lt;#macro border&gt;
  &lt;table border=4 cellspacing=0 cellpadding=4&gt;&lt;tr&gt;&lt;td&gt;
    &lt;#nested&gt;
  &lt;/tr&gt;&lt;/td&gt;&lt;/table&gt;
&lt;/#macro&gt;</code></pre>
<p>The <code>&lt;#nested&gt;</code> directive executes the template fragment between the start-tag and end-tags of the directive. So if you do this:</p>
<pre><code>&lt;@border&gt;The bordered text&lt;/@border&gt;</code></pre>
<p>the output will be:</p>
<pre><code>  &lt;table border=4 cellspacing=0 cellpadding=4&gt;&lt;tr&gt;&lt;td&gt;
    The bordered text
  &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
 </code></pre>
<p>The <code>nested</code> directive can be called for multiple times, for example:</p>
<pre><code>&lt;#macro do_thrice&gt;
  &lt;#nested&gt;
  &lt;#nested&gt;
  &lt;#nested&gt;
&lt;/#macro&gt;
&lt;@do_thrice&gt;
  Anything.
&lt;/@do_thrice&gt;</code></pre>
<p>will print:</p>
<pre><code>  Anything.
  Anything.
  Anything.</code></pre>
<p>If you don't use the <code>nested</code> directive, then the nested content will not be executed. Thus, if you accidentally use the <code>greet</code> directive like this:</p>
<pre><code>&lt;@greet person=&quot;Joe&quot;&gt;
  Anything.
&lt;/@greet&gt;</code></pre>
<p>then FreeMarker will not see this as an error, and simply prints:</p>
<pre><code>&lt;font size=&quot;+2&quot;&gt;Hello Joe!&lt;/font&gt;</code></pre>
<p>and the nested content will be ignored, since the <code>greet</code> macro never uses <code>nested</code> directive.</p>
<p>The nested content can be anything that is valid FTL, including other user-defined directives. Thus this is OK:</p>
<pre><code>&lt;@border&gt;
  &lt;ul&gt;
  &lt;@do_thrice&gt;
    &lt;li&gt;&lt;@greet person=&quot;Joe&quot;/&gt;
  &lt;/@do_thrice&gt;
  &lt;/ul&gt;
&lt;/@border&gt;</code></pre>
<p>and will print:</p>
<pre><code>  &lt;table border=4 cellspacing=0 cellpadding=4&gt;&lt;tr&gt;&lt;td&gt;
      &lt;ul&gt;
    &lt;li&gt;&lt;font size=&quot;+2&quot;&gt;Hello Joe!&lt;/font&gt;

    &lt;li&gt;&lt;font size=&quot;+2&quot;&gt;Hello Joe!&lt;/font&gt;

    &lt;li&gt;&lt;font size=&quot;+2&quot;&gt;Hello Joe!&lt;/font&gt;

  &lt;/ul&gt;

  &lt;/tr&gt;&lt;/td&gt;&lt;/table&gt;</code></pre>
<p>The <a href="#dgui_misc_var">local variables</a> of a macro are not visible in the nested content. Say, this:</p>
<pre><code>&lt;#macro repeat count&gt;
  &lt;#local y = &quot;test&quot;&gt;
  &lt;#list 1..count as x&gt;
    ${y} ${count}/${x}: &lt;#nested&gt;
  &lt;/#list&gt;
&lt;/#macro&gt;
&lt;@repeat count=3&gt;${y!&quot;?&quot;} ${x!&quot;?&quot;} ${count!&quot;?&quot;}&lt;/@repeat&gt;</code></pre>
<p>will print this:</p>
<pre><code>    test 3/1: ? ? ?
    test 3/2: ? ? ?
    test 3/3: ? ? ?</code></pre>
<p>because the <code>y</code>, <code>x</code> and <code>count</code> are the local (private) variables of the macro, and are not visible from outside the macro definition. Furthermore, a different set of local variables is used for each macro call, so this will not cause confusion:</p>
<pre><code>&lt;#macro test foo&gt;${foo} (&lt;#nested&gt;) ${foo}&lt;/#macro&gt;
&lt;@test foo=&quot;A&quot;&gt;&lt;@test foo=&quot;B&quot;&gt;&lt;@test foo=&quot;C&quot;/&gt;&lt;/@test&gt;&lt;/@test&gt;</code></pre>
<p>and will print this:</p>
<pre><code>A (B (C () C) B) A</code></pre>
<h3 id="dgui_misc_userdefdir_loopvar">Macros with loop variables</h3>
loop variable
<p>Predefined directives like <code>list</code> can use so-called loop variables; you should read <a href="#dgui_misc_var">section_title</a> to understand loop variables.</p>
<p>User-defined directives can also have loop variables. For example, let's extend the <code>do_thrice</code> directive of the earlier examples so it exposes the current repetition number as a loop variable. As with the predefined directives (as <code>list</code>) the <em>name</em> of loop variables is given when you call the directive (as <code>foo</code> in <code>&lt;#list foos as
          foo&gt;...&lt;/#list&gt;</code>), while the <em>value</em> of the variables is set by the directive itself.</p>
<pre><code>&lt;#macro do_thrice&gt;
  &lt;#nested 1&gt;
  &lt;#nested 2&gt;
  &lt;#nested 3&gt;
&lt;/#macro&gt;
&lt;@do_thrice ; x&gt; &lt;#-- user-defined directive uses &quot;;&quot; instead of &quot;as&quot; --&gt;
  ${x} Anything.
&lt;/@do_thrice&gt;</code></pre>
<p>This will print:</p>
<pre><code>  1 Anything.
  2 Anything.
  3 Anything.
 </code></pre>
<p>The syntactical rule is that you pass the actual value of the loop variable for a certain &quot;loop&quot; (i.e. repetition of the nested content) as the parameter of <code>nested</code> directive (of course the parameter can by arbitrary expression). The name of the loop variable is specified in the user-defined directive open tag (<code>&lt;@...&gt;</code>) after the parameters and a semicolon.</p>
<p>A macro can use more the one loop variable (the order of variables is significant):</p>
<pre><code>&lt;#macro repeat count&gt;
  &lt;#list 1..count as x&gt;
    &lt;#nested x, x/2, x==count&gt;
  &lt;/#list&gt;
&lt;/#macro&gt;
&lt;@repeat count=4 ; c, halfc, last&gt;
  ${c}. ${halfc}&lt;#if last&gt; Last!&lt;/#if&gt;
&lt;/@repeat&gt;</code></pre>
<p>The output will be:</p>
<pre><code>  1. 0.5
  2. 1
  3. 1.5
  4. 2 Last!
 </code></pre>
<p>It is not a problem if you specify different number of loop variables in the user-defined directive start-tag (that is, after the semicolon) than with the <code>nested</code> directive. If you specify less loop variables after the semicolon, then simply you will not see the last few values that the <code>nested</code> directive provides, since there is no loop variable to hold those values. So these are all OK:</p>
<pre><code>&lt;@repeat count=4 ; c, halfc, last&gt;
  ${c}. ${halfc}&lt;#if last&gt; Last!&lt;/#if&gt;
&lt;/@repeat&gt;
&lt;@repeat count=4 ; c, halfc&gt;
  ${c}. ${halfc}
&lt;/@repeat&gt;
&lt;@repeat count=4&gt;
  Just repeat it...
&lt;/@repeat&gt;</code></pre>
<p>If you specify more variables after the semicolon than with the <code>nested</code> directive, then the last few loop variables will not be created (i.e. will be undefined in the nested content).</p>
<h3>More about user-defined directives and macros</h3>
<p>Now you may read the relevant parts of the FreeMarker Reference:</p>
<ul>
<li><p><a href="#ref.directive.userDefined">user-defined directive call</a></p></li>
<li><p><a href="#ref.directive.macro"><code>macro</code> directive</a></p></li>
</ul>
<p>You can define methods in FTL as well, see <a href="#ref.directive.function">the <code>function</code> directive</a>.</p>
<p>Also, you may interested in namespaces: <a href="#dgui_misc_namespace">section_title</a>. Namespaces help you to organize and reuse your commonly used macros.</p>
<p>Java programmers might want to know that directives (macros are directives) and methods (function-like things) can also be written in Java language, by<a href="#pgui_datamodel_directive">implementing the <code>TemplateDirectiveModel</code></a> or <code>TemplateMethodModelEx</code> interfaces, respectively. Then you can pull in the Java implementations into the template like <code>&lt;#assign foo =
          &quot;com.example.FooDirective&quot;?new()&gt;</code> or <code>&lt;#assign foo =
          &quot;com.example.FooMethod&quot;?new()&gt;</code> on the same place where you would have <code>&lt;#macro foo
          ...&gt;</code> or <code>&lt;#function foo
          ...&gt;</code> otherwise.</p>
<h2 id="dgui_misc_var">Defining variables in the template</h2>
variable
loop variable
local variable
temporary variable
<p>Most of the variables that a typical template works with comes from the data-model. But templates can also define variables themselves, usually to hold loops variables, temporary results, macros, etc. Such variables are outside the data-model; modifying the data-model from templates is by design unsupported. Note that each <a href="#gloss.templateProcessingJob">template processing job</a> has its own private set of these variables, which will be thrown away when the template processing job is finished.</p>
<p>You access variables defined in the template the same way as you access variables defined in the data-model root. For example, if you create a variable called “foo” in the template, you can print its value with <code>${foo}</code>. If, coincidently, there's a variable called “foo” in the data-model too, the variable created in the template will hide (not overwrite!) it.</p>
<p>There are these kinds of variables that are defined in a template:</p>
<ul>
<li><p><em>“plain” variables</em>: They are accessible from everywhere in the template, or from another templates that was inserted with the <a href="#ref.directive.include"><code>include</code> directive</a>. You can create and replace these variables with the <a href="#ref.directive.assign"><a href="#ref.directive.assign"><code>assign</code></a> directive</a>, or, because macros and functions are just variables, with the <a href="#ref.directive.macro"><code>macro</code> directives</a> and <a href="#ref.directive.function"><code>function</code> directives</a>.</p></li>
<li><p><em>Local variables</em>: They can only be set inside a <a href="#gloss.macroDefinitionBody">macro definition body</a> or <a href="#gloss.functionDefinitionBody">function definition body</a>, and are only visible from there, not from other macros or functions called from there. A local variable only exists for the duration of a macro or function call. You can create and replace local variables inside the definition body with the <a href="#ref.directive.local"><code>local</code> directive</a>. <a href="#ref.directive.macro">Macro</a> and <a href="#ref.directive.function">function</a> parameters are also local variables.</p></li>
<li><p><em>Loop variables</em>: Loop variables are created automatically by directives like <a href="#ref.directive.list"><code>list</code></a> (like <code>x</code> in <code>&lt;#list xs as
            x&gt;...&lt;/#list&gt;</code>), and they only exist between the start-tag and end-tag of the directive. They are only visible directly between these tags, not from macros or functions called from there. As such, they are quite similar to local variables, but they can't be assigned to directly.</p></li>
<li><p><em>Global variables</em>: These should be seldom used. Global variables are shared by all templates, even if they belong to different name spaces because of <a href="#ref.directive.import"><code>import</code>-ing</a>. Thus, their visibility is similar to data-model variables. They are set via the <a href="#ref.directive.global"><code>global</code> directive</a>. Global variables hide (but don't overwrite) the data-model variables of the same name.</p></li>
</ul>
<p>Example: Create and replace variables with <code>assign</code>:</p>
<pre><code>&lt;#assign x = 1&gt;  &lt;#-- create variable x --&gt;
${x}
&lt;#assign x = 2&gt; &lt;#-- replace variable x --&gt;
${x}
&lt;#assign x++&gt; &lt;#-- replace variable x --&gt;
${x}</code></pre>
<pre><code>1
2
3</code></pre>
<p>In the next example we demonstrate that local variables hide (not overwrite) “plain” variables of the same name, and that loop variables hide (not overwrite) local and “plain” variables of the same name:</p>
<pre><code>&lt;#assign x = &quot;plain&quot;&gt;
1. ${x}  &lt;#-- we see the plain var. here --&gt;
&lt;@test/&gt;
6. ${x}  &lt;#-- the value of plain var. was not changed --&gt;
&lt;#list [&quot;loop&quot;] as x&gt;
    7. ${x}  &lt;#-- now the loop var. hides the plain var. --&gt;
    &lt;#assign x = &quot;plain2&quot;&gt; &lt;#-- replaces the plain var, not the loop var. --&gt;
    8. ${x}  &lt;#-- it still hides the plain var. --&gt;
&lt;/#list&gt;
9. ${x}  &lt;#-- now the new value of plain var. becomse visible --&gt;

&lt;#macro test&gt;
  2. ${x}  &lt;#-- we still see the plain var. here --&gt;
  &lt;#local x = &quot;local&quot;&gt;
  3. ${x}  &lt;#-- now the local var. hides it --&gt;
  &lt;#list [&quot;loop&quot;] as x&gt;
    4. ${x}  &lt;#-- now the loop var. hides the local var. --&gt;
  &lt;/#list&gt;
  5. ${x}  &lt;#-- now we see the local var. again --&gt;
&lt;/#macro&gt;</code></pre>
<pre><code>1. plain
  2. plain
  3. local
    4. loop
  5. local
6. plain
    7. loop
    8. loop
9. plain2 </code></pre>
<p>In the next example we demonstrate that an inner loop variable can hide (not overwrite) an outer loop variable of the same name:</p>
<pre><code>&lt;#list [&quot;loop 1&quot;] as x&gt;
  ${x}
  &lt;#list [&quot;loop 2&quot;] as x&gt;
    ${x}
    &lt;#list [&quot;loop 3&quot;] as x&gt;
      ${x}
    &lt;/#list&gt;
    ${x}
  &lt;/#list&gt;
  ${x}
&lt;/#list&gt;</code></pre>
<pre><code>  loop 1
    loop 2
      loop 3
    loop 2
  loop 1</code></pre>
<p>When a variable hides the variable from the data-model, you can still read that variable from the data-model using <a href="#dgui_template_exp_var_special">special variable</a> <code>globals</code>. For example, assume we have a variable called <code>user</code> in the data-model with value “Big Joe”:</p>
<pre><code>${user}          &lt;#-- prints: Big Joe --&gt;
&lt;#assign user = &quot;Joe Hider&quot;&gt;
${user}          &lt;#-- prints: Joe Hider --&gt;
${.globals.user} &lt;#-- prints: Big Joe --&gt;</code></pre>
<p>You could also write <code>.data_model.user</code> instead, and then not even a <code>&lt;#global user =
        &quot;...&quot;&gt;</code> can hide the value in the data-model. However, global variables are often purposely set to override the value coming from the data-model, so using <code>globals</code> is a better practice usually.</p>
<p>For information about syntax of variables (allowed characters and such) please read: <a href="#dgui_template_exp">section_title</a></p>
<h2 id="dgui_misc_namespace">Namespaces</h2>
namespaces
libraries
<p>When you run templates, you have a (possibly empty) set of variables that you have created with <code>assign</code> and <code>macro</code> and <code>function</code> directives (see in the <a href="#dgui_misc_var">previous chapter</a>). A set of template-made variables like that is called a <em>namespace</em>. In simple cases you use only one namespace, the <em>main namespace</em>. Whenever you define a variable in the main template (macros and functions are also variables, mind you), or in templates <a href="#ref.directive.include"><code>include</code>-d</a> in it, that's where the variable are created. The key property of a namespace is that the variable name uniquely identifies a value in it (i.e, you can't have multiple variables in it with the same name in the same namespace).</p>
<p>Sometimes you want to build reusable collection of macros, functions, and other variables, which we call a <em>library</em>. It's important that a library can use its own namespace, to avoid accidental name clashes. Consider, you may have many names in that library, and you intend to use the library in many templates, maybe even reuse it in several projects. It becomes impractical to keep track of where the library used in another template accidentally hides variables from the data-model, or what names you shouldn't assign to in the template to avoid overwriting the variables of the library. If you have multiple libraries used in the same template, this becomes even harder to track. So you should use a separate namespace for the variables of each library.</p>
<h3>Creating a library</h3>
<p>Here's a simple library, which contains a <code>copyright</code> macro and a <code>mail</code> string:</p>
<pre><code>&lt;#macro copyright date&gt;
  &lt;p&gt;Copyright (C) ${date} Someone. All rights reserved.&lt;/p&gt;
&lt;/#macro&gt;

&lt;#assign mail = &quot;user@example.com&quot;&gt;</code></pre>
<p>Save this into the <code>lib/example.ftl</code> file (inside the directory where you store the templates). Then create a template, let's say, <code>some_web_page.ftl</code>, and use the library in it:</p>
<pre><code>&lt;#import &quot;/lib/example.ftl&quot; as e&gt;

Some Web page...
&lt;@e.copyright date=&quot;1999-2002&quot;/&gt;
${e.mail}</code></pre>
<pre><code>Some Web page...
  &lt;p&gt;Copyright (C) 1999-2002 Someone. All rights reserved.&lt;/p&gt;
user@example.com</code></pre>
<p>Note the <a href="#ref.directive.import"><code>import</code> directive</a> above, and the subsequent usage of the “<code>e</code>” variable. <code>import</code> is similar to the perhaps already familiar <a href="#ref.directive.include"><code>include</code> directive</a>, but it will create an empty namespace and will run <code>lib/example.ftl</code> in that namespace. So <code>lib/example.ftl</code> will find itself in a clean world, where only the variables of the data-models are visible (and the globals), and will create its two variables (<code>copyright</code> and <code>mail</code>) in this clean namespace. But you will need to access those two variables from another namespace (the main namespace), thus, the <code>import</code> directive creates a hash variable (<code>e</code> in this case) to access the namespace it has created . That variable is in the namespace that the <code>import</code>-ing template uses, and acts as a window to the namespace of the imported library.</p>
<p>To demonstrate that the two namespaces are separate, consider the example below. Replace <code>lib/example.ftl</code> with this:</p>
<pre><code>&lt;#macro copyright date&gt;
  &lt;p&gt;Copyright (C) ${date} Someone. All rights reserved.
  &lt;br&gt;Email: ${mail}&lt;/p&gt;
&lt;/#macro&gt;

&lt;#assign mail = &quot;user@example.com&quot;&gt;</code></pre>
<p>and <code>some_web_page.ftl</code> with this:</p>
<pre><code>&lt;#import &quot;/lib/example.ftl&quot; as e&gt;
&lt;#assign mail=&quot;other@example.com&quot;&gt;
&lt;@e.copyright date=&quot;1999-2002&quot;/&gt;
${e.mail}
${mail}</code></pre>
<pre><code>  &lt;p&gt;Copyright (C) 1999-2002 Someone. All rights reserved.
  &lt;br&gt;Email: user@example.com&lt;/p&gt;
user@example.com
other@example.com</code></pre>
<p>As you can see, the <code>mail</code> variable assigned in <code>some_web_page.ftl</code> is separate from the <code>mail</code> variable assigned in the imported library.</p>
<h3>Writing the variables of imported namespaces</h3>
<p>Sometimes you want to create or replace a variable in an imported namespace. You can do that with the <code>assign</code> directive and its <code>namespace</code> parameter:</p>
<pre><code>&lt;#import &quot;/lib/example.ftl&quot; as e&gt;
${e.mail}
&lt;#assign mail=&quot;other@example.com&quot; in e&gt;
${e.mail}</code></pre>
<pre><code>user@example.com
other@example.com</code></pre>
<h3>Namespaces and data-model</h3>
<p>The variables of the data-model are visible from everywhere. For example, if you have a variable called <code>user</code> in the data-model, <code>lib/example.ftl</code> will access that, exactly like <code>some_web_page.ftl</code> does:</p>
<pre><code>&lt;#macro copyright date&gt;
  &lt;p&gt;Copyright (C) ${date} ${user}. All rights reserved.&lt;/p&gt;
&lt;/#macro&gt;</code></pre>
<p>Assuming <code>user</code> is “John Doe”:</p>
<pre><code>&lt;#import &quot;/lib/my_test.ftl&quot; as my&gt;
User is: ${user}
&lt;@my.copyright date=&quot;1999-2002&quot;/&gt;</code></pre>
<pre><code>User is: John Doe
  &lt;p&gt;Copyright (C) 1999-2002 John Doe. All rights reserved.&lt;/p&gt;</code></pre>
<p>Don't forget that the variables in the namespace (the variables you create with <code>assign</code>, <code>macro</code>, and <code>function</code> directives) have precedence over the variables of the data-model when you are in that namespace. So generally, if a library is interested in a data-model variable, it doesn't assign to the same name.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>In some unusual applications you want to create variables in the template that are visible from all namespaces, exactly like the variables of the data-model. While templates can't change the data-model, it's possible to achieve similar effect with the <code>global</code> directive; see the <a href="#ref.directive.global">reference</a>.</p>
</blockquote>
<h3>The life-cycle of namespaces</h3>
<p>A namespace is identified by the path used in the <code>import</code> directive (after it was normalized to an absolute path). If you try to <code>import</code> with equivalent paths for multiple times, it will create the namespace and run the template for only the first invocation of <code>import</code>. The later <code>import</code>-s with equivalent paths will just assign the same namespace to the variable specified after the <code>as</code> keyword. For example:</p>
<pre><code>&lt;#import &quot;/lib/example.ftl&quot; as e&gt;
&lt;#import &quot;/lib/example.ftl&quot; as e2&gt;
&lt;#import &quot;/lib/example.ftl&quot; as e3&gt;
${e.mail}, ${e2.mail}, ${e3.mail}
&lt;#assign mail=&quot;other@example.com&quot; in e&gt;
${e.mail}, ${e2.mail}, ${e3.mail}</code></pre>
<pre><code>user@example.com, user@example.com, user@example.com
other@example.com, other@example.com, other@example.com</code></pre>
<p>As you access the same namespace through <code>e</code>, <code>e2</code>, and <code>e3</code>, the <code>email</code> has changed in all of them at once. The practical importance of this is that when you import the same library in multiple templates, only one namespace will be initialized and created for the library, which will be shared by all the importing templates.</p>
<p>Note that namespaces are not hierarchical; it doesn't mater what namespace are you in when <code>import</code> creates another namespace. For example, when you <code>import</code> namespace N2 while you are in name space N1, N2 will not be inside N1. N1 just gets the same N2 that you get if you <code>import</code> N2 when you are in the main namespace.</p>
<p>Each <a href="#gloss.templateProcessingJob">template processing job</a> has its own private set of namespaces. Each template processing job is a separate universe that exists only for the short period while the main template is rendered, and then it vanishes with all its populated namespaces. Thus, whenever we say that “<code>import</code> is called for the first time”, we always mean the first time within the lifespan of a single template processing job.</p>
<h3>Auto-importing</h3>
<p>When you have to import the same libraries again and again in many templates, know that the Java programmers (or whoever is responsible for configuring FreeMarker) can specify auto-imports, which are imports that are automatically done in all templates. Auto imports can also be configured to be “lazy” (since FreeMarker 2.3.25), which means that they are only done when the imported library is actually used in the template. See the Java API documentation for more details: <a href="http://freemarker.org/docs/api/freemarker/template/Configuration.html#setAutoImports-java.util.Map-">Configuration.setAutoImports</a>, <a href="http://freemarker.org/docs/api/freemarker/template/Configuration.html#setLazyAutoImports-java.lang.Boolean-">Configuration.setLazyAutoImports</a>.</p>
<h2 id="dgui_misc_autoescaping">Auto-escaping and output formats</h2>
escaping
auto-escaping
MIME type
HTML escaping
HTML encoding
XML escaping
XML encoding
<p>This is a <em>detailed</em> tutorial to auto-escaping and related concepts; for the bare minimum, <a href="#dgui_quickstart_template_autoescaping">read this instead</a>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>The kind of automatic escaping described here requires at least FreeMarker 2.3.24. If you have to use an earlier version, use the deprecated <a href="#ref_directive_escape"><code>escape</code> directive</a> instead.</p>
</blockquote>
<h3 id="dgui_misc_autoescaping_outputformat">Output formats</h3>
output format
<p>Each template has an associated output format (a <code>freemarker.core.OutputFormat</code> instance). The output format dictates the escaping rules, which is applied on all <code>${...}</code>-s (and <code>#{...}</code>-s) that aren't <a href="#dgui_misc_autoescaping_stringliteral">inside a string literal</a>. It also specifies a MIME type (e.g. <code>&quot;text/HTML&quot;</code>) and a canonical name (e.g. <code>&quot;HTML&quot;</code>) that the embedding application/framework can use for its own purposes.</p>
<p>It's the programmer's responsibility to <a href="#pgui_config_outputformatsautoesc">associate output format to templates</a>. Furthermore it's recommended that FreeMarker is configured so that templates with <code>ftlh</code> and <code>ftlx</code> file extensions are automatically associated with the HTML and XML output formats, respectively.</p>
<p>The predefined output formats are:</p>
<table>
<thead>
<tr class="header">
<th>Name</th>
<th>Description</th>
<th>MIME Type</th>
<th>Default implementation (<code>freemarker.core.*</code>)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>HTML</code></td>
<td>Escapes <code>&lt;</code>, <code>&gt;</code>, <code>&amp;</code>, <code>&quot;</code>, <code>'</code> as <code>&amp;lt;</code>, <code>&amp;gt;</code>, <code>&amp;amp;</code>, <code>&amp;quot;</code>, <code>&amp;#39;</code></td>
<td><code>text/html</code></td>
<td><code>HTMLOutputFormat.INSTANCE</code></td>
</tr>
<tr class="even">
<td><code>XHTML</code></td>
<td>Escapes <code>&lt;</code>, <code>&gt;</code>, <code>&amp;</code>, <code>&quot;</code>, <code>'</code> as <code>&amp;lt;</code>, <code>&amp;gt;</code>, <code>&amp;amp;</code>, <code>&amp;quot;</code>, <code>&amp;#39;</code></td>
<td><code>application/xhtml+xml</code></td>
<td><code>XHTMLOutputFormat.INSTANCE</code></td>
</tr>
</tbody>
</table>
<p>The programmers can add their your own output formats, so this is maybe not all the output formats in your application!</p>
<h3 id="dgui_misc_autoescaping_overrideoformat">Overriding the output format in templates</h3>
<p>Especially in legacy applications, you will often find that the output format is <code>undefined</code> (you can check that with <code>${.output_format}</code>), and so no automatic escaping is happening. In other cases, a common output format (like HTML) is set for all templates, but a few templates need a different output format. In any case, the output format of a template can be enforced in the <a href="#ref_directive_ftl">the <code>ftl</code> header</a>:</p>
<pre><code>&lt;#ftl output_format=&quot;XML&quot;&gt;
${&quot;&#39;&quot;}  &lt;#-- Prints: &amp;apos; --&gt;</code></pre>
<p>Above, the output format was referred by its name shown in the earlier table <em>(looked up via <code>Configuration.getOutputFormat(String name)</code>, actually)</em>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>If escaping doesn't happen after adding the above <code>ftl</code> header, then <code>&lt;#ftl
            output_format=&quot;XML&quot; auto_esc=true&gt;</code> might helps (and that means that FreeMarker was configured to use “disable” auto-escaping <em>policy</em>, which is generally not recommended).</p>
</blockquote>
<p>The output format can also be applied to only a section of a template, like:</p>
<pre><code>&lt;#-- Let&#39;s assume we have &quot;HTML&quot; output format by default. --&gt;
${&quot;&#39;&quot;}  &lt;#-- Prints: &amp;#39; --&gt;
&lt;#outputformat &quot;XML&quot;&gt;
  ${&quot;&#39;&quot;}  &lt;#-- Prints: &amp;apos; --&gt;
&lt;/#outputformat&gt;
${&quot;&#39;&quot;}  &lt;#-- Prints: &amp;#39; --&gt;</code></pre>
<p>Basically, each position in a template has an associated output format, and as you saw above, it might not be the same everywhere in the template. This association sticks to the positions and won't change as the template executes. So if, for example, you call a macro from inside an <code>outputformat</code> block and the called macro is defined outside that block, it won't get the output format of it. Or, if you have a macro that's defined in a template with HTML output format, no mater from where you call it, that macro will always execute with HTML output format. This is like if you were coloring each characters of the template files by output format in the text editor, and then later when the templates are executed, it only considers the color of the statement being executed. This gives you firm control over the output format and hence escaping; you don't have to consider the possible execution paths that can lead to a point.</p>
<h3 id="dgui_misc_autoescaping_disableautoesc">Disabling auto escaping</h3>
<p>For a single interpolation you can disable auto-escaping with <a href="#ref_builtin_no_esc"><code>?no_esc</code></a>:</p>
<pre><code>&lt;#-- Let&#39;s assume we have &quot;HTML&quot; output format by default. --&gt;
${&#39;&lt;b&gt;test&lt;/b&gt;&#39;}  &lt;#-- prints: &amp;lt;b&amp;gt;test&amp;lt;/b&amp;gt; --&gt;
${&#39;&lt;b&gt;test&lt;/b&gt;&#39;?no_esc}  &lt;#-- prints: &lt;b&gt;test&lt;/b&gt; --&gt;</code></pre>
<p>You can also disable auto escaping for a whole section with the <a href="#ref_directive_noautoesc"><code>noautoesc</code> directive</a>:</p>
<pre><code>${&#39;&amp;&#39;}  &lt;#-- prints: &amp;amp; --&gt;
&lt;#noautoesc&gt;
  ${&#39;&amp;&#39;}  &lt;#-- prints: &amp; --&gt;
  ...
  ${&#39;&amp;&#39;}  &lt;#-- prints: &amp; --&gt;
&lt;/#noautoesc&gt;
${&#39;&amp;&#39;}  &lt;#-- prints: &amp;amp; --&gt;</code></pre>
<p>Just like <code>outputformat</code>, this only applies to the part that's literally inside the block (“coloring” logic).</p>
<p>Auto-escaping can also be disabled for the whole template in the <code>ftl</code> header. It can then be re-enabled for a section with the <a href="#ref_directive_autoesc"><code>autoesc</code> directive</a>:</p>
<pre><code>&lt;#ftl autoesc=false&gt;
${&#39;&amp;&#39;}  &lt;#-- prints: &amp; --&gt;
&lt;#autoesc&gt;
  ${&#39;&amp;&#39;}  &lt;#-- prints: &amp;amp; --&gt;
  ...
  ${&#39;&amp;&#39;}  &lt;#-- prints: &amp;amp; --&gt;
&lt;/#autoesc&gt;
${&#39;&amp;&#39;}  &lt;#-- prints: &amp; --&gt;</code></pre>
<p>You can also force escaping for an individual interpolation when escaping is disabled, with <a href="#ref_builtin_esc"><code>?esc</code></a>:</p>
<pre><code>&lt;#ftl autoesc=false&gt;
${&#39;&amp;&#39;}  &lt;#-- prints: &amp; --&gt;
${&#39;&amp;&#39;?esc}  &lt;#-- prints: &amp;amp; --&gt;</code></pre>
<p>Naturally, both <code>autoesc</code> and <code>?esc</code> works inside <code>noautoesc</code> blocks too.</p>
<h3 id="dgui_misc_autoescaping_movalues">“Markup output” values</h3>
<p>In FTL, <a href="#dgui_datamodel_basics">values have type</a>, like string, number, boolean, etc. One such type is called “markup output”. A value of that type is a piece of text that's already in the output format (like HTML), and hence needs no further escaping. We have already produced such values earlier:</p>
<ul>
<li><p><code>s?esc</code> creates a markup output value out of a string value by escaping all special characters in it.</p></li>
<li><p><code>s?no_esc</code> creates a markup output value out of a string value by assuming that the string already stores markup and so needs no further escaping</p></li>
</ul>
<p>These can be useful outside <code>${...}</code> too. For example, here the caller of the <code>infoBox</code> macro can decide if the message is plain text (hence needs escaping) or HTML (hence it mustn't be escaped):</p>
<pre><code>&lt;#-- We assume that we have &quot;HTML&quot; output format by default. --&gt;

&lt;@infoBox &quot;Foo &amp; bar&quot; /&gt;
&lt;@infoBox &quot;Foo &lt;b&gt;bar&lt;/b&gt;&quot;?no_esc /&gt;

&lt;#macro infoBox message&gt;
  &lt;div class=&quot;infoBox&quot;&gt;
    ${message}
  &lt;/div&gt;
&lt;/#macro&gt;</code></pre>
<pre><code>  &lt;div class=&quot;infoBox&quot;&gt;
    Foo &amp;amp; bar
  &lt;/div&gt;
  &lt;div class=&quot;infoBox&quot;&gt;
    Foo &lt;b&gt;bar&lt;/b&gt;
  &lt;/div&gt;</code></pre>
<p>Another case where you get a markup output value is output capturing:</p>
<pre><code>&lt;#-- We assume that we have &quot;HTML&quot; output format by default. --&gt;
&lt;#assign captured&gt;&lt;b&gt;Test&lt;/b&gt;&lt;/#assign&gt;
Just a string: ${&quot;&lt;b&gt;Test&lt;/b&gt;&quot;}
Captured output: ${captured}</code></pre>
<pre><code>Just a string: &amp;lt;b&amp;gt;Test&amp;lt;/b&amp;gt;
Captured output: &lt;b&gt;Test&lt;/b&gt;</code></pre>
<p>Because the captured output is markup output, it wasn't auto-escaped.</p>
<p>It's important that markup output values aren't strings, and aren't automatically coerced to strings. Thus <code>?upper_case</code>, <code>?starts_with</code> etc., will give an error with them. You won't be able to pass them to Java methods for <code>String</code> parameters either. But sometimes you need the markup that's behind the value as a string, which you can get as <code>markupOutput?markup_string</code>. Be sure you know what you are doing though. Applying string operations on markup (as opposed to on plain text) can result in invalid markup. Also there's the danger of unintended double escaping.</p>
<pre><code>&lt;#-- We assume that we have &quot;HTML&quot; output format by default. --&gt;

&lt;#assign markupOutput1=&quot;&lt;b&gt;Test&lt;/b&gt;&quot;?no_esc&gt;
&lt;#assign markupOutput2=&quot;Foo &amp; bar&quot;?esc&gt;

As expected:
${markupOutput1}
${markupOutput2}

Possibly unintended double escaping:
${markupOutput1?markup_string}
${markupOutput2?markup_string}</code></pre>
<pre><code>As expected:
&lt;b&gt;Test&lt;/b&gt;
Foo &amp;amp; bar

Possibly unintended double escaping:
&amp;lt;b&amp;gt;Test&amp;lt;/b&amp;gt;
Foo &amp;amp;amp; bar</code></pre>
<h3>Further details and tricky cases</h3>
<h4 id="dgui_misc_autoescaping_nonmarkupof">Non-markup output formats</h4>
<p>An output format is said to be a non-markup format if it defines no escaping rules. Examples of such output formats are the <code>undefined</code> format and the <code>plainText</code> format.</p>
<p>These formats produce no <a href="#dgui_misc_autoescaping_movalues">markup output values</a>, hence you can't use <code>?esc</code> or <code>?no_esc</code> when they are the current format. You can use output capturing (like <code>&lt;#assign
            captured&gt;...&lt;/#assign&gt;</code>), but the resulting value will be a string, not a markup output value.</p>
<p>Furthermore, you aren't allowed to use the <code>autoesc</code> directive or <code>&lt;#ftl
            auto_esc=true&gt;</code> when the current output format is non-markup.</p>
<p>Using constructs that aren't supported by the current output format will give <a href="#gloss.parseTimeError">parse-time error</a>.</p>
<h4 id="dgui_misc_autoescaping_mixingoutputformats">Inserting markup output values from other markups</h4>
<p>Each <a href="#dgui_misc_autoescaping_movalues">markup output value</a> has an associated <a href="#dgui_misc_autoescaping_outputformat">output format</a>. When a markup output value is inserted with <code>${...}</code> (or <code>#{...}</code>), it has to be converted to the current output format at the point of insertion (if they differ). As of this writing (2.3.24), such output format conversion will only be successful if the value to convert was created by escaping plain text:</p>
<pre><code>&lt;#-- We assume that we have &quot;HTML&quot; output format by default. --&gt;

&lt;#assign mo1 = &quot;Foo&#39;s bar {}&quot;?esc&gt;
HTLM: ${mo1}
XML:  &lt;#outputformat &#39;XML&#39;&gt;${mo1}&lt;/#outputformat&gt;
RTF:  &lt;#outputformat &#39;RTF&#39;&gt;${mo1}&lt;/#outputformat&gt;

&lt;#assign mo2&gt;&lt;p&gt;Test&lt;/#assign&gt;
HTML: ${mo2}
XML:  &lt;#attempt&gt;&lt;#outputformat &#39;XML&#39;&gt;${mo2}&lt;/#outputformat&gt;&lt;#recover&gt;Failed&lt;/#attempt&gt;
RTF:  &lt;#attempt&gt;&lt;#outputformat &#39;RTF&#39;&gt;${mo2}&lt;/#outputformat&gt;&lt;#recover&gt;Failed&lt;/#attempt&gt;</code></pre>
<pre><code>HTLM: Foo&amp;#39;s bar {}
XML:  Foo&amp;apos;s bar {}
RTF:  Foo&#39;s bar \{\}

HTML: &lt;p&gt;Test
XML:  Failed
RTF:  Failed</code></pre>
<p>But, an output format can also chose to insert pieces of other output formats as is, without converting them. Among the standard output formats, <code>undefined</code> is like that, which is the output format used for templates for which no output format was specified in the configuration:</p>
<pre><code>&lt;#-- We assume that we have &quot;undefined&quot; output format here. --&gt;

&lt;#outputformat &quot;HTML&quot;&gt;&lt;#assign htmlMO&gt;&lt;p&gt;Test&lt;/#assign&gt;&lt;/#outputformat&gt;
&lt;#outputformat &quot;XML&quot;&gt;&lt;#assign xmlMO&gt;&lt;p&gt;Test&lt;/p&gt;&lt;/#assign&gt;&lt;/#outputformat&gt;
&lt;#outputformat &quot;RTF&quot;&gt;&lt;#assign rtfMO&gt;\par Test&lt;/#assign&gt;&lt;/#outputformat&gt;
HTML: ${htmlMO}
XML:  ${xmlMO}
RTF:  ${rtfMO}</code></pre>
<pre><code>HTML: &lt;p&gt;Test
XML:  &lt;p&gt;Test&lt;/p&gt;
RTF:  \par Test</code></pre>
<h4 id="dgui_misc_autoescaping_concatenation">Markup output values and the “+” operator</h4>
<p>As you certainly know, if one of the sides of the <code>+</code> operator is a string then <a href="#dgui_template_exp_stringop_concatenation">it does concatenation</a>. If there's a <a href="#dgui_misc_autoescaping_movalues">markup output value</a> in one side, the other side gets promoted to markup output value of the same output format (if it's not already that), by escaping its string value, and finally the two markups are concatenated to form a new markup output value. Example:</p>
<pre><code>&lt;#-- We assume that we have &quot;HTML&quot; output format by default. --&gt;
${&quot;&lt;h1&gt;&quot;?no_esc + &quot;Foo &amp; bar&quot; + &quot;&lt;/h1&gt;&quot;?no_esc}</code></pre>
<pre><code>&lt;h1&gt;Foo &amp;amp; bar&lt;/h1&gt;</code></pre>
<p>If the two sides of the <code>+</code> operator are markup values of different output formats, the right side operand is converted to the output format of the left side. If that's not possible, then the left side operand is converted to the output format of the right side. If that isn't possible either, that's an error. (See the <a href="#dgui_misc_autoescaping_mixingoutputformats">limitations of conversions here</a>.)</p>
<h4 id="dgui_misc_autoescaping_stringliteral">${...} inside string literals</h4>
<p>When <code>${...}</code> is used inside string <em>expressions</em> (e.g., in <code>&lt;#assign s = &quot;Hello ${name}!&quot;&gt;</code>), it's just a shorthand of using the <code>+</code> operator (<code>&lt;#assign s = &quot;Hello&quot; + name + &quot;!&quot;&gt;</code>). Thus, <code>${...}</code>-s inside string expressions aren't auto-escaped, but of course when the resulting concatenated string is printed later, it will be possibly auto-escaped.</p>
<pre><code>&lt;#-- We assume that we have &quot;HTML&quot; output format by default. --&gt;
&lt;#assign name = &quot;Foo &amp; Bar&quot;&gt;

&lt;#assign s = &quot;&lt;p&gt;Hello ${name}!&quot;&gt;
${s}
&lt;p&gt;Hello ${name}!

To prove that s didn&#39;t contain the value in escaped form:
${s?replace(&#39;&amp;&#39;), &#39;and&#39;}</code></pre>
<pre><code>&amp;lt;p&amp;gt;Hello Foo &amp;amp; Bar!
&lt;p&gt;Hello Foo &amp;amp; Bar!

To prove that &quot;s&quot; didn&#39;t contain the value in escaped form:
&amp;lt;p&amp;gt;Hello Foo and Bar!</code></pre>
<h4>Combined output formats</h4>
<p>Combined output formats are output formats that are created ad-hoc from other output formats by nesting them into each other, so that the escaping of both output formats are applied. <a href="#topic.combinedOutputFormats">They are discussed here...</a></p>
<h2 id="dgui_misc_whitespace">White-space handling</h2>
white-space removal
<p>The control of the <a href="#gloss.whiteSpace">white-space</a> in a template is a problem that to some extent haunts every template engine in the business.</p>
<p>Let see this template. I have marked the components of template with colors: text, interpolation, FTL tag. With the [BR]-s I visualize the <a href="#gloss.lineBreak">line breaks</a>.</p>
<pre><code>&lt;p&gt;List of users:[BR]
&lt;#assign users = [{&quot;name&quot;:&quot;Joe&quot;,        &quot;hidden&quot;:false},[BR]
                  {&quot;name&quot;:&quot;James Bond&quot;, &quot;hidden&quot;:true},[BR]
                  {&quot;name&quot;:&quot;Julia&quot;,      &quot;hidden&quot;:false}]&gt;[BR]
&lt;ul&gt;[BR]
&lt;#list users as user&gt;[BR]
  &lt;#if !user.hidden&gt;[BR]
  &lt;li&gt;${user.name}[BR]
  &lt;/#if&gt;[BR]
&lt;/#list&gt;[BR]
&lt;/ul&gt;[BR]
&lt;p&gt;That&#39;s all.</code></pre>
<p>If FreeMarker were to output all text as is, the output would be:</p>
<pre><code>&lt;p&gt;List of users:[BR]
[BR]
&lt;ul&gt;[BR]
[BR]
  [BR]
  &lt;li&gt;Joe[BR]
  [BR]
[BR]
  [BR]
[BR]
  [BR]
  &lt;li&gt;Julia[BR]
  [BR]
[BR]
&lt;/ul&gt;[BR]
&lt;p&gt;That&#39;s all.</code></pre>
<p>You have a lot of unwanted spaces and line breaks here. Fortunately neither HTML nor XML is typically white-space sensitive, but this amount of superfluous white-space can be annoying, and needlessly increases the size of produced HTML. Of course, it is even bigger problem when outputting white-space-sensitive formats.</p>
<p>FreeMarker provides the following tools to cope with this problem:</p>
<ul>
<li><p>Tools to ignore certain white-space of the template files (parse time white-space removal):</p>
<ul>
<li><p>White-space stripping: This feature automatically ignores typical superfluous white-space around FTL tags. It can be enabled or disabled on per template manner.</p></li>
<li><p>Trimmer directives: <code>t</code>, <code>rt</code>, <code>lt</code>. With these directives you can explicitly tell FreeMarker to ignore certain white-space. Read <a href="#ref.directive.t">the reference</a> for more information.</p></li>
<li><p><a href="#ref.directive.ftl"><code>ftl</code></a> parameter <code>strip_text</code>: This removes all top-level text from the template. It is useful for templates that contain macro definitions only (and some other non-outputting directives), because it removes the line-breaks that you use between the macro definitions and between the other top-level directives to improve the readability of the template.</p></li>
</ul></li>
<li><p>Tools that remove white-space from the output (on-the-fly white-space removal):</p>
<ul>
<li><p><code>compress</code> directive.</p></li>
</ul></li>
</ul>
<h3 id="dgui_misc_whitespace_stripping">White-space stripping</h3>
white-space removal
stripping
<p>If this feature is enabled for a template, then it automatically ignores (i.e. does not print to the output) two kind of typical superfluous white-space:</p>
<ul>
<li><p>Indentation white-space, and trailing white-space at the end of the line (includes the line break) will be ignored in lines that contains only FTL tags (e.g. <code>&lt;@myMacro/&gt;</code>, <code>&lt;#if
              ...&gt;</code>) and/or FTL comments (e.g. <code>&lt;#-- blah --&gt;</code>), apart from the the ignored white-space itself. For example, if a line contains only an <code>&lt;#if
              ...&gt;</code>, then the indentation before the tag and the line break after the tag will be ignored. However, if the line contains <code>&lt;#if
              ...&gt;x</code>, then the white-space in that line will not be ignored, because of the <code>x</code>, as that is not FTL tag. Note that according these rules, a line that contains <code>&lt;#if
              ...&gt;&lt;#list
              ...&gt;</code> is subject to white-space ignoring, while a line that contains <code>&lt;#if ...&gt; &lt;#list
              ...&gt;</code> is not, because the white-space between the two FTL tags is embedded white-space, not indentation or trailing white-space.</p></li>
<li><p>White-space sandwiched between the following directives is ignored: <code>macro</code>, <code>function</code>, <code>assign</code>, <code>global</code>, <code>local</code>, <code>ftl</code>, <code>import</code>, but only if there is <em>only</em> white-space and/or FTL comments between the directives. In practice it means that you can put empty lines between macro definitions and assignments as spacing for better readability, without printing needless empty lines (line breaks) to the output.</p></li>
</ul>
<p>The output of the last example with white-space stripping enabled will be:</p>
<pre><code>&lt;p&gt;List of users:[BR]
&lt;ul&gt;[BR]
  &lt;li&gt;Joe[BR]
  &lt;li&gt;Julia[BR]
&lt;/ul&gt;[BR]
&lt;p&gt;That&#39;s all.</code></pre>
<p>This is because after stripping the template becomes the following; the ignored text is not colored:</p>
<pre><code>&lt;p&gt;List of users:[BR]
&lt;#assign users = [{&quot;name&quot;:&quot;Joe&quot;,        &quot;hidden&quot;:false},[BR]
                  {&quot;name&quot;:&quot;James Bond&quot;, &quot;hidden&quot;:true},[BR]
                  {&quot;name&quot;:&quot;Julia&quot;,      &quot;hidden&quot;:false}]&gt;[BR]
&lt;ul&gt;[BR]
&lt;#list users as user&gt;[BR]
  &lt;#if !user.hidden&gt;[BR]
  &lt;li&gt;${user.name}[BR]
  &lt;/#if&gt;[BR]
&lt;/#list&gt;[BR]
&lt;/ul&gt;[BR]
&lt;p&gt;That&#39;s all.</code></pre>
<p>White-space stripping can be enabled/disabled in per template manner with the <a href="#ref.directive.ftl"><code>ftl</code> directive</a>. If you don't specify this with the <code>ftl</code> directive, then white-space stripping will be enabled or disabled depending on how the programmer has configured FreeMarker. The factory default is white-space stripping enabled, and the programmers probably left it so (recommended). Note that enabling white-space stripping does <em>not</em> degrade the performance of template execution; white-space stripping is done during template loading.</p>
<p>White-space stripping can be disabled for a single line with the <a href="#ref.directive.nt"><code>nt</code></a> directive (for No Trim).</p>
<h3>Using compress directive</h3>
white-space removal
compress
<p>Another solution is to use the <a href="#ref.directive.compress"><code>compress</code> directive</a>. As opposed to white-space stripping, this works directly on the generated output, not on the template. That is, it will investigate the printed output on the fly, and does not investigate the FTL program that creates the output. It aggressively removes indentations, empty lines and repeated spaces/tabs (for more information read the <a href="#ref.directive.compress">reference</a>). So the output of:</p>
<pre><code>&lt;#compress&gt;
&lt;#assign users = [{&quot;name&quot;:&quot;Joe&quot;,        &quot;hidden&quot;:false},
                  {&quot;name&quot;:&quot;James Bond&quot;, &quot;hidden&quot;:true},
                  {&quot;name&quot;:&quot;Julia&quot;,      &quot;hidden&quot;:false}]&gt;
List of users:
&lt;#list users as user&gt;
  &lt;#if !user.hidden&gt;
  - ${user.name}
  &lt;/#if&gt;
&lt;/#list&gt;
That&#39;s all.
&lt;/#compress&gt;</code></pre>
<p>will be:</p>
<pre><code>List of users:
- Joe
- Julia
That&#39;s all.</code></pre>
<p>Note that <code>compress</code> is totally independent of white-space stripping. So it is possible that the white-space of template is stripped, and later the produced output is <code>compress</code>-ed.</p>
<p>Also, by default a user-defined directve called <code>compress</code> is available in the data-model (due to backward compatibility). This is the same as the directive, except that you may optionally set the <code>single_line</code> parameter, which will remove all intervening line breaks. If you replace <code>&lt;#compress&gt;...&lt;/#compress&gt;</code> on the last example with <code>&lt;@compress
          single_line=true&gt;...&lt;/@compress&gt;</code>, then you get this output:</p>
<pre><code>List of users: - Joe - Julia That&#39;s all.</code></pre>
<h2 id="dgui_misc_alternativesyntax">Alternative (square bracket) syntax</h2>
alternative syntax
square bracket syntax
<blockquote>
<p><strong>Note</strong></p>
<p>This feature exists since FreeMarker 2.3.4.</p>
</blockquote>
<p>FreeMarker supports an alternative syntax, where <code>[</code> and <code>]</code> is used instead of <code>&lt;</code> and <code>&gt;</code> in FreeMarker directives and comments, for example:</p>
<ul>
<li><p>Calling predefined directive: <code>[#list animals as
            animal]...[/#list]</code></p></li>
<li><p>Calling user-defined directive: <code>[@myMacro
            /]</code></p></li>
<li><p>Comment: <code>[#-- the comment --]</code></p></li>
</ul>
<p>To use the alternative syntax instead of the default one, start the template with the <a href="#ref_directive_ftl"><code>ftl</code> directive</a> using the alternative syntax. If you don't know what is the <code>ftl</code> directive, just start the template with <code>[#ftl]</code>, and remember that it should be the very first thing in the file (except that <a href="#gloss.whiteSpace">white-space</a> can precede it). For example, this is how the last example of the <a href="#dgui_quickstart_template">Getting Started</a> looks with the alternative syntax (assuming it's a complete template, not just a fragment):</p>
<pre><code>[#ftl]
&lt;p&gt;We have these animals:
&lt;table border=1&gt;
  &lt;tr&gt;&lt;th&gt;Name&lt;th&gt;Price
  [#list animals as animal]
  &lt;tr&gt;
    &lt;td&gt;
      [#if animal.size == &quot;large&quot;]&lt;b&gt;[/#if]
      ${animal.name}
      [#if animal.size == &quot;large&quot;]&lt;/b&gt;[/#if]
    &lt;td&gt;${animal.price} Euros
  [/#list]
&lt;/table&gt;</code></pre>
<p>The alternative (square bracket) and the default (angle bracket) syntax are mutually exclusive within a template. That is, either the whole template uses alternative syntax, or the whole template uses the default syntax. If the template uses alternative syntax, things like <code>&lt;#if ...&gt;</code> are count as static text, not as FTL tags. Similarly, if the template uses the default syntax, things like <code>[#if
        ...]</code> count as static text, not as FTL tags.</p>
<p>If you start the file with <code>[#ftl
        ...]</code> (where the <code>...</code> stands for the optional parameters; of course <code>[#ftl]</code> works too) the file will surely use the alternative (square bracket) syntax. If you start the file with <code>&lt;#ftl
        ...&gt;</code> the file will surely use the normal (angle bracket) syntax. If there is no <code>ftl</code> directive in the file, then the programmer decides what the syntax will be by configuring FreeMarker (programmers see <code>Configuration.setTagSyntax(int)</code> in the API javadocs). Most probably the programmers use the factory default however. The factory default in 2.3.x is using the normal syntax. The factory default in 2.4.x will be auto-detection, which means that the first FreeMarker tag determines the syntax (it can be anything, not just <code>ftl</code>).</p>
<h1 id="pgui_quickstart">Getting Started</h1>
<p>If you are new to FreeMarker, you should read at least the <a href="#dgui_quickstart_basics">section_title</a> before this chapter.</p>
<h2 id="pgui_quickstart_createconfiguration">Create a configuration instance</h2>
configuration
<p>First you have to create a <code>freemarker.template.Configuration</code> instance and adjust its settings. A <code>Configuration</code> instance is the central place to store the application level settings of FreeMarker. Also, it deals with the creation and <em>caching</em> of pre-parsed templates (i.e., <code>Template</code> objects).</p>
<p>Normally you will <em>do this only once</em> at the beginning of the application (possibly servlet) life-cycle:</p>
<pre><code>// Create your Configuration instance, and specify if up to what FreeMarker
// version (here 2.3.27) do you want to apply the fixes that are not 100%
// backward-compatible. See the Configuration JavaDoc for details.
Configuration cfg = new Configuration(Configuration.VERSION_2_3_27);

// Specify the source where the template files come from. Here I set a
// plain directory for it, but non-file-system sources are possible too:
cfg.setDirectoryForTemplateLoading(new File(&quot;/where/you/store/templates&quot;));

// Set the preferred charset template files are stored in. UTF-8 is
// a good choice in most applications:
cfg.setDefaultEncoding(&quot;UTF-8&quot;);

// Sets how errors will appear.
// During web page *development* TemplateExceptionHandler.HTML_DEBUG_HANDLER is better.
cfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);

// Don&#39;t log exceptions inside FreeMarker that it will thrown at you anyway:
cfg.setLogTemplateExceptions(false);

// Wrap unchecked exceptions thrown during template processing into TemplateException-s.
cfg.setWrapUncheckedExceptions(true);</code></pre>
<p>From now you should use this <em>single</em> configuration instance (i.e., its a singleton). Note however that if a system has multiple independent components that use FreeMarker, then of course they will use their own private <code>Configuration</code> instances.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Do not needlessly re-create <code>Configuration</code> instances; it's expensive, among others because you lose the template cache. <code>Configuration</code> instances meant to be application-level singletons.</p>
</blockquote>
<p>In multi-threaded applications (like Web sites) the settings in the <code>Configuration</code> instance must not be modified anymore after this point. Thus it can be treated as “effectively immutable” object, so you can continue with <em>safe publishing</em> techniques (see JSR 133 and related literature) to make the instance available for other threads. Like, publish the instance through a final or volatile filed, or through a thread-safe IoC container (like the one provided by Spring). <code>Configuration</code> methods that don't deal with modifying settings are thread-safe.</p>
<h2 id="pgui_quickstart_createdatamodel">Create a data-model</h2>
data-model
assembling with Java
<p>In simple cases you can build data-models using <code>java.lang</code> and <code>java.util</code> classes and custom JavaBeans:</p>
<ul>
<li><p>Use <code>java.lang.String</code> for strings.</p></li>
<li><p>Use <code>java.lang.Number</code> subclasses for numbers.</p></li>
<li><p>Use <code>java.lang.Boolean</code> for boolean values.</p></li>
<li><p>Use <code>java.util.Date</code> and its subclasses for date/time values</p></li>
<li><p>Use <code>java.util.List</code> or Java arrays for sequences.</p></li>
<li><p>Use <code>java.util.Map</code> with <code>String</code> keys for hashes.</p></li>
<li><p>Use your custom bean class for hashes where the items correspond to the bean properties. For example the <code>price</code> property (<code>getPrice()</code>) of <code>product</code> can be get as <code>product.price</code>. (The actions of the beans can be exposed as well; see much later <a href="#pgui_misc_beanwrapper">here</a>)</p></li>
</ul>
<p>For example, let's build the data-model of the <a href="#example.first">first example of the Template Author's Guide</a>. For convenience, here it is again:</p>
<pre><code>(root)
  |
  +- user = &quot;Big Joe&quot;
  |
  +- latestProduct
      |
      +- url = &quot;products/greenmouse.html&quot;
      |
      +- name = &quot;green mouse&quot;</code></pre>
<p>This Java code fragment that builds this data-model:</p>
<pre><code>// Create the root hash. We use a Map here, but it could be a JavaBean too.
Map&lt;String, Object&gt; root = new HashMap&lt;&gt;();

// Put string &quot;user&quot; into the root
root.put(&quot;user&quot;, &quot;Big Joe&quot;);

// Create the &quot;latestProduct&quot; hash. We use a JavaBean here, but it could be a Map too.
Product latest = new Product();
latest.setUrl(&quot;products/greenmouse.html&quot;);
latest.setName(&quot;green mouse&quot;);
// and put it into the root
root.put(&quot;latestProduct&quot;, latest);</code></pre>
<p>As demonstrated above, for hashes (something that stores other named items) you can use either a <code>Map</code> or any kind of public class that has public <code>getXxx</code>/<code>isXxx</code> methods as prescribed by the JavaBeans specification. Like the above <code>Product</code> class could be something like:</p>
<pre><code>/**
 * Product bean; note that it must be a public class!
 */
public class Product {

    private String url;
    private String name;

    // As per the JavaBeans spec., this defines the &quot;url&quot; bean property
    // It must be public!
    public String getUrl() {
        return url;
    }

    public void setUrl(String url) {
        this.url = url;
    }

    // As per the JavaBean spec., this defines the &quot;name&quot; bean property
    // It must be public!
    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

}</code></pre>
<p>Regardless if <code>latestProduct</code> is a <code>Map</code> that contains the <code>&quot;name&quot;</code> and <code>&quot;url&quot;</code> keys, or it's a JavaBean as shown above, in the template you can use <code>${latestProduct.name}</code>. The root itself need not be a <code>Map</code> either; it could be an object with <code>getUser()</code> and <code>getLastestProduct()</code> methods too.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>The behavior described here only stands if the value of the <code>object_wrapper</code> configuration setting is something that's used in almost all real world setups anyway. Anything that the <code>ObjectWrapper</code> wraps to be a hash (something that implements the <code>TemplateHashModel</code> interface) can be used as the root, and can be traversed in templates with the dot and <code>[]</code> operators. Something that it doesn't wrap to be a hash can't be used as the root or be traversed like that.</p>
</blockquote>
<h2 id="pgui_quickstart_gettemplate">Get the template</h2>
template
Java side
<p>Templates are represented by <code>freemarker.template.Template</code> instances. Typically you obtain a <code>Template</code> instance from the <code>Configuration</code> instance, using its. <code>getTemplate</code> method. If you store <a href="#example.first">the example template</a> in the <code>test.ftlh</code> file of the <a href="#pgui_quickstart_createconfiguration">earlier</a> set directory, then you can do this:</p>
<pre><code>Template temp = cfg.getTemplate(&quot;test.ftlh&quot;);</code></pre>
<p>This gives you a <code>Template</code> instance that was created by reading <code>/where/you/store/templates/test.ftlh</code> and parsing it. The <code>Template</code> instance stores the template in parsed form, and not as text. If the template is missing or syntactically incorrect, <code>getTemplate</code> will throw exception instead.</p>
<p><code>Configuration</code> caches <code>Template</code> instances, so when you call <code>cfg.getTemplate(&quot;test.ftlh&quot;)</code> next time, it probably won't read and parse the template file again, just returns the same <code>Template</code> instance as for the first time.</p>
<h2 id="pgui_quickstart_merge">Merging the template with the data-model</h2>
output
generate with Java
merging
<p>As you might already know, data-model + template = output. We already have a data-model (<code>root</code>) and a template (<code>temp</code>), so to get the output we have to merge them. This is done by the <code>process</code> method of the template. It takes the data-model root and a <code>Writer</code> as parameters. It writes the produced output to the <code>Writer</code>. For the sake of simplicity here I write to the standard output:</p>
<pre><code>Writer out = new OutputStreamWriter(System.out);
temp.process(root, out);</code></pre>
<p>This will print to your terminal the output you have seen in the <a href="#example.first">first example</a> of the Template Author's Guide.</p>
<p>Java I/O related notes: Depending on what <code>out</code> is, you may need to ensure that <code>out.close()</code> is called. This is typically needed when <code>out</code> writes into a file that was opened to store the output of the template. In other times, like in typical Web applications, you must <em>not</em> close <code>out</code>. FreeMarker calls <code>out.flush()</code> after a successful template execution (but tis can be disabled in <code>Configuration</code>), so you don't need to worry about that.</p>
<p>Note that once you have obtained a <code>Template</code> instance, you can merge it with different data-models for unlimited times (<code>Template</code> instances are stateless). Also, the <code>test.ftlh</code> file is accessed only while the <code>Template</code> instance is created, not when you call the process method.</p>
<h2 id="pgui_quickstart_all">Putting all together</h2>
<p>This is a working source file assembled from the previous fragments. Don't forget to put <code>freemarker.jar</code> into the <code>CLASSPATH</code>.</p>
<pre><code>import freemarker.template.*;
import java.util.*;
import java.io.*;

public class Test {

    public static void main(String[] args) throws Exception {

        /* ------------------------------------------------------------------------ */
        /* You should do this ONLY ONCE in the whole application life-cycle:        */

        /* Create and adjust the configuration singleton */
        Configuration cfg = new Configuration(Configuration.VERSION_2_3_27);
        cfg.setDirectoryForTemplateLoading(new File(&quot;/where/you/store/templates&quot;));
        cfg.setDefaultEncoding(&quot;UTF-8&quot;);
        cfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
        cfg.setLogTemplateExceptions(false);
        cfg.setWrapUncheckedExceptions(true);

        /* ------------------------------------------------------------------------ */
        /* You usually do these for MULTIPLE TIMES in the application life-cycle:   */

        /* Create a data-model */
        Map root = new HashMap();
        root.put(&quot;user&quot;, &quot;Big Joe&quot;);
        Product latest = new Product();
        latest.setUrl(&quot;products/greenmouse.html&quot;);
        latest.setName(&quot;green mouse&quot;);
        root.put(&quot;latestProduct&quot;, latest);

        /* Get the template (uses cache internally) */
        Template temp = cfg.getTemplate(&quot;test.ftlh&quot;);

        /* Merge data-model with template */
        Writer out = new OutputStreamWriter(System.out);
        temp.process(root, out);
        // Note: Depending on what `out` is, you may need to call `out.close()`.
        // This is usually the case for file output, but not for servlet output.
    }
}</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>I have suppressed the exceptions for the sake of simplicity. Don't do it in real products.</p>
</blockquote>
<p>For the sake completeness, here's the the Product class used in the data model:</p>
<pre><code>/**
 * Product bean; note that it must be a public class!
 */
public class Product {

    private String url;
    private String name;

    // As per the JavaBeans spec., this defines the &quot;url&quot; bean property
    // It must be public!
    public String getUrl() {
        return url;
    }

    public void setUrl(String url) {
        this.url = url;
    }

    // As per the JavaBean spec., this defines the &quot;name&quot; bean property
    // It must be public!
    public String getName() {
        return name;
    }

    public void setName(String name) {
        this.name = name;
    }

}</code></pre>
<p>and the template:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Welcome!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Welcome ${user}!&lt;/h1&gt;
  &lt;p&gt;Our latest product:
  &lt;a href=&quot;${latestProduct.url}&quot;&gt;${latestProduct.name}&lt;/a&gt;!
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<h1 id="pgui_datamodel">The Data Model</h1>
<p>This is just an introductory explanation. See the FreeMarker Java API documentation for more detailed information.</p>
<h2 id="pgui_datamodel_basics">Basics</h2>
object wrapper
wrapper
data-model
assembling with Java, without object wrapper
<p>You have seen how to build a data-model in the <a href="#pgui_quickstart">Getting Started</a> using the standard Java classes (<code>Map</code>, <code>String</code>, etc.). Internally, the variables available in the template are Java objects that implement the <code>freemarker.template.TemplateModel</code> interface. But you could use standard Java collections as variables in your data-model, because these were replaced with the appropriate <code>TemplateModel</code> instances behind the scenes. This facility is called <em>object wrapping</em>. The object wrapping facility can convert <em>any</em> kind of object transparently to the instances of classes that implement <code>TemplateModel</code> interface. This makes it possible, for example, to access <code>java.sql.ResultSet</code> as sequence variable in templates, or to access <code>javax.servlet.ServletRequest</code> objects as a hash variable that contains the request attributes, or even to traverse XML documents as FTL variables (<a href="#xgui">see here</a>). To wrap (convert) these objects, however, you need to plug the proper <code>ObjectWrapper</code> implementation (possibly your custom implementation); this will be discussed <a href="#pgui_datamodel_objectWrapper">later</a>. The point for now is that any object that you want to access from the templates, sooner or later must be converted to an object that implements <code>TemplateModel</code> interface. So first you should familiarize yourself with writing of <code>TemplateModel</code> implementations.</p>
<p>There is roughly one <code>freemarker.template.TemplateModel</code> descendant interface corresponding to each basic type of variable (<code>TemplateHashModel</code> for hashes, <code>TemplateSequenceModel</code> sequences, <code>TemplateNumberModel</code> for numbers, etc.). For example, if you want to expose a <code>java.sql.ResultSet</code> as a sequence for the templates, then you have to write a <code>TemplateSequenceModel</code> implementation that can read <code>java.sql.ResultSet</code>-s. We used to say on this, that you <em>wrap</em> the <code>java.sql.ResultSet</code> with your <code>TemplateModel</code> implementation, as basically you just encapsulate the <code>java.sql.ResultSet</code> to provide access to it with the common <code>TemplateSequenceModel</code> interface. Note that a class can implement multiple <code>TemplateModel</code> interfaces; this is why FTL variables can have multiple types (see: <a href="#dgui_datamodel_basics">section_title</a>)</p>
<p>Note that a trivial implementation of these interfaces is provided with the <code>freemarker.template</code> package. For example, to convert a <code>String</code> to FTL string variable, you can use <code>SimpleScalar</code>, to convert a <code>java.util.Map</code> to FTL hash variable, you can use <code>SimpleHash</code>, etc.</p>
<p>An easy way to try your own <code>TemplateModel</code> implementation, is to create an instance of that, and drop it directly into the data-model (as <code>put</code> it into the root hash). The object wrapper will expose it untouched for the template, as it already implements <code>TemplateModel</code>, so no conversion (wrapping) needed. (This trick is also useful in cases when you do not want the object wrapper to try to wrap (convert) a certain object.)</p>
<h2 id="pgui_datamodel_scalar">Scalars</h2>
scalar
Java side
string
Java side
number
Java side
boolean
Java side
date
Java side
time
Java side
<p>There are 4 scalar types:</p>
<ul>
<li><p>Boolean</p></li>
<li><p>Number</p></li>
<li><p>String</p></li>
<li><p>Date-like (subtypes: date (no time part), time or date-time)</p></li>
</ul>
<p>For each scalar type is a <code>TemplateTypeModel</code> interface, where <code>Type</code> is the name of the type. These interfaces define only one method: <code>type
        getAsType();</code>. This returns the value of the variable with the Java type (<code>boolean</code>, <code>Number</code>, <code>String</code> and <code>Date</code> respectively).</p>
<blockquote>
<p><strong>Note</strong></p>
<p>For historical reasons the interface for string scalars is called <code>TemplateScalarModel</code>, not <code>TemplateStringModel</code>. (It's because in early FreeMarker strings were the only kind of scalars.)</p>
</blockquote>
<p>A trivial implementation of these interfaces are available in <code>freemarker.template</code> package with <code>SimpleType</code> class name. However, there is no <code>SimpleBooleanModel</code>; to represent the boolean values you can use the <code>TemplateBooleanModel.TRUE</code> and <code>TemplateBooleanModel.FALSE</code> singletons.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>For historical reasons the class for string scalars is called <code>SimpleScalar</code>, not <code>SimpleString</code>.</p>
</blockquote>
<p>Scalars are immutable within FTL. When you set the value of a variable in a template, then you replace the <code>TemplateTypeModel</code> instance with another instance, and don't change the value stored in the original instance.</p>
<h3>Difficulties with the “date-like” types</h3>
date
Java API related difficulties
time
Java API related difficulties
<p>There is a complication around date-like types, because Java API usually does not differentiate <code>java.util.Date</code>-s that store only the date part (April 4, 2003), only the time part (10:19:18 PM), or both (April 4, 2003 10:19:18 PM). To display the value as text correctly (or to do certain other operations), FreeMarker must know what parts of the <code>java.util.Date</code> stores meaningful information, and what parts are unused (usually 0-ed out). Unfortunately, this information is usually only available when the value comes from a database, because most databases have separate date, time and date-time (aka. timestap) types, and <code>java.sql</code> has 3 corresponding <code>java.util.Date</code> subclasses for them.</p>
<p><code>TemplateDateModel</code> interface has two methods: <code>java.util.Date getAsDate()</code> and <code>int getDateType()</code>. A typical implementation of this interface, stores a <code>java.util.Date</code> object, plus an integer that tells the subtype. The value of this integer must be a constant from the <code>TemplateDateModel</code> interface: <code>DATE</code>, <code>TIME</code>, <code>DATETIME</code> and <code>UNKNOWN</code>.</p>
<p>About <code>UNKNOWN</code>: <code>java.lang</code> and <code>java.util</code> classes are usually converted automatically into <code>TemplateModel</code> implementations be the <code>ObjectWrapper</code> (see object wrapping earlier). If the object wrapper has to wrap a <code>java.util.Date</code>, that is not an instance of a <code>java.sql</code> date class, it can't decide what the subtype is, so it uses <code>UNKNOWN</code>. Later, if the template has to use this variable, and the subtype is needed for the operation, it will stop with error. To prevent this, for the problematic variables the template author must specify the subtype explicitly using the <a href="#ref_builtin_date_datetype"><code>date</code>, <code>time</code> or <code>datetime</code> built-ins</a> (like <code>lastUpdated?datetime</code>). Note that if you use <code>string</code> built-in with format parameter, as <code>foo?string[&quot;MM/dd/yyyy&quot;]</code>, then FreeMarker doesn't need to know the subtype.</p>
<h2 id="pgui_datamodel_parent">Containers</h2>
containers
Java side
<p>These are hashes, sequences, and collections.</p>
<h3>Hashes</h3>
hash
Java side
<p>Hashes are java objects that implement <code>TemplateHashModel</code> interface. <code>TemplateHashModel</code> contains two methods: <code>TemplateModel get(String key)</code>, which returns the subvariable of the given name, and <code>boolean
          isEmpty()</code>, which indicates if the hash has zero subvariable or not. The <code>get</code> method returns null if no subvariable with the given name exists.</p>
<p>The <code>TemplateHashModelEx</code> interface extends <code>TemplateHashModel</code>. It adds methods by which <a href="#ref_builtin_values">values</a> and <a href="#ref_builtin_keys">keys</a> built-ins can enumerate the sub variables of the hash.</p>
<p>The commonly used implementation is <code>SimpleHash</code>, which implements <code>TemplateHashModelEx</code>. Internally it uses a <code>java.util.Hash</code> to store the sub variables. <code>SimpleHash</code> has methods by which you can add and remove subvariable. These methods should be used to initialize the variable directly after its creation.</p>
<p>Containers are immutable within FTL. That is, you can't add, replace or remove the sub variables they contain.</p>
<h3>Sequences</h3>
sequence
Java side
<p>Sequences are java objects that implement <code>TemplateSequenceModel</code>. It contains two methods: <code>TemplateModel get(int index)</code> and <code>int
          size()</code>.</p>
<p>The commonly used implementation is <code>SimpleSequence</code>. It uses internally a <code>java.util.List</code> to store its sub variables. <code>SimpleSequence</code> has methods by which you can add sub variables. These methods should be used to populate the sequence directly after its creation.</p>
<h3>Collections</h3>
collection
Java side
<p>Collections are java objects that implement the <code>TemplateCollectionModel</code> interface. That interface has one method: <code>TemplateModelIterator iterator()</code>. The <code>TemplateModelIterator</code> interface is similar to <code>java.util.Iterator</code>, but it returns <code>TemplateModels</code> instead of <code>Object</code>-s, and it can throw <code>TemplateModelException</code>s.</p>
<p>The commonly used implementation is <code>SimpleCollection</code>.</p>
<h2 id="pgui_datamodel_method">Methods</h2>
method
Java side
<p>Method variables exposed to a template implement the <code>TemplateMethodModel</code> interface. This contains one method: <code>TemplateModel exec(java.util.List
        arguments)</code>. When you call a method with a <a href="#dgui_template_exp_methodcall">method call expression</a>, then the <code>exec</code> method will be called. The arguments parameter will contain the values of the FTL method call arguments. The return value of <code>exec</code> gives the value of the FTL method call expression.</p>
<p>The <code>TemplateMethodModelEx</code> interface extends <code>TemplateMethodModel</code>. It does not add any new methods. The fact that the object implements this <em>marker</em> interface indicates to the FTL engine that the arguments should be put to the <code>java.util.List</code> directly as <code>TemplateModel</code>-s. Otherwise they will be put to the list as <code>String</code>-s.</p>
<p>For obvious reasons there is no default implementation for these interfaces.</p>
<p>Example: This is a method, which returns the index within the second string of the first occurrence of the first string, or -1 if the second string doesn't contains the first.</p>
<pre><code>public class IndexOfMethod implements TemplateMethodModel {

    public TemplateModel exec(List args) throws TemplateModelException {
        if (args.size() != 2) {
            throw new TemplateModelException(&quot;Wrong arguments&quot;);
        }
        return new SimpleNumber(
            ((String) args.get(1)).indexOf((String) args.get(0)));
    }
}</code></pre>
<p>If you put an instance of this, say, into the root:</p>
<pre><code>root.put(&quot;indexOf&quot;, new IndexOfMethod());</code></pre>
<p>then you can call it in the template:</p>
<pre><code>&lt;#assign x = &quot;something&quot;&gt;
${indexOf(&quot;met&quot;, x)}
${indexOf(&quot;foo&quot;, x)}</code></pre>
<p>and then the output will be:</p>
<pre><code>2
-1</code></pre>
<p>If you need to access the runtime FTL environment (read/write variables, get the current locale, etc.), you can get it with <code>Environment.getCurrentEnvironment()</code>.</p>
<h2 id="pgui_datamodel_directive">Directives</h2>
directives
Java side
<p>Java programmers can implement user-defined directives in Java using the <code>TemplateDirectiveModel</code> interface. See in the API documentation.</p>
<blockquote>
<p><strong>Note</strong></p>
<p><code>TemplateDirectiveModel</code> was introduced in FreeMarker 2.3.11, replacing the soon to be depreciated <code>TemplateTransformModel</code>.</p>
</blockquote>
<h3>Example 1</h3>
<p>We will implement a directive which converts all output between its start-tag and end-tag to upper case. Like, this template:</p>
<pre><code>foo
&lt;@upper&gt;
  bar
  &lt;#-- All kind of FTL is allowed here --&gt;
  &lt;#list [&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;] as color&gt;
    ${color}
  &lt;/#list&gt;
  baaz
&lt;/@upper&gt;
wombat</code></pre>
<p>will output this:</p>
<pre><code>foo
  BAR
    RED
    GREEN
    BLUE
  BAAZ
wombat</code></pre>
<p>This is the source code of the directive class:</p>
<pre><code>package com.example;
import java.io.IOException;
import java.io.Writer;
import java.util.Map;

import freemarker.core.Environment;
import freemarker.template.TemplateDirectiveBody;
import freemarker.template.TemplateDirectiveModel;
import freemarker.template.TemplateException;
import freemarker.template.TemplateModel;
import freemarker.template.TemplateModelException;

/**
 *  FreeMarker user-defined directive that progressively transforms
 *  the output of its nested content to upper-case.
 *
 *
 *  &lt;p&gt;&lt;b&gt;Directive info&lt;/b&gt;&lt;/p&gt;
 *
 *  &lt;p&gt;Directive parameters: None
 *  &lt;p&gt;Loop variables: None
 *  &lt;p&gt;Directive nested content: Yes
 */
public class UpperDirective implements TemplateDirectiveModel {

    public void execute(Environment env,
            Map params, TemplateModel[] loopVars,
            TemplateDirectiveBody body)
            throws TemplateException, IOException {
        // Check if no parameters were given:
        if (!params.isEmpty()) {
            throw new TemplateModelException(
                    &quot;This directive doesn&#39;t allow parameters.&quot;);
        }
        if (loopVars.length != 0) {
                throw new TemplateModelException(
                    &quot;This directive doesn&#39;t allow loop variables.&quot;);
        }

        // If there is non-empty nested content:
        if (body != null) {
            // Executes the nested body. Same as &lt;#nested&gt; in FTL, except
            // that we use our own writer instead of the current output writer.
            body.render(new UpperCaseFilterWriter(env.getOut()));
        } else {
            throw new RuntimeException(&quot;missing body&quot;);
        }
    }

    /**
     * A {@link Writer} that transforms the character stream to upper case
     * and forwards it to another {@link Writer}.
     */
    private static class UpperCaseFilterWriter extends Writer {

        private final Writer out;

        UpperCaseFilterWriter (Writer out) {
            this.out = out;
        }

        public void write(char[] cbuf, int off, int len)
                throws IOException {
            char[] transformedCbuf = new char[len];
            for (int i = 0; i &lt; len; i++) {
                transformedCbuf[i] = Character.toUpperCase(cbuf[i + off]);
            }
            out.write(transformedCbuf);
        }

        public void flush() throws IOException {
            out.flush();
        }

        public void close() throws IOException {
            out.close();
        }
    }

}</code></pre>
<p>Now we still need to create an instance of this class, and make this directive available to the template with the name &quot;upper&quot; (or with whatever name we want) somehow. A possible solution is to put the directive in the data-model:</p>
<pre><code>root.put(&quot;upper&quot;, new com.example.UpperDirective());</code></pre>
<p>But typically it is better practice to put commonly used directives into the <code>Configuration</code> as <a href="#pgui_config_sharedvariables">shared variables</a>.</p>
<p>It is also possible to put the directive into an FTL library (collection of macros and like in a template, that you <code>include</code> or <code>import</code> in other templates) using the <a href="#ref_builtin_new"><code>new</code> built-in</a>:</p>
<pre><code>&lt;#-- Maybe you have directives that you have implemented in FTL --&gt;
&lt;#macro something&gt;
  ...
&lt;/#macro&gt;

&lt;#-- Now you can&#39;t use &lt;#macro upper&gt;, but instead you can: --&gt;
&lt;#assign upper = &quot;com.example.UpperDirective&quot;?new()&gt;</code></pre>
<h3>Example 2</h3>
<p>We will create a directive that executes its nested content again and again for the specified number of times (similarly to <code>list</code> directive), optionally separating the the output of the repetations with a <code>&lt;hr&gt;</code>-s. Let's call this directive &quot;repeat&quot;. Example template:</p>
<pre><code>&lt;#assign x = 1&gt;

&lt;@repeat count=4&gt;
  Test ${x}
  &lt;#assign x++&gt;
&lt;/@repeat&gt;

&lt;@repeat count=3 hr=true&gt;
  Test
&lt;/@repeat&gt;

&lt;@repeat count=3; cnt&gt;
  ${cnt}. Test
&lt;/@repeat&gt;</code></pre>
<p>Output:</p>
<pre><code>  Test 1
  Test 2
  Test 3
  Test 4

  Test
&lt;hr&gt;  Test
&lt;hr&gt;  Test

  1. Test
  2. Test
  3. Test
 </code></pre>
<p>The class:</p>
<pre><code>package com.example;
import java.io.IOException;
import java.io.Writer;
import java.util.Iterator;
import java.util.Map;

import freemarker.core.Environment;
import freemarker.template.SimpleNumber;
import freemarker.template.TemplateBooleanModel;
import freemarker.template.TemplateDirectiveBody;
import freemarker.template.TemplateDirectiveModel;
import freemarker.template.TemplateException;
import freemarker.template.TemplateModel;
import freemarker.template.TemplateModelException;
import freemarker.template.TemplateNumberModel;

/**
 * FreeMarker user-defined directive for repeating a section of a template,
 * optionally with separating the output of the repetations with
 * &lt;tt&gt;&amp;lt;hr&gt;&lt;/tt&gt;-s.
 *
 *
 * &lt;p&gt;&lt;b&gt;Directive info&lt;/b&gt;&lt;/p&gt;
 *
 * &lt;p&gt;Parameters:
 * &lt;ul&gt;
 *   &lt;li&gt;&lt;code&gt;count&lt;/code&gt;: The number of repetations. Required!
 *       Must be a non-negative number. If it is not a whole number then it will
 *       be rounded &lt;em&gt;down&lt;/em&gt;.
 *   &lt;li&gt;&lt;code&gt;hr&lt;/code&gt;: Tells if a HTML &quot;hr&quot; element could be printed between
 *       repetations. Boolean. Optional, defaults to &lt;code&gt;false&lt;/code&gt;.
 * &lt;/ul&gt;
 *
 * &lt;p&gt;Loop variables: One, optional. It gives the number of the current
 *    repetation, starting from 1.
 *
 * &lt;p&gt;Nested content: Yes
 */
public class RepeatDirective implements TemplateDirectiveModel {

    private static final String PARAM_NAME_COUNT = &quot;count&quot;;
    private static final String PARAM_NAME_HR = &quot;hr&quot;;

    public void execute(Environment env,
            Map params, TemplateModel[] loopVars,
            TemplateDirectiveBody body)
            throws TemplateException, IOException {

        // ---------------------------------------------------------------------
        // Processing the parameters:

        int countParam = 0;
        boolean countParamSet = false;
        boolean hrParam = false;

        Iterator paramIter = params.entrySet().iterator();
        while (paramIter.hasNext()) {
            Map.Entry ent = (Map.Entry) paramIter.next();

            String paramName = (String) ent.getKey();
            TemplateModel paramValue = (TemplateModel) ent.getValue();

            if (paramName.equals(PARAM_NAME_COUNT)) {
                if (!(paramValue instanceof TemplateNumberModel)) {
                    throw new TemplateModelException(
                            &quot;The \&quot;&quot; + PARAM_NAME_HR + &quot;\&quot; parameter &quot;
                            + &quot;must be a number.&quot;);
                }
                countParam = ((TemplateNumberModel) paramValue)
                        .getAsNumber().intValue();
                countParamSet = true;
                if (countParam &lt; 0) {
                    throw new TemplateModelException(
                            &quot;The \&quot;&quot; + PARAM_NAME_HR + &quot;\&quot; parameter &quot;
                            + &quot;can&#39;t be negative.&quot;);
                }
            } else if (paramName.equals(PARAM_NAME_HR)) {
                if (!(paramValue instanceof TemplateBooleanModel)) {
                    throw new TemplateModelException(
                            &quot;The \&quot;&quot; + PARAM_NAME_HR + &quot;\&quot; parameter &quot;
                            + &quot;must be a boolean.&quot;);
                }
                hrParam = ((TemplateBooleanModel) paramValue)
                        .getAsBoolean();
            } else {
                throw new TemplateModelException(
                        &quot;Unsupported parameter: &quot; + paramName);
            }
        }
        if (!countParamSet) {
                throw new TemplateModelException(
                        &quot;The required \&quot;&quot; + PARAM_NAME_COUNT + &quot;\&quot; paramter&quot;
                        + &quot;is missing.&quot;);
        }

        if (loopVars.length &gt; 1) {
                throw new TemplateModelException(
                        &quot;At most one loop variable is allowed.&quot;);
        }

        // Yeah, it was long and boring...

        // ---------------------------------------------------------------------
        // Do the actual directive execution:

        Writer out = env.getOut();
        if (body != null) {
            for (int i = 0; i &lt; countParam; i++) {
                // Prints a &lt;hr&gt; between all repetations if the &quot;hr&quot; parameter
                // was true:
                if (hrParam &amp;&amp; i != 0) {
                    out.write(&quot;&lt;hr&gt;&quot;);
                }

                // Set the loop variable, if there is one:
                if (loopVars.length &gt; 0) {
                    loopVars[0] = new SimpleNumber(i + 1);
                }

                // Executes the nested body (same as &lt;#nested&gt; in FTL). In this
                // case we don&#39;t provide a special writer as the parameter:
                body.render(env.getOut());
            }
        }
    }

}</code></pre>
<h3>Notices</h3>
<p>It's important that a <code>TemplateDirectiveModel</code> object usually should not be stateful. The typical mistake is the storing of the state of the directive call execution in the fields of the object. Think of nested calls of the same directive, or directive objects used as shared variables accessed by multiple threads concurrently.</p>
<p>Unfortunately, <code>TemplateDirectiveModel</code>-s don't support passing parameters by position (rather than by name). This is fixed starting from FreeMarker 2.4.</p>
<h2 id="pgui_datamodel_node">Node variables</h2>
node
Java side
tree nodes
trees
<p>A node variable embodies a node in a tree structure. Node variables were introduced to help <a href="#xgui">the handling of XML documents in the data-model</a>, but they can be used for the modeling of other tree structures as well. For more information about nodes from the point of view of the template language <a href="#dgui_datamodel_node">read this earlier section</a>.</p>
<p>A node variable has the following properties, provided by the methods of <code>TemplateNodeModel</code> interface:</p>
<ul>
<li><p>Basic properties:</p>
<ul>
<li><p><code>TemplateSequenceModel
                getChildNodes()</code>: A node has sequence of children (except if the node is a leaf node, in which case the method return an empty sequence or null). The child nodes should be node variables as well.</p></li>
<li><p><code>TemplateNodeModel getParentNode()</code>: A node has exactly 1 parent node, except if the node is root node of the tree, in which case the method returns <code>null</code>.</p></li>
</ul></li>
<li><p>Optional properties. If a property does not make sense in the concrete use case, the corresponding method should return <code>null</code>:</p>
<ul>
<li><p><code>String getNodeName()</code>: The node name is the name of the macro, that handles the node when you use <a href="#ref.directive.recurse"><code>recurse</code></a> and <a href="#ref.directive.visit"><code>visit</code></a> directives. Thus, if you want to use these directives with the node, the node name is <em>required</em>.</p></li>
<li><p><code>String getNodeType()</code>: In the case of XML: <code>&quot;element&quot;</code>, <code>&quot;text&quot;</code>, <code>&quot;comment&quot;</code>, ...etc. This information, if available, is used by the <code>recurse</code> and <code>visit</code> directives to find the default handler macro for a node. Also it can be useful for other application specific purposes.</p></li>
<li><p><code>String getNamespaceURI()</code>: The node namespace (has nothing to do with FTL namespaces used for libraries) this node belongs to. For example, in the case of XML, this is the URI of the XML namespace the element or attribute belongs to. This information, if available, is used by the <code>recurse</code> and <code>visit</code> directives to find the FTL namespaces that store the handler macros.</p></li>
</ul></li>
</ul>
<p>On the FTL side, the direct utilization of node properties is done with <a href="#ref_builtins_node">node built-ins</a>, and with the <code>visit</code> and <code>recurse</code> macros.</p>
<p>In most use cases, variables that implement <code>TemplateNodeModel</code>, implement other interfaces as well, since node variable properties just provide the basic infrastructure for navigating between nodes. For a concrete example, see <a href="#xgui">how FreeMarker deals with XML</a>.</p>
<h2 id="pgui_datamodel_objectWrapper">Object wrappers</h2>
object wrapper
wrapper
<p>The object wrapper is an object that implements the <code>freemarker.template.ObjectWrapper</code> interface. It's purpose is to implement a mapping between Java objects (like <code>String</code>-s, <code>Map</code>-s, <code>List</code>-s, instances of your application specific classes, etc.) and FTL's type system. With other words, it specifies how the templates will see the Java objects of the data-model (including the return value of Java methods called from the template). The object wrapper is plugged into the <code>Configuration</code> as its <code>object_wrapper</code> setting (or with <code>Configuration.setObjectWrapper</code>).</p>
<p>FTL's type system is technically represented by the <code>TemplateModel</code> sub-interfaces that were introduced earlier (<code>TemplateScalarModel</code>, <code>TemplateHashMode</code>, <code>TemplateSequenceModel</code>, etc). To map a Java object to FTL's type system, object wrapper's <code>TemplateModel
        wrap(java.lang.Object obj)</code> method will be called.</p>
<p>Sometimes FreeMarker needs to reverse this mapping, in which case the <code>ObjectWrapper</code>'s <code>Object
        unwrap(TemplateModel)</code> method is called (or some other variation of that, but see the API documentation for such details). This last operation is in <code>ObjectWrapperAndUnwrapper</code>, the subinterface of <code>ObjectWrapper</code>. Most real world object wrappers will implement <code>ObjectWrapperAndUnwrapper</code>.</p>
<p>Here's how wrapping Java objects that contain other objects (like a <code>Map</code>, a <code>List</code>, an array, or an object with some JavaBean properties) usually work. Let's say, an object wrapper wraps an <code>Object[]</code> array into some implementation of the <code>TemplateSquenceModel</code> interface. When FreeMarker needs an item from that FTL sequence, it will call <code>TemplateSquenceModel.get(int index)</code>. The return type of this method is <code>TemplateModel</code>, that is, the <code>TemplateSquenceModel</code> implementation not only have to get the <code>Object</code> from the given index of the array, it's also responsible for wrapping that value before returning it. To solve that, a typical <code>TemplateSquenceModel</code> implementation will store the <code>ObjectWrapper</code> that has cerated it, and then invoke that <code>ObjectWrapper</code> to wrap the contained value. The same logic stands for <code>TemplateHashModel</code> or for any other <code>TemplateModel</code> that's a container for further <code>TemplateModel</code>-s. Hence, usually, no mater how deep the value hierarchy is, all values will be wrapped by the same single <code>ObjectWrapper</code>. (To create <code>TemplateModel</code> implementations that follow this idiom, you can use the <code>freemarker.template.WrappingTemplateModel</code> as base class.)</p>
<p>The data-model itself (the root variable) is a <code>TemplateHashModel</code>. The root object that you specify to <code>Template.process</code> will be wrapped with the object wrapper specified in the <code>object_wrapper</code> configuration setting, which must yield a <code>TemplateHashModel</code>. From then on, the wrapping of the contained values follow the logic described earlier (i.e., the container is responsible for wrapping its children).</p>
<p>Well behaving object wrappers bypass objects that already implement <code>TemplateModel</code> as is. So if you put an object into the data-model that already implements <code>TemplateModel</code> (or you return as such object from a Java method that's called from the template, etc.), then you can avoid actual object wrapping. You do this usually when you are creating a value specifically to be accessed from a template. Thus, you avoid much of the object wrapping performance overhead, also you can control exactly what will the template see (not depending on the mapping strategy of the current object wrapper). A frequent application of this trick is using a <code>freemarker.template.SimpleHash</code> as the data-model root (rather than a <code>Map</code>), by filling it with <code>SimpleHash</code>'s <code>put</code> method (that's important, so it won't have to copy an existing <code>Map</code> that you have already filled). This speeds up top-level data-model variable access.</p>
<h3 id="pgui_datamodel_defaultObjectWrapper">The default object wrapper</h3>
object wrapper
default
DefaultObjectWrapper
<p>The default of the <code>object_wrapper</code> <code>Configuration</code> setting is a <code>freemarker.template.DefaultObjectWrapper</code> singleton. Unless you have very special requirements, it's recommended to use this object wrapper, or an instance of a <code>DefaultObjectWrapper</code> subclass of yours.</p>
<p>It recognizes most basic Java types, like <code>String</code>, <code>Number</code>, <code>Boolean</code>, <code>Date</code>, <code>List</code> (and in general all kind of <code>java.util.Collection</code>-s), arrays, <code>Map</code>, etc., and wraps them into the naturally matching <code>TemplateModel</code> interfaces. It will also wrap W3C DOM nodes with <code>freemarker.ext.dom.NodeModel</code>, so you can conveniently traverse XML as <a href="#xgui">described in its own chapter</a>). For Jython objects, it will delegate to <code>freemarker.ext.jython.JythonWrapper</code>. For all other objects, it will invoke <code>BeansWrapper.wrap</code> (the super class's method), which will expose the JavaBean properties of the objects as hash items (like <code>myObj.foo</code> in FTL will call <code>getFoo()</code> behind the scenes), and will also expose the public methods (JavaBean actions) of the object (like <code>myObj.bar(1, 2)</code> in FTL will call a method). (For more information about BeansWrapper, <a href="#pgui_misc_beanwrapper">see its own section</a>.)</p>
<p>Some further details that's worth mentioning about <code>DefaultObjectWrapper</code>:</p>
<ul>
<li><p>You shouldn't use its constructor usually, instead create it using a <code>DefaultObjectWrapperBuilder</code>. This allows FreeMarker to use singletons.</p></li>
<li><p><code>DefaultObjectWrapper</code> has an <code>incompatibleImprovements</code> property, that's highly recommended to set it to a high value (see the <a href="http://freemarker.org/docs/api/freemarker/template/DefaultObjectWrapper.html#DefaultObjectWrapper-freemarker.template.Version-">API documentation</a> for the effects). How to set it:</p>
<ul>
<li><p>If you have set the <code>incompatible_improvements</code> setting <em>of the <code>Configuration</code></em> to 2.3.22 or higher, and you didn't set the <code>object_wrapper</code> setting (so it had remained on its default value), then you have to do nothing, as it already uses a <code>DefaultObjectWrapper</code> singleton with the equivalent <code>incompatibleImprovements</code> property value.</p></li>
<li><p>Otherwise you have to set the <code>incompatibleImprovements</code> independently of the <code>Configuration</code>. Depending on how you create/set the <code>ObjectWrapper</code>, it can be done like this:</p>
<ul>
<li><p>If you are using the builder API:</p>
<pre><code>... = new DefaultObjectWrapperBuilder(Configuration.VERSION_2_3_27).build()</code></pre></li>
<li><p>Or, if you are using the constructor:</p>
<pre><code>... = new DefaultObjectWrapper(Configuration.VERSION_2_3_27)</code></pre></li>
<li><p>Or, if you are using the <code>object_wrapper</code> property (<code>*.properties</code> file or <code>java.util.Properties</code> object):</p>
<pre><code>object_wrapper=DefaultObjectWrapper(2.3.27)</code></pre></li>
<li><p>Or, if you are configuring the <code>object_wrapper</code> through a <code>FreemarkerServlet</code> with an <code>init-param</code> in <code>web.xml</code>:</p>
<pre><code>&lt;init-param&gt;
    &lt;param-name&gt;object_wrapper&lt;/param-name&gt;
    &lt;param-value&gt;DefaultObjectWrapper(2.3.27)&lt;/param-value&gt;
&lt;/init-param&gt;</code></pre></li>
</ul></li>
</ul></li>
<li><p>In new or properly test-covered projects it's also recommended to set the <code>forceLegacyNonListCollections</code> property to <code>false</code>. If you are using <code>.properties</code> or <code>FreemarkerServlet</code> init-params or such, that will look like <code>DefaultObjectWrapper(2.3.22,
              forceLegacyNonListCollections=false)</code>, while with the Java API you call <code>setForceLegacyNonListCollections(false)</code> on the <code>DefaultObjectWrapperBuilder</code> object before calling <code>build()</code>.</p></li>
<li><p>The most common way of customizing <code>DefaultObjectWrapper</code> is overriding its <code>handleUnknownType</code> method.</p></li>
</ul>
<h3 id="pgui_datamodel_customObjectWrappingExample">Custom object wrapping example</h3>
object wrapper
custom
custom object wrapper
DefaultObjectWrapper
extending
<p>Let's say you have an application-specific class like this:</p>
<pre><code>package com.example.myapp;

public class Tupple&lt;E1, E2&gt; {
    public Tupple(E1 e1, E2 e2) { ... }
    public E1 getE1() { ... }
    public E2 getE2() { ... }
}</code></pre>
<p>You want templates to see this as a sequence of length 2, so that you can do things like <code>someTupple[1]</code>, <code>&lt;#list someTupple
          ...&gt;</code>, or <code>someTupple?size</code>. For that you need to create a <code>TemplateSequenceModel</code> implementation that adapts a <code>Tupple</code> to the <code>TempateSequenceMoldel</code> interface:</p>
<pre><code>package com.example.myapp.freemarker;

...

public class TuppleAdapter extends WrappingTemplateModel implements TemplateSequenceModel,
        AdapterTemplateModel {

    private final Tupple&lt;?, ?&gt; tupple;

    public TuppleAdapter(Tupple&lt;?, ?&gt; tupple, ObjectWrapper ow) {
        super(ow);  // coming from WrappingTemplateModel
        this.tupple = tupple;
    }

    @Override  // coming from TemplateSequenceModel
    public int size() throws TemplateModelException {
        return 2;
    }

    @Override  // coming from TemplateSequenceModel
    public TemplateModel get(int index) throws TemplateModelException {
        switch (index) {
        case 0: return wrap(tupple.getE1());
        case 1: return wrap(tupple.getE2());
        default: return null;
        }
    }

    @Override  // coming from AdapterTemplateModel
    public Object getAdaptedObject(Class hint) {
        return tupple;
    }

}</code></pre>
<p>Regarding the classes and interfaces:</p>
<ul>
<li><p><code>TemplateSequenceModel</code>: This is why the template will see this as a sequence</p></li>
<li><p><code>WrappingTemplateModel</code>: Just a convenience class, used for <code>TemplateModel</code>-s that do object wrapping themselves. That's normally only needed for objects that contain other objects. See the <code>wrap(...)</code> calls above.</p></li>
<li><p><code>AdapterTemplateModel</code>: Indicates that this template model adapts an already existing object to a <code>TemplateModel</code> interface, thus unwrapping should give back that original object.</p></li>
</ul>
<p>Lastly, we tell FreeMarker to wrap <code>Tupple</code>-s with the <code>TuppleAdapter</code> (alternatively, you could wrap them manually before passing them to FreeMarker). For that, first we create a custom object wrapper:</p>
<pre><code>package com.example.myapp.freemarker;

...

public class MyAppObjectWrapper extends DefaultObjectWrapper {

    public MyAppObjectWrapper(Version incompatibleImprovements) {
        super(incompatibleImprovements);
    }

    @Override
    protected TemplateModel handleUnknownType(final Object obj) throws TemplateModelException {
        if (obj instanceof Tupple) {
            return new TuppleAdapter((Tupple&lt;?, ?&gt;) obj, this);
        }

        return super.handleUnknownType(obj);
    }

}</code></pre>
<p>and then where you configure FreeMarker (<a href="#pgui_config">about configuring, see here...</a>) we plug our object wrapper in:</p>
<pre><code>// Where you initialize the cfg *singleton* (happens just once in the application life-cycle):
cfg = new Configuration(Configuration.VERSION_2_3_27);
...
cfg.setObjectWrapper(new MyAppObjectWrapper(cfg.getIncompatibleImprovements()));</code></pre>
<p>or if you are configuring FreeMarker with <code>java.util.Properties</code> instead (and let's say it's also a <code>.properties</code> file):</p>
<pre><code>object_wrapper=com.example.myapp.freemarker.MyAppObjectWrapper(2.3.27)</code></pre>
<h1 id="pgui_config">The Configuration</h1>
Configuration
<p>This is just an overview. See the FreeMarker Java API documentation for the details.</p>
<h2 id="pgui_config_basics">Basics</h2>
<p>First of all, be sure you have read the <a href="#pgui_quickstart_createconfiguration">Getting Started</a> chapter.</p>
<p>A configuration is a <code>freemarker.template.Configuration</code> object that stores your common (global, application level) settings and defines variables that you want to be available in all templates (so called shared variables). Also, it deals with the creation and caching of <code>Template</code> instances.</p>
<p>An application typically uses only a single shared <code>Configuration</code> instance. More precisely, typically you have one <code>Configuration</code> instance per independently developed component that internally uses FreeMarker, so they can be configured independently of each other. For example, your e-mail sender component and your report generator component (service) probably want to use their own <code>Configuration</code>-s, as their needs differ.</p>
<p>As the behavior of templates depends on the configuration settings, each <code>Template</code> instance has an associated <code>Configuration</code> instance. If you obtain the <code>Template</code> instances with <code>Configuration.getTemplate</code>, the associated <code>Configuration</code> instance will be the one whose <code>getTemplate</code> method was called. If you create the <code>Template</code> instances directly with the <code>Template</code> constructor, the <code>Configuration</code> should be specified as constructor parameter.</p>
<h2 id="pgui_config_sharedvariables">Shared variables</h2>
shared variable
<p><em>Shared variables</em> are variables that are defined for all templates. You can add shared variables to the configuration with the <code>setSharedVariable</code> methods:</p>
<pre><code>Configuration cfg = new Configuration(Configuration.VERSION_2_3_27);
...
cfg.setSharedVariable(&quot;warp&quot;, new WarpDirective());
cfg.setSharedVariable(&quot;company&quot;, &quot;Foo Inc.&quot;);</code></pre>
<p>In all templates that use this configuration, an user-defined directive with name <code>wrap</code> and a string with name <code>company</code> will be visible in the data-model root, so you don't have to add them to the root hash again and again. A variable in the root object that you pass to the <code>Template.process</code> will hide the shared variable with the same name.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Never use <code>TemplateModel</code> implementation that is not <a href="#gloss.threadSafe">thread-safe</a> for shared variables, if the configuration is used by multiple threads! This is the typical situation for Servlet based applications.</p>
</blockquote>
<p>Due to backward compatibility heritage, the set of shared variables is initially (i.e., for a new <code>Configuration</code> instance) not empty. It contains the following user-defined directives (they are &quot;user-defined&quot; in the sense that you use <code>@</code> to call them instead of <code>#</code>):</p>
<table>
<thead>
<tr class="header">
<th>name</th>
<th>class</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>capture_output</code></td>
<td><code>freemarker.template.utility.CaptureOutput</code></td>
</tr>
<tr class="even">
<td><code>compress</code></td>
<td><code>freemarker.template.utility.StandardCompress</code></td>
</tr>
<tr class="odd">
<td><code>html_escape</code></td>
<td><code>freemarker.template.utility.HtmlEscape</code></td>
</tr>
<tr class="even">
<td><code>normalize_newlines</code></td>
<td><code>freemarker.template.utility.NormalizeNewlines</code></td>
</tr>
<tr class="odd">
<td><code>xml_escape</code></td>
<td><code>freemarker.template.utility.XmlEscape</code></td>
</tr>
</tbody>
</table>
<h2 id="pgui_config_settings">Settings</h2>
setting
<p><em>Settings</em> are named values that influence the behavior of FreeMarker. Examples of settings are: <code>locale</code>, <code>number_format</code>, <code>default_encoding</code>, <code>template_exception_handler</code>. The full list of settings can be found in the <a href="http://freemarker.org/docs/api/freemarker/template/Configuration.html#setSetting-java.lang.String-java.lang.String-">Java API documentation of <code>Configuration.setSetting(...)</code></a>.</p>
<p>The settings coming from the <code>Configuration</code> can be overridden in a <code>Template</code> instance. For example, if you set the <code>locale</code> setting to <code>&quot;en_US&quot;</code> in the configuration, then the <code>locale</code> in all templates that use this configuration will be <code>&quot;en_US&quot;</code>, except in templates where the <code>locale</code> was explicitly specified differently (see <a href="#ref_directive_include_localized">localization</a>). Thus, the setting values in the <code>Configuration</code> serve as defaults that can be overridden in a per template manner. The value coming from the <code>Configuration</code> instance or <code>Template</code> instance can be further overridden for a single <code>Template.process</code> call. For each such call a <code>freemarker.core.Environment</code> object is created internally that holds the runtime environment of the template processing, including the setting values that were overridden on that level. The values stored there can even be changed during the template processing, so a template can set settings itself, like switching <code>locale</code> at the middle of the ongoing processing.</p>
<p>This can be imagined as 3 layers (<code>Configuration</code>, <code>Template</code>, <code>Environment</code>) of settings, where the topmost layer that contains the value for a certain setting provides the effective value of that setting. For example (settings A to F are just imaginary settings for this example):</p>
<table>
<thead>
<tr class="header">
<th style="text-align: left;"></th>
<th style="text-align: center;">Setting A</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Layer 3: <code>Environment</code></td>
<td style="text-align: center;">1</td>
</tr>
<tr class="even">
<td style="text-align: left;">Layer 2: <code>Template</code></td>
<td style="text-align: center;">2</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Layer 1: <code>Configuration</code></td>
<td style="text-align: center;">3</td>
</tr>
</tbody>
</table>
<p>The effective value of settings will be: A = 1, B = 2, C = 3, D = 1, E = 2. The F setting is probably <code>null</code>, or it throws exception when you try to get it.</p>
<p>Let's see exactly how to set settings:</p>
<ul>
<li><p><code>Configuration</code> layer: In principle you set the settings with the setter methods of the <code>Configuration</code> object, fore example:</p>
<pre><code>Configuration myCfg = new Configuration(Configuration.VERSION_2_3_27);
myCfg.setTemplateExceptionHandler(TemplateExceptionHandler.RETHROW_HANDLER);
myCfg.setDefaultEncoding(&quot;UTF-8&quot;);
DefaultObjectWrapperBuilder owb = new DefaultObjectWrapperBuilder(Configuration.VERSION_2_3_27);
owb.setForceLegacyNonListCollections(false);
owb.setDefaultDateType(TemplateDateModel.DATETIME);
myCfg.setObjectWrapper(owb.build());</code></pre>
<p>You do this before you start to actually use the <code>Configuration</code> object (typically, when you initialize the application); you should treat the object as read-only after that.</p>
<p>In practice, in most frameworks you have to specify the settings in some kind of framework-specific configuration file that require specifying settings as <code>String</code> name-value pairs (like in a <code>.properties</code> file). In that case the authors of the frameworks most probably use the <code>Confguration.setSetting(String name, String
            value)</code> method; see available setting names and the format of the values in the <a href="http://freemarker.org/docs/api/freemarker/template/Configuration.html#setSetting-java.lang.String-java.lang.String-">API documentation of <code>setSetting</code></a>. Example for Spring Framework:</p>
<pre><code>&lt;bean id=&quot;freemarkerConfig&quot;
    class=&quot;org.springframework.web.servlet.view.freemarker.FreeMarkerConfigurer&quot;&gt;
  &lt;property name=&quot;freemarkerSettings&quot;&gt;
    &lt;props&gt;
      &lt;prop key=&quot;incompatible_improvements&quot;&gt;2.3.27&lt;/prop&gt;
      &lt;prop key=&quot;template_exception_handler&quot;&gt;rethrow&lt;/prop&gt;
      &lt;prop key=&quot;default_encoding&quot;&gt;UTF-8&lt;/prop&gt;
      &lt;prop key=&quot;object_wrapper&quot;&gt;
        DefaultObjectWrapper(
                2.3.27,
                forceLegacyNonListCollections = false,
                defaultDateType = freemarker.template.TemplateDateModel.DATETIME)
      &lt;/prop&gt;
    &lt;/props&gt;
  &lt;/property&gt;
&lt;/bean&gt;</code></pre>
<p>Here's the same when configuring FreeMarker for Struts, which looks for a <code>freemarker.properties</code> in the classpath:</p>
<pre><code>incompatible_improvements=2.3.27
template_exception_handler=rethrow
default_encoding=UTF-8
object_wrapper=DefaultObjectWrapper( \
        2.3.27, \
        forceLegacyNonListCollections = false, \
        defaultDateType = freemarker.template.TemplateDateModel.DATETIME)</code></pre>
<p>As demonstrated above with <code>object_wrapper</code>, some settings can accept quite complex values, which can be used to instantiate objects of arbitrary classes and set their properties. Still, configuring with <code>String</code> key-value pairs is limited compared to directly using the Java API, so in some cases you have to find a way to do this in Java.</p></li>
<li><p><code>Template</code> layer: Settings on individual templates are normally set by <a href="#pgui_config_templateconfigurations">template configurations (see them in their own chapter)</a>, which basically associate setting assignments to template name (template path) patterns. There's a deviation from this approach with the <code>locale</code> setting, because that you can also specify to <code>Configuration.getTemplate(...)</code> as parameter, to get the template for the requested locale (so called localized lookup).</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>You should never set settings directly on the <code>Template</code> object that you get from <code>Configuration.getTemplate(...)</code>! Those objects should be treated as already initialized and read-only.</p>
</blockquote>
<p>When a template includes or imports another template, most of the settings (like <code>locale</code>, <code>number_format</code>, etc.) will remain those specified by the top-level template. The exceptions are the settings that affect the parsing of the template (like <code>tag_syntax</code>, <code>whitespace_stripping</code>, etc.), as these are not inherited from the top-level template, instead each template always uses its own values, no mater how it was invoked.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>If you are going to use template layer settings, you should set <a href="#pgui_config_incompatible_improvements">the <code>incompatible_improvements</code> setting</a> to 2.3.22 or higher, to avoid some confusing legacy bugs.</p>
</blockquote></li>
<li><p><code>Environment </code>layer: There are two ways of doing it:</p>
<ul>
<li><p>With Java API: Use the setter methods of the <code>Environment</code> object. You may run into the API problem that <code>myTemplate.process(...)</code> both creates the <code>Environment</code> object internally and processes the template, so you have no opportunity to adjust the <code>Environment</code> in between. The solution is that those two steps can be separated like this:</p>
<pre><code>Environment env = myTemplate.createProcessingEnvironment(root, out);
env.setLocale(java.util.Locale.ITALY);
env.setNumberFormat(&quot;0.####&quot;);
env.process();  // process the template</code></pre></li>
<li><p>Directly in the Template (considered as bad style, usually): Use the <a href="#ref.directive.setting"><code>setting</code> directive</a>, for example:</p>
<pre><code>&lt;#setting locale=&quot;it_IT&quot;&gt;
&lt;#setting number_format=&quot;0.####&quot;&gt;</code></pre></li>
</ul>
<p>There are no restriction regarding when can you change the settings in this layer.</p></li>
</ul>
<p>To see the list of supported settings and their meaning, please read the following parts of the FreeMarker Java API documentation:</p>
<ul>
<li><p>Setter methods of <code>freemarker.core.Configurable</code> for the settings that are in all three layers</p></li>
<li><p>Setter methods of <code>freemarker.template.Configuration</code> for the settings that are available only in the <code>Configuration</code> layer</p></li>
<li><p><code>freemarker.core.Configurable.setSetting(String,
            String)</code> for settings that are available in all three layers and are writable with <code>String</code> key-value pairs.</p></li>
<li><p><code>freemarker.template.Configuration.setSetting(String,
            String)</code> for settings that are available only in the <code>Configuration</code> layer and are writable with <code>String</code> key-value pairs.</p></li>
</ul>
<h2 id="pgui_config_templateloading">Template loading</h2>
loading templates
template loading
storing templates
<h3>Template loaders</h3>
template loaders
<p>Template loaders are objects that load raw textual data based on abstract template paths like <code>&quot;index.ftl&quot;</code> or <code>&quot;products/catalog.ftl&quot;</code>. It's up to the concrete template loader if from where and how the template “files” are loaded. They could be real files inside a specified directory, or values in a data base table, or <code>String</code>-s in a Java Map, etc. When you call <code>cfg.getTemplate</code> (where <code>cfg</code> is a <code>Configuration</code> instance), FreeMarker asks the template loader (<code>cfg.getTemplateLoader</code>) to return the text for the given template path, and then FreeMarker parses that text as template. It doesn't care or even know if the template is a real file or not, and where it is physically; those details are only known by the template loader.</p>
<h4>Built-in template loaders</h4>
<p>You can set up the three most common template loading mechanism in the <code>Configuration</code> using the following <em>convenience</em> methods:</p>
<ul>
<li><p><code>void setDirectoryForTemplateLoading(File
                dir)</code>: Sets a directory on the file system from which to load templates. Template names (template paths) will be interpreted relatively to this physical directory. It won't let you load files outside this directory.</p></li>
<li><p><code>void setClassForTemplateLoading(Class cl,
                String basePackagePath)</code> and <code>void
                setClassLoaderForTemplateLoading(ClassLoader classLoader,
                String basePackagePath)</code>: These are for when you want to load templates via the same mechanism with which Java loads classes (from the class-path, as they used to say vaguely). This is very likely be the preferred means of loading templates for production code, as it allows you to keep everything inside the deployment <code>jar</code> files. The first parameter decides which Java <code>ClassLoader</code> will be used. The second parameter specifies the package that contains the templates, in <code>/</code>-separated format. Note that if you don't start it with <code>/</code>, it will be interpreted relatively to the package of the <code>Class</code> parameter.</p></li>
<li><p><code>void setServletContextForTemplateLoading(Object
                servletContext, String path)</code>: Takes the context of your Servlet-based web application, and a base path, which is interpreted relative to the web application root directory (that's the parent of the <code>WEB-INF</code> directory). Note that we refer to &quot;directory&quot; here although this loading method works even for unpacked <code>.war</code> files, since it uses <code>ServletContext.getResource()</code> to access the templates. If you omit the second parameter (or use <code>&quot;&quot;</code>), you can simply store the static files (<code>.html</code>, <code>.jpg</code>, etc.) mixed with the <code>.ftl</code> files. Of course, you must set up a Servlet for the <code>*.ftl</code>, <code>*.ftlh</code>, <code>*.ftlx</code> uri-patterns in <code>WEB-INF/web.xml</code> for this, otherwise the client will get the raw templates as is! To avoid a such accident, many prefers storing the templates somewhere inside the <code>WEB-INF</code> directory, which is never visitable directly. This mechanism will very likely be the preferred means of loading templates for servlet applications, since the templates can be updated without restarting the web application, while this often doesn't work with the class-loader mechanism.</p></li>
</ul>
<p>If you want to use a custom <code>TemplateLoader</code> implementation, or need to set up some extra settings of a built-in template loader, you need to instantiate the <code>TemplateLoader</code> object yourself, and then call <code>Configuration.setTemplateLoader(TemplateLoader)</code>:</p>
<pre><code>WebappTemplateLoader templateLoader = new WebappTemplateLoader(servletContext, &quot;WEB-INF/templates&quot;);
templateLoader.setURLConnectionUsesCaches(false);
templateLoader.setAttemptFileAccess(false);
cfg.setTemplateLoader(templateLoader);</code></pre>
<h4>Loading templates from multiple locations</h4>
<p>If you need to load templates from multiple locations, you have to instantiate the template loader objects for every location, wrap them into a <code>MultiTemplateLoader</code>, and finally pass that loader to the <code>setTemplateLoader(TemplateLoader loader)</code> method of <code>Configuration</code>. Here's an example for loading templates from two distinct directories and with the class-loader:</p>
<pre><code>import freemarker.cache.*; // template loaders live in this package

...

FileTemplateLoader ftl1 = new FileTemplateLoader(new File(&quot;/tmp/templates&quot;));
FileTemplateLoader ftl2 = new FileTemplateLoader(new File(&quot;/usr/data/templates&quot;));
ClassTemplateLoader ctl = new ClassTemplateLoader(getClass(), &quot;/com/example/templates&quot;);

MultiTemplateLoader mtl = new MultiTemplateLoader(new TemplateLoader[] { ftl1, ftl2, ctl });

cfg.setTemplateLoader(mtl);</code></pre>
<p>Now FreeMarker will try to load templates from <code>/tmp/templates</code> directory, and if it does not find the requested template there, it will try to load that from <code>/usr/data/templates</code>, and if it still does not find the requested template, then it tries to load it from the <code>com.example.templates</code> Java package.</p>
<h4>Loading templates from other sources</h4>
<p>If none of the built-in class loaders fit your needs, you can write your own class that implements the <code>freemarker.cache.TemplateLoader</code> interface and pass it to the <code>setTemplateLoader(TemplateLoader
            loader)</code> method of <code>Configuration</code>. Please read the API JavaDoc for more information.</p>
<p>If your template source accesses the templates through an URL, you needn't implement a <code>TemplateLoader</code> from scratch; you can choose to subclass <code>freemarker.cache.URLTemplateLoader</code> instead and just implement the <code>URL getURL(String
            templateName)</code> method.</p>
<h4>The template name (template path)</h4>
path
template path
template name
<p>It is up to the template loader how it interprets template names (also known as template paths). But to work together with other components there are restrictions regarding the format of the path. In general, it is strongly recommended that template loaders use URL-style paths. The path must not use <code>/</code> (path step separator) character, nor the <code>.</code> (same-directory) and <code>..</code> (parent directory) path steps with other meaning than they have in URL paths (or in UN*X paths). The <code>*</code> (asterisk) step is also reserved, and used for “template acquisition” feature of FreeMarker.</p>
<p><code>://</code> (or with <code>template_name_format</code> setting set to <code>DEFAULT_2_4_0</code>, the <code>:</code> (colon) character) is reserved for specifying a scheme part, similarly as it works with URI-s. For example <code>someModule://foo/bar.ftl</code> uses the <code>someModule</code>, or assuming the <code>DEFAULT_2_4_0</code> format, <code>classpath:foo/bar.ftl</code> uses the <code>classpath</code> scheme. Interpreting the scheme part is completely up to the <code>TemplateLoader</code>. (The FreeMarker core is only aware of the idea of schemes because otherwise it couldn't resolve relative template names properly.)</p>
<p>FreeMarker always normalizes the paths before passing them to the <code>TemplateLoader</code>, so the paths don't contain <code>/../</code> or such, and are relative to the imaginary template root directory (that is, they don't start with <code>/</code>). They don't contain the <code>*</code> step either, as template acquisition happens in an earlier stage. Furthermore, with <code>template_name_format</code> setting set to <code>DEFAULT_2_4_0</code>, multiple consecutive <code>/</code>-s will be normalized to a single <code>/</code> (unless they are part of the <code>://</code> scheme separator).</p>
<p>Note that FreeMarker template path should always uses slash (not backslash) regardless of the host OS.</p>
<h3 id="pgui_config_templateloading_caching">Template caching</h3>
caching
template caching
<p>FreeMarker caches templates (assuming you use the <code>Configuration</code> methods to create <code>Template</code> objects). This means that when you call <code>getTemplate</code>, FreeMarker not only returns the resulting <code>Template</code> object, but stores it in a cache, so when next time you call <code>getTemplate</code> with the same (or equivalent) path, it just returns the cached <code>Template</code> instance, and will not load and parse the template file again.</p>
<p>If you change the template file, then FreeMarker will re-load and re-parse the template automatically when you get the template next time. However, since always checking for changes can be burden for a system that processes lot of templates, there is a <code>Configuration</code> level setting called “update delay” (defaults is 5 seconds). Until this much time has elapsed since the last checking for a newer version, FreeMarker will not check again if the template was changed. If you want to see the changes without delay, set this setting to 0. Note that some template loaders won't see that a template was changed because of the underlying storage mechanism doesn't support that; for example, class-loader based template loaders may have this problem.</p>
<p>A template will be removed from the cache if you call <code>getTemplate</code> and FreeMarker realizes that the template file has been removed meanwhile. Also, if the JVM thinks that it begins to run out of memory, by default it can arbitrarily drop templates from the cache. Furthermore, you can empty the cache manually with the <code>clearTemplateCache</code> method of <code>Configuration</code>. You can also drop selected template from the cache with <code>removeTemplateFromCache</code>; this can be also utilized to force re-loading a template regardless of the “update delay” setting.</p>
<p>The actual strategy of when a cached template should be thrown away is pluggable with the <code>cache_storage</code> setting, by which you can plug any <code>CacheStorage</code> implementation. For most users <code>freemarker.cache.MruCacheStorage</code> will be sufficient. This cache storage implements a two-level Most Recently Used cache. In the first level, items are strongly referenced up to the specified maximum (strongly referenced items can't be dropped by the JVM, as opposed to softly referenced items). When the maximum is exceeded, the least recently used item is moved into the second level cache, where they are softly referenced, up to another specified maximum. The size of the strong and soft parts can be specified with the constructor. For example, set the size of the strong part to 20, and the size of soft part to 250:</p>
<pre><code>cfg.setCacheStorage(new freemarker.cache.MruCacheStorage(20, 250))</code></pre>
<p>Or, since <code>MruCacheStorage</code> is the default cache storage implementation:</p>
<pre><code>cfg.setSetting(Configuration.CACHE_STORAGE_KEY, &quot;strong:20, soft:250&quot;);</code></pre>
<p>When you create a new <code>Configuration</code> object, initially it uses an <code>MruCacheStorage</code> where <code>strongSizeLimit</code> is 0, and <code>softSizeLimit</code> is <code>Integer.MAX_VALUE</code> (that is, in practice, infinite). Depending on how smart the JVM is, using non-0 <code>strongSizeLimit</code> is maybe a safer option, as with only softly referenced items the JVM could even throw the most frequently used templates when there's a resource shortage, which then have to be re-loaded and re-parsed, burdening the system even more.</p>
<h2 id="pgui_config_errorhandling">Error handling</h2>
error handling
exception handling
<h3>The possible exceptions</h3>
<p>The exceptions that can occur regarding FreeMarker could be classified like this:</p>
<ul>
<li><p>Exceptions occurring when you configure FreeMarker: Typically you configure FreeMarker only once in your application, when your application initializes itself. Of course, during this, exceptions can occur.</p></li>
<li><p>Exceptions occurring when loading and parsing templates: When you call <code>Configuration.getTemplate(...)</code>, FreeMarker has to load the template into the memory and parse it (unless the template is already <a href="#pgui_config_templateloading_caching">cached</a> in that <code>Configuration</code> object). During this, these kind of exceptions can occur:</p>
<ul>
<li><p><code>TemplateNotFoundException</code> because the requested template doesn't exist. Note this extends <code>IOException</code>.</p></li>
<li><p><code>freemarker.core.ParseException</code> because the template is syntactically incorrect according the rules of the FTL language. Note that this error occurs when you obtain the <code>Template</code> object (<code>Configuration.getTemplate(...)</code>), not later when you execute (<code>Template.process(...)</code>) the template. . Note this extends <code>IOException</code> (legacy).</p></li>
<li><p>Any other kind of <code>IOException</code> because an error has occurred while reading an existing template. For example you have no right to read the file, or the connection through which you read the template is broken. The emitter of these is the <a href="#pgui_config_templateloading"><code>TemplateLoader</code> object</a>, which is plugged into the <code>Configuration</code> object.</p></li>
</ul></li>
<li><p>Exceptions occurring when executing (processing) templates, that is, when you call <code>Template.process(...)</code>. Two kind of exceptions can occur:</p>
<ul>
<li><p><code>IOException</code> because there was an error when trying to write into the output writer.</p></li>
<li><p><code>freemarker.template.TemplatException</code> because other problem occurred while executing the template. For example, a frequent error is referring to a variable that doesn't exist in the data-model. By default, when a <code>TemplatException</code> occurs, FreeMarker prints the FTL error message and the stack trace to the output writer with plain text format, and then aborts the template execution by re-throwing the <code>TemplatException</code>, which then you can catch as <code>Template.process(...)</code> throws it. This behavior can be customized, and in fact, it should be; see the recommended configuration <a href="#pgui_quickstart_createconfiguration">here</a>. By default FreeMarker also <a href="#pgui_misc_logging">logs</a> <code>TemplatException</code>-s.</p></li>
</ul></li>
</ul>
<h3>Customizing the behavior regarding TemplatException-s</h3>
<p><code>TemplateException</code>-s thrown during the template processing are handled by the <code>freemarker.template.TemplateExceptionHandler</code> object, which is plugged into the <code>Configuration</code> object with its <code>setTemplateExceptionHandler(...)</code> method. These are the <code>TemplateExceptionHandler</code> implementations with FreeMarker comes with:</p>
<ul>
<li><p><code>TemplateExceptionHandler.DEBUG_HANDLER</code>: Prints stack trace (includes FTL error message and FTL stack trace) and re-throws the exception. This is the default handler, however, you should be careful not using it in production environment, as it shows technical information about your system.</p></li>
<li><p><code>TemplateExceptionHandler.HTML_DEBUG_HANDLER</code>: Same as <code>DEBUG_HANDLER</code>, but it formats the stack trace so that it will be readable with Web browsers. Recommended over <code>DEBUG_HANDLER</code> when you generate HTML pages, but it should only be used for development as it shows technical information about your system.</p></li>
<li><p><code>TemplateExceptionHandler.IGNORE_HANDLER</code>: Simply suppresses all exceptions (though FreeMarker will still log them if <code>Configuration.getLogTemplateExceptions</code> is <code>true</code>). It does nothing to handle the event. It does not re-throw the exception.</p></li>
<li><p><code>TemplateExceptionHandler.RETHROW_HANDLER</code>: Simply re-throws all exceptions; it doesn't do anything else. This should be used in most applications today. It doesn't print anything to the output about the error, which makes it safe, and the developers can still get the error details from the logs. It's not as convenient during template development as <code>HTML_DEBUG_HANDLER</code> or <code>DEBUG_HANDLER</code> though. For more information about handling errors in Web applications <a href="#misc.faq.niceErrorPage">see the FAQ</a>.</p></li>
</ul>
<p>You can also write a custom <code>TemplateExceptionHandler</code> by implementing that interface, which contains this method:</p>
<pre><code>void handleTemplateException(TemplateException te, Environment env, Writer out)
        throws TemplateException;</code></pre>
<p>Whenever a <code>TemplateException</code> occurs, this method will be called. The exception to handle is in the <code>te</code> argument, the runtime environment of the template processing is in the <code>env</code> argument, and the handler can print to the output using the <code>out</code> argument. If this method throws exception (usually it re-throws <code>te</code>), then the template processing will be aborted, and <code>Template.process(...)</code> will throw the same exception. If <code>handleTemplateException</code> doesn't throw exception, then template processing continues as if nothing had happen, but the statement that caused the exception will be skipped (see more later). Of course, the handler can still print an error indicator to the output.</p>
<p>Let's see how FreeMarker skips statements when the error handler doesn't throw exception, through examples. Assume we are using this template exception handler:</p>
<pre><code>class MyTemplateExceptionHandler implements TemplateExceptionHandler {
    public void handleTemplateException(TemplateException te, Environment env, java.io.Writer out)
            throws TemplateException {
        try {
            out.write(&quot;[ERROR: &quot; + te.getMessage() + &quot;]&quot;);
        } catch (IOException e) {
            throw new TemplateException(&quot;Failed to print error message. Cause: &quot; + e, env);
        }
    }
}

...

cfg.setTemplateExceptionHandler(new MyTemplateExceptionHandler());</code></pre>
<p>If an error occurs in an interpolation which is not inside an FTL tag (that is, not enclosed into <code>&lt;#...&gt;</code> or <code>&lt;@...&gt;</code>), then the whole interpolation will be skipped. So this template (assuming that <code>badVar</code> is missing from the data-model):</p>
<pre><code>a${badVar}b</code></pre>
<p>will print this if we use the <code>MyTemplateExceptionHandler</code>:</p>
<pre><code>a[ERROR: Expression badVar is undefined on line 1, column 4 in test.ftl.]b</code></pre>
<p>This template will print the same (except that the column number will differ...):</p>
<pre><code>a${&quot;moo&quot; + badVar}b</code></pre>
<p>because the whole interpolation is skipped if any error occurs inside it.</p>
<p>If an error occurs when evaluating the value of a parameter for a directive call, or if there are other problems with the parameter list, or if an error occurs when evaluating <code>exp</code> in <code>&lt;@exp
          ...&gt;</code>, or if the value of <code>exp</code> is not an user-defined directive, then the whole directive call is skipped. For example this:</p>
<pre><code>a&lt;#if badVar&gt;Foo&lt;/#if&gt;b</code></pre>
<p>will print this:</p>
<pre><code>a[ERROR: Expression badVar is undefined on line 1, column 7 in test.ftlh.]b</code></pre>
<p>Note that the error occurred in the <code>if</code> start-tag (<code>&lt;#if badVar&gt;</code>), but the whole directive call was skipped. Logically, the nested content (<code>Foo</code>) was skipped with this, since the nested content is handled (printed) by the enclosing directive (<code>if</code>).</p>
<p>The output will be the same with this (except that the column number will differ...):</p>
<pre><code>a&lt;#if &quot;foo${badVar}&quot; == &quot;foobar&quot;&gt;Foo&lt;/#if&gt;b</code></pre>
<p>because whole directive calling will be skipped if any error occurs during the parameter evaluation.</p>
<p>The directive call will not be skipped if the error occurs after the execution of the directive was already started. That is, if an error occurs in the nested content:</p>
<pre><code>a
&lt;#if true&gt;
  Foo
  ${badVar}
  Bar
&lt;/#if&gt;
c</code></pre>
<p>or in the macro definition body:</p>
<pre><code>a
&lt;@test /&gt;
b
&lt;#macro test&gt;
  Foo
  ${badVar}
  Bar
&lt;/#macro&gt;</code></pre>
<p>the output will be something like:</p>
<pre><code>a
  Foo
  [ERROR: Expression badVar is undefined on line 4, column 5 in test.ftlh.]
  Bar
c</code></pre>
<h3>TemplateException logging</h3>
<p>By default FreeMarker <a href="#pgui_misc_logging">logs</a> all <code>TemplateException</code>-s under the <code>freemarker.runtime</code> log category, even when it will throw it at you from its public API. As logging has become common practice in Java applications, this usually leads to double logging of exceptions now, so it's recommended to disable this legacy behavior by <code>cfg.setLogTemplateExceptions(false)</code> (or <code>log_template_exceptions=false</code>) where you configure FreeMarker.</p>
<h3>Explicit error handling in templates</h3>
<p>Although it has nothing to do with the FreeMarker configuration (the topic of this chapter), for the sake of completeness it's mentioned here that you can handle errors directly inside the templates as well:</p>
<ul>
<li><p>Handling missing/null variables: <a href="#dgui_template_exp_missing">section_title</a></p></li>
<li><p>Substituting failing but expendable page sections: <a href="#ref_directive_attempt">section_title</a></p></li>
</ul>
<h2 id="pgui_config_templateconfigurations">Template configurations</h2>
<p>“Template configurations” refers to the <code>template_configurations</code> setting of <code>Configuration</code> (<code>Configuration.setTemplateConfigurations(...)</code>). This setting lets you override individual settings coming from the common <code>Configuration</code> object, depending on the name (path) of the template.</p>
<p>It's important to understand, however, that this setting only has effect if you get templates with <code>Configuration.getTemplate(...)</code>, not when you create templates directly with the <code>Template</code> constructors. In that case it's up to you to invoke this mechanism (see <code>TemplateCache</code> source code as an example).</p>
<p>You will use these kind of objects to declare your template configuration rules:</p>
<ul>
<li><p><code>TemplateConfiguration</code>-s: These store the actual setting assignments that you want to apply. For example, this <code>TemplateConfiguration</code> will set the encoding and the output format of the matched template (and leave all other settings of it alone):</p>
<pre><code>TemplateConfiguration tcUTF8XML = new TemplateConfiguration();
tc.setEncoding(&quot;utf-8&quot;);
tc.setOutputFormat(XMLOutputFormat.INSTANCE);</code></pre></li>
<li><p><code>TemplateSourceMatcher</code> (abstract) subclasses: These define a rule that matches templates based on their source name (their source path; as in <code>Template.getSourceName()</code>), and possibly on other <code>TemplateLoader</code>-dependent properties. For example, <code>new FileExtensionMatcher(&quot;xml&quot;)</code> matches templates that has <code>xml</code> file extension. See all the subclasses in the Java API documentation.</p></li>
<li><p><code>TemplateConfigurationFactory</code>-es: This is what connects <code>TemplateConfiguration</code>-s and <code>TemplateSourceMatcher</code>-s together. This is the Java type of the <code>template_configurations</code> setting. See the examples below for more.</p></li>
</ul>
<p>This setup combines our earlier two example objects with a <code>ConditionalTemplateConfigurationFactory</code>, causing all templates with <code>xml</code> extension to get UTF-8 encoding and XML output format:</p>
<pre><code>cfg.setTemplateConfigurations(
        new ConditionalTemplateConfigurationFactory(
                new FileExtensionMatcher(&quot;xml&quot;),
                tcUTF8XML));</code></pre>
<p>The same configuring is also doable if you don't have access to the configuring Java code, but only to a Java <code>*.properties</code> file or other kind of string-string key value pairs (the <code>\</code>-s are prescribed by the Java Properties file format for multi-line values):</p>
<pre><code>templateConfigurations = \
    ConditionalTemplateConfigurationFactory( \
        FileExtensionMatcher(&quot;xml&quot;), \
        TemplateConfiguration( \
            encoding = &quot;utf-8&quot;, \
            outputFormat = XMLOutputFormat() \
        ) \
    )</code></pre>
<p>Let's say you only need to handle templates in the <code>mail</code> directory specially, other templates can use the setting coming from the shared <code>Configuration</code> singleton. The names of templates there must contain <code>&quot;.subject.&quot;</code> or <code>&quot;.body.&quot;</code>. Subject templates must get <code>plainText</code> output format, while body templates must get <code>HTML</code> output format. So we have to make a choice here, and that's when you need a <code>FirstMatchTemplateConfigurationFactory</code>.</p>
<p>Assuming <code>cfg</code> stores the shared <code>Configuration</code> singleton, you set this up like this:</p>
<pre><code>cfg.setTemplateConfigurations(
        new ConditionalTemplateConfigurationFactory(
                new PathGlobMatcher(&quot;mail/**&quot;),
                new FirstMatchTemplateConfigurationFactory(
                        new ConditionalTemplateConfigurationFactory(
                                new FileNameGlobMatcher(&quot;*.subject.*&quot;),
                                tcSubject),
                        new ConditionalTemplateConfigurationFactory(
                                new FileNameGlobMatcher(&quot;*.body.*&quot;),
                                tcBody)
                        )
                        .noMatchErrorDetails(
                                &quot;Mail template names must contain \&quot;.subject.\&quot; or \&quot;.body.\&quot;!&quot;)
                ));</code></pre>
<p>The equivalent configuration using a Java <code>*.properties</code> file or other kind of string-string key value pairs (the <code>\</code>-s are prescribed by the Java Properties file format only):</p>
<pre><code>templateConfigurations = \
    ConditionalTemplateConfigurationFactory( \
        PathGlobMatcher(&quot;mail/**&quot;), \
        FirstMatchTemplateConfigurationFactory( \
            ConditionalTemplateConfigurationFactory( \
                FileNameGlobMatcher(&quot;*.subject.*&quot;), \
                TemplateConfiguration(outputFormat = PlainTextOutputFormat()) \
            ), \
            ConditionalTemplateConfigurationFactory( \
                FileNameGlobMatcher(&quot;*.body.*&quot;), \
                TemplateConfiguration(outputFormat = HTMLOutputFormat()) \
            ), \
            noMatchErrorDetails = &#39;Mail template names must contain &quot;.subject.&quot; or &quot;.body.&quot;!&#39; \
        ) \
    )</code></pre>
<p>Let's say you want the following deviations from the shared <code>Configuration</code> settings in your application:</p>
<ul>
<li><p>All templates whose name contains <code>&quot;.stats.&quot;</code> should use ISO date/time format and UTC time zone</p></li>
<li><p>All templates inside the <code>mail</code> directory should use UTF-8 encoding</p></li>
<li><p>Templates with <code>xml</code> file extension should use XML <code>output_format</code>, templates with <code>html</code> or <code>htm</code> extension should use HTML output format. For other templates, the shared <code>Configuration</code> can dictate the <code>output_format</code>.</p></li>
</ul>
<p>Here we have 3 independent concerns, and possibly multiple (or none) of those apply to a template; that's when you need a <code>MergingTemplateConfigurationFactory</code>. The last point describes a rule where you have mutually exclusive choices; that's when you need a <code>FirstMatchTemplateConfigurationFactory</code>, but this time no choice is also allowed. Here's the source code, assuming <code>cfg</code> stores the shared <code>Configuration</code> instance:</p>
<pre><code>TemplateConfiguration tcStats = new TemplateConfiguration();
tcStats.setDateTimeFormat(&quot;iso&quot;);
tcStats.setDateFormat(&quot;iso&quot;);
tcStats.setTimeFormat(&quot;iso&quot;);
tcStats.setTimeZone(DateUtil.UTC);

TemplateConfiguration tcMail = new TemplateConfiguration();
tcMail.setEncoding(&quot;utf-8&quot;);

TemplateConfiguration tcHTML = new TemplateConfiguration();
tcHTML.setOutputFormat(HTMLOutputFormat.INSTANCE);

TemplateConfiguration tcXML = new TemplateConfiguration();
tcXML.setOutputFormat(XMLOutputFormat.INSTANCE);

cfg.setTemplateConfigurations(
        new MergingTemplateConfigurationFactory(
                new ConditionalTemplateConfigurationFactory(
                        new FileNameGlobMatcher(&quot;*.stats.*&quot;),
                        tcStats),
                new ConditionalTemplateConfigurationFactory(
                        new PathGlobMatcher(&quot;mail/**&quot;),
                        tcMail),
                new FirstMatchTemplateConfigurationFactory(
                        new ConditionalTemplateConfigurationFactory(
                                new FileExtensionMatcher(&quot;xml&quot;),
                                tcXML),
                        new ConditionalTemplateConfigurationFactory(
                                new OrMatcher(
                                        new FileExtensionMatcher(&quot;html&quot;),
                                        new FileExtensionMatcher(&quot;htm&quot;)),
                                tcHTML)
                ).allowNoMatch(true)
        )
);</code></pre>
<p>The equivalent configuration using a Java <code>*.properties</code> file or other kind of string-string key value pairs (the <code>\</code>-s are prescribed by the Java Properties file format only):</p>
<pre><code>templateConfigurations = \
    MergingTemplateConfigurationFactory( \
        ConditionalTemplateConfigurationFactory( \
            FileNameGlobMatcher(&quot;*.stats.*&quot;), \
            TemplateConfiguration( \
                dateTimeFormat = &quot;iso&quot;, \
                dateFormat = &quot;iso&quot;, \
                timeFormat = &quot;iso&quot;, \
                timeZone = TimeZone(&quot;UTC&quot;) \
            ) \
        ), \
        ConditionalTemplateConfigurationFactory( \
            PathGlobMatcher(&quot;mail/**&quot;), \
            TemplateConfiguration(encoding = &quot;utf-8&quot;) \
        ), \
        FirstMatchTemplateConfigurationFactory( \
            ConditionalTemplateConfigurationFactory( \
                FileExtensionMatcher(&quot;xml&quot;), \
                TemplateConfiguration(outputFormat = XMLOutputFormat()) \
            ), \
            ConditionalTemplateConfigurationFactory( \
                OrMatcher( \
                    FileExtensionMatcher(&quot;html&quot;), \
                    FileExtensionMatcher(&quot;htm&quot;) \
                ), \
                TemplateConfiguration(outputFormat = HTMLOutputFormat()) \
            ), \
            allowNoMatch = true \
        ) \
    )</code></pre>
<h2 id="pgui_config_outputformatsautoesc">Associating output formats with templates</h2>
auto-escaping
output format
<p>The output format associated to a template decides if and what kind of auto-escaping is used in that template (unless the template <a href="#dgui_misc_autoescaping_overrideoformat">overrides that with directives</a>). By default, templates have “undefined” output format associated, which does no escaping, and in general gives the behavior that you would expect from a template engine that doesn't care about output formats and escaping. However, if the <code>recognize_standard_file_extensions</code> <a href="#pgui_config_settings">setting</a> is <code>true</code> (which is the default with <a href="#pgui_config_incompatible_improvements">the <code>incompatible_improvements</code> setting</a> set to 2.3.24 or higher), templates whose source name ends with <code>&quot;.ftlh&quot;</code> gets “HTML” output format, and those with <code>&quot;.ftlx&quot;</code> get “XML” output format. Using the <code>ftlh</code> and <code>ftlx</code> file extensions is the recommended way of activating HTML and XML auto-escaping. You can also associate output formats to templates based on arbitrary name patterns with the <a href="#pgui_config_templateconfigurations"><code>template_configurations</code> setting</a>; see some examples of that below.</p>
<p>There's another a related setting, called <code>auto_escaping_policy</code>, which can be used to disable auto-escaping even if the current output format supports it, or enable auto-escaping even if the format by default doesn't escape (but it supports it). Using this setting rarely advisable, as it's potentially confusing for the template authors. (Instead, escaping can be turned on/off explicitly inside the templates with the <code>auto_esc</code> parameter of the <a href="#ref_directive_ftl"><code>ftl</code> directive</a>, or with the <a href="#ref_directive_autoesc"><code>noautoesc</code></a> and <a href="#ref_directive_autoesc"><code>autoesc</code> directive</a>s.)</p>
<p>To check if you have configured FreeMarker properly, you can use this template:</p>
<pre><code>&lt;p&gt;Output format: ${.output_format}
&lt;p&gt;Auto-escaping: ${.auto_esc?c}</code></pre>
<p>See the <a href="#topic.predefinedOutputFormats">table of predefined output formats here...</a></p>
<p>Configuration examples:</p>
<ul>
<li><p>To enable automatic output format associations to <code>*.ftlh</code> and <code>*.ftlx</code>, either:</p>
<ul>
<li><p>Use <code>incompatible_improvements</code> 2.3.24 or higher; see <a href="#pgui_config_incompatible_improvements_how_to_set">how to set <code>incompatible_improvements</code></a></p></li>
<li><p>Or, enable standard file extension recognizing explicitly:</p>
<pre><code>// Where you initalize the Configuration singletion, add:
cfg.setRecognizeStandardFileExtensions(true);</code></pre>
<p>or if you configure FreeMarker with Java <code>*.properties</code> file:</p>
<pre><code>recognizeStandardFileExtensions = true</code></pre></li>
</ul></li>
<li><p>Let's say that you want to associate all templates in the <code>mail</code> directory to the HTML output format. You could achieve that like this (assuming that you are getting the templates with <code>cfg.getTemplate(...)</code>, and not instantiating them yourself):</p>
<pre><code>// Where you initalize the Configuration singletion, add:

TemplateConfiguration tcHTML = new TemplateConfiguration();
tcHTML.setOutputFormat(HTMLOutputFormat.INSTANCE);

cfg.setTemplateConfigurations(
        new ConditionalTemplateConfigurationFactory(
                new PathGlobMatcher(&quot;mail/**&quot;),
                tcHTML));</code></pre>
<p>or if you are configuring FreeMarker from Java <code>*.properties</code> file (the <code>\</code>-s are required for the Java Properties file format only):</p>
<pre><code>templateConfigurations = \
    ConditionalTemplateConfigurationFactory( \
        PathGlobMatcher(&quot;mail/**&quot;), \
        TemplateConfiguration(outputFormat = HTMLOutputFormat()))</code></pre></li>
<li><p>Let's say you want to associate templates with <code>xml</code> file extension to the XML output format, templates with <code>html</code> and <code>htm</code> extension to the HTML output format, and templates with <code>rtf</code> extension to the <code>RTF</code> output format. You could achieve that like this (assuming that you are getting the templates with <code>cfg.getTemplate(...)</code>, and not instantiating them yourself):</p>
<pre><code>TemplateConfiguration tcHTML = new TemplateConfiguration();
tcHTML.setOutputFormat(HTMLOutputFormat.INSTANCE);

TemplateConfiguration tcXML = new TemplateConfiguration();
tcXML.setOutputFormat(XMLOutputFormat.INSTANCE);

TemplateConfiguration tcRTF = new TemplateConfiguration();
tcRTF.setOutputFormat(RTFOutputFormat.INSTANCE);

cfg.setTemplateConfigurations(
        new FirstMatchTemplateConfigurationFactory(
                new ConditionalTemplateConfigurationFactory(
                        new FileExtensionMatcher(&quot;xml&quot;),
                        tcXML),
                new ConditionalTemplateConfigurationFactory(
                        new OrMatcher(
                                new FileExtensionMatcher(&quot;html&quot;),
                                new FileExtensionMatcher(&quot;htm&quot;)),
                        tcHTML),
                new ConditionalTemplateConfigurationFactory(
                        new FileExtensionMatcher(&quot;rtf&quot;),
                        tcRTF)
        ).allowNoMatch(true)
);</code></pre>
<p>or if you are configuring FreeMarker from Java <code>*.properties</code> file (the <code>\</code>-s are required for the Java Properties file format only):</p>
<pre><code>templateConfigurations = \
    FirstMatchTemplateConfigurationFactory( \
        ConditionalTemplateConfigurationFactory( \
            FileExtensionMatcher(&quot;xml&quot;), \
            TemplateConfiguration(outputFormat = XMLOutputFormat())), \
        ConditionalTemplateConfigurationFactory( \
            OrMatcher( \
                FileExtensionMatcher(&quot;html&quot;), \
                FileExtensionMatcher(&quot;htm&quot;)), \
            TemplateConfiguration(outputFormat = HTMLOutputFormat())), \
        ConditionalTemplateConfigurationFactory( \
            FileExtensionMatcher(&quot;rtf&quot;), \
            TemplateConfiguration(outputFormat = RTFOutputFormat())), \
        allowNoMatch = true)</code></pre></li>
</ul>
<p>(You can find some more complex <code>template_configurations</code> setups <a href="#pgui_config_templateconfigurations">here...</a>)</p>
<h2 id="pgui_config_custom_formats">Custom number and date/time formats</h2>
<h3>Overview</h3>
<p>FreeMarker allows you to define your own number and date/time/datetime formats, and associate a name to them. This mechanism has several applications:</p>
<ul>
<li><p>Custom formatter algorithms: You can use your own formatter algorithm instead of relying on those provided by FreeMarker. For this, implement <code>freemarker.core.TemplateNumberFormatFactory</code> or <code>freemarker.core.TemplateDateFormatFactory</code>. You will find a few examples of this <a href="#pgui_config_custom_formats_ex_cust_alg_simple">below</a>.</p></li>
<li><p>Aliasing: You can give application-specific names (like “price”, “weight”, “fileDate”, “logEventTime”, etc.) to other formats by using <code>AliasTemplateNumberFormatFactory</code> and <code>AliasTemplateDateFormatFactory</code>. Thus templates can just refer to that name, like in <code>${lastModified?string.@fileDate}</code>, instead of specifying the format directly. Thus the formats can be specified on a single central place (where you configure FreeMarker), instead of being specified repeatedly in templates. Also thus template authors don't have to enter complex and hard to remember formatting patterns. <a href="#pgui_config_custom_formats_ex_alias">See example below</a>.</p></li>
<li><p>Model-sensitive formatting: Applications can put custom <code>freemarker.TemplateModel</code>-s into the data-model instead of dropping plain values (like <code>int</code>-s, <code>double</code>-s, etc.) into it, to attach rendering-related information to the value. Custom formatters can utilize this information (for example, to show the unit after numbers), as they receive the <code>TemplateModel</code> itself, not the wrapped raw value. <a href="#pgui_config_custom_formats_ex_model_aware">See example below</a>.</p></li>
<li><p>Format that prints markup instead of plain text: You might want to use HTML tags (or other markup) in the formatted values, such as coloring negative numbers to red or using HTML <code>sup</code> element for exponents. This is possible if you write a custom format as shown in previous cases, but override the <code>format</code> method in the formatter class so that it returns a <code>TemplateMarkupOutputModel</code> instead of a <code>String</code>. (You shouldn't just return the markup as <code>String</code>, as then it might will be escaped; see <a href="#dgui_misc_autoescaping">auto-escaping</a>.)</p></li>
</ul>
<p>Custom formats can be registered with the <code>custom_number_formats</code> and <code>custom_date_formats</code> configuration settings. After that, anywhere where you can specify formats with a <code>String</code>, now you can refer to your custom format as <code>&quot;@name&quot;</code>. So for example, if you have registered your number format implementation with name <code>&quot;smart&quot;</code>, then you could set the <code>number_format</code> setting (<code>Configurable.setNumberFormat(String)</code>) to <code>&quot;@smart&quot;</code>, or issue <code>${n?string.@smart}</code> or <code>&lt;#setting
          number_format=&quot;@smart&quot;&gt;</code> in a template. Furthermore, you can define parameters for your custom format, like <code>&quot;@smart
          2&quot;</code>, and the interpretation of the parameters is up to your formatter implementation.</p>
<h3 id="pgui_config_custom_formats_ex_cust_alg_simple">Simple custom number format example</h3>
<p>This custom number format shows numbers in hexadecimal form:</p>
<pre><code>package com.example;

import java.util.Locale;

import freemarker.template.TemplateModelException;
import freemarker.template.TemplateNumberModel;
import freemarker.template.utility.NumberUtil;

public class HexTemplateNumberFormatFactory extends TemplateNumberFormatFactory {

    public static final HexTemplateNumberFormatFactory INSTANCE
            = new HexTemplateNumberFormatFactory();

    private HexTemplateNumberFormatFactory() {
        // Defined to decrease visibility
    }

    @Override
    public TemplateNumberFormat get(String params, Locale locale, Environment env)
            throws InvalidFormatParametersException {
        TemplateFormatUtil.checkHasNoParameters(params);
        return HexTemplateNumberFormat.INSTANCE;
    }

    private static class HexTemplateNumberFormat extends TemplateNumberFormat {

        private static final HexTemplateNumberFormat INSTANCE = new HexTemplateNumberFormat();

        private HexTemplateNumberFormat() { }

        @Override
        public String formatToPlainText(TemplateNumberModel numberModel)
                throws UnformattableValueException, TemplateModelException {
            Number n = TemplateFormatUtil.getNonNullNumber(numberModel);
            try {
                return Integer.toHexString(NumberUtil.toIntExact(n));
            } catch (ArithmeticException e) {
                throw new UnformattableValueException(n + &quot; doesn&#39;t fit into an int&quot;);
            }
        }

        @Override
        public boolean isLocaleBound() {
            return false;
        }

        @Override
        public String getDescription() {
            return &quot;hexadecimal int&quot;;
        }

    }

}</code></pre>
<p>We register the above format with name “hex”:</p>
<pre><code>// Where you initalize the application-wide Configuration singleton:
Configuration cfg = ...;
...
Map&lt;String, TemplateNumberFormatFactory&gt; customNumberFormats = ...;
...
customNumberFormats.put(&quot;hex&quot;, HexTemplateNumberFormatFactory.INSTANCE);
...
cfg.setCustomNumberFormats(customNumberFormats);</code></pre>
<p>Now we can use this format in templates:</p>
<pre><code>${x?string.@hex}</code></pre>
<p>or even set it as the default number format:</p>
<pre><code>cfg.setNumberFormat(&quot;@hex&quot;);</code></pre>
<h3 id="pgui_config_custom_formats_ex_cust_algo_advanced">Advanced custom number format example</h3>
<p>This is a more complex custom number format that shows how to deal with parameters in the format string, also how to delegate to another format:</p>
<pre><code>package com.example;

import java.util.Locale;

import freemarker.template.TemplateModelException;
import freemarker.template.TemplateNumberModel;
import freemarker.template.utility.NumberUtil;
import freemarker.template.utility.StringUtil;

/**
 * Shows a number in base N number system. Can only format numbers that fit into an {@code int},
 * however, optionally you can specify a fallback format. This format has one required parameter,
 * the numerical system base. That can be optionally followed by &quot;|&quot; and a fallback format.
 */
public class BaseNTemplateNumberFormatFactory extends TemplateNumberFormatFactory {

    public static final BaseNTemplateNumberFormatFactory INSTANCE
            = new BaseNTemplateNumberFormatFactory();

    private BaseNTemplateNumberFormatFactory() {
        // Defined to decrease visibility
    }

    @Override
    public TemplateNumberFormat get(String params, Locale locale, Environment env)
            throws InvalidFormatParametersException {
        TemplateNumberFormat fallbackFormat;
        {
            int barIdx = params.indexOf(&#39;|&#39;);
            if (barIdx != -1) {
                String fallbackFormatStr = params.substring(barIdx + 1);
                params = params.substring(0, barIdx);
                try {
                    fallbackFormat = env.getTemplateNumberFormat(fallbackFormatStr, locale);
                } catch (TemplateValueFormatException e) {
                    throw new InvalidFormatParametersException(
                            &quot;Couldn&#39;t get the fallback number format (specified after the \&quot;|\&quot;), &quot;
                            + StringUtil.jQuote(fallbackFormatStr) + &quot;. Reason: &quot; + e.getMessage(),
                            e);
                }
            } else {
                fallbackFormat = null;
            }
        }

        int base;
        try {
            base = Integer.parseInt(params);
        } catch (NumberFormatException e) {
            if (params.length() == 0) {
                throw new InvalidFormatParametersException(
                        &quot;A format parameter is required to specify the numerical system base.&quot;);
            }
            throw new InvalidFormatParametersException(
                    &quot;The format paramter must be an integer, but was (shown quoted): &quot;
                    + StringUtil.jQuote(params));
        }
        if (base &lt; 2) {
            throw new InvalidFormatParametersException(&quot;A base must be at least 2.&quot;);
        }
        return new BaseNTemplateNumberFormat(base, fallbackFormat);
    }

    private static class BaseNTemplateNumberFormat extends TemplateNumberFormat {

        private final int base;
        private final TemplateNumberFormat fallbackFormat;

        private BaseNTemplateNumberFormat(int base, TemplateNumberFormat fallbackFormat) {
            this.base = base;
            this.fallbackFormat = fallbackFormat;
        }

        @Override
        public String formatToPlainText(TemplateNumberModel numberModel)
                throws TemplateModelException, TemplateValueFormatException {
            Number n = TemplateFormatUtil.getNonNullNumber(numberModel);
            try {
                return Integer.toString(NumberUtil.toIntExact(n), base);
            } catch (ArithmeticException e) {
                if (fallbackFormat == null) {
                    throw new UnformattableValueException(
                            n + &quot; doesn&#39;t fit into an int, and there was no fallback format &quot;
                            + &quot;specified.&quot;);
                } else {
                    return fallbackFormat.formatToPlainText(numberModel);
                }
            }
        }

        @Override
        public boolean isLocaleBound() {
            return false;
        }

        @Override
        public String getDescription() {
            return &quot;base &quot; + base;
        }

    }

}</code></pre>
<p>We register the above format with name “base”:</p>
<pre><code>// Where you initalize the application-wide Configuration singleton:
Configuration cfg = ...;
...
Map&lt;String, TemplateNumberFormatFactory&gt; customNumberFormats = ...;
...
customNumberFormats.put(&quot;base&quot;, BaseNTemplateNumberFormatFactory.INSTANCE);
...
cfg.setCustomNumberFormats(customNumberFormats);</code></pre>
<p>Now we can use this format in templates:</p>
<pre><code>${x?string.@base_8}</code></pre>
<p>Above there the parameter string was <code>&quot;8&quot;</code>, as FreeMarker allows separating that from the format name with <code>_</code> instead of whitespace, so that you don't have to write the longer <code>n?string[&quot;@base 8&quot;]</code> form.</p>
<p>Of course, we could also set this as the default number format like:</p>
<pre><code>cfg.setNumberFormat(&quot;@base 8&quot;);</code></pre>
<p>Here's an example of using the a fallback number format (which is <code>&quot;0.0###&quot;</code>):</p>
<pre><code>cfg.setNumberFormat(&quot;@base 8|0.0###&quot;);</code></pre>
<p>Note that this functionality, with the <code>|</code> syntax and all, is purely implemented in the example code earlier.</p>
<h3 id="pgui_config_custom_formats_ex_cust_algo_date">Custom date/time format example</h3>
<p>This simple date format formats the date/time value to the milliseconds since the epoch:</p>
<pre><code>package com.example;

import java.util.Date;
import java.util.Locale;
import java.util.TimeZone;

import freemarker.template.TemplateDateModel;
import freemarker.template.TemplateModelException;

public class EpochMillisTemplateDateFormatFactory extends TemplateDateFormatFactory {

    public static final EpochMillisTemplateDateFormatFactory INSTANCE
            = new EpochMillisTemplateDateFormatFactory();

    private EpochMillisTemplateDateFormatFactory() {
        // Defined to decrease visibility
    }

    @Override
    public TemplateDateFormat get(String params, int dateType,
            Locale locale, TimeZone timeZone, boolean zonelessInput,
            Environment env)
            throws InvalidFormatParametersException {
        TemplateFormatUtil.checkHasNoParameters(params);
        return EpochMillisTemplateDateFormat.INSTANCE;
    }

    private static class EpochMillisTemplateDateFormat extends TemplateDateFormat {

        private static final EpochMillisTemplateDateFormat INSTANCE
                = new EpochMillisTemplateDateFormat();

        private EpochMillisTemplateDateFormat() { }

        @Override
        public String formatToPlainText(TemplateDateModel dateModel)
                throws UnformattableValueException, TemplateModelException {
            return String.valueOf(TemplateFormatUtil.getNonNullDate(dateModel).getTime());
        }

        @Override
        public boolean isLocaleBound() {
            return false;
        }

        @Override
        public boolean isTimeZoneBound() {
            return false;
        }

        @Override
        public Date parse(String s, int dateType) throws UnparsableValueException {
            try {
                return new Date(Long.parseLong(s));
            } catch (NumberFormatException e) {
                throw new UnparsableValueException(&quot;Malformed long&quot;);
            }
        }

        @Override
        public String getDescription() {
            return &quot;millis since the epoch&quot;;
        }

    }

}</code></pre>
<p>We register the above format with name “epoch”:</p>
<pre><code>// Where you initalize the application-wide Configuration singleton:
Configuration cfg = ...;
...
Map&lt;String, TemplateDateFormatFactory&gt; customDateFormats = ...;
...
customDateFormats.put(&quot;epoch&quot;, EpochMillisTemplateDateFormatFactory.INSTANCE);
...
cfg.setCustomDateFormats(customDateFormats);</code></pre>
<p>Now we can use this format in templates:</p>
<pre><code>${t?string.@epoch}</code></pre>
<p>Of course, we could also set this as the default date-time format like:</p>
<pre><code>cfg.setDateTimeFormat(&quot;@epoch&quot;);</code></pre>
<p>For a more complex that for example uses format parameters, refer to the <a href="#pgui_config_custom_formats_ex_cust_algo_advanced">advanced number format example</a>. Doing that with date formats is very similar.</p>
<h3 id="pgui_config_custom_formats_ex_alias">Alias format example</h3>
<p>In this example we specify some number formats and date formats that are aliases to another format:</p>
<pre><code>// Where you initalize the application-wide Configuration singleton:
Configuration cfg = ...;

Map&lt;String, TemplateNumberFormatFactory&gt; customNumberFormats
        = new HashMap&lt;String, TemplateNumberFormatFactory&gt;();
customNumberFormats.put(&quot;price&quot;, new AliasTemplateNumberFormatFactory(&quot;,000.00&quot;));
customNumberFormats.put(&quot;weight&quot;,
        new AliasTemplateNumberFormatFactory(&quot;0.##;; roundingMode=halfUp&quot;));
cfg.setCustomNumberFormats(customNumberFormats);

Map&lt;String, TemplateDateFormatFactory&gt; customDateFormats
        = new HashMap&lt;String, TemplateDateFormatFactory&gt;();
customDateFormats.put(&quot;fileDate&quot;, new AliasTemplateDateFormatFactory(&quot;dd/MMM/yy hh:mm a&quot;));
customDateFormats.put(&quot;logEventTime&quot;, new AliasTemplateDateFormatFactory(&quot;iso ms u&quot;));
cfg.setCustomDateFormats(customDateFormats);</code></pre>
<p>So now you can do this in a template:</p>
<pre><code>${product.price?string.@price}
${product.weight?string.@weight}
${lastModified?string.@fileDate}
${lastError.timestamp?string.@logEventTime}</code></pre>
<p>Note that the constructor parameter of <code>AliasTemplateNumberFormatFactory</code> can naturally refer to a custom format too:</p>
<pre><code>Map&lt;String, TemplateNumberFormatFactory&gt; customNumberFormats
        = new HashMap&lt;String, TemplateNumberFormatFactory&gt;();
customNumberFormats.put(&quot;base&quot;, BaseNTemplateNumberFormatFactory.INSTANCE);
customNumberFormats.put(&quot;oct&quot;, new AliasTemplateNumberFormatFactory(&quot;@base 8&quot;));
cfg.setCustomNumberFormats(customNumberFormats);</code></pre>
<p>So now <code>n?string.@oct</code> will format the number to octal form.</p>
<h3 id="pgui_config_custom_formats_ex_model_aware">Model-aware format example</h3>
<p>In this example we specify a number format that automatically show the unit after the number if that was put into the data-model as <code>UnitAwareTemplateNumberModel</code>. First let's see <code>UnitAwareTemplateNumberModel</code>:</p>
<pre><code>package com.example;

import freemarker.template.TemplateModelException;
import freemarker.template.TemplateNumberModel;

public class UnitAwareTemplateNumberModel implements TemplateNumberModel {

    private final Number value;
    private final String unit;

    public UnitAwareTemplateNumberModel(Number value, String unit) {
        this.value = value;
        this.unit = unit;
    }

    @Override
    public Number getAsNumber() throws TemplateModelException {
        return value;
    }

    public String getUnit() {
        return unit;
    }

}</code></pre>
<p>When you fill the data-model, you could do something like this:</p>
<pre><code>Map&lt;String, Object&gt; dataModel = new HashMap&lt;&gt;();
dataModel.put(&quot;weight&quot;, new UnitAwareTemplateNumberModel(1.5, &quot;kg&quot;));
// Rather than just: dataModel.put(&quot;weight&quot;, 1.5);</code></pre>
<p>Then if we have this in the template:</p>
<pre><code>${weight}</code></pre>
<p>we want to see this:</p>
<pre><code>1.5 kg</code></pre>
<p>To achieve that, we define this custom number format:</p>
<pre><code>package com.example;

import java.util.Locale;

import freemarker.core.Environment;
import freemarker.core.TemplateNumberFormat;
import freemarker.core.TemplateNumberFormatFactory;
import freemarker.core.TemplateValueFormatException;
import freemarker.template.TemplateModelException;
import freemarker.template.TemplateNumberModel;

/**
 * A number format that takes any other number format as parameter (specified as a string, as
 * usual in FreeMarker), then if the model is a {@link UnitAwareTemplateNumberModel}, it  shows
 * the unit after the number formatted with the other format, otherwise it just shows the formatted
 * number without unit.
 */
public class UnitAwareTemplateNumberFormatFactory extends TemplateNumberFormatFactory {

    public static final UnitAwareTemplateNumberFormatFactory INSTANCE
            = new UnitAwareTemplateNumberFormatFactory();

    private UnitAwareTemplateNumberFormatFactory() {
        // Defined to decrease visibility
    }

    @Override
    public TemplateNumberFormat get(String params, Locale locale, Environment env)
            throws TemplateValueFormatException {
        return new UnitAwareNumberFormat(env.getTemplateNumberFormat(params, locale));
    }

    private static class UnitAwareNumberFormat extends TemplateNumberFormat {

        private final TemplateNumberFormat innerFormat;

        private UnitAwareNumberFormat(TemplateNumberFormat innerFormat) {
            this.innerFormat = innerFormat;
        }

        @Override
        public String formatToPlainText(TemplateNumberModel numberModel)
                throws TemplateModelException, TemplateValueFormatException {
            String innerResult = innerFormat.formatToPlainText(numberModel);
            return numberModel instanceof UnitAwareTemplateNumberModel
                    ? innerResult + &quot; &quot; + ((UnitAwareTemplateNumberModel) numberModel).getUnit()
                    : innerResult;
        }

        @Override
        public boolean isLocaleBound() {
            return innerFormat.isLocaleBound();
        }

        @Override
        public String getDescription() {
            return &quot;unit-aware &quot; + innerFormat.getDescription();
        }

    }

}</code></pre>
<p>Finally, we set the above custom format as the default number format:</p>
<pre><code>// Where you initalize the application-wide Configuration singleton:
Configuration cfg = ...;

Map&lt;String, TemplateNumberFormatFactory&gt; customNumberFormats = new HashMap&lt;&gt;();
customNumberFormats.put(&quot;ua&quot;, UnitAwareTemplateNumberFormatFactory.INSTANCE);
cfg.setCustomNumberFormats(customNumberFormats);

// Note: &quot;0.####;; roundingMode=halfUp&quot; is a standard format specified in FreeMarker.
cfg.setNumberFormat(&quot;@ua 0.####;; roundingMode=halfUp&quot;);</code></pre>
<h2 id="pgui_config_incompatible_improvements">The &quot;incompatible improvements&quot; setting</h2>
incompatible improvements
incompatible_improvements
incompatibleImprovements
backward compatibility
<h3>What does it do</h3>
<p>This setting specifies the FreeMarker version number where the not 100% backward compatible bug fixes and improvements <em>that you want to enable</em> were already implemented. Usually, it's a bad idea to left it on its default, which is 2.3.0 (maximum backward compatibility).</p>
<p>In new projects you should set this to the FreeMarker version that you are actually using. In older projects it's also usually better to keep this high, however you better check the changes activated (find them in <a href="http://freemarker.org/docs/api/freemarker/template/Configuration.html#Configuration-freemarker.template.Version-">the API JavaDoc of the <code>Configuration(Version)</code> constructor</a>), at least if not only the 3rd version number (the micro version) of “incompatible improvements” setting is increased. Generally, as far as you only increase the last version number of this setting, the changes are low risk.</p>
<p>Bug fixes and improvements that are fully backward compatible, also those that are important security fixes, are enabled regardless of the “incompatible improvements” setting.</p>
<p>An important consequence of setting this setting is that now your application will check if the stated minimum FreeMarker version requirement is met. Like if you set this setting to 2.3.22, but accidentally the application is deployed with FreeMarker 2.3.21, then FreeMarker will fail, telling that a higher version is required. After all, the fixes/improvements you have requested aren't available on a lower version.</p>
<h3 id="pgui_config_incompatible_improvements_how_to_set">How to set it</h3>
<p>The incompatible improvements setting exists on the <code>Configuration</code> level. It can be set on multiple ways:</p>
<ul>
<li><p>Create the <code>freemarker.template.Configuration</code> object like:</p>
<pre><code>... = new Configuration(Configuration.VERSION_2_3_27)</code></pre></li>
<li><p>Or, alter the <code>Configuration</code> singleton where you initialize its other settings like:</p>
<pre><code>cfg.setIncompatibleImprovements(Configuration.VERSION_2_3_27)</code></pre></li>
<li><p>Or, if you are configuring FreeMarker with properties (<code>*.properties</code> file or <code>java.util.Properties</code> object), add:</p>
<pre><code>incompatible_improvements=2.3.27</code></pre></li>
<li><p>Or, if you are configuring FreeMarker through <code>FreemarkerServlet</code>, add this <code>init-param</code> to it in the <code>web.xml</code>:</p>
<pre><code>&lt;init-param&gt;
    &lt;param-name&gt;incompatible_improvements&lt;/param-name&gt;
    &lt;param-value&gt;2.3.27&lt;/param-value&gt;
&lt;/init-param&gt;</code></pre></li>
</ul>
<p>But, <em>if you set the <code>object_wrapper</code> setting</em> (same as <code>Configuration.setObjectWrapper(ObjectWrapper)</code>) of your configuration, then it's important to know that <code>BeansWrapper</code> and its subclasses (most importantly, <code>DefaultObjectWrapper</code>) has its own independent <code>incompatibleImprovements</code> property, and some fixes/improvements are activated by that, not by <code>Configuration</code>'s similar setting. You don't have to be aware of this complication if you aren't setting the <code>object_wrapper</code> configuration setting anywhere, because the default <code>object_wrapper</code> has the same “incompatible improvements” as of the <code>Configuration</code>. But if you are setting the <code>object_wrapper</code>, then you must not forget to set the <code>incompatibleImprovements</code> property of the <code>ObjectWrapper</code> itself, in additionally to that of the <code>Configuration</code>. (Note that it's fine to have different “incompatible improvements” for the <code>Configuration</code> and for the <code>ObjectWrapper</code>, only it should be a conscious decision.) <a href="#topic.setDefaultObjectWrapperIcIIndividually">See here how to set it</a> in the case of <code>DefaultObjectWrapper</code> (for <code>BeansWrapper</code> it's the same, only with different class name of course).</p>
<h1 id="pgui_misc">Miscellaneous</h1>
<p>This is just an introductory guide. See the FreeMarker Java API documentation for the details.</p>
<h2 id="pgui_misc_var">Variables, scopes</h2>
variables
variable scopes
scopes
<p>This chapter explains what happens when a template tries to access a variable, and how the variables are stored.</p>
<p>When you call <code>Template.process</code> it will internally create an <code>Environment</code> object that will be in use until <code>process</code> returns. This object stores the runtime state of template processing. Among other things, it stores the variables created by the template with directives like <code>assign</code>, <code>macro</code>, <code>local</code> or <code>global</code>. It never tries to modify the data-model object that you pass to the <code>process</code> call, nor does it create or replace shared variables stored in the configuration.</p>
<p>When you try to read a variable, FreeMarker will seek the variable in this order, and stops when it finds a variable with the right name:</p>
<ol type="1">
<li><p>In the Environment:</p>
<ol type="1">
<li><p>If you are in a loop, in the set of loop variables. Loop variables are the variables created by directives like <code>list</code>.</p></li>
<li><p>If you are inside a macro, in the local variable set of the macro. Local variables can be created with the <code>local</code> directive. Also, the parameters of macros are local variables.</p></li>
<li><p>In the current <a href="#dgui_misc_namespace">namespace</a>. You can put variables into a namespace with the <code>assign</code> directive.</p></li>
<li><p>In the set of variables created with <code>global</code> directive. FTL handles these variables as if they were normal members of the data-model. That is, they are visible in all namespaces, and you can access them as if they would be in the data-model.</p></li>
</ol></li>
<li><p>In the data-model object you have passed to the <code>process</code> method</p></li>
<li><p>In the set of shared variables stored in the <code>Configuration</code></p></li>
</ol>
<p>In practice, from the viewpoint of template authors these 6 layers are only 4 layers, since from that viewpoint the last 3 layers (variables created with <code>global</code>, the actual data-model object, shared variables) together constitute the set of global variables.</p>
<p>Note that it is possible to get variables from a specific layer in FTL with <a href="#ref_specvar">special variables</a>.</p>
<h2 id="pgui_misc_charset">Charset issues</h2>
charset
encoding
<p>FreeMarker, as most Java applications, works with &quot;<a href="#gloss.unicode">UNICODE</a> text&quot; (UTF-16). Nonetheless, there are situations when it must deal with <a href="#gloss.charset">charsets</a>, because it has to exchange data with the outer world that may uses various other charsets.</p>
<h3>The charset of the input</h3>
<p>When FreeMarker has to load a template file (or an unparsed text file), then it must know the charset of the file, since files are just raw byte sequences. You can use the <code>encoding</code> <a href="#pgui_config_settings">setting</a> to specify the charset. This setting takes effect only when FreeMarker loads a template (parsed or unparsed) with the <code>getTemplate</code> method of <code>Configuration</code>. Note that the <a href="#ref.directive.include"><code>include</code> directive</a> uses this method internally, so the value of the <code>encoding</code> setting is significant for an already loaded template if the template contains <code>include</code> directive call.</p>
<p>The getter and setter method of the <code>encoding</code> setting is special in the first (configuration) layer. The getter method guesses the return value based on a <code>Locale</code> passed as parameter; it looks up the encoding in a table that maps locales to encodings (called encoding map), and if the locale was not found there, it returns the default encoding. You can fill the encoding map with the <code>setEncoding(Locale locale, String encoding)</code> method of the configuration; the encoding map is initially empty. The default encoding is initially the value of the <code>file.encoding</code> system property, but you always should set a default default with the <code>setDefaultEncoding</code> method, rather than relying on that. For new projects, a popular default encoding is <code>utf-8</code>.</p>
<p>You can give the charset directly by overriding the <code>encoding</code> setting in the template layer or runtime environment layer (When you specify an encoding as the parameter of <code>getTemplate</code> method, you override the <code>encoding</code> setting in the template layer.). If you don't override it, the effective value will be what the <code>configuration.getEncoding(Locale)</code> method returns for the effective value of the <code>locale</code> setting.</p>
<p>Also, instead of relying on this charset guessing mechanism, you can specify the charset of the template in the template file itself, with the <a href="#ref.directive.ftl"><a href="#ref.directive.ftl"><code>ftl</code></a> directive</a>, like <code>&lt;#ftl
          encoding=&quot;utf-8&quot;&gt;</code>.</p>
<p>Note that the charset of the template is independent from the charset of the output that the tempalte generates (unless the enclosing software deliberately sets the output charset to the same as the template charset).</p>
<h3>The charset of the output</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>The <code>output_encoding</code> setting/variable and the <a href="#ref_builtin_url"><code>url</code> built-in</a> is available since FreeMarker 2.3.1. It doesn't exist in 2.3.</p>
</blockquote>
<p>output encodingoutput charsetIn principle FreeMarker does not deal with the charset of the output, since it writes the output to a <code>java.io.Writer</code>. Since the <code>Writer</code> is made by the software that encapsulates FreeMarker (such as a Web application framework), the output charset is controlled by the encapsulating software. Still, FreeMarker has a setting called <code>output_encoding</code> (starting from FreeMarker version 2.3.1). The enclosing software should set this setting (to the charset that the <code>Writer</code> uses), to inform FreeMarker what charset is used for the output (otherwise FreeMarker can't find it out). Some features, such as the <a href="#ref_builtin_url"><code>url</code> built-in</a>, and the <a href="#ref_specvar"><code>output_encoding</code> special variable</a> utilize this information. Thus, if the enclosing software doesn't set this setting then FreeMarker features that need to know the output charset can't be used.</p>
<p>If you write software that will use FreeMarker, you may wonder what output charset should you choose. Of course it depends on the consumer of the FreeMarker output, but if the consumer is flexible regarding this question, then the common practice is either using the charset of the template file for the output, or using UTF-8. Using UTF-8 is usually a better practice, because arbitrary text may comes from the data-model, which then possibly contains characters that couldn't be encoded with the charset of the template.</p>
<p>FreeMarker settings can be set for each individual template processing if you use <code>Template.createProcessingEnvironment(...)</code> plus <code>Environment.process(...)</code> instead of <code>Template.process(...)</code>. Thus, you can set the <code>output_encoding</code> setting for each template execution independently:</p>
<pre><code>Writer w = new OutputStreamWriter(out, outputCharset);
Environment env = template.createProcessingEnvironment(dataModel, w);
env.setOutputEncoding(outputCharset);
env.process();</code></pre>
<h2 id="pgui_misc_multithreading">Multithreading</h2>
multithreading
thread-safety
<p>In a multithreaded environment <code>Configuration</code> instances, <code>Template</code> instances and data-models should be handled as immutable (read-only) objects. That is, you create and initialize them (for example with <code>set...</code> methods), and then you don't modify them later (e.g. you don't call <code>set...</code>). This allows us to avoid expensive synchronized blocks in a multithreaded environment. Beware with <code>Template</code> instances; when you get a <code>Template</code> instance with <code>Configuration.getTemplate</code>, you may get an instance from the template cache that is already used by other threads, so do not call its <code>set...</code> methods (calling <code>process</code> is of course fine).</p>
<p>The above restrictions do not apply if you access all objects from the <em>same</em> single thread only.</p>
<p>It is impossible to modify the data-model object or a <a href="#pgui_config_sharedvariables">shared variable</a> with FTL, unless you put methods (or other objects) into the data-model that do that. We discourage you from writing methods that modify the data-model object or the shared variables. Try to use variables that are stored in the environment object instead (this object is created for a single <code>Template.process</code> call to store the runtime state of processing), so you don't modify data that are possibly used by multiple threads. For more information read: <a href="#pgui_misc_var">section_title</a></p>
<h2 id="pgui_misc_beanwrapper">Bean wrapper</h2>
wrapping
reflection
wrapping
beans
beans
wrapping
BeansWrapper
<blockquote>
<p><strong>Note</strong></p>
<p>Using <code>BeansWrapper</code> directly is not recommended anymore. Use its subclass, <code>DefaultObjectWrapper</code> instead, though by ensuring that its <code>incompatibleImprovements</code> property is at least 2.3.22. <code>DefaultObjectWrapper</code> gives cleaner data-model (less confusing multi-type FTL values) and is usually faster. <a href="#pgui_datamodel_defaultObjectWrapper">See more about DefaultObjectWrapper here...</a></p>
</blockquote>
<p>The <code>freemarker.ext.beans.BeansWrapper</code> is an <a href="#pgui_datamodel_objectWrapper">object wrapper</a> that was originally added to FreeMarker so arbitrary POJO-s (Plain Old Java Objects) can be wrapped into <code>TemplateModel</code> interfaces. Since then it has became the normal way of doing things, and in fact the <code>DefaultObjectWrapper</code> itself is a <code>BeansWrapper</code> extension. So everything described here goes for the <code>DefaultObjectWrapper</code> too, except that the <code>DefaultObjectWrapper</code> will wrap <code>String</code>, <code>Number</code>, <code>Date</code>, <code>array</code>, <code>Collection</code> (like <code>List</code>), <code>Map</code>, <code>Boolean</code> and <code>Iterator</code> objects with the <code>freemarker.template.SimpleXxx</code> classes, and W3C DOM nodes with <code>freemarker.ext.dom.NodeModel</code> (<a href="#xgui">more about wrapped W3C DOM...</a>), so for those the above described rules doesn't apply.</p>
<p>You will want to use <code>BeansWrapper</code> instead of <code>DefaultObjectWrapper</code> when any of these stands:</p>
<ul>
<li><p>The <code>Collection</code>-s and <code>Map</code>-s of the model should be allowed to be modified during template execution. (<code>DefaultObjectWrapper</code> prevents that, since it creates a copy of the collections when they are wrapped, and the copies will be read-only.)</p></li>
<li><p>If the identity of the <code>array</code>, <code>Collection</code> and <code>Map</code> objects must be kept when they are passed to a wrapped object's method in the template. That is, if those methods must get exactly the same object that was earlier wrapped.</p></li>
<li><p>If the Java API of the earlier listed classes (<code>String</code>, <code>Map</code>, <code>List</code> ...etc) should be visible for the templates. Even with <code>BeansWrapper</code>, they are not visible by default, but it can be achieved by setting the exposure level (see later). Note that this is usually a bad practice; try to use <a href="#ref_builtins">the built-ins</a> (like <code>foo?size</code>, <code>foo?upper_case</code>, <code>foo?replace('_', '-')</code> ...etc) instead of the Java API.</p></li>
</ul>
<p>Below is a summary of the <code>TemplateModel</code>-s that the <code>BeansWrapper</code> creates. Let's assume that the object is called <code>obj</code> before wrapping, and <code>model</code> after wrapping for the sake of the following discussion.</p>
<h3 id="beanswrapper_hash">TemplateHashModel functionality</h3>
<p>Every object will be wrapped into a <code>TemplateHashModel</code> that will expose JavaBeans properties and methods of the object. This way, you can use <code>model.foo</code> in the template to invoke <code>obj.getFoo()</code> or <code>obj.isFoo()</code> methods. (Note that public fields are not visible directly; you must write a getter method for them.) Public methods are also retrievable through the hash model as template method models, therefore you can use the <code>model.doBar()</code> to invoke <code>object.doBar()</code>. More on this on discussion of method model functionality.</p>
<p>If the requested key can not be mapped to a bean property or method, the framework will attempt to locate the so-called &quot;generic get method&quot;, that is a method with signature public <code>any-return-type
          get(String)</code> or public <code>any-return-type
          get(Object)</code> and invoke that method with the requested key. Note that this allows convenient access to mappings in a <code>java.util.Map</code> and similar classes - as long as the keys of the map are <code>String</code>s and some property or method name does not shadow the mapping. (There is a solution to avoid shadowing, read on.) Also note that the models for <code>java.util.ResourceBundle</code> objects use the <code>getObject(String)</code> as the generic get method.</p>
<p>If you call <code>setExposeFields(true)</code> on a <code>BeansWrapper</code> instance, it will also expose public, non-static fields of classes as hash keys and values. I.e. if <code>foo</code> is a public, non-static field of the class <code>Bar</code>, and <code>bar</code> is a template variable wrapping an instance of <code>Bar</code>, then <code>bar.foo</code> expression will evaluate as the value of the field <code>foo</code> of the <code>bar</code> object. The public fields in all superclasses of the class are also exposed.</p>
<h3>A word on security</h3>
<p>By default, you will not be able to access several methods that are considered not safe for templating. For instance, you can't use synchronization methods (<code>wait</code>, <code>notify</code>, <code>notifyAll</code>), thread and thread group management methods (<code>stop</code>, <code>suspend</code>, <code>resume</code>, <code>setDaemon</code>, <code>setPriority</code>), reflection (<code>Field</code> <code>setXxx</code> methods, <code>Method.invoke</code>, <code>Constructor.newInstance</code>, <code>Class.newInstance</code>, <code>Class.getClassLoader</code> etc.) and various dangerous methods in <code>System</code> and <code>Runtime</code> classes (<code>exec</code>, <code>exit</code>, <code>halt</code>, <code>load</code>, etc.). The <code>BeansWrapper</code> has several security levels (called &quot;levels of method exposure&quot;), and the default called <code>EXPOSE_SAFE</code> is probably suited for most applications. There is a no-safeguard level called <code>EXPOSE_ALL</code> that allows you to call even the above unsafe methods, and a strict level <code>EXPOSE_PROPERTIES_ONLY</code> that will expose only bean property getters. Finally, there is a level named <code>EXPOSE_NOTHING</code> that will expose no properties and no methods. The only data you will be able to access through hash model interface in this case are items in maps and resource bundles, as well as objects returned from a call to generic <code>get(Object)</code> or <code>get(String)</code> methods - provided the affected objects have such method.</p>
<h3>TemplateScalarModel functionality</h3>
<p>Models for <code>java.lang.String</code> objects will implement <code>TemplateScalarModel</code> whose <code>getAsString()</code> method simply delegates to <code>toString()</code>. Note that wrapping <code>String</code> objects into Bean wrappers provides much more functionality than just them being scalars: because of the hash interface described above, the models that wrap <code>String</code>s also provide access to all <code>String</code> methods (<code>indexOf</code>, <code>substring</code>, etc.), though most of them has native FreeMarker equivalent which are better to use (<code>s?index_of(n)</code>, <code>s[start..&lt;end]</code>, etc).</p>
<h3>TemplateNumberModel functionality</h3>
<p>Model wrappers for objects that are instances of <code>java.lang.Number</code> implement <code>TemplateNumberModel</code> whose <code>getAsNumber()</code> method returns the wrapped number object. Note that wrapping <code>Number</code> objects into Bean wrappers provides much more functionality than just them being number models: because of the hash interface described above, the models that wrap <code>Number</code>s also provide access to all their methods.</p>
<h3>TemplateCollectionModel functionality</h3>
<p>Model wrappers for native Java arrays and all classes that implement <code>java.util.Collection</code> will implement <code>TemplateCollectionModel</code> and thus gain the additional capability of being usable through <code>list</code> directive.</p>
<h3>TemplateSequenceModel functionality</h3>
<p>Model wrappers for native Java arrays and all classes that implement <code>java.util.List</code> will implement <code>TemplateSequenceModel</code> and thus their elements will be accessible by index using the <code>model[i]</code> syntax. You can also query the length of the array or the size of the list using the <code>model?size</code> built-in.</p>
<p>Also, every method that takes a single parameter that is assignable through reflective method invocation from a <code>java.lang.Integer</code> (these are <code>int</code>, <code>long</code>, <code>float</code>, <code>double</code>, <code>java.lang.Object</code>, <code>java.lang.Number</code>, and <code>java.lang.Integer</code>) also implements this interface. What this means is that you have a convenient way for accessing the so-called indexed bean properties: <code>model.foo[i]</code> will translate into <code>obj.getFoo(i)</code>.</p>
<h3 id="beanswrapper_method">TemplateMethodModel functionality</h3>
<p>All methods of an object are represented as <code>TemplateMethodModelEx</code> objects accessible using a hash key with method name on their object's model. When you call a method using <code>model.method(arg1,
          arg2,
          ...)</code> the arguments are passed to the method as template models. The method will first try to unwrap them - see below for details about unwrapping. These unwrapped arguments are then used for the actual method call. In case the method is overloaded, the most specific method will be selected using the same rules that are used by the Java compiler to select a method from several overloaded methods. In case that no method signature matches the passed parameters, or that no method can be chosen without ambiguity, a <code>TemplateModelException</code> is thrown.</p>
<p>Methods of return type <code>void</code> return <code>TemplateModel.NOTHING</code>, so they can be safely called with the <code>${obj.method(args)}</code> syntax.</p>
<p>Models for instances of <code>java.util.Map</code> also implement <code>TemplateMethodModelEx</code> as a means for invoking their <code>get()</code> method. As it was discussed previously, you can use the hash functionality to access the &quot;get&quot; method as well, but it has several drawbacks: it's slower because first property and method names are checked for the key; keys that conflict with property and method names will be shadowed by them; finally you can use <code>String</code> keys only with that approach. In contrast, invoking <code>model(key)</code> translates to <code>model.get(key)</code> directly: it's faster because there's no property and method name lookup; it is subject to no shadowing; and finally it works for non-String keys since the argument is unwrapped just as with ordinary method calls. In effect, <code>model(key)</code> on a <code>Map</code> is equal to <code>model.get(key)</code>, only shorter to write.</p>
<p>Models for <code>java.util.ResourceBundle</code> also implement <code>TemplateMethodModelEx</code> as a convenient way of resource access and message formatting. A single-argument call to a bundle will retrieve the resource with the name that corresponds to the <code>toString()</code> value of the unwrapped argument. A multiple-argument call to a bundle will also retrieve the resource with the name that corresponds to the <code>toString()</code> value of the unwrapped argument, but it will use it as a format pattern and pass it to <code>java.text.MessageFormat</code> using the unwrapped values of second and later arguments as formatting parameters. <code>MessageFormat</code> objects will be initialized with the locale of the bundle that originated them.</p>
<h3>Unwrapping rules</h3>
<p>When invoking a Java method from a template, its arguments need to be converted from template models back to Java objects. Assuming that the target type (the declared type of the method's formal parameter) is denoted as <code>T</code>, the following rules are tried in the following order:</p>
<ul>
<li><p>If the model is the null model for this wrapper, Java <code>null</code> is returned.</p></li>
<li><p>If the model implements <code>AdapterTemplateModel</code>, the result of <code>model.getAdaptedObject(T)</code> is returned if it is instance of <code>T</code> or it is a number and can be converted to <code>T</code> using numeric coercion as described three bullets lower. All models created by the BeansWrapper are themselves AdapterTemplateModel implementations, so unwrapping a model that was created by BeansWrapper for an underlying Java object always yields the original Java object.</p></li>
<li><p>If the model implements the deprecated <code>WrapperTemplateModel</code>, the result of <code>model.getWrappedObject()</code> is returned if it is instance of <code>T</code> or it is a number and can be converted to <code>T</code> using numeric coercion as described two bullets lower.</p></li>
<li><p>If <code>T</code> is <code>java.lang.String</code>, then if model implements <code>TemplateScalarModel</code> its string value is returned. Note that if the model doesn't implement TemplateScalarModel we don't attempt to automatically convert the model to string using String.valueOf(model). You'll have to use the ?string built-in explicitly to pass non-scalars as strings.</p></li>
<li><p>If <code>T</code> is a primitive numeric type or <code>java.lang.Number</code> is assignable from <code>T</code>, and model implements <code>TemplateNumberModel</code>, then its numeric value is returned if it is instance of <code>T</code> or its boxing type (if <code>T</code> is primitive type). Otherwise, if <code>T</code> is a built-in Java numeric type (primitive type or a standard subclass of <code>java.lang.Number</code>, including <code>BigInteger</code> and <code>BigDecimal</code>) a new object of class <code>T</code> or its boxing type is created with the number model's appropriately coerced value.</p></li>
<li><p>If <code>T</code> is <code>boolean</code> or <code>java.lang.Boolean</code>, and model implements <code>TemplateBooleanModel</code>, then its boolean value is returned.</p></li>
<li><p>If <code>T</code> is <code>java.util.Map</code> and the model implements <code>TemplateHashModel</code>, then a special Map representation of the hash model is returned.</p></li>
<li><p>If <code>T</code> is <code>java.util.List</code> and the model implements <code>TemplateSequenceModel</code>, then a special List representation of the sequence model is returned.</p></li>
<li><p>If <code>T</code> is <code>java.util.Set</code> and the model implements <code>TemplateCollectionModel</code>, then a special Set representation of the collection model is returned.</p></li>
<li><p>If <code>T</code> is <code>java.util.Collection</code> or <code>java.lang.Iterable</code> and the model implements either <code>TemplateCollectionModel</code> or <code>TemplateSequenceModel</code>, then a special Set or List representation of the collection or sequence model (respectively) is returned.</p></li>
<li><p>If <code>T</code> is a Java array type and the model implements <code>TemplateSequenceModel</code>, then a new array of the specified type is created and its elements unwrapped into the array recursively using the array's component type as <code>T</code>.</p></li>
<li><p>If <code>T</code> is <code>char</code> or <code>java.lang.Character</code>, and model implements <code>TemplateScalarModel</code>, and its string representation contains exactly one character, then a <code>java.lang.Character</code> with that value is retured.</p></li>
<li><p>If <code>java.util.Date</code> is assignable from <code>T</code>, and model implements <code>TemplateDateModel</code>, and its date value is instance of <code>T</code>, then its date value is returned.</p></li>
<li><p>If model is a number model, and its numeric value is instance of <code>T</code>, the numeric value is returned. You can have a custom subclass of java.lang.Number that implements a custom interface, and T might be that interface. (*)</p></li>
<li><p>If model is a date model, and its date value is instance of <code>T</code>, the date value is returned. Similar consideration as for (*)</p></li>
<li><p>If model is a scalar model, and <code>T</code> is assignable from <code>java.lang.String</code>, the string value is returned. This covers cases when T is java.lang.Object, java.lang.Comparable, and java.io.Serializable (**)</p></li>
<li><p>If model is a boolean model, and <code>T</code> is assignable from <code>java.lang.Boolean</code>, the boolean value is returned. Same as (**)</p></li>
<li><p>If model is a hash model, and <code>T</code> is assignable from <code>freemarker.ext.beans.HashAdapter</code>, a hash adapter is returned. Same as (**)</p></li>
<li><p>If model is a sequence model, and <code>T</code> is assignable from <code>freemarker.ext.beans.SequenceAdapter</code>, a sequence adapter is returned. Same as (**)</p></li>
<li><p>If model is a collection model, and <code>T</code> is assignable from <code>freemarker.ext.beans.SetAdapter</code>, a set adapter for the collection is returned. Same as (**)</p></li>
<li><p>If the model is instance of <code>T</code>, the model itself is returned. This covers the case where the method explicitly declared a FreeMarker-specific model interface, as well as allows returning directive, method and transform models when java.lang.Object is requested.</p></li>
<li><p>An exception signifying no conversion is possible is thrown.</p></li>
</ul>
<h3>Accessing static methods</h3>
static method
accessing from templates
<p>The <code>TemplateHashModel</code> returned from <code>BeansWrapper.getStaticModels()</code> can be used to create hash models for accessing static methods and fields of an arbitrary class.</p>
<pre><code>BeansWrapper wrapper = BeansWrapper.getDefaultInstance();
TemplateHashModel staticModels = wrapper.getStaticModels();
TemplateHashModel fileStatics =
    (TemplateHashModel) staticModels.get(&quot;java.io.File&quot;);</code></pre>
<p>And you will get a template hash model that exposes all static methods and static fields (both final and non-final) of the <code>java.lang.System</code> class as hash keys. Suppose that you put the previous model in your root model:</p>
<pre><code>root.put(&quot;File&quot;, fileStatics);</code></pre>
<p>From now on, you can use <code>${File.SEPARATOR}</code> to insert the file separator character into your template, or you can even list all roots of your file system by:</p>
<pre><code>&lt;#list File.listRoots() as fileSystemRoot&gt;...&lt;/#list&gt;</code></pre>
<p>Of course, you must be aware of the potential security issues this model brings.</p>
<p>You can even give the template authors complete freedom over which classes' static methods they use by placing the static models hash into your template root model with</p>
<pre><code>root.put(&quot;statics&quot;, BeansWrapper.getDefaultInstance().getStaticModels());</code></pre>
<p>This object exposes just about any class' static methods if it's used as a hash with class name as the key. You can then use expression like <code>${statics[&quot;java.lang.System&quot;].currentTimeMillis()}</code> in your template. Note, however that this has even more security implications, as someone could even invoke <code>System.exit()</code> using this model if the method exposure level is weakened to <code>EXPOSE_ALL</code>.</p>
<p>Note that in above examples, we always use the default <code>BeansWrapper</code> instance. This is a convenient static wrapper instance that you can use in most cases. You are also free to create your own <code>BeansWrapper</code> instances and use them instead especially when you want to modify some of its characteristics (like model caching, security level, or the null model representation).</p>
<h3 id="jdk_15_enums">Accessing enums</h3>
enum
<p>The <code>TemplateHashModel</code> returned from <code>BeansWrapper.getEnumModels()</code> can be used to create hash models for accessing values of enums on JRE 1.5 or later. (An attempt to invoke this method on an earlier JRE will result in an <code>UnsupportedOperationException</code>.)</p>
<pre><code>BeansWrapper wrapper = BeansWrapper.getDefaultInstance();
TemplateHashModel enumModels = wrapper.getEnumModels();
TemplateHashModel roundingModeEnums =
    (TemplateHashModel) enumModels.get(&quot;java.math.RoundingMode&quot;);</code></pre>
<p>And you will get a template hash model that exposes all enum values of the <code>java.math.RoundingMode</code> class as hash keys. Suppose that you put the previous model in your root model:</p>
<pre><code>root.put(&quot;RoundingMode&quot;, roundingModeEnums);</code></pre>
<p>From now on, you can use <code>RoundingMode.UP</code> as an expression to reference the <code>UP</code> enum value in your template.</p>
<p>You can even give the template authors complete freedom over which enum classes they use by placing the enum models hash into your template root model with</p>
<pre><code>root.put(&quot;enums&quot;, BeansWrapper.getDefaultInstance().getEnumModels());</code></pre>
<p>This object exposes any enum class if it's used as a hash with class name as the key. You can then use expression like <code>${enums[&quot;java.math.RoundingMode&quot;].UP}</code> in your template.</p>
<p>The exposed enum values can be used as scalars (they'll delegate to their <code>toString()</code> method), and can be used in equality and inequality comparisons as well.</p>
<p>Note that in above examples, we always use the default <code>BeansWrapper</code> instance. This is a convenient static wrapper instance that you can use in most cases. You are also free to create your own <code>BeansWrapper</code> instances and use them instead especially when you want to modify some of its characteristics (like model caching, security level, or the null model representation).</p>
<h2 id="pgui_misc_logging">Logging</h2>
logging
SLF4J
Log4j2
<h3>Logging library selection</h3>
<p>Is short, the recommended setup in contemporary application (as of 2015) is using SLF4J API for logging everywhere. To get FreeMarker 2.3.x. to use SLF4J, simply add the <code>org.slf4j:log4j-over-slf4j</code> dependency to your project, and ensure that <code>log4j:log4j</code> isn't present. (Starting from FreeMarker 2.4.x you don't need <code>log4j-over-slf4j</code> anymore, though it does no harm either.)</p>
<p>Read on if you are curious about the details, or if you can't use SLF4J...</p>
<p>FreeMarker integrates with the following logging libraries: <a href="http://www.slf4j.org/">SLF4J</a>, <a href="http://commons.apache.org/logging/">Apache Commons Logging</a>, <a href="http://jakarta.apache.org/log4j">Log4J</a> 1.x, <a href="http://jakarta.apache.org/avalon/logkit">Avalon LogKit</a>, and <a href="http://java.sun.com/j2se/1.4/docs/api/java/util/logging/package-summary.html"><code>java.util.logging</code></a>. By default, FreeMarker will look for the these logging libraries in the following order, and will automatically use the first one it finds (in 2.3.x): [2.4 - un-remark this] SLF4J, Apache Commons Logging,Log4J (will use SLF4J instead if it's a properly installed <code>log4j-over-slf4j</code>, since 2.3.22), Apache Avalon LogKit, <code>java.util.logging</code>. As you can see, Log4j has the highest priority. The presence of Log4j is simply detected from the presence of the <code>org.apache.log4j.Logger</code> class, which means that Log4j redirections like <code>log4j-over-slf4j</code> or <code>log4j-1.2-api</code> will also get the highest priority.</p>
<p>Prior to FreeMarker 2.4, SLF4J and Apache Commons Logging aren't searched automatically due to backward compatibility constraints. But if you have <code>org.slf4j:log4j-over-slf4j</code> properly installed (means, you have no real Log4j in your class path, and SLF4J has a backing implementation like <code>logback-classic</code>), then FreeMarker will use the SLF4J API directly instead of the Log4j API (since FreeMarker 2.3.22).</p>
<p>Note that a similar trick can be applied for logging into Log4j2: If <code>org.apache.logging.log4j:log4j-1.2-api</code> is present, FreeMarker 2.3.x will pick that as it looks like Log4j, but all the messages will actually go to Log4j2.</p>
<p>If the auto detection doesn't give you the result that you want, you can set the <code>org.freemarker.loggerLibrary</code> system property to select a logger library explicitly (since 2.3.22), like:</p>
<pre><code>java ... -Dorg.freemarker.loggerLibrary=SLF4J</code></pre>
<p>The supported system property values are: <code>SLF4J</code>, <code>CommonsLogging</code>, <code>JUL</code> (for <code>java.util.logging</code>), <code>Avalon</code>, <code>auto</code> (the default behavior), <code>none</code> (disables logging).</p>
<p>Note that for reliable operation, the system property should be set when the JVM starts (like above), not later from Java code.</p>
<p>Using SLF4J is recommended, as it works best with FreeMarker, and also because it will be the highest priority auto detected logger starting from FreeMarker 2.4.</p>
<h3>Logging categories</h3>
<p>All log messages produced by FreeMarker are logged with a logger category that starts with <code>freemarker.</code>. The currently used logger categories are:</p>
<table>
<thead>
<tr class="header">
<th>Log category name</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>freemarker.beans</code></td>
<td>Logs messages of the Beans wrapper module.</td>
</tr>
<tr class="even">
<td><code>freemarker.cache</code></td>
<td>Logs messages related to template loading and caching.</td>
</tr>
<tr class="odd">
<td><code>freemarker.runtime</code></td>
<td>Logs messages related to template execution that doesn't fit any of the more specific categories. Most importantly, it logs template exceptions thrown during template processing (however that should be disabled in modern application; see later).</td>
</tr>
<tr class="even">
<td><code>freemarker.runtime.attempt</code></td>
<td>Logs template exceptions thrown during template processing and caught by <code>attempt</code>/<code>recover</code> directives, with DEBUG severity. Note that such exceptions will be still also logged with their normal logger (like <code>freemarker.runtime</code>).</td>
</tr>
<tr class="odd">
<td><code>freemarker.servlet</code></td>
<td>Logs messages of the <code>FreemarkerServlet</code> class.</td>
</tr>
<tr class="even">
<td><code>freemarker.jsp</code></td>
<td>Logs messages of the FreeMarker JSP support.</td>
</tr>
</tbody>
</table>
<p>One quirk relating this is that FreeMarker will log exceptions during template execution under the <code>freemarker.runtime</code> category even if the exception continues propagating and so eventually will be thrown by <code>Template.process</code> or <code>Environment.process</code> anyway. (Those are the API calls with which the template was invoked from the application or the application framework.) Well behaving applications log the exceptions thrown at them, or rarely, handle them and deliberately don't want to log them. But as FreeMarker has already logged that exception, you will end up one more log entry than expected. To fix that (since 2.3.22), set the <code>log_template_exceptions</code> (<code>Configurable.setLogTemplateExceptions(boolean)</code>) setting to <code>false</code>.</p>
<h2 id="pgui_misc_servlet">Using FreeMarker with servlets</h2>
Servlet
HTTP
JSP
Model 2
Struts
Web application framework
<p>In a fundamental sense, using FreeMarker in the web application space is no different from anywhere else; FreeMarker writes its output to a <code>Writer</code> that you pass to the <code>Template.process</code> method, and it does not care if that <code>Writer</code> prints to the console or to a file or to the output stream of <code>HttpServletResponse</code>. FreeMarker knows nothing about servlets and Web; it just merges Java object with template files and generates text output from them. From here, it is up to you how to build a Web application around this.</p>
<p>But, probably you want to use FreeMarker with some already existing Web application framework. Many frameworks rely on the “Model 2” architecture, where JSP pages handle presentation. If you use such a framework (for example, <a href="http://jakarta.apache.org/struts">Apache Struts</a>), then read on. For other frameworks please refer to the documentation of the framework.</p>
<h3 id="pgui_misc_servlet_model2">Using FreeMarker for “Model 2”</h3>
<p>Many frameworks follow the strategy that the HTTP request is dispatched to user-defined “action” classes that put data into <code>ServletContext</code>, <code>HttpSession</code> and <code>HttpServletRequest</code> objects as attributes, and then the request is forwarded by the framework to a JSP page (the view) that will generate the HTML page using the data sent with the attributes. This is often referred as Model 2.</p>
<p><img src="figures/model2sketch.png" /></p>
<p>With these frameworks you can simply use FTL files instead of JSP files. But, since your servlet container (Web application server), unlike with JSP files, does not know out-of-the-box what to do with FTL files, a little extra configuring is needed for your Web application:</p>
<ol type="1">
<li><p>Copy <code>freemarker.jar</code> (from the <code>lib</code> directory of the FreeMarker distribution) into the <code>WEB-INF/lib</code> directory of your Web application.</p></li>
<li><p>Insert the following section to the <code>WEB-INF/web.xml</code> file of your Web application (and adjust it if required):</p></li>
</ol>
<pre><code>&lt;servlet&gt;
  &lt;servlet-name&gt;freemarker&lt;/servlet-name&gt;
  &lt;servlet-class&gt;freemarker.ext.servlet.FreemarkerServlet&lt;/servlet-class&gt;

  &lt;!--
    Init-param documentation:
    http://freemarker.org/docs/api/freemarker/ext/servlet/FreemarkerServlet.html
  --&gt;

  &lt;!-- FreemarkerServlet settings: --&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;TemplatePath&lt;/param-name&gt;
    &lt;param-value&gt;/&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;NoCache&lt;/param-name&gt;
    &lt;param-value&gt;true&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;ResponseCharacterEncoding&lt;/param-name&gt;
    &lt;!-- Use the output_encoding setting of FreeMarker: --&gt;
    &lt;param-value&gt;fromTemplate&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;ExceptionOnMissingTemplate&lt;/param-name&gt;
    &lt;!-- true =&gt; HTTP 500 on missing template, instead of HTTP 404. --&gt;
    &lt;param-value&gt;true&lt;/param-value&gt;
  &lt;/init-param&gt;

  &lt;!-- FreeMarker engine settings: --&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;incompatible_improvements&lt;/param-name&gt;
    &lt;param-value&gt;2.3.27&lt;/param-value&gt;
    &lt;!--
      Recommended to set to a high value.
      See: http://freemarker.org/docs/pgui_config_incompatible_improvements.html
    --&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;template_exception_handler&lt;/param-name&gt;
    &lt;!-- Use &quot;html_debug&quot; during development! --&gt;
    &lt;param-value&gt;rethrow&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;template_update_delay&lt;/param-name&gt;
    &lt;!-- Use 0 during development! Consider what value you need otherwise. --&gt;
    &lt;param-value&gt;30 s&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;default_encoding&lt;/param-name&gt;
    &lt;!-- The encoding of the template files: --&gt;
    &lt;param-value&gt;UTF-8&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;output_encoding&lt;/param-name&gt;
    &lt;!-- The encoding of the template output; Note that you must set
         &quot;ResponseCharacterEncodring&quot; to &quot;fromTemplate&quot; for this to work! --&gt;
    &lt;param-value&gt;UTF-8&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;locale&lt;/param-name&gt;
    &lt;!-- Influences number and date/time formatting, etc. --&gt;
    &lt;param-value&gt;en_US&lt;/param-value&gt;
  &lt;/init-param&gt;
  &lt;init-param&gt;
    &lt;param-name&gt;number_format&lt;/param-name&gt;
    &lt;param-value&gt;0.##########&lt;/param-value&gt;
  &lt;/init-param&gt;

  &lt;load-on-startup&gt;1&lt;/load-on-startup&gt;
&lt;/servlet&gt;

&lt;servlet-mapping&gt;
  &lt;servlet-name&gt;freemarker&lt;/servlet-name&gt;
  &lt;url-pattern&gt;*.ftl&lt;/url-pattern&gt;
  &lt;!-- HTML and XML auto-escaped if incompatible_improvements &gt;= 2.3.24: --&gt;
  &lt;url-pattern&gt;*.ftlh&lt;/url-pattern&gt;
  &lt;url-pattern&gt;*.ftlx&lt;/url-pattern&gt;
&lt;/servlet-mapping&gt;

...

&lt;!--
  Prevent the visiting of MVC Views from outside the servlet container.
  RequestDispatcher.forward/include should, and will still work.
  Removing this may open security holes!
--&gt;
&lt;security-constraint&gt;
  &lt;web-resource-collection&gt;
    &lt;web-resource-name&gt;FreeMarker MVC Views&lt;/web-resource-name&gt;
    &lt;url-pattern&gt;*.ftl&lt;/url-pattern&gt;
    &lt;url-pattern&gt;*.ftlh&lt;/url-pattern&gt;
    &lt;url-pattern&gt;*.ftlx&lt;/url-pattern&gt;
  &lt;/web-resource-collection&gt;
  &lt;auth-constraint&gt;
    &lt;!-- Nobody is allowed to visit these directly. --&gt;
  &lt;/auth-constraint&gt;
&lt;/security-constraint&gt;</code></pre>
<p>After this, you can use FTL files (<code>*.ftl</code>) in the same manner as JSP (<code>*.jsp</code>) files. (Of course you can choose another extension besides <code>ftl</code>; it is just the convention)</p>
<blockquote>
<p><strong>Note</strong></p>
<p>How does it work? Let's examine how JSP-s work. Many servlet container handles JSP-s with a servlet that is mapped to the <code>*.jsp</code> request URL pattern. That servlet will receive all requests where the request URL ends with <code>.jsp</code>, find the JSP file based on the request URL, and internally compiles it to a <code>Servlet</code>, and then call the generated servlet to generate the page. The <code>FreemarkerServlet</code> mapped here to the <code>*.ftl</code> URL pattern does the same, except that FTL files are not compiled to <code>Servlet</code>-s, but to <code>Template</code> objects, and then the <code>process</code> method of <code>Template</code> will be called to generate the page.</p>
</blockquote>
<p>For example, instead of this JSP file (note that it heavily uses Struts tag-libs to save designers from embedded Java monsters):</p>
<pre><code>&lt;%@ taglib uri=&quot;/WEB-INF/struts-bean.tld&quot; prefix=&quot;bean&quot; %&gt;
&lt;%@ taglib uri=&quot;/WEB-INF/struts-logic.tld&quot; prefix=&quot;logic&quot; %&gt;

&lt;html&gt;
&lt;head&gt;&lt;title&gt;Acmee Products International&lt;/title&gt;
&lt;body&gt;
  &lt;h1&gt;Hello &lt;bean:write name=&quot;user&quot;/&gt;!&lt;/h1&gt;
  &lt;p&gt;These are our latest offers:
  &lt;ul&gt;
    &lt;logic:iterate name=&quot;latestProducts&quot; id=&quot;prod&quot;&gt;
      &lt;li&gt;&lt;bean:write name=&quot;prod&quot; property=&quot;name&quot;/&gt;
        for &lt;bean:write name=&quot;prod&quot; property=&quot;price&quot;/&gt; Credits.
    &lt;/logic:iterate&gt;
  &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>you can use this FTL file (use <code>ftl</code> file extension instead of <code>jsp</code>):</p>
<pre><code>&lt;html&gt;
&lt;head&gt;&lt;title&gt;Acmee Products International&lt;/title&gt;
&lt;body&gt;
  &lt;h1&gt;Hello ${user}!&lt;/h1&gt;
  &lt;p&gt;These are our latest offers:
  &lt;ul&gt;
    &lt;#list latestProducts as prod&gt;
      &lt;li&gt;${prod.name} for ${prod.price} Credits.
    &lt;/#list&gt;
  &lt;/ul&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<blockquote>
<p><strong>Warning</strong></p>
<p>In FreeMarker <code>&lt;html:form
            action=&quot;/query&quot;&gt;...&lt;/html:form&gt;</code> is just static text, so it is printed to the output as is, like any other XML or HTML markup. JSP tags are just FreeMarker directives, nothing special, so you <em>use FreeMarker syntax</em> for calling them, not JSP syntax: <code>&lt;@html.form
            action=&quot;/query&quot;&gt;...&lt;/@html.form&gt;</code>. Note that in the FreeMarker syntax you <em>don't use <code>${...}</code> in parameters</em> as in JSP, and you <em>don't quote the parameter values</em>. So this is <em>WRONG</em>:</p>
<pre><code>&lt;#-- WRONG: --&gt;
&lt;@my.jspTag color=&quot;${aVariable}&quot; name=&quot;aStringLiteral&quot;
            width=&quot;100&quot; height=${a+b} /&gt;</code></pre>
<p>and this is good:</p>
<pre><code>&lt;#-- Good: --&gt;
&lt;@my.jspTag color=aVariable name=&quot;aStringLiteral&quot;
            width=100 height=a+b /&gt;</code></pre>
</blockquote>
<p>In both templates, when you refer to <code>user</code> and <code>latestProduct</code>, it will first try to find a variable with that name that was created in the template (like <code>prod</code>; if you master JSP: a page scope attribute). If that fails, it will try to look up an attribute with that name in the <code>HttpServletRequest</code>, and if it is not there then in the <code>HttpSession</code>, and if it still doesn't find it then in the <code>ServletContext</code>. In the case of FTL this works because <code>FreemarkerServlet</code> builds the data-model from the attributes of the mentioned 3 objects. That is, in this case the root hash is not a <code>java.util.Map</code> (as it was in some example codes in this manual), but <code>ServletContext</code>+<code>HttpSession</code>+<code>HttpServletRequest</code>; FreeMarker is pretty flexible about what the data-model is. So if you want to put variable <code>&quot;name&quot;</code> into the data-model, then you call <code>servletRequest.setAttribute(&quot;name&quot;, &quot;Fred&quot;)</code>; this is the logic of Model 2, and FreeMarker adapts itself to it.</p>
<p><code>FreemarkerServlet</code> also puts 3 hashes into the data-model, by which you can access the attributes of the 3 objects directly. The hash variables are: <code>Request</code>, <code>Session</code>, <code>Application</code> (corresponds to <code>ServletContext</code>). It also exposes another hash named <code>RequestParameters</code> that provides access to the parameters of the HTTP request.</p>
<p><code>FreemarkerServlet</code> has various init-params. It can be set up to load templates from an arbitrary directory, from the classpath, or relative to the Web application directory. You can set the charset used for templates, the default locale used by templates, what object wrapper do you want to use, etc.</p>
<p><code>FreemarkerServlet</code> is easily tailored to special needs through subclassing. Say, if you need to have additional variables available in your data-model for all templates, subclass the servlet and override the <code>preTemplateProcess()</code> method to shove any additional data you need into the model before the template gets processed. Or subclass the servlet, and set these globally available variables as <a href="#pgui_config_sharedvariables">shared variables</a> in the <code>Configuration</code>.</p>
<p>For more information please read the Java API documentation of the class.</p>
<h3 id="pgui_misc_servlet_include">Including content from other web application resources</h3>
include
servlet
include
JSP
servlet
include
JSP
include
<p>You can use the <code>&lt;@include_page
          path=&quot;...&quot;/&gt;</code> custom directive provided by the <code>FreemarkerServlet</code> (since 2.3.15) to include the contents of another web application resource into the output; this is often useful to integrate output of JSP pages (living alongside the FreeMarker templates in the same web server) into the FreeMarker template output. Using:</p>
<pre><code>&lt;@include_page path=&quot;path/to/some.jsp&quot;/&gt;</code></pre>
<p>is identical to using this tag in JSP:</p>
<pre><code>&lt;jsp:include page=&quot;path/to/some.jsp&quot;&gt;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p><code>&lt;@include_page ...&gt;</code> is not to be confused with <code>&lt;#include ...&gt;</code>, as the last is for including FreeMarker templates without involving the Servlet container. An <code>&lt;#include ...&gt;</code>-ed template shares the template processing state with the including template, such as the data-model and the template-language variables, while <code>&lt;@include_page ...&gt;</code> starts an independent HTTP request processing.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>Some Web Application Frameworks provide their own solution for this, in which case you possibly should use that instead. Also some Web Application Frameworks don't use <code>FreemarkerServlet</code>, so <code>include_page</code> is not available.</p>
</blockquote>
<p>The path can be relative or absolute. Relative paths are interpreted relative to the URL of the current HTTP request (one that triggered the template processing), while absolute paths are absolute in the current servlet context (current web application). You can not include pages from outside the current web application. Note that you can include any page, not just a JSP page; we just used page with path ending in <code>.jsp</code> as an illustration.</p>
<p>In addition to the <code>path</code> parameter, you can also specify an optional parameter named <code>inherit_params</code> with a boolean value (defaults to true when not specified) that specifies whether the included page will see the HTTP request parameters of the current request or not.</p>
<p>Finally, you can specify an optional parameter named <code>params</code> that specifies new request parameters that the included page will see. In case inherited parameters are passed too, the values of specified parameters will get prepended to the values of inherited parameters of the same name. The value of <code>params</code> must be a hash, with each value in it being either a string, or a sequence of strings (if you need multivalued parameters). Here's a full example:</p>
<pre><code>&lt;@include_page path=&quot;path/to/some.jsp&quot; inherit_params=true params={&quot;foo&quot;: &quot;99&quot;, &quot;bar&quot;: [&quot;a&quot;, &quot;b&quot;]}/&gt;</code></pre>
<p>This will include the page <code>path/to/some.jsp</code>, pass it all request parameters of the current request, except for &quot;foo&quot; and &quot;bar&quot;, which will be set to &quot;99&quot; and multi-value of &quot;a&quot;, &quot;b&quot;, respectively. In case the original request already had values for these parameters, the new values will be prepended to the existing values. I.e. if &quot;foo&quot; had values &quot;111&quot; and &quot;123&quot;, then it will now have values &quot;99&quot;, &quot;111&quot;, &quot;123&quot;.</p>
<p>It is in fact possible to pass non-string values for parameter values within <code>params</code>. Such a value will be converted to a suitable Java object first (i.e. a Number, a Boolean, a Date, etc.), and then its Java <code>toString()</code> method will be used to obtain the string value. It is better to not rely on this mechanism, though, and instead explicitly ensure that parameter values that aren't strings are converted to strings on the template level where you have control over formatting using the <code>?string</code> and <code>?c</code> built-ins.</p>
<h3>Using JSP custom tags in FTL</h3>
JSP
taglib
custom tags
taglib
<p><code>FreemarkerServlet</code> puts the <code>JspTaglibs</code> hash into the data-model, which you can use to access JSP taglibs. The JSP custom tags will be accessible as plain user-defined directives, and the custom EL functions (since FreeMarker 2.3.22) as methods. For example, for this JSP file:</p>
<pre><code>&lt;%@ page contentType=&quot;text/html;charset=ISO-8859-2&quot; language=&quot;java&quot;%&gt;
&lt;%@ taglib prefix=&quot;e&quot; uri=&quot;/WEB-INF/example.tld&quot; %&gt;
&lt;%@ taglib prefix=&quot;oe&quot; uri=&quot;/WEB-INF/other-example.tld&quot; %&gt;
&lt;%@ taglib prefix=&quot;c&quot; uri=&quot;http://java.sun.com/jsp/jstl/core&quot; %&gt;
&lt;%@ taglib prefix=&quot;fn&quot; uri=&quot;http://java.sun.com/jsp/jstl/functions&quot; %&gt;

&lt;%-- Custom JSP tags and functions: --%&gt;

&lt;e:someTag numParam=&quot;123&quot; boolParam=&quot;true&quot; strParam=&quot;Example&quot; anotherParam=&quot;${someVar}&quot;&gt;
  ...
&lt;/e:someTag&gt;

&lt;oe:otherTag /&gt;

${e:someELFunction(1, 2)}


&lt;%-- JSTL: --%&gt;

&lt;c:if test=&quot;${foo}&quot;&gt;
  Do this
&lt;/c:if&gt;

&lt;c:choose&gt;
  &lt;c:when test=&quot;${x == 1}&quot;&gt;
      Do this
  &lt;/c:when&gt;
  &lt;c:otherwise&gt;
      Do that
  &lt;/c:otherwise&gt;
&lt;/c:choose&gt;

&lt;c:forEach var=&quot;person&quot; items=&quot;${persons}&quot;&gt;
  ${person.name}
&lt;/c:forEach&gt;

${fn:trim(bar)}</code></pre>
<p>the about equivalent FTL is:</p>
<pre><code>&lt;#assign e=JspTaglibs[&quot;/WEB-INF/example.tld&quot;]&gt;
&lt;#assign oe=JspTaglibs[&quot;/WEB-INF/other-example.tld&quot;]&gt;

&lt;#-- Custom JSP tags and functions: --#&gt;

&lt;@e.someTag numParam=123 boolParam=true strParam=&quot;Example&quot; anotherParam=someVar&gt;
  ...
&lt;/@e.someTag&gt;

&lt;@oe.otherTag /&gt;

${e.someELFunction(1, 2)}


&lt;#-- JSTL - Instead, use native FTL constructs: --&gt;

&lt;#if foo&gt;
  Do this
&lt;/#if&gt;

&lt;#if x == 1&gt;
  Do this
&lt;#else&gt;
  Do that
&lt;/#if&gt;

&lt;#list persons as person&gt;
  ${person.name}
&lt;/#list&gt;

${bar?trim}</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Parameter values don't use quotation and <code>&quot;${...}&quot;</code> like in JSP. See more explanation later.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p><code>JspTaglibs</code> is not a core FreeMarker feature; it only exists when the template is called through the <code>FreemarkerServlet</code>. That's because JSP tags/functions assume a servlet environment (FreeMarker doesn't), plus some Servlet concepts have to be emulated in the special FreeMarker data-model that <code>FreemarkerServlet</code> builds. Many modern frameworks use FreeMarker on a pure way, not through <code>FreemarkerServlet</code>.</p>
</blockquote>
<p>Since JSP custom tags are written to operate in JSP environment, they assume that variables (often referred as “beans” in JSP world) are stored in 4 scopes: page scope, request scope, session scope and application scope. FTL has no such notation (the 4 scopes), but <code>FreemarkerServlet</code> provides emulated JSP environment for the custom JSP tags, which maintains correspondence between the “beans” of JSP scopes and FTL variables. For the custom JSP tags, the request, session and application scopes are exactly the same as with real JSP: the attributes of the <code>javax.servlet.ServletContext</code>, <code>HttpSession</code> and <code>ServletRequest</code> objects. From the FTL side you see these 3 scopes together as the data-model, as it was explained earlier. The page scope corresponds to the FTL global variables (see the <a href="#ref.directive.global"><code>global</code> directive</a>). That is, if you create a variable with the <code>global</code> directive, it will be visible for the custom tags as page scope variable through the emulated JSP environment. Also, if a JSP-tag creates a new page scope variable, the result will be the same as if you create a variable with the <code>global</code> directive. Note that the variables in the data-model are not visible as page-scope attributes for the JSP tags, despite that they are globally visible, since the data-model corresponds to the request, session and application scopes, not the page-scope.</p>
<p>On JSP pages you quote all attribute values, it does not mater if the type of the parameter is string or boolean or number. But since custom tags are accessible in FTL templates as user-defined FTL directives, you have to use the FTL syntax rules inside the custom tags, not the JSP rules. So when you specify the value of an “attribute”, then on the right side of the <code>=</code> there is an <a href="#dgui_template_exp">FTL expression</a>. Thus, <em>you must not quote boolean and numerical parameter values</em> (e.g. <code>&lt;@tiles.insert
          page=&quot;/layout.ftl&quot; flush=true/&gt;</code>), or they are interpreted as string values, and this will cause a type mismatch error when FreeMarker tries to pass the value to the custom tag that expects non-string value. Also note that, naturally, you can use any FTL expression as attribute value, such as variables, calculated values, etc. (e.g. <code>&lt;@tiles.insert page=layoutName
          flush=foo &amp;&amp; bar/&gt;</code>).</p>
<p>FreeMarker does not rely on the JSP support of the servlet container in which it is run when it uses JSP taglibs since it implements its own lightweight JSP runtime environment. There is only one small detail to pay attention to: to enable the FreeMarker JSP runtime environment to dispatch events to JSP taglibs that register event listeners in their TLD files, you should add this to the <code>WEB-INF/web.xml</code> of your Web application:</p>
<pre><code>&lt;listener&gt;
  &lt;listener-class&gt;freemarker.ext.jsp.EventForwarding&lt;/listener-class&gt;
&lt;/listener&gt;</code></pre>
<p>Note that you can use JSP taglibs with FreeMarker even if the servlet container has no native JSP support, just make sure that the <code>javax.servlet.jsp.*</code> packages for JSP 2.0 (or later) are available to your Web application.</p>
<p>As of this writing, JSP features up to JSP 2.1 are implemented, except the &quot;tag files&quot; feature of JSP 2 (i.e., custom JSP tags <em>implemented</em> in JSP language). The tag files had to be compiled to Java classes to be usable under FreeMarker.</p>
<p><code>JspTaglibs[uri]</code> will have to find the TLD for the URI specified, just like JSP's <code>@taglib</code> directive has to. For this, it implements the TLD discovery mechanism described in the JSP specification. See more there, but in a nutshell, it searches TLD-s in <code>WEB-INF/web.xml</code> <code>taglib</code> elements, at <code>WEB-INF/**/*.tld</code>, and in <code>WEB-INF/lib/*.{jar,zip}/META-INF/**/*.tld</code>. Additionally, it can discover TLD-s that are visible for the class loader even if they are outside the WAR structure, when you set that up with the <code>MetaInfTldSources</code> and/or <code>ClasspathTlds</code> <code>FreemarkerServlet</code> init-params (since 2.3.22). See the Java API documentation of <code>FreemarkerServlet</code> for the description of these. It's also possible to set these from Java system properties, which can be handy when you want to change these in the Eclipse run configuration without modifying the <code>web.xml</code>; again, see the <code>FreemarkerServlet</code> API docs. <code>FreemarkerServlet</code> also recognizes the <code>org.eclipse.jetty.server.webapp.ContainerIncludeJarPattern</code> servlet context attribute, and adds the entries from it to <code>MetaInfTldSources</code>.</p>
<h3>Embed FTL into JSP pages</h3>
JSP
taglib
<p>There is a taglib that allows you to put FTL fragments into JSP pages. The embedded FTL fragment can access the attributes (Beans) of the 4 JSP scopes. You can find a working example and the taglib in the FreeMarker distribution.</p>
<h2 id="pgui_misc_secureenv">Configuring security policy for FreeMarker</h2>
security
<p>When FreeMarker is used in a Java virtual machine with a security manager installed, you have to grant it few permissions to ensure it operates properly. Most notably, you need these entries to your security policy file for <code>freemarker.jar</code>:</p>
<pre><code>grant codeBase &quot;file:/path/to/freemarker.jar&quot;
{
  permission java.util.PropertyPermission &quot;file.encoding&quot;, &quot;read&quot;;
  permission java.util.PropertyPermission &quot;freemarker.*&quot;, &quot;read&quot;;
}</code></pre>
<p>Additionally, if you are loading templates from a directory, you need to give FreeMarker permissions to read files from that directory using the following permission:</p>
<pre><code>grant codeBase &quot;file:/path/to/freemarker.jar&quot;
{
  ...
  permission java.io.FilePermission &quot;/path/to/templates/-&quot;, &quot;read&quot;;
}</code></pre>
<p>Finally, if you're just using the default template loading mechanism which loads templates from the current directory, then specify these permissions additionally: (note that the expression <code>${user.dir}</code> will be evaluated at run time by the policy interpreter, pretty much as if it were a FreeMarker template)</p>
<pre><code>grant codeBase &quot;file:/path/to/freemarker.jar&quot;
{
  ...
  permission java.util.PropertyPermission &quot;user.dir&quot;, &quot;read&quot;;
  permission java.io.FilePermission &quot;${user.dir}/-&quot;, &quot;read&quot;;
}</code></pre>
<p>Naturally, if you're running under Windows, use double backslash instead of a single slash for separating directory components in paths.</p>
<h2 id="pgui_misc_xml_legacy">Legacy XML wrapper implementation</h2>
<blockquote>
<p><strong>Note</strong></p>
<p><em>The legacy XML wrapper is deprecated.</em> FreeMarker 2.3 has introduced support for a new XML processing model. To support this, a new XML wrapper package was introduced, <code>freemarker.ext.dom</code>. For new usage, we encourage you to use that. It is documented in the part <a href="#xgui">part_title</a>.</p>
</blockquote>
<p>The class <code>freemarker.ext.xml.NodeListModel</code> provides a template model for wrapping XML documents represented as node trees. Every node list can contain zero or more XML nodes (documents, elements, texts, processing instructions, comments, entity references, CDATA sections, etc.). The node list implements the following template model interfaces with the following semantics:</p>
<h3>TemplateScalarModel</h3>
<p>When used as a scalar, the node list will render the XML fragment that represents its contained nodes. This makes it handy for use in XML-to-XML transforming templates.</p>
<h3>TemplateCollectionModel</h3>
<p>When used as a collection with <code>list</code> directive, it will simply enumerate its nodes. Every node will be returned as a new node list consisting of a single node.</p>
<h3>TemplateSequenceModel</h3>
<p>When used as a sequence, it will return the i-th node as a new node list consisting of the single requested node. I.e. to return the 3rd <code>&lt;chapter&gt;</code> element of the <code>&lt;book&gt;</code> element, you'd use the following (note indexes are zero-based):</p>
<pre><code>&lt;#assign thirdChapter = xmldoc.book.chapter[2]&gt;</code></pre>
<h3>TemplateHashModel</h3>
<p>When used as a hash, it is basically used to traverse children. That is, if you have a node list named <code>book</code> that wraps an element node with several chapters, then the <code>book.chapter</code> will yield a node list with all chapter elements of that book element. The at sign is used to refer to attributes: <code>book.@title</code> yields a node list with a single attribute node, that is the title attribute of the book element.</p>
<p>It is important to realize the consequence that, for example, if <code>book</code> has no <code>chapter</code>-s then <code>book.chapter</code> is an empty sequence, so <code>xmldoc.book.chapter??</code> will <em>not</em> be <code>false</code>, it will be always <code>true</code>! Similarly, <code>xmldoc.book.somethingTotallyNonsense??</code> will not be <code>false</code> either. To check if there was no children found, use <code>xmldoc.book.chapter?size ==
          0</code>.</p>
<p>The hash defines several &quot;magic keys&quot; as well. All these keys start with an underscore. The most notable is the <code>_text</code> key which retrieves the text of the node: <code>${book.@title._text}</code> will render the value of the attribute into the template. Similarly, <code>_name</code> will retrieve the name of the element or attribute. <code>*</code> or <code>_allChildren</code> returns all direct children elements of all elements in the node list, while <code>@*</code> or <code>_allAttributes</code> returns all attributes of the elements in the node list. There are many more such keys; here's a detailed summary of all the hash keys:</p>
<table>
<thead>
<tr class="header">
<th>Key name</th>
<th>Evaluates to</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>*</code> or <code>_children</code></td>
<td>all direct element children of current nodes (non-recursive). Applicable to element and document nodes.</td>
</tr>
<tr class="even">
<td><code>@*</code> or <code>_attributes</code></td>
<td>all attributes of current nodes. Applicable to elements only.</td>
</tr>
<tr class="odd">
<td><code>@attributeName</code></td>
<td>named attributes of current nodes. Applicable to elements, doctypes and processing instructions. On doctypes it supports attributes <code>publicId</code>, <code>systemId</code> and <code>elementName</code>. On processing instructions, it supports attributes <code>target</code> and <code>data</code>, as well as any other attribute name specified in data as <code>name=&quot;value&quot;</code> pair. The attribute nodes for doctype and processing instruction are synthetic, and as such have no parent. Note, however that <code>@*</code> does NOT operate on doctypes or processing instructions.</td>
</tr>
<tr class="even">
<td><code>_ancestor</code></td>
<td>all ancestors up to root element (recursive) of current nodes. Applicable to same node types as <code>_parent</code>.</td>
</tr>
<tr class="odd">
<td><code>_ancestorOrSelf</code></td>
<td>all ancestors of current nodes plus current nodes. Applicable to same node types as <code>_parent</code>.</td>
</tr>
<tr class="even">
<td><code>_cname</code></td>
<td>the canonical names of current nodes (namespace URI + local name), one string per node (non-recursive). Applicable to elements and attributes</td>
</tr>
<tr class="odd">
<td><code>_content</code></td>
<td>the complete content of current nodes, including children elements, text, entity references, and processing instructions (non-recursive). Applicable to elements and documents.</td>
</tr>
<tr class="even">
<td><code>_descendant</code></td>
<td>all recursive descendant element children of current nodes. Applicable to document and element nodes.</td>
</tr>
<tr class="odd">
<td><code>_descendantOrSelf</code></td>
<td>all recursive descendant element children of current nodes plus current nodes. Applicable to document and element nodes.</td>
</tr>
<tr class="even">
<td><code>_document</code></td>
<td>all documents the current nodes belong to. Applicable to all nodes except text.</td>
</tr>
<tr class="odd">
<td><code>_doctype</code></td>
<td>doctypes of the current nodes. Applicable to document nodes only.</td>
</tr>
<tr class="even">
<td><code>_filterType</code></td>
<td>is a filter-by-type template method model. When called, it will yield a node list that contains only those current nodes whose type matches one of types passed as argument. You should pass arbitrary number of strings to this method containing the names of types to keep. Valid type names are: &quot;attribute&quot;, &quot;cdata&quot;, &quot;comment&quot;, &quot;document&quot;, &quot;documentType&quot;, &quot;element&quot;, &quot;entity&quot;, &quot;entityReference&quot;, &quot;processingInstruction&quot;, &quot;text&quot;.</td>
</tr>
<tr class="odd">
<td><code>_name</code></td>
<td>the names of current nodes, one string per node (non-recursive). Applicable to elements and attributes (returns their local names), entities, processing instructions (returns its target), doctypes (returns its public ID)</td>
</tr>
<tr class="even">
<td><code>_nsprefix</code></td>
<td>the namespace prefixes of current nodes, one string per node (non-recursive). Applicable to elements and attributes</td>
</tr>
<tr class="odd">
<td><code>_nsuri</code></td>
<td>the namespace URIs of current nodes, one string per node (non-recursive). Applicable to elements and attributes</td>
</tr>
<tr class="even">
<td><code>_parent</code></td>
<td>parent elements of current nodes. Applicable to element, attribute, comment, entity, processing instruction.</td>
</tr>
<tr class="odd">
<td><code>_qname</code></td>
<td>the qualified names of current nodes in <code>[namespacePrefix:]localName</code> form, one string per node (non-recursive). Applicable to elements and attributes</td>
</tr>
<tr class="even">
<td><code>_registerNamespace(prefix, uri)</code></td>
<td>register a XML namespace with the specified prefix and URI for the current node list and all node lists that are derived from the current node list. After registering, you can use the <code>nodelist[&quot;prefix:localname&quot;]</code> or <code>nodelist[&quot;@prefix:localname&quot;]</code> syntaxes to reach elements and attributes whose names are namespace-scoped. Note that the namespace prefix need not match the actual prefix used by the XML document itself since namespaces are compared solely by their URI.</td>
</tr>
<tr class="odd">
<td><code>_text</code></td>
<td>the text of current nodes, one string per node (non-recursive). Applicable to elements, attributes, comments, processing instructions (returns its data) and CDATA sections. The reserved XML characters ('&lt;' and '&amp;') are not escaped.</td>
</tr>
<tr class="even">
<td><code>_type</code></td>
<td>Returns a node list containing one string per node describing the type of the node. Possible node type names are: &quot;attribute&quot;, &quot;cdata&quot;, &quot;comment&quot;, &quot;document&quot;, &quot;documentType&quot;, &quot;element&quot;, &quot;entity&quot;, &quot;entityReference&quot;, &quot;processingInstruction&quot;, &quot;text&quot;. If the type of the node is unknown, returns &quot;unknown&quot;.</td>
</tr>
<tr class="odd">
<td><code>_unique</code></td>
<td>a copy of the current nodes that keeps only the first occurrence of every node, eliminating duplicates. Duplicates can occur in the node list by applying uptree-traversals <code>_parent</code>, <code>_ancestor</code>, <code>_ancestorOrSelf</code>, and <code>_document</code>. I.e. <code>foo._children._parent</code> will return a node list that has duplicates of nodes in foo - each node will have the number of occurrences equal to the number of its children. In these cases, use <code>foo._children._parent._unique</code> to eliminate duplicates. Applicable to all node types.</td>
</tr>
<tr class="even">
<td>any other key</td>
<td>element children of current nodes with name matching the key. This allows for convenience child traversal in <code>book.chapter.title</code> style syntax. Note that <code>nodeset.childname</code> is technically equivalent to <code>nodeset(&quot;childname&quot;)</code>, but is both shorter to write and evaluates faster. Applicable to document and element nodes.</td>
</tr>
</tbody>
</table>
<h3>TemplateMethodModel</h3>
<p>When used as a method model, it returns a node list that is the result of evaluating an XPath expression on the current contents of the node list. For this feature to work, you must have the <code>Jaxen</code> library in your classpath. For example:</p>
<pre><code>&lt;#assign firstChapter=xmldoc(&quot;//chapter[first()]&quot;)&gt;</code></pre>
<h3>Namespace handling</h3>
<p>For purposes of traversal of children elements that have namespace-scoped names, you can register namespace prefixes with the node list. You can do it either in Java, calling the</p>
<pre><code>public void registerNamespace(String prefix, String uri);</code></pre>
<p>method, or inside a template using the</p>
<pre><code>${nodelist._registerNamespace(prefix, uri)}</code></pre>
<p>syntax. From there on, you can refer to children elements in the namespace denoted by the particular URI through the syntax</p>
<pre><code>nodelist[&quot;prefix:localName&quot;]</code></pre>
<p>and</p>
<pre><code>nodelist[&quot;@prefix:localName&quot;]</code></pre>
<p>as well as use these namespace prefixes in XPath expressions. Namespaces registered with a node list are propagated to all node lists that are derived from the original node list. Note also that namespaces are matched by their URI only, so you can safely use a prefix for a namespace inside your template that differs from the prefix in the actual XML document - a prefix is just a local alias for the URI both in the template and in the XML document.</p>
<h2 id="pgui_misc_ant">Using FreeMarker with Ant</h2>
ant task
<p>There are two “FreeMarker Ant tasks” that we know about:</p>
<ul>
<li><p><code>FreemarkerXmlTask</code>: It comes with the FreeMarker distribution, packed into the <code>freemarker.jar</code>. This is a lightweight, easy-to-use Ant task for transforming XML documents with FreeMarker templates. Its approach is that the source files (input files) are XML files, which are rendered to corresponding output files, by a single template. That is, for each XML file, the template will be executed (with the XML document in the data-model), and the template output will be written into a file of similar name than the name of the XML file. Thus, the template file plays a similar role as an XSLT style sheet, but it is FTL, not XSLT.</p></li>
<li><p>command-line FMPP: It's a more heavyweight, less XML centric, third party Ant task (and standalone command-line tool). Its primary approach is that the source files (input files) are template files that generate the corresponding output files themselves, but it also supports the approach of <code>FreemarkerXmlTask</code> for the source files that are XML-s. Also, it has extra features over the <code>FreemarkerXmlTask</code>. What's its drawback then? As it is more complex and more generalized, it's harder to learn and use it.</p></li>
</ul>
<p>This section introduces the <code>FreemarkerXmlTask</code>. For more information about FMPP visit its homepage: <a href="http://fmpp.sourceforge.net/" class="uri">http://fmpp.sourceforge.net/</a>.</p>
<p>In order to use the <code>FreemarkerXmlTask</code>, you must first define the <code>freemarker.ext.ant.FreemarkerXmlTask</code> inside your Ant buildfile, then call the task. Suppose you want to transform several XML documents to HTML using the hypothetical &quot;xml2html.ftl&quot; template, with XML documents located in the directory &quot;xml&quot; and HTML documents generated into directory &quot;html&quot;. You would write something like:</p>
<pre><code>&lt;taskdef name=&quot;freemarker&quot; classname=&quot;freemarker.ext.ant.FreemarkerXmlTask&quot;&gt;
  &lt;classpath&gt;
    &lt;pathelement location=&quot;freemarker.jar&quot; /&gt;
  &lt;/classpath&gt;
&lt;/taskdef&gt;
&lt;mkdir dir=&quot;html&quot; /&gt;
&lt;freemarker basedir=&quot;xml&quot; destdir=&quot;html&quot; includes=&quot;**/*.xml&quot; template=&quot;xml2html.ftl&quot; /&gt;</code></pre>
<p>The task would invoke the template for every XML document. Every document would be parsed into a DOM tree, then wrapped as a FreeMarker node variable. When template processing begins, the special variable, <code>.node</code>, is set to the root node of the XML document.</p>
<p>Note that if you are using the legacy (FreeMarker 2.2.x and earlier) XML adapter implementation, that still works, and the root of the XML tree is placed in the data-model as the variable <code>document</code>. That contains an instance of the legacy <code>freemarker.ext.xml.NodeListModel</code> class.</p>
<p>Note that all properties defined by the build file would be made available as a hash model named &quot;properties&quot;. Several other models are made available; for detailed description of what variables are made available to templates as well as what other attributes can the task accept, see the JavaDoc for <code>freemarker.ext.ant.FreemarkerXmlTask</code>.</p>
<h2 id="pgui_misc_jythonwrapper">Jython wrapper</h2>
wrapping
jython
jython
wrapping
<p>The <code>freemarker.ext.jython</code> package consists of models that enable any Jython object to be used as a <code>TemplateModel</code>. In the very basic case, you only need to call the</p>
<pre><code>public TemplateModel wrap(Object obj);</code></pre>
<p>method of the <code>freemarker.ext.jython.JythonWrapper</code> class. This method will wrap the passed object into an appropriate <code>TemplateModel</code>. Below is a summary of the properties of returned model wrappers. Let's assume that the model that resulted from the <code>JythonWrapper</code> call on object <code>obj</code> is named <code>model</code> in the template model root for the sake of the following discussion.</p>
<h3>TemplateHashModel functionality</h3>
<p><code>PyDictionary</code> and <code>PyStringMap</code> will be wrapped into a hash model. Key lookups are mapped to the <code>__finditem__</code> method; if an item is not found, a model for <code>None</code> is returned.</p>
<h3>TemplateScalarModel functionality</h3>
<p>Every python object will implement <code>TemplateScalarModel</code> whose <code>getAsString()</code> method simply delegates to <code>toString()</code>.</p>
<h3>TemplateBooleanModel functionality</h3>
<p>Every python object will implement <code>TemplateBooleanModel</code> whose <code>getAsBoolean()</code> method simply delegates to <code>__nonzero__()</code> in accordance with Python semantics of true/false.</p>
<h3>TemplateNumberModel functionality</h3>
<p>Model wrappers for <code>PyInteger</code>, <code>PyLong</code>, and <code>PyFloat</code> objects implement <code>TemplateNumberModel</code> whose <code>getAsNumber()</code> method returns <code>__tojava__(java.lang.Number.class)</code>.</p>
<h3>TemplateSequenceModel functionality</h3>
<p>Model wrappers for all classes that extend <code>PySequence</code> will implement <code>TemplateSequenceModel</code> and thus their elements will be accessible by index using the <code>model[i]</code> syntax, which will delegate to <code>__finditem__(i)</code>. You can also query the length of the array or the size of the list using the <code>model?size</code> built-in, which will delegate to <code>__len__()</code>.</p>
<h1 id="ref_builtins">Built-in Reference</h1>
built-in
<h2 id="ref_builtins_alphaidx">Alphabetical index</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>As of FreeMarker 2.3.23, you can use camel case instead of snake case for directive names, like <code>startsWith</code> instead of <code>starts_with</code>. But know that then within the same template, FreeMarker will enforce the usage of camel case for all identifiers that are part of the template language (user defined names are not affected).</p>
</blockquote>
built-in
<ul>
<li><p><a href="#ref_builtin_abs">abs</a></p></li>
<li><p><a href="#ref_builtin_ancestors">ancestors</a></p></li>
<li><p><a href="#ref_buitin_api_and_has_api">api</a></p></li>
<li><p><a href="#ref_builtin_boolean">boolean</a></p></li>
<li><p><a href="#ref_builtin_numType">byte</a></p></li>
<li><p>c <a href="#ref_builtin_c">for strings</a>, <a href="#ref_builtin_c_boolean">for booleans</a></p></li>
<li><p><a href="#ref_builtin_cap_first">cap_first</a></p></li>
<li><p><a href="#ref_builtin_capitalize">capitalize</a></p></li>
<li><p><a href="#ref_builtin_rounding">ceiling</a></p></li>
<li><p><a href="#ref_builtin_children">children</a></p></li>
<li><p><a href="#ref_builtin_chop_linebreak">chop_linebreak</a></p></li>
<li><p><a href="#ref_builtin_chunk">chunk</a></p></li>
<li><p><a href="#ref_builtin_contains">contains</a></p></li>
<li><p><a href="#ref_builtin_counter">counter</a></p></li>
<li><p>date <a href="#ref_builtin_date_datetype">for dates</a>, <a href="#ref_builtin_string_date">for strings</a></p></li>
<li><p><a href="#ref_builtin_date_if_unknown">date_if_unknown</a></p></li>
<li><p>datetime <a href="#ref_builtin_date_datetype">for dates</a>, <a href="#ref_builtin_string_date">for strings</a></p></li>
<li><p><a href="#ref_builtin_date_if_unknown">datetime_if_unknown</a></p></li>
<li><p><a href="#ref_builtin_numType">double</a></p></li>
<li><p><a href="#ref_builtin_esc">esc</a></p></li>
<li><p><a href="#ref_builtin_ends_with">ends_with</a></p></li>
<li><p><a href="#ref_builtin_ensure_ends_with">ensure_ends_with</a></p></li>
<li><p><a href="#ref_builtin_ensure_starts_with">ensure_starts_with</a></p></li>
<li><p><a href="#ref_builtin_eval">eval</a></p></li>
<li><p><a href="#ref_builtin_first">first</a></p></li>
<li><p><a href="#ref_builtin_rounding">floor</a></p></li>
<li><p><a href="#ref_builtin_groups">groups</a></p></li>
<li><p><a href="#ref_builtin_numType">float</a></p></li>
<li><p><a href="#ref_buitin_api_and_has_api">has_api</a></p></li>
<li><p><a href="#ref_builtin_has_content">has_content</a></p></li>
<li><p><a href="#ref_builtin_has_next">has_next</a></p></li>
<li><p><a href="#ref_builtin_html">html</a></p></li>
<li><p><a href="#ref_builtin_index">index</a></p></li>
<li><p><a href="#ref_builtin_index_of">index_of</a></p></li>
<li><p><a href="#ref_builtin_numType">int</a></p></li>
<li><p><a href="#ref_builtin_interpret">interpret</a></p></li>
<li><p><a href="#ref_builtin_item_cycle">item_cycle</a></p></li>
<li><p><a href="#ref_builtin_item_parity">item_parity</a></p></li>
<li><p><a href="#ref_builtin_item_parity_cap">item_parity_cap</a></p></li>
<li><p><a href="#ref_builtin_is_even_item">is_even_item</a></p></li>
<li><p><a href="#ref_builtin_first">is_first</a></p></li>
<li><p><a href="#ref_builtin_is_infinite">is_infinite</a></p></li>
<li><p><a href="#ref_builtin_is_last">is_last</a></p></li>
<li><p><a href="#ref_builtin_is_nan">is_nan</a></p></li>
<li><p><a href="#ref_builtin_is_odd_item">is_odd_item</a></p></li>
<li><p><a href="#ref_builtin_isType">is_type</a></p></li>
<li><p><a href="#ref_builtin_date_iso">iso, iso_...</a></p></li>
<li><p><a href="#ref_builtin_j_string">j_string</a></p></li>
<li><p><a href="#ref_builtin_join">join</a></p></li>
<li><p><a href="#ref_builtin_js_string">js_string</a></p></li>
<li><p><a href="#ref_builtin_keep_after">keep_after</a></p></li>
<li><p><a href="#ref_builtin_keep_after_last">keep_after_last</a></p></li>
<li><p><a href="#ref_builtin_keep_before">keep_before</a></p></li>
<li><p><a href="#ref_builtin_keep_before_last">keep_before_last</a></p></li>
<li><p><a href="#ref_builtin_keys">keys</a></p></li>
<li><p><a href="#ref_builtin_last">last</a></p></li>
<li><p><a href="#ref_builtin_last_index_of">last_index_of</a></p></li>
<li><p><a href="#ref_builtin_left_pad">left_pad</a></p></li>
<li><p><a href="#ref_builtin_length">length</a></p></li>
<li><p><a href="#ref_builtin_numType">long</a></p></li>
<li><p><a href="#ref_builtin_lower_abc">lower_abc</a></p></li>
<li><p><a href="#ref_builtin_lower_case">lower_case</a></p></li>
<li><p><a href="#ref_builtin_markup_string">markup_string</a></p></li>
<li><p><a href="#ref_builtin_matches">matches</a></p></li>
<li><p><a href="#ref_builtin_namespace">namespace</a></p></li>
<li><p><a href="#ref_builtin_new">new</a></p></li>
<li><p><a href="#ref_builtin_next_sibling">next_sibling</a></p></li>
<li><p><a href="#ref_builtin_no_esc">no_esc</a></p></li>
<li><p><a href="#ref_builtin_node_namespace">node_namespace</a></p></li>
<li><p><a href="#ref_builtin_node_name">node_name</a></p></li>
<li><p><a href="#ref_builtin_node_type">node_type</a></p></li>
<li><p><a href="#ref_builtin_number">number</a></p></li>
<li><p><a href="#ref_builtin_numToDate">number_to_date, number_to_datetime, number_to_time</a></p></li>
<li><p><a href="#ref_builtin_parent">parent</a></p></li>
<li><p><a href="#ref_builtin_previous_sibling">previous_sibling</a></p></li>
<li><p><a href="#ref_builtin_replace">replace</a></p></li>
<li><p><a href="#ref_builtin_remove_beginning">remove_beginning</a></p></li>
<li><p><a href="#ref_builtin_remove_ending">remove_ending</a></p></li>
<li><p><a href="#ref_builtin_reverse">reverse</a></p></li>
<li><p><a href="#ref_builtin_right_pad">right_pad</a></p></li>
<li><p><a href="#ref_builtin_rounding">round</a></p></li>
<li><p><a href="#ref_builtin_root">root</a></p></li>
<li><p><a href="#ref_builtin_rtf">rtf</a></p></li>
<li><p><a href="#ref_builtin_numType">short</a></p></li>
<li><p><a href="#ref_builtin_size">size</a></p></li>
<li><p><a href="#ref_builtin_sort">sort</a></p></li>
<li><p><a href="#ref_builtin_seq_contains">seq_contains</a></p></li>
<li><p><a href="#ref_builtin_seq_index_of">seq_index_of</a></p></li>
<li><p><a href="#ref_builtin_seq_last_index_of">seq_last_index_of</a></p></li>
<li><p><a href="#ref_builtin_sequence">sequence</a></p></li>
<li><p><a href="#ref_builtin_sort_by">sort_by</a></p></li>
<li><p><a href="#ref_builtin_split">split</a></p></li>
<li><p><a href="#ref_builtin_starts_with">starts_with</a></p></li>
<li><p>string: <a href="#ref_builtin_string_for_string">for strings</a>, <a href="#ref_builtin_string_for_number">for numbers</a>, <a href="#ref_builtin_string_for_boolean">for booleans</a>, <a href="#ref_builtin_string_for_date">for date/time/date-time</a></p></li>
<li><p><a href="#ref_builtin_substring">substring</a> (deprecated)</p></li>
<li><p><a href="#ref_builtin_switch">switch</a></p></li>
<li><p><a href="#ref_builtin_then">then</a></p></li>
<li><p>time <a href="#ref_builtin_date_datetype">for date/time/date-time</a>, <a href="#ref_builtin_string_date">for strings</a></p></li>
<li><p><a href="#ref_builtin_date_if_unknown">time_if_unknown</a></p></li>
<li><p><a href="#ref_builtin_trim">trim</a></p></li>
<li><p><a href="#ref_builtin_uncap_first">uncap_first</a></p></li>
<li><p><a href="#ref_builtin_upper_abc">upper_abc</a></p></li>
<li><p><a href="#ref_builtin_upper_case">upper_case</a></p></li>
<li><p><a href="#ref_builtin_url">url</a></p></li>
<li><p><a href="#ref_builtin_values">values</a></p></li>
<li><p><a href="#ref_builtin_word_list">word_list</a></p></li>
<li><p><a href="#ref_builtin_xhtml">xhtml</a></p></li>
<li><p><a href="#ref_builtin_xml">xml</a></p></li>
</ul>
<p>See the built-ins filtered by left-hand-value type <a href="#ref_builtins">here</a>.</p>
<p>If you don't find a built-in here that you have seen in a working template, probably you will find it here: <a href="#ref_deprecated">Deprecated FTL constructs</a></p>
<h2 id="ref_builtins_string">Built-ins for strings</h2>
string
built-ins
<p>These built-ins act on a string left-value. However, if the left-value is number or date/time/date-time or boolean (since 2.3.20), it will automatically converted to string according the current number-, date/time/date-time- and boolean-format settings (which are the same formatters that are applied when inserting such values with <code>${...}</code>).</p>
<h3 id="ref_builtin_boolean">boolean</h3>
type-casting
converting between types
boolean built-in
string to boolean
converting string to boolean
parse string as boolean
<p>The string converted to boolean value. The string must be <code>true</code> or <code>false</code> (case sensitive!), or must be in the format specified by the <code>boolean_format</code> setting.</p>
<p>If the string is not in the appropriate format, an error will abort template processing when you try to access this built-in.</p>
<h3 id="ref_builtin_cap_first">cap_first</h3>
cap_first built-in
<p>The string with the very first word of the string capitalized. For the precise meaning of “word” see the <a href="#ref_builtin_word_list">word_list built-in</a>. Example:</p>
<pre><code>${&quot;  green mouse&quot;?cap_first}
${&quot;GreEN mouse&quot;?cap_first}
${&quot;- green mouse&quot;?cap_first}</code></pre>
<p>The output:</p>
<pre><code>  Green mouse
GreEN mouse
- green mouse</code></pre>
<p>In the case of <code>&quot;- green mouse&quot;</code>, the first word is the <code>-</code>.</p>
<h3 id="ref_builtin_capitalize">capitalize</h3>
capitalize built-in
<p>The string with all words capitalized. For the precise meaning of “word” see the <a href="#ref_builtin_word_list">word_list built-in</a>. Example:</p>
<pre><code>${&quot;  green  mouse&quot;?capitalize}
${&quot;GreEN mouse&quot;?capitalize}</code></pre>
<p>The output:</p>
<pre><code>  Green Mouse
Green Mouse</code></pre>
<h3 id="ref_builtin_chop_linebreak">chop_linebreak</h3>
chop_linebreak built-in
<p>The string without the <a href="#gloss.lineBreak">line-break</a> at its very end if there was a line-break, otherwise the unchanged string.</p>
<h3 id="ref_builtin_contains">contains</h3>
contains built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.1. It doesn't exist in 2.3.</p>
</blockquote>
<p>Returns if the substring specified as the parameter to this built-in occurrs in the string. For example:</p>
<pre><code>&lt;#if &quot;piceous&quot;?contains(&quot;ice&quot;)&gt;It contains &quot;ice&quot;&lt;/#if&gt;</code></pre>
<p>This will output:</p>
<pre><code>It contains &quot;ice&quot;</code></pre>
<h3 id="ref_builtin_string_date">date, time, datetime</h3>
type-casting
converting between types
date built-in
time built-in
datetime built-in
string to date
string to time
converting string to date
converting string to time
parsing string as date
parsing string as time
XML Schema date parsing
XML Schema time parsing
ISO 8601 parsing
<p>The string value converted to a date, time, or date-time value. It will expect the format specified by the <a href="#topic.dateTimeFormatSettings"><code>date_format</code>, <code>time_format</code> and <code>datetime_format</code> settings</a>. If the string is not in the appropriate format, an error will abort template processing when you try to access this built-in.</p>
<pre><code>&lt;#-- The date_format, time_format and datetime_format settings must match this format! --&gt;
&lt;#assign someDate = &quot;Oct 25, 1995&quot;?date&gt;
&lt;#assign someTime = &quot;3:05:30 PM&quot;?time&gt;
&lt;#assign someDatetime = &quot;Oct 25, 1995 03:05:00 PM&quot;?datetime&gt;

&lt;#-- Changing the setting value changes the expected format: --&gt;
&lt;#setting datetime_format=&quot;iso&quot;&gt;
&lt;#assign someDatetime = &quot;1995-10-25T15:05&quot;?datetime&gt;</code></pre>
<p>You can also specify the format explicitly like <code>?datetime.format</code> (and hence also as <code>?datetime[&quot;format&quot;]</code>) or <code>?datetime(&quot;format&quot;)</code>; these three forms do the same. The format can be specified similarly with <code>?date</code> and <code>?time</code> too. For the syntax and meaning of format values see the possible values of the <a href="#topic.dateTimeFormatSettings"><code>date_format</code>, <code>time_format</code> and <code>datetime_format</code> settings</a>. Example:</p>
<pre><code>&lt;#-- Parsing XML Schema xs:date, xs:time and xs:dateTime values: --&gt;
&lt;#assign someDate = &quot;1995-10-25&quot;?date.xs&gt;
&lt;#assign someTime = &quot;15:05:30&quot;?time.xs&gt;
&lt;#assign someDatetime = &quot;1995-10-25T15:05:00&quot;?datetime.xs&gt;

&lt;#-- Parsing ISO 8601 (both extended and basic formats): --&gt;
&lt;#assign someDatetime = &quot;1995-10-25T15:05&quot;?datetime.iso&gt;
&lt;#assign someDatetime = &quot;19951025T1505&quot;?datetime.iso&gt;

&lt;#-- Parsing with SimpleDateFormat patterns: --&gt;
&lt;#assign someDate = &quot;10/25/1995&quot;?date(&quot;MM/dd/yyyy&quot;)&gt;
&lt;#assign someTime = &quot;15:05:30&quot;?time(&quot;HH:mm:ss&quot;)&gt;
&lt;#assign someDatetime = &quot;1995-10-25 03:05 PM&quot;?datetime(&quot;yyyy-MM-dd hh:mm a&quot;)&gt;

&lt;#-- Parsing with custom date formats: --&gt;
&lt;#assign someDatetime = &quot;October/25/1995 03:05 PM&quot;?datetime.@worklog&gt;</code></pre>
<p>To prevent misunderstandings, the left-hand value need not be a string literal. For example, when you read data from XML DOM (from where all values come as unparsed strings), you may do things like <code>order.confirmDate?date.xs</code> to convert the string value to a real date.</p>
<p>Of course, the format also can be a variable, like in <code>&quot;...&quot;?datetime(myFormat)</code>.</p>
<p>Note that since 2.3.24, these built-ins can also be called with 0 arguments, like <code>?date()</code>. It's almost the same as just writing <code>?date</code>. The difference is highly technical and rarely matters: <code>?date()</code> and such returns exactly the same Java object that the date parser (<code>freemarker.core.TemplateDateFormat</code> implementation) returns, while <code>?date</code> without the <code>()</code> returns a tricky wrapper value that's a date and a method and hash on the same time.</p>
<h3 id="ref_builtin_ends_with">ends_with</h3>
ends_with built-in
<p>Returns whether this string ends with the substring specified in the parameter. For example <code>&quot;ahead&quot;?ends_with(&quot;head&quot;)</code> returns boolean <code>true</code>. Also, <code>&quot;head&quot;?ends_with(&quot;head&quot;)</code> will return <code>true</code>.</p>
<h3 id="ref_builtin_ensure_ends_with">ensure_ends_with</h3>
ensure_ends_with built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.21.</p>
</blockquote>
<p>If the string doesn't end with the substring specified as the 1st parameter, it adds it after the string, otherwise it returns the original string. For example, both <code>&quot;foo&quot;?ensure_ends_with(&quot;/&quot;)</code> and <code>&quot;foo/&quot;?ensure_ends_with(&quot;/&quot;)</code> returns <code>&quot;foo/&quot;</code>.</p>
<h3 id="ref_builtin_ensure_starts_with">ensure_starts_with</h3>
ensure_ends_with built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.21.</p>
</blockquote>
<p>If the string doesn't start with the substring specified as the 1st parameter, it adds it before the string, otherwise it returns the original string. For example, both <code>&quot;foo&quot;?ensure_starts_with(&quot;/&quot;)</code> and <code>&quot;/foo&quot;?ensure_starts_with(&quot;/&quot;)</code> returns <code>&quot;/foo&quot;</code>.</p>
<p>If you specify two parameters, then the 1st parameter is interpreted as a Java regular expression, and if it doesn't match the beginning of the string, then the string specified as the 2nd parameter is added before the string. For example <code>someURL?ensure_starts_with(&quot;[a-zA-Z]+://&quot;,
          &quot;http://&quot;)</code> will check if the string starts with something that matches <code>&quot;[a-zA-Z]+://&quot;</code> (note that no <code>^</code> is needed), and if it doesn't, it prepends <code>&quot;http://&quot;</code>.</p>
<p>This method also accepts a 3rd <a href="#ref_builtin_string_flags">flags parameter</a>. As calling with 2 parameters implies <code>&quot;r&quot;</code> there (i.e., regular expression mode), you rarely need this. One notable case is when you don't want the 1st parameter to be interpreted as a regular expression, only as plain text, but you want the comparison to be case-insensitive, in which case you would use <code>&quot;i&quot;</code> as the 3rd parameter.</p>
<h3 id="ref_builtin_esc">esc</h3>
<p>esc built-in</p>
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.24.</p>
</blockquote>
<p>Escapes the value with the current <a href="#dgui_misc_autoescaping_outputformat">output format</a>, and prevents the <a href="#dgui_misc_autoescaping">auto-escaping</a> of the returned value (to avoid double escaping). Because of auto-escaping, you usually only need this where auto-escaping was disabled:</p>
<pre><code>&lt;#ftl output_format=&quot;HTML&quot; auto_esc=false&gt;
&lt;#assign s = &quot;R&amp;D&quot;&gt;
${s}
${s?esc}</code></pre>
<pre><code>R&amp;D
R&amp;amp;D</code></pre>
<p>In templates, where auto-escaping is on, using it is redundant:</p>
<pre><code>&lt;#ftl output_format=&quot;HTML&quot;&gt;
&lt;#assign s = &quot;R&amp;D&quot;&gt;
${s}
${s?esc} &lt;#-- ?esc is redundant here --&gt;</code></pre>
<pre><code>R&amp;amp;D
R&amp;amp;D</code></pre>
<p>This built-in works by converting the string value to a <a href="#dgui_misc_autoescaping_movalues">markup output value</a>, by escaping the string with the current output format, and using the result as the markup. The resulting markup output value belongs to the current output format at the point of the invocation.</p>
<p>This built-in can also be applied on markup output values, which it will bypass without change, as far as the input markup output value belongs to the current output format. If it doesn't, then the markup has to be converted to the current output format, which currently (as of 2.3.24) will be only successful if that value was created by escaping plain text (usually, with <code>?esc</code>).</p>
<p>This built-in can't be used where the current output format is a <a href="#dgui_misc_autoescaping_nonmarkupof">non-markup output format</a>. An attempt to do so will cause a <a href="#gloss.parseTimeError">parse-time error</a>.</p>
<p>This built-in is not related to the deprecated <a href="#ref_directive_escape"><code>escape</code> and <code>noescape</code> directives</a>. In fact, the parser will prevent using them on the same place, to prevent confusion.</p>
<h3 id="ref_builtin_groups">groups</h3>
groups built-in
<p>This is used only with the result of the <code>matches</code> built-in. See <a href="#ref_builtin_matches">there...</a></p>
<h3 id="ref_builtin_html">html (deprecated)</h3>
escaping
output
html built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is <em>deprecated</em> by the <a href="#dgui_misc_autoescaping">auto-escaping mechanism</a> introduced in 2.3.24. To prevent double escaping and confusion in general, using this built-in on places where auto-escaping is active is a <a href="#gloss.parseTimeError">parse-time error</a>. To help migration, this built-in silently bypasses HTML <a href="#dgui_misc_autoescaping_movalues">markup output values</a> without changing them.</p>
</blockquote>
<p>The string as HTML markup. That is, the string with all:</p>
<ul>
<li><p><code>&lt;</code> replaced with <code>&amp;lt;</code></p></li>
<li><p><code>&gt;</code> replaced with <code>&amp;gt;</code></p></li>
<li><p><code>&amp;</code> replaced with <code>&amp;amp;</code></p></li>
<li><p><code>&quot;</code> replaced with <code>&amp;quot;</code></p></li>
<li><p><code>'</code> is replaced with <code>&amp;#39;</code> <em>if</em> the programmers has <a href="#pgui_config_incompatible_improvements_how_to_set">set the <code>incompatible_improvements</code> setting</a> to 2.3.24 or higher (also if it's set to 2.3.20 or higher and you are outside a string literal). Otherwise <code>'</code> won't be replaced, so you must use quotation mark (<code>&quot;</code>, not <code>'</code>) to quote attribute values where you want to insert a value safely.</p></li>
</ul>
<pre><code>&lt;input type=text name=user value=&quot;${user?html}&quot;&gt;</code></pre>
<blockquote>
<p><strong>Warning</strong></p>
<p>When inserting the value of an attribute, always quote it, or else it can be exploited by attackers! This is WRONG: <code>&lt;input name=&quot;user&quot; value=${user?xhtml}&gt;</code>. This is good: <code>&lt;input name=&quot;user&quot;
            value=&quot;${user?xhtml}&quot;&gt;</code>.</p>
</blockquote>
<p>Note that in HTML pages usually you want to use this built-in for all interpolations. You can spare a lot of typing and lessen the chances of accidental mistakes by using the <a href="#ref_directive_escape"><code>escape</code> directive</a>.</p>
<h3 id="ref_builtin_index_of">index_of</h3>
index_of built-in
<p>Returns the index within this string of the first occurrence of the specified substring. For example, <code>&quot;abcabc&quot;?index_of(&quot;bc&quot;)</code> will return 1 (don't forget that the index of the first character is 0). Also, you can specify the index to start the search from: <code>&quot;abcabc&quot;?index_of(&quot;bc&quot;, 2)</code> will return 4. There is no restriction on the numerical value of the second parameter: if it is negative, it has the same effect as if it were zero, and if it is greater than the length of this string, it has the same effect as if it were equal to the length of this string. Decimal values will be truncated to integers.</p>
<p>If the 1st parameter does not occur as a substring in this string (starting from the given index, if you use the second parameter), then it returns -1.</p>
<h3 id="ref_builtin_j_string">j_string</h3>
j_string built-in
<p>Escapes the string with the escaping rules of Java language string literals, so it's safe to insert the value into a string literal. Note that it will <em>not</em> add quotation marks around the inserted value; you meant to use this <em>inside</em> the string literal.</p>
<p>All characters under <a href="#gloss.UCS">UCS</a> code point 0x20 will be escaped. When they have no dedicated escape sequence in the Java language (like <code>\n</code>, <code>\t</code>, etc.), they will be replaced with a UNICODE escape (<code>\uXXXX</code>).</p>
<p>Example:</p>
<pre><code>&lt;#assign beanName = &#39;The &quot;foo&quot; bean.&#39;&gt;
String BEAN_NAME = &quot;${beanName?j_string}&quot;;</code></pre>
<p>will output:</p>
<pre><code>String BEAN_NAME = &quot;The \&quot;foo\&quot; bean.&quot;;</code></pre>
<h3 id="ref_builtin_js_string">js_string</h3>
js_string built-in
<p>Escapes the string with the escaping rules of JavaScript language string literals, so it's safe to insert the value into a string literal. Note that it will <em>not</em> add quotation marks around the inserted value; you meant to use this <em>inside</em> the string literal.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>When inserting into a JavaScript string literal that's inside a HTML attribute, you also must escape the value with HTML escaping. Thus, of you don't have <a href="#pgui_config_outputformatsautoesc">automatic HTML escaping</a>, this is WRONG: <code>&lt;p
            onclick=&quot;alert('${message?js_string}')&quot;&gt;</code>, and this is good: <code>&lt;p
            onclick=&quot;alert('${message?js_string?html}')&quot;&gt;</code>.</p>
</blockquote>
<p>Example:</p>
<pre><code>&lt;#assign user = &quot;Big Joe&#39;s \&quot;right hand\&quot;&quot;&gt;
&lt;script&gt;
  alert(&quot;Welcome ${user?js_string}!&quot;);
&lt;/script&gt;</code></pre>
<p>will output:</p>
<pre><code>&lt;script&gt;
  alert(&quot;Welcome Big Joe\&#39;s \&quot;right hand\&quot;!&quot;);
&lt;/script&gt;</code></pre>
<p>The exact escaping rules are:</p>
<ul>
<li><p><code>&quot;</code> is escaped as <code>\&quot;</code></p></li>
<li><p><code>'</code> is escaped as <code>\'</code></p></li>
<li><p><code>\</code> is escaped as <code>\\</code></p></li>
<li><p><code>/</code> is escaped as <code>\/</code> if the <code>/</code> is directly after <code>&lt;</code> in the escaped string, or if it's at the beginning of the escaped string</p></li>
<li><p><code>&gt;</code> is escaped as <code>\&gt;</code> if the <code>&gt;</code> is directly after <code>]]</code> or <code>--</code> in the escaped string, or if it's at the beginning of the escaped string, or if there's only a <code>]</code> or <code>-</code> before it at the beginning of the escaped string</p></li>
<li><p><code>&lt;</code> is escaped as <code>\u003C</code> if it's followed by <code>?</code> or <code>!</code> in the escaped string, or if it's at the end of the escaped string</p></li>
<li><p>Control characters in <a href="#gloss.UCS">UCS</a> code point ranges U+0000...U+001f and U+007f...U+009f are escaped as <code>\r</code>, <code>\n</code>, etc., or as <code>\xXX</code> where there's no special escape for them in JavaScript.</p></li>
<li><p>Control characters with <a href="#gloss.UCS">UCS</a> code point U+2028 (Line separator) and U+2029 (Paragraph separator) are escaped as <code>\uXXXX</code>, as they are source code line-breaks in ECMAScript.</p></li>
</ul>
<h3 id="ref_builtin_json_string">json_string</h3>
json_string built-in
<p>Escapes the string with the escaping rules of JSON language string literals, so it's safe to insert the value into a string literal. Note that it will <em>not</em> add quotation marks around the inserted value; you meant to use this <em>inside</em> the string literal.</p>
<p>This will not escape <code>'</code> characters, since JSON strings must be quoted with <code>&quot;</code>.</p>
<p>The escaping rules are almost identical to those <a href="#ref_builtin_j_string">documented for <code>js_string</code></a>. The differences are that <code>'</code> is not escaped at all, that &gt; is escaped as \u003E (not as \&gt;), and that <code>\uXXXX</code> escapes are used instead of <code>\xXX</code> escapes.</p>
<h3 id="ref_builtin_keep_after">keep_after</h3>
keep_after built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.21.</p>
</blockquote>
<p>Removes the part of the string that is not after the first occurrence of the given substring. For example:</p>
<pre><code>${&quot;abcdefgh&quot;?keep_after(&quot;de&quot;)}</code></pre>
<p>will print</p>
<pre><code>fgh</code></pre>
<p>If the parameter string is not found, it will return an empty string. If the parameter string is a 0-length string, it will return the original string unchanged.</p>
<p>This method accepts an optional <a href="#ref_builtin_string_flags">flags parameter</a>, as its 2nd parameter:</p>
<pre><code>${&quot;foo : bar&quot;?keep_after(r&quot;\s*:\s*&quot;, &quot;r&quot;)}</code></pre>
<p>will print</p>
<pre><code>bar</code></pre>
<h3 id="ref_builtin_keep_after_last">keep_after_last</h3>
keep_after_last built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.22.</p>
</blockquote>
<p>Same as <a href="#ref_builtin_keep_after"><code>keep_after</code></a>, but keeps the part after the last occurrence of the parameter, rather than after the first. Example:</p>
<pre><code>${&quot;foo.bar.txt&quot;?keep_after_last(&quot;.&quot;)}</code></pre>
<p>will print</p>
<pre><code>txt</code></pre>
<p>while with <code>keep_after</code> you would get <code>bar.txt</code>.</p>
<h3 id="ref_builtin_keep_before">keep_before</h3>
keep_before built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.21.</p>
</blockquote>
<p>Removes the part of the string that starts with the given substring. For example:</p>
<pre><code>${&quot;abcdef&quot;?keep_before(&quot;de&quot;)}</code></pre>
<p>will print</p>
<pre><code>abc</code></pre>
<p>If the parameter string is not found, it will return the original string unchanged. If the parameter string is a 0-length string, it will return an empty string.</p>
<p>This method accepts an optional <a href="#ref_builtin_string_flags">flags parameter</a>, as its 2nd parameter:</p>
<pre><code>${&quot;foo : bar&quot;?keep_before(r&quot;\s*:\s*&quot;, &quot;r&quot;)}</code></pre>
<p>will print</p>
<pre><code>foo</code></pre>
<h3 id="ref_builtin_keep_before_last">keep_before_last</h3>
keep_before_last built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.22.</p>
</blockquote>
<p>Same as <a href="#ref_builtin_keep_before"><code>keep_before</code></a>, but keeps the part before the last occurrence of the parameter, rather than after the first. Example:</p>
<pre><code>${&quot;foo.bar.txt&quot;?keep_after_last(&quot;.&quot;)}</code></pre>
<p>will print</p>
<pre><code>foo.bar</code></pre>
<p>while with <code>keep_before</code> you would get <code>foo</code>.</p>
<h3 id="ref_builtin_last_index_of">last_index_of</h3>
last_index_of built-in
<p>Returns the index within this string of the last (rightmost) occurrence of the specified substring. It returns the index of the first (leftmost) character of the substring. For example: <code>&quot;abcabc&quot;?last_index_of(&quot;ab&quot;)</code> will return 3. Also, you can specify the index to start the search from. For example, <code>&quot;abcabc&quot;?last_index_of(&quot;ab&quot;, 2)</code> will return 0. Note that the second parameter indicates the maximum index of the start of the substring. There is no restriction on the numerical value of the second parameter: if it is negative, it has the same effect as if it were zero, and if it is greater than the length of this string, it has the same effect as if it were equal to the length of this string. Decimal values will be truncated to inegers.</p>
<p>If the 1st parameter does not occur as a substring in this string (before the given index, if you use the second parameter), then it returns -1.</p>
<h3 id="ref_builtin_left_pad">left_pad</h3>
left_pad built-in
padding
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.1.</p>
</blockquote>
<p>If it's used with 1 parameter, then it inserts spaces on the beginning of the string until it reaches the length that is specified as the parameter. If the string is already as long or longer than the specified length, then it does nothing. For example, this:</p>
<pre><code>[${&quot;&quot;?left_pad(5)}]
[${&quot;a&quot;?left_pad(5)}]
[${&quot;ab&quot;?left_pad(5)}]
[${&quot;abc&quot;?left_pad(5)}]
[${&quot;abcd&quot;?left_pad(5)}]
[${&quot;abcde&quot;?left_pad(5)}]
[${&quot;abcdef&quot;?left_pad(5)}]
[${&quot;abcdefg&quot;?left_pad(5)}]
[${&quot;abcdefgh&quot;?left_pad(5)}]</code></pre>
<p>will output this:</p>
<pre><code>[     ]
[    a]
[   ab]
[  abc]
[ abcd]
[abcde]
[abcdef]
[abcdefg]
[abcdefgh]</code></pre>
<p>If it's used with 2 parameters, then the 1st parameter means the same as if you were using the built-in with only 1 parameter, and the second parameter specifies what to insert instead of space characters. For example:</p>
<pre><code>[${&quot;&quot;?left_pad(5, &quot;-&quot;)}]
[${&quot;a&quot;?left_pad(5, &quot;-&quot;)}]
[${&quot;ab&quot;?left_pad(5, &quot;-&quot;)}]
[${&quot;abc&quot;?left_pad(5, &quot;-&quot;)}]
[${&quot;abcd&quot;?left_pad(5, &quot;-&quot;)}]
[${&quot;abcde&quot;?left_pad(5, &quot;-&quot;)}]</code></pre>
<p>will output this:</p>
<pre><code>[-----]
[----a]
[---ab]
[--abc]
[-abcd]
[abcde]</code></pre>
<p>The 2nd parameter can be a string whose length is greater than 1. Then the string will be inserted periodically, for example:</p>
<pre><code>[${&quot;&quot;?left_pad(8, &quot;.oO&quot;)}]
[${&quot;a&quot;?left_pad(8, &quot;.oO&quot;)}]
[${&quot;ab&quot;?left_pad(8, &quot;.oO&quot;)}]
[${&quot;abc&quot;?left_pad(8, &quot;.oO&quot;)}]
[${&quot;abcd&quot;?left_pad(8, &quot;.oO&quot;)}]</code></pre>
<p>will output this:</p>
<pre><code>[.oO.oO.o]
[.oO.oO.a]
[.oO.oOab]
[.oO.oabc]
[.oO.abcd]</code></pre>
<p>The 2nd parameter must be a string value, and it must be at least 1 character long.</p>
<h3 id="ref_builtin_length">length</h3>
length built-in
<p>The number of characters in the string.</p>
<h3 id="ref_builtin_lower_case">lower_case</h3>
lower_case built-in
<p>The lower case version of the string. For example <code>&quot;GrEeN MoUsE&quot;?lower_case</code> will be <code>&quot;green
          mouse&quot;</code>.</p>
<h3 id="ref_builtin_matches">matches</h3>
matches built-in
<p>This is a “power user” built-in. Ignore it if you don't know <a href="#gloss.regularExpression">regular expressions</a>.</p>
<p>This built-in determines if the string exactly matches the pattern. Also, it returns the list of matching sub-strings. The return value is a multi-type value:</p>
<ul>
<li><p>Boolean: <code>true</code>, if it the entire string matches the pattern, otherwise <code>false</code>. For example, <code>&quot;fooo&quot;?matches('fo*')</code> is <code>true</code>, but <code>&quot;fooo bar&quot;?matches('fo*')</code> is <code>false</code>.</p></li>
<li><p>Sequence: the list of matched substrings of the string. Possibly a 0 length sequence.</p></li>
</ul>
<p>For example:</p>
<pre><code>&lt;#if &quot;fxo&quot;?matches(&quot;f.?o&quot;)&gt;Matches.&lt;#else&gt;Does not match.&lt;/#if&gt;

&lt;#assign res = &quot;foo bar fyo&quot;?matches(&quot;f.?o&quot;)&gt;
&lt;#if res&gt;Matches.&lt;#else&gt;Does not match.&lt;/#if&gt;
Matching sub-strings:
&lt;#list res as m&gt;
- ${m}
&lt;/#list&gt;</code></pre>
<p>will print:</p>
<pre><code>Matches.

Does not match.
Matching sub-strings:
- foo
- fyo</code></pre>
<p>If the regular expression contains groups (parentheses), then you can access them with the <code>groups</code> built-in:</p>
<pre><code>&lt;#-- Entire input match --&gt;
&lt;#assign res = &quot;John Doe&quot;?matches(r&quot;(\w+) (\w+)&quot;)&gt;
&lt;#if res&gt; &lt;#-- Must not try to access groups if there was no match! --&gt;
  First name: ${res?groups[1]}
  Second name: ${res?groups[2]}
&lt;/#if&gt;

&lt;#-- Subtring matches --&gt;
&lt;#assign res = &quot;aa/rx; ab/r;&quot;?matches(&quot;(.+?)/*(.+?);&quot;)&gt;
&lt;#list res as m&gt;
  - &quot;${m}&quot; is &quot;${m?groups[1]}&quot; per &quot;${m?groups[2]}&quot;
&lt;/#list&gt;</code></pre>
<p>This will print:</p>
<pre><code>  First name: John
  Second name: Doe

  - &quot;aa/rx;&quot; is &quot;a&quot; per &quot;a/rx&quot;
  - &quot; ab/r;&quot; is &quot; &quot; per &quot;ab/r&quot;</code></pre>
<p>Notes regarding the behavior of the <code>groups</code> built-in:</p>
<ul>
<li><p>It works both with substring matches and with the result of entire string matching (as it was shown in the above example)</p></li>
<li><p>The first item in the sequence that <code>groups</code> returns is the whole substring matched by the regular expression. Hence, the index of the first explicit regular expression group (with other words, of the first <code>(...)</code> in the regular expression) is 1, and not 0. Also, because of this, the size of the sequence is one more than the number of explicit regular expression groups.</p></li>
<li><p>The size of the sequence returned by <code>groups</code> only depends on the number of explicit groups in the regular expression, and so it will be the same (non-0) even if there was no match found for the regular expression. Attempting to access an item of the sequence (as in <code>res?groups[1]</code>) when there was match will cause an error. Thus, before accessing the groups, you should always check if there was any match (as in <code>&lt;#if
              res&gt;access the groups
              here&lt;/#if&gt;</code>).</p></li>
<li><p>When there's a match for the regular expression, but not for a certain explicit group inside the regular expression, then for that group the sequence will contain a 0 length string. So accessing a group that matches nothing is safe, as far as the containing regular expression has matched something.</p></li>
</ul>
<p><code>matches</code> accepts an optional 2nd parameter, the <a href="#ref_builtin_string_flags">flags</a>. Note that it doesn't support flag <code>f</code>, and ignores the <code>r</code> flag.</p>
<h3 id="ref_builtin_no_esc">no_esc</h3>
<p>no_esc built-in</p>
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.24.</p>
</blockquote>
<p>Prevents the <a href="#dgui_misc_autoescaping">auto-escaping</a> of a value. For example:</p>
<pre><code>&lt;#ftl output_format=&quot;HTML&quot;&gt;
&lt;#assign s = &quot;&lt;b&gt;Test&lt;/b&gt;&quot;&gt;
${s}
${s?no_esc}</code></pre>
<pre><code>&amp;lt;b&amp;gt;Test&amp;lt;/b&amp;gt;
&lt;b&gt;Test&lt;/b&gt;</code></pre>
<p>This works by converting the string value to a <a href="#dgui_misc_autoescaping_movalues">markup output value</a>, which uses the string as the markup as is, and belongs to the current <a href="#dgui_misc_autoescaping_outputformat">output format</a> at the point of the invocation.</p>
<p>This built-in can also be applied on markup output values, which it will bypass without change, as far as the input markup output value belongs to current output format. If it doesn't, then the markup has to be converted to the current output format, which currently (as of 2.3.24) will be only successful if that value was created by escaping plain text (usually, with <code>?esc</code>).</p>
<p>This built-in can't be used where the current output format is a <a href="#dgui_misc_autoescaping_nonmarkupof">non-markup output format</a>. An attempt to do so will cause a <a href="#gloss.parseTimeError">parse-time error</a>.</p>
<p>This built-in is not related to the deprecated <a href="#ref_directive_escape"><code>escape</code> and <code>noescape</code> directives</a>. In fact, the parser will prevent using them on the same place, to prevent confusion.</p>
<h3 id="ref_builtin_number">number</h3>
type-casting
converting between types
number built-in
string to number
converting string to number
parse string as number
<p>The string converted to numerical value. The number must be in “computer language” format. That is, it must be in the locale independent form, where the decimal separator is dot, and there's no grouping.</p>
<p>This built-in recognizes numbers in the format that the FreeMarker template language uses. In additionally, it recognizes scientific notation (e.g. <code>&quot;1.23E6&quot;</code>, <code>&quot;1.5e-8&quot;</code>). Since FreeMarker 2.3.21, it also recognizes all XML Schema number formats, like <code>NaN</code>, <code>INF</code>, <code>-INF</code>, plus the Java-native formats <code>Infinity</code> and <code>-Infinity</code>.</p>
<p>If the string is not in the appropriate format, an error will abort template processing when you try to access this built-in.</p>
<p>In fact, the string is parsed by the <code>toNumber</code> method of the current <code>arithmetic_engine</code>, which is configuration setting. However, that method should behave similarly as described above.</p>
<h3 id="ref_builtin_replace">replace</h3>
replace built-in
<p>It is used to replace all occurrences of a string in the original string with another string. It does not deal with word boundaries. For example:</p>
<pre><code>${&quot;this is a car acarus&quot;?replace(&quot;car&quot;, &quot;bulldozer&quot;)}</code></pre>
<p>will print:</p>
<pre><code>this is a bulldozer abulldozerus</code></pre>
<p>The replacing occurs in left-to-right order. This means that this:</p>
<pre><code>${&quot;aaaaa&quot;?replace(&quot;aaa&quot;, &quot;X&quot;)}</code></pre>
<p>will print:</p>
<pre><code>Xaa</code></pre>
<p>If the 1st parameter is an empty string, then all occurrences of the empty string will be replaced, like <code>&quot;foo&quot;?replace(&quot;&quot;,&quot;|&quot;)</code> will evaluate to <code>&quot;|f|o|o|&quot;</code>.</p>
<p><code>replace</code> accepts an optional <a href="#ref_builtin_string_flags">flags parameter</a>, as its 3rd parameter.</p>
<h3 id="ref_builtin_right_pad">right_pad</h3>
right_pad built-in
padding
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.1. It doesn't exist in 2.3.</p>
</blockquote>
<p>This is the same as <a href="#ref_builtin_left_pad"><code>left_pad</code></a>, but it inserts the characters at the end of the string instead of the beginning of the string.</p>
<p>Example:</p>
<pre><code>[${&quot;&quot;?right_pad(5)}]
[${&quot;a&quot;?right_pad(5)}]
[${&quot;ab&quot;?right_pad(5)}]
[${&quot;abc&quot;?right_pad(5)}]
[${&quot;abcd&quot;?right_pad(5)}]
[${&quot;abcde&quot;?right_pad(5)}]
[${&quot;abcdef&quot;?right_pad(5)}]
[${&quot;abcdefg&quot;?right_pad(5)}]
[${&quot;abcdefgh&quot;?right_pad(5)}]

[${&quot;&quot;?right_pad(8, &quot;.oO&quot;)}]
[${&quot;a&quot;?right_pad(8, &quot;.oO&quot;)}]
[${&quot;ab&quot;?right_pad(8, &quot;.oO&quot;)}]
[${&quot;abc&quot;?right_pad(8, &quot;.oO&quot;)}]
[${&quot;abcd&quot;?right_pad(8, &quot;.oO&quot;)}]</code></pre>
<p>This will output this:</p>
<pre><code>[     ]
[a    ]
[ab   ]
[abc  ]
[abcd ]
[abcde]
[abcdef]
[abcdefg]
[abcdefgh]

[.oO.oO.o]
[aoO.oO.o]
[abO.oO.o]
[abc.oO.o]
[abcdoO.o]</code></pre>
<h3 id="ref_builtin_remove_beginning">remove_beginning</h3>
remove_beginning built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.21.</p>
</blockquote>
<p>Removes the parameter substring from the beginning of the string, or returns the original string if it doesn't start with the parameter substring. For example:</p>
<pre><code>${&quot;abcdef&quot;?remove_beginning(&quot;abc&quot;)}
${&quot;foobar&quot;?remove_beginning(&quot;abc&quot;)}</code></pre>
<p>will print:</p>
<pre><code>def
foobar</code></pre>
<h3 id="ref_builtin_remove_ending">remove_ending</h3>
remove_ending built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.21.</p>
</blockquote>
<p>Removes the parameter substring from the ending of the string, or returns the original string if it doesn't end with the parameter substring. For example:</p>
<pre><code>${&quot;abcdef&quot;?remove_ending(&quot;def&quot;)}
${&quot;foobar&quot;?remove_ending(&quot;def&quot;)}</code></pre>
<p>will print:</p>
<pre><code>abc
foobar</code></pre>
<h3 id="ref_builtin_rtf">rtf (deprecated)</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is <em>deprecated</em> by the <a href="#dgui_misc_autoescaping">auto-escaping mechanism</a> introduced in 2.3.24. To prevent double escaping and confusion in general, using this built-in on places where auto-escaping is active is a <a href="#gloss.parseTimeError">parse-time error</a>. To help migration, this built-in silently bypasses RTF <a href="#dgui_misc_autoescaping_movalues">markup output values</a> without changing them.</p>
</blockquote>
rtf built-in
escaping
output
<p>The string as Rich text (RTF text). That is, the string with all:</p>
<ul>
<li><p><code>\</code> replaced with <code>\\</code></p></li>
<li><p><code>{</code> replaced with <code>\{</code></p></li>
<li><p><code>}</code> replaced with <code>\}</code></p></li>
</ul>
<h3 id="ref_builtin_split">split</h3>
split built-in
<p>It is used to split a string into a sequence of strings along the occurrences of another string. For example:</p>
<pre><code>&lt;#list &quot;someMOOtestMOOtext&quot;?split(&quot;MOO&quot;) as x&gt;
- ${x}
&lt;/#list&gt;</code></pre>
<p>will print:</p>
<pre><code>- some
- test
- text</code></pre>
<p>Note that it is assumed that all occurrences of the separator is before a new item (except with <code>&quot;r&quot;</code> flag - see later), thus:</p>
<pre><code>&lt;#list &quot;some,,test,text,&quot;?split(&quot;,&quot;) as x&gt;
- &quot;${x}&quot;
&lt;/#list&gt;</code></pre>
<p>will print:</p>
<pre><code>- &quot;some&quot;
- &quot;&quot;
- &quot;test&quot;
- &quot;text&quot;
- &quot;&quot;</code></pre>
<p><code>split</code> accepts an optional <a href="#ref_builtin_string_flags">flags parameter</a>, as its 2nd parameter. There's a historical glitch with the <code>r</code> (regular expression) flag; it removes the empty elements from the end of the resulting list, so with <code>?split(&quot;,&quot;, &quot;r&quot;)</code> in the last example the last <code>&quot;&quot;</code> would be missing from the output.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>To check if a strings ends with something and append it otherwise, use <a href="#ref_builtin_ensure_ends_with">the <code>ensure_ends_with</code> built-in</a>.</p>
</blockquote>
<h3 id="ref_builtin_starts_with">starts_with</h3>
starts_with built-in
<p>Returns if this string starts with the specified substring. For example <code>&quot;redirect&quot;?starts_with(&quot;red&quot;)</code> returns boolean <code>true</code>. Also, <code>&quot;red&quot;?starts_with(&quot;red&quot;)</code> will return <code>true</code>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>To check if a strings starts with something and prepend it otherwise, use <a href="#ref_builtin_ensure_starts_with">the <code>ensure_starts_with</code> built-in</a>.</p>
</blockquote>
<h3 id="ref_builtin_string_for_string">string (when used with a string value)</h3>
<p>Does nothing, just returns the string as-is. The exception is that if the value is a multi-type value (e.g. it is both string and sequence at the same time), then the resulting value will be only a simple string, not a multi-type value. This can be utilized to prevent the artifacts of multi-typing.</p>
<h3 id="ref_builtin_substring">substring (deprecated)</h3>
substring built-in
substring
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is deprecated since FreeMarker 2.3.21 by <a href="#dgui_template_exp_stringop_slice">slicing expressions</a>, like <code>str[from..&lt;toExclusive]</code>, <code>str[from..]</code>, and <code>str[from..*maxLength]</code>.</p>
<p>A warning if you are processing XML: Since slicing expressions work both for sequences and strings, and since XML nodes are typically both sequences and strings at the same time, there the equivalent expression is <code>someXmlNode?string[from..&lt;toExclusive]</code> and <code>exp?string[from..]</code>, as without <code>?string</code> it would slice the node sequence instead of the text value of the node.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>Some of the typical use-cases of string slicing is covered by convenient built-ins: <a href="#ref_builtin_remove_beginning"><code>remove_beginning</code></a>, <a href="#ref_builtin_remove_ending"><code>remove_ending</code></a>, <a href="#ref_builtin_keep_before"><code>keep_before</code></a>, <a href="#ref_builtin_keep_after"><code>keep_after</code></a>, <a href="#ref_builtin_keep_before_last"><code>keep_before_last</code></a>, <a href="#ref_builtin_keep_after_last"><code>keep_after_last</code></a></p>
</blockquote>
<p>Synopsis: <code>exp?substring(from,
          toExclusive)</code>, also callable as <code>exp?substring(from)</code></p>
<p>A substring of the string. <code>from</code> is the index of the first character. It must be a number that is at least 0 and less than or equal with <code>toExclusive</code>, or else an error will abort the template processing. The <code>toExclusive</code> is the index of the character position after the last character of the substring, or with other words, it is one greater than the index of the last character. It must be a number that is at least 0 and less than or equal to the length of the string, or else an error will abort the template processing. If the <code>toExclusive</code> is omitted, then it defaults to the length of the string. If a parameter is a number that is not an integer, only the integer part of the number will be used.</p>
<p>Example:</p>
<pre><code>- ${&#39;abc&#39;?substring(0)}
- ${&#39;abc&#39;?substring(1)}
- ${&#39;abc&#39;?substring(2)}
- ${&#39;abc&#39;?substring(3)}

- ${&#39;abc&#39;?substring(0, 0)}
- ${&#39;abc&#39;?substring(0, 1)}
- ${&#39;abc&#39;?substring(0, 2)}
- ${&#39;abc&#39;?substring(0, 3)}

- ${&#39;abc&#39;?substring(0, 1)}
- ${&#39;abc&#39;?substring(1, 2)}
- ${&#39;abc&#39;?substring(2, 3)}</code></pre>
<p>The output:</p>
<pre><code>- abc
- bc
- c
-

-
- a
- ab
- abc

- a
- b
- c</code></pre>
<h3 id="ref_builtin_trim">trim</h3>
trim built-in
<p>The string without leading and trailing white-space. Example:</p>
<pre><code>(${&quot;  green mouse  &quot;?trim})</code></pre>
<p>The output:</p>
<pre><code>(green mouse)</code></pre>
<h3 id="ref_builtin_uncap_first">uncap_first</h3>
uncap_first built-in
<p>The opposite of <a href="#ref_builtin_cap_first"><code>cap_first</code></a>. The string with the very first word of the string un-capitalized.</p>
<h3 id="ref_builtin_upper_case">upper_case</h3>
upper_case built-in
<p>The upper case version of the string. For example <code>&quot;GrEeN MoUsE&quot;</code> will be <code>&quot;GREEN
          MOUSE&quot;</code>.</p>
<h3 id="ref_builtin_url">url</h3>
url built-in
escaping
URL
encoding
URL
URL escaping
URL encoding
url_escaping_charset
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.1. It doesn't exist in 2.3.</p>
</blockquote>
<p>The string after URL escaping. This means that all non-US-ASCII and reserved URL characters will be escaped with <code>%XX</code>. For example:</p>
<pre><code>&lt;#assign x = &#39;a/b c&#39;&gt;
${x?url}</code></pre>
<p>The output will be (assuming that the charset used for the escaping is an US-ASCII compatible charset):</p>
<pre><code>a%2Fb%20c</code></pre>
<p>Note that it escapes <em>all</em> reserved URL characters (<code>/</code>, <code>=</code>, <code>&amp;</code>, ...etc), so this encoding can be used for encoding query parameter values, for example:</p>
<pre><code>&lt;a href=&quot;foo.cgi?x=${x?url}&amp;y=${y?url}&quot;&gt;Click here...&lt;/a&gt;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Above no HTML encoding (<code>?html</code>) was needed, because URL escaping escapes all reserved HTML characters anyway. But watch: always quote the attribute value, and always with normal quotation mark (<code>&quot;</code>), never with apostrophe quotation mark (<code>'</code>), because apostrophe quotation mark is not escaped by the URL escaping.</p>
</blockquote>
<p>To do URL escaping a <a href="#gloss.charset">charset</a> must be chosen that will be used for calculating the escaped parts (<code>%XX</code>). If you are HTML page author and you don't really understand this, don't worry: the programmers should configure FreeMarker so that it uses the proper charset by default (programmers: see more below...). If you are a more technical minded user, then you may want to know that the charset used is specified by the <code>url_escaping_charset</code> setting, that can be set in template execution time (or, preferably, earlier by the programmers). For example:</p>
<pre><code>&lt;#--
  This will use the charset specified by the programmers
  before the template execution has started.
--&gt;
&lt;a href=&quot;foo.cgi?x=${x?url}&quot;&gt;foo&lt;/a&gt;

&lt;#-- Use UTF-8 charset for URL escaping from now: --&gt;
&lt;#setting url_escaping_charset=&quot;UTF-8&quot;&gt;

&lt;#-- This will surely use UTF-8 charset --&gt;
&lt;a href=&quot;bar.cgi?x=${x?url}&quot;&gt;bar&lt;/a&gt;</code></pre>
<p>Furthermore, you can explicitly specify a charset for a single URL escaping as the parameter to the built-in:</p>
<pre><code>&lt;a href=&quot;foo.cgi?x=${x?url(&#39;ISO-8895-2&#39;)}&quot;&gt;foo&lt;/a&gt;</code></pre>
<p>output encodingoutput charsetIf the <code>url</code> built-in has no parameter, then it will use the charset specified as the value of the <code>url_escaping_charset</code> setting. This setting should be set by the software that encloses FreeMarker (e.g. a Web application framework), because it is not set (<code>null</code>) by default. If it is not set, then FreeMarker falls back using the value of the <code>output_encoding</code> setting, which is also not set by default, so it is again the task of the enclosing software. If the <code>output_encoding</code> setting is not set either, then the parameterless <code>url</code> built-in can't be executed, and it will cause execution time error. Of course, the <code>url</code> built-in with parameter always works.</p>
<p>It's possible to set <code>url_escaping_charset</code> in the template with the <code>setting</code> directive, but it is bad practice, at least in true MVC applications. The <code>output_encoding</code> setting can't be set with the <code>setting</code> directive, so that's surely the task of the enclosing software. You may find more information regarding this <a href="#pgui_misc_charset">here...</a></p>
<h3 id="ref_builtin_url_path">url_path</h3>
url_path built-in
escaping
URL path
encoding
URL path
URL escaping
URL encoding
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.21.</p>
</blockquote>
<p>This is the same as <a href="#ref_builtin_url">the <code>url</code> built-in</a>, except that it doesn't escape slash (<code>/</code>) characters. This meant to be used for converting paths (like paths coming from the OS or some content repository) that use slash (not backslash!) to a path the can be inserted into an URL. The most common reason why this conversion is needed is that folder names or file names might contain non-US-ASCII letters (“national” characters).</p>
<blockquote>
<p><strong>Note</strong></p>
<p>Just like with <a href="#ref_builtin_url">the <code>url</code> built-in</a>, the desired URL escaping charset (or as a fall back, the output encoding) must be set in the FreeMarker configuration settings, or else the built-in will give error. Or, you you have to specify the charset like <code>somePath?url_path('utf-8')</code>.</p>
</blockquote>
<h3 id="ref_builtin_word_list">word_list</h3>
word_list built-in
<p>A sequence that contains all words of the string in the order as they appear in the string. Words are continual character sequences that contain any character but <a href="#gloss.whiteSpace">white-space</a>. Example:</p>
<pre><code>&lt;#assign words = &quot;   a bcd, .   1-2-3&quot;?word_list&gt;
&lt;#list words as word&gt;[${word}]&lt;/#list&gt;</code></pre>
<p>will output:</p>
<pre><code>[a][bcd,][.][1-2-3]</code></pre>
<h3 id="ref_builtin_xhtml">xhtml (deprecated)</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is <em>deprecated</em> by the <a href="#dgui_misc_autoescaping">auto-escaping mechanism</a> introduced in 2.3.24. To prevent double escaping and confusion in general, using this built-in on places where auto-escaping is active is a <a href="#gloss.parseTimeError">parse-time error</a>. To help migration, this built-in silently bypasses HTML <a href="#dgui_misc_autoescaping_movalues">markup output values</a> without changing them.</p>
</blockquote>
xhtml built-in
escaping
output
<p>The string as XHTML text. That is, the string with all:</p>
<ul>
<li><p><code>&lt;</code> replaced with <code>&amp;lt;</code></p></li>
<li><p><code>&gt;</code> replaced with <code>&amp;gt;</code></p></li>
<li><p><code>&amp;</code> replaced with <code>&amp;amp;</code></p></li>
<li><p><code>&quot;</code> replaced with <code>&amp;quot;</code></p></li>
<li><p><code>'</code> replaced with <code>&amp;#39;</code></p></li>
</ul>
<p>The only difference between this built-in and the <code>xml</code> built-in is that the <code>xhtml</code> built-in escapes <code>'</code> as <code>&amp;#39;</code> instead of as <code>&amp;apos;</code>, because some older browsers don't know <code>&amp;apos;</code>.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>When inserting the value of an attribute, always quote it, or else it can be exploited by attacker! This is WRONG: <code>&lt;input name=&quot;user&quot; value=${user?xhtml}/&gt;</code>. These are good: <code>&lt;input name=&quot;user&quot;
            value=&quot;${user?xhtml}&quot;/&gt;</code>, <code>&lt;input
            name=&quot;user&quot; value='${user?xhtml}'/&gt;</code>.</p>
</blockquote>
<h3 id="ref_builtin_xml">xml (deprecated)</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is <em>deprecated</em> by the <a href="#dgui_misc_autoescaping">auto-escaping mechanism</a> introduced in 2.3.24. To prevent double escaping and confusion in general, using this built-in on places where auto-escaping is active is a <a href="#gloss.parseTimeError">parse-time error</a>. To help migration, this built-in silently bypasses XML and HTML <a href="#dgui_misc_autoescaping_movalues">markup output values</a> without changing them.</p>
</blockquote>
xml built-in
escaping
output
<p>The string as XML text. That is, the string with all:</p>
<ul>
<li><p><code>&lt;</code> replaced with <code>&amp;lt;</code></p></li>
<li><p><code>&gt;</code> replaced with <code>&amp;gt;</code></p></li>
<li><p><code>&amp;</code> replaced with <code>&amp;amp;</code></p></li>
<li><p><code>&quot;</code> replaced with <code>&amp;quot;</code></p></li>
<li><p><code>'</code> replaced with <code>&amp;apos;</code></p></li>
</ul>
<blockquote>
<p><strong>Warning</strong></p>
<p>When inserting the value of an attribute, always quote it, or else it can be exploited by attackers! This is WRONG: <code>&lt;input name=&quot;user&quot; value=${user?xml}/&gt;</code>. These are good: <code>&lt;input name=&quot;user&quot;
            value=&quot;${user?xml}&quot;/&gt;</code>, <code>&lt;input name=&quot;user&quot;
            value='${user?xml}'/&gt;</code>.</p>
</blockquote>
<h3 id="ref_builtin_string_flags">Common flags</h3>
<p>Many string built-ins accept an optional string parameter, the so called “flags”. In this string, each letter influences a certain aspect of the behavior of the built-in. For example, letter <code>i</code> means that the built-in should not differentiate the lower and upper-case variation of the same letter. The order of the letters in the flags string is not significant.</p>
<p>This is the complete list of letters (flags):</p>
<ul>
<li><p><code>i</code>: Case insensitive: do not differentiate the lower and upper-case variation of the same letter.</p></li>
<li><p><code>f</code>: First only. That is, replace/find/etc. only the first occurrence of something.</p></li>
<li><p>regular expression built-ins <code>r</code>: The substring to find is a <a href="#gloss.regularExpression">regular expression</a>. FreeMarker uses the variation of regular expressions described at <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html" class="uri">http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html</a> (note that the presence of some pattern features depends on the Java version used).</p></li>
<li><p><code>m</code>: Multi-line mode for regular expressions. In multi-line mode the expressions <code>^</code> and <code>$</code> match just after or just before, respectively, a line terminator or the end of the string. By default these expressions only match at the beginning and the end of the entire string. Note that <code>^</code> and <code>$</code> doesn't match the line-break character itself.</p></li>
<li><p><code>s</code>: Enables dot-all mode for regular expressions (same as Perl singe-line mode). In dot-all mode, the expression <code>.</code> matches any character, including a line terminator. By default this expression does not match line terminators.</p></li>
<li><p><code>c</code>: Permits whitespace and comments in regular expressions.</p></li>
</ul>
<p>Example:</p>
<pre><code>&lt;#assign s = &#39;foo bAr baar&#39;&gt;
${s?replace(&#39;ba&#39;, &#39;XY&#39;)}
i: ${s?replace(&#39;ba&#39;, &#39;XY&#39;, &#39;i&#39;)}
if: ${s?replace(&#39;ba&#39;, &#39;XY&#39;, &#39;if&#39;)}
r: ${s?replace(&#39;ba*&#39;, &#39;XY&#39;, &#39;r&#39;)}
ri: ${s?replace(&#39;ba*&#39;, &#39;XY&#39;, &#39;ri&#39;)}
rif: ${s?replace(&#39;ba*&#39;, &#39;XY&#39;, &#39;rif&#39;)}</code></pre>
<p>This outputs this:</p>
<pre><code>foo bAr XYar
i: foo XYr XYar
if: foo XYr baar
r: foo XYAr XYr
ri: foo XYr XYr
rif: foo XYr baar</code></pre>
<p>This is the table of built-ins that use these common flags, and which supports which flags:</p>
<table>
<thead>
<tr class="header">
<th>Built-in</th>
<th><code>i</code> (ignore case)</th>
<th><code>r</code> (reg. exp.)</th>
<th><code>m</code> (multi-line mode)</th>
<th><code>s</code> (dot-all mode)</th>
<th><code>c</code> (whitesp. and comments)</th>
<th><code>f</code> (first only)</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>replace</code></td>
<td>Yes</td>
<td>Yes</td>
<td>Only with <code>r</code></td>
<td>Only with <code>r</code></td>
<td>Only with <code>r</code></td>
<td>Yes</td>
</tr>
<tr class="even">
<td><code>split</code></td>
<td>Yes</td>
<td>Yes</td>
<td>Only with <code>r</code></td>
<td>Only with <code>r</code></td>
<td>Only with <code>r</code></td>
<td>No</td>
</tr>
<tr class="odd">
<td><code>matches</code></td>
<td>Yes</td>
<td>Ignored</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="even">
<td><code>keep_after</code></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Ignored</td>
</tr>
<tr class="odd">
<td><code>keep_after_last</code></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Ignored</td>
</tr>
<tr class="even">
<td><code>keep_before</code></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Ignored</td>
</tr>
<tr class="odd">
<td><code>keep_before_last</code></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Ignored</td>
</tr>
<tr class="even">
<td><code>ensure_starts_with</code></td>
<td>Yes</td>
<td>Ignored</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Ignored</td>
</tr>
</tbody>
</table>
<h2 id="ref_builtins_number">Built-ins for numbers</h2>
number
built-ins
<p>Related FAQs: Do you have things like 1,000,000 or 1 000 000 instead of 1000000, or something like 3.14 instead of 3,14 or vice versa? See <a href="#faq_number_grouping">this</a> and <a href="#faq_number_decimal_point">this</a> FAQ entry, also note the <code>c</code> built-in above.</p>
<h3 id="ref_builtin_abs">abs</h3>
abs built-in
absolute value
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.20.</p>
</blockquote>
<p>Gives the absolute value of a number. For example <code>x?abs</code> , if <code>x</code> is -5, will evaluate to 5.</p>
<h3 id="ref_builtin_c">c (when used with numerical value)</h3>
c built-in
type-casting
converting between types
format
number
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.3.</p>
</blockquote>
<p>This built-in converts a number to string for a “computer language” as opposed to for human audience. That is, it formats with the rules that programming languages used to use, which is independent of all the locale and number format settings of FreeMarker. It always uses dot as decimal separator, and it never uses grouping separators (like 3,000,000), nor exponential form (like 5E20), nor superfluous leading or trailing 0-s (like 03 or 1.0), nor + sign (like +1). It will print at most 16 digits after the decimal dot, and thus numbers whose absolute value is less than 1E-16 will be shown as 0. This built-in is crucial because be default (like with <code>${x}</code>) numbers are converted to strings with the locale (language, country) specific number formatting, which is for human readers (like 3000000 is possibly printed as 3,000,000). When the number is printed not for human audience (e.g., for a database record ID used as the part of an URL, or as invisible field value in a HTML form, or for printing CSS/JavaScript numerical literals) this built-in must be used to print the number (i.e., use <code>${x?c}</code> instead of <code>${x}</code>), or else the output will be possibly broken depending on the current number formatting settings and locale (like the decimal point is not dot, but comma in many countries) and the value of the number (like big numbers are possibly “damaged” by grouping separators).</p>
<p>If the <code>incompatible_imporvements</code> FreeMarker configuration setting is set to 2.3.24 or higher (also if it's set to 2.3.20 or higher and you are outside a string literal), this built-in will return <code>&quot;INF&quot;</code>, <code>&quot;-INF&quot;</code> and <code>&quot;NaN&quot;</code> for positive/negative infinity and IEEE floating point Not-a-Number, respectively. These are the XML Schema compatible representations of these special values. (Earlier it has returned what <code>java.text.DecimalFormat</code> did with US locale, none of which is understood by any (common) computer language.)</p>
<p>Note that this built-in <a href="#ref_builtin_c_boolean">also works on booleans</a>.</p>
<h3 id="ref_builtin_is_infinite">is_infinite</h3>
is_infinte built-in
infinite
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.20.</p>
</blockquote>
<p>Tells if a number is floating point infinite (according to IEEE 754). For example, <code>someNumber?is_infinite</code> evaluates to <code>true</code> or <code>false</code> depending on if the value of <code>someNumber</code> is infinite or not. Of course, if the underlying number is not of floating point type, this will always return <code>false</code>.</p>
<h3 id="ref_builtin_is_nan">is_nan</h3>
is_nan built-in
NaN
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.20.</p>
</blockquote>
<p>Tells if a number is floating point NaN (according to IEEE 754). For example, <code>someNumber?is_nan</code> evaluates to <code>true</code> or <code>false</code> depending on if the value of <code>someNumber</code> is NaN or not. Of course, if the underlying number is not of floating point type, this will always return <code>false</code>.</p>
<h3 id="ref_builtin_lower_abc">lower_abc</h3>
lower_abc built-in
ABC
alphabetical ordinals
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.22.</p>
</blockquote>
<p>Converts <code>1</code>, <code>2</code>, <code>3</code>, etc., to the string <code>&quot;a&quot;</code>, <code>&quot;b&quot;</code>, <code>&quot;c&quot;</code>, etc. When reaching <code>&quot;z&quot;</code>, it continues like <code>&quot;aa&quot;</code>, <code>&quot;ab&quot;</code>, etc. This is the same logic that you can see in column labels in spreadsheet applications (like Excel or Calc). The lowest allowed number is <code>1</code>. There's no upper limit. If the number is <code>0</code> or less or it isn't an integer number then the template processing will be aborted with error.</p>
<p>Example:</p>
<pre><code>&lt;#list 1..30 as n&gt;${n?lower_abc} &lt;/#list&gt;</code></pre>
<p>Prints:</p>
<pre><code>a b c d e f g h i j k l m n o p q r s t u v w x y z aa ab ac ad </code></pre>
<p>See also: <a href="#ref_builtin_upper_abc"><code>upper_abc</code></a></p>
<h3 id="ref_builtin_rounding">round, floor, ceiling</h3>
rounding
floor built-in
ceiling built-in
round built-in
<blockquote>
<p><strong>Note</strong></p>
<p>The rounding built-ins exist since FreeMarker 2.3.13.</p>
</blockquote>
<p>Converts a number to a whole number using the specified rounding rule:</p>
<ul>
<li><p><code>round</code>: Rounds to the nearest whole number. If the number ends with .5, then it rounds upwards (i.e., towards positive infinity)</p></li>
<li><p><code>floor</code>: Rounds the number downwards (i.e., towards neagative infinity)</p></li>
<li><p><code>ceiling</code>: Rounds the number upwards (i.e., towards positive infinity)</p></li>
</ul>
<p>Example:</p>
<pre><code>&lt;#assign testlist=[
  0, 1, -1, 0.5, 1.5, -0.5,
  -1.5, 0.25, -0.25, 1.75, -1.75]&gt;
&lt;#list testlist as result&gt;
    ${result} ?floor=${result?floor} ?ceiling=${result?ceiling} ?round=${result?round}
&lt;/#list&gt;</code></pre>
<p>Prints:</p>
<pre><code>    0 ?floor=0 ?ceiling=0 ?round=0
    1 ?floor=1 ?ceiling=1 ?round=1
    -1 ?floor=-1 ?ceiling=-1 ?round=-1
    0.5 ?floor=0 ?ceiling=1 ?round=1
    1.5 ?floor=1 ?ceiling=2 ?round=2
    -0.5 ?floor=-1 ?ceiling=0 ?round=0
    -1.5 ?floor=-2 ?ceiling=-1 ?round=-1
    0.25 ?floor=0 ?ceiling=1 ?round=0
    -0.25 ?floor=-1 ?ceiling=0 ?round=0
    1.75 ?floor=1 ?ceiling=2 ?round=2
    -1.75 ?floor=-2 ?ceiling=-1 ?round=-2</code></pre>
<p>These built-ins may be useful in pagination operations and like. If you just want to <em>display</em> numbers in rounded form, then you should rather use the <a href="#ref_builtin_string_for_number"><code>string</code> built-in</a> or the <a href="#ref.setting.number_format"><code>number_format</code> setting</a>.</p>
<h3 id="ref_builtin_string_for_number">string (when used with a numerical value)</h3>
type-casting
converting between types
string built-in
format
number
<p>Converts a number to a string. In its simplest form (<code>expression?string</code>) it uses the default format that the programmer has specified via the <code>number_format</code> and the <code>locale</code> configuration settings. You can also specify a number format explicitly with this built-in, as it will be shown later.</p>
<p>There are four predefined number formats: <code>computer</code>, <code>currency</code>, <code>number</code>, and <code>percent</code>. The exact meaning of these is locale (nationality) specific, and is controlled by the Java platform installation, not by FreeMarker, except for <code>computer</code>, which uses the same formatting as <a href="#ref_builtin_c">the <code>c</code> built-in</a>. There can also be programmer-defined formats, whose name starts with <code>@</code> (programmers <a href="#pgui_config_custom_formats">see more here...</a>). You can use these predefined formats like this:</p>
<pre><code>&lt;#assign x=42&gt;
${x}
${x?string}  &lt;#-- the same as ${x} --&gt;
${x?string.number}
${x?string.currency}
${x?string.percent}
${x?string.computer}</code></pre>
<p>If your locale is US English, this will print:</p>
<pre><code>42
42
42
$42.00
4,200%
42</code></pre>
<p>The output of first three expressions is identical because the first two expressions use the default format, which is “number” here. You can change this default using a setting:</p>
<pre><code>&lt;#setting number_format=&quot;currency&quot;&gt;
&lt;#assign x=42&gt;
${x}
${x?string}  &lt;#-- the same as ${x} --&gt;
${x?string.number}
${x?string.currency}
${x?string.percent}</code></pre>
<p>Will now output:</p>
<pre><code>$42.00
$42.00
42
$42.00
4,200%</code></pre>
<p>since the default number format was set to “currency”.</p>
<p>You can also refer to named custom formats that were defined when configuring FreeMarker (programmers <a href="#pgui_config_custom_formats">see more here</a>), like:</p>
<pre><code>${x?string.@price}
${x?string.@weight}</code></pre>
<p>where the custom format names were “price” and “weight”. This way the templates can just refer to the application-domain meaning, and the exact format can be specified outside the templates, on a single central place. (Programmers can read about <a href="#pgui_config_custom_formats">defining such named formats here...</a>)</p>
<p>Beside named formats, you can specify number format patterns directly, using the <a href="http://docs.oracle.com/javase/7/docs/api/java/text/DecimalFormat.html">Java decimal number format syntax</a> (with some FreeMarker-specific extensions; <a href="#topic.extendedJavaDecimalFormat">see later</a>):</p>
<pre><code>&lt;#assign x = 1.234&gt;
${x?string[&quot;0&quot;]}
${x?string[&quot;0.#&quot;]}
${x?string[&quot;0.##&quot;]}
${x?string[&quot;0.###&quot;]}
${x?string[&quot;0.####&quot;]}

${1?string[&quot;000.00&quot;]}
${12.1?string[&quot;000.00&quot;]}
${123.456?string[&quot;000.00&quot;]}

${1.2?string[&quot;0&quot;]}
${1.8?string[&quot;0&quot;]}
${1.5?string[&quot;0&quot;]} &lt;-- 1.5, rounded towards even neighbor
${2.5?string[&quot;0&quot;]} &lt;-- 2.5, rounded towards even neighbor

${12345?string[&quot;0.##E0&quot;]}</code></pre>
<pre><code>1
1.2
1.23
1.234
1.234

001.00
012.10
123.46

1
2
2 &lt;-- 1.5, rounded towards even neighbor
2 &lt;-- 2.5, rounded towards even neighbor

1.23E4</code></pre>
<p>Note that as in FreeMarker <code>foo.bar</code> is equivalent with <code>foo[&quot;bar&quot;]</code>, you could also write <code>x?string.currency</code> as <code>x?string[&quot;currency&quot;]</code>, but of course that wouldn't be practical. But in the above examples we have to use the square bracket syntax, because the characters involved (numbers, dot, <code>#</code>) aren't allowed syntactically after the dot operator.</p>
<p>For historical reasons, you could also write things like <code>x?string(&quot;0.#&quot;)</code>, which does exactly the same as <code>x?string[&quot;0.#&quot;]</code>.</p>
<p>Following the financial and statistics practice, by default the rounding goes according the so called half-even rule, which means rounding towards the nearest “neighbor”, unless both neighbors are equidistant, in which case, it rounds towards the even neighbor. This was visible in the above example if you look at the rounding of 1.5 and of 2.5, as both were rounded to 2, since 2 is even, but 1 and 3 are odds. The other popular rounding rule, where we always round up when the neighbors are equidistant (and so 2.5 is rounded to 3) is called the half-up rule, and it can be activated as <a href="#topic.extendedJavaDecimalFormat">described later</a>.</p>
<p>As it was shown for the predefined formats earlier, the default formatting of the numbers can be set in the template:</p>
<pre><code>&lt;#setting number_format=&quot;0.##&quot;&gt;
${1.234}</code></pre>
<pre><code>1.23</code></pre>
<p>The default number format also can be specified outside the templates with the FreeMarker API (like with <code>Configuration.setNumberFormat(String)</code>).</p>
<p>Note that as number formatting is locale sensitive, the locale setting also plays role in the formatting:</p>
<pre><code>&lt;#setting number_format=&quot;,##0.00&quot;&gt;
&lt;#setting locale=&quot;en_US&quot;&gt;
US people write:     ${12345678}
&lt;#setting locale=&quot;hu&quot;&gt;
German people write: ${12345678}</code></pre>
<pre><code>US people write:     12,345,678.00
German people write: 12.345.678,00</code></pre>
extended Java decimal format
<p>FreeMarker extends the Java decimal format patterns with extra options. These options are name-value pairs, specified after two semicolons (<code>;;</code>) at the end of the format string, or if you had a negative pattern (which is separated from the normal patter with a semicolon, like in <code>&quot;0.0;minus
            0.0&quot;</code>), the after only one semicolon. For example:</p>
<pre><code>Standard decimal format: ${10002.5?string[&quot;,000&quot;]}
Extended decimal format: ${10002.5?string[&quot;,000;; roundingMode=halfUp groupingSeparator=_&quot;]}</code></pre>
<pre><code>Standard decimal format: 10,002
Extended decimal format: 10_003</code></pre>
<p>Above, in the extended decimal format, we have specified half-up rounding mode and group separator <code>&quot;_&quot;</code>. The table of all options follows (note that these are defined by <code>java.text.DecimalFormat</code> and <code>java.text.DecimalFormatSymbols</code>, not by FreeMarker):</p>
<table>
<thead>
<tr class="header">
<th>Name</th>
<th>Meaning / value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>roundingMode</code></td>
<td>The value is one of <code>up</code>, <code>down</code>, <code>ceiling</code>, <code>floor</code>, <code>halfUp</code>, <code>halfDown</code>, <code>halfEven</code>, and <code>unnecessary</code>. The behavior that most people learns in school is <code>halfUp</code>, but the Java default is <code>halfEven</code> (also called bankers' rounding). (See <a href="http://docs.oracle.com/javase/7/docs/api/java/math/RoundingMode.html">the <code>java.math.RoundingMode</code> API</a> for explanations.)</td>
</tr>
<tr class="even">
<td><code>multipier</code></td>
<td>The number will be shown after multiplied with this integer number.</td>
</tr>
<tr class="odd">
<td><code>decimalSeparator</code></td>
<td>The character separating the integer part from the fraction part (like <code>&quot;.&quot;</code> in <code>3.14</code>).</td>
</tr>
<tr class="even">
<td><code>monetaryDecimalSeparator</code></td>
<td>This is used instead of <code>decimalSeparator</code> when the pattern contains parts that make it a monetary format. (See the <a href="http://docs.oracle.com/javase/7/docs/api/java/text/DecimalFormat.html">Java decimal number format documentation</a> for more.)</td>
</tr>
<tr class="odd">
<td><code>groupingSeparator</code></td>
<td>The single character used for grouping the integer part (like <code>&quot;,&quot;</code> in <code>1,000,000</code>) Note that grouping is turned on by using <code>&quot;,&quot;</code> in the pattern, as shown in the earlier example. If it's not turned on, this option won't have visible effect.</td>
</tr>
<tr class="even">
<td><code>exponentSeparator</code></td>
<td>This string (of arbitrary length) is used to separate the exponent from the part before it. (like <code>&quot;E&quot;</code> in <code>1.23E6</code>). Only has visible effect if the pattern specifies exponential (also known as scientific) format, like <code>&quot;0.##E0&quot;</code>.</td>
</tr>
<tr class="odd">
<td><code>minusSign</code></td>
<td>The single character used as minus sign (like <code>&quot;-&quot;</code> in <code>-1</code>).</td>
</tr>
<tr class="even">
<td><code>infinity</code></td>
<td>The string (of arbitrary length) used to show infinity.</td>
</tr>
<tr class="odd">
<td><code>nan</code></td>
<td>The string (of arbitrary length) used to show not-a-number (NaN).</td>
</tr>
<tr class="even">
<td><code>percent</code></td>
<td>The single character used as the percent symbol (like <code>&quot;%&quot;</code> in <code>50%</code>). Only has visible effect if the pattern contains <code>%</code>.</td>
</tr>
<tr class="odd">
<td><code>perMill</code></td>
<td>The single character used as the per-mill symbol (like <code>&quot;‰&quot;</code> in <code>50021‰</code>). Only has visible effect if the pattern contains <code>‰</code>.</td>
</tr>
<tr class="even">
<td><code>zeroDigit</code></td>
<td>The first character in the 10 character range (of character codes) that contains the digits to be used. For example, if this is <code>A</code>, then 1 will <code>B</code>, 2 will be <code>C</code>, and so on.</td>
</tr>
<tr class="odd">
<td><code>currencyCode</code></td>
<td>Currency ISO 4217 code. Only has effect when the pattern contains parts that make it a monetary format. It's an error to specify a code that's not a known ISO 4217 code in the Java installation.</td>
</tr>
<tr class="even">
<td><code>currencySymbol</code></td>
<td>Currency symbol; shown where the localized currency name is present in the pattern. Overrides the symbol determined based on the <code>currencyCode</code>.</td>
</tr>
</tbody>
</table>
<p>Regarding the syntax of the options:</p>
<ul>
<li><p>The option name and value are separated by equals character (<code>=</code>).</p></li>
<li><p>Options are separated by whitespace and/or optional comma (<code>,</code>)</p></li>
<li><p>The option value can be quoted with apostrophe (<code>'</code>) or normal quotation mark (<code>&quot;</code>) , like <code>exponentSeparator='*10^'</code> or <code>exponentSeparator=&quot;*10^&quot;</code>. If the value itself has to contain the character used for quotation, then it has to be entered twice (like <code>infinity='It''s
                infinite'</code>, but you could also write <code>infinity=&quot;It's infinite&quot;</code>). Backslash has no special meaning.</p></li>
<li><p>Non-string values must not be quoted. Strings only has to be quoted if they contain punctuation or whitespace, or any other non-letter non-digit non-<code>&quot;_&quot;</code> non-<code>&quot;$&quot;</code> characters. Thus, for example, both <code>roundingMode=down</code> and <code>roundingMode=&quot;down&quot;</code> are legal.</p></li>
</ul>
<h3 id="ref_builtin_upper_abc">upper_abc</h3>
upper_abc built-in
ABC
alphabetical ordinals
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.22.</p>
</blockquote>
<p>Same as <a href="#ref_builtin_lower_abc"><code>lower_abc</code></a>, but converts to upper case letters, like <code>&quot;A&quot;</code>, <code>&quot;B&quot;</code>, <code>&quot;C&quot;</code>, …, <code>&quot;AA&quot;</code>, <code>&quot;AB&quot;</code>, etc.</p>
<h2 id="ref_builtins_date">Built-ins for date/time/date-time values</h2>
date
built-ins
time
built-ins
datetime
built-ins
timestamp
built-ins
<h3 id="ref_builtin_date_datetype">date, time, datetime (when used with a date/time/date-time value)</h3>
type-casting
converting between types
date built-in
time built-in
datetime built-in
<p>These built-ins can be used to specify which parts of the date-like variable are in use:</p>
<ul>
<li><p><code>date</code>: Date only, no time of the day.</p></li>
<li><p><code>time</code>: Only the time of the day, no date part</p></li>
<li><p><code>datetime</code>: Both date and time</p></li>
</ul>
<p>Ideally, you do not need to use these built-ins. Unfortunately, because of the technical limitations of the Java platform, FreeMarker sometimes can't find out which parts of a date-like value is a date, a time or a date-time; ask the programmers which variables has this problem. If FreeMarker has to execute an operation where this information is needed -- such as displaying the value as text -- but it does not know which parts are in use, it will stop with error. This is when you have to use these built-ins. For example, assume <code>openingTime</code> is a such problematic variable:</p>
<pre><code>&lt;#assign x = openingTime&gt; &lt;#-- no problem can occur here --&gt;
${openingTime?time} &lt;#-- without ?time it would fail --&gt;
&lt;#-- For the sake of better understanding, consider this: --&gt;
&lt;#assign openingTime = openingTime?time&gt;
${openingTime} &lt;#-- this will work now --&gt;</code></pre>
<p>These built-ins can also be used to convert date-time values to date or time. For example:</p>
<pre><code>Last updated: ${lastUpdated} &lt;#-- assume that lastUpdated is a date-time value --&gt;
Last updated date: ${lastUpdated?date}
Last updated time: ${lastUpdated?time}</code></pre>
<p>will output something like:</p>
<pre><code>Last updated: 04/25/2003 08:00:54 PM
Last updated date: 04/25/2003
Last updated time: 08:00:54 PM</code></pre>
<p>If the left side of the <code>?</code> is string, then these built-ins <a href="#ref_builtin_string_date">convert strings to date/time/date-time</a>.</p>
<h3 id="ref_builtin_date_if_unknown">date_if_unknown, time_if_unknown, datetime_if_unknown</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.21.</p>
</blockquote>
<p>The <code>date_if_unknown</code>, <code>time_if_unknown</code>, <code>datetime_if_unknown</code> built-ins mark a date-like value with some of the sub-types: date without time, time, or date-time, respectively. However, if the value already holds this information, the built-in has no effect. That is, it will never convert the sub-type of a value, it only adds the sub-type if it was unknown.</p>
<h3 id="ref_builtin_date_iso">iso_...</h3>
iso built-in
iso_... built-ins
<blockquote>
<p><strong>Note</strong></p>
<p><em>These built-ins are deprecated</em> since FreeMarker 2.3.21, where the <code>date_format</code>, <code>time_format</code> and <code>datetime_format</code> settings understand <code>&quot;iso&quot;</code> (for ISO 8601:2004 format) and <code>&quot;xs&quot;</code> (for XML Schema format) in additionally to the Java <code>SimpleDateFormat</code> patterns. Thus the default format can be set to ISO 8601, or for one time ISO formatting you can use <code>myDate?string.iso</code>. <a href="#topic.dateTimeFormatSettings">See more here...</a></p>
</blockquote>
<p>These built-ins convert a date, time or date-time value to string that follows ISO 8601:2004 &quot;extended&quot; format.</p>
<p>This built-in has several variations: <code>iso_utc</code>, <code>iso_local</code>, <code>iso_utc_nz</code>, <code>iso_local_nz</code>, <code>iso_utc_m</code>, <code>iso_utc_m_nz</code>, etc. The name is constructed from the following words in this order, each separated with a <code>_</code> from the next:</p>
<ol type="1">
<li><p><code>iso</code> (required)</p></li>
<li><p>Either <code>utc</code> or <code>local</code> (required (except when it's given with a parameter, but see that later)): Specifies whether you want to print the date/time/date-time according to UTC or according the current time zone. The current time zone is decided by the <code>time_zone</code> FreeMarker setting and is normally configured by the programmers outside the templates (but it can also be set in a template, like <code>&lt;#setting
              time_zone=&quot;America/New_York&quot;&gt;</code> for example). Note that if the <code>sql_date_and_time_time_zone</code> FreeMarker setting is set and non-<code>null</code>, then for <code>java.sql.Date</code> and <code>java.sql.Time</code> values (i.e., for date-only and time-only values that are coming from database via SQL) <code>local</code> will mean that time zone instead of the value of the <code>time_zone</code> setting.</p></li>
<li><p>Either <code>h</code> or <code>m</code> or <code>ms</code> (optional): The accuracy of the time part. When omitted, it defaults to seconds accuracy (like <code>12:30:18</code>). <code>h</code> means hours accuracy (like <code>12</code>), <code>m</code> means minutes accuracy (<code>12:30</code>), and <code>ms</code> means milliseconds accuracy (<code>12:30:18.25</code>, where we have 250 ms). Note that when using <code>ms</code>, the milliseconds are displayed as fraction seconds (following the standard) and will not have trailing <code>0</code>-s. Thus, if the the millisecond part happens to be <code>0</code>, the whole fraction second part will be omitted. Also note that the fraction seconds are always separated with a dot , not with comma (to follow the Web conventions and XML Schema time/dateTime canonical format).</p></li>
<li><p><code>nz</code> (optional): <code>nz</code> (like in <code>${foo?utc_local_nz}</code>) stands for “no zone”, which means that the time zone offset (like <code>+02:00</code> or or <code>-04:30</code> or <code>Z</code>) will not be displayed. If this part is omitted (like in <code>${foo?utc_local}</code>) the zone will be displayed, except in two cases:</p>
<ul>
<li><p>If the value is a date (no time part) value (again, ISO 8901 doesn't allow it then)</p></li>
<li><p>If the value is a <code>java.sql.Time</code> and the <code>incompatible_improvements</code> (often set via the Java <code>Configuration</code> constructor parameter) FreeMarker configuration setting is at least 2.3.21 (or 2.3.24 when you are inside a string literal). This is because most databases store time values that aren't in any time zone, but just store hour, minute, second, and decimal second field values, so showing the time zone doesn't make sense.</p></li>
</ul>
<p>Note that since FreeMarker 2.3.19, the offset always contains the minutes for XML Schema date/time/dateTime format compliance. (However, if you primarily generate for the XML Schema format, use the xs format.)</p></li>
</ol>
<p>Example:</p>
<pre><code>&lt;#assign aDateTime = .now&gt;
&lt;#assign aDate = aDateTime?date&gt;
&lt;#assign aTime = aDateTime?time&gt;

Basic formats:
${aDate?iso_utc}
${aTime?iso_utc}
${aDateTime?iso_utc}

Different accuracies:
${aTime?iso_utc_ms}
${aDateTime?iso_utc_m}

Local time zone:
${aDateTime?iso_local}</code></pre>
<p>A possible output (depends on current time and time zone):</p>
<pre><code>Basic formats:
2011-05-16
21:32:13Z
2011-05-16T21:32:13Z

Different accuracies:
21:32:13.868Z
2011-05-16T21:32Z

Local time zone:
2011-05-16T23:32:13+02:00</code></pre>
<p>There is yet another group of <code>iso_...</code> built-in variants, where you omit the <code>local</code> or <code>utc</code> word from the name and instead specify the time zone as a parameter to the built-in. Example:</p>
<pre><code>&lt;#assign aDateTime = .now&gt;
${aDateTime?iso(&quot;UTC&quot;)}
${aDateTime?iso(&quot;GMT-02:30&quot;)}
${aDateTime?iso(&quot;Europe/Rome&quot;)}

The usual variations are supported:
${aDateTime?iso_m(&quot;GMT+02&quot;)}
${aDateTime?iso_m_nz(&quot;GMT+02&quot;)}
${aDateTime?iso_nz(&quot;GMT+02&quot;)}</code></pre>
<p>A possible output (depends on current time and time zone):</p>
<pre><code>2011-05-16T21:43:58Z
2011-05-16T19:13:58-02:30
2011-05-16T23:43:58+02:00

The usual variations are supported:
2011-05-16T23:43+02:00
2011-05-16T23:43
2011-05-16T23:43:58</code></pre>
<p>If the time zone parameter can't be interpreted, the template processing will be terminated with error.</p>
<p>The parameter can be a <code>java.util.TimeZone</code> object too (which is possibly the return value of a Java method, or it's in the data-model), not just a string.</p>
<h3 id="ref_builtin_string_for_date">string (when used with a date/time/date-time value)</h3>
type-casting
converting between types
string built-in
format
date
format
time
format
date-time
format
timestamp
converting date to string
converting time to string
time to string
date to string
<p>This built-in converts a date to a string, with the specified formatting.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>You should need this built-in rarely, as the default format of date/time/date-time values can be specified globally <a href="#topic.dateTimeFormatSettings">with the <code>date_format</code>, <code>time_format</code> and <code>datetime_format</code> settings</a> of FreeMarker. Use this built-in only at the places where the desired format differs from the one normally used. For the other places the default format should be set properly by the programmers, outside the templates.</p>
</blockquote>
<p>The desired format can be specified like <code>?string.format</code> or <code>?string[&quot;format&quot;]</code>(or the historical equivalent, <code>?string(&quot;format&quot;)</code>). These are equivalent, except that with the quoted formats you can include any characters in the <code>format</code>, like spaces. The syntax of <code>format</code> is exactly the same as of the <code>date_format</code>, <code>time_format</code> and <code>datetime_format</code> configuration settings; <a href="#topic.dateTimeFormatSettings">see the documentation of the possible values there</a>.</p>
<p>Example: If the locale of the output is U.S. English, and the time zone is the U.S. Pacific Time zone, and <code>openingTime</code> is a <code>java.sql.Time</code>, <code>nextDiscountDay</code> is <code>java.sql.Date</code> and <code>lastUpdated</code> is <code>java.sql.Timestamp</code> or <code>java.util.Date</code> then this:</p>
<pre><code>&lt;#-- Predefined format names: --&gt;

${openingTime?string.short}
${openingTime?string.medium}
${openingTime?string.long}
${openingTime?string.full}
${openingTime?string.xs} &lt;#-- XSD xs:time --&gt;
${openingTime?string.iso} &lt;#-- ISO 8601 time --&gt;

${nextDiscountDay?string.short}
${nextDiscountDay?string.medium}
${nextDiscountDay?string.long}
${nextDiscountDay?string.full}
${nextDiscountDay?string.xs} &lt;#-- XSD xs:date --&gt;
${nextDiscountDay?string.iso} &lt;#-- ISO 8601 date --&gt;

${lastUpdated?string.short}
${lastUpdated?string.medium}
${lastUpdated?string.long}
${lastUpdated?string.full}
${lastUpdated?string.medium_short} &lt;#-- medium date, short time --&gt;
${lastUpdated?string.xs} &lt;#-- XSD xs:dateTime --&gt;
${lastUpdated?string.iso} &lt;#-- ISO 8601 combined date and time --&gt;

&lt;#-- Programmer-defined named format (@ + name): --&gt;
${lastUpdated?string.@fileDate}

&lt;#-- Advanced ISO 8601 and XSD formatting: --&gt;
${lastUpdated?string.iso_m_u}
${lastUpdated?string.xs_ms_nz}

&lt;#-- SimpleDateFormat patterns: --&gt;
${lastUpdated?string[&quot;dd.MM.yyyy, HH:mm&quot;]}
${lastUpdated?string[&quot;EEEE, MMMM dd, yyyy, hh:mm a &#39;(&#39;zzz&#39;)&#39;&quot;]}
${lastUpdated?string[&quot;EEE, MMM d, &#39;&#39;yy&quot;]}
${lastUpdated?string.yyyy} &lt;#-- Same as ${lastUpdated?string[&quot;yyyy&quot;]} --&gt;</code></pre>
<p>will print something like this:</p>
<pre><code>01:45 PM
01:45:09 PM
01:45:09 PM PST
01:45:09 PM PST
13:45:09-08:00
13:45:09-08:00

2/20/07
Apr 20, 2007
April 20, 2007
Friday, April 20, 2007
2007-02-20-08:00
2007-02-20

2/20/07 01:45 PM
Feb 20, 2007 01:45:09 PM
February 20, 2007 01:45:09 PM PST
Friday, February 20, 2007 01:45:09 PM PST
Feb 8, 2003 9:24 PM
2007-02-20T13:45:09-08:00
2007-02-20T13:45:09-08:00

Apr/20/2007 13:45

2007-02-20T21:45Z
2007-02-20T13:45:09.000

08.04.2003 21:24
Tuesday, April 08, 2003, 09:24 PM (PDT)
Tue, Apr 8, &#39;03
2003</code></pre>
<p>Note that with custom formats like in <code>lastUpdated?string.@fileDate</code> above, templates can just refer to the application-domain meaning, and the exact format can be specified outside the templates, on a central place. (Programmers can read about <a href="#pgui_config_custom_formats">defining such named formats here...</a>)</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>Unfortunately, because of the limitations of the Java platform, it can happen that you have date-like variables in the data-model, where FreeMarker can't decide if the variable is a date (year, month, day), or a time (hour, minute, second, millisecond) or a date-time. In this case, FreeMarker doesn't know how to display the value when you write something like <code>${lastUpdated?string.short}</code> or <code>${lastUpdated?string.xs}</code>, i.e., a format that doesn't specify the exact fields to display, or if you simply use <code>${lastUpdated}</code>. Then it will have to stop with error. To prevent this, you can help FreeMarker with the <a href="#ref_builtin_date_datetype"><code>?date</code>, <code>?time</code> and <code>?datetime</code> built-ins</a>. For example: <code>${lastUpdated?datetime?string.short}</code>. Ask the programmers if certain variables of the data-model have this problem, or always use <code>?date</code>, <code>?time</code> and <code>?datetime</code> built-ins to be on the safe side.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>You never need to use <code>?date</code>, <code>?time</code> or <code>?datetime</code> with format patterns like <code>&quot;yyyy.MM.dd HH:mm&quot;</code>, since with the pattern you tell FreeMarker what parts of the date to show. However, FreeMarker will trust you blindly, so you can show &quot;noise&quot; if you display parts that are actually not stored in the variable. For example, <code>${openingTime?string[&quot;yyyy-MM-dd
            hh:mm:ss a&quot;]}</code>, where <code>openingTime</code> stores only time, will display <code>1970-01-01 09:24:44
            PM</code>.</p>
</blockquote>
<p>To prevent misunderstandings, the format need not be a string literal, it can be a variable or any other expression as far as it evaluates to a string. For example, it can be like <code>&quot;...&quot;?string[myFormat]</code>.</p>
<p>See also: <a href="#dgui_template_valueinserion_universal_date">the interpolation of dates</a></p>
<h2 id="ref_builtins_boolean">Built-ins for booleans</h2>
boolean
built-ins
<h3 id="ref_builtin_c_boolean">c (when used with boolean)</h3>
c built-in
type-casting
converting between types
format
boolean
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.20.</p>
</blockquote>
<p>This built-in converts a boolean to string for a “computer language” as opposed to for human audience. The result will be <code>&quot;true&quot;</code> or <code>&quot;false&quot;</code>, regardless of the <code>boolean_format</code> setting. When generating JavaScript and such, this should be used, as otherwise changing the <code>boolean_format</code> can break the generated computer-language output.</p>
<p>Note that this built-in <a href="#ref_builtin_c">also works on strings</a>.</p>
<h3 id="ref_builtin_string_for_boolean">string (when used with a boolean value)</h3>
boolean
printing
type-casting
converting between types
string built-in
format
boolean
<p><em>All usages of this built-in has been deprecated; see below.</em></p>
<p>Converts a boolean to a string. You can use it in two ways:</p>
<ul>
<li><p>As <code>foo?string(&quot;yes&quot;, &quot;no&quot;)</code>: <em>Deprecated starting from FreeMarker 2.3.23: use <a href="#ref_builtin_then"><code>?then(&quot;yes&quot;,
              &quot;no&quot;)</code></a> instead.</em>This will return the first parameter (here: <code>&quot;yes&quot;</code>) if the boolean is true, otherwise the second parameter (here: <code>&quot;no&quot;</code>). Note that the return value is always a string; if the parameters were numbers, they would be converted to strings first. Also note that both parameters are evaluated, despite that only one of them will be used; this might have negative impact if the parameters aren't just literals.</p></li>
<li><p><code>foo?string</code>: <em>Deprecated starting from FreeMarker 2.3.20: use <a href="#ref_builtin_c_boolean"><code>?c</code></a> instead, or set the <code>boolean_format</code> <a href="#ref_directive_setting">setting</a> to something like <code>&quot;yes,no&quot;</code> and then the conversion can happen automatically</em>. If you still need to know about this, this will convert the boolean to string using the default strings for representing true and false values. By default, true is rendered as <code>&quot;true&quot;</code> and false is rendered as <code>&quot;false&quot;</code>. This is mostly useful if you generate source code with FreeMarker <em>(but use <code>?c</code> for that starting from 2.3.20)</em>, since the values are not locale (language, country) sensitive. To change these default strings, you can use the <code>boolean_format</code> <a href="#ref_directive_setting">setting</a>.</p>
<p>Note, that in the very rare case when a value is multi-typed and is both a boolean and a string, then the string value of the variable will be returned, and so the <code>boolean_format</code> setting will have no effect.</p></li>
</ul>
<h3 id="ref_builtin_then">then</h3>
then built-in
ternary operator
format; boolean
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.23.</p>
</blockquote>
<p>Used like <code>booleanExp?then(whenTrue,
          whenFalse)</code>, fills the same role as the ternary operator in C-like languages (i.e., <code>booleanExp ?
          whenTrue :
          whenFalse</code>). If <code>booleanExp</code> evaluates to boolean true then it evaluates and returns its first argument, or else if <code>booleanExp</code> evaluates to boolean false then it evaluates and return its second argument. Off course, all three expression can be arbitrary complex. The argument expressions can have any type, even different types.</p>
<p>An important special property of this built-in is that only one of the argument expressions will be evaluated. This is unlike with normal method calls, where all argument expressions are evaluated, regardless if the method will need them. This also means that the argument that's not needed can even refer to missing variables without causing error. (It still can't be syntactically invalid of course.)</p>
<p>Example:</p>
<pre><code>&lt;#assign foo = true&gt;
${foo?then(&#39;Y&#39;, &#39;N&#39;)}

&lt;#assign foo = false&gt;
${foo?then(&#39;Y&#39;, &#39;N&#39;)}

&lt;#assign x = 10&gt;
&lt;#assign y = 20&gt;
&lt;#-- Prints 100 plus the maximum of x and y: --&gt;
${100 + (x &gt; y)?then(x, y)}</code></pre>
<pre><code>Y

N

120</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>If you need to choose based on a non-boolean value, you should use the <a href="#ref_builtin_switch"><code>switch</code> built-in</a> instead of nesting multiple <code>then</code>-s into each other, like <code>priority?switch(1, &quot;low&quot;, 2, &quot;medium&quot;, 3,
            &quot;high&quot;)</code>, or even <code>true?switch(priority &lt;= 1,
            &quot;low&quot;, priority == 2, &quot;medium&quot;, priority &gt;= 3,
            &quot;high&quot;)</code>.</p>
</blockquote>
<h2 id="ref_builtins_sequence">Built-ins for sequences</h2>
sequence
built-ins
<h3 id="ref_builtin_chunk">chunk</h3>
chunk built-in
tabular printing of sequences
columnar printing of sequences
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.3.</p>
</blockquote>
<p>This built-in splits a sequence into multiple sequences of the size given with the 1st parameter to the built-in (like <code>mySeq?chunk(3)</code>). The result is the sequence of these sequences. The last sequence is possibly shorter than the given size, unless the 2nd parameter is given (like <code>mySeq?chunk(3, '-')</code>), that is the item used to make up the size of the last sequence to the given size. Example:</p>
<pre><code>&lt;#assign seq = [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;, &#39;h&#39;, &#39;i&#39;, &#39;j&#39;]&gt;

&lt;#list seq?chunk(4) as row&gt;
  &lt;#list row as cell&gt;${cell} &lt;/#list&gt;
&lt;/#list&gt;

&lt;#list seq?chunk(4, &#39;-&#39;) as row&gt;
  &lt;#list row as cell&gt;${cell} &lt;/#list&gt;
&lt;/#list&gt;</code></pre>
<p>The output will be:</p>
<pre><code>  a b c d
  e f g h
  i j

  a b c d
  e f g h
  i j - -
 </code></pre>
<p>This built in is mostly for outputting sequnces in tabular/columnar format. When used with HTML tables, the 2nd parameter is often <code>&quot;\xA0&quot;</code> (that is the code of the no-break space character, also known as “nbsp”), so the border of the empty TD-s will not be missing.</p>
<p>The 1st parameter must be a number that is at least 1. If the number is not integer, it will be silently rounded down to integer (i.e. both 3.1 and 3.9 will be rounded to 3). The 2nd parameter can be of any type and value.</p>
<h3 id="ref_builtin_first">first</h3>
first built-in
<p>Returns the first item of the sequence. Thus <code>value?first</code> is the same as <code>value[0]</code>, except that, since FreeMarker 2.3.26, <code>value?first</code> also works if <code>value</code> doesn't support getting items with numerical index, but still supports to be listed (i.e., with FTL collection values).</p>
<p>If the sequence or collection is empty, the result will be a missing value (as in <code>empty?first!'No item was
          found'</code>).</p>
<h3 id="ref_builtin_join">join</h3>
join built-in
<p>Concatenates the items of a sequence to a single string, with the given separator. For example:</p>
<pre><code>&lt;#assign colors = [&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;]&gt;
${colors?join(&quot;, &quot;)}</code></pre>
<p>will output:</p>
<pre><code>red, green, blue</code></pre>
<p>Sequence items that are not strings will be converted to string with the same conversion rules as of <code>${...}</code> (except, of course, no automatic escaping is applied at this stage).</p>
<p><code>?join(...)</code> can have up to 3 parameters:</p>
<ol type="1">
<li><p>Separator, required: The string that is inserted between items</p></li>
<li><p>Empty value, defaults to <code>&quot;&quot;</code> (empty string): The value used if the sequence contains no items.</p></li>
<li><p>List ending, defaults to <code>&quot;&quot;</code> (empty string): The value printed after the last value, if the list sequence wasn't empty.</p></li>
</ol>
<p>So this (where <code>[]</code> means an empty sequence):</p>
<pre><code>${colors?join(&quot;, &quot;, &quot;-&quot;)}
${[]?join(&quot;, &quot;, &quot;-&quot;)}

${colors?join(&quot;, &quot;, &quot;-&quot;, &quot;.&quot;)}
${[]?join(&quot;, &quot;, &quot;-&quot;, &quot;.&quot;)}</code></pre>
<p>will output:</p>
<pre><code>red, green, blue
-

red, green, blue.
-</code></pre>
<p>Sequences coming from Java might contain <code>null</code> values. Those values will be ignored by this built-in, exactly like if they were removed from the list.</p>
<h3 id="ref_builtin_last">last</h3>
last built-in
<p>The last subvariable of the sequence. Template processing will die with error if the sequence is empty.</p>
<h3 id="ref_builtin_reverse">reverse</h3>
reverse built-in
<p>The sequence with reversed order.</p>
<h3 id="ref_builtin_seq_contains">seq_contains</h3>
seq_contains built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.1. It doesn't exist in 2.3.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>The <code>seq_</code> prefix is required in the built-in name to differentiate it from the <a href="#ref_builtin_contains"><code>contains</code> built-in</a> that searches a substring in a string (since a variable can be both string and sequence on the same time).</p>
</blockquote>
<p>Tells if the sequence contains the specified value. It has 1 parameter, the value to find. Example:</p>
<pre><code>&lt;#assign x = [&quot;red&quot;, 16, &quot;blue&quot;, &quot;cyan&quot;]&gt;
&quot;blue&quot;: ${x?seq_contains(&quot;blue&quot;)?string(&quot;yes&quot;, &quot;no&quot;)}
&quot;yellow&quot;: ${x?seq_contains(&quot;yellow&quot;)?string(&quot;yes&quot;, &quot;no&quot;)}
16: ${x?seq_contains(16)?string(&quot;yes&quot;, &quot;no&quot;)}
&quot;16&quot;: ${x?seq_contains(&quot;16&quot;)?string(&quot;yes&quot;, &quot;no&quot;)}</code></pre>
<p>The output will be:</p>
<pre><code>&quot;blue&quot;: yes
&quot;yellow&quot;: no
16: yes
&quot;16&quot;: no</code></pre>
<p>To find the value the built-in uses FreeMarker's comparison rules (as if you was using <a href="#dgui_template_exp_comparison"><code>==</code> operator</a>), except that comparing two values of different types or of types for which FreeMarker doesn't support comparison will not cause error, just will be evaluated as the two values are not equal. Thus, you can use it only to find scalar values (i.e. string, number, boolean or date/time values). For other types the result will be always <code>false</code>.</p>
<p>For fault tolerance, this built-in also works with collections.</p>
<h3 id="ref_builtin_seq_index_of">seq_index_of</h3>
seq_index_of built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.1. It doesn't exist in 2.3.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>The <code>seq_</code> prefix is required in the built-in name to differentiate it from the <a href="#ref_builtin_index_of"><code>index_of</code> built-in</a> that searches a substring in a string (since a variable can be both string and sequence on the same time).</p>
</blockquote>
<p>Returns the index of the first occurrence of a value in the sequence, or <code>-1</code> if the sequence doesn't contain the specified value. The value to find is specified as the first parameter. For example this template:</p>
<pre><code>&lt;#assign colors = [&quot;red&quot;, &quot;green&quot;, &quot;blue&quot;]&gt;
${colors?seq_index_of(&quot;blue&quot;)}
${colors?seq_index_of(&quot;red&quot;)}
${colors?seq_index_of(&quot;purple&quot;)}</code></pre>
<p>will output this:</p>
<pre><code>2
0
-1</code></pre>
<p>To find the value the built-in uses FreeMarker's comparison rules (as if you was using <a href="#dgui_template_exp_comparison"><code>==</code> operator</a>), except that comparing two values of different types or of types for which FreeMarker doesn't support comparison will not cause error, just will be evaluated as the two values are not equal. Thus, you can use it only to find scalar values (i.e. string, number, boolean or date/time values). For other types the result will be always <code>-1</code>.</p>
<p>The index where the searching is started can be optionally given as the 2nd parameter. This may be useful if the same item can occur for multiple times in the same sequence. There is no restriction on the numerical value of the second parameter: if it is negative, it has the same effect as if it were zero, and if it is greater than the length of the sequence, it has the same effect as if it were equal to the length of the sequence. Decimal values will be truncated to integers. For example:</p>
<pre><code>&lt;#assign names = [&quot;Joe&quot;, &quot;Fred&quot;, &quot;Joe&quot;, &quot;Susan&quot;]&gt;
No 2nd param: ${names?seq_index_of(&quot;Joe&quot;)}
-2: ${names?seq_index_of(&quot;Joe&quot;, -2)}
-1: ${names?seq_index_of(&quot;Joe&quot;, -1)}
 0: ${names?seq_index_of(&quot;Joe&quot;, 0)}
 1: ${names?seq_index_of(&quot;Joe&quot;, 1)}
 2: ${names?seq_index_of(&quot;Joe&quot;, 2)}
 3: ${names?seq_index_of(&quot;Joe&quot;, 3)}
 4: ${names?seq_index_of(&quot;Joe&quot;, 4)}</code></pre>
<p>will output this:</p>
<pre><code>No 2nd param: 0
-2: 0
-1: 0
 0: 0
 1: 2
 2: 2
 3: -1
 4: -1</code></pre>
<h3 id="ref_builtin_seq_last_index_of">seq_last_index_of</h3>
seq_last_index_of built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.1. It doesn't exist in 2.3.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>The <code>seq_</code> prefix is required in the built-in name to differentiate it from the <a href="#ref_builtin_last_index_of"><code>last_index_of</code> built-in</a> that searches a substring in a string (since a variable can be both string and sequence on the same time).</p>
</blockquote>
<p>Returns the index of the last occurrence of a value in the sequence, or <code>-1</code> if the sequence doesn't contain the specified value. That is, it is the same as <a href="#ref_builtin_seq_index_of"><code>seq_index_of</code></a>, just it searches backward starting from the last item of the sequence. It also supports the optional 2nd parameter that specifies the index where the searching is started. For example:</p>
<pre><code>&lt;#assign names = [&quot;Joe&quot;, &quot;Fred&quot;, &quot;Joe&quot;, &quot;Susan&quot;]&gt;
No 2nd param: ${names?seq_last_index_of(&quot;Joe&quot;)}
-2: ${names?seq_last_index_of(&quot;Joe&quot;, -2)}
-1: ${names?seq_last_index_of(&quot;Joe&quot;, -1)}
 0: ${names?seq_last_index_of(&quot;Joe&quot;, 0)}
 1: ${names?seq_last_index_of(&quot;Joe&quot;, 1)}
 2: ${names?seq_last_index_of(&quot;Joe&quot;, 2)}
 3: ${names?seq_last_index_of(&quot;Joe&quot;, 3)}
 4: ${names?seq_last_index_of(&quot;Joe&quot;, 4)}</code></pre>
<p>will output this:</p>
<pre><code>No 2nd param: 2
-2: -1
-1: -1
 0: 0
 1: 0
 2: 2
 3: 2
 4: 2</code></pre>
<h3 id="ref_builtin_size">size</h3>
size built-in
<p>The number of sub variables in sequence (as a numerical value). The highest possible index in sequence <code>s</code> is <code>s?size - 1</code> (since the index of the first subvariable is 0) assuming that the sequence has at least one subvariable.</p>
<h3 id="ref_builtin_sort">sort</h3>
sort built-in
sequence
sorting
<p>Returns the sequence sorted in ascending order. (For descending order use this and then the <a href="#ref_builtin_reverse"><code>reverse</code> built in</a>.) This will work only if all sub variables are strings, or if all sub variables are numbers, or if all sub variables are date values (date, time, or date+time), or if all sub variables are booleans (since 2.3.17). If the sub variables are strings, it uses locale (language) specific lexical sorting (which is usually not case sensitive). For example:</p>
<pre><code>&lt;#assign ls = [&quot;whale&quot;, &quot;Barbara&quot;, &quot;zeppelin&quot;, &quot;aardvark&quot;, &quot;beetroot&quot;]?sort&gt;
&lt;#list ls as i&gt;${i} &lt;/#list&gt;</code></pre>
<p>will print (with US locale at least):</p>
<pre><code>aardvark Barbara beetroot whale zeppelin</code></pre>
<h3 id="ref_builtin_sort_by">sort_by</h3>
sort_by built-in
sequence
sorting
<p>Returns the sequence of hashes sorted by the given hash subvariable in ascending order. (For descending order use this and then the <a href="#ref_builtin_reverse"><code>reverse</code> built in</a>.) The rules are the same as with the <a href="#ref_builtin_sort"><code>sort</code> built-in</a>, except that the sub variables of the sequence must be hashes, and you have to give the name of a hash subvariable that will decide the order. For example:</p>
<pre><code>&lt;#assign ls = [
  {&quot;name&quot;:&quot;whale&quot;, &quot;weight&quot;:2000},
  {&quot;name&quot;:&quot;Barbara&quot;, &quot;weight&quot;:53},
  {&quot;name&quot;:&quot;zeppelin&quot;, &quot;weight&quot;:-200},
  {&quot;name&quot;:&quot;aardvark&quot;, &quot;weight&quot;:30},
  {&quot;name&quot;:&quot;beetroot&quot;, &quot;weight&quot;:0.3}
]&gt;
Order by name:
&lt;#list ls?sort_by(&quot;name&quot;) as i&gt;
- ${i.name}: ${i.weight}
&lt;/#list&gt;

Order by weight:
&lt;#list ls?sort_by(&quot;weight&quot;) as i&gt;
- ${i.name}: ${i.weight}
&lt;/#list&gt;</code></pre>
<p>will print (with US locale at least):</p>
<pre><code>Order by name:
- aardvark: 30
- Barbara: 53
- beetroot: 0.3
- whale: 2000
- zeppelin: -200

Order by weight:
- zeppelin: -200
- beetroot: 0.3
- aardvark: 30
- Barbara: 53
- whale: 2000</code></pre>
<p>If the subvariable that you want to use for the sorting is on a deeper level (that is, if it is a subvariable of a subvariable and so on), then you can use a sequence as parameter, that specifies the names of the sub variables that lead down to the desired subvariable. For example:</p>
<pre><code>&lt;#assign members = [
    {&quot;name&quot;: {&quot;first&quot;: &quot;Joe&quot;, &quot;last&quot;: &quot;Smith&quot;}, &quot;age&quot;: 40},
    {&quot;name&quot;: {&quot;first&quot;: &quot;Fred&quot;, &quot;last&quot;: &quot;Crooger&quot;}, &quot;age&quot;: 35},
    {&quot;name&quot;: {&quot;first&quot;: &quot;Amanda&quot;, &quot;last&quot;: &quot;Fox&quot;}, &quot;age&quot;: 25}]&gt;
Sorted by name.last:
&lt;#list members?sort_by([&#39;name&#39;, &#39;last&#39;]) as m&gt;
- ${m.name.last}, ${m.name.first}: ${m.age} years old
&lt;/#list&gt;</code></pre>
<p>will print (with US locale at least):</p>
<pre><code>Sorted by name.last:
- Crooger, Fred: 35 years old
- Fox, Amanda: 25 years old
- Smith, Joe: 40 years old</code></pre>
<h2 id="ref_builtins_hash">Built-ins for hashes</h2>
hash
built-ins
<h3 id="ref_builtin_keys">keys</h3>
keys built-in
<p>A sequence that contains all the lookup keys in the hash.</p>
<pre><code>&lt;#assign myHash = { &quot;name&quot;: &quot;mouse&quot;, &quot;price&quot;: 50 }&gt;
&lt;#list myHash?keys as k&gt;
  ${k}
&lt;/#list&gt;</code></pre>
<pre><code>  name
  price</code></pre>
<p>Note that not all hashes support this (ask the programmer if a certain hash allows this or not).</p>
<p>Since hashes do not define an order for their sub variables in general, the order in which key names are returned can be arbitrary. However, some hashes maintain a meaningful order (ask the programmer if a certain hash does that or not). For example, hashes created with the above <code>{...}</code> syntax preserve the same order as you have specified the sub variables.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>To list both the keys and the values, you can use <code>&lt;#list attrs as key,
            value&gt;...&lt;#list&gt;</code>; see the <a href="#ref.directive.list"><code>list</code> directive</a>.</p>
</blockquote>
<h3 id="ref_builtin_values">values</h3>
values built-in
<p>A sequence that contains all the variables (the values in the key-value pairs) in the hash.</p>
<pre><code>&lt;#assign myHash = { &quot;name&quot;: &quot;mouse&quot;, &quot;price&quot;: 50 }&gt;
&lt;#list myHash?values as v&gt;
  ${v}
&lt;/#list&gt;</code></pre>
<pre><code>  mouse
  50</code></pre>
<p>Note that not all hashes support this (ask the programmer if a certain hash allows this or not).</p>
<p>As of the order in which the values are returned, the same applies as with the <code>keys</code> built-in; see there. Furthermore, it's not guaranteed that the order of the values corresponds to the order of the keys returned by the <code>keys</code> build-in.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>To list both the keys and the values, you can use <code>&lt;#list attrs as key,
            value&gt;...&lt;#list&gt;</code>; see the <a href="#ref.directive.list"><code>list</code> directive</a>.</p>
</blockquote>
<h2 id="ref_builtins_node">Built-ins for nodes (for XML)</h2>
node
built-ins
<p>Note that the variables returned by these built-ins are generated by the node variable implementation it is used with. This means that the returned variables can have extra features in additional to what it stated here, for example, with the <a href="#xgui_expose_dom">XML DOM nodes</a> the sequence retuned by the <code>children</code> built-in also can be used as hash and maybe as string, as it is described in the <a href="#xgui">part about XML processing</a>.</p>
<h3 id="ref_builtin_ancestors">ancestors</h3>
ancestors built-in
<p>A sequence that contains all the node's ancestors, starting with the immediate parent and ending with the root node. The result of this built-in is also a method, by which you can filter the result with the <a href="#gloss.fullQualifiedName">full-qualified name</a> of the node. For example as <code>node?ancestors(&quot;section&quot;)</code> to get the sequence of all ancestors with name <code>section</code>.</p>
<h3 id="ref_builtin_children">children</h3>
children built-in
<p>A sequence that contains all of this node's child nodes (i.e. immediate descendant nodes).</p>
<p>XML: This is almost the same as special hash key <code>*</code>, except that it returns all nodes, not only elements. So the possible children are element nodes, text nodes, comment nodes, processing instruction nodes, etc. but <em>not</em> attribute nodes. Attribute nodes are excluded from the sequence.</p>
<h3 id="ref_builtin_node_name">node_name</h3>
node_name built-in
<p>Returns the string that is used to determine what user-defined directive to invoke to handle this node when it is “visited”. See: the <a href="#ref.directive.visit">visit</a> and <a href="#ref.directive.recurse">recurse</a> directives.</p>
<p>XML: If the node is an element or attribute, then the string will be the local (prefix free) name of the element or attribute. Otherwise the name usually starts with <code>@</code> followed by the node type. See <a href="#misc.xguiTable">this table</a>. Note that this node name is not the same as the node name returned in the DOM API; the goal of FreeMarker node names is to give the name of the used-defined directive that will process the node.</p>
<h3 id="ref_builtin_next_sibling">next_sibling</h3>
next_sibling built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is only available since 2.3.26</p>
</blockquote>
<p>Returns the following sibling node of the node. (Two nodes in a tree are said to be siblings if they are on the same level and are directly next to each other.) If there's no such node, the expression <code>node?next_sibling??</code> evaluates to <code>false</code>.</p>
<p>XML: Note that the value returned by this built-in is also a sequence of length 1 (same as the result of some XPath expressions), however if there's no next sibling, the result is a missing value (null) instead of an empty sequence. Also note that for XML element nodes you can also use <code>node.@@next_sibling_element</code>, which is practical if you want to ignore the whitespace that separates two apparently sibling elements; see more <a href="#xgui_imperative_formal">here...</a></p>
<blockquote>
<p><strong>Note</strong></p>
<p>For custom node implementations this built-in is only supported if that implements the <code>freemarker.template.TemplateNodeModelEx</code> interface.</p>
</blockquote>
<h3 id="ref_builtin_node_namespace">node_namespace</h3>
node_namespace built-in
<p>Returns the namespace string of the node. FreeMarker does not define the exact meaning of node namespace; it depends on what your node variables are modeling. It's possible that a node doesn't have any node namespace defined. In this case, the built-in should evaluate to undefined variable (i.e. <code>node?node_namespace??</code> is <code>false</code>), so you can't use the returned value.</p>
<p>XML: In the case of XML, it's the XML namespace URI (such as <code>&quot;http://www.w3.org/1999/xhtml&quot;</code>). If an element or attribute node does not use XML namespace, then this built-in evaluates to an empty string. For other XML nodes this built-in always return undefined variable.</p>
<h3 id="ref_builtin_node_type">node_type</h3>
node_type built-in
<p>A string that describes the type of the node. FreeMarker does not define the exact meaning of node type; it depends on what your variables are modeling. It's possible that a node doesn't support node type at all. In this case, the built-in evaluates to an undefined value, so you can't use the returned value. (You can still check if a node supports the type property with <code>node?node_type??</code>.)</p>
<p>XML: The possible values are: <code>&quot;attribute&quot;</code>, <code>&quot;text&quot;</code>, <code>&quot;comment&quot;</code>, <code>&quot;document_fragment&quot;</code>, <code>&quot;document&quot;</code>, <code>&quot;document_type&quot;</code>, <code>&quot;element&quot;</code>, <code>&quot;entity&quot;</code>, <code>&quot;entity_reference&quot;</code>, <code>&quot;notation&quot;</code>, <code>&quot;pi&quot;</code>. Note that a there is no <code>&quot;cdata&quot;</code> type, because CDATA is considered as plain text node.</p>
<h3 id="ref_builtin_parent">parent</h3>
parent built-in
<p>Returns the node that is this node's immediate parent in the node tree. The root node has no parent node, so for the root node, the expression <code>node?parent??</code> evaluates to <code>false</code>.</p>
<p>XML: Note that the value returned by this built-in is also a sequence (same as the result of XPath expression <code>..</code>, when you write <code>someNode[&quot;..&quot;]</code>), however if there's no parent, the result is a missing value (null) instead of an empty sequence. Also note that for attribute nodes, it returns the element the attribute belongs to, despite that attribute nodes are not counted as children of the element.</p>
<h3 id="ref_builtin_previous_sibling">previous_sibling</h3>
previous_sibling built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is only available since 2.3.26</p>
</blockquote>
<p>Returns the previous sibling node of the node. Apart from the direction, this is the same as <code>next_sibling</code>, so see more details <a href="#ref_builtin_next_sibling">there...</a></p>
<blockquote>
<p><strong>Note</strong></p>
<p>For custom node implementations this built-in is only supported if that implements the <code>freemarker.template.TemplateNodeModelEx</code> interface.</p>
</blockquote>
<h3 id="ref_builtin_root">root</h3>
root built-in
<p>The node that is the root of the tree of nodes to which this node belongs.</p>
<p>XML: According to W3C, the root of an XML document is not the topmost element node, but the document itself, which is the parent of the topmost element. For example, if you want to get the topmost <em>element</em> of the XML (the so called “document element”; do not mix it with the “document”), which is called <code>foo</code>, then you have to write <code>someNode?root.foo</code>. If you write just <code>someNode?root</code>, then you get the document itself, and not the document element.</p>
<h2 id="ref_builtins_loop_var">Loop variable built-ins</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>Loop variable built-ins only exists since FreeMarker 2.3.23.</p>
</blockquote>
<p>These built-ins you can only use with the loop variable of the <a href="#ref_directive_list"><code>list</code> and <code>items</code> directives</a> (and of the deprecated <code>foreach</code> directive). Some explanation of that follows (<code>loopVar?index</code> returns the 0-based index in the listable value we iterate through):</p>
<pre><code>&lt;#-- Note: x is a loop variable --&gt;
&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] as x&gt;
  ${x?index}
&lt;/#list&gt;</code></pre>
<pre><code>0
1
2</code></pre>
<p>When the <code>list</code> directive doesn't specify the loop variable, these built-ins are used with the loop variable of the <code>items</code> directive:</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;]&gt;
  &lt;ul&gt;
   &lt;#items as x&gt;
     &lt;li&gt;${x?index}&lt;/li&gt;
   &lt;/#items&gt;
  &lt;/ul&gt;
&lt;/#list&gt;</code></pre>
<p>Loop variable built-ins only use the <em>name</em> of loop variable, so that they can identify the related ongoing iteration. They don't read the <em>value</em> of the loop variable. Hence, this is a parsing error:</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] as x&gt;
  &lt;#assign y = x&gt;
  ${y?index} &lt;#-- ERROR: y isn&#39;t a loop variable --&gt;
&lt;/#list&gt;</code></pre>
<h3 id="ref_builtin_counter">counter</h3>
counter built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Returns the 1-based index where the iteration (which is identified by the loop variable name) currently stands.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] as i&gt;
  ${i?counter}: ${i}
&lt;/#list&gt;</code></pre>
<pre><code>  1: a
  2: b
  3: c</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>For the 0-based index, use the <a href="#ref_builtin_index"><code>index</code> built-in</a>.</p>
</blockquote>
<h3 id="ref_builtin_has_next">has_next</h3>
has_next built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Tells if the item where the iteration (which is identified by the loop variable name) currently stands is not the last item.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] as i&gt;${i?has_next?c} &lt;/#list&gt;</code></pre>
<pre><code>true true false </code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>For separating items with commas and such, use <code>&lt;#sep&gt;separator&lt;/#sep&gt;</code> instead of <code>&lt;#if
            var?has_next&gt;separator&lt;/#if&gt;</code>, as it's more readable. (Furthermore the <code>&lt;/#sep&gt;</code> can be often omitted, like in <code>&lt;#list ... as
            var&gt;...${var}...&lt;#sep&gt;separator&lt;/#list&gt;</code>)</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>If you need the inverse of this built-in, use <code>var?is_last</code> instead of <code>!var?has_next</code>, because it's more readable.</p>
</blockquote>
<h3 id="ref_builtin_index">index</h3>
index built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Returns the 0-based index where the iteration (which is identified by the loop variable name) currently stands.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] as i&gt;
  ${i?index}: ${i}
&lt;/#list&gt;</code></pre>
<pre><code>  0: a
  1: b
  2: c</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>For the 1-based index, use the <a href="#ref_builtin_counter"><code>counter</code> built-in</a>.</p>
</blockquote>
<h3 id="ref_builtin_is_even_item">is_even_item</h3>
is_even_item built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Tells if the item where the iteration (which is identified by the loop variable name) currently stands has an even 1-based index.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;] as i&gt;${i?is_even_item?c} &lt;/#list&gt;</code></pre>
<pre><code>false true false true</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>To make tables with alternating row colors and such, use <a href="#ref_builtin_item_parity"><code>var?item_parity</code></a> or <a href="#ref_builtin_item_cycle"><code>var?item_cycle(...)</code></a> instead.</p>
</blockquote>
<h3 id="ref_builtin_is_first">is_first</h3>
is_first built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Tells if the item where the iteration (which is identified by the loop variable name) currently stands is the first item.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] as i&gt;${i?is_first?c} &lt;/#list&gt;</code></pre>
<pre><code>true false false </code></pre>
<h3 id="ref_builtin_is_last">is_last</h3>
is_last built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Tells if the item where the iteration (which is identified by the loop variable name) currently stands is the last item.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;] as i&gt;${i?is_last?c} &lt;/#list&gt;</code></pre>
<pre><code>false false true</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>If you need the inverse of this built-in, use <code>var?has_next</code> instead of <code>!var?is_last</code>, because it's more readable.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>For separating items with commas and such, use <code>&lt;#sep&gt;separator&lt;/#sep&gt;</code> instead of <code>&lt;#if
            var?has_next&gt;separator&lt;/#if&gt;</code>, as it's more readable. (Furthermore the <code>&lt;/#sep&gt;</code> can be often omitted, like in <code>&lt;#list ... as
            var&gt;...${var}...&lt;#sep&gt;separator&lt;/#list&gt;</code>)</p>
</blockquote>
<h3 id="ref_builtin_is_odd_item">is_odd_item</h3>
is_odd_item built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Tells if the item where the iteration (which is identified by the loop variable name) currently stands has an odd 1-based index.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;] as i&gt;${i?is_odd_item?c} &lt;/#list&gt;</code></pre>
<pre><code>true false true false </code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>To make tables with alternating row colors and such, use <a href="#ref_builtin_item_parity"><code>var?item_parity</code></a> or <a href="#ref_builtin_item_cycle"><code>var?item_cycle(...)</code></a> instead.</p>
</blockquote>
<h3 id="ref_builtin_item_cycle">item_cycle</h3>
item_cycle built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>This is a more generic version of the <a href="#ref_builtin_item_parity"><code>item_parity</code> built-in</a>, where you can specify what value to use instead of <code>&quot;odd&quot;</code> and <code>&quot;even&quot;</code>. It also allows more than 2 values that it will cycle through.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;, &#39;e&#39;, &#39;f&#39;, &#39;g&#39;] as i&gt;
  &lt;tr class=&quot;${i?item_cycle(&#39;row1&#39;, &#39;row2&#39;, &#39;row3&#39;)}&quot;&gt;${i}&lt;/tr&gt;
&lt;/#list&gt;</code></pre>
<pre><code>  &lt;tr class=&quot;row1&quot;&gt;a&lt;/tr&gt;
  &lt;tr class=&quot;row2&quot;&gt;b&lt;/tr&gt;
  &lt;tr class=&quot;row3&quot;&gt;c&lt;/tr&gt;
  &lt;tr class=&quot;row1&quot;&gt;d&lt;/tr&gt;
  &lt;tr class=&quot;row2&quot;&gt;e&lt;/tr&gt;
  &lt;tr class=&quot;row3&quot;&gt;f&lt;/tr&gt;
  &lt;tr class=&quot;row1&quot;&gt;g&lt;/tr&gt;</code></pre>
<p>Some details:</p>
<ul>
<li><p>The number of arguments must be at least 1, and has no upper limit.</p></li>
<li><p>The type of the arguments can be anything, they doesn't have to be strings.</p></li>
</ul>
<blockquote>
<p><strong>Note</strong></p>
<p>Use the <a href="#ref_builtin_item_parity"><code>item_parity</code> built-in</a> instead if the values you need are <code>&quot;odd&quot;</code> and <code>&quot;even&quot;</code>.</p>
</blockquote>
<h3 id="ref_builtin_item_parity">item_parity</h3>
item_parity built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Returns <code>&quot;odd&quot;</code> or <code>&quot;even&quot;</code> string value, depending on the parity of the 1-based index where the iteration (which is identified by the loop variable name) currently stands. This is commonly used for alternating color for table rows:</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;] as i&gt;
  &lt;tr class=&quot;${i?item_parity}Row&quot;&gt;${i}&lt;/tr&gt;
&lt;/#list&gt;</code></pre>
<pre><code>  &lt;tr class=&quot;oddRow&quot;&gt;a&lt;/tr&gt;
  &lt;tr class=&quot;evenRow&quot;&gt;b&lt;/tr&gt;
  &lt;tr class=&quot;oddRow&quot;&gt;c&lt;/tr&gt;
  &lt;tr class=&quot;evenRow&quot;&gt;d&lt;/tr&gt;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Use the <a href="#ref_builtin_item_parity"><code>item_parity_cap</code> built-in</a> for capitalized <code>&quot;Odd&quot;</code> and <code>&quot;Even&quot;</code>. Use the <a href="#ref_builtin_item_cycle"><code>item_cycle</code> built-in</a> to specify custom values, or more then two values.</p>
</blockquote>
<h3 id="ref_builtin_item_parity_cap">item_parity_cap</h3>
item_parity_cap built-in
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.23.</p>
</blockquote>
<p>Returns <code>&quot;Odd&quot;</code> or <code>&quot;Even&quot;</code> string value (note the capitalization), depending on the parity of the 1-based index where the iteration (which is identified by the loop variable name) currently stands.</p>
<pre><code>&lt;#list [&#39;a&#39;, &#39;b&#39;, &#39;c&#39;, &#39;d&#39;] as i&gt;
  &lt;tr class=&quot;row${i?item_parity_cap}&quot;&gt;${i}&lt;/tr&gt;
&lt;/#list&gt;</code></pre>
<pre><code>  &lt;tr class=&quot;rowOdd&quot;&gt;a&lt;/tr&gt;
  &lt;tr class=&quot;rowEven&quot;&gt;b&lt;/tr&gt;
  &lt;tr class=&quot;rowOdd&quot;&gt;c&lt;/tr&gt;
  &lt;tr class=&quot;rowEven&quot;&gt;d&lt;/tr&gt;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>Use the <a href="#ref_builtin_item_parity"><code>item_parity</code> built-in</a> for lower case <code>&quot;odd&quot;</code> and <code>&quot;even&quot;</code>.</p>
</blockquote>
<h2 id="ref_builtins_type_independent">Type independent built-ins</h2>
<p>These are the built-ins that don't care (much) about the type of their left hand argument.</p>
<h3 id="ref_builtin_switch">switch</h3>
switch built-in
switch expression
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in exists since FreeMarker 2.3.23.</p>
</blockquote>
<p>This is basically the in-line (expression) version of the <a href="#ref_directive_switch"><code>switch</code>-<code>case</code>-<code>default</code> directives</a>. Its generic format is like <code>matchedValue?switch(case1,
          result1,
          case2,
          result2, ...
          caseN,
          resultN,
          defaultResult)</code>, where <code>defaultResult</code> can be omitted. Example:</p>
<pre><code>&lt;#list [&#39;r&#39;, &#39;w&#39;, &#39;x&#39;, &#39;s&#39;] as flag&gt;
  ${flag?switch(&#39;r&#39;, &#39;readable&#39;, &#39;w&#39; &#39;writable&#39;, &#39;x&#39;, &#39;executable&#39;, &#39;unknown flag: &#39; + flag)}
&lt;/#list&gt;</code></pre>
<pre><code>  readable
  writable
  executable
  unknown flag: s</code></pre>
<p>That is, <code>switch</code> will find the first <code>case</code> parameter (left to right) whose value equals to <code>matchedValue</code>, then it returns the value of the <code>result</code> parameter that's directly after that <code>case</code> parameter. If it doesn't find an equal <code>case</code>, then it will return the value of the <code>defaultResult</code>, or if there's no <code>defaultResult</code> parameter (i.e., if the number of parameters is even) then it stops the template processing with error.</p>
<p>Further details:</p>
<ul>
<li><p>The comparison of <code>matchedValue</code> to the <code>case</code> parameter value behaves exactly like <a href="#dgui_template_exp_comparison">the <code>==</code> operator</a>. Hence it only compares scalars and only same-type values. Thus, something like <code>x?switch(1,
              &quot;r1&quot;, &quot;c2&quot;, &quot;r2&quot;)</code> doesn't make sense, as if <code>x</code> is non-numerical then the first case will cause error, and if <code>x</code> is numerical then the second case will cause error (unless <code>x</code> is <code>1</code>, as then we won't do further comparisons after the first one).</p></li>
<li><p>Unlike with normal method calls, only those parameters of <code>switch(...)</code> are evaluated that are indeed needed. For example, in <code>two()?switch(c1(), r1(), c2(), r2(), c3(),
              r3())</code>, if <code>two()</code> returns <code>2</code>, <code>c1()</code> returns <code>1</code>, and <code>c2()</code> returns <code>2</code>, then only the following functions will be called, and in this order: <code>m()</code>, <code>c1()</code>, <code>c2()</code>, <code>r2()</code>. (Naturally, arguments that aren't evaluated can refer to missing variables without causing error.) It's guaranteed that the <code>case</code> parameter expressions are evaluated left to right, and only until the first match was found. It's also guaranteed that only the <code>result</code> expression that belongs to the first matching <code>case</code> will be evaluated. It's also guaranteed that the <code>defaultResult</code> expression will only be evaluated if there was no matching <code>case</code> parameter.</p></li>
<li><p>The <code>case</code> parameter expressions need not be constant values, they can be arbitrary complex expressions. Of course, the same goes for and the <code>result</code>, <code>defaultResult</code>, and <code>matchedValue</code>.</p></li>
<li><p>There's no restriction regarding the type of the <code>case</code> parameter values, like they can be strings, or numbers, or dates, etc. However, because of how the <code>==</code> operator works, it doesn't make sense to use <code>case</code> parameters of different types inside the same <code>switch</code> (see earlier why).</p></li>
<li><p>Unlike with the <a href="#ref_directive_switch"><code>case</code> directive</a>, there's no fall-through behavior there, that is, there's no need for an equivalent of the <code>break</code> directive.</p></li>
</ul>
<blockquote>
<p><strong>Note</strong></p>
<p>If you need to switch by a boolean value, you should use the <a href="#ref_builtin_then"><code>then</code> built-in</a> instead, like <code>matchedBoolean?then(whenTrue,
            whenFalse)</code>.</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>If you need to do arbitrary logical tests instead of simple equality comparisons at the <code>case</code> parameters, you can do something like this (here we tests for ranges): <code>true?switch(priority &lt;= 1, &quot;low&quot;, priority == 2,
            &quot;medium&quot;, priority &gt;= 3, &quot;high&quot;)</code></p>
</blockquote>
<h2 id="ref_builtins_expert">Seldom used and expert built-ins</h2>
<p>These are the built-ins that normally you should not use, but in exceptional situations (debugging, advanced macros) they can be useful. If you need to use these in your normal page templates, you may revisit the data-model so you don't need to use these.</p>
<h3 id="ref_buitin_api_and_has_api">api, has_api</h3>
api built-in
has_api built-in
<blockquote>
<p><strong>Note</strong></p>
<p>These built-ins exists since FreeMarker 2.3.22</p>
</blockquote>
<p><code>value?api</code> provides access to the API (usually, the Java API) of <code>value</code>, like <code>value?api.someJavaMethod()</code> or <code>value?api.someBeanProperty</code>, if the value itself supports exposing its API. This meant to be used rarely, when you need to call a Java method of an object, but the by-design simplistic view of the value that FreeMarker exposes to the templates hides that, and there's no equivalent built-in either. For example, when you put a <code>Map</code> into the data-model (and you are using the default object wrapper), <code>myMap.myMethod()</code> in a template basically translates to <code>((Method)
          myMap.get(&quot;myMethod&quot;)).invoke(...)</code> in Java, thus you can't call <code>myMethod</code>. If, however, you write <code>myMap?api.myMethod()</code> instead, that means <code>myMap.myMethod()</code> in Java. Similarly, <code>myMap?api.myProperty</code> translates to <code>myMap.getMyProperty()</code> in Java, instead of to <code>myMap.get(&quot;myProperty&quot;)</code>.</p>
<p><em>You should avoid using <code>api</code>, and rely on the capabilities of the FTL types and the related built-ins as far as possible.</em> For example, don't use <code>users?api.size()</code>, but <code>users?size</code>. The variation that uses <code>?api</code> is more verbose, slower, more easily breaks when FreeMarker configuration settings are changed, and most importantly, more prone to break as the technical details of the data-model change. For example, if <code>users</code> is changed from a <code>List</code> to an array, <code>users?size</code> will keep working, while <code>users?api.size()</code> will break.</p>
<p>Avoid calling methods that <em>modify</em> an object (especially <code>Map</code>-s and <code>Collection</code>-s) or that aren't thread safe from other reasons. Templates usually aren't expected to modify the objects exposed to them, just to display them. Thus the application may passes some objects to multiple (possibly concurrent) template processings.</p>
<p>The <code>api</code> built-in is not everywhere available, some requirements has to be met:</p>
<ul>
<li><p>The <code>api_builtin_enabled</code> configuration setting must be set to <code>true</code>. Its default is <code>false</code> (at least as of 2.3.22) for not lowering the security of existing applications.</p></li>
<li><p>The value itself has to support it. We are talking about the value as the template sees it, which is created from the original object (that's coming from the data-model or from a Java method return value) value via <a href="#pgui_datamodel_objectWrapper">object wrapping</a>. Hence, this depends on the <code>object_wrapper</code> FreeMarker configuration setting, and on the class of the wrapped (the original) object:</p>
<ul>
<li><p>When the object wrapper is a <code>DefaultObjectWrapper</code> with its <code>incompatibleImprovements</code> set to 2.3.22 or higher (<a href="#topic.defaultObjectWrapperIcI">see how to set it here</a>), FTL values made from <code>Map</code>-s and <code>List</code>-s support <code>?api</code>. (Actually, what matters is that its <code>useAdaptersForContainer</code> property is set to <code>true</code>, but that's the default with said <code>incompatibleImprovements</code>.) Other <code>java.util.Collections</code> (such as <code>Set</code>-s) only support <code>?api</code> if <code>DefaultObjectWrapper</code>'s <code>forceLegacyNonListCollections</code> property is set to <code>false</code> (the default is <code>true</code> for better out-of-the-box backward compatibility).</p></li>
<li><p>When wrapped with pure <code>BeansWrapper</code>, all values support <code>?api</code>.</p></li>
<li><p>Custom <code>TemplateModel</code>-s can support <code>?api</code> by implementing the <code>freemarker.template.TemplateModelWithAPISupport</code> interface.</p></li>
</ul></li>
</ul>
<p>Using <code>?api</code> when it's not allowed in the configuration or when the value doesn't support it will abort template processing with error.</p>
<p>Whether a value supports <code>?api</code> can be checked like <code>value?has_api</code>, which returns a boolean value. Note that the result of <code>?has_api</code> isn't influenced by the <code>api_builtin_enabled</code> setting.</p>
<h3 id="ref_builtin_numType">byte, double, float, int, long, short</h3>
type-casting
converting between types
byte built-in
double built-in
float built-in
int built-in
long built-in
short built-in
converting date to long
date to long
<p>Returns a <code>SimpleNumber</code> which contains the same value as the original variable, but uses <code>java.lang.Type</code> for the internal representation of the value. This is useful if a method is overloaded, or if a <code>TemplateModel</code> unwrapper has problem with automatically choosing the suitable <code>java.lang.*</code> type. Note that since version 2.3.9 the unwrapper has been improved substantially, so you will hardly ever need to use these built-ins to convert between numerical types, except for resolving ambiguity in overloaded method invocation.</p>
<p>The <code>long</code> built-in can also be used with date, time and date-time values to get the value as <code>java.util.Date.getTime()</code> would return. This is useful if you have to call a Java methods that expect a timestamp as a <code>long</code>.</p>
<h3 id="ref_builtin_eval">eval</h3>
eval
evaluate string
<p>This built-in evaluates a string as an FTL expression. For example <code>&quot;1+2&quot;?eval</code> returns number 3.</p>
<p>The evaluated expression sees the same variables (such as locals) that are visible at the place of the invocation of <code>eval</code>. That is, it behaves similarly as if in place of <code>s?eval</code> you had the <em>value of</em> <code>s</code> there. Except, it can't use <a href="#ref_builtins_loop_var">loop variable built-ins</a> that refer to a loop variable that was created outside <code>s</code>.</p>
<p>Regarding the configuration settings that affect the parsing (like syntax) and evaluation the rules are the same as with the <a href="#ref_builtin_interpret"><code>interpret</code> built-in</a>.</p>
<h3 id="ref_builtin_has_content">has_content</h3>
has_content built-in
<p>It is <code>true</code> if the variable exists (and isn't Java <code>null</code>) and is not “empty”, otherwise it is <code>false</code>. The meaning of “empty” depends on the concrete case. This follows intuitive common-sense ideas. The following are empty: a string with 0 length, a <a href="#dgui_misc_autoescaping_movalues">markup output value</a> with 0 length markup, a sequence or hash with no sub variables, a collection which has passed the last element. If the value is not of any of these types, then it counts as non-empty if it's a number or a date or a boolean (e.g. <code>0</code> and <code>false</code> are not empty), otherwise it counts as empty. Note that when your data-model implements multiple template model interfaces you may get unexpected results. However, when in doubt you can use always use <code>expr!?size &gt; 0</code> or <code>expr!?length &gt; 0</code> instead of <code>expr?has_content</code>.</p>
<p>This buit-in is exceptional in that you can use the parentheses trick like with the <a href="#dgui_template_exp_missing_default">default value operator</a>. That is, you can write both <code>product.color?has_content</code> and <code>(product.color)?has_content</code>. The first doesn't handle the case when <code>product</code> is missing, the last does.</p>
<h3 id="ref_builtin_interpret">interpret</h3>
interpret built-in
<p>This built-in parses a string as an FTL template, and returns an user-defined directive that executes that template, just as if a template with that content were <a href="#ref_directive_include"><code>include</code>-d</a> at that point. Example:</p>
<pre><code>&lt;#assign x=[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]&gt;
&lt;#assign templateSource = r&quot;&lt;#list x as y&gt;${y}&lt;/#list&gt;&quot;&gt;
&lt;#-- Note: That r was needed so that the ${y} is not interpreted above --&gt;
&lt;#assign inlineTemplate = templateSource?interpret&gt;
&lt;@inlineTemplate /&gt;</code></pre>
<p>The output:</p>
<pre><code>abc</code></pre>
<p>As you can see, <code>inlineTemplate</code> is a user-defined directive that, when executed, runs the template whose content is the value of <code>templateSource</code>.</p>
<p>The name of the template created by <code>interpret</code> is the name of the template that calls <code>interpret</code>, plus <code>&quot;-&gt;anonymous_interpreted&quot;</code>. For example, if the template that calls the built-in is <code>&quot;foo/bar.ftl&quot;</code>, then the name of the resulting template is <code>&quot;foo/bar.ftl-&gt;anonymous_interpreted&quot;</code>. Thus, relative paths inside the interpreted template are relative to this path (i.e., the base directory will be <code>&quot;foo&quot;</code>), and errors inside the interpreted template will point to this generated template name.</p>
<p>For more helpful error messages, you can override the template name part after the <code>&quot;-&gt;&quot;</code>. For example, let's say <code>mailTemplateSource</code> comes from the <code>mail_template</code> database table, and in the case of error, you want the error log to contain the database ID of the failing template:</p>
<pre><code>&lt;#assign inlineTemplate = [mailTemplateSource, &quot;mail_templates id=${mailTemplateId}&quot;]?interpret&gt;</code></pre>
<p>As you can see, <code>interpret</code> can be applied on a sequence of two items, in which case the first item is the FTL string to interpret, and the second items is the template name used after the <code>&quot;-&gt;&quot;</code>.</p>
<p>The configuration settings that affect the interpreted template are the same as of the surrounding template, except that parser settings specified in the <a href="#ref.directive.ftl"><code>ftl</code> directive</a> or was established via tag syntax or naming convention auto-detection are instead coming from the <code>Configuration</code> object (or naturally, from the <a href="#pgui_config_templateconfigurations"><code>TemplateConfiguration</code></a>, if there's any). Thus the tag syntax, naming convention, whitespace handling, etc. of the interpreted template is independent of that established <em>inside</em> the surrounding template. An important exception from this rule is that the <a href="#dgui_misc_autoescaping_outputformat">output format</a> and auto-escaping policy is inherited from the lexical context where <code>interpret</code> is called from. For example in a template that has <code>&lt;#ftl
          output_format=&quot;XML&quot;&gt;</code> header (or if you are inside a <code>&lt;#output_format
          &quot;XML&quot;&gt;...&lt;/#output_format&gt;</code> block), <code>interpret</code> calls in it will produce directives with XML output format.</p>
<h3 id="ref_builtin_isType">is_...</h3>
is_... built-in
type checking
<p>These built-ins check the type of a variable, and returns <code>true</code> or <code>false</code> depending on the type. The list of <code>is_...</code> built-ins:</p>
<table>
<thead>
<tr class="header">
<th>Built-in</th>
<th>Returns <code>true</code> if the value is a ...</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>is_string</code></td>
<td>string</td>
</tr>
<tr class="even">
<td><code>is_number</code></td>
<td>number</td>
</tr>
<tr class="odd">
<td><code>is_boolean</code></td>
<td>boolean</td>
</tr>
<tr class="even">
<td><code>is_date</code></td>
<td>Don't use it! Same as <code>is_date_like</code>, use that instead. Later may changes meaning to <code>date_only</code>.</td>
</tr>
<tr class="odd">
<td><code>is_date_like</code></td>
<td>date-like, means either date, time or date-time, or date-like with unknown precise type (since FreeMarker 2.3.21)</td>
</tr>
<tr class="even">
<td><code>is_date_only</code></td>
<td>date (no time of the day part) (since FreeMarker 2.3.21)</td>
</tr>
<tr class="odd">
<td><code>is_time</code></td>
<td>time (no year-month-day part) (since FreeMarker 2.3.21)</td>
</tr>
<tr class="even">
<td><code>is_datetime</code></td>
<td>date-time (contains both year-month-day and time of the day)</td>
</tr>
<tr class="odd">
<td><code>is_unknown_date_like</code></td>
<td>date-like where we don't know if it's a date or a time or a date-time</td>
</tr>
<tr class="even">
<td><code>is_method</code></td>
<td>method</td>
</tr>
<tr class="odd">
<td><code>is_transform</code></td>
<td>transform</td>
</tr>
<tr class="even">
<td><code>is_macro</code></td>
<td>macro or function (yes, also for function; a historical glitch)</td>
</tr>
<tr class="odd">
<td><code>is_hash</code></td>
<td>hash (including extended hash)</td>
</tr>
<tr class="even">
<td><code>is_hash_ex</code></td>
<td>extended hash (supports <code>?keys</code> and <code>?values</code>)</td>
</tr>
<tr class="odd">
<td><code>is_sequence</code></td>
<td>sequence (Historical quirk: Before <a href="#pgui_config_incompatible_improvements_how_to_set"><code>incompatible_improvements</code></a> 2.3.24 it returns <code>true</code> for Java methods as they implement the <code>[index]</code> operator, however, they fail on <code>?size</code>.)</td>
</tr>
<tr class="even">
<td><code>is_collection</code></td>
<td>collection (including extended collection)</td>
</tr>
<tr class="odd">
<td><code>is_collection_ex</code></td>
<td>extended collection (supports <code>?size</code>)</td>
</tr>
<tr class="even">
<td><code>is_enumerable</code></td>
<td>sequence or collection</td>
</tr>
<tr class="odd">
<td><code>is_indexable</code></td>
<td>sequence (Historical quirk: it returns <code>true</code> for Java methods as they implement the <code>[index]</code> operator.)</td>
</tr>
<tr class="even">
<td><code>is_directive</code></td>
<td>Whatever kind of directive (for example a macro, or <code>TemplateDirectiveModel</code>, <code>TemplateTransformModel</code>, etc.), or function (a historical glitch)</td>
</tr>
<tr class="odd">
<td><code>is_node</code></td>
<td>node</td>
</tr>
<tr class="even">
<td><code>is_markup_output</code></td>
<td>markup output (a value that won't be <a href="#dgui_misc_autoescaping">auto-escaped</a>)</td>
</tr>
</tbody>
</table>
<h3 id="ref_builtin_markup_string">markup_string</h3>
<p>markup_string built-in</p>
<blockquote>
<p><strong>Note</strong></p>
<p>This built-in is available since FreeMarker 2.3.24.</p>
</blockquote>
<p>Returns the markup stored inside a <a href="#dgui_misc_autoescaping_movalues">markup output value</a> as string. This is useful if the value has to be passed to a Java method for a <code>String</code> parameter, or if we want to manipulate the markup directly in the template. Note that the resulting string can be converted back to markup output value with <a href="#ref_builtin_no_esc"><code>?no_esc</code></a>.</p>
<h3 id="ref_builtin_namespace">namespace</h3>
namespace built-in
<p>This built-in returns the namespace (i.e. the “gate” hash to the namespace) associated with a macro or function variable. You can use it with macros and functions only.</p>
<h3 id="ref_builtin_new">new</h3>
instantiating variable
new built-in
<p>This is to create a variable of a certain <code>TemplateModel</code> implementation.</p>
<p>On the left side of <code>?</code> you specify a string, the full-qualified class name of a <code>TemplateModel</code> implementation. The result is a method variable that calls the constructor, and returns the new variable.</p>
<p>Example:</p>
<pre><code>&lt;#-- Creates an user-defined directive be calling the parameterless constructor of the class --&gt;
&lt;#assign word_wrapp = &quot;com.acmee.freemarker.WordWrapperDirective&quot;?new()&gt;
&lt;#-- Creates an user-defined directive be calling the constructor with one numerical argument --&gt;
&lt;#assign word_wrapp_narrow = &quot;com.acmee.freemarker.WordWrapperDirective&quot;?new(40)&gt;</code></pre>
<p>For more information about how the constructor parameters are unwrapped and how overloaded constructor is chosen, read: <a href="#pgui_misc_beanwrapper">section_title</a></p>
<p>This built-in can be a security concern because the template author can create arbitrary Java objects and then use them, as far as they implement <code>TemplateModel</code>. Also the template author can trigger static initialization for classes that don't even implement <code>TemplateModel</code>. You can (since 2.3.17) restrict the classes accessible with this built-in using <code>Configuration.setNewBuiltinClassResolver(TemplateClassResolver)</code> or the <code>new_builtin_class_resolver</code> setting. See the Java API docs for more information. If you are allowing not-so-much-trusted users to upload templates then you should definitely look into this topic.</p>
<h3 id="ref_builtin_numToDate">number_to_date, number_to_time, number_to_datetime</h3>
type-casting
converting between types
number_to_date built-in
number_to_datetime built-in
number_to_time built-in
converting long to date
long to date
<p>These are used to convert a number (usually a Java <code>long</code>) to a date, time or date-time, respectively. This does them same as <code>new java.util.Date(long)</code> in Java, that is, the number is interpreted as the milliseconds passed since the epoch. The number can be anything and of any type as far as its value fits into a <code>long</code>. If the number isn't a whole number, it will be rounded to whole with half-up rule.</p>
<p>Example:</p>
<pre><code>${1305575275540?number_to_datetime}
${1305575275540?number_to_date}
${1305575275540?number_to_time}</code></pre>
<p>The output will be something like this (depending on the current locale and time zone):</p>
<pre><code>May 16, 2011 3:47:55 PM
May 16, 2011
3:47:55 PM</code></pre>
<h3 id="ref_builtin_sequence">sequence</h3>
seq_sequence built-in
<p>This built-in is used to convert a listable value (one that you can iterate through with the <a href="#ref.directive.list"><code>list</code> directive</a>) to a more capable <a href="#dgui_datamodel_container">sequence</a> value. Sequences support operations like <code>xs[index]</code> and <code>xs?size</code>. Also, the resulting value is listable for multiple times, even if the original value was backed by a <code>java.util.Iterator</code>. This built-in is typically used to work around data-model problems, in case you can't fix the data-model itself. If you can, always fix the data-model instead (give a <code>java.util.List</code> or array to the template instead of a more restricted object, like a non-<code>List</code> <code>java.util.Collection</code>, or a <code>java.util.Iterator</code>).</p>
<p>If the value is already a sequence, then this built-in just returns that as is. If the value is not something that the <a href="#ref.directive.list"><code>list</code> directive</a> could list, then template processing will be aborted with error. Otherwise, it fetches all the values, and stores them into a sequence. Be careful if you can have a huge number of items, as all of them will be held in memory on the same time.</p>
<p>You should convert a value with <code>sequence</code> only once. If you need the resulting sequence at multiple places, always assign the result to a variable, because if the value you convert is only listable once, converting it for the second time will result in error or an empty sequence. Also the conversion is somewhat costly for big collections, so it's better to do it only once.</p>
<p>Example: Let's say you find that <code>users</code> is only listable once (because it's a <code>java.util.Iterator</code>), but you need to list it for multiple times in the template, and you can't fix the data-model. Then you could do this:</p>
<pre><code>&lt;#-- Collect all the users into a sequence: --&gt;
&lt;#assign usersSeq = users?sequence&gt;

&lt;#list usersSeq as user&gt;...&lt;/#list&gt;
Again:
&lt;#list usersSeq as user&gt;...&lt;/#list&gt;</code></pre>
<h1 id="ref_directives">Directive Reference</h1>
directive
<h2 id="ref_directive_alphaidx">Alphabetical index</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>As of FreeMarker 2.3.23, you can use camel case instead of all-lower-case for directive names, like <code>noParse</code> instead of <code>noparse</code>. But know that then within the same template, FreeMarker will enforce the usage of camel case for all identifiers that are part of the template language (user defined names are not affected).</p>
</blockquote>
directive
<ul>
<li><p><a href="#ref.directive.assign">assign</a></p></li>
<li><p><a href="#ref.directive.attempt">attempt</a></p></li>
<li><p><a href="#ref_directive_autoesc">autoesc</a></p></li>
<li><p>break: <a href="#ref.directive.switch.break">in switch</a>, <a href="#ref.directive.list.break">in list</a></p></li>
<li><p><a href="#ref.directive.case">case</a></p></li>
<li><p><a href="#ref.directive.compress">compress</a></p></li>
<li><p><a href="#ref.directive.list.continue">continue</a></p></li>
<li><p><a href="#ref.directive.default">default</a></p></li>
<li><p>else: <a href="#ref.directive.else">in if</a>, <a href="#ref.directive.list.else">in list</a></p></li>
<li><p><a href="#ref.directive.elseif">elseif</a></p></li>
<li><p><a href="#ref.directive.escape">escape</a></p></li>
<li><p><a href="#ref.directive.fallback">fallback</a></p></li>
<li><p><a href="#ref.directive.function">function</a></p></li>
<li><p><a href="#ref.directive.flush">flush</a></p></li>
<li><p><a href="#ref.directive.ftl">ftl</a></p></li>
<li><p><a href="#ref.directive.global">global</a></p></li>
<li><p><a href="#ref.directive.if">if</a></p></li>
<li><p><a href="#ref.directive.import">import</a></p></li>
<li><p><a href="#ref.directive.include">include</a></p></li>
<li><p><a href="#ref.directive.items">items</a></p></li>
<li><p><a href="#ref.directive.list">list</a></p></li>
<li><p><a href="#ref.directive.local">local</a></p></li>
<li><p><a href="#ref.directive.lt">lt</a></p></li>
<li><p><a href="#ref.directive.macro">macro</a></p></li>
<li><p><a href="#ref.directive.nested">nested</a></p></li>
<li><p><a href="#ref_directive_noautoesc">noautoesc</a></p></li>
<li><p><a href="#ref.directive.noescape">noescape</a></p></li>
<li><p><a href="#ref_directive_noparse">noparse</a></p></li>
<li><p><a href="#ref.directive.nt">nt</a></p></li>
<li><p><a href="#ref_directive_outputformat">outputformat</a></p></li>
<li><p><a href="#ref.directive.attempt">recover</a></p></li>
<li><p><a href="#ref.directive.recurse">recurse</a></p></li>
<li><p>return: <a href="#ref.directive.macro.return">in macro</a>, <a href="#ref.directive.function.return">in function</a></p></li>
<li><p><a href="#ref.directive.rt">rt</a></p></li>
<li><p><a href="#ref.directive.sep">sep</a></p></li>
<li><p><a href="#ref.directive.setting">setting</a></p></li>
<li><p><a href="#ref.directive.stop">stop</a></p></li>
<li><p><a href="#ref.directive.switch">switch</a></p></li>
<li><p><a href="#ref.directive.t">t</a></p></li>
<li><p><a href="#ref.directive.userDefined">User-defined directive (&lt;@...&gt;)</a></p></li>
<li><p><a href="#ref.directive.visit">visit</a></p></li>
</ul>
<p>If you don't find a directive here that you have seen in a working template, probably you will find it in: <a href="#ref_deprecated">Deprecated FTL constructs</a></p>
<h2 id="ref_directive_assign">assign</h2>
assign directive
<h3>Synopsis</h3>
<pre><code>&lt;#assign name1=value1 name2=value2 ... nameN=valueN&gt;
or
&lt;#assign same as above... in namespacehash&gt;
or
&lt;#assign name&gt;
  capture this
&lt;/#assign&gt;
or
&lt;#assign name in namespacehash&gt;
  capture this
&lt;/#assign&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>name</code>: name of the variable. It is not expression. However, it can be written as a string literal, which is useful if the variable name contains reserved characters, for example <code>&lt;#assign &quot;foo-bar&quot; = 1&gt;</code>. Note that this string literal does not expand interpolations (as <code>&quot;${foo}&quot;</code>); if you need to assign to a dynamically constructed name, the you have to use <a href="#faq_assign_to_dynamic_variable_name">a different trick</a>. Note that because the FreeMarker template language assumes that sequences (lists, arrays, etc.) and hashes (maps, beans, etc.) are immutable, you can <em>not</em> write something like <code>&lt;#assign myObj.someProperty =
              'will NOT work'&gt;</code> or <code>&lt;#assign myList[0]
              = 'will NOT work'&gt;</code>. However, adding sequences or hashes with the <code>+</code> operator to form another value is supported; see in the <a href="#exp_cheatsheet">chapter about expressions</a>, and please note the performance consequences.</p></li>
<li><p><code>=</code>: Assignment operator. It can also be one of the assignment shorthand operators (since FreeMarker 2.3.23): <code>++</code>, <code>--</code>, <code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code> or <code>%=</code>. Like <code>&lt;#assign
              x++&gt;</code> is similar to <code>&lt;#assign x = x +
              1&gt;</code>, and <code>&lt;#assign x += 2&gt;</code> is the same as <code>&lt;#assign x = x + 2&gt;</code>. Note that <code>++</code> always means arithmetical addition (an so it will fail on non-numbers), unlike <code>+</code> or <code>+=</code> that are overloaded to do string concatenation and such.</p></li>
<li><p><code>value</code>: the value to store. Expression.</p></li>
<li><p><code>namespacehash</code>: a hash that was created for a <a href="#dgui_misc_namespace">namespace</a> (by <a href="#ref.directive.import"><code>import</code></a>). Expression. If not specified, it defaults to the namespace that belongs to the containing template.</p></li>
</ul>
<h3>Description</h3>
<p>With this you can create a new variable, or replace an existing variable. Note that only top-level variables can be created/replaced (i.e. you can't create/replace <code>some_hash.subvar</code>, but <code>some_hash</code>).</p>
<p>For more information about variables, read this: <a href="#dgui_misc_var">section_title</a></p>
<blockquote>
<p><strong>Note</strong></p>
<p>A frequent mistake is trying to use <code>assign</code> to change a local variable like: <code>&lt;#macro m&gt;&lt;#local x = 1&gt;${x}&lt;#assign x =
            2&gt;${x}&lt;/#macro&gt;</code>. This prints <code>11</code>, not <code>12</code>, because <code>assign</code> creates/replaces the <code>x</code> of the namespace that the template belongs to, and doesn't change the <code>x</code> local variable. Local variables should be always set with the <a href="#ref.directive.local"><code>local</code> directive</a>, not just for the fist time.</p>
</blockquote>
<p>Example: variable <code>seq</code> will store a sequence:</p>
<pre><code>&lt;#assign seq = [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]&gt;</code></pre>
<p>Example: Increments the numerical value stored in variable <code>x</code>:</p>
<pre><code>&lt;#assign x++&gt;</code></pre>
<p>As a convenience feature, you can do more assignments with one <code>assign</code> tag. For example this will do the same as the two previous examples:</p>
<pre><code>&lt;#assign
  seq = [&quot;foo&quot;, &quot;bar&quot;, &quot;baz&quot;]
  x++
&gt;</code></pre>
<p>If you know what namespaces are: <code>assign</code> directive creates variables in a namespace. Normally it creates the variable in the current namespace (i.e. in the namespace associated with the template where the tag is). However, if you use <code>in
          namespacehash</code> then you can create/replace a variable of another <a href="#dgui_misc_namespace">namespace</a> than the current namespace. For example, here you create/replace variable <code>bgColor</code> of the namespace used for <code>/mylib.ftl</code>:</p>
<pre><code>&lt;#import &quot;/mylib.ftl&quot; as my&gt;
&lt;#assign bgColor=&quot;red&quot; in my&gt;</code></pre>
<p>An extreme usage of <code>assign</code> is when it captures the output generated between its start-tag and end-tag. That is, things that are printed between the tags will not be shown on the page, but will be stored in the variable. For example:</p>
<pre><code>&lt;#macro myMacro&gt;foo&lt;/#macro&gt;
&lt;#assign x&gt;
  &lt;#list 1..3 as n&gt;
    ${n} &lt;@myMacro /&gt;
  &lt;/#list&gt;
&lt;/#assign&gt;
Number of words: ${x?word_list?size}
${x}</code></pre>
<p>will print:</p>
<pre><code>Number of words: 6
    1 foo
    2 foo
    3 foo
 </code></pre>
<p>Please note that you should not to use this to insert variables into strings:</p>
<pre><code>&lt;#assign x&gt;Hello ${user}!&lt;/#assign&gt; &lt;#-- BAD PRACTICE! --&gt;</code></pre>
<p>You should simply write:</p>
<pre><code>&lt;#assign x=&quot;Hello ${user}!&quot;&gt;</code></pre>
<h2 id="ref_directive_attempt">attempt, recover</h2>
attempt directive
recover directive
error handling
<h3>Synopsis</h3>
<pre><code>&lt;#attempt&gt;
  attempt block
&lt;#recover&gt;
  recover block
&lt;/#attempt&gt;
</code></pre>
<p>Where:</p>
<ul>
<li><p><code>attempt
              block</code>: Template block with any content. This will be always executed, but if an error occurs during that, all output from this block is rolled back, and the <code>recover block</code> will be executed.</p></li>
<li><p><code>recover
              block</code>: Template block with any content. This will be executed only if there was an error during the execution of the <code>attempt
              block</code>. You may print an error messages here and such.</p></li>
</ul>
<p>The <code>recover</code> is mandatory. <code>attempt</code>/<code>recover</code> can be nested freely into other <code>attempt
          block</code>s or <code>recover
          block</code>s.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>The format shown here is supported starting from 2.3.3; earlier it was <code>&lt;#attempt&gt;...&lt;#recover&gt;...&lt;/#recover&gt;</code>, which is still supported for backward compatibility. Furthermore, these directives were introduced with FreeMarker 2.3.1, so they aren't exist in 2.3.</p>
</blockquote>
<h3>Description</h3>
<p>These directives are used if you want the page successfully outputted even if the outputting of a certain part of the page fails. If an error occurs during the execution of the <code>attempt block</code>, then the output of the <code>attempt
          block</code> is rolled back (and the error is logged, with the default configuration at least), and the <code>recover block</code> is executed instead, then template execution continues normally after the <code>recover block</code>. If no error occurs during the execution of the <code>attempt block</code>, then the <code>recover block</code> is ignored. A simple example:</p>
<pre><code>Primary content
&lt;#attempt&gt;
  Optional content: ${thisMayFails}
&lt;#recover&gt;
  Ops! The optional content is not available.
&lt;/#attempt&gt;
Primary content continued</code></pre>
<p>If the <code>thisMayFails</code> variable doesn't exist (or any other error occurs at that place), then the output is:</p>
<pre><code>Primary content
  Ops! The optional content is not available.
Primary content continued</code></pre>
<p>If the <code>thisMayFails</code> variable exists and it's value is <code>123</code>, then the output is:</p>
<pre><code>Primary content
  Optional content: 123
Primary content continued</code></pre>
<p>The <code>attempt
          block</code> has an all-or-none semantic: either the entire content of the <code>attempt
          block</code> is output (when there was no error), or no output at all results from the execution of the <code>attempt block</code> (when there was an error). For example, above, the failure happens after “Optional content:” was printed, still it is not there in the output before the “Ops!”. (This is implemented with the aggressive buffering of the output inside the <code>attempt
          block</code>. Not even the <code>flush</code> directive will send the output to the client.)</p>
<p>To prevent misunderstandings coming from the above example: <code>attempt</code>/<code>recover</code> is not (only) for handling undefined variables (for that use <a href="#dgui_template_exp_missing">missing value handler operators</a>). It can handle all kind of errors that occurs when the block is executed (i.e. not syntactical errors, which are detected earlier). It meant to enclose bigger template fragments, where error can occur at various points. For example, you have a part in your template that deals with printing advertisements, but that's not the primary content of the page, so you don't want your whole page be down just because some error occurs with the printing of the advertisements (say, because of a database server outage). So you put the whole advertisement printing into an <code>attempt block</code>.</p>
<p>In some environments programmers configure FreeMarker so that it doesn't abort template execution for certain errors, but continues execution, possibly after printing some error indicator to the output (see more <a href="#pgui_config_errorhandling">here...</a>). The <code>attempt</code> directive doesn't consider such suppressed errors as errors.</p>
<p>Inside a <code>recover
          block</code> the error message of the error is available with the <code>error</code> <a href="#ref_specvar">special variable</a>. Don't forget that references to special variable are started with dot (for example: <code>${.error}</code>).</p>
<p>By default errors occurring inside an <code>attempt
          block</code> are <a href="#pgui_misc_logging">logged</a> with <code>ERROR</code> level, despite that the template recovers from them. This is because <code>attempt</code> is not meant to be a general purpose error handler mechanism, like <code>try</code> is in Java. It's for decreasing the impact of unexpected errors on the visitors, by making it possible that only part of the page is going down, instead of the whole page. But it's still an error, something that needs the attention of the operators. (The way this error is reported can be customized with the <code>attempt_exception_reporter</code> configuration setting, since FreeMarker 2.3.27.)</p>
<h2 id="ref_directive_autoesc">autoesc</h2>
autoesc directive
auto-escaping
escaping
<h3>Synopsis</h3>
<pre><code>&lt;#autoesc&gt;
  ...
&lt;/#autoesc&gt;</code></pre>
<p>Camel case name variant: <code>autoEsc</code></p>
<h3>Description</h3>
<p>Turns on <a href="#dgui_misc_autoescaping">auto-escaping</a> in the nested section. Auto-escaping is usually enabled by default if the current <a href="#dgui_misc_autoescaping_outputformat">output format</a> has auto-escaping by default, so you rarely need this. Note that to escape just a single <code>${expression}</code> where auto-escaping is disabled you should use <code>${expression?esc}</code> instead.</p>
<p>This directive only has effect on the section that is literally (as in the text editor) inside the nested bock, not on the parts that are called/included from there.</p>
<p>Example:</p>
<pre><code>&lt;#ftl output_format=&quot;XML&quot; auto_esc=false&gt;
${&quot;&amp;&quot;}
&lt;#autoesc&gt;
  ${&quot;&amp;&quot;}
  ...
  ${&quot;&amp;&quot;}
&lt;/#autoesc&gt;
${&quot;&amp;&quot;}</code></pre>
<pre><code>&amp;
  &amp;amp;
  ...
  &amp;amp;
&amp;</code></pre>
<p><code>autoesc</code> can't be used where the current <a href="#dgui_misc_autoescaping_outputformat">output format</a> is a <a href="#dgui_misc_autoescaping_nonmarkupof">non-markup output format</a> (and hence can't do escaping). Doing so is a <a href="#gloss.parseTimeError">parse-time error</a>.</p>
<p><code>autoesc</code> can also be used nested into <a href="#ref_directive_noautoesc"><code>noautoesc</code> directive</a> to re-enable auto-escaping.</p>
<p><code>autoesc</code> can be used on places where auto-escaping is already enabled, such as even inside another <code>autoesc</code> block. Doing so is redundant but allowed.</p>
<h2 id="ref_directive_compress">compress</h2>
compress directive
white-space removal
compress
<h3>Synopsis</h3>
<pre><code>&lt;#compress&gt;
  ...
&lt;/#compress&gt;</code></pre>
<h3>Description</h3>
<p>The compress directive is useful for removing superfluous <a href="#gloss.whiteSpace">white-space</a> when you use a white-space insensitive format (e.g. HTML or XML). It captures the output generated inside its body (i.e. between its start-tag and end-tag), and reduces all unbroken white-space sequences to a single white-space character. The inserted character will be a <a href="#gloss.lineBreak">line break</a> if the replaced sequence contains line breaks, or a space otherwise. The very first and very last unbroken white-space sequences will be completely removed.</p>
<pre><code>&lt;#assign x = &quot;    moo  \n\n   &quot;&gt;
(&lt;#compress&gt;
  1 2  3   4    5
  ${moo}
  test only

  I said, test only

&lt;/#compress&gt;)</code></pre>
<p>will output:</p>
<pre><code>(1 2 3 4 5
moo
test only
I said, test only)</code></pre>
<h2 id="ref_directive_escape">escape, noescape (deprecated)</h2>
escape directive
noescape directive
<h3>Synopsis</h3>
<pre><code>&lt;#escape identifier as expression&gt;
  ...
  &lt;#noescape&gt;...&lt;/#noescape&gt;
  ...
&lt;/#escape&gt;</code></pre>
<p>Camel case name variant: <code>noEscape</code></p>
<h3>Description</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>These directives are <em>deprecated</em> by <a href="#dgui_misc_autoescaping">output-format-based auto-escaping</a> since 2.3.24. Furthermore, on places that use auto-escaping (with an output format that actually does escaping) you aren't allowed to use the <code>escape</code> directive (as you will find out from the parsing error message anyway).</p>
</blockquote>
<p>When you surround a part of the template with an escape directive, interpolations (<code>${...}</code>) that occur inside the block are combined with the escaping expression automatically. This is a convenience method for avoiding writing similar expressions all over. It does not affect interpolations in string literals (as in <code>&lt;#assign x =
          &quot;Hello ${user}!&quot;&gt;</code>). Also, it does not affect numerical interpolations (<code>#{...}</code>).</p>
<p>Example:</p>
<pre><code>&lt;#escape x as x?html&gt;
  First name: ${firstName}
  Last name: ${lastName}
  Maiden name: ${maidenName}
&lt;/#escape&gt;</code></pre>
<p>is actually equivalent to:</p>
<pre><code>  First name: ${firstName?html}
  Last name: ${lastName?html}
  Maiden name: ${maidenName?html}</code></pre>
<p>Note that it is irrelevant what identifier you use in the directive - it just serves as a formal parameter to the escaping expression.</p>
<p>When you are calling macros or the <code>include</code> directive, it is important to understand that escape has effect only on interpolations that occur between the <code>&lt;#escape
          ...&gt;</code> and <code>&lt;/#escape&gt;</code> <em>in the template text</em>. That is, it will not escape anything that is before <code>&lt;#escape ...&gt;</code> in the text, or after the <code>&lt;/#escape&gt;</code> in the text, not even if that part is called from inside the <code>escape</code>-d section.</p>
<pre><code>&lt;#assign x = &quot;&lt;test&gt;&quot;&gt;
&lt;#macro m1&gt;
  m1: ${x}
&lt;/#macro&gt;
&lt;#escape x as x?html&gt;
  &lt;#macro m2&gt;m2: ${x}&lt;/#macro&gt;
  ${x}
  &lt;@m1/&gt;
&lt;/#escape&gt;
${x}
&lt;@m2/&gt;</code></pre>
<p>the output will be:</p>
<pre><code>  &amp;lt;test&amp;gt;
  m1: &lt;test&gt;
&lt;test&gt;
m2: &amp;lt;test&amp;gt;</code></pre>
<p>More technically, the effects of <code>escape</code> directive are applied at template parsing time rather than at template processing time. This means that if you call a macro or include another template from within an escape block, it won't affect the interpolations in the macro/included template, since macro calls and template includes are evaluated at template processing time. On the other hand, if you surround one or more macro declarations (which are evaluated at template parsing time, as opposed to macro calls) with an escape block, the interpolations in those macros will be combined with the escaping expression.</p>
<p>Sometimes there is a need to temporarily turn off escaping for one or two interpolations in an escape block. You can achieve this by closing and later reopening the escape block, but then you have to write the escaping expression twice. You can instead use the noescape directive:</p>
<pre><code>&lt;#escape x as x?html&gt;
  From: ${mailMessage.From}
  Subject: ${mailMessage.Subject}
  &lt;#noescape&gt;Message: ${mailMessage.htmlFormattedBody}&lt;/#noescape&gt;
  ...
&lt;/#escape&gt;</code></pre>
<p>is equivalent to:</p>
<pre><code>  From: ${mailMessage.From?html}
  Subject: ${mailMessage.Subject?html}
  Message: ${mailMessage.htmlFormattedBody}
  ...</code></pre>
<p>Escapes can be nested (although you will do it only in rare circumstances). Therefore, you can write something like the below code (the example is admittedly a bit stretched, as you'd probably place item codes in a sequence and use <code>list</code> to iterate over them, but we're now doing it this way just to illustrate the point):</p>
<pre><code>&lt;#escape x as x?html&gt;
  Customer Name: ${customerName}
  Items to ship:
  &lt;#escape x as itemCodeToNameMap[x]&gt;
    ${itemCode1}
    ${itemCode2}
    ${itemCode3}
    ${itemCode4}
  &lt;/#escape&gt;
&lt;/#escape&gt;</code></pre>
<p>is actually equivalent to:</p>
<pre><code>  Customer Name: ${customerName?html}
  Items to ship:
    ${itemCodeToNameMap[itemCode1]?html}
    ${itemCodeToNameMap[itemCode2]?html}
    ${itemCodeToNameMap[itemCode3]?html}
    ${itemCodeToNameMap[itemCode4]?html}</code></pre>
<p>When you use the noescape directive in a nested escape block, it undoes only a single level of escaping. Therefore, to completely turn off escaping in a two-level deep escaped block, you need to use two nested noescape directives as well.</p>
<h2 id="ref_directive_flush">flush</h2>
flush directive
<h3>Synopsis</h3>
<pre><code>&lt;#flush&gt;</code></pre>
<h3>Description</h3>
<p>When FreeMarker generates the output, it's usually not sent immediately to the final receiving party (like a web browser or a destination file), but is accumulated in a buffer, then it's sent out in bigger chunks. The exact rules of the buffering is not decided by FreeMarker, but by the embedding software. Sending out the content accumulated in the buffer is called flushing. Although flushing happens automatically, sometimes you want to force it on certain points of the template processing, and this is what the <code>flush</code> directive does. Whether it's needed at certain points should be decided by a programmer, not a designer.</p>
<p>Note that while <code>flush</code> tells the embedding software that we want to flush, that might as well decides to ignore this request. It's not in the hands of FreeMarker.</p>
<p>Flush simply calls the <code>flush()</code> method of the currently used <code>java.io.Writer</code> instance. The whole buffering and flushing mechanism is implemented in the <code>Writer</code> (that you have passed as the parameter of the <code>Template.process</code> method); FreeMarker does not deal with it.</p>
<h2 id="ref_directive_ftl">ftl</h2>
ftl directive
header
charset
encoding
white-space removal
stripping
<h3>Synopsis</h3>
<pre><code>&lt;#ftl param1=value1 param2=value2 ... paramN=valueN&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>param1</code>, <code>param2</code>, ...etc.: Name of the parameter. Not an expression. Allowed parameters are: <code>encoding</code>, <code>strip_whitespace</code>, <code>strip_text</code>, ...etc. See below.</p></li>
<li><p><code>value1</code>, <code>value2</code>, ...etc.: The value of parameter. This must be a constant expression (as <code>true</code>, or <code>&quot;ISO-8859-5&quot;</code>, or <code>{x:1, y:2}</code>). It can't use variables.</p></li>
</ul>
<h3>Description</h3>
<p>Tells information about the template for FreeMarker and for other tools, also helps programs to automatically detect if a text file is an FTL file. This directive, if present, must be the very first thing in the template. Any <a href="#gloss.whiteSpace">white-space</a> before this directive will be ignored. The old-syntax (<code>#</code>-less) format of this directive is not supported.</p>
<p>The settings (encoding, white-space stripping, etc.) given here has the highest precedence, that is, they will be used for the template regardless of any FreeMarker configuration settings.</p>
<p>Possible parameters:</p>
<ul>
<li><p><code>attributes</code>: This is a hash that associates arbitrary attributes (name-value pairs) to the template. The values of the attributes can be of any type (string, number, sequence... etc.). FreeMarker doesn't try to understand the meaning of the attributes. It's up to the application that encapsulates FreeMarker (as a Web application framework). Thus, the set of allowed attributes and their semantic is application (Web application framework) dependent. Programmers: you can get the attributes associated with a <code>Template</code> object with its <code>getCustomAttributeNames</code> and <code>getCustomAttribute</code> methods (inherited from <code>freemarker.core.Configurable</code>). As the template attributes are associated with the <code>Template</code> object when the template is parsed, the attributes can be read anytime, the template need not be executed. The methods mentioned return the attribute values unwrapped, that is, with FreeMarker independent type as <code>java.util.List</code>.</p></li>
<li><p><code>auto_esc</code>: A boolean constant to turn <a href="#dgui_misc_autoescaping">auto-escaping</a> on or off. It depends on the <code>auto_escaping_policy</code> of the FreeMarker configuration, but usually auto-escaping will be by default on, if the current <a href="#dgui_misc_autoescaping_outputformat">output format</a> uses auto-escaping by default. So you mostly use this to disable auto-escaping (<code>false</code> value). An attempt to use <code>true</code> value when the current output format is a <a href="#dgui_misc_autoescaping_nonmarkupof">non-markup output format</a> (which hence can't escape) will cause <a href="#gloss.parseTimeError">parse-time error</a>. Note that you can turn auto-escaping on/off for only a part of the template with the <a href="#ref_directive_autoesc"><code>autoesc</code></a> and <a href="#ref_directive_noautoesc"><code>noautoesc</code> directives</a>.</p></li>
<li><p><code>encoding</code>: With this you can specify the encoding (charset) of the template in the template file itself. (That is, this will be the <code>encoding</code> setting of the newly created <code>Template</code>, and not even the <code>encoding</code> parameter to <code>Configuration.getTemplate</code> can override it). Note however, that FreeMarker will try to find and interpret the <code>ftl</code> directive first with the automatically guessed encoding (which depends on the FreeMarker configuration set by the programmers), and only then realizes if the <code>ftl</code> directive dictates something different, and re-read the template with the new encoding. Thus, the template must be valid FTL until the end of <code>ftl</code> tag with the encoding tried first. The valid values of this parameter are MIME-preferred charset names from the IANA Charset Registry, like ISO-8859-5, UTF-8 or Shift_JIS.</p></li>
<li><p><code>ns_prefixes</code>: This is a hash that associates prefixes with node namespaces. For example: <code>{&quot;e&quot;:&quot;http://example.com/ebook&quot;,
              &quot;vg&quot;:&quot;http://example.com/vektorGraphics&quot;}</code>. This is mostly used with XML processing where the prefixes can be used in XML queries, but it also influences the working of <a href="#ref_directive_visit">directives <code>visit</code> and <code>recurse</code></a>. Only one prefix can be registered for the same node namespace (otherwise an error will occur), so there is one-to-one relation between prefixes and node namespaces. Prefixes <code>D</code> and <code>N</code> are reserved. If you register prefix <code>D</code>, then other than you associate the node namespace with prefix <code>D</code>, you also set the default node namespace. Prefix <code>N</code> can't be registered; it is used to denote nodes with no node namespace in certain places, when (and only when) prefix <code>D</code> is registered. (To see the usage of default node namespace, <code>N</code>, and prefixes in general, see the part about <a href="#xgui">XML processing</a> and <a href="#ref_directive_visit"><code>visit</code> and <code>recurse</code></a> in the reference.) The effect of <code>ns_prefixes</code> is limited to a single <a href="#dgui_misc_namespace">FTL namespace</a>, namely, to the FTL namespace that was created for the template. This also means that <code>ns_prefixes</code> has effect only when an FTL namespace is created for the template that contains it, otherwise the <code>ns_prefixes</code> parameter has no effect. An FTL namespace is made for a template when: (a) the template is the “main” template, that is, it is not invoked as a result of an <code>&lt;#include
              ...&gt;</code>, but it is directly invoked (with the <code>process</code> Java method of class <code>Template</code> or <code>Environment</code>); (b) the template is invoked directly with <code>&lt;#import
              ...&gt;</code>.</p></li>
<li><p><code>output_format</code>: Specifies the <a href="#dgui_misc_autoescaping_outputformat">output format</a> of this template. This must be a string literal, which refers to the name of the output format. See the <a href="#topic.predefinedOutputFormats">table of predefined output formats here</a>. Other names can exist if the programmers has added them via the <code>registered_custom_output_formats</code> configuration setting (<code>Configuration.setRegisteredCustomOutputFormats(...)</code>). The referred output format must be known by the <code>Configuration</code>, or else a <a href="#gloss.parseTimeError">parse-time error</a>will occur. The name can also refer to a so called combined output format as <code>&quot;outerFormatName{innerFormatName}&quot;</code>; <a href="#topic.combinedOutputFormats">see more about combined output formats here</a>.</p></li>
<li><p><code>strict_syntax</code>: This turns on/off “strict syntax”, which is the standard syntax after FreeMarker 2.1. Valid values are the boolean constants <code>true</code> and <code>false</code>. (And for backward compatibility, strings <code>&quot;yes&quot;</code>, <code>&quot;no&quot;</code>, <code>&quot;true&quot;</code>, <code>&quot;false&quot;</code>). The default value (i.e., when you don't use this parameter) depends on the FreeMarker configuration set by the programmers, but it's most certainly set to <code>true</code>. For more information read: <a href="#ref_depr_oldsyntax">section_title</a></p></li>
<li><p><code>strip_text</code>: When enabled, all top-level text in a template is removed when the template is parsed. This does not affect text within macros, directives, or interpolations. Valid values are the boolean constants <code>true</code> and <code>false</code>. (And for backward compatibility, strings <code>&quot;yes&quot;</code>, <code>&quot;no&quot;</code>, <code>&quot;true&quot;</code>, <code>&quot;false&quot;</code>). The default value (i.e. when you don't use this parameter) is <code>false</code>.</p></li>
<li><p><code>strip_whitespace</code>: This enables/disables <a href="#dgui_misc_whitespace_stripping">white-space stripping</a>. Valid values are the boolean constants <code>true</code> and <code>false</code>. (And for backward compatibility, strings <code>&quot;yes&quot;</code>, <code>&quot;no&quot;</code>, <code>&quot;true&quot;</code>, <code>&quot;false&quot;</code>). The default value (i.e. when you don't use this parameter) depends on the FreeMarker configuration set by the programmers, but it should be <code>true</code> for new projects.</p></li>
</ul>
<blockquote>
<p><strong>Note</strong></p>
<p>As of FreeMarker 2.3.23, you can use camel case instead of snake case for parameter names, like <code>outputFormat</code> instead of <code>output_format</code>. But know that then within the same template, FreeMarker will enforce the usage of camel case for all identifiers that are part of the template language (user defined names are not affected).</p>
</blockquote>
<p>This directive also determines if the template uses angle bracket syntax (e.g. <code>&lt;#include 'foo.ftl'&gt;</code>) or <a href="#dgui_misc_alternativesyntax">square bracket syntax</a> (e.g. <code>[#include 'foo.ftl']</code>). Simply, the syntax used for this directive will be the syntax used for the whole template, regardless of the FreeMarker configuration settings.</p>
<h2 id="ref_directive_function">function, return</h2>
function directive
return directive
method
defining with FTL
<h3>Synopsis</h3>
<pre><code>&lt;#function name param1 param2 ... paramN&gt;
  ...
  &lt;#return returnValue&gt;
  ...
&lt;/#function&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>name</code>: name of method variable (not expression)</p></li>
<li><p><code>param1</code>, <code>param2</code>, ...etc.: the name of the <a href="#dgui_misc_var">local variables</a> store the parameter values (not expression), optionally followed by <code>=</code> and the default value (that's an expression).</p></li>
<li><p><code>paramN</code>, the last parameter, may optionally include a trailing ellipsis (<code>...</code>), which indicates the macro takes a variable number of parameters. Local variable <code>paramN</code> will be a sequence of the extra parameters.</p></li>
<li><p><code>returnValue</code>: the expression that calculates the value of the method call.</p></li>
</ul>
<p>The <code>return</code> directive can be used anywhere and for any times between the <code>&lt;#function
          ...&gt;</code> and <code>&lt;/#function&gt;</code>.</p>
<p>Parameters without default value must precede parameters with default value (<code>paramName=defaultValue</code>).</p>
<h3>Description</h3>
<p>Creates a method variable (in the current namespace, if you know namespace feature). This directive works in the same way as the <a href="#ref.directive.macro"><code>macro</code> directive</a>, except that <code>return</code> directive <em>must</em> have a parameter that specifies the return value of the method, and that attempts to write to the output will be ignored. If the <code>&lt;/#function&gt;</code> is reached (i.e. there was no <code>return
          returnValue</code>), then the return value of the method is an undefined variable.</p>
<p>Example 1: Creating a method that calculates the average of two numbers:</p>
<pre><code>&lt;#function avg x y&gt;
  &lt;#return (x + y) / 2&gt;
&lt;/#function&gt;
${avg(10, 20)}</code></pre>
<p>will print:</p>
<pre><code>15</code></pre>
<p>Example 2: Creating a method that calculates the average of multiple numbers:</p>
<pre><code>&lt;#function avg nums...&gt;
  &lt;#local sum = 0&gt;
  &lt;#list nums as num&gt;
    &lt;#local sum += num&gt;
  &lt;/#list&gt;
  &lt;#if nums?size != 0&gt;
    &lt;#return sum / nums?size&gt;
  &lt;/#if&gt;
&lt;/#function&gt;
${avg(10, 20)}
${avg(10, 20, 30, 40)}
${avg()!&quot;N/A&quot;}</code></pre>
<p>will print:</p>
<pre><code>15
25
N/A</code></pre>
<h2 id="ref_directive_global">global</h2>
global directive
<h3>Synopsis</h3>
<pre><code>&lt;#global name=value&gt;
or
&lt;#global name1=value1 name2=value2 ... nameN=valueN&gt;
or
&lt;#global name&gt;
  capture this
&lt;/#global&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>name</code>: name of the variable. It is not expression. However, it can be written as a string literal, which is useful if the variable name contains reserved characters, for example <code>&lt;#global &quot;foo-bar&quot; = 1&gt;</code>. Note that this string literal does not expand interpolations (as <code>&quot;${foo}&quot;</code>).</p></li>
<li><p><code>=</code>: Assignment operator, which can also be one of the shorthand assignment operators (<code>++</code>, <code>+=</code>, etc.), just like with <a href="#ref_directive_assign">the <code>assign</code> directive</a>,</p></li>
<li><p><code>value</code>: the value to store. Expression.</p></li>
</ul>
<h3>Description</h3>
<p>This directive is similar to <a href="#ref.directive.assign"><code>assign</code></a>, but the variable created will be visible in all <a href="#dgui_misc_namespace">namespaces</a>, and will not be inside any namespace. Exactly as if you would create (or replace) a variable of the data-model. Hence, the variable is global. If a variable with the same name already exists in the data-model, it will be hidden by the variable created with this directive. If a variable with the same name already exists in the current namespace, that will hide the variable created with <code>global</code> directive.</p>
<p>For example, with <code>&lt;#global x = 1&gt;</code> you create a variable that is visible as <code>x</code> in all namespaces, unless another variable called <code>x</code> hides it (for example a variable what you have created as <code>&lt;#assign x = 2&gt;</code>). In this case, you can use <a href="#dgui_template_exp_var_special">special variable</a> <code>globals</code>, like <code>${.globals.x}</code>. Note that with <code>globals</code> you see all globally accessible variables; not only the variables that were created with <code>global</code> directive, but also the variables of the data-model.</p>
<p>Note for custom JSP tag users: The set of variables created with this directive corresponds to the JSP page-scope. This means, that if a custom JSP tag wants to get a page-scope attribute (page-scope bean), a variable with the same name in the current namespace will not hide it from the viewpoint of the JSP tag.</p>
<h2 id="ref_directive_if">if, else, elseif</h2>
if directive
else directive
elseif directive
<h3>Synopsis</h3>
<pre><code>&lt;#if condition&gt;
  ...
&lt;#elseif condition2&gt;
  ...
&lt;#elseif condition3&gt;
  ...
...
&lt;#else&gt;
  ...
&lt;/#if&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>condition</code>, <code>condition2</code>, ...etc.: Expression evaluates to a boolean value.</p></li>
</ul>
<p>The <code>elseif</code>-s and the <code>else</code> are optional.</p>
<p>Camel case name variant: <code>elseIf</code></p>
<h3>Description</h3>
<p>You can use <code>if</code>, <code>elseif</code> and <code>else</code> directives to conditionally skip a section of the template. The <code>condition</code>-s must evaluate to a boolean value, or else an error will abort template processing. The <code>elseif</code>-s and <code>else</code>-s must occur inside <code>if</code> (that is, between the <code>if</code> start-tag and end-tag). The <code>if</code> can contain any number of <code>elseif</code>-s (including 0) and at the end optionally one <code>else</code>. Examples:</p>
<p><code>if</code> with 0 <code>elseif</code> and no <code>else</code>:</p>
<pre><code>&lt;#if x == 1&gt;
  x is 1
&lt;/#if&gt;</code></pre>
<p><code>if</code> with 0 <code>elseif</code> and <code>else</code>:</p>
<pre><code>&lt;#if x == 1&gt;
  x is 1
&lt;#else&gt;
  x is not 1
&lt;/#if&gt;</code></pre>
<p><code>if</code> with 2 <code>elseif</code> and no <code>else</code>:</p>
<pre><code>&lt;#if x == 1&gt;
  x is 1
&lt;#elseif x == 2&gt;
  x is 2
&lt;#elseif x == 3&gt;
  x is 3
&lt;/#if&gt;</code></pre>
<p><code>if</code> with 3 <code>elseif</code> and <code>else</code>:</p>
<pre><code>&lt;#if x == 1&gt;
  x is 1
&lt;#elseif x == 2&gt;
  x is 2
&lt;#elseif x == 3&gt;
  x is 3
&lt;#elseif x == 4&gt;
  x is 4
&lt;#else&gt;
  x is not 1 nor 2 nor 3 nor 4
&lt;/#if&gt;</code></pre>
<p>To see more about boolean expressions, see: <a href="#dgui_template_exp">section_title</a>.</p>
<p>You can nest <code>if</code> directives (of course):</p>
<pre><code>&lt;#if x == 1&gt;
  x is 1
  &lt;#if y == 1&gt;
    and y is 1 too
  &lt;#else&gt;
    but y is not
  &lt;/#if&gt;
&lt;#else&gt;
  x is not 1
  &lt;#if y &lt; 0&gt;
    and y is less than 0
  &lt;/#if&gt;
&lt;/#if&gt;</code></pre>
<blockquote>
<p><strong>Note</strong></p>
<p>When you want to test if <code>x &gt; 0</code> or <code>x &gt;= 0</code>, writing <code>&lt;#if x &gt;
            0&gt;</code> and <code>&lt;#if x &gt;= 0&gt;</code> is WRONG, as the first <code>&gt;</code> will close the <code>#if</code> tag. To work that around, write <code>&lt;#if x gt 0&gt;</code> or <code>&lt;#if gte
            0&gt;</code>. Also note that if the comparison occurs inside parentheses, you will have no such problem, like <code>&lt;#if
            foo.bar(x &gt; 0)&gt;</code> works as expected.</p>
</blockquote>
<h2 id="ref_directive_import">import</h2>
import directive
<h3>Synopsis</h3>
<pre><code>&lt;#import path as hash&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>path</code>: The path of a template. This is an expression that evaluates to a string. (With other words, it doesn't have to be a fixed string, it can also be something like, for example, <code>profile.baseDir + &quot;/menu.ftl&quot;</code>.)</p></li>
<li><p><code>hash</code>: The unquoted name of hash variable by which you can access the namespace. Not an expression. (If you have to import into a dynamically constructed name, you have to use <a href="#faq_assign_to_dynamic_variable_name">this trick</a>.)</p></li>
</ul>
<h3>Description</h3>
<p>Imports a library. That is, it creates a new empty namespace, and then executes the template given with <code>path</code> parameter in that namespace so the template populates the namespace with variables (macros, functions, ...etc.). Then it makes the newly created namespace available to the caller with a hash variable. The hash variable will be created as a plain variable in the namespace used by the caller of <code>import</code> (as if you would create it with <code>assign</code> directive), with the name given with the <code>hash</code> parameter. If the import happens in the namespace of the main template, the hash variable is also created in the global namespace.</p>
<p>If you call <code>import</code> with the same <code>path</code> for multiple times, it will create the namespace and run the template for the very first call of <code>import</code> only. The later calls will just create a hash by which you can access the <em>same</em> namespace.</p>
<p>The output printed by the imported template will be ignored (will not be inserted at the place of importing). The template is executed to populate the namespace with variables, and not to write to the output.</p>
<p>Example:</p>
<pre><code>&lt;#import &quot;/libs/mylib.ftl&quot; as my&gt;

&lt;@my.copyright date=&quot;1999-2002&quot;/&gt;</code></pre>
<p>The <code>path</code> parameter can be a relative path like <code>&quot;foo.ftl&quot;</code> and <code>&quot;../foo.ftl&quot;</code>, or an absolute like <code>&quot;/foo.ftl&quot;</code>. Relative paths are relative to the directory of the template that uses the <code>import</code> directive. Absolute paths are relative to a base (often referred as the ''root directory of the templates'') that the programmer defines when he configures FreeMarker.</p>
<p>Always use <code>/</code> (slash) to separate path components, never <code>\</code> (backslash). If you are loading templates from your local file system and it uses backslashes (like under. Windows), FreeMarker will convert them automatically.</p>
<p>Like with the <code>include</code> directive, <a href="#ref_directive_include_acquisition">acquisition</a> and <a href="#ref_directive_include_localized">localized lookup</a> may be used for resolving the path.</p>
<p>Note, that it is possible to automatically do the commonly used imports for all templates, with the &quot;auto imports&quot; setting of <code>Configuration</code>.</p>
<p>If you are new to namespaces, you should read: <a href="#dgui_misc_namespace">section_title</a></p>
<h2 id="ref_directive_include">include</h2>
include directive
<h3>Synopsis</h3>
<pre><code>&lt;#include path&gt;
or
&lt;#include path options&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>path</code>: The path of the file to include; an expression that evaluates to a string. (With other words, it doesn't have to be a fixed string, it can also be something like, for example, <code>profile.baseDir + &quot;/menu.ftl&quot;</code>.)</p></li>
<li><p><code>options</code>: One or more of these: <code>encoding=encoding</code>, <code>parse=parse</code></p>
<ul>
<li><p><code>encoding</code>: Expression evaluates to string</p></li>
<li><p><code>parse</code>: Expression evaluates to boolean (also accepts a few string values for backward compatibility)</p></li>
<li><p><code>ignore_missing</code>: Expression evaluates to boolean</p></li>
</ul></li>
</ul>
<h3>Description</h3>
<p>You can use it to insert another FreeMarker template file (specified by the <code>path</code> parameter) into your template. The output from the included template is inserted at the point where the <code>include</code> tag occurs. The included file shares the variables with the including template, similarly like if it was copy-pasted into it. The <code>include</code> directive is not really replaced by the content of the included file, instead it processes the included file each time when FreeMarker reaches the <code>include</code> directive in the course of template processing. So for example if the <code>include</code> is inside a <code>list</code> loop, you can specify different file names in each cycle.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>This directive is not be confused with the JSP (Servlet) include, as it doesn't involve the Servlet container at all, just processes another FreeMarker template, without &quot;leaving&quot; FreeMarker. Regarding how to do a &quot;JSP include&quot; <a href="#faq_servlet_include">read this...</a></p>
</blockquote>
<p>The <code>path</code> parameter can be a relative path like <code>&quot;foo.ftl&quot;</code> and <code>&quot;../foo.ftl&quot;</code>, or an absolute like <code>&quot;/foo.ftl&quot;</code>. Relative paths are relative to the directory of the template that contains the <code>import</code> directive. Absolute paths are relative to a base (often referred as the 'root directory of the templates') that the programmer defines when he configures FreeMarker.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>This is different than the way it worked prior FreeMarker 2.1, where the path was always absolute. To preserve the old behavior, enable the classic compatible mode in the <code>Configuration</code> object.</p>
</blockquote>
<p>Always use <code>/</code> (slash) to separate path components, never <code>\</code> (backslash). Even if you are loading templates from your local file system and it uses backslashes (like under. Windows), use <code>/</code>.</p>
<p>Example:</p>
<p>Assume /common/copyright.ftl contains:</p>
<pre><code>Copyright 2001-2002 ${me}&lt;br&gt;
All rights reserved.</code></pre>
<p>Then this:</p>
<pre><code>&lt;#assign me = &quot;Juila Smith&quot;&gt;
&lt;h1&gt;Some test&lt;/h1&gt;
&lt;p&gt;Yeah.
&lt;hr&gt;
&lt;#include &quot;/common/copyright.ftl&quot;&gt;</code></pre>
<p>will output this:</p>
<pre><code>&lt;h1&gt;Some test&lt;/h1&gt;
&lt;p&gt;Yeah.
&lt;hr&gt;
Copyright 2001-2002 Juila Smith
All rights reserved.</code></pre>
<p>The supported <code>options</code> are:</p>
<ul>
<li><p><code>parse</code>: If it is <code>true</code>, then the included file will be parsed as FTL, otherwise the whole file will be considered as simple text (i.e, no FreeMarker constructs will be searched in it). If you omit this option, then it defaults to <code>true</code>.</p></li>
<li><p><code>encoding</code>: The encoding (charset) of the included template. You shouldn't use this option anymore; if different template use different encodings, then the programmers should associated the encoding to the templates via <code>Configuration.setTemplateConfigurations(...)</code>-s (which also overrides that you specify here). If <code>Configuration.setTemplateConfigurations(...)</code> doesn't specify an encoding for the included template, then the included file inherits the encoding (the charset) of the top-level template, unless you specify an encoding with this option. Examples of valid names: UTF-8, ISO-8859-1, ISO-8859-2, Shift_JIS, Big5, EUC-KR, GB2312. Encoding names are the same as the ones supported be java.io.InputStreamReader (as of Java API 1.3: MIME-preferred charset names from the IANA Charset Registry)</p></li>
<li><p><code>ignore_missing</code>: When <code>true</code>, suppresses the error when the template to include is missing, instead <code>&lt;#include
              ...&gt;</code> will print nothing. When <code>false</code>, the template processing will stop with error if the template is missing. If you omit this option, then it defaults to <code>false</code>.</p></li>
</ul>
<p>Example:</p>
<pre><code>&lt;#include &quot;/common/navbar.html&quot; parse=false encoding=&quot;Shift_JIS&quot;&gt;</code></pre>
<p>Note, that it is possible to automatically do the commonly used inclusions for all templates, with the &quot;auto includes&quot; setting of <code>Configuration</code>.</p>
<h4 id="ref_directive_include_acquisition">Using acquisition</h4>
acquisition
<p>There's a special path component represented by an asterisk (<code>*</code>). It is interpreted as &quot;this directory or any of its parents&quot;. Therefore, if the template located in <code>/foo/bar/template.ftl</code> has the following line:</p>
<pre><code>&lt;#include &quot;*/footer.ftl&quot;&gt;</code></pre>
<p>then the engine will look for the template in following locations, in this order:</p>
<ul>
<li><p><code>/foo/bar/footer.ftl</code></p></li>
<li><p><code>/foo/footer.ftl</code></p></li>
<li><p><code>/footer.ftl</code></p></li>
</ul>
<p>This mechanism is called <em>acquisition</em> and allows the designers to place commonly included files in a parent directory, and redefine them on a per-subdirectory basis as needed. We say that the including template acquires the template to include from the first parent directory that has it. Note that you can specify not only a template name to the right of the asterisk, but a subpath as well. I.e. if the previous template instead read:</p>
<pre><code>&lt;#include &quot;*/commons/footer.ftl&quot;&gt;</code></pre>
<p>then the engine would look for the template in following locations, in this order:</p>
<ul>
<li><p><code>/foo/bar/commons/footer.ftl</code></p></li>
<li><p><code>/foo/commons/footer.ftl</code></p></li>
<li><p><code>/commons/footer.ftl</code></p></li>
</ul>
<p>Finally, the asterisk needn't be the first element of the path:</p>
<pre><code>&lt;#include &quot;commons/*/footer.ftl&quot;&gt;</code></pre>
<p>would cause the engine to look for the template in following locations, in this order:</p>
<ul>
<li><p><code>/foo/bar/commons/footer.ftl</code></p></li>
<li><p><code>/foo/bar/footer.ftl</code></p></li>
<li><p><code>/foo/footer.ftl</code></p></li>
<li><p><code>/footer.ftl</code></p></li>
</ul>
<p>However, there can be at most one asterisk in the path. If you specifying more asterisks, the template won't be found.</p>
<h4 id="ref_directive_include_localized">Localized lookup</h4>
localization
<p>A locale is a language and an optional country or dialect identifier (plus also maybe a further variant identifier, like “MAC”). Whenever a template is requested, a desired locale is always specified (explicitly or implicitly), and FreeMarke will try to find a variant of the template that matches that locale. When a template includes or imports another template, internally that will also be requested for a locale, for the locale that the <code>locale</code> setting is set to, and that's usually for the locale of the top-level template.</p>
<p>Suppose your template was loaded with locale <code>en_US</code>, which means U.S. English. When you include another template:</p>
<pre><code>&lt;#include &quot;footer.ftl&quot;&gt;</code></pre>
<p>the engine will in fact look for several templates, in this order:</p>
<ul>
<li><p><code>footer_en_US.ftl</code>,</p></li>
<li><p><code>footer_en.ftl</code></p></li>
<li><p><code>footer.ftl</code></p></li>
</ul>
<p>and it will use the first one that exists.</p>
<p>Note that if how (and if) FreeMarker searches the localized variations is configurable by the programmers, so we are just describing the default behavior here.You can disable localized lookup with the <code>localized_lookup</code> setting (<code>Configuration.setLocalizedLookup(boolean)</code>). Also, you can define your own sequence of deduced template names with the <code>template_lookup_strategy</code> setting (<code>Configuration.setTemplateLookupStrategy(TemplateLookupStrategy)</code>).</p>
<p>When you use both acquisition (i.e., <code>*</code> step in the path) and localized template lookup, the template with more specific locale in a parent directory takes precedence over template with less specific locale in a child directory. Suppose you use the following include from <code>/foo/bar/template.ftl</code>:</p>
<pre><code>&lt;#include &quot;*/footer.ftl&quot;&gt;</code></pre>
<p>the engine will look for these templates, in this order:</p>
<ul>
<li><p><code>/foo/bar/footer_en_US.ftl</code></p></li>
<li><p><code>/foo/footer_en_US.ftl</code></p></li>
<li><p><code>/footer_en_US.ftl</code></p></li>
<li><p><code>/foo/bar/footer_en.ftl</code></p></li>
<li><p><code>/foo/footer_en.ftl</code></p></li>
<li><p><code>/footer_en.ftl</code></p></li>
<li><p><code>/foo/bar/footer.ftl</code></p></li>
<li><p><code>/foo/footer.ftl</code></p></li>
<li><p><code>/footer.ftl</code></p></li>
</ul>
<h2 id="ref_directive_list">list, else, items, sep, break, continue</h2>
list directive
sequence
iterate
<h3>Synopsis</h3>
<p>The simplest form for listing a sequence (or collection) is:</p>
<pre><code>&lt;#list sequence as item&gt;
    Part repeated for each item
&lt;/#list&gt;</code></pre>
<p>and to list the key-value pairs of a hash (since 2.3.25):</p>
<pre><code>&lt;#list hash as key, value&gt;
    Part repeated for each key-value pair
&lt;/#list&gt;</code></pre>
<p>But these are just cases of the generic forms, which are shown below. Note that for simplicity we only show the generic forms for sequence listing; simply replace “<code>as
          item</code>” with “<code>as key,
          value</code>” to get the generic form for hash listing.</p>
<p>Generic form 1:</p>
<pre><code>&lt;#list sequence as item&gt;
    Part repeated for each item
&lt;#else&gt;
    Part executed when there are 0 items
&lt;/#list&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p>The <code>else</code> part is optional, and is only supported since FreeMarker 2.3.23.</p></li>
<li><p><code>sequence</code>: Expressions evaluates to a sequence or collection of the items we want to iterate through</p></li>
<li><p><code>item</code>: Name of the <a href="#dgui_misc_var">loop variable</a> (not an expression)</p></li>
<li><p>The various “parts” between the tags can contain arbitrary FTL (including nested <code>list</code>-s)</p></li>
</ul>
<p>Generic form 2 (since FreeMarker 2.3.23):</p>
<pre><code>&lt;#list sequence&gt;
    Part executed once if we have more than 0 items
    &lt;#items as item&gt;
        Part repeated for each item
    &lt;/#items&gt;
    Part executed once if we have more than 0 items
&lt;#else&gt;
    Part executed when there are 0 items
&lt;/#list&gt;</code></pre>
<p>Where: see the “Where” section of Form 1 above (and thus the <code>else</code> part is optional here too).</p>
<h3>Description</h3>
<h4 id="ref_list_simple">Simplest form</h4>
<p>Assuming <code>users</code> contains the <code>['Joe', 'Kate', 'Fred']</code> sequence:</p>
<pre><code>&lt;#list users as user&gt;
  &lt;p&gt;${user}
&lt;/#list&gt;</code></pre>
<pre><code>  &lt;p&gt;Joe
  &lt;p&gt;Kate
  &lt;p&gt;Fred</code></pre>
<p>The <code>list</code> directive executes the code between the <code>list</code> start-tag and <code>list</code> end-tag (the body of <code>list</code> from now on) for each value in the sequence (or collection) specified as its first parameter. For each such iteration the loop variable (<code>user</code> in this example) will store the value of the current item.</p>
<p>The loop variable (<code>user</code>) only exists inside the <code>list</code> body. Also, macros/functions called from within the loop won't see it (as if it were a local variable).</p>
<p>Listing hashes is very similar, but you need to provide two variable names after the <code>as</code>; one for the hash key, and another for the associated value. Assuming <code>products</code> is <code>{ &quot;apple&quot;: 5, &quot;banana&quot;:
            10, &quot;kiwi&quot;: 15 }</code>:</p>
<pre><code>&lt;#list products as name, price&gt;
  &lt;p&gt;${name}: ${price}
&lt;/#list&gt;</code></pre>
<pre><code>  &lt;p&gt;apple: 5
  &lt;p&gt;banan: 10
  &lt;p&gt;kiwi: 15</code></pre>
<p>Note that not all hash variables can be listed, because some of them isn't able to enumerate its keys. It's practically safe to assume though that hashes that stand for Java <code>Map</code> objects can be listed.</p>
<h4 id="ref_list_else">else directive</h4>
else directive inside list
<blockquote>
<p><strong>Note</strong></p>
<p><code>else</code> inside <code>list</code> is only supported since FreeMarker 2.3.23</p>
</blockquote>
<p>The <code>else</code> directive is used if when there are 0 items, you have to print something special instead of just printing nothing:</p>
<pre><code>&lt;#list users as user&gt;
  &lt;p&gt;${user}
&lt;#else&gt;
  &lt;p&gt;No users
&lt;/#list&gt;</code></pre>
<p>This outputs the same as the earlier example, except when <code>users</code> contains 0 items:</p>
<pre><code>  &lt;p&gt;No users</code></pre>
<p>Note that the loop variable (<code>user</code>) doesn't exist between the <code>else</code> tag and the <code>list</code> end-tag, since that part is not part of the loop.</p>
<p><code>else</code> must be literally (means, in the source code) inside the body of the <code>list</code> directive. That is, you can't moved it out into a macro or included template.</p>
<h4 id="ref_list_items">items directive</h4>
items directive
<blockquote>
<p><strong>Note</strong></p>
<p><code>items</code> exists since FreeMarker 2.3.23</p>
</blockquote>
<p>The <code>items</code> directive is used if you have to print (or do) something before the first list item, and after the last list item, as far as there's at least 1 item. A typical example:</p>
<pre><code>&lt;#list users&gt;
  &lt;ul&gt;
    &lt;#items as user&gt;
      &lt;li&gt;${user}&lt;/li&gt;
    &lt;/#items&gt;
  &lt;/ul&gt;
&lt;/#list&gt;</code></pre>
<pre><code>  &lt;ul&gt;
      &lt;li&gt;Joe&lt;/li&gt;
      &lt;li&gt;Kate&lt;/li&gt;
      &lt;li&gt;Fred&lt;/li&gt;
  &lt;/ul&gt;</code></pre>
<p>If there are 0 items, the above won't print anything, thus you don't end up with an empty <code>&lt;ul&gt;&lt;/ul&gt;</code>.</p>
<p>That is, when the <code>list</code> directive has no <code>as item</code> parameter, the body of its is executed exactly once if there's at least one item, or not at all otherwise. It's the body of the mandatory nested <code>items</code> directive that will be run for each item, and hence it's also the <code>items</code> directive that defines the loop variable with <code>as
            item</code>, not <code>list</code>.</p>
<p>A <code>list</code> directive with <code>items</code> also can have an <code>else</code> directive:</p>
<pre><code>&lt;#list users&gt;
  &lt;ul&gt;
    &lt;#items as user&gt;
      &lt;li&gt;${user}&lt;/li&gt;
    &lt;/#items&gt;
  &lt;/ul&gt;
&lt;#else&gt;
  &lt;p&gt;No users
&lt;/#list&gt;</code></pre>
<p>Some further details:</p>
<ul>
<li><p>The parser will check that a <code>list</code> without <code>as item</code> parameter always has a nested <code>items</code> directive, and that an <code>items</code> directive always has an enclosing <code>list</code> which has no <code>as item</code> parameter. This is checked when the template is parsed, not when the template is executed. Thus, these rules apply on the FTL source code itself, so you can't move <code>items</code> out into a macro or included template.</p></li>
<li><p>A <code>list</code> can have multiple <code>items</code> directives, but only one of them will be allowed to run (as far as you don't leave and re-enter the enclosing <code>list</code> directive); and further attempts to call <code>items</code> will cause error. So multiple <code>items</code> can be utilized on different <code>if</code>-<code>else</code> branches for example, but not for iterating twice.</p></li>
<li><p><code>items</code> directive can't have its own nested <code>else</code> directive, only the enclosing <code>list</code> can have</p></li>
<li><p>The loop variable (<code>user</code>) only exists inside the body of the <code>items</code> directive.</p></li>
</ul>
<h4 id="ref_list_sep">sep directive</h4>
sep directive
<blockquote>
<p><strong>Note</strong></p>
<p><code>sep</code> exists since FreeMarker 2.3.23</p>
</blockquote>
<p><code>sep</code> is used when you have to display something between each item (but not before the first item or after the last item). For example:</p>
<pre><code>&lt;#list users as user&gt;${user}&lt;#sep&gt;, &lt;/#list&gt;</code></pre>
<pre><code>Joe, Kate, Fred</code></pre>
<p>Above, <code>&lt;#sep&gt;, &lt;/#list&gt;</code> is a shorthand for <code>&lt;#sep&gt;,
            &lt;/#sep&gt;&lt;/#list&gt;</code>; the <code>sep</code> end-tag can be omitted if you would put it where the enclosing directive is closed anyway. In the next example, you couldn't use such abbreviation (HTML tags close nothing, as they are just raw text to output for FreeMarker):</p>
<pre><code>&lt;#list users as user&gt;
  &lt;div&gt;
    ${user}&lt;#sep&gt;, &lt;/#sep&gt;
  &lt;/div&gt;
&lt;/#list&gt;</code></pre>
<p><code>sep</code> is just a shorthand for <code>&lt;#if
            item?has_next&gt;...&lt;/#if&gt;</code>. Thus, it can be used anywhere where there's a <code>list</code> or <code>items</code> loop variable available, it can occur for multiple times, and it can have arbitrary nested content.</p>
<p>The parser ensures that <code>sep</code> is only used on a place where there's a visible loop variable. This happens earlier than the actual execution of the template. Thus, you can't move <code>sep</code> from inside the associated <code>list</code> or <code>items</code> directive into a macro or included template (the parser can't know where those will be called from).</p>
<h4 id="ref_list_break">break directive</h4>
break directive
<p>You can exit the iteration at any point with the <code>break</code> directive. For example:</p>
<pre><code>&lt;#list 1..10 as x&gt;
  ${x}
  &lt;#if x == 3&gt;
    &lt;#break&gt;
  &lt;/#if&gt;
&lt;/#list&gt;</code></pre>
<pre><code>  1
  2
  3</code></pre>
<p>The <code>break</code> directives can be placed anywhere inside <code>list</code> as far as it has <code>as item</code> parameter, otherwise it can be placed anywhere inside the <code>items</code> directive. However, it's strongly recommended to place it either before or after all the other things that you do inside the iteration. Otherwise it's easy to end up with unclosed elements in the output, or otherwise make the template harder to understand. Especially, avoid breaking out from the nested content of custom directives (like <code>&lt;#list
            ...&gt;...&lt;@foo&gt;...&lt;#break&gt;...&lt;/@foo&gt;...&lt;/#list&gt;</code>), as the author of the directive may not expect that the closing tag (<code>&lt;/@foo&gt;</code>) is never executed.</p>
<p>If the <code>break</code> is inside <code>items</code>, it will only exit from <code>items</code>, not from <code>list</code>. In general, <code>break</code> will only exit from the directive whose body is called for each item, and can only be placed inside such directive. So for example can't use <code>break</code> inside <code>list</code>'s <code>else</code> section, unless there's the <code>list</code> is nested into another <code>break</code>-able directive.</p>
<p>Using <code>break</code> together with <code>sep</code> is generally a bad idea, as <code>sep</code> can't know if you will skip the rest of items with <code>break</code>, and then you end up with a separator after the item printed last.</p>
<p>Just like <code>else</code> and <code>items</code>, <code>break</code> must be literally inside body of the directive to break out from, and can't be moved out into a macro or included template.</p>
<h4 id="ref_list_continue">continue directive</h4>
continue directive
<blockquote>
<p><strong>Note</strong></p>
<p>The <code>continue</code> directive exists since FreeMarker 2.3.27</p>
</blockquote>
<p>You can skip the rest of the iteration body (the section until the <code>&lt;/#list&gt;</code> or <code>&lt;/#items&gt;</code> tag) with the <code>continue</code> directive, then FreeMarker will continue with the next item. For example:</p>
<pre><code>&lt;#list 1..5 as x&gt;
  &lt;#if x == 3&gt;
    &lt;#continue&gt;
  &lt;/#if&gt;
  ${x}
&lt;/#list&gt;</code></pre>
<pre><code>  1
  2
  4
  5</code></pre>
<p>The <code>continue</code> directives can be placed anywhere inside <code>list</code> as far as it has <code>as item</code> parameter, otherwise it can be placed anywhere inside the <code>items</code> directive. However, it's strongly recommended to place it before all the other things you do inside the iteration. Otherwise it's easy to end up with unclosed elements in the output, or otherwise make the template harder to understand. Especially, avoid breaking out from the nested content of custom directives (like <code>&lt;#list
            ...&gt;...&lt;@foo&gt;...&lt;#continue&gt;...&lt;/@foo&gt;...&lt;/#list&gt;</code>), as the author of the directive may not expect that the closing tag (<code>&lt;/@foo&gt;</code>) is never executed.</p>
<p>When you call <code>continue</code>, the <code>sep</code> directive will not be executed for that iteration. Using <code>continue</code> together with <code>sep</code> is generally a bad idea, as <code>sep</code> can't know if you will skip the rest of the items, and then you end up with a separator after the item printed last.</p>
<p>Just like <code>break</code>, <code>continue</code> must be literally inside body of the directive whose iteration need to be “continued”, and can't be moved out into a macro or included template.</p>
<h4 id="ref_list_accessing_state">Accessing iteration state</h4>
iteration state
listing state
<p>Starting from 2.3.23, <a href="#ref_builtins_loop_var">loop variable built-ins</a> is the preferred way of accessing current state of the iteration. For example, here we use the <code>counter</code> and <code>item_parity</code> loop variable built-ins (see all of them <a href="#ref_builtins_loop_var">in the Reference</a>):</p>
<pre><code>&lt;#list users&gt;
  &lt;table&gt;
    &lt;#items as user&gt;
      &lt;tr class=&quot;${user?item_parity}Row&quot;&gt;
        &lt;td&gt;${user?counter}
        &lt;td&gt;${user}
    &lt;/#items&gt;
  &lt;/table&gt;
&lt;/#list&gt;</code></pre>
<pre><code>  &lt;table&gt;
      &lt;tr class=&quot;oddRow&quot;&gt;
        &lt;td&gt;1
        &lt;td&gt;Joe
      &lt;tr class=&quot;evenRow&quot;&gt;
        &lt;td&gt;2
        &lt;td&gt;Kate
      &lt;tr class=&quot;oddRow&quot;&gt;
        &lt;td&gt;3
        &lt;td&gt;Fred
  &lt;/table&gt;</code></pre>
<p>In 2.3.22 and earlier, there were two extra loop variables to retrieve the iteration state instead (and they still exist for backward compatibility):</p>
<ul>
<li><p><code>item_index</code> (<em>deprecated</em> by <code>item?index</code>): The index (0-based number) of the current item in the loop.</p></li>
<li><p><code>item_has_next</code> (<em>deprecated</em> by <code>item?has_next</code>): Boolean value that tells if the current item is the last in the sequence or not.</p></li>
</ul>
<p>so in the above example, you could replace <code>${user?counter}</code> with <code>${user_index +
            1}</code>.</p>
<h4 id="ref_list_nesting">Nesting loops into each other</h4>
<p>Naturally, <code>list</code> or <code>items</code> can contain further <code>list</code>-s:</p>
<pre><code>&lt;#list 1..2 as i&gt;
  &lt;#list 1..3 as j&gt;
    i = ${i}, j = ${j}
  &lt;/#list&gt;
&lt;/#list&gt;</code></pre>
<pre><code>    i = 1, j = 1
    i = 1, j = 2
    i = 1, j = 3
    i = 2, j = 1
    i = 2, j = 2
    i = 2, j = 3</code></pre>
<p>It's also allowed to use clashing loop variable names like:</p>
<pre><code>&lt;#list 1..2 as i&gt;
  Outer: ${i}
  &lt;#list 10..12 as i&gt;
    Inner: ${i}
  &lt;/#list&gt;
  Outer again: ${i}
&lt;/#list&gt;</code></pre>
<pre><code>  Outer: 1
    Inner: 10
    Inner: 11
    Inner: 12
  Outer again: 1
  Outer: 2
    Inner: 10
    Inner: 11
    Inner: 12
  Outer again: 2</code></pre>
<h4 id="ref_list_java_notes">Notes for Java programmers</h4>
<p>If classic compatible mode <code>list</code> accepts a scalar too and treats it as a single-element sequence.</p>
<p>If you pass a collection that wraps an <code>java.util.Iterator</code> to the <code>list</code>, you can iterate over its elements only once, since <code>Iterator</code>s are by their nature one-off objects. When you try to list a such collection variable for the second time, an error will abort template processing.</p>
<h2 id="ref_directive_local">local</h2>
local directive
<h3>Synopsis</h3>
<pre><code>&lt;#local name=value&gt;
or
&lt;#local name1=value1 name2=value2 ... nameN=valueN&gt;
or
&lt;#local name&gt;
  capture this
&lt;/#local&gt;
</code></pre>
<p>Where:</p>
<ul>
<li><p><code>name</code>: the name of the local object in the root. It is not an expression. However, it can be written as a string literal, which is useful if the variable name contains reserved characters, for example <code>&lt;#local &quot;foo-bar&quot; = 1&gt;</code>. Note that this string literal does not expand interpolations (as <code>&quot;${foo}&quot;</code>).</p></li>
<li><p><code>=</code>: Assignment operator, which can also be one of the shorthand assignment operators (<code>++</code>, <code>+=</code>, etc.), just like with <a href="#ref_directive_assign">the <code>assign</code> directive</a>,</p></li>
<li><p><code>value</code>: the value to store. Expression.</p></li>
</ul>
<h3>Description</h3>
<p>It is similar to <a href="#ref.directive.assign">assign directive</a>, but it creates or replaces local variables. This only works inside macro definitions and function definitions.</p>
<p>For more information about variables, read this: <a href="#dgui_misc_var">section_title</a></p>
<blockquote>
<p><strong>Note</strong></p>
<p>A frequent mistake is trying to use <code>assign</code> to change a local variable like: <code>&lt;#macro m&gt;&lt;#local x = 1&gt;${x}&lt;#assign x =
            2&gt;${x}&lt;/#macro&gt;</code>. This prints <code>11</code>, not <code>12</code>, because <code>assign</code> creates/replaces the <code>x</code> of the namespace that the template belongs to, and doesn't change the <code>x</code> local variable. Local variables should be always set with the <a href="#ref.directive.local"><code>local</code> directive</a>, not just for the fist time.</p>
</blockquote>
<h2 id="ref_directive_macro">macro, nested, return</h2>
macro directive
nested directive
return directive
<h3>Synopsis</h3>
<pre><code>&lt;#macro name param1 param2 ... paramN&gt;
  ...
  &lt;#nested loopvar1, loopvar2, ..., loopvarN&gt;
  ...
  &lt;#return&gt;
  ...
&lt;/#macro&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>name</code>: name of macro variable. It's not an expression. It follows the same syntax as <a href="#dgui_template_exp_var_toplevel">like top-level variable references</a>, like <code>myMacro</code> or <code>my\-macro</code>. However, it can also be written as a string literal, which is useful if the macro name contains characters that can't be specified in an identifier, for example <code>&lt;#macro
              &quot;foo~bar&quot;&gt;...</code>. Note that this string literal does not expand interpolations (as <code>&quot;${foo}&quot;</code>).</p></li>
<li><p><code>param1</code>, <code>param2</code>, ...etc.: the name of the <a href="#dgui_misc_var">local variables</a> store the parameter values (not expression), optionally followed by <code>=</code> and the default value (that's an expression). The default value can even be another parameter, for example <code>&lt;#macro section title
              label=title&gt;</code>. The parameter name uses the same syntax as <a href="#dgui_template_exp_var_toplevel">like top-level variable references</a>, so the same features and restrictions apply.</p></li>
<li><p>catch-all parametervariable number of parameters<code>paramN</code>, the last parameter may optionally has 3 trailing dots (<code>...</code>), which indicates that the macro takes a variable number of parameters and the parameters that doesn't match any other parameters will be collected in this last parameter (also called the catch-all parameter). When the macro is called with named parameters, <code>paramN</code> will be a hash containing all of the undeclared key/value pairs passed to the macro. When the macro is called using positional parameters, <code>paramN</code> will be the sequence of the extra parameter values. (Inside the macro, to find out which was the case, you can use <code>myCatchAllParam?is_sequence</code>.)</p></li>
<li><p><code>loopvar1</code>, <code>loopvar2</code>, ...etc.: Optional. The values of <a href="#dgui_misc_var">loop variables</a> that the <code>nested</code> directive wants to create for the nested content. These are expressions.</p></li>
</ul>
<p>The <code>return</code> and <code>nested</code> directives are optional and can be used anywhere and for any times between the <code>&lt;#macro
          ...&gt;</code> and <code>&lt;/#macro&gt;</code>.</p>
<p>Parameters without default value must precede parameters with default value (<code>paramName=defaultValue</code>).</p>
<h3>Description</h3>
<p>Creates a macro variable (in the current namespace, if you know namespace feature). If you are new to macros and user-defined directives you should read the <a href="#dgui_misc_userdefdir">the tutorial about user-defined directives</a>.</p>
<p>Macro variable stores a template fragment (called macro definition body) that can be used as <a href="#ref.directive.userDefined">user-defined directive</a>. The variable also stores the name of allowed parameters to the user-defined directive. You must give value for all of those parameters when you use the variable as directive, except for parameters that has a default value. The default value will be used if and only if you don't give value for the parameter when you call the macro.</p>
<p>The variable will be created at the beginning of the template; it does not mater where the <code>macro</code> directive is placed in the template. Thus, this will work:</p>
<pre><code>&lt;#-- call the macro; the macro variable is already created: --&gt;
&lt;@test/&gt;
...

&lt;#-- create the macro variable: --&gt;
&lt;#macro test&gt;
  Test text
&lt;/#macro&gt;</code></pre>
<p>However, if the macro definitions are inserted with <code>include</code> directive, they will not be available until FreeMarker has executed the <code>include</code> directive.</p>
<p>Example: Macro without parameters:</p>
<pre><code>&lt;#macro test&gt;
  Test text
&lt;/#macro&gt;
&lt;#-- call the macro: --&gt;
&lt;@test/&gt;</code></pre>
<p>Output:</p>
<pre><code>  Test text
 </code></pre>
<p>Example: Macro with parameters:</p>
<pre><code>&lt;#macro test foo bar baaz&gt;
  Test text, and the params: ${foo}, ${bar}, ${baaz}
&lt;/#macro&gt;
&lt;#-- call the macro: --&gt;
&lt;@test foo=&quot;a&quot; bar=&quot;b&quot; baaz=5*5-2/&gt;</code></pre>
<p>Output:</p>
<pre><code>  Test text, and the params: a, b, 23
   </code></pre>
<p>Example: Macro with parameters and default parameter values:</p>
<pre><code>&lt;#macro test foo bar=&quot;Bar&quot; baaz=-1&gt;
  Test text, and the params: ${foo}, ${bar}, ${baaz}
&lt;/#macro&gt;
&lt;@test foo=&quot;a&quot; bar=&quot;b&quot; baaz=5*5-2/&gt;
&lt;@test foo=&quot;a&quot; bar=&quot;b&quot;/&gt;
&lt;@test foo=&quot;a&quot; baaz=5*5-2/&gt;
&lt;@test foo=&quot;a&quot;/&gt;</code></pre>
<p>Output:</p>
<pre><code>  Test text, and the params: a, b, 23
  Test text, and the params: a, b, -1
  Test text, and the params: a, Bar, 23
  Test text, and the params: a, Bar, -1
 </code></pre>
<p>Example: A more complex macro.</p>
<pre><code>&lt;#macro list title items&gt;
  &lt;p&gt;${title?cap_first}:
  &lt;ul&gt;
    &lt;#list items as x&gt;
      &lt;li&gt;${x?cap_first}
    &lt;/#list&gt;
  &lt;/ul&gt;
&lt;/#macro&gt;
&lt;@list items=[&quot;mouse&quot;, &quot;elephant&quot;, &quot;python&quot;] title=&quot;Animals&quot;/&gt;</code></pre>
<p>Output:</p>
<pre><code>  &lt;p&gt;Animals:
  &lt;ul&gt;
      &lt;li&gt;Mouse
      &lt;li&gt;Elephant
      &lt;li&gt;Python
  &lt;/ul&gt;
 </code></pre>
<p>Example: A macro with support for a variable number of named parameters:</p>
<pre><code>&lt;#macro img src extra...&gt;
  &lt;img src=&quot;/myapp${src?ensure_starts_with(&#39;/&#39;)}&quot;
    &lt;#list extra as attrName, attrVal&gt;
      ${attrName}=&quot;${attrVal}&quot;
    &lt;/#list&gt;
  &gt;
&lt;/#macro&gt;
&lt;@img src=&quot;/images/test.png&quot; width=100 height=50 alt=&quot;Test&quot;/&gt;</code></pre>
<p>Output:</p>
<pre><code>  &lt;img src=&quot;/context/images/test.png&quot;
    alt=&quot;Test&quot;
    height=&quot;50&quot;
    width=&quot;100&quot;
  &gt;</code></pre>
<p>Example: A macro that supports a variable number of positional parameters, regardless if it uses named or positional parameter passing:</p>
<pre><code>&lt;#macro m a b ext...&gt;
  a = ${a}
  b = ${b}
  &lt;#if ext?is_sequence&gt;
    &lt;#list ext as e&gt;
      ${e?index} = ${e}
    &lt;/#list&gt;
  &lt;#else&gt;
    &lt;#list ext as k, v&gt;
      ${k} = ${v}
    &lt;/#list&gt;
  &lt;/#if&gt;
&lt;/#macro&gt;

&lt;@m 1 2 3 4 5 /&gt;

&lt;@m a=1 b=2 c=3 d=4 e=5 data\-foo=6 myns\:bar=7 /&gt;</code></pre>
<p>Output:</p>
<pre><code>  a = 1
  b = 2
      0 = 3
      1 = 4
      2 = 5

  a = 1
  b = 2
      c = 3
      d = 4
      e = 5
      data-foo=6
      myns:bar=7</code></pre>
<blockquote>
<p><strong>Warning</strong></p>
<p>Currently, named catch-all parameters are unordered, that is, you don't know what order will they be enumerated. That is, they aren't returned in the same order as they were passed in (that above example output shows them in the same order for understandability only).</p>
</blockquote>
<h4>nested</h4>
<p>The <code>nested</code> directive executes the template fragment between the start-tag and end-tags of the user-defined directive. The nested part can contain anything what is valid in templates; interpolations, directives, ...etc. It is executed in the context where the macro was called from, rather than in the context of the macro definition body. Thus, for example, you don't see the local variables of the macro in the nested part. If you don't call the <code>nested</code> directive, the part between the start-tag and end-tags of the user-defined directive will be ignored.</p>
<p>Example:</p>
<pre><code>&lt;#macro do_twice&gt;
  1. &lt;#nested&gt;
  2. &lt;#nested&gt;
&lt;/#macro&gt;
&lt;@do_twice&gt;something&lt;/@do_twice&gt;</code></pre>
<pre><code>  1. something
  2. something
 </code></pre>
<p>The nested directive can create loop variables for the nested content. For example:</p>
<pre><code>&lt;#macro do_thrice&gt;
  &lt;#nested 1&gt;
  &lt;#nested 2&gt;
  &lt;#nested 3&gt;
&lt;/#macro&gt;
&lt;@do_thrice ; x&gt;
  ${x} Anything.
&lt;/@do_thrice&gt;</code></pre>
<pre><code>  1 Anything.
  2 Anything.
  3 Anything.
 </code></pre>
<p>A more complex example:</p>
<pre><code>&lt;#macro repeat count&gt;
  &lt;#list 1..count as x&gt;
    &lt;#nested x, x/2, x==count&gt;
  &lt;/#list&gt;
&lt;/#macro&gt;
&lt;@repeat count=4 ; c, halfc, last&gt;
  ${c}. ${halfc}&lt;#if last&gt; Last!&lt;/#if&gt;
&lt;/@repeat&gt;</code></pre>
<pre><code>  1. 0.5
  2. 1
  3. 1.5
  4. 2 Last!
 </code></pre>
<h4>return</h4>
<p>With the <code>return</code> directive, you can leave a macro or function definition body anywhere. Example:</p>
<pre><code>&lt;#macro test&gt;
  Test text
  &lt;#return&gt;
  Will not be printed.
&lt;/#macro&gt;
&lt;@test/&gt;</code></pre>
<pre><code>  Test text
  </code></pre>
<h2 id="ref_directive_noautoesc">noautoesc</h2>
noautoesc directive
auto-escaping
escaping
<h3>Synopsis</h3>
<pre><code>&lt;#noautoesc&gt;
  ...
&lt;/#noautoesc&gt;</code></pre>
<p>Camel case name variant: <code>noAutoEsc</code></p>
<h3>Description</h3>
<p>Disables <a href="#dgui_misc_autoescaping">auto-escaping</a> in the nested section. Note that to prevent escaping for just a single <code>${expression}</code> you should use <code>${expression?no_esc}</code> instead.</p>
<p>This directive only has effect on the section that is literally (as in the text editor) inside the nested bock, not on the parts that are called/included from there.</p>
<p>Example:</p>
<pre><code>&lt;#ftl output_format=&quot;XML&quot;&gt;
${&quot;&amp;&quot;}
&lt;#noautoesc&gt;
  ${&quot;&amp;&quot;}
  ...
  ${&quot;&amp;&quot;}
&lt;/#noautoesc&gt;
${&quot;&amp;&quot;}</code></pre>
<pre><code>&amp;amp;
  &amp;
  ...
  &amp;
&amp;amp;</code></pre>
<p><code>noautoesc</code> can be used regardless of what the current <a href="#dgui_misc_autoescaping_outputformat">output format</a> is (unlike the <a href="#ref_directive_autoesc"><code>autoesc</code> directive</a>).</p>
<p><code>noautoesc</code> can also be used nested into <a href="#ref_directive_autoesc"><code>autoesc</code> directive</a> to re-enable escaping.</p>
<p><code>noautoesc</code> can be used on places where auto-escaping is already disabled, such as even inside another <code>noautoesc</code> block. Doing so is redundant but allowed.</p>
<h2 id="ref_directive_noparse">noparse</h2>
noparse directive
<h3>Synopsis</h3>
<pre><code>&lt;#noparse&gt;
  ...
&lt;/#noparse&gt;</code></pre>
<p>Camel case name variant: <code>noParse</code></p>
<h3>Description</h3>
<p>FreeMarker will not search FTL tags and interpolations and other special character sequences in the body of this directive, except the noparse end-tag.</p>
<p>Example:</p>
<pre><code>Example:
--------

&lt;#noparse&gt;
  &lt;#list animals as animal&gt;
  &lt;tr&gt;&lt;td&gt;${animal.name}&lt;td&gt;${animal.price} Euros
  &lt;/#list&gt;
&lt;/#noparse&gt;</code></pre>
<pre><code>Example:
--------

  &lt;#list animals as animal&gt;
  &lt;tr&gt;&lt;td&gt;${animal.name}&lt;td&gt;${animal.price} Euros
  &lt;/#list&gt;
 </code></pre>
<h2 id="ref_directive_nt">nt</h2>
nt directive
trimmer directives
white-space removal
trimming
white-space removal
stripping
<h3>Synopsis</h3>
<pre><code>&lt;#nt&gt;</code></pre>
<h3>Description</h3>
<p>“No Trim”. This directive disables <a href="#dgui_misc_whitespace_stripping">white-space stripping</a> in the line where it occurs. It also disables the effect of other trim directives occurring in the same line (the effect of <code>t</code>, <code>rt</code>, <code>lt</code>).</p>
<h2 id="ref_directive_outputformat">outputformat</h2>
outputformat directive
auto-escaping
escaping
<h3>Synopsis</h3>
<pre><code>&lt;#outputformat formatName&gt;
  ...
&lt;/#outputFormat&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>formatName</code>: A string constant; can't contain runtime expressions! This is the name of the output format, like <code>&quot;HTML&quot;</code>, <code>&quot;XML&quot;</code>, etc.; see the <a href="#topic.predefinedOutputFormats">table of the predefined output formats here</a>. The referred output format must be known by the <code>Configuration</code>, or else a <a href="#gloss.parseTimeError">parse-time error</a> will occur. The name can also be like <code>&quot;outerFormatName{innerFormatName}&quot;</code>, or <code>&quot;{innerFormatName}&quot;</code>; <a href="#topic.combinedOutputFormats">see combined output formats later</a>.</p></li>
</ul>
<p>Camel case name variant: <code>outputFormat</code></p>
<blockquote>
<p><strong>Note</strong></p>
<p><code>outputformat</code> exists since FreeMarker 2.3.24.</p>
</blockquote>
<h3>Description</h3>
<p>Sets the <a href="#dgui_misc_autoescaping_outputformat">output format</a> to the specified one, inside the nested block. At the end of the block, the earlier output format is restored.</p>
<p>This directive only has effect on the section that is literally (as in the text editor) inside the nested bock, not on the parts that are called/included from there.</p>
<p>Example:</p>
<pre><code>&lt;#ftl output_format=&quot;XML&quot;&gt;
XML escaping: ${&quot;&amp;{}&quot;}
&lt;#outputformat &quot;RTF&quot;&gt;
  RTF escaping: ${&quot;&amp;{}&quot;}
&lt;/#outputformat&gt;
&lt;#outputformat &quot;plainText&quot;&gt;
  No escsaping: ${&quot;&amp;{}&quot;}
&lt;/#outputformat&gt;
XML escsaping: ${&quot;&amp;{}&quot;}</code></pre>
<pre><code>XML escsaping: &amp;amp;{}
  RTF escaping: &amp;\{\}
  No escsaping: &amp;{}
XML escsaping: &amp;amp;{}</code></pre>
<p>When <code>outputformat</code>-s are nested into each other, normally, only the innermost output format will count. For example:</p>
<pre><code>&lt;#ftl output_format=&quot;XML&quot;&gt;
${&quot;&#39;{}&quot;}
&lt;#outputformat &quot;HTML&quot;&gt;
  ${&quot;&#39;{}&quot;}
  &lt;#outputformat &quot;RTF&quot;&gt;
    ${&quot;&#39;{}&quot;}
  &lt;/#outputformat&gt;
&lt;/#outputformat&gt;</code></pre>
<pre><code>&amp;apos;{}
  &amp;#39;{}
    &#39;\{\}</code></pre>
<p>But sometimes you want all enclosing output format escaping to be applied at once. In that case the 2nd <code>${...}</code> above should be escaped with <code>&quot;HTML&quot;</code> and then with <code>&quot;XML&quot;</code>, and the 3rd <code>${...}</code> should be escaped with <code>&quot;RTF&quot;</code> and then with <code>&quot;HTML&quot;</code> and then with <code>&quot;XML&quot;</code>. These are called combined output formats, and can be referred by names like <code>&quot;XML{HTML}&quot;</code> and <code>&quot;XML{HTLM{RTF}}&quot;</code>, respectively. We could use these names in the earlier two <code>outputformat</code> calls, however, there's a shorthand where you inherit the part outside the <code>{...}</code> from the enclosing output format:</p>
<pre><code>&lt;#ftl outputFormat=&quot;XML&quot;&gt;
${&quot;&#39;{}&quot;}
&lt;#outputFormat &quot;{HTML}&quot;&gt;&lt;#-- Same as &quot;XML{HTML}&quot; --&gt;
  ${&quot;&#39;{}&quot;}
  &lt;#outputFormat &#39;{RTF}&#39;&gt;&lt;#-- Same as &quot;XML{HTML{RTF}}&quot; --&gt;
    ${&quot;&#39;{}&quot;}
  &lt;/#outputFormat&gt;
&lt;/#outputFormat&gt;</code></pre>
<pre><code>&amp;apos;{}
  &amp;amp;#39;{}
    &amp;amp;#39;\{\}</code></pre>
<h2 id="ref_directive_setting">setting</h2>
setting directive
<h3>Synopsis</h3>
<pre><code>&lt;#setting name=value&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>name</code>: name of the setting. It is not expression!</p></li>
<li><p><code>value</code>: New value of the setting. Expression</p></li>
</ul>
<h3>Description</h3>
<p>Sets a setting for the further part of processing. Settings are values that influence the behavior of FreeMarker. The new value will be present only in the template processing where it was set, and does not touch the template itself. The initial value of settings is set by the programmer (see: <a href="#pgui_config_settings">section_title</a>).</p>
<p>The supported settings are:</p>
<ul>
<li><p>locale<code>locale</code>: The locale (language) of the output. It can influence the presentation format of numbers, dates, etc. The value is a string which consist of a language code (lowercase two-letter ISO-639 code) plus optional county code (uppercase two-letter ISO-3166 code) separated from the language code with underscore, and if we have specified the country then an optional variant code (not standardized) separated from the country with underscore. Examples of valid values: <code>en</code>, <code>en_US</code>, <code>en_US_MAC</code>. FreeMarker will try to use the most specific available locale, so if you specify <code>en_US_MAC</code> but that is not known, then it will try <code>en_US</code>, and then <code>en</code>, and then the default locale of the computer (which is may set by the programmer).</p></li>
<li><p>number_formatformat number<code>number_format</code>: The number format that is used to convert numbers to strings when no explicit format is specified. Can be one of the following:</p>
<ul>
<li><p>Predefined values defined by the Java platform: <code>number</code> (the default), <code>currency</code>, or <code>percent</code></p></li>
<li><p><code>computer</code>, which formats like <a href="#ref_builtin_c">the <code>c</code> built-in</a></p></li>
<li><p>Format pattern written in <a href="http://java.sun.com/j2se/1.4/docs/api/java/text/DecimalFormat.html">Java decimal number format syntax</a>, for example <code>0.###</code>. FreeMarker <a href="#topic.extendedJavaDecimalFormat">extends this format</a> to allow specifying rounding mode, symbols used, etc.</p></li>
<li><p>Values starting with <code>@</code> that's also followed by a letter, refer to a <a href="#pgui_config_custom_formats">custom format</a>. For example, <code>&quot;@price&quot;</code> refers to the custom format registered with the <code>&quot;price&quot;</code> name. The custom format name is possibly followed by space or <code>_</code> and then format parameters, whose interpretation depends on the custom format. For backward compatibility, the initial <code>@</code> only has this new meaning if either <a href="#pgui_config_incompatible_improvements_how_to_set">the <code>incompatible_improvements</code> setting</a> is at least 2.3.24, or there's any custom formats defined. When the initial <code>@</code> isn't followed by a letter (any UNICODE letter), it's never treated as a reference to a custom format.</p></li>
</ul></li>
<li><p>boolean_formatformat boolean<code>boolean_format</code>: The comma-separated pair of strings for representing true and false values respectively that is used to convert booleans to strings when no explicit format is specified (like in <code>${booleanValue}</code>). Note that currently white space isn't removed from this string, so don't put space after the comma. Default value is <code>&quot;true,false&quot;</code>, but FreeMarker will deny using that particular value for <code>${booleanValue}</code>, and requires using <code>${booleanValue?c}</code> instead (this works since 2.3.21). For any other value, like <code>&quot;Y,N&quot;</code>, <code>${booleanValue}</code> will work. See also:<a href="#ref_builtin_string_for_boolean"><code>string</code> built-in</a>.</p></li>
<li><p>date_formattime_formatdatetime_formatformat dateXML Schema date renderingXML Schema time renderingXML Schema dateTime renderingISO 8601 <code>date_format</code>, <code>time_format</code>, <code>datetime_format</code>: The format used to convert date/time/date-time values (Java <code>java.util.Date</code>-s and its subclasses) to strings when no explicit format is specified via the <a href="#ref_builtin_string_for_date"><code>string</code> built-in</a> (or otherwise), as in the case of <code>${someDate}</code>. The <code>date_format</code> setting only effects the formatting of date values that store no time part, <code>time_format</code> only effects the formatting of times that store no date part, and <code>datetime_format</code> only effects formatting of date-time values. These settings also effects what format do <a href="#ref_builtin_string_date"><code>?time</code>, <code>?date</code>, and <code>?datetime</code></a> expect when it's applied on a string value.</p>
<p>The following part is copy-pasted from the JavaDoc of Configurable.setDateTimeFormat(String); keep them in sync.The possible setting values are (the quotation marks aren't part of the value itself):</p>
<ul>
<li><p>Patterns <a href="http://docs.oracle.com/javase/7/docs/api/java/text/SimpleDateFormat.html">accepted by Java's <code>SimpleDateFormat</code></a>, for example <code>&quot;dd.MM.yyyy HH:mm:ss&quot;</code> (where <code>&quot;HH&quot;</code> means 0-23 hours) or <code>&quot;MM/dd/yyyy hh:mm:ss a&quot;</code> (where <code>&quot;a&quot;</code> prints AM or PM, if the current language is English).</p></li>
<li><p><code>&quot;xs&quot;</code> for XML Schema format, or <code>&quot;iso&quot;</code> for ISO 8601:2004 format. These formats allow various additional options, separated with space, like in <code>&quot;iso m nz&quot;</code> (or with <code>_</code>, like in <code>&quot;iso_m_nz&quot;</code>; this is useful in a case like <code>lastModified?string.iso_m_nz</code>). The options and their meanings are:</p>
<ul>
<li><p>Accuracy options:</p>
<ul>
<li><p><code>ms</code>: Milliseconds, always shown with all 3 digits, even if it's all 0-s. Example: <code>13:45:05.800</code></p></li>
<li><p><code>s</code>: Seconds (fraction seconds are dropped even if non-0), like <code>13:45:05</code></p></li>
<li><p><code>m</code>: Minutes, like <code>13:45</code>. This isn't allowed for <code>&quot;xs&quot;</code>.</p></li>
<li><p><code>h</code>: Hours, like <code>13</code>. This isn't allowed for <code>&quot;xs&quot;</code>.</p></li>
<li><p>Neither: Up to millisecond accuracy, but trailing millisecond 0-s are removed, also the whole milliseconds part if it would be 0 otherwise. Example: <code>13:45:05.8</code></p></li>
</ul></li>
<li><p>Time zone offset visibility options:</p>
<ul>
<li><p><code>fz</code>: “Force Zone”, always show time zone offset (even for for <code>java.sql.Date</code> and <code>java.sql.Time</code> values). But, because ISO 8601 doesn't allow for dates (means date without time of the day) to show the zone offset, this option will have no effect in the case of <code>&quot;iso&quot;</code> with dates.</p></li>
<li><p><code>nz</code>: “No Zone”, never show time zone offset</p></li>
<li><p>Neither: Always show time zone offset, except for <code>java.sql.Date</code> and <code>java.sql.Time</code>, and for <code>&quot;iso&quot;</code> date values.</p></li>
</ul></li>
<li><p>Time zone options:</p>
<ul>
<li><p><code>u</code>: Use UTC instead of what the <code>time_zone</code> setting suggests. However, <code>java.sql.Date</code> and <code>java.sql.Time</code> aren't affected by this (see <code>sql_date_and_time_time_zone</code> to understand why)</p></li>
<li><p><code>fu</code>: “Force UTC”, that is, use UTC instead of what the <code>time_zone</code> or the <code>sql_date_and_time_time_zone</code> setting suggests. This also effects <code>java.sql.Date</code> and <code>java.sql.Time</code> values</p></li>
<li><p>Neither: Use the time zone suggested by the <code>time_zone</code> or the <code>sql_date_and_time_time_zone</code> configuration setting</p></li>
</ul></li>
</ul>
<p>Options from the same category are mutually exclusive, like using <code>m</code> and <code>s</code> together is an error.</p>
<p>The options can be specified in any order.</p>
<p>The accuracy and time zone offset visibility options don't influence parsing, only formatting. For example, even if you use <code>&quot;iso m nz&quot;</code>, <code>&quot;2012-01-01T15:30:05.125+01&quot;</code> will be parsed successfully and with milliseconds accuracy. The time zone options (like <code>&quot;u&quot;</code>) influence what time zone is chosen only when parsing a string that doesn't contain time zone offset.</p>
<p>Parsing with <code>&quot;iso&quot;</code> understands both “extend format” and “basic format”, like <code>20141225T235018</code>. It doesn't, however, support the parsing of all kind of ISO 8601 strings: if there's a date part, it must use year, month and day of the month values (not week of the year), and the day can't be omitted.</p>
<p>The output of <code>&quot;iso&quot;</code> is deliberately so that it's also a good representation of the value with XML Schema format, except for 0 and negative years, where it's impossible. Also note that the time zone offset is omitted for date values in the <code>&quot;iso&quot;</code> format, while it's preserved for the <code>&quot;xs&quot;</code> format.</p></li>
<li><p><code>&quot;short&quot;</code>, <code>&quot;medium&quot;</code>, <code>&quot;long&quot;</code>, or <code>&quot;full&quot;</code>, which has locale-dependent meaning defined by the Java platform (see in the <a href="http://docs.oracle.com/javase/7/docs/api/java/text/DateFormat.html">documentation of <code>java.text.DateFormat</code></a>). For date-time values, you can specify the length of the date and time part independently, be separating them with <code>_</code>, like <code>&quot;short_medium&quot;</code>. (<code>&quot;medium&quot;</code> means <code>&quot;medium_medium&quot;</code> for date-time values.)</p></li>
<li><p>Values starting with <code>@</code> that's also followed by a letter, refer to a <a href="#pgui_config_custom_formats">custom format</a>, like <code>&quot;@worklog&quot;</code> refers to the custom format registered with the <code>&quot;worklog&quot;</code> name. The format name is possibly followed by space or <code>_</code> and then format parameters, whose interpretation depends on the custom format. For backward compatibility, the initial <code>@</code> only has this new meaning if either <a href="#pgui_config_incompatible_improvements_how_to_set">the <code>incompatible_improvements</code> setting</a> is at least 2.3.24, or there's any custom formats defined. When the initial <code>@</code> isn't followed by a letter (any UNICODE letter), it's never treated as a reference to a custom format.</p></li>
</ul></li>
<li><p>time_zone<code>time_zone</code>: The name of the time zone used to format times for display. By default, the default time zone of the JVM is used. Can be any value that is accepted by <a href="http://docs.oracle.com/javase/7/docs/api/java/util/TimeZone.html">Java TimeZone API</a>, or <code>&quot;JVM default&quot;</code> (since FreeMarker 2.3.21) to use the JVM default time zone. Examples: <code>&quot;GMT&quot;</code>, <code>&quot;GMT+2&quot;</code>, <code>&quot;GMT-1:30&quot;</code>, <code>&quot;CET&quot;</code>, <code>&quot;PST&quot;</code>, <code>&quot;America/Los_Angeles&quot;</code>.</p>
<blockquote>
<p><strong>Warning</strong></p>
<p>If you change this setting from its default value, you should certainly also set <code>sql_date_and_time_time_zone</code> to &quot;JVM default&quot;. See more in the Java API documentation of <code>Configurable.setSQLDateAndTimeTimeZone(TimeZone)</code>.</p>
</blockquote></li>
<li><p>time_zoneJDBC time zone<code>sql_date_and_time_time_zone</code> (since FreeMarker 2.3.21): This handles a highly technical issue, so it should usually be set from the Java code by the programmers. For programmers: If this is set to non-<code>null</code>, for date-only and time-only values coming from SQL database (more precisely, for <code>java.sql.Date</code> and <code>java.sql.Time</code> objects) FreeMarker will use this time zone instead of the time zone specified by the <code>time_zone</code> FreeMarker setting. See more in the Java API documentation of <code>Configurable.setSQLDateAndTimeTimeZone(TimeZone)</code>.</p></li>
<li><p>url_escaping_charset<code>url_escaping_charset</code>: The charset used for URL escaping (e.g. for <code>${foo?url}</code>) to calculate the escaped (<code>%XX</code>) parts. Usually the framework that encloses FreeMarker should set it, so you hardly ever should set this setting in templates. (Programmers can read more about this <a href="#pgui_misc_charset">here...</a>)</p></li>
<li><p>output_encoding<code>output_encoding</code>: Tells FreeMarker what the charset of the output is. As FreeMarker outputs a stream of UNICODE characters (it writes into a <code>java.io.Writer</code>), it's not affected by the output encoding, but some macros/functions and built-ins may want to used this information.</p></li>
<li><p>classic_compatible<code>classic_compatible</code>: This is for experts. Its value should be a boolean. See the documentation of <code>freemarker.template.Configurable</code> for more information.</p></li>
</ul>
<p>Example: Assume that the initial locale of template is <code>de_DE</code> (German). Then this:</p>
<pre><code>${1.2}
&lt;#setting locale=&quot;en_US&quot;&gt;
${1.2}</code></pre>
<p>will output this:</p>
<pre><code>1,2
1.2</code></pre>
<p>because German people use the comma as their decimal separator, while US people use the dot.</p>
<h2 id="ref_directive_stop">stop</h2>
stop directive
<h3>Synopsis</h3>
<pre><code>&lt;#stop&gt;
or
&lt;#stop reason&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>reason</code>: Informative message that describes the reason of the terminating error. Expression, must evaluate to a string.</p></li>
</ul>
<h3>Description</h3>
<p>Aborts template processing with the given (optional) error message. <em>This must not be used for ending template processing in normal situations!</em> The caller of the FreeMarker template will see this as a failed template rendering, not as a normally finished one.</p>
<p>This directive throws a <code>StopException</code>, and the <code>StopException</code> will hold the value of the reason parameter.</p>
<h2 id="ref_directive_switch">switch, case, default, break</h2>
switch directive
case directive
default directive
break directive
<h3>Synopsis</h3>
<pre><code>&lt;#switch value&gt;
  &lt;#case refValue1&gt;
    ...
    &lt;#break&gt;
  &lt;#case refValue2&gt;
    ...
    &lt;#break&gt;
  ...
  &lt;#case refValueN&gt;
    ...
    &lt;#break&gt;
  &lt;#default&gt;
    ...
&lt;/#switch&gt;
</code></pre>
<p>Where:</p>
<ul>
<li><p><code>value</code>, <code>refValue1</code>, etc.: Expressions evaluates to scalars of the same type.</p></li>
</ul>
<p>The <code>break</code>-s and <code>default</code> are optional.</p>
<h3>Description</h3>
<p>The usage of this directive is not recommended, as it's error-prone because of the fall-through behavior. Use <a href="#ref.directive.elseif"><code>elseif</code></a>-s instead unless you want to exploit the fall-through behavior.</p>
<p>Switch is used to choose a fragment of template depending on the value of an expression:</p>
<pre><code>&lt;#switch animal.size&gt;
  &lt;#case &quot;small&quot;&gt;
     This will be processed if it is small
     &lt;#break&gt;
  &lt;#case &quot;medium&quot;&gt;
     This will be processed if it is medium
     &lt;#break&gt;
  &lt;#case &quot;large&quot;&gt;
     This will be processed if it is large
     &lt;#break&gt;
  &lt;#default&gt;
     This will be processed if it is neither
&lt;/#switch&gt;</code></pre>
<p>Inside the <code>switch</code> must be one or more <code>&lt;#case value&gt;</code>, and after all such <code>case</code> tags optionally one <code>&lt;#default&gt;</code>. When FM reaches the <code>switch</code> directive, it chooses a <code>case</code> directive where <code>refValue</code> equals with <code>value</code> and continues the processing of the template there. If there is no <code>case</code> directive with appropriate value then it continues processing at the <code>default</code> directive if that exists, otherwise it continues the processing after the end-tag of <code>switch</code>. And now comes the confusing thing: when it has chosen a <code>case</code> directive, it will continue the processing there, and will go ahead until it reaches a <code>break</code> directive. That is, it will not automatically leave the <code>switch</code> directive when it reaches another <code>case</code> directive or the <code>&lt;#default&gt;</code> tag. Example:</p>
<pre><code>&lt;#switch x&gt;
  &lt;#case 1&gt;
    1
  &lt;#case 2&gt;
    2
  &lt;#default&gt;
    d
&lt;/#switch&gt;</code></pre>
<p>If <code>x</code> is 1, then it will print 1 2 d; if <code>x</code> is 2 then it will print 2 d; if <code>x</code> is 3 then it will print d. This is the mentioned fall-through behavior. The <code>break</code> tag instructs FM to immediately skip past the <code>switch</code> end-tag.</p>
<h2 id="ref_directive_t">t, lt, rt</h2>
t directive
lt directive
rt directive
trimmer directives
white-space removal
trimming
<h3>Synopsis</h3>
<pre><code>&lt;#t&gt;

&lt;#lt&gt;

&lt;#rt&gt;</code></pre>
<h3>Description</h3>
<p>These directives, instruct FreeMarker to ignore certain white-space in the line of the tag:</p>
<ul>
<li><p><code>t</code> (for trim): Ignore all leading and trailing white-space in this line.</p></li>
<li><p><code>lt</code> (for left trim): Ignore all leading white-space in this line.</p></li>
<li><p><code>rt</code> (for right trim): Ignore all trailing white-space in this line.</p></li>
</ul>
<p>where:</p>
<ul>
<li><p>“leading white-space” means all space and tab (and other character that are white-space according to <a href="#gloss.unicode">UNICODE</a>, except <a href="#gloss.lineBreak">line breaks</a>) before the first non-white-space character of the line.</p></li>
<li><p>“trailing white-space” means all space and tab (and other character that are white-space according to <a href="#gloss.unicode">UNICODE</a>, except line breaks) after the last non-white-space character of the line, <em>and</em> the line break at the end of the line.</p></li>
</ul>
<p>It is important to understand that these directives examine the template itself, and <em>not</em> the output what the template generates when you merge it with the data-model. (That is, the white-space removal happens on parse time.)</p>
<p>For example this:</p>
<pre><code>--
  1 &lt;#t&gt;
  2&lt;#t&gt;
  3&lt;#lt&gt;
  4
  5&lt;#rt&gt;
  6
--</code></pre>
<p>will output this:</p>
<pre><code>--
1 23
  4
  5  6
--</code></pre>
<p>The placement of these directives inside the line has no importance. That is, the effect will be the same regardless if you put the directive at the beginning of the line, or at the end of the line, or in the middle of the line.</p>
<h2 id="ref_directive_userDefined">User-defined directive (&lt;@...&gt;)</h2>
user-defined directive
<h3>Synopsis</h3>
<pre><code>&lt;@user_def_dir_exp param1=val1 param2=val2 ... paramN=valN/&gt;
(Note the XML-style / before the &gt;)
or if you need loop variables (more details...)
&lt;@user_def_dir_exp param1=val1 param2=val2 ... paramN=valN ; lv1, lv2, ..., lvN/&gt;

Or the same as the above two but with end-tag (more details...):

&lt;@user_def_dir_exp ...&gt;
  ...
&lt;/@user_def_dir_exp&gt;
or
&lt;@user_def_dir_exp ...&gt;
  ...
&lt;/@&gt;

Or all above but with positional parameter passing (more details...):

&lt;@user val1, val2, ..., valN/&gt;
...etc.</code></pre>
<p>Where:</p>
<ul>
<li><p><code>user_def_dir_exp</code>: Expression evaluates to an user-defined directive (for example a macro), that will be called.</p></li>
<li><p><code>param1</code>, <code>param2</code>, ...etc.: The name of parameters. They are <em>not</em> expressions.</p></li>
<li><p><code>val1</code>, <code>val2</code>, ...etc.: The value of parameters. They <em>are</em> expressions.</p></li>
<li><p><code>lv1</code>, <code>lv2</code>, ...etc.: The name of <a href="#dgui_misc_var">loop variables</a>. They are <em>not</em> expressions.</p></li>
</ul>
<p>The number of parameters can be 0 (i.e. no parameters).</p>
<p>The order of parameters is not significant (unless you use positional parameter passing). The name of parameters must be unique. Lower- and uppercase letters are considered as different letters in parameter names (i.e. <code>Color</code> and <code>color</code> is not the same).</p>
<h3>Description</h3>
<p>This will call an user-defined directive, for example a macro. The meaning of parameters, and the set of supported and required parameters depend on the concrete user-defined directive.</p>
<p>You may read <a href="#dgui_misc_userdefdir">the tutorial about user-defined directives</a>.</p>
<p>Example 1: Calls the directive that is stored in the variable <code>html_escape</code>:</p>
<pre><code>&lt;@html_escape&gt;
  a &lt; b
  Romeo &amp; Juliet
&lt;/@html_escape&gt;</code></pre>
<p>Output:</p>
<pre><code>  a &amp;lt; b
  Romeo &amp;amp; Juliet</code></pre>
<p>Example 2: Calls a macro with parameters:</p>
<pre><code>&lt;@list items=[&quot;mouse&quot;, &quot;elephant&quot;, &quot;python&quot;] title=&quot;Animals&quot;/&gt;
...
&lt;#macro list title items&gt;
  &lt;p&gt;${title?cap_first}:
  &lt;ul&gt;
    &lt;#list items as x&gt;
      &lt;li&gt;${x?cap_first}
    &lt;/#list&gt;
  &lt;/ul&gt;
&lt;/#macro&gt;</code></pre>
<p>Output:</p>
<pre><code>  &lt;p&gt;Animals:
  &lt;ul&gt;
      &lt;li&gt;Mouse
      &lt;li&gt;Elephant
      &lt;li&gt;Python
  &lt;/ul&gt;

...</code></pre>
<h4 id="ref_directive_userDefined_entTag">End-tag</h4>
<p>You can omit the <code>user_def_dir_exp</code> in the <a href="#gloss.endTag">end-tag</a>. That is, you can always write <code>&lt;/@&gt;</code> instead of <code>&lt;/@anything&gt;</code>. This rule is mostly useful when the <code>user_def_dir_exp</code> expression is too complex, because you don't have to repeat the expression in the end-tag. Furthermore, if the expression contains other than simple variable names and dots, you are not allowed to repeat the expression. For example, <code>&lt;@a_hash[a_method()]&gt;...&lt;/@a_hash[a_method()]&gt;</code> is an error; you must write <code>&lt;@a_hash[a_method()]&gt;...&lt;/@&gt;</code>. But <code>&lt;@a_hash.foo&gt;...&lt;/@a_hash.foo&gt;</code> is OK.</p>
<h4 id="ref_directive_userDefined_loopVar">Loop variables</h4>
<p>Some user-defined directives create loop variables (similarly to <code>list</code> directive). As with the predefined directives (as <code>list</code>) the <em>name</em> of loop variables is given when you call the directive (as <code>foo</code> in <code>&lt;#list
            foos as
            foo&gt;...&lt;/#list&gt;</code>), while the <em>value</em> of the variable is set by the directive itself. In the case of user-defined directives the syntax is that the name of loop variables is given after a semicolon. For example:</p>
<pre><code>&lt;@myRepeatMacro count=4 ; x, last&gt;
  ${x}. Something... &lt;#if last&gt; This was the last!&lt;/#if&gt;
&lt;/@myRepeatMacro&gt;</code></pre>
<p>Note that the number of loop variable created by the user-defined directive and the number of loop variables specified after the semicolon need not match. Say, if you are not interested if the repetition is the last, you can simply write:</p>
<pre><code>&lt;@myRepeatMacro count=4 ; x&gt;
  ${x}. Something...
&lt;/@myRepeatMacro&gt;</code></pre>
<p>or you can even:</p>
<pre><code>&lt;@myRepeatMacro count=4&gt;
  Something...
&lt;/@myRepeatMacro&gt;</code></pre>
<p>Furthermore, it does not cause error if you specify more loop variables after the semicolon than the user-defined directive creates, just the last few loop variables will not be created (i.e. those will be undefined in the nested content). Trying to use the undefined loop variables, however, will cause error (unless you use built-ins like <code>?default</code>), since you try to access a non-existing variable.</p>
<p>See the <a href="#dgui_misc_userdefdir">the tutorial about user-defined directives</a> for more explanation.</p>
<h4 id="ref_directive_userDefined_positionalParam">Positional parameter passing</h4>
positional parameter passing
<p>Positional parameter passing (as <code>&lt;@heading
            &quot;Preface&quot;, 1/&gt;</code>) is a shorthand form of normal named parameter passing (as <code>&lt;@heading title=&quot;Preface&quot;
            level=1/&gt;</code>), where you omit the parameter name. This shorthand form should be used if a user-defined directive has only one parameter, or if it is easy to remember the order of parameters for a frequently used user-defined directive. To use this form, you have to know the order in which the named parameters are declared (trivial if the directive has only one parameter). Say, if <code>heading</code> was created as <code>&lt;#macro heading title
            level&gt;...</code>, then <code>&lt;@heading &quot;Preface&quot;, 1/&gt;</code> is equivalent with <code>&lt;@heading title=&quot;Preface&quot; level=1/&gt;</code> (or <code>&lt;@heading level=1 title=&quot;Preface&quot;/&gt;</code>; if you use parameter names, the order is not important). Note that positional parameter passing is currently only supported for macros.</p>
<h2 id="ref_directive_visit">visit, recurse, fallback</h2>
visit directive
recurse directive
fallback directive
recursion
iterate
<h3>Synopsis</h3>
<pre><code>&lt;#visit node using namespace&gt;
or
&lt;#visit node&gt;</code></pre>
<pre><code>&lt;#recurse node using namespace&gt;
or
&lt;#recurse node&gt;
or
&lt;#recurse using namespace&gt;
or
&lt;#recurse&gt;</code></pre>
<pre><code>&lt;#fallback&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>node</code>: Expression evaluates to a <a href="#xgui_expose_dom">node variable</a>.</p></li>
<li><p><code>namespace</code>: A <a href="#dgui_misc_namespace">namespace</a>, or a sequence of namespaces. A namespace can be given with the namespace hash (a.k.a. gate hash), or with a string literal that store the path of template that could be imported. Instead of namespace hashes, you can use plain hashes as well.</p></li>
</ul>
<h3>Description</h3>
<p>The <code>visit</code> and <code>recurse</code> directives are used for the recursive processing of trees. In practice, this will mostly be used for <a href="#xgui">processing XML.</a></p>
<h4>Visit</h4>
<p>When you call <code>&lt;#visit
            node&gt;</code>, it looks for a user-defined directive (like a macro) to invoke that has the name deducted from the node's name (<code>node?node_name</code>) and namespace (<code>node?node_namesoace</code>). The rules of name deduction:</p>
<ul>
<li><p>If the node doesn't support node namespaces (as text nodes in XML), then the directive name is simply the name of the node (<code>node?node_name</code>). A node does not support node namespaces if the <code>getNodeNamespace</code> method returns <code>null</code>.</p></li>
<li><p>If the node does support node namespaces (as element nodes in XML), then a prefix deduced from the node namespace maybe appended before the node name with a colon used as separator (e.g. <code>e:book</code>). The prefix, and if there is a prefix used at all, depends on what prefixes has been registered with the <code>ns_prefixes</code> parameter of the <code>ftl</code> directive in the <a href="#dgui_misc_namespace">FTL namespace</a> where <code>visit</code> looks for the handler directive (which is not necessary the same as the FTL namespace where <code>visit</code> was called from, as you will see later). Concretely, if there was no default namespace registered with <code>ns_prefixes</code> then for nodes that does not belong to any namespace (when <code>getNodeNamespace</code> returns <code>&quot;&quot;</code>) no prefix is used. If there was a default namespace registered with <code>ns_prefixes</code> then for nodes that does not belong to any namespace prefix <code>N</code> is used, and for nodes that belong to the default node namespace no prefix is used. Otherwise, in both case, the prefix associated to the node namespace with the <code>ns_prefixes</code> is used. If there is not prefix associated to the node namespace of the node, then <code>visit</code> simply behave as if there was no directive found with the proper name.</p></li>
</ul>
<p>The node for which the user-defined directive was invoked is available for it as special variable <code>.node</code>. Example:</p>
<pre><code>&lt;#-- Assume that nodeWithNameX?node_name is &quot;x&quot; --&gt;
&lt;#visit nodeWithNameX&gt;
Done.
&lt;#macro x&gt;
   Now I&#39;m handling a node that has the name &quot;x&quot;.
   Just to show how to access this node: this node has ${.node?children?size} children.
&lt;/#macro&gt;</code></pre>
<p>The output will be something like:</p>
<pre><code>   Now I&#39;m handling a node that has the name &quot;x&quot;.
   Just to show how to access this node: this node has 3 children.
Done.</code></pre>
<p>If one or more namespaces is specified using the optional <code>using</code> clause, then <code>visit</code> will look for the directives in those namespaces only, with the earlier specified namespaces in the list getting priority. If no <code>using</code> clause is specified, the namespace or sequence of namespaces specified with the <code>using</code> clause of the last uncompleted <code>visit</code> call is reused. If there is no such pending <code>visit</code> call, then the current namespace is used. For example, if you execute this template:</p>
<pre><code>&lt;#import &quot;n1.ftl&quot; as n1&gt;
&lt;#import &quot;n2.ftl&quot; as n2&gt;

&lt;#-- This will call n2.x (because there is no n1.x): --&gt;
&lt;#visit nodeWithNameX using [n1, n2]&gt;

&lt;#-- This will call the x of the current namespace: --&gt;
&lt;#visit nodeWithNameX&gt;

&lt;#macro x&gt;
  Simply x
&lt;/#macro&gt;</code></pre>
<p>and this is <code>n1.ftl</code>:</p>
<pre><code>&lt;#macro y&gt;
  n1.y
&lt;/#macro&gt;</code></pre>
<p>and this is <code>n2.ftl</code>:</p>
<pre><code>&lt;#macro x&gt;
  n2.x
  &lt;#-- This callc n1.y as it inherits the &quot;using [n1, n2]&quot; from the pending visit call: --&gt;
  &lt;#visit nodeWithNameY&gt;
  &lt;#-- This will call n2.y: --&gt;
  &lt;#visit nodeWithNameY using .namespace&gt;
&lt;/#macro&gt;

&lt;#macro y&gt;
  n2.y
&lt;/#macro&gt;</code></pre>
<p>then this will print:</p>
<pre><code>  n2.x
  n1.y
  n2.y

  Simply x
 </code></pre>
<p>If <code>visit</code> doesn't find a user-defined directive in either FTL namespaces with the name identical to the name deduced with the rules described earlier, then it tries to find an user-defined directive with name <code>@node_type</code>, or if the node does not support node type property (i.e. <code>node?node_type</code> returns undefined variable), then with name <code>@default</code>. For the lookup, it uses the same mechanism as was explained earlier. If it still doesn't find an user-defined directive to handle the node, then <code>visit</code> stops template processing with error. Some XML specific node types have special handling in this regard; see: <a href="#xgui_declarative_details">section_title</a>. Example:</p>
<pre><code>&lt;#-- Assume that nodeWithNameX?node_name is &quot;x&quot; --&gt;
&lt;#visit nodeWithNameX&gt;

&lt;#-- Assume that nodeWithNameY?node_type is &quot;foo&quot; --&gt;
&lt;#visit nodeWithNameY&gt;

&lt;#macro x&gt;
Handling node x
&lt;/#macro&gt;

&lt;#macro @foo&gt;
There was no specific handler for node ${node?node_name}
&lt;/#macro&gt;</code></pre>
<p>This would print:</p>
<pre><code>Handling node x

There was no specific handler for node y

 </code></pre>
<h4>Recurse</h4>
<p>The <code>&lt;#recurse&gt;</code> directive is really syntactic sugar. It visits all children nodes of the node (and not the node itself). So, to write:</p>
<pre><code>&lt;#recurse someNode using someLib&gt;</code></pre>
<p>is equivalent to writing:</p>
<pre><code>&lt;#list someNode?children as child&gt;&lt;#visit child using someLib&gt;&lt;/#list&gt;</code></pre>
<p>However, target node is optional in the <code>recurse</code> directive. If the target node is unspecified, it simply uses the <code>.node</code>. Thus, the terse instruction <code>&lt;#recurse&gt;</code> is equivalent to:</p>
<pre><code>&lt;#list .node?children as child&gt;&lt;#visit child&gt;&lt;/#list&gt;</code></pre>
<p>As a side comment for those who are familiar with XSLT, <code>&lt;#recurse&gt;</code> is pretty much exactly analogous to the <code>&lt;xsl:apply-templates/&gt;</code> instruction in XSLT.</p>
<h4>Fallback</h4>
<p>As you could learn earlier, in the documentation of the <code>visit</code> directive, the user-defined directive that handles the node is maybe searched in multiple FTL name-spaces. The <code>fallback</code> directive can be used in a user-defined directive that was invoked to handle a node. It directs FreeMarker to continue the searching for the user-defined directive in the further name-spaces (that is, in the name-spaces that are after the name-space of the currently invoked user-defined directive in the list of name-spaces). If a handler for the node is found then it is invoked, otherwise <code>fallback</code> does nothing.</p>
<p>A typical usage of this to write customization layer over a handler library, that sometimes passes the handling to the customized library:</p>
<pre><code>&lt;#import &quot;/lib/docbook.ftl&quot; as docbook&gt;

&lt;#--
  We use the docbook library, but we override some handlers
  in this namespace.
--&gt;
&lt;#visit document using [.namespace, docbook]&gt;

&lt;#--
  Override the &quot;programlisting&quot; handler, but only in the case if
  its &quot;role&quot; attribute is &quot;java&quot;
--&gt;
&lt;#macro programlisting&gt;
  &lt;#if .node.@role[0]!&quot;&quot; == &quot;java&quot;&gt;
    &lt;#-- Do something special here... --&gt;
    ...
  &lt;#else&gt;
    &lt;#-- Just use the original (overidden) handler --&gt;
    &lt;#fallback&gt;
  &lt;/#if&gt;
&lt;/#macro&gt;</code></pre>
<h1 id="ref_specvar">Special Variable Reference</h1>
special variable
<p>Special variables are variables defined by the FreeMarker engine itself. To access them, you use the <code>.variable_name</code> syntax. For example, you can't write simply <code>version</code>; you have to write <code>.version</code>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>As of FreeMarker 2.3.23, you can use camel case instead of snake case for special variable names, like <code>dataModel</code> instead of <code>data_model</code>. But know that then within the same template, FreeMarker will enforce the usage of camel case for all identifiers that are part of the template language (user defined names are not affected).</p>
</blockquote>
<p>The supported special variables are:</p>
<ul>
<li><p>auto_esc<code>auto_esc</code> (since 2.3.24): Boolean value that tells if auto-escaping (based on output format) is on or off at the place where this variable is referred (resolved statically). This is <em>not</em> affected by the deprecated <code>escape</code> directive. This only deals with automatic escaping based on the output format mechanism.</p></li>
<li><p>current_template_name<code>current_template_name</code>: The name of the template where we are now (available since FreeMarker 2.3.23). This can be missing (<code>null</code>) if the template was created on-the-fly in Java (via <code>new Template(null,
          ...)</code>), rather than loaded from a backing store by name (via <code>cfg.getTemplate(name,
          ...)</code>). Migration notice: If you replace the deprecated <code>template_name</code> with this, note that the later is a 0-length string instead of missing (<code>null</code>) if the template has no name, so you might want to write <code>current_template_name!''</code> in legacy templates.</p></li>
<li><p><code>data_model</code>: A hash that you can use to access the data-model directly. That is, variables you did with <code>global</code> directive are not visible here.</p></li>
<li><p>error<code>error</code> (available since FreeMarker 2.3.1): This variable accessible in the body of the <a href="#ref.directive.attempt"><code>recover</code> directive</a>, where it stores the error message of the error we recover from.</p></li>
<li><p><code>globals</code>: A hash that you can use to access the globally accessible variables: the data-model and the variables created with <code>global</code> directive. Note that variables created with <code>assign</code> or <code>macro</code> are not globals, thus they never hide the variables when you use <code>globals</code>.</p></li>
<li><p>incomplatible_improvements<code>incompatible_improvements</code> (since FreeMarker 2.3.24): The <a href="#pgui_config_incompatible_improvements"><code>incompatible_improvements</code> setting</a> of the current FreeMarker configuration, as a string.</p></li>
<li><p>languagelang<code>lang</code>: Returns the language part of the current value of the locale setting. For example if <code>.locale</code> is <code>en_US</code>, then <code>.lang</code> is <code>en</code>.</p></li>
<li><p>locale<code>locale</code>: Returns the current value of the locale setting. This is a string, for example <code>en_US</code>. For more information about locale strings <a href="#ref.directive.setting">see the <code>setting</code> directive</a>.</p></li>
<li><p>locale_object<code>locale_object</code> (available since FreeMarker 2.3.21): Returns the current value of the locale setting as a <code>java.util.Locale</code> object, rather than as a string. This meant to be used instead of <code>.locale</code> when you want to pass it as a <code>java.util.Locale</code> object to a Java method. (The <code>Locale</code> object will be wrapped according the <code>object_wrapper</code> setting value. Whether you can actually pass this value to a Java method as a <code>Locale</code> object depends on the object wrapper, but an object wrapper that let you call Java methods directly is very unlikely to not support that.)</p></li>
<li><p><code>locals</code>: A hash that you can use to access the local variables (the variables created with the <code>local</code> directive, and the parameters of macro).</p></li>
<li><p><code>main</code>: A hash that you can use to access the main <a href="#dgui_misc_namespace">namespace</a>. Note that global variables like the variables of data-model are <em>not</em> visible through this hash.</p></li>
<li><p>main_template_name<code>main_template_name</code>: The name of the top level template (available since FreeMarker 2.3.23). (In Java, this is the template for which <code>Template.process</code> was called.)This can be missing (<code>null</code>) if the template was created on-the-fly in Java (via <code>new
          Template(null, ...)</code>), rather than loaded from a backing store by name (via <code>cfg.getTemplate(name,
          ...)</code>). Migration notice: If you replace the deprecated <code>template_name</code> with this, note that the later is a 0-length string instead of missing (<code>null</code>) if the template has no name, so you might want to write <code>main_template_name!''</code> in legacy templates.</p></li>
<li><p><code>namespace</code>: A hash that you can use to access the current <a href="#dgui_misc_namespace">namespace</a>. Note that global variables like the variables of data-model are <em>not</em> visible through this hash.</p></li>
<li><p><code>node</code> (alias <code>current_node</code> for historical reasons): The node you are currently processing with the visitor pattern (i.e. with the <a href="#ref_directive_visit"><code>visit</code>, <code>recurse</code>, ...etc. directives</a>). Also, it initially stores the root node when you use the <a href="#pgui_misc_ant">FreeMarker XML Ant task</a>.</p></li>
<li><p>nowcurrent date-time<code>now</code>: Returns the current date-time. Usage examples: &quot;<code>Page generated: ${.now}</code>&quot;, &quot;<code>Today is ${.now?date}</code>&quot;, &quot;<code>The current
          time is ${.now?time}</code>&quot;.</p></li>
<li><p>output format Returns the name of the current <a href="#dgui_misc_autoescaping_outputformat">output format</a>. This value is never missing/null. It's maybe the string <code>&quot;undefined&quot;</code>, which is just the name of the default output format.</p></li>
<li><p>output encodingoutput charset<code>output_encoding</code> (available since FreeMarker 2.3.1): Returns the name of the current output charset. This special variable is not existent if the framework that encapsulates FreeMarker doesn't specify the output charset for FreeMarker. (Programmers can read more about charset issues <a href="#pgui_misc_charset">here...</a>)</p></li>
<li><p><code>pass</code>: This is a macro that does nothing. It has no parameters. Mostly used as no-op node handler in XML processing.</p></li>
<li><p>template_name<code>template_name</code>: <em>Don't use it, because its behavior is strange when macros are used; use <code>current_template_name</code> or <code>main_template_name</code> instead (see migration notices there).</em> Gives the name of the main template, or if we are running an included or imported template, the name of that template. When calling macros, it becomes rather confusing: the macro call won't change the value of this special variable, but when <code>nested</code> is called, it changes it to the name of the template that belongs to the current namespace. (Available since FreeMarker 2.3.14.)</p></li>
<li><p>URL escaping charsetURL escaping charset<code>url_escaping_charset</code> (available since FreeMarker 2.3.1): If exists, it stores the name of the charset that should be used for URL escaping. If this variable doesn't exist that means that nobody has specified what charset should be used for URL encoding yet. In this case the <a href="#ref_builtin_url"><code>url</code> built-in</a> uses the charset specified by the <code>output_encoding</code> special variable for URL encoding; custom mechanism may follow the same logic. (Programmers can read more about charset issues <a href="#pgui_misc_charset">here...</a>)</p></li>
<li><p>output_format<code>output_format</code> (since 2.3.24): The name of output format at the place where this variable is referred (resolved statically), such as <code>&quot;HTML&quot;</code>, <code>&quot;XML&quot;</code>, <code>&quot;RTF&quot;</code>, <code>&quot;plainText&quot;</code>, <code>&quot;undefined&quot;</code>, etc. (The available names can be extended by the programmers, by the <code>registered_custom_output_formats</code> setting.)</p></li>
<li><p><code>vars</code>: Expression <code>.vars.foo</code> returns the same variable as expression <code>foo</code>. It's useful if for some reasons you have to use square bracket syntax, since that works only for hash sub variables, so you need an artificial parent hash. For example, to read a top-level variable that has a strange name that would confuse FreeMarker, you can write <code>.vars[&quot;A strange name!&quot;]</code>. Or, to access a top-level variable with dynamic name given with variable <code>varName</code> you can write <code>.vars[varName]</code>. Note that the hash returned by <code>.vars</code> does not support <code>?keys</code> and <code>?values</code>.</p></li>
<li><p>version<code>version</code>: Returns the FreeMarker version number as string, for example <code>2.2.8</code>. This can be used to check which FreeMarker version does your application use, but note that this special variable does not exist prior to the 2.3.0 or 2.2.8 versions. The version number of non-final releases contains dash and further info after the numbers, like in 2.3.21-nightly_20140726T151800Z.</p></li>
</ul>
<h1 id="ref_reservednames">Reserved names in FTL</h1>
reserved name
<p>The following names cannot be used for top-level variables without square-bracket syntax (as <code>.vars[&quot;in&quot;]</code>), since they are keywords in FTL:</p>
<ul>
<li><p><code>true</code>: boolean value “true”</p></li>
<li><p><code>false</code>: boolean value “false”</p></li>
<li><p><code>gt</code>: comparison operator “greater than”</p></li>
<li><p><code>gte</code>: comparison operator “greater than or equivalent”</p></li>
<li><p><code>lt</code>: comparison operator “less than”</p></li>
<li><p><code>lte</code>: comparison operator “less than or equivalent”</p></li>
<li><p><code>as</code>: used by a few directives</p></li>
<li><p><code>in</code>: used by a few directives</p></li>
<li><p><code>using</code>: used by a few directives</p></li>
</ul>
<h1 id="ref_deprecated">Deprecated FTL constructs</h1>
deprecated
<h2 id="ref_depr_directive">List of deprecated directives</h2>
<p>The following directives are deprecated, but still working:</p>
<ul>
<li><p><a href="#ref.directive.call"><code>call</code></a>: use <a href="#ref.directive.userDefined">user-defined directive call</a> instead</p></li>
<li><p><code>comment</code>: This is the old format of <code>&lt;#--...--&gt;</code>. Anything between the <code>&lt;#comment&gt;</code> and <code>&lt;/#comment&gt;</code> will be ignored.</p></li>
<li><p><code>foreach</code>: it is a synonym of the <code>list</code> directive with slightly different parameter syntax. The syntax is <code>&lt;#foreach
            item in
            sequence&gt;</code> that is equivalent with <code>&lt;#list
            sequence as
            item&gt;</code>.</p></li>
<li><p><a href="#ref.directive.transform"><code>transform</code></a>: use <a href="#ref.directive.userDefined">user-defined directive call</a> instead</p></li>
</ul>
<p>The following directives are not working anymore:</p>
<ul>
<li><p>Legacy <code>function</code>: Originally <code>function</code> was used to define macros, and was deprecated in favor of the <code>macro</code> directive. As of FreeMarker 2.3, this directive is reintroduced with different meaning: it is used to define methods.</p></li>
</ul>
<h2 id="ref_depr_builtin">List of deprecated built-ins</h2>
<p>The following built-ins are deprecated, but still working:</p>
<ul>
<li><p>default built-in <code>default</code>: This was deprecated with the introduction of the <a href="#dgui_template_exp_missing_default">default value operator</a>. <code>exp1?default(exp2)</code> is near equivalent with <code>exp1!exp2</code>, and <code>(exp1)?default(exp2)</code> is near equivalent with with <code>(exp1)!exp2</code>. The only difference is that prior to FreeMarker 2.4, the <code>default</code> built-in has always evaluated <code>exp2</code>, while the default value operator only evaluates it when the default value is really needed. Starting from FreeMarker 2.4, however, the <code>default</code> built-in was improved, and behaves exactly like the default value operator.</p></li>
<li><p>exists built-in<code>exists</code>: This was deprecated with the introduction of the <a href="#dgui_template_exp_missing_test">missing value test operator</a>. <code>exp1?exists</code> is equivalent with <code>exp1??</code>, also <code>(exp1)?exists</code> is equivalent with with <code>(exp1)??</code>.</p></li>
<li><p>if_exists built-in<code>if_exists</code>: This was deprecated with the introduction of the <a href="#dgui_template_exp_missing_default">default value operator</a>. <code>exp1?if_exists</code> is similar to <code>exp1!</code>, and <code>(exp1)?if_exists</code> is similar to <code>(exp1)!</code>. The difference is that the default value with <code>if_exists</code> is not only empty string, empty sequence and empty hashs at the same time, but also boolean <code>false</code> and a transform that does nothing and ignores all parameters.</p></li>
<li><p>web_safe built-in<code>web_safe</code>: the same as <a href="#ref_builtin_html"><code>html</code></a></p></li>
</ul>
<h2 id="ref_depr_oldmacro">Old-style macro and call directives</h2>
<h3>Synopsis</h3>
<pre><code>&lt;#macro name(argName1, argName2, ... argNameN)&gt;
  ...
&lt;/#macro&gt;

&lt;#call name(argValue1, argValue2, ... argValueN)&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>name</code>: name of the macro (not expression)</p></li>
<li><p><code>argName1</code>, <code>argName2</code>, ...etc.: the name of the <a href="#dgui_misc_var">local variables</a> store the parameter values (not expression)</p></li>
<li><p><code>argValue1</code>, <code>argValue2</code>, ...etc.: expressions, the value of the parameters</p></li>
</ul>
<h3>Description</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>This is the documentation of FreeMarker 2.1 macro and macro related directives. These are still working, but deprecated. You may want to read the FreeMarker 2.2+ references: <a href="#ref.directive.macro">macro, return</a>, <a href="#ref.directive.userDefined">user-defined directive call</a></p>
</blockquote>
<p>A macro is a template fragment with an associated name. You can use that named fragment on multiple places in your template, so it helps in repetitive tasks. A macro can have parameters that influence the output generated when you use the macro.</p>
<p>You define a macro with the <code>macro</code> directive, and then you can use the defined macro in the whole template. The <code>macro</code> directive itself does not write anything to the output, it just defines the macro. For example this will define a macro called <code>warning</code>:</p>
<pre><code>&lt;#macro warning(message)&gt;
  &lt;div align=center&gt;
  &lt;table border=1 bgcolor=yellow width=&quot;80%&quot;&gt;&lt;tr&gt;&lt;td align=center&gt;
    &lt;b&gt;Warning!&lt;/b&gt;
    &lt;p&gt;${message}
  &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
  &lt;/div&gt;
&lt;/#macro&gt;</code></pre>
<p>The macro definition body (the section between the macro start-tag and end-tag) will be processed whenever you use the <code>call</code> directive with the name of the macro. For example this calls the macro called <code>warning</code>:</p>
<pre><code>&lt;#call warning(&quot;Unplug the machine before opening the cover!&quot;)&gt;</code></pre>
<p>and will write this to the output:</p>
<pre><code>  &lt;div align=center&gt;
  &lt;table border=1 bgcolor=yellow width=&quot;80%&quot;&gt;&lt;tr&gt;&lt;td align=center&gt;
    &lt;b&gt;Warning!&lt;/b&gt;
    &lt;p&gt;Unplug the machine before opening the cover!
  &lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
  &lt;/div&gt;
  </code></pre>
<p>The parameters passed in as parameters to the <code>call</code> directive will be accessible in the macro definition body as <a href="#dgui_misc_var">local variables</a>.</p>
<p>When you call a macro, you must specify the same number of parameters as were specified in the macro definition. For example if this is the macro definition:</p>
<pre><code>&lt;#macro test(a, b, c)&gt;Nothing...&lt;/#macro&gt;</code></pre>
<p>then these are valid macro calls:</p>
<pre><code>&lt;#call test(1, 2, 3)&gt;
&lt;#call test(&quot;one&quot;, 2 + x, [1234, 2341, 3412, 4123])&gt;</code></pre>
<p>If a macro has no parameters, then you can omit the parentheses:</p>
<pre><code>&lt;#macro test&gt;mooo&lt;/#macro&gt;
&lt;#call test&gt;</code></pre>
<p>When you define a macro it will be available in the template, where you have defined it only. But probably you want to use the same macros in more templates. In this case you can store your macro definitions in a common file, and then include that file in all templates where you need those macros.</p>
<p>It's fine to call a macro that's defined further down in the template (since macros are defined at parse time, not in process time). However, if the macro definitions are inserted with <code>include</code> directive, they will not be available until FreeMarker has executed the <code>include</code> directive.</p>
<p>You can leave a macro definition body before the <code>&lt;/#macro&gt;</code> tag with the <code>return</code> directive.</p>
<h2 id="ref_depr_transform">Transform directive</h2>
transform directive
<h3>Synopsis</h3>
<pre><code>&lt;transform transVar&gt;
  ...
&lt;/transform&gt;
or
&lt;transform transVar name1=value1 name2=value2 ... nameN=valueN&gt;
  ...
&lt;/transform&gt;</code></pre>
<p>Where:</p>
<ul>
<li><p><code>transVar</code>: Expression evaluates to a transform</p></li>
<li><p><code>name1</code>, <code>name2</code>, ... <code>nameN</code>: Name of parameters. Literal value, not expression.</p></li>
<li><p><code>value1</code>, <code>value2</code>, ... <code>valueN</code>: Expressions evaluate to the values of parameters</p></li>
</ul>
<h3>Description</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>This directive is still working, but deprecated. You may want to read about <a href="#ref.directive.userDefined">user-defined directive calls</a> to see the replacement.</p>
</blockquote>
<p>Captures the output generated inside its body (i.e. between its start-tag and end-tag), and let the given transform modify it before it is written to the final output.</p>
<p>Example:</p>
<pre><code>&lt;p&gt;A very simple HTML file:
&lt;pre&gt;
&lt;transform html_escape&gt;
&lt;html&gt;
  &lt;body&gt;
    &lt;p&gt;Hello word!
  &lt;/body&gt;
&lt;/html&gt;
&lt;/transform&gt;
&lt;/pre&gt;</code></pre>
<p>the output will be:</p>
<pre><code>&lt;p&gt;A very simple HTML file:
&lt;pre&gt;
&amp;lt;html&amp;gt;
  &amp;lt;body&amp;gt;
    &amp;lt;p&amp;gt;Hello word!
  &amp;lt;/body&amp;gt;
&amp;lt;/html&amp;gt;
&lt;/pre&gt;</code></pre>
<p>Some transforms may take parameters. The name and meaning of parameters depends on the transform in question. For example here we give a parameter called “var”:</p>
<pre><code>&lt;#-- This transform stores the output in the variable x,
     rather than sending it to the output --&gt;
&lt;transform capture_output var=&quot;x&quot;&gt;
some test
&lt;/transform&gt;</code></pre>
<p>It is the task of the programmers to put the necessary transforms into the data-model. For the name and usage of accessible transforms ask the programmers. Initially there is a <a href="#pgui_config_sharedvariables">shared variable</a> for most transforms in the <code>freemarker.template.utility</code> package. For more information see: <a href="#pgui_config_sharedvariables">section_title</a></p>
<h2 id="ref_depr_oldsyntax">Old FTL syntax</h2>
strict syntax
old FTL syntax
new FTL syntax
<p>With the old FTL syntax the <code>#</code> was not required (prior 2.1 not even allowed) in the FTL tags. For example, you could write this:</p>
<pre><code>&lt;html&gt;
&lt;head&gt;
  &lt;title&gt;Welcome!&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;Welcome ${user}!&lt;/h1&gt;
  &lt;p&gt;We have there animals:
  &lt;ul&gt;
  &lt;list animals as animal&gt;
    &lt;li&gt;${animal.name} for ${animal.price} Euros
  &lt;/list&gt;
  &lt;/ul&gt;
  &lt;include &quot;common_footer.html&quot;&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
<p>While the <code>#</code>-less syntax was more natural for HTML authors, it had too many drawbacks, so finally we have decided to deprecate it. With the newer syntax (a.k.a “strict syntax”), the <code>#</code> is strictly required. That is, things like <code>&lt;include
        &quot;common_footer.html&quot;&gt;</code> will go to the output as is, since they are not considered as FTL tags. Note that user-defined directives use <code>@</code> <em>instead of</em> <code>#</code>.</p>
<p>However, to give users time to prepare for this change, in FreeMarker 2.1 and 2.2 the usage of <code>#</code> is optional, unless the programmer enables strict syntax mode in the FreeMarker configuration by calling <code>setStrictSyntaxMode(true)</code> on <code>Configuration</code>. In fact, we strongly recommend this to programmers. Starting from some later release this setting will be initially set to <code>true</code>. Also, you can specify if you want to use strict syntax or old syntax in the template files with the <a href="#ref.directive.ftl"><code>ftl</code> directive</a>.</p>
<p>The advantages of “strict syntax” over the legacy FTL syntax are:</p>
<ul>
<li><p>Since all <code>&lt;#...&gt;</code> and <code>&lt;/#...&gt;</code> are reserved for FTL:</p>
<ul>
<li><p>We can introduce new directives without breaking backward compatibility.</p></li>
<li><p>We can detect if you made a typo, i.e. <code>&lt;#inculde
                ...&gt;</code> is treated as parse-time error, rather than silently treated as simple text.</p></li>
<li><p>It is easier for third-party tools to handle templates (e.g. do syntax highlighting), especially since they don't have to know about the new directives introduced with new releases.</p></li>
<li><p>Templates are more readable, since it is easier to spot <code>&lt;#...&gt;</code> tags embedded into HTML or other markup.</p></li>
</ul></li>
<li><p><code>&lt;#</code> and <code>&lt;/#</code> is illegal XML (except in CDATA sections), and illegal in almost all other SGML applications, so they can't interfere with the tags used in the static text parts (e.g. if you have <code>include</code> element in the generated XML).</p></li>
</ul>
<h2 id="ref_depr_numerical_interpolation">#{...}: Numerical interpolation</h2>
#{...}
<p>Deprecated: Use the <a href="#ref.setting.number_format"><code>number_format</code> setting</a> and <a href="#ref_builtin_string_for_number">the <code>string</code> built-in</a> instead. For formatting for computer audience (i.e., no localized formatting) use the <a href="#ref_builtin_c"><code>c</code> built-in</a> (like <code>number?c</code>).</p>
<h3>Synopsis</h3>
<pre><code>#{expression}
or
#{expression; format}</code></pre>
<p>Where:</p>
<ul>
<li><p><code>expression</code>: expression that can be evaluated as a number.</p></li>
<li><p><code>format</code>: optional format specifier.</p></li>
</ul>
<h3>Description</h3>
<p>The numerical interpolation is used to output a number value. If the expression doesn't evaluate to a number, the evaluation ends with an error.</p>
<p>The optional format specifier specifies the minimum and the maximum number of displayed fractional digits using syntax <code>mminMmax</code>. For example, <code>m2M5</code> means &quot;at least two, at most five fractional digits&quot;. The minimum or the maximum specifier part can be omitted. If only the minimum is specified, the maximum is equal to the minimum. If only maximum is specified, the minimum is 0.</p>
<p>The decimal separator character of the output is internationalized (according the current locale setting), which means that it is not necessarily a dot.</p>
<p>Unlike <code>${...}</code>, <code>#{...}</code> ignores the <a href="#ref.setting.number_format"><code>number_format</code> setting</a>. This is actually a backward compatibility quirk, but it can be useful when you print numbers in situations like <code>&lt;a href=&quot;queryDatabase?id=#{id}&quot;&gt;</code>, where you surely don't want grouping separators or something fancy like that. However, starting from FreeMarker 2.3.3 rather use the <a href="#ref_builtin_c"><code>?c</code> built-in</a> for this purpose, like <code>&lt;a
          href=&quot;queryDatabase?id=${id?c}&quot;&gt;</code>.</p>
<p>Examples. Assume that <code>x</code> is <code>2.582</code> and <code>y</code> is <code>4</code>:</p>
<pre><code>           &lt;#-- If the language is US English the output is: --&gt;
#{x}       &lt;#-- 2.582 --&gt;
#{y}       &lt;#-- 4 --&gt;
#{x; M2}   &lt;#-- 2.58 --&gt;
#{y; M2}   &lt;#-- 4    --&gt;
#{x; m1}   &lt;#-- 2.6 --&gt;
#{y; m1}   &lt;#-- 4.0 --&gt;
#{x; m1M2} &lt;#-- 2.58 --&gt;
#{y; m1M2} &lt;#-- 4.0  --&gt;</code></pre>
<h1 id="xgui_preface">Preface</h1>
<p>Although FreeMarker was originally designed as a web page template engine, as of version 2.3 it also targets another application domain: transforming XML into arbitrary textual output (e.g. HTML files). Thus, in many cases, FreeMarker is an XSLT alternative.</p>
<p>Technically, there is nothing special in transforming XML documents. It's just like when you do anything else with FreeMarker: you drop the XML document into the data-model (and possibly other variables), and then you merge the data-model with the FTL template(s) that generate the output text. The extra features introduced for better XML processing are the node FTL variable type (symbolizes a node in generic tree structures, usable not only for XML) and the built-ins and directives dealing with them, and the XML wrapper you get out-of-the-box that exposes XML documents as FTL variables for the templates.</p>
<p>What's the difference between using FreeMarker or XSLT? The FTL language has the usual imperative/procedural logic. On the other hand, XSLT is a language with declarative style, designed by &quot;too clever&quot; people, so it's not easy to adopt its logic, nor to use it in many cases. Also its syntax is terribly verbose. However, XSLT's &quot;apply-templates&quot; method can be very handy when you process XML documents, thus FreeMarker supports something similar called the “visitor pattern”. So in many applications, it is much easier to write FTL stylesheets than XSLT style-sheets. Another fundamental difference is that FTL &quot;transforms&quot; the node tree to text, while XSLT transforms the tree to another tree. So you cannot always use FreeMarker where you can use XSLT.</p>
<h1 id="xgui_expose">Exposing XML documents</h1>
XML
exposing
<h2 id="xgui_expose_dom">The DOM tree</h2>
<p>We will use this XML document for the examples:</p>
<pre><code>&lt;book&gt;
  &lt;title&gt;Test Book&lt;/title&gt;
  &lt;chapter&gt;
    &lt;title&gt;Ch1&lt;/title&gt;
    &lt;para&gt;p1.1&lt;/para&gt;
    &lt;para&gt;p1.2&lt;/para&gt;
    &lt;para&gt;p1.3&lt;/para&gt;
  &lt;/chapter&gt;
  &lt;chapter&gt;
    &lt;title&gt;Ch2&lt;/title&gt;
    &lt;para&gt;p2.1&lt;/para&gt;
    &lt;para&gt;p2.2&lt;/para&gt;
  &lt;/chapter&gt;
&lt;/book&gt;</code></pre>
<p>W3C DOM models an XML document as a tree of nodes. The node tree of the above XML can be visualized as:</p>
<pre><code>document
 |
 +- element book
     |
     +- text &quot;\n  &quot;
     |
     +- element title
     |   |
     |   +- text &quot;Test Book&quot;
     |
     +- text &quot;\n  &quot;
     |
     +- element chapter
     |   |
     |   +- text &quot;\n    &quot;
     |   |
     |   +- element title
     |   |   |
     |   |   +- text &quot;Ch1&quot;
     |   |
     |   +- text &quot;\n    &quot;
     |   |
     |   +- element para
     |   |   |
     |   |   +- text &quot;p1.1&quot;
     |   |
     |   +- text &quot;\n    &quot;
     |   |
     |   +- element para
     |   |   |
     |   |   +- text &quot;p1.2&quot;
     |   |
     |   +- text &quot;\n    &quot;
     |   |
     |   +- element para
     |      |
     |      +- text &quot;p1.3&quot;
     |
     +- element
         |
         +- text &quot;\n    &quot;
         |
         +- element title
         |   |
         |   +- text &quot;Ch2&quot;
         |
         +- text &quot;\n    &quot;
         |
         +- element para
         |   |
         |   +- text &quot;p2.1&quot;
         |
         +- text &quot;\n    &quot;
         |
         +- element para
             |
             +- text &quot;p2.2&quot;</code></pre>
<p>Note that the disturbing <code>&quot;\n  &quot;</code>-s are the line-breaks (indicated here with <code>\n</code>, an escape sequence used in FTL string literals) and the indentation spaces between the tags.</p>
<p>Notes on the DOM related terminology:</p>
<ul>
<li><p>The topmost node of a tree is called the <em>root</em>. In the case of XML documents, it is always the “document” node, and not the top-most element (<code>book</code> in this example).</p></li>
<li><p>We say that node B is the <em>child</em> of node A, if B is the <em>immediate</em> descendant of A. For example, the two <code>chapter</code> element nodes are the children of the <code>book</code> element node, but the <code>para</code> element nodes are not.</p></li>
<li><p>We say that node A is the <em>parent</em> of node B, if A is the <em>immediate</em> ascendant of node B, that is, if B is the children of A. For example, the <code>book</code> element node is the parent of the two <code>chapter</code> element nodes, but it is not the parent of the <code>para</code> element nodes.</p></li>
<li><p>There are several kind of components that can occur in XML documents, such as elements, text, comments, processing instructions, etc. All such components are nodes in the DOM tree, so there are element nodes, text nodes, comment nodes, etc. In principle, the attributes of elements are also nodes in the tree -- they are the children of the element --, but still, usually we (and other XML related technologies) exclude them of element children. So basically they don't count as children nodes.</p></li>
</ul>
<p>The programmer drops the document node of the DOM tree into the FreeMarker data-model, and then the template author can walk the DOM tree using that variable as the starting-point.</p>
<p>The DOM nodes in FTL correspond to <em>node variables</em>. This is a variable type, similarly to type string, number, hash, etc. Node variable type makes it possible for FreeMarker to get the parent node and the child nodes of a node. This is technically required to allow the template author to navigate between the nodes, say, to use the <a href="#ref_builtins_node">node built-ins</a> or the <a href="#ref.directive.visit"><code>visit</code></a> and <a href="#ref.directive.recurse"><code>recurse</code></a> directives; we will show the usage of these in the further chapters.</p>
<h2 id="xgui_expose_put">Putting the XML into the data-model</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>This section is for programmers.</p>
</blockquote>
<p>It's easy to create a simple program to try the examples. Just replace the “Create a data-model” part of <a href="#pgui_quickstart_all">the example of Programmer's Guide Quickstart</a> with this:</p>
<pre><code>/* Create a data-model */
Map root = new HashMap();
root.put(
        &quot;doc&quot;,
        freemarker.ext.dom.NodeModel.parse(new File(&quot;the/path/of/the.xml&quot;)));</code></pre>
<p>and then you have a program that outputs the result of the XML transformation to the standard output (usually the terminal screen).</p>
<p>Notes:</p>
<ul>
<li><p>The <code>parse</code> method removes comment and processing instruction nodes by default. See the API for more details.</p></li>
<li><p><code>NodeModel</code> also allows you to wrap <code>org.w3c.dom.Node</code>-s directly. You may want to clean up the DOM tree first with the static utility methods, such as <code>NodeModel.simplify</code> or your own custom cleanup routines.</p></li>
</ul>
<p>Note that there are tools available that you can use to generate files from XML documents, so you don't have to write your own for this common task. <a href="#pgui_misc_ant">See here...</a></p>
<h1 id="xgui_imperative">Imperative XML processing</h1>
XML
imperative processing
<h2 id="xgui_imperative_learn">Basics</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>This section uses the DOM tree and the variable made in the <a href="#xgui_expose">previous chapter</a>.</p>
</blockquote>
<p>Assume that the programmer has put the XML document into the data-model as variable <code>doc</code>. This variable corresponds to the root of the <a href="#xgui_expose_dom">DOM tree</a>, the “document”. The actual variable structure behind <code>doc</code> is wily enough, and only roughly resembles the DOM tree. So instead of getting lost in the details, let's see how to use it by example.</p>
<h3>Accessing elements by name</h3>
<p>This FTL prints the title of the book:</p>
<pre><code>&lt;h1&gt;${doc.book.title}&lt;/h1&gt;</code></pre>
<p>The output will be:</p>
<pre><code>&lt;h1&gt;Test Book&lt;/h1&gt;</code></pre>
<p>As you see, both <code>doc</code> and <code>book</code> can be used as hashes; you get their child nodes as sub variables. Basically, you describe the path by which you reach the target (element <code>title</code>) in the DOM tree. You may notice that there was some swindle above: with <code>${doc.book.title}</code>, it seems that we instruct FreeMarker to print the <code>title</code> element itself, but we should print its child text node (check the <a href="#xgui_expose_dom">DOM tree</a>). It still works, because elements are not only hash variables, but string variables as well. The scalar value of an element node is the string resulting from the concatenation of all its text child nodes. However, trying to use an element as scalar will cause error if the element has child elements. For example <code>${doc.book}</code> would stop with error.</p>
<p>This FTL prints the titles of the two chapters:</p>
<pre><code>&lt;h2&gt;${doc.book.chapter[0].title}&lt;/h2&gt;
&lt;h2&gt;${doc.book.chapter[1].title}&lt;/h2&gt;</code></pre>
<p>Here, as <code>book</code> has 2 <code>chapter</code> element children, <code>doc.book.chapter</code> is a sequence that stores the two element nodes. Thus, we can generalize the above FTL, so it works with any number of chapters:</p>
<pre><code>&lt;#list doc.book.chapter as ch&gt;
  &lt;h2&gt;${ch.title}&lt;/h2&gt;
&lt;/#list&gt;</code></pre>
<p>But what's if there is only one chapter? Actually, when you access an element as hash subvariable, it is <em>always</em> a sequence as well (not only hash and string), but if the sequence contains exactly 1 item, then the variable also acts as that item itself. So, returning to the first example, this would print the book title as well:</p>
<pre><code>&lt;h1&gt;${doc.book[0].title[0]}&lt;/h1&gt;</code></pre>
<p>But you know that there is exactly 1 <code>book</code> element, and that a book has exactly 1 title, so you can omit the <code>[0]</code>-s. <code>${doc.book.chapter.title}</code> would work too, if the book happen to have only 1 <code>chapter</code>-s (otherwise it is ambiguous: how is it to know if the <code>title</code> of which <code>chapter</code> you want? So it stops with an error.). But since a book can have multiple chapters, you don't use this form. If the element <code>book</code> has no <code>chapter</code> child, then <code>doc.book.chapter</code> will be a 0 length sequence, so the FTL with <code>&lt;#list ...&gt;</code> will still work.</p>
<p>It is important to realize the consequence that, for example, if <code>book</code> has no <code>chapter</code>-s then <code>book.chapter</code> is an empty sequence, so <code>doc.book.chapter??</code> will <em>not</em> be <code>false</code>, it will be always <code>true</code>! Similarly, <code>doc.book.somethingTotallyNonsense??</code> will not be <code>false</code> either. To check if there was no children found, use <code>doc.book.chapter[0]??</code> (or <code>doc.book.chapter?size == 0</code>). Of course you can use similarly all the <a href="#dgui_template_exp_missing">missing value handler operators</a> (e.g. <code>doc.book.author[0]!&quot;Anonymous&quot;</code>), just don't forget that <code>[0]</code>.</p>
<blockquote>
<p><strong>Note</strong></p>
<p>The rule with sequences of size 1 is a convenience feature of the XML wrapper (implemented via multi-type FTL variables). It will not work with other sequences in general.</p>
</blockquote>
<p>Now we finish the example by printing all the <code>para</code>-s of each chapter:</p>
<pre><code>&lt;h1&gt;${doc.book.title}&lt;/h1&gt;
&lt;#list doc.book.chapter as ch&gt;
  &lt;h2&gt;${ch.title}&lt;/h2&gt;
  &lt;#list ch.para as p&gt;
    &lt;p&gt;${p}
  &lt;/#list&gt;
&lt;/#list&gt;</code></pre>
<p>this will print:</p>
<pre><code>&lt;h1&gt;Test&lt;/h1&gt;
  &lt;h2&gt;Ch1&lt;/h2&gt;
    &lt;p&gt;p1.1
    &lt;p&gt;p1.2
    &lt;p&gt;p1.3
  &lt;h2&gt;Ch2&lt;/h2&gt;
    &lt;p&gt;p2.1
    &lt;p&gt;p2.2</code></pre>
<p>The above FTL could be written more nicely as:</p>
<pre><code>&lt;#assign book = doc.book&gt;
&lt;h1&gt;${book.title}&lt;/h1&gt;
&lt;#list book.chapter as ch&gt;
  &lt;h2&gt;${ch.title}&lt;/h2&gt;
  &lt;#list ch.para as p&gt;
    &lt;p&gt;${p}
  &lt;/#list&gt;
&lt;/#list&gt;</code></pre>
<p>Finally, a generalized usage of the child selector mechanism: this template lists all <code>para</code>-s of the example XML document:</p>
<pre><code>&lt;#list doc.book.chapter.para as p&gt;
  &lt;p&gt;${p}
&lt;/#list&gt;</code></pre>
<p>The output will be:</p>
<pre><code>  &lt;p&gt;p1.1
  &lt;p&gt;p1.2
  &lt;p&gt;p1.3
  &lt;p&gt;p2.1
  &lt;p&gt;p2.2
  </code></pre>
<p>This example shows that hash sub variables select the children of a sequence of notes (just in the earlier examples that sequence happened to be of size 1). In this concrete case, subvariable <code>chapter</code> returns a sequence of size 2 (since there are two <code>chapter</code>-s), and then subvariable <code>para</code> selects the <code>para</code> child nodes of all nodes in that sequence.</p>
<p>A negative consequence of this mechanism is that things like <code>doc.somethingNonsense.otherNonsesne.totalNonsense</code> will just evaluate to an empty sequence, and you don't get any error messages.</p>
<h3>Accessing attributes</h3>
<p>This XML is the same as the original, except that it uses attributes for the titles, instead of elements:</p>
<pre><code>&lt;!-- THIS XML IS USED FOR THE &quot;Accessing attributes&quot; CHAPTER ONLY! --&gt;
&lt;!-- Outside this chapter examples use the XML from earlier.       --&gt;

&lt;book title=&quot;Test&quot;&gt;
  &lt;chapter title=&quot;Ch1&quot;&gt;
    &lt;para&gt;p1.1&lt;/para&gt;
    &lt;para&gt;p1.2&lt;/para&gt;
    &lt;para&gt;p1.3&lt;/para&gt;
  &lt;/chapter&gt;
  &lt;chapter title=&quot;Ch2&quot;&gt;
    &lt;para&gt;p2.1&lt;/para&gt;
    &lt;para&gt;p2.2&lt;/para&gt;
  &lt;/chapter&gt;
&lt;/book&gt;</code></pre>
<p>The attributes of an element can be accessed in the same way as the child elements of the element, except that you put an at-sign (@) before the name of the attribute:</p>
<pre><code>&lt;#assign book = doc.book&gt;
&lt;h1&gt;${book.@title}&lt;/h1&gt;
&lt;#list book.chapter as ch&gt;
  &lt;h2&gt;${ch.@title}&lt;/h2&gt;
  &lt;#list ch.para as p&gt;
    &lt;p&gt;${p}
  &lt;/#list&gt;
&lt;/#list&gt;</code></pre>
<p>This will print exactly the same as the previous example.</p>
<p>Getting attributes follows the same logic as getting child elements, so the result of <code>ch.@title</code> above is a sequence of size 1. If there were no <code>title</code> attribute, then the result would be a sequence of size 0. So be ware, using existence built-ins is tricky here too: if you are curious if <code>foo</code> has attribute <code>bar</code> then you have to write <code>foo.@bar[0]??</code>. (<code>foo.@bar??</code> is wrong, because it always returns <code>true</code>.) Similarly, if you want a default value for the <code>bar</code> attribute, then you have to write <code>foo.@bar[0]!&quot;theDefaultValue&quot;</code>.</p>
<p>As with child elements, you can select the attributes of multiple nodes. For example, this template prints the titles of all chapters:</p>
<pre><code>&lt;#list doc.book.chapter.@title as t&gt;
  ${t}
&lt;/#list&gt;</code></pre>
<h3>Exploring the tree</h3>
<p>This FTL will enumerate all child nodes of the book element:</p>
<pre><code>&lt;#list doc.book?children as c&gt;
- ${c?node_type} &lt;#if c?node_type == &#39;element&#39;&gt;${c?node_name}&lt;/#if&gt;
&lt;/#list&gt;</code></pre>
<p>this will print:</p>
<pre><code>- text
- element title
- text
- element chapter
- text
- element chapter
- text</code></pre>
<p>The meaning of <code>?node_type</code> is probably clear without explanation. There are several node types that can occur in a DOM tree, such as <code>&quot;element&quot;</code>, <code>&quot;text&quot;</code>, <code>&quot;comment&quot;</code>, <code>&quot;pi&quot;</code>, ...etc.</p>
<p>The <code>?node_name</code> returns the name of element for element nodes. For other node types, it also returns something, but that's mainly useful for declarative XML processing, which will be discussed in a <a href="#xgui_declarative">later chapter</a>.</p>
<p>If the book element had attributes, they would <em>not</em> appear in the above list, for practical reasons. But you can get a list that contains all attributes of the element, with subvariable <code>@@</code> of the element variable. If you modify the first line of the XML to this:</p>
<pre><code>&lt;book foo=&quot;Foo&quot; bar=&quot;Bar&quot; baaz=&quot;Baaz&quot;&gt;</code></pre>
<p>and run this FTL:</p>
<pre><code>&lt;#list doc.book.@@ as attr&gt;
- ${attr?node_name} = ${attr}
&lt;/#list&gt;</code></pre>
<p>then you get this output (or something similar):</p>
<pre><code>- baaz = Baaz
- bar = Bar
- foo = Foo</code></pre>
<p>Returning to the listing of children, there is a convenience subvariable to list only the element children of an element:</p>
<pre><code>&lt;#list doc.book.* as c&gt;
- ${c?node_name}
&lt;/#list&gt;</code></pre>
<p>This will print:</p>
<pre><code>- title
- chapter
- chapter</code></pre>
<p>You get the parent of an element with the <code>parent</code> built-in:</p>
<pre><code>&lt;#assign e = doc.book.chapter[0].para[0]&gt;
&lt;#-- Now e is the first para of the first chapter --&gt;
${e?node_name}
${e?parent?node_name}
${e?parent?parent?node_name}
${e?parent?parent?parent?node_name}</code></pre>
<p>This will print:</p>
<pre><code>para
chapter
book
@document</code></pre>
<p>In the last line you have reached the root of the DOM tree, the document node. It's not an element, and this is why it has that strange name; don't deal with it now. Obviously, the document node has no parent.</p>
<p>You can quickly go back to the document node using the <code>root</code> built-in:</p>
<pre><code>&lt;#assign e = doc.book.chapter[0].para[0]&gt;
${e?root?node_name}
${e?root.book.title}</code></pre>
<p>This will print:</p>
<pre><code>@document
Test Book</code></pre>
<p>For the complete list of built-ins you can use to navigate in the DOM tree, read the <a href="#ref_builtins_node">reference of node built-ins</a>.</p>
<h3 id="xgui_imperative_learn_xpath">Using XPath expressions</h3>
<blockquote>
<p><strong>Note</strong></p>
<p>XPath expressions work only if <a href="http://xml.apache.org/xalan/">Apache Xalan</a> or <a href="http://jaxen.org/">Jaxen</a> (at least 1.1) classes are available. However, up to Java 1.8 you don't need any additional dependencies, as Apache Xalan is included in Java with changed package names, which FreeMarker will automatically use (unless plain Apache Xalan is also present). This internal Xalan isn't available anymore on OpenJDK 9, but is still available on Oracle JDK/JRE 9 (at least on official stable release “build 9+181”).</p>
</blockquote>
<blockquote>
<p><strong>Note</strong></p>
<p>Don't use the sample XML from the previous section, where <code>title</code> is an attribute; that applies only to that section.</p>
</blockquote>
<p>If a hash key used with a node variable can't be interpreted otherwise (see the <a href="#xgui_imperative_formal">next section</a> for the precise definition), then it will by interpreted as an XPath expression. For more information on XPath, please visit <a href="http://www.w3.org/TR/xpath" class="uri">http://www.w3.org/TR/xpath</a>.</p>
<p>For example, here we list the <code>para</code> elements of the chapter with <code>title</code> element (not attribute!) content &quot;Ch1'':</p>
<pre><code>&lt;#list doc[&quot;book/chapter[title=&#39;Ch1&#39;]/para&quot;] as p&gt;
  &lt;p&gt;${p}
&lt;/#list&gt;</code></pre>
<p>It will print:</p>
<pre><code>  &lt;p&gt;p1.1
  &lt;p&gt;p1.2
  &lt;p&gt;p1.3</code></pre>
<p>The rule with sequences of length 1 (explained in earlier sections) stands for XPath results as well. That is, if the resulting sequence contains exactly 1 node, it also acts as the node itself. For example, print the first paragraph of chapter “Ch1”:</p>
<pre><code>${doc[&quot;book/chapter[title=&#39;Ch1&#39;]/para[1]&quot;]}</code></pre>
<p>which prints the same as:</p>
<pre><code>${doc[&quot;book/chapter[title=&#39;Ch1&#39;]/para[1]&quot;][0]}</code></pre>
<p>The context node of the XPath expression is the node (or sequence of nodes) whose hash subvariable is used to issue the XPath expression. Thus, this prints the same as the previous example:</p>
<pre><code>${doc.book[&quot;chapter[title=&#39;Ch1&#39;]/para[1]&quot;]}</code></pre>
<p>Note that currently you can use a sequence of 0 or multiple (more than 1) nodes as context only if the programmer has set up FreeMarker to use Jaxen instead of Xalan.</p>
<p>Also note that XPath indexes sequence items from 1, while FTL indexes sequence items from 0. Thus, to select the first chapter, the XPath expression is <code>&quot;/book/chapter[1]&quot;</code>, while the FTL expression is <code>book.chapter[0]</code>.</p>
<p>If the programmer has set up FreeMarker to use Jaxen instead of Xalan, then FreeMarker variables are visible with XPath variable references:</p>
<pre><code>&lt;#assign currentTitle = &quot;Ch1&quot;&gt;
&lt;#list doc[&quot;book/chapter[title=$currentTitle]/para&quot;] as p&gt;
...</code></pre>
<p>Note that <code>$currentTitle</code> is not a FreeMarker interpolation, as there are no <code>{</code> and <code>}</code> there. That's an XPath expression.</p>
<p>The result of some XPath expressions is not a node-set, but a string, a number, or a boolean. For those XPath expressions, the result is an FTL string, number, or boolean variable respectively. For example, the following will count the total number of <code>para</code> elements in the XML document, so the result is a number:</p>
<pre><code>${x[&quot;count(//para)&quot;]}</code></pre>
<p>The output will be:</p>
<pre><code>5</code></pre>
<h3>XML namespaces</h3>
XML namespace
in imperative processing
<p>Be default, when you write something like <code>doc.book</code>, then it will select the element with name <code>book</code> that does not belongs to any XML namespace (similarly to XPath). If you want to select an element that is inside an XML namespace, you must register a prefix and use that. For example, if element <code>book</code> is in XML namespace <code>http://example.com/ebook</code>, then you have to associate a prefix with it at the top of the template with the <code>ns_prefixes</code> parameter of the <a href="#ref.directive.ftl"><code>ftl</code> directive</a>:</p>
<pre><code>&lt;#ftl ns_prefixes={&quot;e&quot;:&quot;http://example.com/ebook&quot;}&gt;</code></pre>
<p>And now you can write expressions as <code>doc[&quot;e:book&quot;]</code>. (The usage of square bracket syntax was required because the colon would confuse FreeMarker otherwise.)</p>
<p>As the value of <code>ns_prefixes</code> is a hash, you can register multiple prefixes:</p>
<pre><code>&lt;#ftl ns_prefixes={
    &quot;e&quot;:&quot;http://example.com/ebook&quot;,
    &quot;f&quot;:&quot;http://example.com/form&quot;,
    &quot;vg&quot;:&quot;http://example.com/vectorGraphics&quot;}
&gt;</code></pre>
<p>The <code>ns_prefixes</code> parameter affects the whole <a href="#dgui_misc_namespace">FTL namespace</a>. This means in practice that the prefixes you have registered in the main page template will be visible in all <code>&lt;#include
          ...&gt;</code>-d templates, but not in <code>&lt;#imported
          ...&gt;</code>-d templates (often referred as FTL libraries). Or from another point of view, an FTL library can register XML namespace prefixes for it's own use, without interfering with the prefix registrations of the main template and other libraries.</p>
<p>Note that, if an input document is dominated by a given XML namespace, you can set that as the default namespace for convenience. This means that if you don't use prefix, as in <code>doc.book</code>, then it selects element that belongs to the default namespace. The setting of the default namespace happens with reserved prefix <code>D</code>, for example:</p>
<pre><code>&lt;#ftl ns_prefixes={&quot;D&quot;:&quot;http://example.com/ebook&quot;}&gt;</code></pre>
<p>Now expression <code>doc.book</code> select the <code>book</code> element that belongs to XML namespace <code>http://example.com/ebook</code>. Unfortunately, XPath does not support this idea of a default namespace. Thus, in XPath expressions, element names without prefixes always select the elements that does not belong to any XML namespace. However, to access elements in the default namespace you can directly use prefix <code>D</code>, for example: <code>doc[&quot;D:book/D:chapter[title='Ch1']&quot;]</code>.</p>
<p>Note that when you use a default namespace, then you can select elements that does not belong to any node namespace with reserved prefix <code>N</code>, for example <code>doc.book[&quot;N:foo&quot;]</code>. It doesn't go for XPath expressions, where the above can be witten as <code>doc[&quot;D:book/foo&quot;]</code>.</p>
<h3>Don't forget escaping!</h3>
<p>As we generate output of HTML format in these examples, and HTML format reserves characters as <code>&lt;</code>, <code>&amp;</code>, etc., we have to ensure that those will be escaped. For that, either FreeMarker has to be <a href="#pgui_config_outputformatsautoesc">properly configured</a>, or add <code>output_format=&quot;HTML&quot;</code> in the template to the <code>ftl</code> directive calls.</p>
<p>So if the book title is &quot;Romeo &amp; Juliet&quot;, the resulting HTML output will be correctly:</p>
<pre><code>...
&lt;h1&gt;Romeo &amp;amp; Juliet&lt;/h1&gt;
...</code></pre>
<h2 id="xgui_imperative_formal">Details</h2>
<p>Every variable that corresponds to a single node in the DOM tree is a multi-type variable of type node and type hash (for programmers: implements both <code>TemplateNodeModel</code> and <code>TemplateHashModel</code>). Thus, you can use the <a href="#ref_builtins_node">node built-ins</a> with them. Hash keys are interpreted as XPath expressions, except the special keys shown in the table below. Some of the node variables also have string type, so you can use them as string variables (for programmers: they implement <code>TemplateScalarModel</code>).</p>
<table>
<thead>
<tr class="header">
<th>Node type (<code>?node_type</code>)</th>
<th>Node name (<code>?node_name</code>)</th>
<th>String value (e.g. <code>&lt;p&gt;${node}</code>)</th>
<th>Special hash keys</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>&quot;document&quot;</code></td>
<td><code>&quot;@document&quot;</code></td>
<td>No string value. (Error when you try to use it as string.)</td>
<td><code>elementName</code>, <code>&quot;prefix:elementName&quot;</code>, <code>*</code>, <code>**</code>, <code>@@markup</code>, <code>@@nested_markup</code>, <code>@@text</code>, <code>@@local_name</code>, <code>@@qname</code>, <code>@@namespace</code></td>
</tr>
<tr class="even">
<td><code>&quot;element&quot;</code></td>
<td><code>&quot;name&quot;</code>: the name of the element. This is the local name (i.e. name without namespace prefix).</td>
<td>If it has no element children, the text of all text node children concatenated together. Error otherwise, when you try to use it as string.</td>
<td><code>elementName</code>, <code>&quot;prefix:elementName&quot;</code>, <code>*</code>, <code>**</code>, <code>@attrName</code>, <code>&quot;@prefix:attrName&quot;</code>, <code>@@</code>, <code>&quot;@*&quot;</code>, <code>@@start_tag</code>, <code>@@end_tag</code>, <code>@@attributes_markup</code>, <code>@@next_sibling_element</code>, <code>@@previous_sibling_element</code>, <code>@@markup</code>, <code>@@nested_markup</code>, <code>@@text</code>, <code>@@local_name</code>, <code>@@qname</code>, <code>@@namespace</code></td>
</tr>
<tr class="odd">
<td><code>&quot;text&quot;</code></td>
<td><code>&quot;@text&quot;</code></td>
<td>The text itself.</td>
<td><code>@@markup</code>, <code>@@nested_markup</code>, <code>@@text</code>, <code>@@local_name</code>, <code>@@qname</code>, <code>@@namespace</code></td>
</tr>
<tr class="even">
<td><code>&quot;pi&quot;</code></td>
<td><code>&quot;@pi$target&quot;</code></td>
<td>The part between the target name and the <code>?&gt;</code>.</td>
<td><code>@@markup</code>, <code>@@nested_markup</code>, <code>@@text</code>, <code>@@local_name</code>, <code>@@qname</code>, <code>@@namespace</code></td>
</tr>
<tr class="odd">
<td><code>&quot;comment&quot;</code></td>
<td><code>&quot;@comment&quot;</code></td>
<td>The text of the comment, without the delimiters <code>&lt;!--</code> and <code>--&gt;</code>.</td>
<td><code>@@markup</code>, <code>@@nested_markup</code>, <code>@@text</code>, <code>@@local_name</code>, <code>@@qname</code>, <code>@@namespace</code></td>
</tr>
<tr class="even">
<td><code>&quot;attribute&quot;</code></td>
<td><code>&quot;name&quot;</code>: the name of the attribute. This is the local name (i.e. name without namespace prefix).</td>
<td>The value of the attribute.</td>
<td><code>@@markup</code>, <code>@@nested_markup</code>, <code>@@text</code>, <code>@@qname</code>, <code>@@local_name</code>, <code>@@qname</code>, <code>@@namespace</code></td>
</tr>
<tr class="odd">
<td><code>&quot;document_type&quot;</code></td>
<td><code>&quot;@document_type$name&quot;</code>: <code>name</code> is the name of the document element.</td>
<td>No string value. (Error when you try to use it as string.)</td>
<td><code>@@markup</code>, <code>@@nested_markup</code>, <code>@@text</code>, <code>@@local_name</code>, <code>@@qname</code>, <code>@@namespace</code></td>
</tr>
</tbody>
</table>
<p>Notes:</p>
<ul>
<li><p>There is no CDATA type. CDATA nodes are transparently considered as text nodes.</p></li>
<li><p>These variables do <em>not</em> support <code>?keys</code> and <code>?values</code>.</p></li>
<li><p>Element and attribute node names are local names, that is, they do not contain the namespace prefix. The URI of the namespace the node belongs to can be queried with the <code>?node_namespace</code> built-in.</p></li>
<li><p>XPath expression needs Jaxen (recommended, but please use 1.1-beta-8 or later; <a href="http://jaxen.org/">download it here</a>) or Apache Xalan classes available, or an error will stop template execution. Note, however, that as some special hash keys hide the XPath expressions of the same meaning, those XPath expressions will work even if there is no XPath implementation available. If both Xalan and Jaxen is available, FreeMarker will use Xalan, unless you choose Jaxen by calling <code>freemarker.ext.dom.NodeModel.useJaxenXPathSupport()</code> from Java.</p></li>
<li><p>If Jaxen is used for the XPath support (not Xalan), then FreeMarker variables are visible with XPath variable references (e.g. <code>doc[&quot;book/chapter[title=$currentTitle]&quot;]</code>).</p></li>
</ul>
<p>Meaning of special hash keys:</p>
<ul>
<li><p><code>elementName</code>, <code>&quot;prefix:elementName&quot;</code>: Returns the sequence of child nodes that are elements of name <code>elementName</code>. (Note that the term “child” means <em>immediate</em> descendant.) The selection is XML name-space aware, unless the XML document was persed with an XML parser that was not in namespace aware mode. In XML name-space aware mode, names without prefix (elementName) selects only elements that doesn't belong to any XML name-space (unless you have registered a default XML namespace), and names with prefix (prefix:elementName) selects only elements that are belonging to the XML namespace denoted by the prefix. The registration of prefixes and the setting of the default XML namespace is done with the <code>ns_prefixes</code> parameter of the <a href="#ref.directive.ftl"><code>ftl</code> directive</a>.</p></li>
<li><p><code>*</code>: Returns the sequence of all child (direct descendant) <em>element</em> nodes. The sequence will contain the elements in the “document order”, that is, in the order in which the first character of the XML representation of each node occurs (after expansion of general entities).</p></li>
<li><p><code>**</code>: Returns the sequence of all descendant <em>element</em> nodes. The sequence will contain the elements in the document order.</p></li>
<li><p><code>@attName</code>, <code>&quot;@prefix:attrName&quot;</code>: Returns the attribute <code>attName</code> of the element as a sequence of size 1 that contains the attribute node, or as an empty sequence if the attribute does not exist (so to check if an attribute exists use <code>foo.@attName[0]??</code>, <em>not</em> <code>foo.@attName??</code>). As with special key <code>&quot;elementName&quot;</code>, if the length of the sequence is 1, then it also acts as its first subvariable. If no <code>prefix</code> is used, then it returns only attribute that does not use XML namespace (even if you have set a default XML namespace). If a <code>prefix</code> is used, it returns only the attribute that belongs to the XML namespace associated with the <code>prefix</code>. The registration of prefixes is done with the <code>ns_prefixes</code> parameter of the <a href="#ref.directive.ftl"><code>ftl</code> directive</a>.</p></li>
<li><p><code>@@</code> or <code>&quot;@*&quot;</code>: Returns the sequence of attribute nodes belonging to the parent element. This is the same as XPath <code>@*</code>.</p></li>
<li><p><code>@@qname</code>: Returns the full-qualified name of the element (such as <code>e:book</code>, in contrast to the local name returned by <code>?node_name</code> that is <code>book</code>) . The prefix used (as <code>e</code>) is chosen based on the prefix registered in the current namespace with the <code>ns_prefixes</code> parameter of the <code>ftl</code> directive, and not influenced by the prefix used in the source XML document. If you have set a default XML namespace, then for nodes that use that, prefix <code>D</code> will be used. For nodes that does not belong to an XML namespace, no prefix is used (even if you have set a default namespace). If there is no prefix registered for the namespace of the node, the result is a non-existent variable (<code>node.@@qname??</code> is <code>false</code>).</p></li>
<li><p><code>@@local_mame</code>: The name of the node without the namespace prefix.</p></li>
<li><p><code>@@namespace</code>: The namespace URL (not the namespace prefix) of the node.</p></li>
<li><p><code>@@markup</code>: This returns the full XML markup of a node, as a string. (Full XML markup means that it also contains the markup of the child nodes, and the markup of the children of the child nodes, and so on.) The markup you get is not necessary the same as the markup in the source XML file, it's just semantically identical. Especially, note that CDATA sections will become to plain text. Also note that depending on how did you wrapped the original XML document with FreeMarker, comment or processing instruction nodes may were removed, and then they will be missing from the output of course. The first outputted start tag will contain <code>xmlns:prefix</code> attributes for each XML name-spaces used in the outputted XML fragment, and those prefixes will be used in the outputted element and attribute names. These prefixes will be the same as the prefixes registered with the <code>ns_prefixes</code> parameter of the <code>ftl</code> directive (no prefix will be used for <code>D</code>, as it will be registered as the default name-space with an <code>xmlns</code> attribute), or if no prefix was assigned for a XML name-space with that, then an arbitrary chosen unused prefix is used.</p></li>
<li><p><code>@@nested_markup</code>: This is similar to <code>@@markup</code>, but it returns the XML markup of an element without its opening and closing tags. For the document node, it returns the same as <code>@@markup</code>. For other node types (text, processing instruction, etc.), it returns an empty string. Unlike with <code>@@markup</code>, no <code>xmlns:prefix</code> attributes will be placed into the output, but regarding the prefixes used in element and attribute names the rules are the same.</p></li>
<li><p><code>@@text</code>: This returns the value of all text nodes that occur within the node (all descendant text nodes, not just direct children), concatenated together into a single string. If the node has no text node children, then the result is an empty string.</p></li>
<li><p><code>@@start_tag</code>: Returns the markup of the <a href="#gloss.startTag">start-tag</a> of the element node. As with <code>@@markup</code>, the output is not necessary the same as in the original XML document, but it is semantically equivalent with that. Regarding the XML name-spaces (<code>xmlns:prefix</code> attributes in the output, etc.) the rules are the same as with <code>&quot;@@markup&quot;</code></p></li>
<li><p><code>@@end_tag</code>: Returns the markup of the <a href="#gloss.endTag">end-tag</a> of the element node. As with <code>@@markup</code>, the output is not necessary the same as in the original XML document, but it is semantically equivalent with that.</p></li>
<li><p><code>@@attributes_markup</code>: Returns the markup of the <a href="#gloss.attribute">attributes</a> of the element node. As with <code>@@markup</code>, the output is not necessary the same as in the original XML document, but it is semantically equivalent with that.</p></li>
<li><p><code>@@next_sibling_element</code> (since 2.3.26): The following sibling element of an element node or an empty node sequence if there's no such element. An element counts as a sibling of another element if they are on the same hierarchical level, and there's no other element or non-whitespace character data (text or CDATA) between the two elements. For example in <code>&lt;a/&gt;&lt;!-- comment
            --&gt;&amp;#x20;&lt;b/&gt;</code> the two elements are siblings, but not in <code>&lt;a/&gt;text&lt;b/&gt;</code> or <code>&lt;a/&gt;&lt;x/&gt;&lt;b/&gt;</code>.</p></li>
<li><p><code>@@previous_sibling_element</code> (since 2.3.26): The previous sibling element of an element node or an empty node sequence if there's no such element. See the last point for the meaning of sibling.</p></li>
</ul>
<h3>Node sequences</h3>
<p>Many of the special hash keys (indicated in the above list), and XPath expressions that result in node-sets (see the <a href="http://www.w3.org/TR/xpath">XPath recommendation</a>) return a sequence of nodes.</p>
<p>These node sequences, if they store exactly 1 subvariable, will also act as the subvariable itself. For example, <code>${book.title[0]}</code> will do the same as <code>${book.title}</code>, if there is only one <code>title</code> element child of element <code>book</code>.</p>
<p>Returning an empty node sequence is a normal situation. For example, if in a concrete XML document, element <code>book</code> has no child element <code>chapter</code>, then <code>book.chapter</code> results in an empty node sequence. Beware! This also means, that <code>book.chaptre</code> (note the typo) will also return empty node sequence, and will not stop with error. Also, <code>book.chaptre??</code> (note the typo) will return <code>true</code> because the empty sequence exists, so you have to use <code>book.chaptre[0]??</code> for the check.</p>
<p>Node sequences that store not 1 nodes (but 0 or more than 1 nodes) also support some of the hash keys described above. Namely, the following special keys are supported:</p>
<ul>
<li><p><code>elementName</code>, <code>&quot;prefix:elementName&quot;</code></p></li>
<li><p><code>@attrName</code>, <code>&quot;@prefix:attrName&quot;</code></p></li>
<li><p><code>@@markup</code>, <code>@@nested_markup</code></p></li>
<li><p><code>@@text</code></p></li>
<li><p><code>*</code>, <code>**</code></p></li>
<li><p><code>@@</code>, <code>&quot;@*&quot;</code></p></li>
</ul>
<p>When you apply one of the above special keys on a node sequence that contains more than 1 or 0 nodes, then for each node in the sequence (where the special key does make sense, e.g. text nodes will be skipped for key <code>*</code> or <code>@foo</code>), the special key will be applied as it was explained for single nodes, and the results will be concatenated to form the final result. The results will be concatenated in the order as the corresponding nodes occur in the node sequence. The concatenation means string or sequence concatenation depending on the type of the results. If the special key would result in a string for a single node, then for multiple nodes the result is a single string too (the results for the single nodes concatenated), and if the special key would return a sequence for a single node, then for multiple nodes the result is a single sequence too. If there are 0 nodes in the sequence you apply the special key on, the string result is an empty string or an empty sequence respectively.</p>
<p>XPath expressions can be used with node sequences. However, for 0 or more than 1 nodes it will work only if you use Jaxen instead of Xalan, because of the limitations of the Xalan XPath implementation.</p>
<h1 id="xgui_declarative">Declarative XML processing</h1>
XML
declarative processing
XSLT
<h2 id="xgui_declarative_basics">Basics</h2>
<blockquote>
<p><strong>Note</strong></p>
<p>This section uses the DOM tree and the variable made in <a href="#xgui_expose">a previous chapter</a>.</p>
</blockquote>
<p>With the imperative approach of XML processing -- this was shown in the previous chapter -- you write an FTL program that walks the tree to find the different kind of nodes. With the declarative approach, you rather define how to handle the different kind of nodes, and then let FreeMarker walk the tree and call the handlers you have defined. This approach is useful for complex XML schemas, where the same element can occur as the child of many other elements. Examples of such schemas are XHTML and XDocBook.</p>
<p>The directive you most often use with the declarative approach is the <a href="#ref.directive.recurse"><code>recurse</code> directive</a>. This directive gets a node variable as parameter, and “visits” all its children nodes, one after the other, starting with the first child. “Visiting” a node means that it calls a user-defined directive (like a macro) that has the same name as the name of the child node (<code>?node_name</code>). We say on this, that the user-defined directive <em>handles</em> the node. The node that the user-defined directive just handles is available as special variable <code>.node</code>. For example, this FTL:</p>
<pre><code>&lt;#recurse doc&gt;

&lt;#macro book&gt;
  I&#39;m the book element handler, and the title is: ${.node.title}
&lt;/#macro&gt;</code></pre>
<p>will print (I have removed some disturbing white-space form the output):</p>
<pre><code>I&#39;m the book element handler, and the title is: Test Book</code></pre>
<p>If you call <code>recurse</code> without parameter, then it uses <code>.node</code>, that is, it visits all children nodes of the node currently handled. So this FTL:</p>
<pre><code>&lt;#recurse doc&gt;

&lt;#macro book&gt;
  Book element with title ${.node.title}
    &lt;#recurse&gt;
  End book
&lt;/#macro&gt;

&lt;#macro title&gt;
  Title element
&lt;/#macro&gt;

&lt;#macro chapter&gt;
  Chapter element with title: ${.node.title}
&lt;/#macro&gt;</code></pre>
<p>will print (I have removed disturbing white-space form the output):</p>
<pre><code>Book element with title Test Book
Title element
Chapter element with title: Ch1
Chapter element with title: Ch2
End book</code></pre>
<p>You have seen how to define handlers for element nodes, but not how to define handler for the text nodes. Since the name of the handler is the same as the node-name of nodes it handles, and as the node-name of all text nodes is <code>@text</code> (see <a href="#misc.xguiTable">the table</a>), you define handler for the text nodes like this:</p>
<pre><code>&lt;#macro @text&gt;${.node?html}&lt;/#macro&gt;</code></pre>
<p>Note the <code>?html</code>. You have to HTML-escape the text, since you generate output of HTML format.</p>
<p>Here it is the template that transforms the XML to complete HTML:</p>
<pre><code>&lt;#recurse doc&gt;

&lt;#macro book&gt;
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;&lt;#recurse .node.title&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;h1&gt;&lt;#recurse .node.title&gt;&lt;/h1&gt;
      &lt;#recurse&gt;
    &lt;/body&gt;
  &lt;/html&gt;
&lt;/#macro&gt;

&lt;#macro chapter&gt;
  &lt;h2&gt;&lt;#recurse .node.title&gt;&lt;/h2&gt;
  &lt;#recurse&gt;
&lt;/#macro&gt;

&lt;#macro para&gt;
  &lt;p&gt;&lt;#recurse&gt;
&lt;/#macro&gt;

&lt;#macro title&gt;
  &lt;#--
    We have handled this element imperatively,
    so we do nothing here.
  --&gt;
&lt;/#macro&gt;

&lt;#macro @text&gt;${.node?html}&lt;/#macro&gt;</code></pre>
<p>and the output will be (now I will honestly include the annoying white-space...):</p>
<pre><code>  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;Test Book&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;h1&gt;Test Book&lt;/h1&gt;


    &lt;h2&gt;Ch1&lt;/h2&gt;


      &lt;p&gt;p1.1

      &lt;p&gt;p1.2

      &lt;p&gt;p1.3


    &lt;h2&gt;Ch2&lt;/h2&gt;


      &lt;p&gt;p2.1

      &lt;p&gt;p2.2


    &lt;/body&gt;
  &lt;/html&gt;

  </code></pre>
<p>Note that you can reduce substantially the amount of superfluous whitespace in the output by using the <a href="#ref_directive_t">trim directives</a>, as <code>&lt;#t&gt;</code>. See also: <a href="#dgui_misc_whitespace">section_title</a></p>
<p>You may say that the FTL that did it with imperative approach was much shorter. That's true, but the example XML uses a very simple schema, and as I said, the declarative approach brings its form with XML schemas that are not that firm about what element can occur where. Say, introduce element <code>mark</code>, that should color text to red, does not mater where do you use it; in a <code>title</code>, or in a <code>para</code>. For this, with the declarative approach, you just add a macro:</p>
<pre><code>&lt;#macro mark&gt;&lt;font color=red&gt;&lt;#recurse&gt;&lt;/font&gt;&lt;/#macro&gt;</code></pre>
<p>And then <code>&lt;mark&gt;...&lt;/mark&gt;</code> will automatically work everywhere. So for certain XML schemas, declarative XML processing will actually result in shorter, and what is even more important, much clearer FTL-s, than imperative XML processing. It's up to you to decide which approach to use when; don't forget that you can mix the two approaches freely. Say, in an element handler, you can use imperative approach to process the contents of that element.</p>
<h2 id="xgui_declarative_details">Details</h2>
<h3>Default handlers</h3>
<p>For some XML node types, there is a default handler, which will handle the node if you haven't defined a handler for the node (i.e. if there is no user-defined directive available with name identical to the node name). Here are these node types, and what the default handler does:</p>
<ul>
<li><p>Text node: prints the text as it. Note, that in most applications, this will not be good for you, because you should escape the text before you send it to the output (with <code>?html</code> or <code>?xml</code> or <code>?rtf</code>, ...etc. depends on the output format).</p></li>
<li><p>Processing instruction node: call handler called <code>@pi</code> if you have created such user-defined directive, otherwise do nothing (ignore the node).</p></li>
<li><p>Comment node, document type node: Do nothing (ignore the node).</p></li>
<li><p>Document node: Call <code>recurse</code>, that is, visit all children of the document node.</p></li>
</ul>
<p>Element and attribute nodes will be handled according to the usual, XML independent mechanism. That is, <code>@node_type</code> will be called as handler, and if that's not defined, then an error stops template processing.</p>
<p>In the case of element nodes, this means that if you define a macro (or other kind of user-defined directive) called <code>@element</code>, that will catch all element nodes, which has no more specific handler. If you have no <code>@element</code> handler, then you <em>must</em> define a handler for all possible elements.</p>
<p>Attribute nodes are not visited by the <code>recurse</code> directive, so you don't need to write handlers for them.</p>
<h3>Visiting a single node</h3>
<p>With the <a href="#ref.directive.visit"><code>visit</code> directive</a> you can visit a single node, instead of the children of the node: <code>&lt;#visit nodeToVisist&gt;</code>. This can be useful sometimes.</p>
<h3>XML namespaces</h3>
XML namespaces
in declarative processing
<p>We said that the name of the handler user-defined directive (like a macro) for an element is the name of the element. In fact, it is the full-qualified name of the element: <code>prefix:elementName</code>. The rules regarding the usage of <code>prefix</code>-es is the same as with imperative processing. Thus, the user-defined <code>book</code> directive handles only element <code>book</code> that does not belong to any XML namespace (unless you have specified a default XML namespace). So if the example XML would use XML namespace <code>http://example.com/ebook</code>:</p>
<pre><code>&lt;book xmlns=&quot;http://example.com/ebook&quot;&gt;
...</code></pre>
<p>Then the FTL should look as this:</p>
<pre><code>&lt;#ftl ns_prefixes={&quot;e&quot;:&quot;http://example.com/ebook&quot;}&gt;

&lt;#recurse doc&gt;

&lt;#macro &quot;e:book&quot;&gt;
  &lt;html&gt;
    &lt;head&gt;
      &lt;title&gt;&lt;#recurse .node[&quot;e:title&quot;]&gt;&lt;/title&gt;
    &lt;/head&gt;
    &lt;body&gt;
      &lt;h1&gt;&lt;#recurse .node[&quot;e:title&quot;]&gt;&lt;/h1&gt;
      &lt;#recurse&gt;
    &lt;/body&gt;
  &lt;/html&gt;
&lt;/#macro&gt;

&lt;#macro &quot;e:chapter&quot;&gt;
  &lt;h2&gt;&lt;#recurse .node[&quot;e:title&quot;]&gt;&lt;/h2&gt;
  &lt;#recurse&gt;
&lt;/#macro&gt;

&lt;#macro &quot;e:para&quot;&gt;
  &lt;p&gt;&lt;#recurse&gt;
&lt;/#macro&gt;

&lt;#macro &quot;e:title&quot;&gt;
  &lt;#--
    We have handled this element imperatively,
    so we do nothing here.
  --&gt;
&lt;/#macro&gt;

&lt;#macro @text&gt;${.node?html}&lt;/#macro&gt;</code></pre>
<p>Or, you can define a default XML namespace, and then the further part of the template remains the same as in the original XML namespace free example:</p>
<pre><code>&lt;#ftl ns_prefixes={&quot;D&quot;:&quot;http://example.com/ebook&quot;}&gt;

&lt;#recurse doc&gt;

&lt;#macro book&gt;
...</code></pre>
<p>But in this case don't forge that in XPath expressions (we didn't used any in the example) the default XML namespace must be accessed with an explicit <code>D:</code> since names without prefix always refer to nodes with no XML namespace in XPath. Also note that with the same logic as with imperative XML processing, the name of handlers for elements that has no XML namespace is <code>N:elementName</code> if (and only if) there is a default XML namespace. However, for nodes that are not of type element (such as text nodes), you never use the <code>N</code> prefix in the handler name, because those nodes are free of the idea of XML namespaces. So for example, the handler for text nodes is always just <code>@text</code>.</p>
<p>For more detailed information, please read <a href="#ref_directive_visit">the reference of <code>recurse</code> and <code>visit</code></a> directives.</p>
<h1 id="app_faq">FAQ</h1>
FAQ
<p><strong>Q:</strong> JSP versus FreeMarker?</p>
JSP
<p><strong>A:</strong> We compare FreeMarker with the JSP 2.0 + JSTL combo here.</p>
<p>FreeMarker Pros:</p>
<ul>
<li><p>FreeMarker is not tied to Servlets or networking/Web; it is just a class library to generate text output by merging a template with Java objects (the data-model). You can execute templates anywhere and anytime; no HTTP request forwarding or similar tricks needed, no Servlet environment needed at all. Because of this you can easily integrate it into any system.</p></li>
<li><p>Terser syntax. Consider this JSP (assuming <code>&lt;%@ taglib prefix=&quot;c&quot;
                uri=&quot;http://java.sun.com/jsp/jstl/core&quot;
                %&gt;</code>):</p>
<pre><code>&lt;c:if test=&quot;${t}&quot;&gt;
  True
&lt;/c:if&gt;

&lt;c:choose&gt;
  &lt;c:when test=&quot;${n == 123}&quot;&gt;
      Do this
  &lt;/c:when&gt;
  &lt;c:otherwise&gt;
      Do that
  &lt;/c:otherwise&gt;
&lt;/c:choose&gt;

&lt;c:forEach var=&quot;i&quot; items=&quot;${ls}&quot;&gt;
- ${i}
&lt;/c:forEach&gt;</code></pre>
<p>and the equivalent FTL:</p>
<pre><code>&lt;#if t&gt;
  True
&lt;/#if&gt;

&lt;#if n == 123&gt;
  Do this
&lt;#else&gt;
  Do that
&lt;/#if&gt;

&lt;#list ls as i&gt;
- ${i}
&lt;/#list&gt;</code></pre></li>
<li><p>No servlet specific scopes and other highly technical things in templates (unless, of course, you expose them into the data-model deliberately). It was made for MVC from the beginning, it focuses only on the presentation.</p></li>
<li><p>You can load the templates from anywhere; from the class path, from a data-base, etc.</p></li>
<li><p>Locale-sensitive number and date formatting by default. When you output for a human audience, all you need to do is just write <code>${x}</code> rather than <code>&lt;fmt:formatNumber value=&quot;${x}&quot;
                /&gt;</code>.</p></li>
<li><p>Easier to define ad-hoc macros and functions.</p></li>
<li><p>No sweeping errors under the carpet. Missing variables and <code>null</code>-s will not silently default to <code>0</code>/<code>false</code>/empty-string, but cause error. <a href="#faq_picky_about_missing_vars">See more about this here...</a></p></li>
<li><p>“Object wrapping”. This lets you show the objects to templates in a customized, presentation oriented way (e.g. <a href="#xgui_imperative_learn">see here</a> how a W3C DOM nodes can be seen by templates using this technology.)</p></li>
<li><p>Macros and functions are just variables, so they can be easily passed around as parameter values, put into the data-model, etc., just like any other values.</p></li>
<li><p>Virtually unnoticeable delay when visiting a page for the first time (or after it was changed), because no expensive compilation happens.</p></li>
</ul>
<p>FreeMarker Cons:</p>
<ul>
<li><p>Not a “standard”. There are fewer tools and IDE integrations, fewer developers knows it and there's much less industry support in general. (However, most JSP tag libraries can work in FreeMarker templates with the proper setup, unless they are base on <code>.tag</code> files.)</p></li>
<li><p>Its syntax doesn't follow the HTML/XML rules apart from some visual similarity, which is confusing for new users (it's the price of the terseness). JSP doesn't follow it either, but it's closer to it.</p></li>
<li><p>Since macros and functions are just variables, incorrect directive and parameter names and missing required parameters can be detected only on runtime.</p></li>
<li><p>Doesn't work with JSF. (It could work technically, but nobody has implemented that yet.)</p></li>
</ul>
<p>You may read this if you are considering replacing JSP with FreeMarker in an existing application or in a legacy framework that only supports JSP: <a href="#pgui_misc_servlet_model2">section_title</a></p>
<p><strong>Q:</strong> Why is FreeMarker so picky about <code>null</code>-s and missing variables, and what to do with it?</p>
<p><strong>A:</strong> To recapitulate what's this entry is about: FreeMarker by default treats an attempt to access a non-existent variable or a <code>null</code> value (<a href="#faq_null">this two is the same for FreeMarker</a>) as error, which aborts the template execution.</p>
<p>First of all, you should understand the reason of being picky. Most scripting languages and template languages are rather forgiving with missing variables (and with <code>null</code>-s), and they usually treat them as empty string and/or 0 and/or logical false. This behavior has several problems:</p>
<ul>
<li><p>It potentially hides accidental mistakes, like a typo in a variable name, or when the template author refers to a variable that the programmer doesn't put into the data-model for that template, or for which the programmer uses a different name. Humans are prone to do such mistakes, while computers are not, so missing this opportunity that the template engine can show these errors is a bad business. Even if you very carefully check the output of the templates during development, it is easy to look over mistakes like <code>&lt;#if hasWarnigs&gt;print warnings
                here...&lt;/#if&gt;</code>, which would then silently never print the warnings, since you have mistyped the variable name (have you noticed it?). Also think about maintenance, when you later modify your application; probably you will not re-check templates (many applications has hundreds of them) that carefully each time, for all possible scenarios. Unit tests typically doesn't cover web page content very good either (if you have them at all...); they mostly only check certain manually set patterns in the web page, so they will often gloss though changes that are actually bugs. But if the page fails with exception, that's something human testers will notice and unit test will notice (as the whole page will fail), and in production the maintainers will notice (assuming somebody check error logs).</p></li>
<li><p>Makes dangerous assumptions. The script language or template engine knows nothing about the application domain, so when it decides the value of something that it doesn't know to be 0/false, it is a quite irresponsible and arbitrary thing. Just because it's not know what's your current balance at your bank, can we just say it's $0? Just because it is not known if a patient has penicillin allergy, can we just say he/she doesn't have it? Just consider the implications of such mistakes. Showing an error page is often better than showing incorrect information that looks good, leading to bad decisions on the user side.</p></li>
</ul>
<p>Being not picky is mostly sweeping under the carpet in this case (not facing the problems), which of course most people feels more convenient, but still, we believe that in most cases being strict will save your time and increase your software quality on the long run.</p>
<p>On the other hand, we recognize that there are cases where you don't want FreeMarker to be that picky for good reason, and there is solution for them:</p>
<ul>
<li><p>It's often normal that your data-model contains <code>null</code>-s or have optional variables. In such cases use <a href="#dgui_template_exp_missing">these operators</a>. If you use them too often, try to rethink your data-model, because depending on them too much won't just make the templates too verbose, but increases the probability of hiding errors and printing arbitrary incorrect output (for the reasons described earlier).</p></li>
<li><p>In some application you may rather want to show an incomplete/damaged page than an error page. In this case you can <a href="#pgui_config_errorhandling">use another error handler</a> than the default one. A custom error handler can skip the problematic part, or show an error indicator there, instead of aborting the whole page rendering. Note, however, that although the error handlers don't give arbitrary default values to variables, for pages that show critical information it's maybe still better to show an error page.</p></li>
<li><p>If the pages contain parts that aren't critically important (like some side bars), another feature you may interested in is <a href="#ref_directive_attempt">the <code>attempt</code>/<code>recover</code> directives</a>.</p></li>
</ul>
<p><strong>Q:</strong> Why does FreeMarker print the numbers with strange formatting (as 1,000,000 or 1 000 000 instead of 1000000)?</p>
<p><strong>A:</strong> FreeMarker uses the locale-sensitive number formatting capability of the Java platform. The default number format for your locale may uses grouping or other formatting. If you don't want that, you have to override the number format suggested by the Java platform with the <code>number_format</code> <a href="#pgui_config_settings">FreeMarker setting</a>. For example:</p>
<pre><code>cfg.setNumberFormat(&quot;0.######&quot;);  // now it will print 1000000
// where cfg is a freemarker.template.Configuration object</code></pre>
<p>Note however than humans often find it hard to read big numbers without grouping separator. So in general it is recommended to keep them, and in cases where the numbers are for ''computer audience'' (which is confused on the grouping separators), use the <a href="#ref_builtin_c"><code>c</code> built-in</a>. For example:</p>
<pre><code>&lt;a href=&quot;/shop/productdetails?id=${product.id?c}&quot;&gt;Details...&lt;/a&gt;</code></pre>
<p>For computer audience you need <code>?c</code> anyway, as the decimal separators can also wary depending on the locale.</p>
<p><strong>Q:</strong> Why does FreeMarker print bad decimal and/or grouping separator symbol (as 3.14 instead of 3,14)?</p>
<p><strong>A:</strong> Different countries use different decimal/grouping separator symbols. If you see incorrect symbols, then probably your locale is not set properly. Set the default locale of the JVM or override the default locale with the <code>locale</code> <a href="#pgui_config_settings">FreeMarker setting</a>. For example:</p>
<pre><code>cfg.setLocale(java.util.Locale.ITALY);
// where cfg is a freemarker.template.Configuration object</code></pre>
<p>However, sometimes you want to output a number not for human audience, but for “computer audience” (like you want to print a size in CSS), in which case you must use dot as decimal separator, regardless of the locale (language) of the page. For that use the <a href="#ref_builtin_c"><code>c</code> built-in</a>, for example:</p>
<pre><code>font-size: ${fontSize?c}pt;</code></pre>
<p><strong>Q:</strong> Why does FreeMarker give an error when I try to print a boolean like <code>${aBoolean}</code>, and how to fix it?</p>
<p><strong>A:</strong> Unlike numbers, booleans has no commonly accepted format, not even a common format within the same page. Like when you show on a HTML page if a product is washable, you will hardly want to show for the visitor &quot;Washable: true&quot;, but rather &quot;Washable: yes&quot;. So we force the template author (by <code>${washable}</code> causing error) to find out with his human knowledge how the boolean value should be shown at the given place. The common way of formatting a boolean is like <code>${washable?string(&quot;yes&quot;,
            &quot;no&quot;)}</code>, <code>${caching?string(&quot;Enabled&quot;,
            &quot;Disabled&quot;)}</code>, <code>${heating?string(&quot;on&quot;,
            &quot;off&quot;)}</code>, etc.</p>
<p>However, there are two cases where this gets impractical:</p>
<ul>
<li><p>When printing boolean to generate computer language output, and hence you want <code>true</code>/<code>false</code>, use <code>${someBoolean?c}</code>. (This requires at least FreeMarker 2.3.20. Before that, the common practice was writing <code>${someBoolean?string}</code>, however that's dangerous because its output depends on the current boolean format setting, whose default is <code>&quot;true&quot;</code>/<code>&quot;false&quot;</code>.)</p></li>
<li><p>When you have format most of the booleans on the same way. In this case you can set the <code>boolean_format</code> setting (<code>Configuration.setBooleanFormat</code>) to reflect that, and then since FreeMarker 2.3.20 you can just write <code>${someBoolean}</code>. (Note that this doesn't work for <code>true</code>/<code>false</code> though - you have to use <code>?c</code> there.)</p></li>
</ul>
<p><strong>Q:</strong> FreeMarker can't find my templates (<code>TemplateNotFoundException</code> or <code>FileNotFoundException</code>, “Template not found” error message)</p>
<p><strong>A:</strong> First of all, you should know that FreeMarker doesn't load templates from file system paths directly. Instead, it uses a simple virtual file system that might reads non-filesystem resources (templates from inside jar-s, from inside a database table, etc.). What that virtual file is decided by a configuration setting, <code>Configuration.setTemplateLoader(TemplateLoader)</code>. Even if the <code>TemplateLoader</code> your are using maps to the file system, it will have a base directory that contains all the templates, and that will be the root of your virtual file system that you can't reach out from (i.e., absolute paths will be still relative to the virtual file system root).</p>
<p>Tips to solve the problem:</p>
<ul>
<li><p>If you are the one who configure FreeMarker, be sure that you set a proper <code>TemplateLoader</code>.</p></li>
<li><p>Otherwise see if the template-not-found error's message contains the description of the <code>TemplateLoader</code> used. If it doesn't, you are using an old FreeMarker version, so update it. Getting <code>FileNotFoundException</code> instead of <code>TemplateNotFoundException</code> is also a sign of that, and so you will get less helpful error messages. (If the <code>TemplateLoader</code> in the error message is like <code>foo.SomeTemplateLoader@64f6106c</code> and so doesn't show some relevant parameters, you may should ask the author to define a nicer <code>toString()</code>.)</p></li>
<li><p>A frequent mistake is using a <code>FileTemplateLoader</code> for a Servlet-based web application, instead of a <code>WebappTemplateLoader</code>. It may works in one environment, but not in another, as the Servlet specification makes no promises about your resources being accessible as plain files, not even when the <code>war</code> file is extracted.</p></li>
<li><p>Know that when you are including/importing a template from another template, if you don't start the template name with <code>/</code>, it will be interpreted relatively to the directory of the including template. The error message contains the full (resolved) name, so you should notice this there.</p></li>
<li><p>Check that you aren't using <code>\</code> (backslash) instead of <code>/</code> (slash). (FreeMarker 2.3.22 and later will warn you about that in the error message.)</p></li>
<li><p>As a last resort, turn on debug level logging (in the logging framework that you are using) for the category <code>freemarker.cache</code>, to see more of what's going on.</p></li>
</ul>
<p><strong>Q:</strong> The documentation writes about feature X, but it seems that FreeMarker doesn't know that, or it behaves in a different way as documented, or a bug that was supposedly fixed is still present.</p>
<p><strong>A:</strong> Are you sure that you are using the documentation written for the same version of FreeMarker that you actually use? Especially, note that our online documentation is for the latest stable FreeMarker release. You may use an older release; update it.</p>
<p>Are you sure that the Java class loader finds the same <code>freemarker.jar</code> that you expect to use? Maybe there is an older version of <code>freemarker.jar</code> around, which shadows the never. To check this, try to print the version number in a template with <code>${.version}</code>. (If it dies with “Unknown built-in variable: version” error message, then you use a very, very old release.).</p>
<p>If you suspect that the problem is that you have multiple <code>freemarker.jar</code>-s, the typical culprit is that some module has a Maven or Ivy dependency with the old <code>freemarker</code> group ID, as opposed to the more modern <code>org.freemarker</code> group ID. Because of the different group ID-s these aren't seen as conflicting artifacts by Maven or Ivy, and so both version gets in. In this case you have to exclude the <code>freemarker</code> dependency.</p>
<p>If you think that the documentation or FreeMarker is wrong, please report it using the bug tracker, or the mailing list. Thank you!</p>
<p><strong>Q:</strong> The <code>&lt;</code> and <code>&gt;</code> of FreeMarker tags confuses my editor or the XML parser. What to do?</p>
<p><strong>A:</strong> Starting from FreeMarker 2.3.4 you can use <code>[</code> and <code>]</code> instead of <code>&lt;</code> and <code>&gt;</code>. For more details <a href="#dgui_misc_alternativesyntax">read this...</a></p>
<p><strong>Q:</strong> What are the legal variable names?</p>
variables
names
<p><strong>A:</strong> FreeMarker has no limitations regarding the characters used in variable names, nor regarding the length of the variable names, but for your convenience try to chose variable names that can be used with the simple variable reference expressions (see it <a href="#dgui_template_exp_var_toplevel">here</a>). If you have to choose a more extreme variable name, that's not a big problem either: <a href="#faq_strange_variable_name">see here</a>.</p>
<p><strong>Q:</strong> How can I use variable names (macro name, parameter name) that contain minus sign (<code>-</code>), colon (<code>:</code>), dot (<code>.</code>), or or other special characters?</p>
<p><strong>A:</strong> If you have a variable with strange name like “foo-bar”, FreeMarker will misunderstand what you mean if you just use it like in <code>${foo-bar}</code>. In this case, it will believe that you want to subtract the value of <code>bar</code> from <code>foo</code>. This FAQ entry explains how to handle situations like this.</p>
<p>First of all it should be clear that these are just syntactical problems, as otherwise FreeMarker has no limitations regarding the characters used in variable names, nor regarding the length of them.</p>
<p>If the special character is one of minus sign (<code>-</code>, UCS 0x2D) or dot (<code>.</code>, UCS 0x2E) or colon (<code>:</code>, UCS 0x3A), then all you have to do is putting a backslash (<code>\</code>) before these characters, like in <code>foo\-bar</code> (since FreeMarker 2.3.22). Then FreeMarker will know that you didn't mean the operator with the same symbol. This works everywhere where you specify unquoted identifiers, like for macro and function names, parameter names, and all kind of variable references in general. (Note that these escapes only work in identifiers, not in string literals.)</p>
<p>When the special character is not one of minus sign, dot, or colon, then it gets trickier. Let's say the problematic variable name is “a+b”. Then:</p>
<ul>
<li><p>If you want to read the variable: If it's a subvariable of something, you can write <code>something[&quot;a+b&quot;]</code> (remember, <code>something.x</code> is equivalent to <code>something[&quot;x&quot;])</code>. If it's a top-level variable, those are accessible through the special hash variable ,<code>.vars</code>, so you can write <code>.vars[&quot;a+b&quot;]</code>. Naturally, this trick works with macro and function invocations too: <code>&lt;@.vars[&quot;a+b&quot;]/&gt;</code>, <code>.vars[&quot;a+b&quot;](1, 2)</code>.</p></li>
<li><p>If you want to create or modify the variable: All directives that let you create or modify a variable (such as <code>assign</code>, <code>local</code>, <code>global</code>, <code>macro</code>, <code>function</code>, etc.) allows the quotation of the destination variable name. For example, <code>&lt;#assign
                foo = 1&gt;</code> is the same as <code>&lt;#assign
                &quot;foo&quot; = 1&gt;</code>. So you can write things like <code>&lt;#assign &quot;a+b&quot; = 1&gt;</code> and <code>&lt;#macro &quot;a+b&quot;&gt;</code>.</p></li>
<li><p>Unfortunately, you can't use such a variable name (that contains special characters other than <code>-</code>, <code>.</code> and <code>:</code>) as macro parameter name.</p></li>
</ul>
<p><strong>Q:</strong> Why do I get &quot;java.lang.IllegalArgumentException: argument type mismatch&quot; when I try to use X JSP custom tag?</p>
<p><strong>A:</strong> Fist of all, update FreeMarker, because 2.3.22 and later gives a much more helpful error message, that pretty much answers the question. Anyway, the reason is as follows. On JSP pages you quote all parameter (attribute) values, it does not mater if the type of the parameter is string or boolean or number. But since custom tags are accessible in FTL templates as plain user-defined FTL directives, you have to use the FTL syntax rules inside the custom tags, not the JSP rules. Thus, according to FTL rules, you must not quote boolean and numerical parameter values, or they are interpreted as string values, and this will cause a type mismatch error when FreeMarker tries to pass the value to the custom tag that expects non-string value.</p>
<p>For example, the <code>flush</code> parameter to Struts Tiles <code>insert</code> tag is boolean. In JSP the correct syntax was:</p>
<pre><code>&lt;tiles:insert page=&quot;/layout.jsp&quot; flush=&quot;true&quot;/&gt;
...</code></pre>
<p>but in FTL you should write:</p>
<pre><code>&lt;@tiles.insert page=&quot;/layout.ftl&quot; flush=true/&gt;
...</code></pre>
<p>Also, for similar reasons, this is wrong:</p>
<pre><code>&lt;tiles:insert page=&quot;/layout.jsp&quot; flush=&quot;${needFlushing}&quot;/&gt;
...</code></pre>
<p>and you should write:</p>
<pre><code>&lt;tiles:insert page=&quot;/layout.jsp&quot; flush=needFlushing/&gt;
...</code></pre>
<p>(Not <code>flush=${needFlushing}</code>!)</p>
<p><strong>Q:</strong> How to include other resources in a way as <code>jsp:include</code> does it?</p>
<p><strong>A:</strong> Not with <code>&lt;#include ...&gt;</code>, as that just includes another FreeMarker template without involving the Servlet container.</p>
<p>Since the inclusion method you look for is Servlet-related, and pure FreeMarker is unaware of Servlets or even HTTP, it's the Web Application Framework that decides if you can do this and if so how. For example, in Struts 2 you can do this like this:</p>
<pre><code>&lt;@s.include value=&quot;/WEB-INF/just-an-example.jspf&quot; /&gt;</code></pre>
<p>If the FreeMarker support of the Web Application Framework is based on <code>freemarker.ext.servlet.FreemarkerServlet</code>, then you can also do this (since FreeMarker 2.3.15):</p>
<pre><code>&lt;@include_page path=&quot;/WEB-INF/just-an-example.jspf&quot; /&gt;</code></pre>
<p>but if the Web Application Framework provides its own solution, then you may prefer that, after all it may does something special.</p>
<p>For more information about <code>include_page</code> <a href="#pgui_misc_servlet_include">read this...</a></p>
<p><strong>Q:</strong> How can I get the parameters to my plain-Java-method/<code>TemplateMethodModelEx</code>/<code>TemplateTransformModel</code>/<code>TemplateDirectiveModel</code> implementation as plain <code>java.lang.*</code>/<code>java.util.*</code> objects?</p>
<p><strong>A:</strong> Unfortunately, there is no simple general-purpose solution for this problem. The problem is that FreeMarker object wrapping is very flexible, which is good when you access variables from templates, but makes unwrapping on the Java side a tricky question. For example, it is possible to wrap a non-<code>java.util.Map</code> object as <code>TemplateHashModel</code> (FTL hash variable). But then, it can't be unwrapped to <code>java.util.Map</code>, since there is no wrapped <code>java.util.Map</code> around at all.</p>
<p>So what to do then? Basically there are two cases:</p>
<ul>
<li><p>Directives and methods that are written for presentation purposes (like kind of “tools” for helping FreeMarker templates) should declare their arguments as <code>TemplateModel</code>-s and the more specific sub interfaces of that. After all, the object wrapping is about transforming the data-model to something that serves the purpose of the presentation layer, and these methods are part of the presentation layer. If you still need a plain Java type there, you may turn to the <code>ObjectWrapperAndUnwrapper</code> interface of the current <code>ObjectWrapper</code> (can be get with <code>Environment.getObjectWrapper()</code>).</p></li>
<li><p>Methods that are not for presentation related tasks (but for business logic and like) should be implemented as plain Java methods, and should not use any FreeMarker specific classes at all, since according the MVC paradigm they must be independent of the presentation technology (FreeMarker). If such a method is called from a template, then it is the responsibility of the <a href="#pgui_datamodel_objectWrapper">object wrapper</a> to ensure the conversion of the arguments to the proper type. If you use the <a href="#pgui_datamodel_defaultObjectWrapper"><code>DefaultObjectWrapper</code></a> or the <a href="#pgui_misc_beanwrapper"><code>BeansWrapper</code></a> then this will happen automatically. For <code>DefaultObjectWrapper</code>, this mechanism works much better, if you <a href="#topic.defaultObjectWrapperIcI">set its <code>incompatibleImprovements</code> to 2.3.22</a>.</p></li>
</ul>
<p><strong>Q:</strong> Why I can't use non-string key in the <code>myMap[myKey]</code> expression? And what to do now?</p>
hash
key type
<p><strong>A:</strong> The “hash” type of the FreeMarker Template Language (FTL) is not the same as Java's <code>Map</code>. FTL's hash is an associative array too, but it uses string keys exclusively. This is because it was introduced for sub variables (as <code>password</code> in <code>user.password</code>, which is the same as <code>user[&quot;password&quot;]</code>), and variable names are strings.</p>
<p>If you only need to list the key-value pairs of a <code>Map</code>, you can just write something like <code>&lt;#list myMap as k, v&gt;${k}:
            ${v}&lt;/#list&gt;</code> (see more about <a href="#ref.directive.list">the <code>list directive</code> here</a>). This enumerates the <code>Map</code> entries, and supports non-string keys. This requires FreeMarker 2.3.25 or later. (If for some reason you can't upgrade to 2.3.25, you can use the Java API of <code>Map</code> instead, like <code>&lt;#list myMap?api.entrySet() as kvp&gt;${kvp.key}:
            ${kvp.value}&lt;/#list&gt;</code>.)</p>
<p>If you need to do more than listing, you will have to turn to the Java API of the <code>Map</code>. You can do it like this: <code>myMap?api.get(nonStringKey)</code>. However, for <code>?api</code> to be enabled, you may need to configure FreeMarker a bit (<a href="#ref_buitin_api_and_has_api">see more here</a>).</p>
<p>Note that as Java's <code>Map</code> is particular about the exact class of the key, at least for numerical keys calculated inside the templates you will have to cast them to the proper Java type, otherwise the item will not be found. For example if you use <code>Integer</code> keys in a Map, then you should write <code>${myMap.get(numKey?int)}</code>. This is because of FTL's deliberately simplified type system has only a single numerical type, while Java distinguishes a lot of numerical types. Note that the casting is not needed when the key value comes directly from the data-model (i.e., you didn't modified its value with arithmetical calculations in the template), including the case when it's the return value of a method, and it was of the proper class before wrapping, because then the result of the unwrapping will be of the original type.</p>
<p><strong>Q:</strong> When I list the contents of a map (a hash) with <code>?keys</code>/<code>?values</code>, I get the <code>java.util.Map</code> methods mixed with the real map entries. Of course, I only want to get the map entries.</p>
<p><strong>A:</strong> Certainly you are using pure <code>BeansWrapper</code> as your object wrapper (instead of the default, <code>DefaultObjectWrapper</code>), or a custom subclass of it, and the <code>simpleMapWrapper</code> property of that is left to <code>false</code>. Unfortunately, that's the default of <code>BeansWrapper</code> (for backward compatibility), so you have to explicitly set it to <code>true</code> where you instantiate it. Also, at least since 2.3.22, applications should just use <code>DefaultObjectWrapper</code> (with <a href="#topic.defaultObjectWrapperIcI">its <code>incompatibleImprovements</code> set to at least 2.3.22</a> - that's especially important if you are switching from pure <code>BeansWrapper</code>), which never had this problem.</p>
<p><strong>Q:</strong> How can I modify sequences (lists) and hashes (maps) in FreeMarker templates?</p>
modify hashes
modify sequences
sequence
modify
hash
modify
<p><strong>A:</strong> First of all, you may don't want to modify the sequence/hash, just concatenate (add) two or more of them, which results in a new sequence/hash, rather than modifying an existing one. In this case use the <a href="#dgui_template_exp_sequenceop_cat">sequence concatenation</a> and <a href="#dgui_template_exp_hashop_cat">hash concatenation operators</a>. Also, you may use the <a href="#dgui_template_exp_seqenceop_slice">subsequence operator</a> instead of removing sequence items. However, be aware of the performance implications: these operations are fast, but the hashes/sequences that are the result of many subsequent applications of these operations (i.e., when you use the result of the operation as the input of yet another operation, and so on) will be slow to read.</p>
<p>Now if you still want to modify sequences/hashes, then read on...</p>
<p>The FreeMarkes Template Language doesn't support the modification of sequences/hashes. It's for displaying already calculated things, not for calculating data. Keep templates simple. But don't give it up, you will see some advices and tricks bellow.</p>
<p>The best is if you can divide the work between the data-model builder program and the template so that the template doesn't need to modify sequences/hashes. Maybe if you rethink your data-model, you will realize this is possible. But, seldom there are cases where you need to modify sequences/hashes for some complex but purely presentation related algorithms. It seldom happens, so think twice whether that calculation (or parts of it) rather belongs to the data-model domain than to the presentation domain. Let's assume you are sure it belongs to the presentation domain. For example, you want to display a keyword index on some very smart way, whose algorithm need you to create and write some sequence variables. Then you should do something like this (ugly situations has ugly solutions...):</p>
<pre><code>&lt;#assign caculatedResults =
    &#39;com.example.foo.SmartKeywordIndexHelper&#39;?new().calculate(keywords)&gt;
&lt;#-- some simple algorithms comes here, like: --&gt;
&lt;ul&gt;
  &lt;#list caculatedResults as kw&gt;
    &lt;li&gt;&lt;a href=&quot;${kw.link}&quot;&gt;${kw.word}&lt;/a&gt;
  &lt;/#list&gt;
&lt;/ul&gt;</code></pre>
<p>That is, you move out the complex part of the presentation task from the template into Java code. Note that it doesn't affect the data-model, so the presentation is still kept separated from other the other application logic. Of course the drawback is that for this the template author will need the help of a Java programmer, but for complex algorithms that's probably needed anyway.</p>
<p>Now, if you still say you need to modify sequences/hashes directly with the FreeMarker template, here are some solutions, but please read the warning after them:</p>
<ul>
<li><p>You can access the Java API of a <code>java.util.Map</code> with the help of the <code>api</code> built-in, like <code>myMap?api.put(11, &quot;eleven&quot;)</code>. You will need to get a <code>Map</code> from somewhere though (an FTL hash literal like <code>{}</code> won't suffice, as it's read only and doesn't support <code>api</code> either). For example, you could expose a Java method or <code>TemplateMethodModelEx</code> to the template that returns a <code>new LinkeHashMap()</code>, so you can do <code>&lt;#assign myMap =
                utils.newLinkedHashMap()&gt;</code>.</p></li>
<li><p>You can write a <code>TemplateMethodModelEx</code> and <code>TemplateDirectiveModel</code> implementation that can modify certain types of sequences/hashes. Just certain types, because <code>TemplateSequenceModel</code> and <code>TemplateHashModel</code> doesn't have methods for modification, so you will need the sequence or hash to implement some additional methods. An example of this solution can be seen in FMPP. It allows you to do things like this (<code>pp</code> stores the services provided by FMPP for templates):</p>
<pre><code>&lt;#assign a = pp.newWritableSequence()&gt;
&lt;@pp.add seq=a value=&quot;red&quot; /&gt;</code></pre>
<p>The <code>pp.add</code> directive works only with sequences that were created with <code>pp.newWritableSequence()</code>. So for example the template author can't modify a sequence that comes from the data-model with this.</p></li>
<li><p>A sequence can have some methods/directives if you use a customized wrapper (so you can write something like <code>&lt;@myList.append foo /&gt;</code>).</p></li>
</ul>
<p>But beware, these solutions have a problem: The <a href="#dgui_template_exp_sequenceop_cat">sequence concatenation</a>, <a href="#dgui_template_exp_seqenceop_slice">sequence slice</a> operator (like <code>seq[5..10]</code>) and <code>?reverse</code> do not copy the original sequence, just wraps it (for efficiency), so the resulting sequence will change if the original sequence is changed later (an abnormal aliasing effect). The same problem exists with the result of <a href="#dgui_template_exp_hashop_cat">hash concatenation</a>; it just wraps the two hashes, so the resulting hash will magically change if you modify the hashes you have added earlier. As a work-around, after you did the above problematic operations, either be sure you will not modify the objects that were used as input, or create a copy of the result with a method provided by the solution described in above two points (e.g. in FMPP you could do <code>&lt;#assign b =
            pp.newWritableSequence(a[5..10])&gt;</code> and <code>&lt;#assign c = pp.newWritableHash(hashA +
            hashB)&gt;</code>). Of course this is easy to miss... so again, rather try to build the data-model so you will not need to modify collections, or use a presentation task helper class as was shown earlier.</p>
<p><strong>Q:</strong> What about <code>null</code> and the FreeMarker template language? null</p>
<p><strong>A:</strong> The FreeMarker template language doesn't know the Java language <code>null</code> at all. It doesn't have <code>null</code> keyword, and it can't test if something is <code>null</code> or not. When it technically faces with a <code>null</code>, it treats it exactly as a missing variable. For example, both if <code>x</code> is <code>null</code> in the data-model and if it's not present at all, <code>${x!'missing'}</code> will print “missing”, you can't tell the difference. Also, if for example you want to test if a Java method has returned <code>null</code>, just write something like <code>&lt;#if foo.bar()??&gt;</code>.</p>
<p>You may interested in the rationale behind this. From the viewpoint of the presentation layer a <code>null</code> and non-existent thing is almost always the same. The difference between this two is usually just a technical detail, which is rather the result of implementation details than of the application logic. That you can't compare something to <code>null</code> (unlike in Java); it doesn't make sense to compare something with <code>null</code> in a template, since the template language doesn't do identity comparison (like the Java <code>==</code> operator when you compare two objects) but the more common sense value comparison (like Java's <code>Object.equals(Object)</code>; that doesn't work with <code>null</code> either). And how could FreeMarker tell if something concrete equals with something that is missing and thus unknown? Or if two missing (unknown) things are equal? Of course these questions can't be answered.</p>
<p>There is at least one problem with this <code>null</code>-unaware approach. When you call a Java method from a template, you may want to pass a <code>null</code> value as argument (since the method was designed to be used in Java language, where the concept of <code>null</code> is known). In this case you can exploit a bug of FreeMarker (that we will not fix until we provide a correct solution for passing <code>null</code> values to a method): if you specify a missing variable as the argument, then it will not cause an error, but a <code>null</code> will be passed to the method instead. Like <code>foo.bar(nullArg)</code> will call the <code>bar</code> method with <code>null</code> as argument, assuming that there is no variable exists with “nullArg” name.</p>
<p><strong>Q:</strong> How can I use the output of a directive (macro) in expressions (as a parameter to another directive)?</p>
<p><strong>A:</strong> Capture the output into a variable with the <code>assign</code> or <code>local</code> directive. For example:</p>
<pre><code>&lt;#assign capturedOutput&gt;&lt;@outputSomething /&gt;&lt;/#assign&gt;
&lt;@otherDirective someParam=capturedOutput /&gt;</code></pre>
<p><strong>Q:</strong> Why do I have “?”-s in the output instead of character X?</p>
<p><strong>A:</strong> This is because the character that you want to print can't be represented with the <a href="#gloss.charset">charset</a> (encoding) used for the output stream, so the Java platform (not FreeMarker) substitutes the problematic character with question mark. In general you should use the same charset for the output as for the template (use the <code>getEncoding()</code> method of the template object), or which is even safer, you should always use UTF-8 charset for the output. The charset used for the output stream is not decided by FreeMarker, but by you, when you create the <code>Writer</code> that you pass to the <code>process</code> method of the template.</p>
<p>Example: Here I use UTF-8 charset in a servlet:</p>
<pre><code>...
resp.setContentType(&quot;text/html; charset=utf-8&quot;);
Writer out = resp.getWriter();
...
t.process(root, out);
...</code></pre>
<p>Note that the question marks (or other substitution characters) may be produced outside FreeMarker, in which case the above obviously will not help. For example a bad/missconfigured database connection or JDBC driver may bring the text already with substitution characters in it. HTML forms are another potential source of encoding problems. It's a good idea to print the numerical code of the characters of the string on various places, to see where the problem occurs first.</p>
<p>You can read more about charsets and FreeMarker <a href="#pgui_misc_charset">here...</a></p>
<p><strong>Q:</strong> How to retrieve values calculated in templates after template execution done?</p>
<p><strong>A:</strong> First of all, be sure your application is designed well: templates should display data, and almost never calculate data. If you are still sure you want to do it, read on...</p>
<p>When you use <code>&lt;#assign x = &quot;foo&quot;&gt;</code>, then you do not actually modify the data-model (since that is read-only, see: <a href="#pgui_misc_multithreading">section_title</a>), but create the <code>x</code> variable in the runtime <a href="#gloss.environment">environment</a> of the processing (see <a href="#pgui_misc_var">section_title</a>). The problem is that this runtime environment will be discarded when <code>Template.process</code> returns, as it was created for a single <code>Template.process</code> call:</p>
<pre><code>// internally an Environment will be created, and then discarded
myTemplate.process(root, out);</code></pre>
<p>To prevent this, you can do the below, which is equivalent with the above, except that you have chance to return the variables created in the template:</p>
<pre><code>Environment env = myTemplate.createProcessingEnvironment(root, out);
env.process();  // process the template
TemplateModel x = env.getVariable(&quot;x&quot;);  // get variable x</code></pre>
<p><strong>Q:</strong> How to assign to (or <code>#import</code> into) a dynamically constructed variable name (like to name that's stored in another variable)?</p>
<p><strong>A:</strong> If you really can't avoid doing that (you should, as it's confusing), you can solve that with constructing the appropriate FTL source code dynamically in a string, then using the <a href="#ref_builtin_interpret"><code>interpret</code> built-in</a>. For example, if you want to assign to the variable whose name is stored in the <code>varName</code> variable:</p>
<pre><code>&lt;@&quot;&lt;#assign ${varName}=&#39;example&#39;&gt;&quot;?interpret /&gt;</code></pre>
security
user-provided templates
<p>Can I allow users to upload templates and what are the security implications?</p>
<p><strong>A:</strong> In general you shouldn't allow that, unless those users are system administrators or other trusted personnel. Consider templates as part of the source code just like <code>*.java</code> files are. If you still want to allow users to upload templates, here are what to consider:</p>
<ul>
<li><p>Denial-of-Service (DoS) attacks: It's trivial to create templates that run practically forever (with a loop), or exhaust memory (by concatenating to a string in a loop). FreeMarker can't enforce CPU or memory usage limits, so this is something that has no solution on the FreeMarker-level.</p></li>
<li><p>Data-model and wrapping (<code>Configuration.setObjectWrapper</code>): The data-model might gives access to the public Java API of some objects that you have put into the data-model. By default, for objects that aren't instances of a the bunch of specially handler types (<code>String</code>, <code>Number</code>, <code>Boolean</code>, <code>Date</code>, <code>Map</code>, <code>List</code>, array, and a few others), their public Java API will be exposed. To avoid that, you have to construct the data-model so that it only exposes the things that are really necessary for the template. For that, you may want to use <code>SimpleObjectWrapper</code> (via <code>Configuration.setObjectWrapper</code> or the <code>object_wrapper</code> setting) and then create the data-model purely from <code>Map</code>-s, <code>List</code>-s, <code>Array</code>-s, <code>String</code>-s, <code>Number</code>-s, <code>Boolean</code>-s and <code>Date</code>-s. Or, you can implement your own extremely restrictive <code>ObjectWrapper</code>, which for example could expose your POJO-s safely.</p></li>
<li><p>Template-loader (<code>Configuration.setTemplateLoader</code>): Templates may load other templates by name (by path), like <code>&lt;#include &quot;../secret.txt&quot;&gt;</code>. To avoid loading sensitive data, you have to use a <code>TemplateLoader</code> that double-checks that the file to load is something that should be exposed. FreeMarker tries to prevent the loading of files outside the template root directory regardless of template loader, but depending on the underlying storage mechanism, exploits may exist that FreeMarker can't consider (like, just as an example, <code>~</code> jumps to the current user's home directory). Note that <code>freemarker.cache.FileTemplateLoader</code> checks the canonical paths, so that's maybe a good candidate for this task, yet, adding a file extension check (file must be <code>*.ftl</code>) is maybe a good idea.</p></li>
<li><p>The <code>new</code> built-in (<code>Configuration.setNewBuiltinClassResolver</code>, <code>Environment.setNewBuiltinClassResolver</code>): It's used in templates like <code>&quot;com.example.SomeClass&quot;?new()</code>, and is important for FTL libraries that are partially implemented in Java, but shouldn't be needed in normal templates. While <code>new</code> will not instantiate classes that are not <code>TemplateModel</code>-s, FreeMarker contains a <code>TemplateModel</code> class that can be used to create arbitrary Java objects. Other &quot;dangerous&quot; <code>TemplateModel</code>-s can exist in you class-path. Plus, even if a class doesn't implement <code>TemplateModel</code>, its static initialization will be run. To avoid these, you should use a <code>TemplateClassResolver</code> that restricts the accessible classes (possibly based on which template asks for them), such as <code>TemplateClassResolver.ALLOWS_NOTHING_RESOLVER</code>.</p></li>
</ul>
<p><strong>Q:</strong> How to implement a function or macro in Java Language instead of in the template language?</p>
<p><strong>A:</strong> It's not possible (yet), but something very similar is possible if you write a class that implements <code>freemarker.template.TemplateMethodModelEx</code> or <code>freemarker.template.TemplateDirectiveModel</code> respectively, and then where you were write <code>&lt;#function
            my
            ...&gt;...&lt;/#function&gt;</code> or <code>&lt;#macro my
            ...&gt;...&lt;/#macro&gt;</code> you write <code>&lt;#assign my = &quot;your.package.YourClass
            &quot;?</code><a href="#ref_builtin_new"><code>new</code></a><code>()&gt;</code> instead. Note that using the <code>assign</code> directive for this works because functions (and methods) and macros are just plain variables in FreeMarker. (For the same reason you could also put <code>TemplateMethodModelEx</code> or <code>TemplateDirectiveModel</code> instances into the data-model before calling the template, or into the shared variable map (see: <code>freemarker.template.Configuration.setSharedVariable(String,
            TemplateModel)</code>) when you initialize the application.)</p>
<p><strong>Q:</strong> In my Servlet based application, how do I show a nice error page instead of a stack trace when error occurs during template processing?</p>
<p><strong>A:</strong> First of all, use <code>RETHROW_HANDLER</code> instead of the default <code>DEBUG_HANDLER</code> (for more information about template exception handlers <a href="#pgui_config_errorhandling">read this...</a>). Now FreeMarker will not print anything to the output when an error occurs, so the control is in your hands. After you have caught the exception of <code>Template.process(...)</code> basically you can follow two strategies:</p>
<ul>
<li><p>Call <code>httpResp.isCommitted()</code>, and if that returns <code>false</code>, then you call <code>httpResp.reset()</code> and print a “nice error page” for the visitor. If the return value was <code>true</code>, then try to finish the page be printing something that makes clear for the visitor that the page generation was abruptly interrupted because of an error on the Web server. You may have to print a lot of redundant HTML end-tags and set colors and font size to ensure that the error message will be actually readable in the browser window (check the source code of the <code>HTML_DEBUG_HANDLER</code> in <code>src\freemarker\template\TemplateException.java</code> to see an example).</p></li>
<li><p>Use full page buffering. This means that the <code>Writer</code> doesn't send the output to the client progressively, but buffers the whole page in the memory. Since you provide the <code>Writer</code> instance for the <code>Template.process(...)</code> method, this is your responsibility, FreeMarker has nothing to do with it. For example, you may use a <code>StringWriter</code>, and if <code>Template.process(...)</code> returns by throwing an exception, then ignore the content accumulated by the <code>StringWriter</code>, and send an error page instead, otherwise you print the content of <code>StringWriter</code> to the output. With this method you surely don't have to deal with partially sent pages, but it can have negative performance implications depending on the characteristic of the pages (for example, the user will experience more response delay for a long page that is generated slowly, also the server will consume more RAM). Note that using a <code>StringWriter</code> is surely not the most efficient solution, as it often reallocates its buffer as the accumulated content grows.</p></li>
</ul>
<p><strong>Q:</strong> I'm using a visual HTML editor that mangles template tags. Will you change the template language syntax to accommodate my editor?</p>
<p><strong>A:</strong> We won't change the standard version, because a lot of templates depend on it.</p>
<p>Our view is that the editors that break template code are themselves broken. A good editor should ignore, not mangle, what it doesn't understand.</p>
<p>You maybe interested in that starting from FreeMarker 2.3.4 you can use <code>[</code> and <code>]</code> instead of <code>&lt;</code> and <code>&gt;</code>. For more details <a href="#dgui_misc_alternativesyntax">read this...</a></p>
<h1 id="app_versions">Version history</h1>
<h2 id="versions_2_3_27">2.3.27 (incubating at Apache)</h2>
<p>Release date: 2017-10-15 + release process</p>
<p><strong>This is a stable, final release.</strong> The “incubating” suffix is required by the Apache Software Foundation until the project becomes a fully accepted (graduated) Apache project.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New directive: <code>continue</code> (<a href="https://sourceforge.net/p/freemarker/feature-requests/79/">sf.net #79</a>, <a href="https://issues.apache.org/jira/browse/FREEMARKER-37">FREEMARKER-37</a>). This can be used inside the <code>list</code> directive to skip to the next iteration (similarly as in Java). <a href="#ref.directive.list.continue">See more...</a></p></li>
<li><p>Added alternative syntaxes for the <code>&amp;&amp;</code> (logical “and”) operator: <code>\and</code> and <code>&amp;amp;&amp;amp;</code>. These are to work around issues in applications where the template must be valid XML (<code>&amp;&amp;</code> is not valid XML/HTML, at most places), or where the template entered is stored after XML or HTML escaping. Note that lonely <code>&amp;amp;</code>, and <code>and</code> without <code>\</code> is not recognized for backward compatibility.</p></li>
<li><p>New built-in, <code>sequence</code> (<a href="https://issues.apache.org/jira/browse/FREEMARKER-73">FREEMARKER-73</a>). This can be used to work around situations where a listable value lacks some features that you need in the template (like it can't be listed twice, it can't tell its size, etc.), and you can't modify the data-model to fix the problem. <a href="#ref_builtin_sequence">See more...</a></p></li>
<li><p>Bug fixed (<a href="https://issues.apache.org/jira/browse/FREEMARKER-70">FREEMARKER-70</a>): The usage of loop variable built-ins, like <code>loopVar?index</code>, was disallowed by the parser inside interpolations that are inside a string literal expression (as in <code>&lt;#list 1..3 as
              loopVar&gt;${'${loopVar?index}'}&lt;/#list&gt;</code>), saying that there's no loop variable in scope with <code>loopVar</code> name.</p></li>
<li><p>Bug fixed: Comments were not allowed by the parser between the <code>switch</code> tag and the first <code>case</code> tag.</p></li>
<li><p>Bug fixed (<a href="https://issues.apache.org/jira/browse/FREEMARKER-71">FREEMARKER-71</a>): When using <code>exp?eval</code>, if the expression inside the evaluated string throws an exception, the cause exception of that exception was lost.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Added new configuration setting (<a href="https://issues.apache.org/jira/browse/FREEMARKER-48">FREEMARKER-48</a>), <code>wrap_unchecked_exceptions</code> (<code>Configurable.setWrapUncheckedExceptions(boolean)</code>). When this is <code>true</code>, unchecked exceptions thrown during evaluating an expression or during executing a custom directive will be wrapped into a <code>TemplateException</code>-s. The advantage of that is that thus the exception will include the location in the template (not just the Java stack trace), and the <code>TemplateExceptionHandler</code> will be invoked for it as well. When this setting is <code>false</code> (which is the default for backward compatibility), the the unchecked exception will bubble up and thrown by <code>Template.process</code>, just as in earlier versions. (Note that plain Java methods called from templates have always wrapped the thrown exception into <code>TemplateException</code>, regardless of this setting.)</p></li>
<li><p>Added new configuration setting, <code>attempt_exception_reporter</code> (<code>Configurable.setAttemptExceptionReporter(AttemptExceptionReporter)</code>), to allow the customization of how the exceptions handled (and thus suppressed) by the <a href="#ref.directive.attempt"><code>attempt</code> directive</a> are reported. The default <code>AttemptExceptionReporter</code> logs the exception as an error, just as it was in earlier versions, though now the error message will indicate that the exception was thrown inside an <code>attempt</code> directive block.</p></li>
<li><p>Added new <code>BeansWrapper</code> setting, <code>preferIndexedReadMethod</code>. This was added to address a Java 8 compatibility problem; see the bug fix entry below for more information.</p></li>
<li><p>When <a href="#pgui_config_incompatible_improvements_how_to_set"><code>incomplatible_improvements</code></a> is set to 2.3.27 (or higher), the following unchecked exceptions (but not their subclasses) will be wrapped into <code>TemplateException</code>-s when thrown during evaluating expressions or calling directives: <code>NullPointerException</code>, <code>ClassCastException</code>, <code>IndexOutOfBoundsException</code>, and <code>InvocationTargetException</code>. The goal of this is the same as of setting the <code>wrap_unchecked_exceptions</code> setting to <code>true</code> (see that earlier), but this is more backward compatible, as it avoids wrapping unchecked exceptions that some application is likely to catch specifically (like application-specific unchecked exceptions). (This is related to <a href="https://issues.apache.org/jira/browse/FREEMARKER-48">FREEMARKER-48</a>.)</p></li>
<li><p>Bug fixed: Starting from Java 8, when the same JavaBeans property has both non-indexed read method (like <code>String[] getFoos()</code>) and indexed read method (like <code>String getFoos(int index)</code>), <code>BeansWrapper</code> and <code>DefaultObjectWrapper</code> have mistakenly used the indexed read method to access the property. This is a problem because then the array size was unknown, and thus the property has suddenly become unlistable on Java 8 (that is, <code>&lt;#list myObject.foos as foo&gt;</code> fails). To enable the fix (where it will use the non-indexed read method), you should increase the value of the <code>incompatibleImprovements</code> constructor argument of the used <code>DefaultObjectWrapper</code> or <code>BeansWrapper</code> to 2.3.27. Note that if you leave the <code>object_wrapper</code> setting of the <code>Configuration</code> on its default, it's enough to increase the <a href="#pgui_config_incompatible_improvements_how_to_set"><code>incompatibleImprovements</code> setting</a> of the <code>Configuration</code> to 2.3.27, as that's inherited by the default <code>object_wrapper</code>. In case increasing the <code>incompatibleImprovements</code> is not an option (because of the other changes it brings), you can instead set the <code>preferIndexedReadMethod</code> property of the object wrapper to <code>false</code>. Note that this bug haven't surfaced before Java 8, as then <code>java.beans.Inrospector</code> has only exposed the non-indexed method when both kind of read method was present.</p></li>
<li><p>Bug fixed (affects Java 8 and later): Regardless of the value of the <code>preferIndexedReadMethod</code> setting (see previous point), if one of the indexed read method and the non-indexed read method is inaccessible (i.e., it's declared in a non-public type, and wasn't inherited by a public type), while the other read method is accessible, we will use the accessible one. Earlier, if there was an indexed read method but it was inaccessible, we have given up, and that bean property wasn't visible. Such properties will now be visible again, just as before Java 8. (Before Java 8 <code>java.beans.Inrospector</code> has only exposed the non-indexed read method in this case, so we didn't have this problem.)</p></li>
<li><p>Bug fixed: On OpenJDK 9 (but not on earlier versions, nor on Oracle Java 9 (tested with “build 9+181”)), when you try to use the DOM-based XML support (<code>freemarker.ext.dom.NodeModel</code>), unless you happen to have Apache Xalan in the class path, the <code>NodeModel</code> constructor will fail with <code>IllegalAccessError</code> because “java.xml does not export com.sun.org.apache.xml.internal.utils”. Note that while the exception is not thrown anymore in 2.3.27, FreeMarker can't use the XPath support included in OpenJDK 9, and so templates that try to use XPath expressions (like <code>doc['//foo']</code>) will still fail, <a href="#xgui_imperative_learn_xpath">unless 3rd party XPath support is present</a>.</p></li>
<li><p>Bug fixed: When the <code>TemplateExceptionHandler</code> suppresses (i.e., doesn't re-throw) an exception, the <a href="#ref.directive.attempt"><code>attempt</code> directive</a> won't log it anymore. (To be precise, the <code>AttemptExceptionReporter</code> won't be invoked for it anymore; the default one logs as error.)</p></li>
<li><p>Bug fixed (part of <a href="https://issues.apache.org/jira/browse/FREEMARKER-48">FREEMARKER-48</a>): When an arithmetic exception has occurred in an expression (typically division by zero), the template processing has thrown the <code>ArithmeticException</code> as is, without packaging it into a <code>TemplateException</code>. Thus, the error location in the template wasn't visible in the exception.</p></li>
<li><p>When logging error due to an error in an <a href="#ref.directive.attempt"><code>attempt</code> directive</a> block, the log message now indicates that the error was inside an <code>attempt</code> block.</p></li>
<li><p>Bug fixed (<a href="https://issues.apache.org/jira/browse/FREEMARKER-52">FREEMARKER-52</a>): When setting the <code>output_format</code> from <code>Properties</code> or the <code>setSetting(String,
              String)</code> API, the <code>XHTMLOutputFormat</code> abbreviation wasn't recognized (for example in a <code>.properties</code> file, <code>output_format=XHTMLOutputFormat</code> didn't work, only <code>output_format=freemarker.core.XHTMLOutputFormat()</code> did).</p></li>
<li><p>Bug fixed: When setting the <code>new_builtin_resolver</code> from <code>Properties</code> or the <code>setSetting(String,
              String)</code> API, it didn't recognize the camel case form of the <code>allowed_classes</code> and <code>trusted_templates</code> keywords, and throw exception for them. Now <code>allowedClasses</code> and <code>trustedTemplates</code> can be used as well.</p></li>
<li><p>Bug fixed: JSP support haven't tried using the thread context class-loader to load the TLD, instead, it has only used the defining class loader of the FreeMarker classes. This can cause problem in the rare case where <code>freemarker.jar</code> is installed on higher scope than the web application (like on the Servlet container level), but the web application contains the TLD.</p></li>
<li><p><code>Constants.EMPTY_HASH</code> and <code>GeneralPurposeNothing</code> (the value of <code>missingVar!</code>) now implements <code>TemplateHashModelEx2</code>. Earlier they were only a <code>TemplateHashModelEx</code>-s.</p></li>
<li><p>Added <code>Constants.EMPTY_KEY_VALUE_PAIR_ITERATOR</code></p></li>
<li><p>Somewhat less synchronization when accessing JavaBean properties (<a href="https://issues.apache.org/jira/browse/FREEMARKER-80">FREEMARKER-80</a>). The problem was that the <code>java.beans.PropertyDescriptor.getReadMethod</code> method is synchronized, and <code>freemarer.ext.beans.BeanModel</code> has called it each time a property was read. Now that method is only called when the class is first introspected.</p></li>
<li><p>Improved/fixed <code>TemplateTransformModel</code> behavior (this is a legacy interface that's not used much in user code):</p>
<ul>
<li><p><code>Writer
                  TemplateTransformModel.getWriter(Writer out, Map
                  args)</code> can now return the <code>out</code> parameter as is, as FreeMarker now recognizes that it's the same object and so won't call <code>close()</code> on it after the end tag.</p></li>
<li><p>When <a href="#pgui_config_incompatible_improvements_how_to_set"><code>incomplatible_improvements</code></a> is set to 2.3.27 (or higher), and the returned <code>Writer</code> implements <code>TransformControl</code>, exceptions that are used internally for flow control (for <code>&lt;#return&gt;</code>, <code>&lt;#break&gt;</code>, etc.) won't be passed to <code>TransformControl.onError(Throwable)</code> anymore. Earlier, if <code>onError</code> didn't rethrow the exception (though almost all implementation does), you couldn't use said directives inside the transformed block.</p></li>
</ul></li>
<li><p>Added workaround against “IllegalStateException: zip file closed” and “ZipException: ZipFile closed” issues (caused by bugs outside of FreeMarker) when loading resources included in the FreeMarker jar (see <code>freemarker.template.utility.ClassUtil.loadProperties</code>).</p></li>
</ul>
<h2 id="versions_2_3_26">2.3.26 (incubating at Apache)</h2>
<p>Release date: 2017-03-25</p>
<p><strong>This is a stable, final release.</strong> The “incubating” suffix is required by the Apache Software Foundation until the project becomes a fully accepted (graduated) Apache project.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Added <code>node?next_sibling</code> and <code>node?previous_sibling</code> to move sideways in a node trees (<a href="#ref_builtin_next_sibling">see reference...</a>). This works with XML DOM nodes, or with any custom <code>TemplateNodeModelEx</code> implementations.</p></li>
<li><p>Added new <code>@@</code> keys to XML DOM models: <code>@@next_sibling_element</code>, <code>@@previous_sibling_element</code>. These get the sibling node if that's an element, with the extra that they silently skip any whitespace text and comment and processing instruction between them. (See more about <code>@@</code> keys <a href="#xgui_imperative_formal">here...</a>)</p></li>
<li><p>Bug fixed (<a href="https://issues.apache.org/jira/browse/FREEMARKER-42">FREEMARKER-42</a>): <code>?first</code> now works with FTL collections (things that can be listed but doesn't support getting items by index), not only with sequences. The practical importance of this is that <code>?first</code> now always works on Java <code>Set</code>-s (which is useful for <code>Set</code>-s with well defined ordering), while earlier it has failed depending on the <code>object_wrapper</code> configuration setting.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p><a href="https://issues.apache.org/jira/browse/FREEMARKER-24">FREEMARKER-24</a>: Added workaround (not enabled by default) to expose Java 8 default methods (and the bean properties they define) to templates, despite that <code>java.beans.Introspector</code> (the official JavaBeans introspector) ignores them, at least as of JRE 1.8.0_66. To enable this workaround, either increase the value of the <code>incompatibleImprovements</code> constructor argument of <code>DefaultObjectWrapper</code> or <code>BeansWrapper</code> the used to 2.3.26, or set its <code>treatDefaultMethodsAsBeanMembers</code> setting to <code>true</code>. Note that if you leave the <code>object_wrapper</code> setting of the <code>Configuration</code> on its default, it's enough to increase the <code>incompatibleImprovements</code> setting of the <code>Configuration</code> to 2.3.26, as that's inherited by the default <code>object_wrapper</code>.</p></li>
<li><p>Added the <code>freemarker.template.TemplateNodeModelEx</code> interface which extends the <code>TemplateNodeModel</code> instance with two methods, <code>TemplateNodeModelEx
              getNextSibling()</code> and <code>TemplateNodeModelEx
              getPreviousSibling()</code> methods. This is required by <code>node?next_sibling</code> and <code>node?previous_sibling</code> in the templates. This new interface is already implemented by the standard W3C DOM node wrapper of FreeMarker.</p></li>
<li><p>Made <code>+</code> operator when adding two hashes significantly faster (be removing the overhead caused be throwing and then catching an exception).</p></li>
<li><p>Better error messages when someone tries to get an invalid <code>@@...</code> subvariable of an XML DOM node. (Now it's not issued by the XPath implementation, which just sees it as a syntactical error.)</p></li>
<li><p>Added <code>Configuration.isXxxExplictlySet</code> and <code>Configuration.unsetXxx</code> methods for the Configuration settings: <code>locale</code>, <code>time_zone</code>, <code>default_encoding</code>. (This can be utilized in frameworks to detect if the application has missed setting these. The backward compatible default values are often unwanted, as they are the default locale, time zone and file encoding of the Java environment.)</p></li>
<li><p>The <code>locale</code> and <code>default_encoding</code> configuration settings now supports the special <code>&quot;JVM default&quot;</code> value when set from Java <code>.properties</code> file, or via <code>Configuration.setSettings(Properties)</code>, or via the <code>#setting</code> directive. Earlier only the <code>time_zone</code> setting has supported this value.</p></li>
<li><p>Bug fixed: The OSGi <code>Bundle-RequiredExecutionEnvironment</code> entry in <code>META-INF/MANIFEST.MF</code> has incorrectly stated that the minimum required version is <code>J2SE-1.4</code>, while it's in fact <code>J2SE-1.5</code>. Also the highest utilized version was raised to <code>JavaSE-1.8</code>.</p></li>
<li><p>Bug fixed: If <a href="#pgui_config_incompatible_improvements_how_to_set">the <code>incompatible_improvements</code> setting</a> is set to 2.3.26 (or higher), <code>exp?interpret</code> always gets the parser-related settings from the template that it's called from. Earlier, sometimes it got those from the topmost (main) template instead. Similarly, the generated name of the template that <code>?interpret</code> creates will always refer to the template where's it's called from.</p></li>
<li><p>Bug fixed: <code>MultiTemplateLoader</code>, when it's in sticky mode (the default), and the <code>TemplateLoader</code> that was successfully used for a given name last time doesn't find the template now (let's call it the sticked <code>TemplateLoader</code>), and thus <code>MultiTemplateLoader</code> falls back to trying all the <code>TemplateLoader</code>-s in order, will now skip the sticked <code>TemplateLoader</code>, as that was already attempted in the same <code>MultiTemplateLoader.findTemplateSource</code> invocation.</p></li>
<li><p>Bug fixed: <code>NodeModel.mergeAdjacentText(Node)</code> didn't merged all adjacent text nodes, only pairs of adjacent text nodes. (Luckily this method is hardly ever used, and the more often used <code>NodeModel.simplify(Node)</code> was working correctly.)</p></li>
<li><p>Performance improvements in the static utility methods of <code>NodeModel</code>: <code>simplify(Node)</code>, <code>mergeAdjacentText(Node)</code>, <code>removeComments(Node)</code>, <code>removePIs(Node)</code>.</p></li>
<li><p>Added warning to the JavaDoc of <code>NodeModel.parse</code> methods to inform users about the possibility of XML External Entity (XXE) attacks if the source XML (not a template) comes from untrusted source. This is just an XML fact (i.e., that in an XML you can have external entities and they can be exploited), and has no much to do with FreeMarker. Also note that FreeMarker itself never calls <code>NodeModel.parse</code>; these are merely convenience methods that some applications directly call themselves to create a <code>NodeModel</code> from an XML file. As this method encapsulates the call to the platform XML parser, we thought it's better to point this risk out.</p></li>
<li><p><code>DefaultObjectWrapper</code>, only with its <code>incompatible_improvements</code> set to 2.3.26 (<a href="#topic.defaultObjectWrapperIcI">see how here...</a>), wraps <code>java.util.Enumeration</code>-s into <code>freemarker.template.DefaultEnumerationAdapter</code> (a new class) instead of into <code>freemarker.ext.beans.EnumerationModel</code> (as far as <code>useAdaptersForContainers</code> is <code>true</code>, which is the default). This adapter is cleaner than <code>EnumerationModel</code> as it only implements the minimally required FTL type, which avoids some ambiguous situations. (Note that Java API methods aren't exposed anymore as subvariables; if you really need them, you can use <code>?api</code>).</p></li>
<li><p><code>DefaultIteratorAdapter</code> now supports <code>?api</code>. It was an oversight that it didn't.</p></li>
<li><p><code>Configuration.setSetting(String,
              String)</code> and <code>setSettings</code> now allows <code>null</code> value for <code>template_loader</code> (because <code>Configuration.setTemplateLoader(null)</code> is also allowed for a while.).</p></li>
<li><p>The <code>freemarker.template.TemplateCollectionModelEx</code> interface and is not experimental anymore, so now it has backward compatibility guarantees. Note that the <code>TemplateCollectionModelEx.contains(TemplateModel)</code> method was removed from it.</p></li>
<li><p><code>freemarker.template.DefaultNonListCollectionAdapter</code> class is not experimental anymore, so now it has backward compatibility guarantees.</p></li>
<li><p><code>BeansWrapperConfiguration.classIntrospectorFactory</code> is not a protected field anymore, but a private one. Especially as the class of that field (<code>ClassIntrospectorBuilder</code>) was package private, it's pretty much sure that nobody depends on this field.</p></li>
<li><p>Various smaller code cleanups.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p><a href="https://issues.apache.org/jira/browse/FREEMARKER-17">FREEMARKER-17</a>: Removed the Servlet- and JSP-related <code>*.dtd</code> files to simplify licensing. We can operate without them as before, as validation with them was disabled earlier too. At this point, everything in the source code of the FreeMarker engine, and everything in the produced <code>freemarker.jar</code> was created inside the FreeMarker project.</p></li>
<li><p><a href="https://issues.apache.org/jira/browse/FREEMARKER-27">FREEMARKER-27</a>: Moved some content from the <code>NOTICES</code> files over to the <code>LICENSE</code> file, to follow the Apache Incubator guidelines closer.</p></li>
<li><p>Various smaller JavaDoc improvements.</p></li>
</ul>
<h2 id="versions_2_3_25">2.3.25 (incubating at Apache)</h2>
<p>Release date: 2016-06-26</p>
<p><strong>This is a stable, final release.</strong> The “incubating” suffix is required by the Apache Software Foundation until the project becomes a fully accepted (graduated) Apache project.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Extended the <a href="#ref.directive.list"><code>list</code> directive</a> to support listing hashes (such as <code>Map</code>-s), like <code>&lt;#list map as k,
              v&gt;${k}: ${v}&lt;/#list&gt;</code>, where <code>k</code> and <code>v</code> are the key and value in the key-value pairs of the hash.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Added the <code>TemplateModelHashEx2</code> interface that extends <code>TemplateModelHashEx</code> with a method for listing the content of the key-value pairs of the hash. (This is utilized by the new hash listing capability of the <a href="#ref.directive.list"><code>list</code> directive</a>, but it's not required by it if all keys are strings.)</p></li>
<li><p>Lazy imports: With the new boolean settings, <code>lazy_imports</code> and <code>lazy_auto_imports</code>, you can make imports (as in <code>&lt;#import &quot;lib/utils.ftl&quot; as u&gt;</code>) and/or auto-imports to be lazy. When the import is lazy, the namespace variable (<code>u</code> in this example) will be created immediately, just like before, but the imported template will be loaded and processed only when (and if ever) the content of the imported namespace is accessed. The main application of this is with auto-imports, where you don't want the overhead of importing templates that aren't actually used in a template. (Also, a new <code>Environment.importLib</code> method overload was added, where you can specify if you want a lazy or an eager import.) These new settings can be set on <code>Configuration</code>, <code>Template</code> (<code>TemplateConfiguration</code>) and <code>Environment</code> level.</p></li>
<li><p>It's now possible to set the <code>auto_import</code> and <code>auto_include</code> settings on a per template basis (like templates with a certain name pattern has different auto-imports). This is now possible as these settings were moved from the <code>Configuration</code> level down to the more generic <code>Configurable</code> level, and so are inherited by <code>TemplateConfiguration</code> and <code>Environment</code> too.</p></li>
<li><p>New <code>Configuration</code> (and <code>TemplateConfiguration</code>) setting, <code>tab_size</code>. This only influences how the column number reported in error messages is calculated (and the column number available with other API-s). It doesn't influence the output of the templates. Defaults to 8.</p></li>
<li><p>Added new setting to <code>DefaultObjectWrapper</code> (and to <code>DefaultObjectWrapperBuilder</code>): <code>iterableSupport</code>. This fixes the issue when you couldn't use <code>#list</code> (or <code>?has_next</code>, etc.) on a value that only implements Java 5 <code>java.lang.Iterable</code> (not to be confused with <code>Iterator</code>), but not <code>Collection</code>. This is not enabled by default as it's not compatible with some existing templates, most often because they have used <code>someIterable.iterator()</code> in the template as a workaround. When this is enabled, the <code>Iterable</code> object won't be seen as a generic Java object by FreeMarker anymore, and thus just like with <code>Collection</code>-s, its API won't be exposed to the templates (except through <code>?api</code>, of course).</p></li>
<li><p>Added <code>Configurable.getCustomNumberFormatsWithoutFallback</code> and <code>Configurable.getCustomDateFormatsWithoutFallback</code> methods to make it easier for custom code to investigate the custom formal setting <code>Map</code> hierarchy.</p></li>
<li><p>Bug fixed (<a href="https://issues.apache.org/jira/browse/FREEMARKER-18">FREEMARKER-18</a>): If you had a JSP custom tag and an EL function defined in the same TLD with the same name, the EL function has overwritten the custom tag. This is a bug introduced in 2.3.23, when EL function support was added. JSP allows a custom tag and an EL function in the same TLD to have the same name. In such case now we combine the two into a single value that is both callable as an user defined directive (<code>&lt;@my.foo...&gt;</code>) and as a function (<code>my.f(...)</code>).</p></li>
<li><p>Bug fixed (<a href="https://issues.apache.org/jira/browse/FREEMARKER-19">FREEMARKER-19</a>): The column numbers calculated by the parser has assumed tab size 1 since 2.3.25 (an unwanted side effect of updating JavaCC), while before it has assumed tab size 8. The default was restored to 8. This bug has affected the column numbers in error messages. It also broke the output of some rarely used AIP-s, namely <code>Template.getSource(beginCol, beginLine, endCol,
              endLine)</code>, <code>TemplateObject.getSource()</code> and through that <code>TemplateObject.toString()</code>, if the first or last line has contain tab characters.</p></li>
<li><p>Bug fixed: There was a regression with 2.3.24, where <code>Configuration.setAutoImports()</code> haven't removed auto-imports added earlier. (Though it's unlikely that an application uses that method and also adds auto-imports earlier.)</p></li>
<li><p>Bug fixed: <code>TemplateConfiguration.apply(Template)</code> didn't merge the <code>customDateFormats</code> and <code>customNumberFormats</code> <code>Map</code>-s when they were set both in the <code>Template</code> and in the applied <code>TemplateConfiguration</code>, instead it just kept the value in the <code>Template</code> (just like with atomic setting values). Note that it was unlikely to run into this bug, as usually you (or FreeMarker) create a single merged <code>TemplateConfiguration</code> with <code>TemplateConfiguration.merge(TemplateConfiguration)</code> and then apply it on a fresh template.</p></li>
<li><p>Removed FindBugs <code>@SuppressFBWarnings</code> annotations from the binary (<code>freemarker.jar</code>), as they have caused warnings like this when compiling dependant project with Gradle: “warning: Cannot find annotation method 'value()' in type 'SuppressFBWarnings'”</p></li>
<li><p>The Maven source artifact now contains the JavaCC generated java files and <code>FTL.jj</code>.</p></li>
</ul>
<h2 id="versions_2_3_24">2.3.24 (incubating at Apache)</h2>
<p>Release date: 2016-03-28</p>
<p><strong>This is a stable, final release.</strong> The “incubating” suffix is required by the Apache Software Foundation until the project becomes a fully accepted (graduated) Apache project. See disclaimer below.</p>
<h3>Legal changes</h3>
<p>The owner of FreeMarker is now the Apache Software Foundation. The license is still Apache License Version 2.0, just like earlier, but the owner is different. The official full product name has changed to Apache FreeMarker.</p>
<p><strong>Disclaimer:</strong><em>Apache FreeMarker is an effort undergoing incubation at The Apache Software Foundation (ASF), sponsored by the <a href="http://incubator.apache.org">Apache Incubator</a>. Incubation is required of all newly accepted projects until a further review indicates that the infrastructure, communications, and decision making process have stabilized in a manner consistent with other successful ASF projects. While incubation status is not necessarily a reflection of the completeness or stability of the code, it does indicate that the project has yet to be fully endorsed by the ASF.</em></p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>The most important new feature of this release is the <a href="#dgui_misc_autoescaping">auto-escaping and output formats mechanism</a>, which deprecates escaping with the <a href="#ref_directive_escape"><code>escape</code> directive</a>. These are the changes related to this new mechanism (see earlier link for a guide):</p>
<ul>
<li><p>New <code>ftl</code> header options, <code>ouput_format</code> and <code>auto_esc</code> to override the <code>output_format</code> and <code>auto_escaping</code> settings of the template, like <code>&lt;#ftl
                  output_format='HTML'</code><code>
                  auto_esc=false&gt;</code>.</p></li>
<li><p>New built-in: <a href="#ref_builtin_no_esc"><code>no_esc</code></a>. Used to prevent auto-escaping, like <code>${descriptionInHtml?no_esc}</code>. This doesn't work with <code>&lt;#escape
                  ...&gt;</code>, only with the new auto-escaping mechanism.</p></li>
<li><p>New FTL type, “markup output”. This is somewhat similar to string, but values of this type aren't auto-escaped by the new escaping mechanism, because they are known to already hold markup. (For example, <code>?esc</code> and <code>?no_esc</code> returns a value of this type, hence their results are protected from double-escaping problems.)</p></li>
<li><p>New built-in: <a href="#ref_builtin_esc"><code>esc</code></a>. Used for escaping with the current output format when auto-escaping is disabled.</p></li>
<li><p>New built-in: <code>markup_string</code>. This returns the markup of a <a href="#dgui_misc_autoescaping_movalues">markup output value</a> as string.</p></li>
<li><p>New built-in: <code>is_markup_output</code>, returns <code>true</code> if the value is of type “markup output”.</p></li>
<li><p>New directive: <code>outputformat</code>, used to change the output format for a section of a template, like <code>&lt;#outputformat
                  &quot;XML&quot;&gt;...&lt;/#outputformat&gt;</code></p></li>
<li><p>New directives: <code>noautoesc</code> and <code>autoesc</code>, used to turn auto-escaping off and on for a section of a template, like <code>&lt;#noautoesc&gt;...&lt;/#noautoesc&gt;</code>.</p></li>
<li><p>New built-in variable, <code>.output_format</code>, returns the current output format at the place of invocation.</p></li>
<li><p>New built-in variable, <code>.auto_esc</code>, returns the boolean that tells if auto-escaping is active at the place of invocation.</p></li>
<li><p>Block assignments, like <code>&lt;#assign
                  captured&gt;...&lt;/#assign&gt;</code>, when the current <code>output_format</code> is some kind of markup (like HTML), will store the captured output not with string type, but with “markup output” type. Thus <code>${captured}</code> will not get unwanted escaping.</p></li>
<li><p>The <code>+</code> operator (concatenation) works with the new “markup output” type as well. Like <code>someMarkup + somePlainText</code> will result in markup where <code>somePlainText</code> is escaped automatically before it's appended to the markup.</p></li>
<li><p>The <code>has_content</code> built-in now supports “markup output” values, considering 0 length markup as empty.</p></li>
</ul></li>
<li><p>You can now define custom number and date/time/datetime formatters. These are defined by the programmers (and thus can implement any kind of exotic formatting rules) when configuring FreeMarker, and can be referred with strings starting with <code>&quot;@&quot;</code>, like in <code>&lt;#setting
              number_format='@foo'&gt;</code>, or <code>${n?string.@foo_params}</code>, <code>&lt;#setting number_format='@foo params'&gt;</code>, or <code>${n?string.@foo}</code>, <code>${n?string.@foo_params}</code>. For backward compatibility, the initial <code>@</code> only has this special meaning if either you have any custom formats or <a href="#pgui_config_incompatible_improvements">the <code>incompatible_improvements</code> setting</a> is at lest 2.3.24.</p></li>
<li><p>Everywhere where Java <code>DecimalFormat</code> patterns are used (like in <code>?string('0.##')</code> or <code>&lt;#setting number_format=&quot;0.##&quot;&gt;</code>), now it's possible to specify options like rounding mode or the symbols used, with a FreeMarker-specific <a href="#topic.extendedJavaDecimalFormat">extension to the <code>DecimalFormat</code> pattern syntax</a>.</p></li>
<li><p>Added new special variable: <code>.incompatible_improvements</code>, which returns the <a href="#pgui_config_incompatible_improvements"><code>incompatible_improvements</code> setting</a> of the current FreeMarker configuration, as a string.</p></li>
<li><p><code>?date</code>, <code>?time</code> and <code>?datetime</code> now can be called as 0 argument method, like <code>?date()</code>, etc., which returns the exact object that <code>TemplateDateFormat.parse</code> returns, instead of the tricky multi-type object that just using <code>?date</code> returns. Because custom <code>TemplateDateFormat</code> implementations may return custom <code>TemplateDateModel</code> implementations, keeping the exact class can be important in some applications.</p></li>
<li><p><code>&lt;@</code> and <code>&lt;/@</code> is now allowed in string literals that contain <code>${exp}</code>, and will be part of the literal as is. Earlier it was a syntactical error.</p></li>
<li><p>Bug fixed: With <code>incompatible_improvements</code> set to 2.3.24 (<a href="#topic.defaultObjectWrapperIcI">see how here...</a>), <code>m?is_sequence</code> doesn't return <code>true</code> for Java methods wrapped by <code>BeansWrapper</code> and its subclasses (most notably <code>DefaultObjectWrapper</code>) anymore, as they only implement the <code>[index]</code> operator, but not <code>?size</code>, which causes <code>&lt;#list ...&gt;</code> to fail, among others.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p><strong>Attention!</strong> FreeMarker now requires at least Java 1.5 (aka. Java 5). 2.3.24 has only required Java 1.4. (Reason: Without this, new public API-s couldn't use generics, which affect negatively the majority of users, while old installations that are still using 1.4 are unlikely to update FreeMarker anyway.)</p></li>
<li><p><strong>Attention!</strong> FreeMarker's JSP support (if it's used) now requires at least JSP 2.0. Earlier it only required JSP 1.1. (Reason: The <code>jsp-api</code> dependency for JSP 1.x, which was needed for building, can't be legally present in the Maven Central Repository, nor be provided by freemarker.org.)</p></li>
<li><p>Added new configuration setting: <code>template_configurations</code>. This allows overriding the settings coming from the shared <code>Configuration</code> object for individual templates, based on template name patterns. <a href="#pgui_config_templateconfigurations">See more here...</a></p></li>
<li><p>Related to the <a href="#dgui_misc_autoescaping">new auto-escaping mechanism</a>:</p>
<ul>
<li><p>As FTL has now a new type, “markup output”, there's also a corresponding new model interface, <code>TemplateMarkupOutputModel</code>. This also means that you can prevent the auto-escaping of values coming from the data-model by returning a <code>TemplateMarkupOutputModel</code> instead of a <code>String</code>. Like the template author can just write <code>${messages.foo}</code>, and it will be auto-escaped or not depending on if the message is known to be markup or not.</p></li>
<li><p>Added new configuration setting: <code>recognize_standard_file_extensions</code>. When <code>true</code>, templates whose source name ends with <code>&quot;.ftlh&quot;</code> will get <code>HTML</code> <code>output_format</code>, and those whose name ends with <code>&quot;.ftlx&quot;</code> get <code>XML</code> <code>output_format</code>, in both cases with auto-escaping on. If <a href="#pgui_config_incompatible_improvements_how_to_set">the <code>incompatible_improvements</code> setting</a> is set to 2.3.24 (or higher) then this setting defaults to <code>true</code>. Otherwise it's default is <code>false</code>, but enabling it is highly recommended.</p></li>
<li><p>Added new configuration setting: <code>output_format</code>. This specifies the <a href="#dgui_misc_autoescaping_outputformat">output format</a> object to use (such as <code>HTMLOutputFormat.INSTANCE</code>, <code>XMLOutputFormat.INSTANCE</code>, etc.) that governs auto-escaping. The output format can be different for different templates, using the <code>template_configurations</code> setting (<a href="#pgui_config_outputformatsautoesc">see here how...</a>).</p></li>
<li><p>Added new configuration setting: <code>registered_custom_output_formats</code>. With this you can add new <code>OutputFormat</code>-s that templates can refer to by name (like in <code>&lt;#ftl
                  output_format=&quot;foo&quot;&gt;</code>).</p></li>
<li><p>Added new configuration setting: <code>auto_escaping_policy</code>. This decides when auto-escaping should be enabled depending on the current output format.</p></li>
</ul></li>
<li><p>Changes related to the custom number and date/time/datetime formating feature:</p>
<ul>
<li><p>Added new classes for implementing custom formatters: <code>freemarker.core.TemplateNumberFormat</code>, <code>TemplateNumberFormatFactory</code>, <code>TemplateDateFormat</code>, <code>TemplateDateFormatFactory</code>, also the exceptions these can throw. These allow implementing any kind of formatting rule that's doable in Java (i.e., they aren't restricted to any <code>java.text</code> formatters). Furthermore these formatters get the <code>TemplateModel</code> instead of a the bare <code>java.lang.Number</code> or <code>java.util.Date</code>, which lets you use the extra application-specific meta information that you may pack into the <code>TemplateModel</code>-s, such as physical unit, preferred precision, and so on.</p></li>
<li><p>Added <code>custom_number_formats</code> and <code>custom_date_formats</code> settings (<code>Configurable.setCustomNumberFormats(Map&lt;String,
                  TemplateNumberFormatFactory&gt;)</code> and <code>Configurable.setCustomDateFormats(Map&lt;String,
                  TemplateDateFormatFactory&gt;)</code>) with which you can register your own formats. These formats can be referred from everywhere where you can use a string to define a format, with a format string like <code>&quot;@foo&quot;</code> or <code>&quot;@foo params&quot;</code>, where <code>&quot;foo&quot;</code> is the key in the <code>Map&lt;String, ...&gt;</code> parameter of the earlier shown methods, and the parameters (if any) are interpreted by the <code>TemplateXxxFormatFactory</code> implementation that you provide. Like, you can issue <code>cfg.setNumberFormat(&quot;@foo params&quot;)</code>, or <code>&lt;#setting number_format='@foo
                  params'&gt;</code>, or <code>${n?string.@foo_params}</code>, similarly as you can issue <code>cfg.setNumberFormat(&quot;0.##&quot;)</code>, etc. For backward compatibility, the initial <code>@</code> only has this special meaning if either you have any custom formats or <a href="#pgui_config_incompatible_improvements">the <code>incompatible_improvements</code> setting</a> is at least 2.3.24. Note that the <code>custom_number_formats</code> and <code>custom_date_formats</code> settings can be set per-template (via the new <code>template_configurations</code> settings) or per-<code>Environment</code> too, thus <code>@foo</code> can mean something different in different templates.</p></li>
<li><p>Added new <code>Environment</code> methods returning <code>TemplateNumberFormat</code> and <code>TemplateDateFormat</code> objects. See the <code>getTemplateNumberFormat(...)</code> and <code>getTemplateDateFormat(...)</code> variations in the API.</p></li>
<li><p>Added <code>freemarker.core.AliasTemplateNumberFormatFactory</code> and <code>AliasTemplateDateFormatFactory</code>, which can be used to create custom formats that are aliases to other formats. For example, instead of writing <code>${n?string[&quot;0.00&quot;]}</code> again and again, you can define the custom format <code>&quot;price&quot;</code> as the alias to the format string <code>&quot;0.00&quot;</code> in the configuration, and then use <code>${n?string.@price}</code>. Thus, you can control at a central place how prices look. Furthermore, the alias can chose a different target format string depending on the current locale; this is especially useful for dates, where conventions can significantly differ in different countries.</p></li>
<li><p>It's now possible to have HTML or other markup in number and date/time/datetime formatting results, like <code>1.23*10&lt;sup&gt;6&lt;/sup&gt;</code>, which won't be accidentally auto-escaped, as FreeMarker knows that it's already HTML. This is done by returning a <code>TemplateMarkupOutputModel</code> instead of a <code>String</code>; see the new auto-escaping mechanism earlier. Note that no out-of-the-box format utilizes this (at the moment), but you could write such custom format.</p></li>
<li><p>The internal format object caching architecture has been reworked, so that it can handle custom formats too. This reworking also fixes some bottlenecks under highly concurrent load, and some (otherwise unlikely) memory leak possibilities.</p></li>
</ul></li>
<li><p>In the <code>number_format</code> configuration setting, when it holds a Java <code>DecimalFormat</code> pattern (like <code>&quot;0.##&quot;</code>), it's now possible to specify options like rounding mode or the symbols used, with a FreeMarker-specific <a href="#topic.extendedJavaDecimalFormat">extension to the pattern syntax</a>.</p></li>
<li><p>New <code>FreemarkerServlet</code> init-params (see <a href="http://freemarker.org/docs/api/freemarker/ext/servlet/FreemarkerServlet.html">the <code>FreemarkerSerlvet</code> API documentation</a> for details):</p>
<ul>
<li><p><code>OverrideResponseContentType</code>: Specifies when should we override the <code>contentType</code> that's already set (i.e., non-<code>null</code>) in the <code>HttpServletResponse</code>. Earlier, we have always set it, and that's still the default behavior. But now that this init-param exists, you can change that behavior, so that the <code>contentType</code> you have specified before forwarding to <code>FreemarkerServlet</code> matters.</p></li>
<li><p><code>OverrideResponseLocale</code>: Specifies if we should override the <code>locale</code> that's already set (i.e., non-<code>null</code>) in the <code>HttpServletResponse</code>. Earlier, we have always set it, but now this behavior can be changed so that we only set it if it wasn't already set.</p></li>
<li><p><code>ResponseCharacterEncoding</code>: Deprecates the old (and quirky) logic of specifying the output charset, which is putting it into the <code>ContentType</code> init-param after the MIME type, otherwise falling back to the template file charset. The possible values are <code>legacy</code> (the default for backward compatibility), <code>fromTemplate</code> (which is <code>legacy</code> without quirks, and is aware of the <code>outputEncoding</code> setting), <code>doNotSet</code> (keeps what the caller has already set in the <code>ServletRespone</code>) and <code>force</code> followed by a charset name (forces a specific output charset).</p></li>
</ul></li>
<li><p>Added <code>freemarker.cache.ByteArrayTemplateLoader</code>, which is similar to <code>StringTemplateLoader</code>, but stores the templates as <code>byte[]</code>-s instead of as <code>String</code>-s.</p></li>
<li><p>Upgraded JavaCC (used during build to generate the FTL parser) from 3.2 to 6.1.2.</p></li>
<li><p>Added <code>Configurable.getSettingNames(boolean
              camelCase)</code>, which returns the set of valid setting names. This can be useful for auto-completion and such.</p></li>
<li><p>Fixes and improvements in the “object builder” mini-language used for configuring FreeMarker from <code>java.util.Properties</code> or other string-only sources (not used in templates). This is <em>not to be confused with the template language syntax</em>, which has nothing to do with the “object builder” syntax we are writing about here. The improvements are:</p>
<ul>
<li><p>Bug fixed: For nested builder expressions, the top-level result class restriction were applied accidentally.</p></li>
<li><p>When resolving an expression like <code>com.example.Foo()</code>, if there's a builder class (<code>com.example.FooBuilder</code>), the non-builder class (<code>com.example.Foo</code>) need not exist anymore. After all, <code>FooBuilder.build()</code> instantiates from any class it wants to anyway.</p></li>
<li><p><code>TimeZone</code> objects can be created like <code>TimeZone(&quot;UTC&quot;)</code>, despite that there's no a such constructor.</p></li>
<li><p>Added support for creating lists with <code>[
                  item1,
                  item2,
                  ...
                  itemN ]</code> syntax.</p></li>
<li><p>Added support for creating maps with <code>{
                  key1:
                  value1,
                  key2:
                  value2,
                  ...
                  keyN:
                  valueN }</code> syntax.</p></li>
<li><p>A number without decimal point will now be parsed to <code>Integer</code>, <code>Long</code>, or <code>BigInteger</code>, depending on the size of the number. Earlier all numbers were parsed to <code>BigDecimal</code>-s, but that had little importance before lists and maps were added, as the number was converted to the constructor or setter parameter type anyway.</p></li>
<li><p>Number literals can have Java type suffixes (<code>f</code>, <code>d</code>, <code>l</code>), plus <code>bd</code> for <code>BigDecimal</code> and <code>bi</code> for <code>BigInteger</code>.</p></li>
<li><p>Public static fields can be referred, like <code>com.example.MyClass.MY_CONSTANT</code> or <code>Configuration.AUTO_DETECT_TAG_SYNTAX</code>.</p></li>
</ul></li>
<li><p>Decreased the stack usage of template execution, which can have importance if you have very very deeply nested templates.</p></li>
<li><p>Added <code>MultiTemplateLoader.setSticky(boolean)</code> and <code>MultiTemplateLoader.isSticky()</code>, with which you can disable the default behavior, where once a template was found in a child <code>TemplateLoader</code>, it will be searched there first next time (typically, when the template update delay is expired). With the <code>sticky</code> property set to <code>false</code>, the child <code>TemplateLoader</code>-s will be always searched in the order as they were added to the <code>MultiTemplateLoader</code>.</p></li>
<li><p>Added <code>StringTemplateLoader.removeTemplate(String)</code> method.</p></li>
<li><p>Bug fixed, only with <code>incompatible_improvements</code> set to 2.3.24 (<a href="#topic.defaultObjectWrapperIcI">see how here...</a>): Expressions inside interpolations that were inside <em>string literal expressions</em> (not <code>${...}</code>-s in general), like in <code>&lt;#assign s=&quot;Hello
              ${name}!&quot;&gt;</code>, always used <code>incompatibleImprovements</code> 0 (2.3.0 in effect). This means that expressions inside string literals had missed the <code>?html</code>, <code>?iso_...</code>, <code>?is_enumerable</code>, <code>?c</code>, etc. fixes/improvements.</p></li>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/439/">439</a>]: <code>FileTemplateLoader</code> with <code>emulateCaseSensitiveFileSystem</code> set to <code>true</code> (used for development) wasn't properly synchronized, leading to random <code>NullPointerException</code>-s or other misbehavior.</p></li>
<li><p>Bug fixed: It wasn't well defined when a Java <code>Iterator</code> counts as empty. Depending on what <code>ObjectWrapper</code> you are using, one of these fixes apply:</p>
<ul>
<li><p><code>DefaultObjectWrapper</code> (fix is always active): Operations on the <code>Iterator</code> that only check if it's empty without reading an element from it, such as <code>?has_content</code>, won't cause a later iteration (or further emptiness check) to fail anymore. Earlier, in certain situations, the second operation has failed saying that the iterator “can be listed only once”.</p></li>
<li><p><code>BeansWrapper</code> (when it's not extended by <code>DefaultObjectWrapper</code>), if it's <code>incompatibleImprovements</code> property is set to 2.3.24 (or higher): <code>Iterator</code>-s were always said to be non-empty when using <code>?has_content</code> and such (i.e., operators that check emptiness without reading any elements). Now an <code>Iterator</code> counts as empty exactly if it has no elements left. (Note that this bug has never affected basic functionality, like <code>&lt;#list
                  ...&gt;</code>.)</p></li>
</ul></li>
<li><p>Bug fixed: The (rarely used) cause exception of <code>ParseException</code>-s wasn't set</p></li>
<li><p>Bug fixed: When the <code>incomaptible_improvements</code> setting of an existing <code>Configuration</code> was changed, the template cache sometimes wasn't recreated, hence old templates could survive.</p></li>
<li><p>Bug fixed, with <code>incompatible_improvements</code> set to 2.3.24 (<a href="#topic.defaultObjectWrapperIcI">see how here...</a>): The <code>#import</code> directive meant to copy the library variable into a global variable if it's executed in the main namespace, but that haven't happened when the imported template was already imported earlier in another namespace.</p></li>
<li><p>Fixes in the XML processing feature (<code>freemarker.ext.dom</code>):</p>
<ul>
<li><p>Bug fixed: XPath queries that has only contained characters that are valid in XML element names and has also contained <code>::</code> (which is valid in names in namespace-unware documents), like <code>e['following-sibling::foo']</code>, were interpreted as literal element names (giving 0 hits) rather than as XPath expressions. Note that there were no such problem with <code>e['following-sibling::*']</code> for example, as it's not a valid XML element name according the XML specification. This fix can actually break applications that has processed namespace unaware XML that use <code>::</code> as part of element or attribute names, but such an application is highly unlikely, unlike running into the fixed problem. (Unfortunately, using <code>incompatible_improvements</code> wasn't technically possible here.)</p></li>
<li><p>Bug fixed: The <code>@@qname</code> of elements that belong to the XML namespace declared as the default via <code>&lt;#ftl ns_prefixes={'D':'...', ...
                  }&gt;</code> no longer starts with <code>D:</code>, instead they just start with no name space prefix.</p></li>
<li><p>Bug fixed: In the markup returned by the <code>@@markup</code> key, when there were multiple namespaces for which there was no prefix associated with via <code>&lt;#ftl
                  ns_prefixes=...&gt;</code>, all those namespaces were assigned to the same auto-generated <code>xmlns</code> prefix (usually “a”). Now they will get “a”, “b”, “c”, etc. prefixes.</p></li>
</ul></li>
<li><p>JSP TLD loading now quotes the location of <code>jar</code>-s (and other <code>zip</code>-s) which can't be loaded due to zip format errors in the error message.</p></li>
<li><p>Added an overload to <code>Configuration.getSupportedBuiltInNames</code> and <code>Configuration.getSupportedBuiltInDirectiveNames</code> that has a <code>namingConvention</code> parameter. This is useful for tooling as since 2.3.23 we support both camel case naming convention (like <code>s?upperCase</code>) and the legacy one (like <code>s?upper_case</code>). Furthermore the old 0 argument overload will now utilize <code>Configuration.getNamingConvention()</code> to only return the relevant names if it's not <code>AUTO_DETECT_NAMING_CONVENTION</code>.</p></li>
<li><p>Internal reworking to simplify the AST (the <code>TemplateElement</code> structure). The related technically public API was marked as internal for a good while. For those who still use that API, the visible change is that <code>TemplateElement</code>-s now almost never has a <code>MixedContent</code> parent, instead, the parent is directly whatever element the child element indeed belongs under when you look at the source code (like the enclosing <code>#list</code> for example, while earlier you often had to go through a <code>MixedContent</code> first whose parent was the <code>#list</code>). Note that when you have moved downwards, i.e., towards the child elements, these <code>MixedContent</code> parents weren't visible and were silently skipped, so the tree traversal API was inconsistent. Now it's consistent.</p></li>
<li><p>Due to the above change again, the return type of <code>freemarker.core.DebugBreak.accept()</code> and <code>freemarker.core.TextBlock.accept()</code> has changed from <code>void</code> to <code>TemplateElement[]</code>. This again is highly unlikely to affect anyone, and these meant to be internal API-s anyway, but as these two <code>accept</code> methods has wider than package visibility for historical reasons, we mention this change.</p></li>
<li><p>The non-public AST API of <code>freemarker.core.StringLiteral</code>-s has been changed. In principle it doesn't mater as it isn't a public API, but some might used these regardless to introspect templates. Earlier it had an “embedded template” parameter inside, now it has 0 (for purely static string literals), one or more “value part”-s, which are <code>String</code>-s and <code>Interpolation</code>-s.</p></li>
<li><p>Internal code cleanup: Mostly for consistent source code formatting, also many parser construction/setup cleanup</p></li>
<li><p>Source code changes to conform to Apache source release policy, such as adding copyright headers and getting rid of test <code>jar</code>-s committed into the source code. Eclipse project files were also removed, instead the <code>README</code> describes how to set up the project.</p></li>
<li><p>Build script and distribution artifact changes to conform to Apache release policy, most notably it produces separate source and binary releases.</p></li>
</ul>
<h3>Changes compared to 2.3.24 Release Candidate 1</h3>
<ul>
<li><p>Added <code>MultiTemplateLoader.setSticky(boolean)</code> and <code>MultiTemplateLoader.isSticky()</code>, with which you can disable the default behavior, where once a template was found in a child <code>TemplateLoader</code>, it will be searched there first next time (typically, when the template update delay is expired). With the <code>sticky</code> property set to <code>false</code>, the child <code>TemplateLoader</code>-s will be always searched in the order as they were added to the <code>MultiTemplateLoader</code>.</p></li>
<li><p>Added <code>StringTemplateLoader.removeTemplate(String)</code> method.</p></li>
<li><p>Source code changes to conform to Apache release policy and recommendations:</p>
<ul>
<li><p>No more binary test <code>jar</code>-s committed into the source code (instead, they are generated on-the-fly)</p></li>
<li><p>Eclipse project files were removed, instead, the <code>README</code> describes how to set up the project.</p></li>
</ul></li>
</ul>
<h2 id="versions_2_3_23">2.3.23</h2>
<p>Date of release: 2015-07-05</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Listing (<code>#list</code>) has received some specialized convenience features that target typical tasks people do again and again in templates.</p>
<ul>
<li><p>New <code>list</code> directive child directives. There are <code>else</code> and <code>items</code> to deal with special cases with 0-length lists, and <code>sep</code> for inserting separators between items. For more details, see the <a href="#ref_directive_list"><code>list</code> directive in the Reference</a>.</p></li>
<li><p><a href="#ref_builtins_loop_var">New built-ins that act on loop variables</a>: <code>var?index</code> (deprecates <code>var_index</code>), <code>var?counter</code> (1-based index), <code>var?has_next</code> (deprecates <code>var_has_next</code>), <code>var?is_first</code>, <code>var?is_last</code>, <code>var?item_parity</code> (returns <code>&quot;odd&quot;</code> or <code>&quot;even&quot;</code>), <code>var?item_parity_cap</code>, <code>var?item_cycle</code><code>(...)</code>, etc.</p></li>
</ul></li>
<li><p>Added convenience assignment operators, which can be used in assignment directives (<code>#assign</code>, <code>#global</code> and <code>#local</code> currently) only:</p>
<ul>
<li><p><code>++</code> and <code>--</code>: For example, <code>&lt;#assign counter++&gt;</code> is equivalent to <code>&lt;#assign counter = counter +
                  1&gt;</code>.</p></li>
<li><p><code>+=</code>, <code>-=</code>, <code>*=</code>, <code>/=</code> and <code>%=</code>: For example, <code>&lt;#assign
                  counter += 2&gt;</code> is equivalent to <code>&lt;#assign counter = counter +
                  2&gt;</code>.</p></li>
</ul></li>
<li><p>Added the <code>then</code> built-in, which can be used like a ternary operator: <code>someBoolean?then(whenTrue,
              whenFalse)</code>. Just like with the ternary operator of most other languages, only one of the parameter expressions will be evaluated. <a href="#ref_builtin_then">More details...</a></p></li>
<li><p>Added the <code>switch</code> built-in, which can be used like an in-line (expression) switch-case-default statement: <code>someValue?switch(case1,
              result1,
              case2,
              result2, ...
              caseN,
              resultN,
              defaultResult)</code>, where <code>defaultResult</code> can be omitted (then it will be error if none of the cases matches). <a href="#ref_builtin_switch">More details...</a></p></li>
<li><p>Added camel case support for the identifiers that are part of the template language (user defined names aren't affected). For example, now <code>&lt;#noEscape&gt;${x?upperCase}&lt;/#noEscape&gt;</code> or <code>&lt;#setting numberFormat=&quot;0.0&quot;&gt;</code> or <code>&lt;#ftl stripText=true&gt;</code> are valid. However, within the same template, FreeMarker will require you to use the same naming convention consistently for all identifiers that are part of the template language. It's also possible to enforce the same naming convention on all templates from Java via <code>Configuration.setNamingConvention(int)</code>. It's certain that camel case will be the recommended convention starting from some future version, because the Java API-s users call from templates use that too.</p></li>
<li><p>Added new <a href="#ref_specvar">special variables</a>, <code>.current_template_name</code> and <code>.main_template_name</code>. These deprecate <code>.template_name</code>, which was always broken when it comes to macro calls. The new <code>.current_template_name</code> always returns the name of the template that contains the reference to the special variable, and <code>.main_template_name</code> always returns the name of the topmost template.</p></li>
<li><p>Smaller error message improvements. Like, added tip in the error message for the frequent issue when <code>someMap[someNumber]</code> complains that <code>someMap</code> is not a sequence nor is coercible to string.</p></li>
<li><p>Bug fixed, activated with setting <code>incompatible_improvements</code> to 2.3.23: There's a long existing parse-time rule that says that <code>#break</code>, in the FTL source code itself, must occur nested inside a breakable directive, such as <code>#list</code> or <code>#switch</code>. This check could be circumvented with <code>#macro</code> or <code>#function</code>, like this: <code>&lt;#list 1..1
              as x&gt;&lt;#macro
              callMeLater&gt;&lt;#break&gt;&lt;/#macro&gt;&lt;/#list&gt;&lt;@callMeLater
              /&gt;</code>. After activating this fix, this will be caught as parse time error.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Added <code>Configuration.setNamingConvention(int)</code>. By default FreeMarker will auto-detect the naming convention (legacy VS camel case) used for the identifiers that are part of the template language, for each template independently. This setting lets you enforce a naming convention instead.</p></li>
<li><p><code>Configuration</code> (and in fact any <code>Configurable</code>) setting names now can be written with camel case as well. For example, if you are configuring FreeMarker from properties file, you can have <code>defaultEncoding=utf-8</code> instead of <code>default_encoding=utf-8</code>. You can use the two naming conventions (camel case, and tradition snake case) mixed, and <code>Configuration.setNamingConvention(int)</code> does not influence this behavior.</p></li>
<li><p>Added <code>Configuration.setTemplateUpdateDelayMilliseconds(long)</code> and <code>Configuration.getTemplateUpdateDelayMilliseconds()</code>. This deprecates <code>setTemplateUpdateDelay(int)</code>, which uses seconds resolution, hence going against Java conventions and often leading to misunderstandings. (Also that couldn't have a getter pair.)</p></li>
<li><p>The <code>template_update_delay</code> setting, when specified as a string (as inside <code>java.util.Properties</code>), supports time units, like in <code>template_update_delay=500 ms</code>.</p></li>
<li><p>Added <code>Environment.getCurrentTemplate()</code> method, which return the currently executed template (as opposed to the main template).</p></li>
<li><p>Added <code>WebappTemplateLoader.setAttemptFileAccess(boolean)</code>, which can be used to disable the legacy trick where we try to load templates through direct file access, so that template updating works without restarting. Disabling URL connection caches (<code>someURLBasedTemplateLoader.setURLConnectionUsesCaches(false)</code>, which is also the default since <code>incompatible_improvements</code> 2.3.21) probably solves that on modern Servlet containers.</p></li>
<li><p>In the <code>FreemarkerServlet</code> <code>TemplatePath</code> init-param, paths (like <code>/templates</code>) can have a <code>?settings(...)</code> postfix, with which you can set the JavaBean properties of the resulting <code>TemplateLoader</code>. For example: <code>&lt;param-value&gt;/templates?settings(attemptFileAccess=false,
              URLConnectionUsesCaches=false)&lt;/param-value&gt;</code></p></li>
<li><p>Added <code>FileTemplateLoader.setEmulateCaseSensitiveFileSystem(boolean)</code>. This is handy when you are developing on Windows but will deploy to a platform with case sensitive file system. The default is <code>false</code>, and <code>true</code> is only meant for development, not for production installations. The default can be overridden by setting the <code>org.freemarker.emulateCaseSensitiveFileSystem</code> system property to <code>true</code>.</p></li>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/424">424</a>]: <code>WebappTemplateLoader</code> didn't find templates that are stored in <code>WEB-INF/lib/*.jar/META-INF/resources</code>. Files under that directory are visible as <code>ServletContext</code> resources since Servlet 3.0, yet <code>WebappTemplateLoader</code> has usually failed to see them because of some internal tricks.</p></li>
<li><p>Bug fixed: If a template “file” was successfully opened for reading, but then there was an <code>IOException</code> during reading its content, the parser (JavaCC) acted like if the template “file” was ended there, and the exception was suppressed. It's actually a JavaCC quirk that affects many other JavaCC-based languages too, but now FreeMarker has added a workaround in the <code>Template</code> constructor, and so now an exception will be thrown as expected.</p></li>
<li><p>Bug fixed: <code>InvalidReferenceException.FAST_INSTANCE</code> could accidentally store reference to an <code>Environment</code> instance, which hence was never garbage collected.</p></li>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/426/">426</a>]: When setting <code>incompatible_improvements</code> to 2.3.22, the special variable reference <code>.template_name</code> in templates always returns the name of the main (topmost) template, due to an oversight in 2.3.22. Setting <code>incompatible_improvements</code> to 2.3.23 restores the old, backward compatible behavior. (Note that the old behavior that we emulate is itself broken, as it doesn't work well with macro calls; you should use <code>.current_template_name</code> or <code>.main_template_name</code> instead.)</p></li>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/53/">53</a>]: Template parsing was abnormally slow for templates with very high number AST (abstract syntax tree) nodes on the same hierarchy level.</p></li>
<li><p>Bug fixed: When the template was concurrently replaced on the backing store during its first loading was still ongoing, the older version of the template could get into the cache with the time stamp of the new version, hence it wasn't reloaded after the configured update delay.</p></li>
<li><p>Bug fixed: The <code>log_template_exceptions</code> setting (added in 2.3.22) couldn't be set through the <code>Configurable.setSetting(String, String)</code> API.</p></li>
<li><p>Bug fixed: <code>StringUtil.FTLStringLiteralEnc</code> has escaped <code>$</code> (hence generating an illegal escape) and haven't escaped <code>{</code> after <code>$</code> and <code>#</code>. While this function is only used for generating error messages by FreeMarker, it's a public methods so anyone could use it.</p></li>
<li><p>Bugs fixed: Various canonical form glitches (they only affect error messages as far as FreeMarker is concerned).</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Modernized Manual and site design with improved functionality (always visible navigation tree, search inside the Manual, etc.), thanks to Evangelia Dendramis. (Also now the Site uses the same format and HTML generator as the Manual.)</p></li>
<li><p>Many smaller Manual and site content updates/improvements.</p></li>
</ul>
<h3>Notes</h3>
<p>Changes compared to 2.3.23 RC1:</p>
<ul>
<li><p><code>.current_name_name</code> and <code>.main_template_name</code> is now missing (<code>null</code>) instead of <code>&quot;&quot;</code> if the template has no name</p></li>
<li><p>Some minor error message improvements</p></li>
<li><p>Documentation refinements</p></li>
</ul>
<h2 id="versions_2_3_22">2.3.22</h2>
<p>Date of release: 2015-03-01</p>
<p>Note that since 2.3.22 is designed to be fully backward compatible with the previous 2.3.x releases, <em>some of the improvements and fixes described below are only activated when you specifically ask for 2.3.22 “incompatible improvements”</em> (it's always clearly indicated), because they could, with very small chance, break existing applications. For actively maintained applications it's probably better to allow them. See <a href="#pgui_config_incompatible_improvements_how_to_set">how to set “incomplatible improvements” here</a>.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New built-ins: <code>api</code> and <code>has_api</code>. <code>value?api</code> provides access to the API (usually, the Java API) of <code>value</code>, like <code>value?api.someJavaMethod()</code> or <code>value?api.someBeanProperty</code>), if the value itself supports exposing its API. This meant to be used rarely, when you need to call a Java method of an object, but the by-design simplistic view of the value that FreeMarker exposes to the templates hides that, and there's no equivalent built-in either. For example, when you put a <code>Map</code> into the data-model (and you are using the default object wrapper), <code>myMap.myMethod()</code> in a template basically translates to <code>((Method)
              myMap.get(&quot;myMethod&quot;)).invoke(...)</code> in Java, thus you can't call <code>myMethod</code>. If, however, you write <code>myMap?api.myMethod()</code> instead, that means <code>myMap.myMethod()</code> in Java. Similarly, <code>myMap?api.myProperty</code> translates to <code>myMap.getMyProperty()</code> in Java, instead of to <code>myMap.get(&quot;myProperty&quot;)</code>.</p>
<p><em>If you can, rely on the capabilities of the FTL types and the related built-ins as far as possible. Using <code>?api</code> is only the last resort.</em></p>
<p>Using <code>?api</code> also happens to offer a workaround for the lack of non-<code>String</code> <code>Map</code> key support in FTL's <code>[]</code> operator (as in <code>myMap[key]</code>), because now you can write <code>myMap?api.get(nonStringKey)</code>.</p>
<p><code>?api</code> is not enabled by default and isn't available for all values. <a href="#ref_buitin_api_and_has_api">See more here...</a></p></li>
<li><p>Identifiers (like <code>someVariable</code>) can now contain minus (<code>-</code>), dot (<code>.</code>), and colon (<code>:</code>) at any position, but those characters <em>must be escaped with a preceding backslash</em> (<code>\</code>), or else they would be interpreted as operators. For example, to read the variable whose name is “data-id”, the correct expression is <code>data\-id</code>, as <code>data-id</code> would be interpreted as “data minus id”. This also works for named macro parameters, which is useful when you want to accept arbitrary HTML attributes in a catch-all parameter, like in <code>&lt;@box
              class=&quot;someCssClass&quot; data\-id=product.id /&gt;</code>. (When you enumerate the catch-all parameter names inside the macro, the key string you get is <code>&quot;data-id&quot;</code> without <code>\</code> of course.)</p></li>
<li><p>Added <code>?lower_abc</code> and <code>?upper_abc</code>. This converts <code>1</code>, <code>2</code>, <code>3</code>, etc., to the string <code>&quot;a&quot;</code>, <code>&quot;b&quot;</code>, <code>&quot;c&quot;</code>, etc. (or for <code>&quot;A&quot;</code>, <code>&quot;B&quot;</code>, <code>&quot;C&quot;</code>, etc.). When reaching <code>&quot;z&quot;</code>, it continues like <code>&quot;aa&quot;</code>, <code>&quot;ab&quot;</code>, etc. This is the same logic that you can see in column labels in spreadsheet applications (like Excel or Calc). <a href="#ref_builtin_lower_abc">More details...</a></p></li>
<li><p>Added <code>?keep_before_last</code> and <code>?keep_after_last</code>. Example: <code>&quot;foo.bar.txt&quot;?keep_before_last(&quot;.&quot;)</code> returns <code>&quot;foo.bar&quot;</code>, <code>&quot;foo.bar.txt&quot;?keep_after_last(&quot;.&quot;)</code> returns <code>&quot;txt&quot;</code>. (These work like <code>?keep_before</code> and <code>?keep_after</code>, but those look for the first occurrence of the separator.)</p></li>
<li><p>Added many missing UNICODE letters and digits to the set of legal identifier characters, like Korean letters (bug fixed: [<a href="https://sourceforge.net/p/freemarker/bugs/129/">129</a>])</p></li>
<li><p>Error message quality improvements:</p>
<ul>
<li><p>Several improvements when calling custom JSP tags; see them in its own section later.</p></li>
<li><p>Bug fixed: When localized lookup or template acquisition has kicked in, error messages have still quoted the name used for requesting the template, rather that the actual template source name (like <code>foo.ftl</code> instead of <code>foo_en.ftl</code>, when the template was get as <code>foo.ftl</code>, but behind the scenes was loaded from <code>foo_en.ftl</code>).</p></li>
<li><p>“Template not found” errors are now more detailed, giving hints about accidentally using <code>\</code> instead of <code>/</code>, or backing out of the <code>TemplateLoader</code>'s root directory.</p></li>
<li><p>The <code>#setting</code> directive gives more helpful error message when the setting name is not recognized, and lists the allowed setting names or a correction suggestion.</p></li>
<li><p>When a bad special variable name (<code>.name</code>) is encountered, the list of available names is shown in the error message.</p></li>
<li><p>When <code>Map.get</code> or <code>Map.containsKey</code> of a wrapped <code>Map</code> throws a <code>ClassCastException</code> or <code>NullPointerException</code>, the error will point to the causing FTL expression (with some explanation), rather than bubbling up as low level runtime error.</p></li>
</ul></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Object wrapping improvements:</p>
<ul>
<li><p><code>DefaultObjectWrapper</code>, only with its <code>incompatible_improvements</code> set to 2.3.22 (<a href="#topic.defaultObjectWrapperIcI">see how here...</a>), or more precisely, with its new <code>useAdaptersForContainers</code> setting set to <code>true</code> (which defaults to <code>true</code> when <code>incompatible_improvements</code> is set to 2.3.22): It doesn't copy <code>Map</code>-s, <code>List</code>-s, and arrays anymore when wrapping them into <code>TemplateModel</code>-s (which is the interface through with templates access all values), just wraps them into thin <code>TemplateModel</code> adapters, that will reach the original object for all operations. The wrapped values will be instances of the new <code>DefaultMapAdapter</code>, <code>DefaultListAdapter</code> and <code>DefaultArrayAdapter</code> classes, instead of the legacy (copying) <code>SimpleHash</code> and <code>SimpleSequence</code> classes. (Note that many projects use pure <code>BeansWrapper</code> instead of <code>DefaultObjectWrapper</code>, which has always used the adapter approach, albeit a different implementation of it. As the shortcomings of <code>DefaultObjectWrapper</code> are fixed now, it's always recommended over <code>BeansWrapper</code>, as <code>BeansWrapper</code> gives quite confusing multi-typed values and is substantially slower.)</p>
<p>While keeping backward compatibility as much as possible was an important factor in this change, this is a quite deep change, so you may want to <a href="#topic.defaultObjectWrapperSwitchToAdapters">review the consequences and reasons here...</a> (But again, this change is <em>not</em> active by default, so merely updating FreeMarker wont risk the stability of existing applications)</p></li>
<li><p>Added <code>TemplateMethodModelEx
                  BeansWrapper.wrap(Object object, Method method)</code> for wrapping methods without wrapping their parent object and without going through overloaded method selection on invocation time.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/372/">372</a>]: <code>ClassCastException</code> when a <code>SortedMap</code> (typically, a <code>TreeMap</code>) is wrapped with <code>DefaultObjectWrapper</code> and then a 1 character long string is get from it that doesn't exist. To fix the issue, if the wrapped <code>Map</code> is a <code>SortedMap</code> and it's wrapped by <code>DefaultObjectWrapper</code>, it won't try to fall back to a <code>Character</code> key after with the <code>String</code> key has got <code>null</code>. (This change should be backward compatible, because when a <code>SortedMap</code> has <code>Character</code> keys, the initial attempt with <code>String</code> key causes <code>ClassCastException</code>, thus, such <code>SortedMap</code>-s were never usable as FTL hashes.)</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/368/">368</a>]: Only with <code>incompatible_improvements</code> set to 2.3.22 or with its new <code>useAdaptersForContainers</code> setting set to <code>true</code>: Key order and other behavioral peculiarities of “custom” <code>Map</code> types isn't lost anymore. The same stands for <code>List</code>-s too.</p></li>
<li><p>Added new setting, <code>forceLegacyNonListCollections</code>. This only matters when <code>useAdaptersForContainers</code> is <code>true</code>. Then, unless you set this to <code>true</code>, <code>java.util.Collection</code>-s that aren't <code>List</code>-s (like <code>Set</code>-s) will continue using <code>SimpleSequence</code> (i.e., the copying approach) instead of the adapter approach. The default is <code>false</code>, at least until <code>incompatible_improvements</code> 2.4.0, because <code>SimpleSequence</code> gave indexed access to these non-<code>List</code>-s, like in <code>mySet[2]</code>, which is strange but some existing templates may utilize this, even if only accidentally. With <code>forceLegacyNonListCollections</code> set to <code>false</code>, indexed access won't be possible for <code>Set</code>-s and such anymore (nor will <code>?first</code> and <code>?last</code> work, but <code>?size</code> will still do), so you may want to retest old templates. On the other hand, you get the advantages of the adapter approach. Hence, in new projects it's highly recommended to set <code>forceLegacyNonListCollections</code> to <code>false</code>. (The adapter approach is implemented by <code>DefaultNonListCollectionAdapter</code>.)</p></li>
<li><p>Added new, <em>experimental</em> FTL type interface, <code>freemarker.template.TemplateCollectionModelEx</code>, which adds the <code>size()</code>, <code>isEmpty()</code>, and <code>boolean
                  contains(TemplateModel)</code> methods to the <code>TemplateCollectionModel</code> interface. This was added because when wrapping <code>java.util.Collections</code> these extra capabilities area available anyway, but FTL couldn't tap on them till now. While the exact interface details are marked as experimental, the feature itself is already utilized for <code>?size</code> when setting the <code>forceLegacyNonListCollections</code> property of <code>DefaultObjectWrapper</code> to <code>false</code> (see earlier).</p></li>
<li><p>Added new <em>experimental</em> interface, <code>freemarker.template.ObjectWrapperAndUnwrapper</code>. This extends <code>ObjectWrapper</code> with unwrapping functionality. This functionality has already existed for a long time in <code>BeansWrapper</code> and its subclasses, like in <code>DefaultObjectWrapper</code>, but it wasn't “factored out” into its own published interface that other <code>ObjectWrapper</code>-s could implement. This is useful for <code>TemplateModel</code> implementations that don't want to require a <code>BeansWrapper</code> (or its subclass), only the availability of the unwrapping functionality.</p></li>
<li><p>Added new <em>experimental</em> interfaces to implement <code>?api</code> (see it in the FTL section): <code>TemplateModelWithAPISupport</code>, <code>ObjectAPIWrapper</code>, <code>RichObjectWrapper</code>. Note that while the interfaces are experimental, <code>?api</code> itself isn't.</p></li>
</ul></li>
<li><p><code>FreemarkerServlet</code> improvements:</p>
<ul>
<li><p><code>FreemarkerServlet</code> now supports custom JSP EL functions (defined in TLD-s with <code>function</code> XML elements). Earlier it has ignored them. The custom EL function can be called like a Java method, for example: <code>&lt;#assign
                  u=JspTaglibs[&quot;/WEB-INF/utils.tld&quot;]&gt; ...
                  ${u.truncate(title, 25)}</code>.</p></li>
<li><p>Bug fixed: Error message was unhelpful when there was a type mismatch between the actual and the expected type of a custom tag parameter. This was a very frequent problem of users who call JSP taglibs from FTL (the typical &quot;java.lang.IllegalArgumentException: argument type mismatch&quot;, without any FTL context). Now it's a proper error with explanation, solution tip, and FTL error position/quotation.</p></li>
<li><p>RFE resolved [<a href="https://sourceforge.net/p/freemarker/feature-requests/113/">113</a>] [<a href="https://sourceforge.net/p/freemarker/feature-requests/114/">114</a>]: <code>FreemarkerServlet</code> can now discover <code>META-INF/**/*.tld</code>-s that are visible for the class loader but aren't in <code>WEB-INF/lib/*.jar</code>-s. For this feature to be active, you must setup the extra TLD lookup with the <code>MetaInfTldSources</code> and/or <code>ClasspathTlds</code> <code>FreemarkerServlet</code> init-params (see the <a href="http://freemarker.org/docs/api/freemarker/ext/servlet/FreemarkerServlet.html">Java API documentation of <code>FreemarkerServlet</code></a> for the description of these). For example, if you run your application from Eclipse with an embedded Servlet container, and thus the tag library jar-s aren't on the standard locations but are in the classpath like any other dependencies, now you can just write:</p>
<pre><code>&lt;init-param&gt;
  &lt;param-name&gt;MetaInfTldSources&lt;/param-name&gt;
  &lt;param-value&gt;classpath&lt;/param-value&gt;
&lt;/init-param&gt;</code></pre>
<p>and then all the <code>META-INF</code> directories that are visible for the class loader will be searched for TLD-s.</p></li>
<li><p><code>MetaInfTldSources</code> and <code>ClasspathTlds</code> can also be appended to or replaced by the values of Java system properties <code>org.freemarker.jsp.metaInfTldSources</code> and <code>org.freemarker.jsp.classpathTlds</code>, respectively. Thus one can adjust these in the Eclipse run configuration without modifying the <code>web.xml</code>. (See the <a href="http://freemarker.org/docs/api/freemarker/ext/servlet/FreemarkerServlet.html">Java API documentation of <code>FreemarkerServlet</code></a> for more.)</p></li>
<li><p><code>FreemarkerServlet</code> now recognizes the <code>org.eclipse.jetty.server.webapp.ContainerIncludeJarPattern</code> servlet context attribute, and adds entries to <code>MetaInfTldSources</code> (introduced above) from it.</p></li>
<li><p>Added <code>protected
                  FreemarkerServlet.createTaglibFactory()</code> to allow fine tuning the settings of the <code>TaglibFactory</code>. It now have a few setters, like <code>setObjectWrapper</code>, <code>setMetaInfTldSource</code>, etc.</p></li>
<li><p>Added new servlet init-param, <code>BufferSize</code>. This sets the buffer size via <code>HTTPServletResponse.setBufferSize()</code> if the response state still allows that, ignores it otherwise.</p></li>
<li><p>The <code>TemplatePath</code> servlet init-param now supports a new kind of path, that looks like <code>classpath:com/example/myapp/templates</code>. This is similar to the old <code>class://com/example/myapp/templates</code>, but it uses the Thread Context Class Loader of the thread that initializes <code>FreemarkerSerlvet</code>, and thus will work even if <code>freemarker.jar</code> is not local to the web application. <code>class://</code> has the problem that it uses the defining class loader of <code>FreemarkerSerlvet</code> itself (or of its subclass).</p></li>
<li><p>If <code>incompatible_improvements</code> is set to 2.3.22 (or higher), the <code>TemplatePath</code> servlet init-param supports specifying multiple comma separated paths inside <code>[...]</code>, like <code>&lt;param-value&gt;[ WEB-INF/templates,
                  classpath:com/example/myapp/templates
                  ]&lt;/param-value&gt;</code>. This internally creates a <code>freemarker.cache.MultiTemplateLoader</code>.</p></li>
<li><p>Added new servlet <code>init-param</code>, <code>ExceptionOnMissingTemplate</code>. Setting this to <code>true</code> changes the behavior on template-not-found errors to similar to what you experience with other kind of template exceptions (a HTTP 500 “Internal Server error” response on most setups). When it's <code>false</code> (the legacy behavior), you only get a HTTP 404 “Not found”. While that's also how JSP views work, this turns out to be a problem, because some frameworks give 404 to the visitor too if the MVC view gives 404. But to get to the point where you forward to the MVC View, the visitor had to visit a valid URL, only that page misses its View, so its broken on the server side, so it should be a 500.</p></li>
<li><p>Added new overridable method: <code>FreemarkerServlet.createDefaultObjectWrapper()</code>. This can be used for what <code>createObjectWrapper()</code> is usually overridden for, but without unwillingly disabling the processing of the related init-params (like of <code>object_wrapper</code>).</p></li>
<li><p>Improved (or fixed) error logging: Now logs will always get into FreeMarker's own log, not only into the servlet container log. Also, earlier template-not-found and template parsing error details logs were sometimes lost, depending on the servlet container.</p></li>
<li><p>Bug fixed, only active with <code>incompatible_improvements</code> set to 2.3.22 (or higher): Some kind of values, when put into the JSP <em>page</em> scope (via <code>#global</code> or via the JSP <code>PageContext</code> API) and later read back with the JSP <code>PageContext</code> API (typically in a custom JSP tag), might come back as FreeMarker <code>TemplateModel</code> objects instead of as objects with a standard Java type. Other Servlet scopes aren't affected. It's highly unlikely that something expects the presence of this bug. The affected values are of the FTL types listed below, and to trigger the bug, they either had to be created directly in the template (like as an FTL literal or with <code>?date</code>/<code>time</code>/<code>datetime</code>), or you had to use <code>DefaultObjectWrapper</code> or <code>SimpleObjectWrapper</code> (or a subclass of them):</p>
<ul>
<li><p>FTL date/time/date-time values may came back as <code>freemarker.template.SimpleDate</code>-s, now they come back as <code>java.util.Date</code>-s instead.</p></li>
<li><p>FTL sequence values may came back as <code>SimpleSequence</code>-s, now they come back as <code>java.util.List</code>-s as expected. This stands assuming that the <code>object_wrapper</code> configuration setting is a subclass of <code>BeansWrapper</code> (such as <code>DefaultObjectWrapper</code>), but that's practically always the case in applications that use FreeMarker's JSP extension (otherwise it can still work, but it depends on the quality and capabilities of the <code>ObjectWrapper</code> implementation).</p></li>
<li><p>FTL hash values may came back as <code>SimpleHash</code>-es, now they come back as <code>java.util.Map</code>-s as expected (again, assuming that the object wrapper is a subclass of <code>BeansWrapper</code>).</p></li>
<li><p>FTL collection values may came back as <code>SimpleCollection</code>-s, now they come back as <code>java.util.Collection</code>-s as expected (again, assuming that the object wrapper is a subclass of <code>BeansWrapper</code>).</p></li>
</ul></li>
<li><p>Bug fixed: Now <code>*.tld</code> files are searched in <code>WEB-INF/</code> and in all its subdirectories recursively. Earlier they were only searched directly under <code>WEB-INF/</code> and <code>WEB-INF/lib/</code>.</p></li>
<li><p>Bug fixed: Leading and trailing whitespace in TLD-s inside the <code>name</code> and <code>tag-class</code> elements is now removed.</p></li>
<li><p>Unwanted behavior fixed: In case multiple TLD-s map to the same tag library URI, now <code>WEB-INF/**/*.tld</code>-s has priority over <code>META-INF/**/*.tld</code>-s coming from jar-s or classpath directories. Earlier, it was the other way around, except that <code>META-INF/lib/*.tld</code>-s could still take precedence randomly. While the JSP specification (2.2) explicitly states that the order is not defined and shouldn't be relied upon, it's just logical that if someone puts a TLD directly under <code>WEB-INF</code>, he meant that to be used in that particular web application, rather than the TLD-s coming from the dependency jars which are often shared by multiple web applications.</p></li>
<li><p>Bug fixed: Defaults set in an overridden <code>FreemarkerServlet.createConfiguration</code> won't be accidentally overwritten by <code>FreemarkerServlet</code>'s factory defaults anymore. This was a problem with theses settings only: <code>template_exception_handler</code>, <code>log_template_exceptions</code>, <code>object_wrapper</code>, <code>template_loader</code>.</p></li>
<li><p>Bug fixed: If you had multiple <code>FreemarkerServlet</code>-s with different configuration settings in the same servlet context, that could lead to malfunction. (Normally, you only have one, just like there's only one servlet that processes <code>*.jsp</code>.)</p></li>
<li><p>Removed all the <code>xsd</code> files (<code>web-app</code> and <code>taglib</code> schemas) from the FreeMarker artifact and from the XML entity resolver, as they were unused during XML parsing.</p></li>
<li><p>Generally improved implementation quality (maintainability, error messages, performance bug fixes, test coverage) and better API documentation.</p></li>
</ul></li>
<li><p>Logging facility improvements:</p>
<ul>
<li><p>Just like earlier, when auto-selecting the logger library (the default behavior), FreeMarker choses Log4j if it's available. But now, if that turns out to be <code>log4j-over-slf4j</code>, FreeMarker will use SLF4J directly instead. (This fixes the issue where the logged location points to FreeMarker's log adapter class instead of the real call place.)</p></li>
<li><p>FreeMarker now recognizes the <code>org.freemarker.loggerLibrary</code> system property, which specifies which logger to use, like <code>java ...
                  -Dorg.freemarker.loggerLibrary=SLF4J</code>. This option deprecates <code>Logger.selectLoggerLibrary(int)</code> as that was inherently unreliable (because you usually can't control class initialization order very well). The system property has precedence over <code>Logger.selectLoggerLibrary</code>.</p></li>
<li><p>Generally improved implementation quality (more info printed when something fails, etc.).</p></li>
<li><p>New configuration setting: <code>log_template_exceptions</code> (<code>Configuration.setLogTemplateExceptions(boolean)</code>). This specifies if <code>TemplateException</code>-s thrown by template processing are logged by FreeMarker or not. The default is <code>true</code> for backward compatibility, but that results in logging the exception twice in properly written applications, because there the <code>TemplateException</code> thrown by the public FreeMarker API is also logged by the caller (even if only as the cause exception of a higher level exception). Hence, in modern applications it should be set to <code>false</code>. (Note that this setting has no effect on the logging of exceptions caught by <code>#attempt</code>/<code>#recover</code>; those are always logged.)</p></li>
</ul></li>
<li><p><code>Environment</code> and custom directive related improvements:</p>
<ul>
<li><p>Added <code>Environment.getCurrentDirectiveCallPlace()</code>, which returns a <code>DirectiveCallPlace</code> object when called from a custom directive (i.e., from <code>TemplateDirectiveModel.execute()</code>). The <code>DirectiveCallPlace</code> objects lets you associate an arbitrary object to the directive invocation inside the template, which can be used for call-place-bound caching (like the minification of non-dynamic nested content). See <code>DirectiveCallPlace</code> in the Java API documentation for more.</p></li>
<li><p>Added <code>Environment.getMainTemplate()</code>. Deprecated the ambiguous (and often broken: [<a href="https://sourceforge.net/p/freemarker/bugs/145/">145</a>]) <code>Environment.getTemplate()</code>.</p></li>
</ul></li>
<li><p>Template loading:</p>
<ul>
<li><p>Added new <code>Configuration</code> setting, <code>template_lookup_strategy</code> (<code>Configuration.setTemplateLookupStrategy(TemplateLookupStrategy)</code>). This allows customizing what <code>TemplateLoader</code>-level names will be tried when a template is requested. With this you can, for example, define a custom localized lookup sequence instead of the default (which looks like: <code>foo_de_LU_MAC.ftl, foo_de_LU.ftl,
                  foo_de.ftl,</code><code> foo.ftl</code>).</p></li>
<li><p>Added new <code>Configuration.getTemplate(...)</code> parameter, <code>Object customLookupCondition</code>. This parameter can be used by custom a <code>TemplateLookupStrategy</code> to deduce the actual template name(s) from the requested name (similarly to as the default lookup strategy does that based on the locale). For example, on a multi-domain Web site, one may want to define some templates that are specialized to a domain, and thus use the domain name as the custom lookup condition. Then, when <code>foo.ftl</code> is requested, a custom <code>TemplateLookupStrategy</code> could first look for <code>@somedomain.com/foo.ftl</code>, and then for <code>@default/foo.ftl</code>. See the JavaDoc of the relevant <code>Configuration.getTemplate(...)</code> overload for more details; note there the requirements regarding the <code>hashCode</code> and <code>equals</code> of the <code>customLookupCondition</code>.</p></li>
<li><p>Added new <code>Configuration</code> setting, <code>template_name_format</code> (<code>Configuration.setTemplateNameFormat(TemplateNameFormat)</code>). This allows specifying the naming rules used by FreeMarker. For now, custom implementations aren't allowed, and you can only chose between <code>TemplateNameFormat.DEFAULT_2_3_0</code> (the default) and <code>DEFAULT_2_4_0</code> (recommended, at least for new projects). <code>DEFAULT_2_4_0</code> has several advantages, but isn't fully backward compatible (though most applications won't be affected). For typical mistakes like using backslash instead of slash, or backing out of the root, it gives <code>MalformedTemplateNameFormatException</code> instead of <code>TempalteNotFoundException</code>. It allows scheme names to be terminated with <code>:</code> alone, instead of a <code>://</code> (which is also supported), like in <code>classpath:foo/bar.ftl</code>. It fixes numerous legacy glitches (bugs), mostly related to the interpretation of <code>..</code> after special steps like <code>.</code> or <code>*</code>. See the full list of differences in the <a href="http://freemarker.org/docs/api/freemarker/cache/TemplateNameFormat.html#DEFAULT_2_4_0">Java API documentation of <code>TemplateNameFormat.DEFAULT_2_4_0</code></a>.</p></li>
<li><p><code>ClassTemplateLoader</code> now can be created by specifying a <code>ClassLoader</code> directly, rather than by specifying a base <code>Class</code>. That is, now there's <code>ClassTemplateLoader(ClassLoader, String)</code> constructor, and also a <code>Configuration.setClassLoaderForTemplateLoading(ClassLoader,
                  String)</code> method.</p></li>
<li><p>Added new exception, <code>TemplateNotFoundException</code>, which is now used instead of <code>TemplateNotFoundException</code> when getting a template. As it extends <code>TemplateNotFoundException</code>, this change is backward compatible. The main goal was to counter the common misunderstanding that template paths are real file paths. However, the new exception also has the benefit that it can give additional FreeMarker-specific information about the error, like right now it has <code>getTemplateName()</code> and <code>getCustomLookupCondition()</code> methods.</p></li>
<li><p><code>Template</code>-s now have a <code>getSourceName()</code> method, in additionally to <code>getName()</code>. These two return the same as far as no localized lookup or acquisition (<code>*</code> in the name) or other lookup strategy was actively involved. But when it was, <code>getSourceName()</code> gives the name with which the template was actually loaded from the <code>TemplateLoader</code>, while <code>getName()</code> returns (and had always returned) the name with which the template was requested (in canonicalized form). <code>getName()</code> is used for everything (like for relative inclusion resolution), except for location information in error messages, which now uses <code>getSourceName()</code>. Also, <code>TemplateException</code> now has a <code>getSourceName()</code> method.</p></li>
<li><p><code>Configuration.getTemplate(...)</code> overloads now accept <code>null</code> for the <code>locale</code> and <code>encoding</code> parameters, in which case they use the same defaults as the overloads where the parameter is omitted.</p></li>
<li><p>Debugger SPI implementators, attention: The <code>DebugBreak</code> instruction will now send the <code>sourceName</code> of the template to the <code>suspendEnvironmentSpi</code> callback, rather than its <code>name</code>. You should also use the <code>sourceName</code> in <code>registerTemplateSpi</code> and such, not the <code>name</code>.</p></li>
</ul></li>
<li><p>Configuration:</p>
<ul>
<li><p>Added <code>Configuration.unsetXxx</code> and <code>isXxxExplicitlySet</code> methods for several settings. Unsetting a setting makes it behave as if <code>setXxx</code> was never called, thus the setting will use the default value that fits the current <code>incompatible_improvements</code> value and will be adjusted as <code>incompatible_improvements</code> is changed later.</p></li>
<li><p>When configuring FreeMarker from <code>java.util.Properties</code> (or with <code>String</code>-<code>String</code> name-value pairs in general):</p>
<ul>
<li><p>The <code>default</code> setting value is now recognized by <code>template_exception_handler</code>, <code>template_storage</code>, <code>template_loader</code> (and by the new <code>template_lookup_strategy</code> and <code>template_name_format</code>) settings, and it causes <code>Configuration.unsetXxx()</code> to be called.</p></li>
<li><p>Bug fixed: When setting <code>object_wrapper</code> to <code>default</code> (as opposed to not specifying it), it has ignored the <code>incompatible_improvements</code> and has always used <code>ObjectWrapper.DEFAULT_WRAPPER</code>. This fix only matters when <code>incompatible_improvements</code> is exactly 2.3.21, as that's when the default object wrapper was changed from <code>ObjectWrapper.DEFAULT_WRAPPER</code> to the result of <code>new
                      DefaultObjectWrapperBuilder(Configuration.VERSION_2_3_21).build()</code>, which is a bit different singleton, as it has read-only configuration settings and bug fixed overloaded method selection rules. To use <code>ObjectWrapper.DEFAULT_WRAPPER</code> regardless of the value of the <code>incompatible_improvements</code> setting, use the new <code>default_2_3_0</code> value.</p></li>
</ul></li>
<li><p>Bug fixed: Changing the value of the <code>localized_lookup</code> setting now empties the template cache, so that old lookup results won't be reused. (This of course only matters if you change this setting under an already running service, which is very unlikely.)</p></li>
</ul></li>
<li><p>Miscellaneous:</p>
<ul>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/145/">145</a>], active only with <code>incompatible_improvements</code> set to 2.3.22 (or higher): <code>#include</code> and <code>#nested</code> doesn't change the parent <code>Template</code> (see <code>Configurable.getParent()</code>) of the <code>Environment</code> anymore to the <code>Template</code> that's included or where <code>#nested</code> “returns” to. Thus, the parent of <code>Environment</code> will be now always the main <code>Template</code>. (The main <code>Template</code> is the <code>Template</code> whose <code>process</code> or <code>createProcessingEnvironment</code> method was called to initiate the output generation.) Note that this only matters if you have set settings directly on <code>Template</code> objects (not to be confused with setting settings in templates via <code>#setting</code>, which just modifies the <code>Environment</code>, and so isn't affected by this fix), and almost nobody does that. Also note that macro calls have never changed the <code>Environment</code> parent to the <code>Template</code> that contains the macro definition, so there's no change there now.</p></li>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/419/">419</a>]: FreeMarker doesn't fail anymore when it has no permission to read Java system properties, like when used in unsigned applets. It just logs some warnings.</p></li>
<li><p><code>HTML_DEBUG</code> and <code>DEBUG</code> <code>TemplateExceptionHandler</code> output now contains a warning like “HTML_DEBUG mode; use RETHROW in production!”, due to frequent misuse.</p></li>
<li><p>Some fixes and improvements in template canonical form output, and as a consequence of that, in FTL stack trace instruction displaying.</p></li>
<li><p>Marked some historically public but otherwise internal API-s as deprecated, so that the disclaimer is more apparent in IDE-s.</p></li>
</ul></li>
</ul>
<h3>Notes</h3>
<p>The consequences and reasons of introducing adapter approach for container types in <code>DefaultObjectWrapper</code> when its incompatibleImprovements is set to 2.3.22:</p>
<ul>
<li><p>With the new approach (the adapter approach), the key order of <code>Map</code>-s is never lost. The copying approach could only keep that for <code>HashMap</code> subclasses (such as <code>LinkedHashMap</code>) and <code>SortedMap</code>-s (such as <code>TreeMap</code>), but not for more exotic <code>Map</code>-s, like Guava's <code>ImmutableMap</code>. Also, any other behavioral peculiarities of the original <code>Map</code> (e.g., case insensitive key lookup) is kept now.</p></li>
<li><p>The exact type and identity of the <code>Map</code>/<code>List</code> is kept when the wrapped value is passed back to a Java method from the template. With the legacy approach the Java methods have received a <code>Map</code> or <code>List</code> of a special FreeMarker specific type (that acted as an adapter for the <code>TemplateModel</code>).</p></li>
<li><p>Performance characteristics change, mostly for the better, but it depends on the application. If the template reads the <em>same(!)</em> entry <em>from the data model</em> roughly once or twice (or not at all), which is typical, them the adapter approach gives better results, otherwise the legacy copying approach is faster (as it can reuse the wrapped entry from the previous read), though this slowdown certainly not a concern for most applications. The performance of the new adapter approach is more predictable, because it has no initial “spike” to set up the container copy (especially painful for huge collections), instead the performance is linearly proportional to the number of data model reads (and not to the number of collection entries).</p></li>
<li><p>If the <code>Map</code>/<code>List</code>/array is changed after it was wrapped, the change will now become visible in the data-model. With the copying approach, the wrapped value was a shallow-snapshot of the original <code>Map</code>/<code>List</code>/array. While it's unlikely that someone has deliberately utilized this, it's a risk factor when switching to adapters.</p></li>
<li><p>It's theoretically possible that some code (mostly <code>TemplateDirectiveModel</code> implementations) mistakenly assumed that wrapped <code>Map</code>-s are <code>SimpleHash</code>-es, and wrapped <code>List</code>-s are <code>SimpleSequence</code>-s, etc., instead of them just being <code>TemplateHashModel</code>-s and <code>TemplateSequenceModel</code>-s. Such code was always wrong, but now it will indeed break, so it's a risk factor.</p></li>
<li><p>As now the exact type of the wrapped original object is used for overloaded method selection, the choice can be different (and similar to what it would be with pure <code>BeansWrapper</code>). It's difficult to find cases where this matters. A change is most probable around arrays, as with the copying approach they were unwrapped to <code>List</code>-s, not to the original array. As the overloaded method mechanism can convert between arrays and lists (in both directions), it's usually not a problem. But, it doesn't do conversion between different array types when the overloaded method has various types on the parameter position of the array, so that's a risk factor.</p></li>
<li><p><code>SimpleHash</code> and <code>SimpleSequence</code> haven't become deprecated. They are still used for hashes and sequences created in FTL, and are recommended for values that are built specifically to be used from templates, rather than wrapping an already existing <code>Map</code> or <code>List</code> or array.</p></li>
<li><p><code>List</code>-s and <code>Map</code>-s that are exposed to templates in multiple threads are now under greater stress regarding their correct operation under multi-threaded read-only access. This is because the adapters won't copy their contents into well known <code>List</code> and <code>Map</code> implementations (<code>HashMap</code>, <code>ArrayList</code>, etc.) before accessing them from multiple threads. So this is mostly a concern with custom <code>List</code> and <code>Map</code> implementations, which aren't as mature as the standard Java classes. Note that this was always like so with pure <code>BeansWrapper</code>, which is used by a lot of projects/frameworks (like by Struts) for a long time, so it's not an uncharted territory.</p></li>
<li><p>When the wrapped <code>List</code> is a <code>AbstractSequentialList</code> (like a <code>LinkedList</code>), the resulting adapter will implement <code>TemplateCollectionModel</code> for more efficient enumeration (<code>#list</code>-ing), in additionally to <code>TemplateSequenceModel</code> of course. <code>TemplateCollectionModel</code> allows FTL to traverse the list without accessing elements by index. With the legacy copying approach <code>TemplateCollectionModel</code> wasn't implemented as it wasn't needed for efficient enumeration there.</p></li>
<li><p>Iterators (when you put them directly into the data-model) are wrapped into <code>DefaultIteratorAdapter</code> instead of <code>SimpleCollection</code>. This has two consequences:</p>
<ul>
<li><p>The wrapped <code>Iterator</code> is now unwrapped properly to the original Java object when it's passed to Java method from the template.</p></li>
<li><p>Wrapped <code>Iterator</code>-s (not to be confused with <code>Iterable</code>) aren't thread-safe anymore, to spare some synchronizations, after all, exposing the same <code>Iterator</code> to multiple parallel template executions doesn't make much sense. This shouldn't be a migration concern, as even earlier, only one of those template executions could succeed (the “content” of <code>Iterator</code>-s wasn't copied, so the one who first accessed it become the exclusive owner). The change is just that earlier it was guaranteed that the other threads will fail (that was the thread-safe about it), while now there are no such guarantees.</p></li>
</ul></li>
</ul>
<h2 id="versions_2_3_21">2.3.21</h2>
<p>Date of release: 2014-10-12</p>
<p>Note that since 2.3.21 is designed to be fully backward compatible with the previous 2.3.x releases, <em>some of the improvements and fixes described below are only activated when you specifically ask for 2.3.21 “incompatible improvements”</em>, because they could, with very small chance, break existing applications. If the dependent project is still actively developed, allowing 2.3.21 &quot;incompatible improvements&quot; is highly recommended. See <a href="#pgui_config_incompatible_improvements_how_to_set">how to set “incomplatible improvements” here</a>.</p>
<p>Note that we have changed our proprietary BSD-style license to Apache License, Version 2.0. See the <a href="#app_license">new license here</a>.</p>
<p>Note that the minimum required Java version was increased from 1.2 to 1.4.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Improved ranges:</p>
<ul>
<li><p>Added ranges with exclusive end: <code>start..&lt;end</code> (also can be written as <code>start..!end</code>). <a href="#dgui_template_exp_direct_ranges">More...</a></p></li>
<li><p>Added length limited ranges: <code>start..*length</code>: For example, <code>10..*4</code> gives <code>[10,
                  11, 12, 13]</code>, <code>10..*-4</code> gives <code>[10, 9, 8, 7]</code>, and <code>10..*0</code> gives <code>[]</code>. When these kind of ranges are used for slicing, the slice will end without error if the end of the sliced sequence or string is reached before the specified range length was reached. Thus, for example, to take the first 10 characters from the string <code>s</code>, or less if <code>s</code> is shorter than 10 characters, you can use <code>s[0..*10]</code>. <a href="#dgui_template_exp_seqenceop_slice">More...</a></p></li>
<li><p>Square bracket now accepts range values from any source, like <code>&lt;#assign r = 1..3&gt;
                  ${'foobar'[r]}</code> will print <code>&quot;oob&quot;</code>. Earlier it has only supported ranges that were specified directly inside the square brackets, like <code>'foobar'[1..3]</code>.</p></li>
<li><p>When slicing a sequence with a right-unbounded range, it's now allowed to have a range start index that's one higher than the last index of the sliced sequence. For example, <code>['x', 'y'][2..]</code> is not an error anymore, but an empty sequence. (Of course, <code>['x',
                  'y'][3..]</code> is still an error.)</p></li>
<li><p><code>someString?substring(from,
                  toExclusive)</code> and <code>someString?substring(from)</code> are now deprecated; use this slicing expression instead: <code>someString[from..&lt;toExclusive]</code> and <code>someString[from..]</code>. A warning if you are processing XML: Since slicing expressions work both for sequences and strings, and XML nodes in FTL are typically both sequences and strings at the same time, there the equivalent expression is <code>someXmlNode?string[from..&lt;toExclusive]</code> and <code>exp?string[from..]</code>, because without the <code>?string</code> it would slice the node sequence instead of the text value of the node.</p></li>
<li><p>If the <code>incompatible_improvements</code> in the FreeMarker configuration is set to at least 2.3.21, right-unbounded ranges become readable (like <code>#list</code>-able). Earlier they could only be used for slicing, and behaved like empty sequences otherwise.</p></li>
</ul></li>
<li><p>New built-in, <code>?url_path</code>: This is the same as <a href="#ref_builtin_url">the <code>url</code> built-in</a>, except that it doesn't escape slash (<code>/</code>) characters. This meant to be used for converting paths (like paths coming from the OS or some content repository) that use slash (not backslash!) to a path the can be inserted into the path part of an URL.</p></li>
<li><p>New built-ins for string manipulation:</p>
<ul>
<li><p><code>someString?keep_before(substring[,
                  flags])</code>: <a href="#ref_builtin_keep_before">More...</a></p></li>
<li><p><code>someString?keep_after(substring[,
                  flags])</code>: <a href="#ref_builtin_keep_after">More...</a></p></li>
<li><p><code>someString?remove_beginning(substring)</code>: <a href="#ref_builtin_remove_beginning">More...</a></p></li>
<li><p><code>someString?remove_ending(substring)</code>: <a href="#ref_builtin_remove_ending">More...</a></p></li>
<li><p><code>someString?ensure_starts_with(substring[,
                  substitution[,
                  flags]])</code>: <a href="#ref_builtin_ensure_starts_with">More...</a></p></li>
<li><p><code>someString?ensure_ends_with(substring)</code>: <a href="#ref_builtin_ensure_ends_with">More...</a></p></li>
</ul></li>
<li><p><code>someString?number</code> now recognizes all XML Schema number formats, like <code>NaN</code>, <code>INF</code>, <code>-INF</code>, plus the Java-native formats <code>Infinity</code> and <code>-Infinity</code>.</p></li>
<li><p>If <code>incompatible_improvements</code> in the FreeMarker configuration is set to at least 2.3.21, <code>someNumber?c</code> will return <code>&quot;INF&quot;</code>, <code>&quot;-INF&quot;</code> and <code>&quot;NaN&quot;</code> for positive/negative infinity and IEEE floating point Not-a-Number, respectively. These are the XML Schema compatible representations of these special values. Earlier it has returned what <code>java.text.DecimalFormat</code> did with US locale, none of which was understood by any (common) computer language.</p></li>
<li><p>New built-in: <code>someString?boolean</code>. This is for example useful for converting &quot;true&quot; and &quot;false&quot; strings coming from XML to real boolean values. <a href="#ref_builtin_boolean">More...</a></p></li>
<li><p>Date/time/date-time related changes:</p>
<ul>
<li><p>Added new kind of <code>date_format</code>/<code>datetime_format</code>/<code>time_format</code> setting values: XML Schema formats, starting with <code>&quot;xs&quot;</code> and ISO 8601:2004 formats, starting with <code>&quot;iso&quot;</code>. The format string can be continued with various space (or <code>_</code>) separated options, like <code>h</code> or <code>m</code> or <code>s</code> or <code>ms</code> for setting shown accuracy, <code>nz</code> or <code>fz</code> for setting time zone offset visibility, and <code>u</code> or, <code>fu</code> for using UTC time zone . For example, to use ISO 8601 with minute precision and without the zone offset being shown, set the <code>datetime_format</code> setting to <code>&quot;iso
                  m nz&quot;</code>, so then the output will be like <code>2014-09-03T20:56</code>. <a href="#topic.dateTimeFormatSettings">More...</a></p></li>
<li><p>Because anything that's accepted as <code>date_format</code>/<code>datetime_format</code>/<code>time_format</code> setting value can also be used with the <code>?string</code> and <code>?date</code>/<code>?time</code>/<code>?datetime</code> build-ins, you can use the new formats like <code>someDate?string.xs</code> and <code>someString?date.xs</code>. (For the <code>&quot;xs&quot;</code> and <code>&quot;iso&quot;</code> formats, <code>_</code> can be used instead of space, which means that, for example, you can write <code>lastModified?string.iso_m_u</code> instead of the more verbose <code>lastModified?string[&quot;iso m
                  u&quot;]</code>.)</p></li>
<li><p>That <code>&quot;iso&quot;</code> and <code>&quot;xs&quot;</code> are now possible <code>date_format</code>/<code>datetime_format</code>/<code>time_format</code> setting values also means that such values can now be parsed too via <code>?date</code>/<code>?time</code>/<code>?datetime</code>. The main application is with processing XML DOM-s, as there values are coming in as strings, and now you can do something like <code>order.confirmDate?date.xs</code> to convert them to real dates.</p></li>
<li><p>The <a href="#ref_builtin_date_iso"><code>?iso_...</code> built-ins</a> are now deprecated in favor of the new setting values described above. They can be set as the default date/time/date-time format, seamlessly fit into the formatting architecture (and thus can parse strings too), and has more/better options (<code>ms</code> always shows 3 millisecond digits, <code>fz</code> for forcing showing time zone offset).</p></li>
<li><p>If the “incompatible improvements” configuration setting is at least 2.3.21, the <code>?iso_...</code> built-ins won't show time zone offset for <code>java.sql.Time</code> values anymore. Most databases store time values that aren't in any time zone, but just store hour, minute, second, and decimal second field values, so showing the time zone doesn't make sense. (Notable exceptions are PostgreSQL &quot;time with time zone&quot; columns, where <code>mzTime?string.iso_fz</code> could be used.)</p></li>
<li><p>Added <code>?is_time</code>, <code>?is_datetime</code>, <code>?is_date_only</code> (should be called <code>?is_date</code>, but that was already taken) and <code>?is_unknown_date_like</code> to check the exact type of a date-like value.</p></li>
<li><p><code>?is_date</code> is now a deprecated name, use <code>?is_date_like</code> instead. This is because <code>?is_date</code> sounds like it checks if the value is a date without time part, but actually it also returns <code>true</code> for time, date-time, and unknown date-like values.</p></li>
<li><p>Added <code>?date_if_unknown</code>, <code>?time_if_unknown</code> and <code>?datetime_if_unknown</code> built-ins, which mark a date-like value with some of the sub-types: date without time, time, or date-time, respectively. However, if the value already holds this information, the built-in has no effect. That is, it will never convert the sub-type of a value, it only adds the sub-type if it was unknown.</p></li>
<li><p>Bug fixed: ISO 8601 dates (via <code>?iso_...</code> and <code>&quot;iso&quot;</code> format settings) now use proleptic Gregorian calendar for the years before 1582, rather than Julian calendar. This is (indirectly) required by the standard, and it's also how the default Sun/Oracle Java XML Schema date/time/dateTime parser works.</p></li>
</ul></li>
<li><p>Error message quality improvements (targeting frequent support requests and some error message bugs):</p>
<ul>
<li><p>Fixed glitch where if an <code>#if</code> had and <code>#else</code> or <code>#elseif</code>, the <code>#if</code>/<code>#else</code>/<code>#elseif</code> wasn't hidden in the FTL stack trace when the error was inside its nested block.</p></li>
<li><p>Some new context sensitive hints in undefined variable exception error messages.</p></li>
<li><p>Fixed unclosed directive error messages at end of file where the wrong unclosed directive name was reported</p></li>
<li><p>Better type error messages when accessing XML data (applies when wrapped with <code>freemarker.ext.dom</code>):</p>
<ul>
<li><p>Trying to use <code>node.noSuchChildNodes</code> on a place where scalar value is expected will explain that the problem is that you had no matches in the constructing XML query.</p></li>
<li><p>Trying to use <code>node.multipleSuchChildNodes</code> on a place where scalar value is expected will explain that the problem is that you had multiple matches in the constructing XML query.</p></li>
<li><p>Trying to use <code>node.exactlyOneChildNode</code> as number, date/time/date-time or boolean will explain that values coming from XML are always strings (text), and must be converted explicitly via <code>?number</code>, <code>?boolean</code>, <code>?date.xs</code>, etc.</p></li>
</ul></li>
<li><p>Trying to use <code>obj.someMethod</code> without <code>()</code> on a place where method value is not expected will recommend calling the method.</p></li>
<li><p>Trying to use methods like <code>obj.getFoo</code> or <code>obj.isFoo</code> without <code>()</code>on a place where method value is not expected will recommend using the <code>obj.foo</code> form.</p></li>
<li><p>Messages are now much more readable when rendered in environments that don't obey to line-breaks. (This often happens in improperly implemented HTML error pages and logs viewers.)</p></li>
<li><p>Better FTL instruction stack traces:</p>
<ul>
<li><p>Error messages now contain up to 10 lines of FTL stack trace (unless it's on the top of a full FTL stack trace), because the FTL stack trace wasn't printed at all when the exception was a cause exception in a Java stack trace, or when only the value of <code>getMessage()</code> was printed instead of a stack trace.</p></li>
<li><p>The FTL stack trace is now more self explanatory as it contains more text labels.</p></li>
<li><p>Stack frames that belong to nestings are now marked differently, and are filtered out when the stack trace wouldn't fit into the error message otherwise.</p></li>
</ul></li>
<li><p>Bug fixed: <code>?substring</code> has thrown low level <code>java.lang.IndexOutOfBoundsException</code>-s instead of more descriptive <code>TemplateModelException</code>-s with FTL stack trace.</p></li>
<li><p>Bug fixed: Slicing with ranges sometimes thrown low level <code>java.lang.IndexOutOfBoundsException</code>-s instead of more descriptive <code>TemplateModelException</code>-s with FTL stack trace.</p></li>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/402/">402</a>]: Fixed misleading parser error message when a directive called without its required parameters (like <code>&lt;#list&gt;</code>) was reported as unknown directive.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/222/">222</a>]: Poor quality error message when <code>someString[someIndex]</code> fails with string index out of bounds.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/27/">27</a>]: Not very good quality error messages when <code>#import</code>-ing a template whose parsing fails.</p></li>
</ul></li>
<li><p>New <code>include</code> directive option, <code>ignore_missing=boolean</code>. When this is set to <code>true</code>, and the template to include is missing, the error will be silently ignored, and nothing will be included.</p></li>
<li><p>The <code>setting</code> directive can now set the <code>output_encoding</code> setting.</p></li>
<li><p>New special variable: <code>.locale_object</code>. This is like <code>.locale</code>, except that it's a <code>java.util.Locale</code> object, not a string. This is handy if you want to pass the current locale to Java methods.</p></li>
<li><p>If <code>incompatible_improvements</code> in the FreeMarker configuration is set to at least 2.3.21, hash <em>literals</em> that repeat keys now only have the key once with <code>?keys</code>, and only has the last value associated to that key with <code>?values</code>. This is consistent with the behavior of <code>hash[key]</code> and how maps work in Java.</p></li>
<li><p>Bug fixed: <code>?is_enumerable</code> has returned <code>true</code> for Java methods get from Java objects, despite that those values aren't <code>&lt;#list
              ...&gt;</code>-able. (This is actually a historical quirk of <code>BeansWrapper</code>, not a bug in <code>?is_enumerable</code>, but now <code>?is_enumerable</code> is aware of this exceptional case.)</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/257/">257</a>]: The result value of <code>?matches</code> wasn't “reentrant”. For example, you couldn't list the matches inside another listing where you are also listing exactly the same result value (stored in a common variable), as they would consume from the same iterator. Most importantly, even accessing the <code>?size</code> of the same result value has terminated the outer listing of the same value.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/229/">229</a>]: If you set <code>incompatible_improvements</code> to 2.3.21 (or higher), unclosed comments (<code>&lt;#--
              ...</code>) and <code>#noparse</code>-s won't be silently closed at the end of template anymore, but cause a parsing error instead.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Added new <code>Configuration</code> constructor, <code>Configuration(Version
              incompatibleImprovements)</code>. This deprecates the vague <code>Configuration()</code> constructor, and makes using <code>setIncompatibleImprovements(Version)</code> needless in most cases. See an example <a href="#pgui_quickstart_createconfiguration">here...</a></p></li>
<li><p>When setting the <code>incompatible_improvements</code> setting (like with the constructor above) to 2.3.21, two setting defaults change:</p>
<ul>
<li><p>The default of the <code>object_wrapper</code> setting (<code>Configuration.getObjectWrapper()</code>) changes from <code>ObjectWrapper.DEFAULT_WRAPPER</code> to another almost identical <code>DefaultObjectWrapper</code> singleton, returned by <code>new
                  DefaultObjectWrapperBuilder(Version).build()</code>. The new default object wrapper's “incompatible improvements” version is set to the same as of the <code>Configuration</code>. (See later regarding the 2.3.21 “incompatible improvements” of <code>BeansWrapper</code> and <code>DefaultObjectWrapper</code>). Furthermore, the new default object wrapper doesn't allow changing its settings; setter methods will throw <code>IllegalStateException</code>. (If anything tries to call setters on the old default in your application, that's a dangerous bug that won't remain hidden now. As the old default is a singleton too, potentially shared by independently developed components, most of them expects the out-of-the-box behavior from it (and the others are necessarily buggy). Also, then concurrency glitches can occur (and even pollute the class introspection cache) because the singleton is modified after publishing.)</p></li>
<li><p>The default of the <code>template_loader</code> setting (<code>Configuration.getTemplateLoader()</code>}) changes to <code>null</code>, which means that FreeMarker will not find any templates. Earlier the default was a <code>FileTemplateLoader</code> that used the current directory as the root. This was dangerous and fragile as you usually don't have good control over what the current directory will be. Luckily, the old default almost never looked for the templates at the right place anyway, so pretty much all applications had to set <code>template_loader</code>, so it's unlikely that changing the default breaks your application.</p></li>
</ul></li>
<li><p>New <code>BeansWrapper</code>, <code>DefaultObjectWrapper</code> and <code>SimpleObjectWrapper</code> constructor that takes a <code>Version</code> <code>incompatibleImprovements</code> argument. This has the same role as the <code>incompatible_improvements</code> setting of the <code>Configuration</code>, but it applies to the <code>ObjectWrapper</code> instead. (As <code>ObjectWrapper</code>-s are often shared among multiple <code>Configuration</code>-s, so they can't use that setting of the <code>Configuration</code>.) In new or actively developed projects it's recommended to use <code>Configuration.VERSION_2_3_21</code> now. The constructor without the <code>Version</code> parameter is now deprecated.</p></li>
<li><p>Safer and more memory-efficient way of managing singletons of <code>DefaultObjectWrapper</code>-s and <code>BeansWrapper</code>-s that are possibly shared by independently developed subsystems:</p>
<ul>
<li><p>Instead of <code>new
                  DefaultObjectWrapper(...)</code> and <code>new
                  BeansWrapper(...)</code>, from now on you should use <code>new
                  DefaultObjectWrapperBuilder(version).build()</code> and <code>new BeansWrapperBuilder(version).build()</code>. (The builder objects have properties (configuration settings) like <code>BeansWrapper</code> has, which specify the properties of the objects created.) The created objects are <em>singletons</em> (VM-wide, or at least Web-Application-wide) and read-only (means, non-configurable, hence safe to share). The main benefit of using these factories instead of creating new instances is that it allows FreeMarker to share the class introspection caches (an internal part of <code>BeansWrapper</code>-s/<code>DefaultObjectWrapper</code>-s that is expensive to populate) among the returned instances. This allow sharing the caches (and the object wrappers) between components that aren't aware of each other and use FreeMarker internally.</p></li>
<li><p>Deprecated the static fields <code>ObjectWrapper.DEFAULT_WRAPPER</code>, <code>BEANS_WRAPPER</code> and <code>SIMPLE_WRAPPER</code>, because these <code>ObjectWrapper</code>-s are configurable (not read-only), and thus dangerous to use as singletons (a badly behaving 3rd party component can mess them up). Use the factories described above instead. They are also more flexible, as you can specify the desired incompatible-improvements version for them and various other <code>BeansWrapper</code> settings.</p></li>
<li><p>Deprecated all <code>SimpleHash</code>, <code>SimpleCollection</code> and <code>SimpleSequence</code> constructors that didn't take an <code>ObjectWrapper</code> argument, as they have usually used <code>ObjectWrapper.DEFAULT_WRAPPER</code> as the default, which itself is deprecated.</p></li>
<li><p><code>BeansWrapper</code>, <code>DefaultObjectWrapper</code> and <code>SimpleObjectWrapper</code> now implements the <code>freemarker.template.utility.WriteProtectable</code> interface with which the configuration properties of the object wrapper can be set permanently to read-only by calling <code>writeProtect()</code>. An attempt to call a setter on a such <code>ObjectWrapper</code> will immediately cause <code>IllegalStateException</code>. (This is what's used for the singletons returned by the <code>getInstance</code> methods too; see earlier).</p></li>
</ul></li>
<li><p>The value of the <code>time_zone</code> setting, when you specify it with a <code>String</code> (in a <code>java.util.Properties</code> object, or via <code>&lt;#setting
              ...&gt;</code>) can now be <code>&quot;JVM default&quot;</code> to use the JVM default time zone. The JVM default is the default value of that setting anyway, but now you can state this explicitly, or restore this value if it was overridden earlier.</p></li>
<li><p>Added new configuration setting, <code>sql_date_and_time_time_zone</code> (<code>Configurable.setSQLDateAndTimeTimeZone(TimeZone)</code>). When this is set to non-<code>null</code>, the time zone used when dealing with <code>java.sql.Date</code> and <code>java.sql.Time</code> values will be this time zone instead of the value of the <code>time_zone</code> FreeMarker configuration setting. This is useful because JDBC will, usually, construct the Java <code>Date</code> objects so that they will show the year-month-day and hour-minute-seconds values from the database “as is” if you render them using the JVM default time zone. As time zone conversions for SQL date-only and SQL time-only values doesn't make much sense (unlike for SQL timestamps), you should certainly set this setting to the JVM default time zone (<code>TimeZone.getDefault()</code>, or if you configure FreeMarker via <code>java.util.Properties</code>, as property value &quot;JVM default&quot;). The default value is <code>null</code> for backward compatibility. For more details see the JavaDoc of <code>Configurable.setSQLDateAndTimeTimeZone(TimeZone)</code>.</p></li>
<li><p>When configuring FreeMarker with <code>java.util.Properties</code> (typically, when the configuration is stored in a <code>.properties</code> file), for the settings where you could specify a fully qualified class name (most notably for the <code>object_wrapper</code> setting) now you can also specify constructor arguments and JavaBean property assignments. For example, now you can write <code>object_wrapper=com.example.MyObjectWrapper(1, 2,
              exposeFields=true, cacheSize=5000)</code>that's nearly equivalent with this Java code: <code>obj = new
              com.example.MyObjectWrapper(1, 2); obj.setExposeFields(true);
              obj.setCacheSize(5000); object_wrapper = obj;</code>. If you are using this new syntax (i.e., if you have parentheses after the class name, even if they are empty), and there's a builder class for the requested class, that will be automatically used. For example, <code>object_wrapper=DefaultObjectWrapper(2.3.21)</code> will create a <code>DefaultObjectWrapperBuilder</code> to build the final instance, thus the object wrapper will be a singleton instead of a new instance. The new syntax will also look for a public static <code>INSTANCE</code> field if there are 0 arguments and property assignments. For more details see the Java API documentation of <code>Configuration.setSetting</code>.</p></li>
<li><p>Template not found exceptions now explain that the template path is interpreted by a template loader, and show the <code>toString</code> of the <code>TemplateLoader</code>. The out-of-the-box <code>TemplateLoader</code> implementations now have an overridden <code>toString</code> to show the actual base directory and such details. Custom <code>TemplateLoader</code> implementations are encouraged to override <code>toString</code>.</p></li>
<li><p>Added <code>Configuration.setSharedVariables(Map/*&lt;String,
              Object&gt;*/)</code> for setting the shared variables from Spring IoC and other IoC solutions. The already existing <code>Configuration.setSharedVariable(String,
              Object)</code> isn't a JavaBean property so it was hard to use for that. Furthermore, the order in which <code>Configuration.setObjectWrapper</code> and <code>Configuration.setSharedVariables</code> are called doesn't mater (unlike in the case of <code>Configuration.setSharedVariable</code>), which is essential in most IoC solutions.</p></li>
<li><p>Mostly concerning tool (like IDE plugin) authors:</p>
<ul>
<li><p><code>ParseException</code>-s now also store the end-location of the error, not just its start-location. This is useful if you want to underline the error in the source code, not just point at it.</p></li>
<li><p><code>Configuration.getSupportedBuiltInDirectiveNames()</code> can be used to return the names of directives supported by FreeMarker.</p></li>
<li><p><code>TemplateExceptions</code> now expose the position of the error (template name, line, column, end line, end column) similarly to <code>ParseException</code>-s. Where applicable, they also expose the blamed expression in its canonical FTL source form; this is mostly useful for <code>InvalidReferenceException</code>-s.</p></li>
</ul></li>
<li><p>The concurrent performance of overloaded method lookups (from the cache) was improved under Java 5 and later.</p></li>
<li><p>The <code>Version</code> instances that are “incompatible improvements” break points are now available via constants like: <code>Configuration.VERSION_2_3_21</code>.</p></li>
<li><p>From now on, if you try to set the “incompatible improvements” to greater than the current FreeMarker version, or less than 2.3.0, an <code>IllegalArgumentException</code> will be thrown. Thus, <code>new
              Configuration(someVersion)</code> not only activates the fixes up to that version, but ensures that the application will not run in an environment with an older FreeMarker version. (On an older FreeMarker version the improvements that you have requested aren't implemented yet, so you should get an exception.)</p></li>
<li><p>Added new configuration setting, <code>show_error_tips</code>, defaults to <code>true</code>. Sets if tips should be shown in error messages of errors arising during template processing.</p></li>
<li><p>Instead of overriding <code>BeansWrapper.finetuneMethodAppearance</code> (now deprecated), now you can use <code>BeansWrapper.setMethodAppearanceFineTuner(MethodAppearanceFineTuner)</code>, so you don't need to extend the object wrapper class to customize this aspect.</p></li>
<li><p>Added <code>Configuration.getCoreDirecticeNames()</code> which returns the names of all directives that are provided by FreeMarker. This can useful for IDE-s.</p></li>
<li><p><code>template_loader</code> was added as possible configuration setting <code>Properties</code> key.</p></li>
<li><p>The standard <code>CacheStorage</code> implementations now have a <code>getSize()</code> method for monitoring the cache size. <code>MruCacheStorage</code> also has <code>getSoftSize()</code> and <code>getStrongSize()</code>.</p></li>
<li><p>Various smaller improvements in configuration setting errors messages.</p></li>
<li><p>With incompatible improvements 2.3.21 only: Empty ranges return <code>Constants.EMPTY_SEQUENCE</code> instead of an empty <code>SimpleSequence</code>. This is in theory backward compatible, as the API only promises to give something that implements <code>TemplateSequenceModel</code>.</p></li>
<li><p>FreeMarker now requires Java version has changed from 1.2 to 1.4.</p></li>
<li><p>Bugs fixed and improvements in overloaded method selection/invocation, but only if you create the <code>BeansWrapper</code>/<code>DefaultObjectWrapper</code> with constructor parameter <code>Configuration.VERSION_2_3_21</code> (or if you are using <code>Properties</code> to configure FreeMarker, you can do that like <code>object_wrapper=BeansWrapper(2.3.21)</code>), or if you have a <code>Configuration</code> with similar <code>incompatible_improvements</code> 2.3.21 <em>and</em> you leave the <code>object_wrapper</code> setting on its default value. There's a little chance that because of these changes, a different overloaded method will be chosen than before, or even that ambiguity errors will arise where earlier they didn't (although the opposite is far more frequent), hence the fixes aren't automatically activated. But the fix mostly only effect calls that were failing or have chosen then wrong method earlier, so it's recommended to activate it for projects that are still actively developed. This fix includes numerous changes:</p>
<ul>
<li><p>Earlier, <code>null</code> argument values has only matched overloaded methods where the corresponding parameter had <code>Object</code> type, not a subclass of it. That's clearly a bug. Now it considers all overloads where the parameter type is non-primitive, and just like the Java language, it choses the one with the most specific type among them. This is the most important fix, and also the most risky one regarding backward-compatibility. Like if you have <code>m(Object o)</code> and <code>m(String
                  s)</code> in a Java class, earlier for a <code>m(null)</code> call in the template it has chosen <code>m(Object o)</code>, but now it will choose <code>m(String s)</code> instead (because <code>String</code> is also <code>null</code>-able and is more specific than <code>Object</code>). Furthermore, if you also had <code>m(File f)</code> in the same class, now it will cause an ambiguity exception, since the specificity of <code>File</code> and <code>String</code> can't be compared (same rule as under Java language), while earlier that wasn't a problem as only <code>m(Object
                  o)</code> was seen as applicable.</p></li>
<li><p>The behavior of numbers with overloaded method selection was heavily reworked:</p>
<ul>
<li><p>If possible, it now always choses the overload where overflow and truncation to integer (like 1.5 to 1) is avoided. Among the methods where no such critical loss occurs, it choses the overload with the least risk of precision loss (unless other conditions with higher priority suggest otherwise). Earlier, the method selection was prone to do choices that led to overflow or precision loss, especially when the parameter was a literal with decimals.</p></li>
<li><p>Overloaded method call can now convert to non-primitive numerical types, like a <code>Byte</code> or <code>byte</code> value is automatically converted to <code>Integer</code> if the parameter type is <code>Integer</code>. (This has always worked for non-overloaded methods.) Earlier where such conversion was needed, the method wasn't seen seen applicable.</p></li>
<li><p>Method selection is now not only based on the type of the wrapped number, but also on its value. For example, a <code>Long</code> with value <code>1</code> is now seen as compatible with a method with parameter type <code>int</code> or <code>short</code> or <code>byte</code>, as <code>1</code> can be stored in those without loss. This is important as unlike in Java language, in FTL you doesn't have strict control over the numerical types (the type of the wrapped number, actually), as FTL has no type declarations. (If multiple compatible methods are available, it will still try to chose the one with the same or bigger numerical type.)</p></li>
<li><p>Conversion from/to <code>BigInteger</code> is now supported.</p></li>
</ul></li>
<li><p>Method choice ambiguity errors now occur much less often. Ambiguities was and are resolved by selecting the compatible methods then choosing the one with the most specific parameter types among them. The changes are:</p>
<ul>
<li><p>When comparing the overall specificity of two parameter lists: Earlier the parameter list seen as more specific was the one that had some parameters that won in specificity, and if both had such parameters then it was an ambiguity. Now it's enough if a method has more such parameters where it's a better match than the other has, or if the two methods are still equal, if it has the first better matching parameter. This can lead to choices that seem arbitrary (but are still deterministic), but as there's no automated way of discovering method selection ambiguities in templates (unlike in Java source code, where they will be detected during compilation), especially as overloaded selection has to rely on the <em>runtime</em> type of the values which even make proper testing hard, this was considered to be a better compromise than throwing an exception whenever the choice of the method is not obvious. Also note that in fact this mechanism is more complicated than just counting the “winner” parameter positions for each methods, as certain kind of wins are stronger than any number of the others: wins where the other possibility is risking of substantial mantissa precision loss are the strongest (like dropping decimals versus not to), wins where the primitive type wins over the boxed class is the weakest (like <code>int</code> versus <code>Integer</code>), subclassing wins (like <code>String</code> versus <code>Object</code>) are between these two.</p></li>
<li><p>When comparing the specificity of two parameters types at the same parameter position: The algorithm now considers a primitive type as more specific that its corresponding boxing class (like <code>int</code> is considered to be more specific than <code>Integer</code>).</p></li>
<li><p>There was a bug with overloaded varargs methods of different parameter counts, where sometimes the last parameters of the compared methods was ignored, which is taking away a potential deciding factor and thus can lead to ambiguity error. Whether this happened depends on the order in which the Java reflection API has returned the methods, which is undocumented and known to change at least after some Java updates, breaking the application.</p></li>
<li><p>When comparing the specificity of two array types, until now they were seen as equal. Now the component types are compared, and then that with the less specific component type is preferred. For example, among <code>f(String[])</code> and <code>f(Object[])</code>, the last will always win. This might sounds controversial, but as we can't efficiently tell the common type of all the items in a sequence or <code>List</code>, and so we don't know if both arrays are indeed valid targets, we go for the safest choice.</p></li>
</ul></li>
<li><p>FTL sequence values (like Java <code>List</code>-s or FTL <code>[x,
                  y,
                  ...]</code> constants) were not seen as applicable to a parameter with array type if there were multiple overloaded methods with the same number of parameters but with different types on the position of the array parameter. That is, if you had <code>f(String[])</code> and <code>f(String)</code> in Java, then <code>f(['foo', 'bar'])</code> in the template reported no compatible overloads. Now it will choose <code>f(String[])</code>. Note that if there's also an <code>f(List)</code> or even an <code>f(Collection)</code>, it will prefer those over arrays. (For consistency, this conversion will work even if the argument is a <code>List</code> that come directly from Java (as opposed to be created inside FTL), i.e., when it was wrapped then unwrapped to the original <code>List</code> object.) For a multidimensional array parameter type, this conversion works recursively, so you can pass in a sequence-of-sequences as the argument.</p></li>
<li><p>FTL sequence values that wrapped a Java array (when FreeMarker was also aware of that via <code>AdapterTemplateModel</code> or <code>WrapperTemplateModel</code>) were not seen as applicable to a parameter with <code>List</code> type if there were multiple overloaded methods with the same number of parameters but with different types on the position of the array parameter. So this is pretty much like the issue described in the previous point, but for array to <code>List</code> conversion. The array to <code>List</code> conversion will be avoided if possible, but it will be attempted if there's no other alternative. Note that unlike with <code>List</code> to array conversions, here FreeMarker can't cope with multi-dimensional lists, that is, an array-of-arrays won't be converted to a <code>List</code>-of-<code>List</code>-s.</p></li>
<li><p>FTL string to Java <code>char</code>/<code>Character</code> conversion now works for overloaded method parameters; earlier it has worked for non-overloaded methods only. If the string length is 1, it will be seen as compatible with parameters with <code>char</code> or <code>Character</code> type.</p></li>
<li><p>Decreased the chance of choosing the wrong target Java type when unwrapping multi-typed FTL values: When unwrapping a parameter value that implements multiple FTL types (e.g. string and hash) but doesn't implement <code>AdapterTemplateModel</code> or <code>WrapperTemplateModel</code>, a decision has to be made if to what Java type the value should be unwrapped to (e.g. to <code>String</code> or to <code>Map</code>). In earlier versions that decision was made based on the most specific common super type of the parameters types of the given parameter position. However, it's quite common that the common super type is too generic, usually <code>Object</code>. Now <code>BeansWrapper</code> stores “type flags” for each parameter position of overloaded methods, from which it can tell whether a potential target Java type occurs in any of the overloads on the given parameter position.</p></li>
<li><p>In many cases, less specific hint class was used for unwrapping than that was possible within the limitations of the applied hint generation algorithm. (The unwrapping hint has influence when there's an ambiguity regarding how to create a Java object form an FTL value. In the vast majority of the cases, a too generic hint has no effect.) (This is a highly technical topic. The way it works is that a single common unwrapping hint class is chosen for a given argument position shared by the overloads that has the same number of parameters, and that hint class has to be as specific as possible while it must fit all those parameter types. The issue with the too generic hints had several instances: (a) When the most specific common class/interface of two same-position parameter types was searched, if there was multiple common classes/interfaces that had no relationship (this is always at most one class and one or more unrelated interfaces), due to the ambiguity it has felt back to using <code>Object</code> as the unwrapping hint. Now if there's a non-<code>Object</code> class among them in such case, it will be chosen as the hint (i.e., we ignore the common interfaces). Otherwise if only a single interface remains by removing <code>Cloneable</code>, <code>Serializable</code>, and <code>Comparable</code> (in that order), that will be chosen. Only then it falls back to <code>Object</code>. (b) The common most specific class of a primitive type and the corresponding boxing class was sometimes <code>Object</code> instead of the boxing class. This has depended on Java's internal ordering of the methods, and so were quite unpredictable, like the result could change after upgrading Java under the application. (c) The common superclass of a numerical primitive value and a numerical non-primitive value was always <code>Object</code>, now if they are a primitive-boxing class pair, then it's the boxing class, otherwise it's <code>Number</code>. (d) If the varags parameter position was not the same in all the overloaded varargs methods, sometimes some varargs arguments where unwrapped with too generic hints. When this happened was unpredictable as it depended on Java's internal method ordering again.)</p></li>
<li><p>When unwrapping method call arguments before calling a Java method, if the argument was an <code>AdapterTemplateModel</code> and the target parameter type was primitive, <code>AdapterTemplateModel.getAdaptedObject(Class
                  hint)</code> has received the primitive type of the target parameter (like <code>int</code> instead of <code>Integer</code>) as the hint. This did not make sense since <code>getAdaptedObject</code> can only return <code>Object</code>-s, not primitive values. Yet, <code>BeansWrapper</code> has expected the returned value to be of the primitive type, otherwise it has discarded it. Exactly the same problem occurs with <code>WrapperTemplateModel</code>. Thus, ultimately, if the target parameter type was primitive and some of these interfaces were implemented, their return value was always discarded and FreeMarker has felt back to other means of unwrapping. Now <code>BeansWrapper</code> always passes in and expects the boxing type (like <code>Integer</code>) instead of the primitive type.</p></li>
</ul></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/373/">373</a>]: These are three bugs actually, which can cause problems when FreeMarker re-loads a template because of a charset override with <code>&lt;#ftl encoding=&quot;...&quot;&gt;</code>: First, if the template loader was a <code>URLTemplateLoader</code>, when <code>TemplateLoader.getReader()</code> was called for the second time, and the <code>Reader</code> returned for the first time was already used, it might returned an empty or corrupted template, depending on the backing URL implementation. Secondly, when FreeMarer has decided if a template file has to be re-loaded because its encoding specified with <code>&lt;#ftl encoding=&quot;...&quot;&gt;</code> differs from the encoding used for loading the template first, it has used case-sensitive comparison, thus often re-loaded needlessly (like &quot;UTF-8&quot; and &quot;utf-8&quot; mean the same). Now this comparison is case-insensitive. Last not least, when retrying with the second charset, the <code>TemplateCache</code> has forgotten to close the first <code>Reader</code>, which can be a handle leak.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/411/">411</a>]: Invalid and redundant execution environment names from the OSGi bundle manifest were removed. It looks like this now: <code>Bundle-RequiredExecutionEnvironment: J2SE-1.5,
              J2SE-1.4</code>. That is, we prefer (and compile against) 1.5, but only require 1.4.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/409/">409</a>]: <code>SimpleHash</code>'s internal <code>Map</code> is concurrently modified on a non-safe way when getting length-1 <code>String</code> key that exists but maps to <code>null</code>. This operation will accidentally add a <code>Character</code> key to the internal map, which is not a thread-safe operation.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/273/">273</a>]: <code>TemplateLoader</code>-s that use <code>java.net.URLConnection</code>-s should set <code>URLConnection.useCaches</code> to <code>false</code>, or else it won't detect template caches on certain configurations.</p>
<ul>
<li><p><code>URLTemplateLoader</code> and its subclasses and <code>WebApplicationTemplateLoader</code> now has a <code>setURLConnectionUsesCaches(Boolean)</code> method. It's recommended to set this property to <code>false</code> from its default backward compatible value, <code>null</code>. As FreeMarker has its own template cache with its own update delay setting (<code>template_update_delay</code>, <code>Configuration.setTemplateUpdateDelay(int)</code>), it shouldn't cause performance problems. The <code>null</code> value will leave the caching of the <code>java.net.URLConnection</code> on its default, which is usually <code>true</code>.</p></li>
<li><p>If <code>incompatible_improvements</code> is set to 2.3.21 (or higher) and templates are loaded through <code>Configuration.getTemplate</code>, and the <code>TemplateLoader</code> in use has <code>URLConnectionUsesCaches</code> left on <code>null</code>, it will behave as if it was set to <code>false</code>. Note that this <code>incompatible_improvements</code> trick only works if the template is loaded through <code>Configuration.getTemplate</code> (or <code>TemplateCache</code>).</p></li>
</ul></li>
<li><p>Bug fixed: When changing the properties of <code>DefaultObjectWrapper</code> or <code>BeansWrapper</code> that influenced class introspection results (like <code>exposureLevel</code> or <code>exposeFields</code>), the introspection cache wasn't cleared, and thus returned stale information for the classes that were introspected before those properties were changed. Now changing such properties always clears the introspection caches.</p></li>
<li><p>Bug fixed: Constants used for empty sequence, empty hash, empty collection and empty iterator weren't <code>Serializable</code>.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/311/">300</a>]: Logger class availability check was incorrect in that it has checked the availability of logger libraries with the thread context class loader, then later it tried to link to them with the defining class loader of the FreeMarker classes. With some class loader setups (notably under Netbeans sometimes) this led to <code>ClassDefNotFoundError</code>-s that made FreeMarker unusable. (The check itself was also not very durable, as it didn't expected <code>LinakeError</code>-s, only <code>ClassNotFoundException</code>.)</p></li>
<li><p>Bug fixed: <code>ClassUtil.forName</code>, used inside FreeMarker everywhere to resolve class names to classes, if the thread context class loader is <code>null</code>, no longer tries to load with the bootstrap class loader before loading with the defining class loader of FreeMarker.</p></li>
<li><p>Bug fixed [<a href="http://sourceforge.net/p/freemarker/bugs/311/">311</a>]: <code>TemplateBooleanModel.TRUE</code> and <code>FALSE</code> are now serializable</p></li>
<li><p>Bug fixed: Various issues in <code>Version</code> class, such as wrong <code>hashCode</code>, possible concurrency glitches, and acceptance of some malformed version strings.</p></li>
<li><p>Bug fixed [<a href="https://sourceforge.net/p/freemarker/bugs/414/">414</a>]: Eclipse debug mode running was suspended during FreeMarker static initialization on the JRebel availability checked if JRebel wasn't available.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>The license has changed from our proprietary BSD-Style license to the well know &quot;Apache License, Version 2.0&quot;. Furthermore, the copyright owner has changed from &quot;Visigoth Software Society&quot; (which was founded by Jonathan Revusky) to the three main FreeMarker 2 developers/contributors, &quot;Attila Szegedi, Daniel Dekany, and Jonathan Revusky&quot;. See the <a href="#app_license">new license here</a>.</p></li>
<li><p>The required minimum Java version was raised from 1.2 to 1.4. FreeMarker will not work on Java 1.2 or 1.3.</p></li>
<li><p>Many smaller improvements and fixes in the Manual and API JavaDocs.</p></li>
</ul>
<h2 id="versions_2_3_20">2.3.20</h2>
<p>Date of release: 2013-06-27</p>
<p>If you are IDE/tools author, <a href="#version_2_3_20_ide">note these changes</a>.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Error message quality improvements:</p>
<ul>
<li><p>Many error messages are now more helpful, especially for users who are not experienced with FreeMarker. For example, some of the most common user mistakes are recognized and tips are shown to fix them, reducing support costs or the time employees spend to figure them out.</p></li>
<li><p>It's now ensured that the error location in the template is included in the message returned by <code>TemplateException.getMessage()</code>. The stack trace always showed this information anyway, but some users only see the “message”, not the stack trace, and that often didn't contained the location.</p></li>
<li><p>The template language part of the stack trace is now more detailed, and easier to understand. This is especially helpful in applications that use a complex library of macros and functions.</p></li>
<li><p>Several smaller bugs were fixed that made the error information wrong or lacking.</p></li>
<li><p>The layout of the error messages is now more consistent, and generally easier to read.</p></li>
</ul></li>
<li><p>Changes regarding boolean to string conversions and formatting:</p>
<ul>
<li><p><code>?c</code> (computer-language formatting) now works with booleans too, always giving <code>&quot;true&quot;</code> or <code>&quot;false&quot;</code> regardless of the <code>boolean_format</code>. This way it's safe for generating JavaScript in a context where human-readable text is also rendered.</p></li>
<li><p>If the <code>boolean_format</code> setting is set to anything but the default <code>&quot;true,false&quot;</code> value, boolean values will be automatically converted to string where a string value is expected by the template language, instead of giving an error. This helps you spare those<code>?string</code>-s after boolean values. This is the same logic as with numbers and dates, which were always automatically converted to string, according the corresponding format setting. Except, the provided default boolean format is useless for automatic conversion (but it's still there for <code>?string</code>, for backward compatibility), hence it must be set manually. (We certainly couldn't come up with a sensible default anyway, as for booleans it depends too much on the application, not to mention the localisation issues.)</p>
<p>Exactly like with numbers and dates, automatic conversion doesn't happen in these cases:</p>
<ul>
<li><p>Comparisons, i.e., <code>someBoolean ==
                      'true'</code> is still an error</p></li>
<li><p>Method calls where the declared type of the parameter is <code>String</code> but the actual value is a boolean; still an error</p></li>
<li><p>When the boolean value is used as key in <code>expr[key]</code>, it's still an error (there was no automatic conversion there for other types either, as numerical and string keys have different meaning)</p></li>
<li><p>The opposite direction, i.e., string to boolean conversion; won't happen</p></li>
</ul></li>
</ul></li>
<li><p>New built-ins for numbers: <a href="#ref_builtin_abs"><code>abs</code></a>, <a href="#ref_builtin_is_nan"><code>is_nan</code></a>, <a href="#ref_builtin_is_infinite"><code>is_infinite</code></a>. Like <code>n?abs</code> will give the absolute value of <code>n</code>.</p></li>
<li><p>New built-in for sequences: <a href="#ref_builtin_join"><code>join</code></a>. Like <code>[1, 2, 3]?join(&quot;, &quot;)</code> will give the string <code>&quot;1, 2, 3&quot;</code>.</p></li>
<li><p>If you set the <code>incompatible_improvements</code> setting (see <a href="http://freemarker.org/docs/api/freemarker/template/Configuration.html#setIncompatibleImprovements%28freemarker.core.Version%29">here</a>) to <code>2.3.20</code> or higher, <code>?html</code> will escape apostrophe-quotes just like <code>?xhtml</code> does. Utilizing this is highly recommended, because otherwise if interpolations are used inside attribute values that use apostrophe-quotation (<code>&lt;foo
              bar='${val}'&gt;</code>) instead of plain quotation mark (<code>&lt;foo bar=&quot;${val}&quot;&gt;</code>), they might produce HTML/XML that's not well-formed. Note that <code>?html</code> didn't do this because long ago there was no cross-browser way of doing this, but it's not a real concern anymore. Also note that this will be the default behavior starting from 2.4.</p></li>
<li><p>Bug fix [<a href="https://sourceforge.net/p/freemarker/bugs/390/">390</a>] (and other improvements): <code>?js_string</code> and <code>?json_string</code> didn't escape the <code>u2028</code>-<code>u2029</code> line terminators (problem for JavaScript) and the <code>u007F</code>-<code>u009F</code> control characters (maybe a problem in JSON, depending on implementation). Furthermore, the escaping of <code>\</code>, <code>&lt;</code>, and <code>&gt;</code> become safer in that now they are escaped whenever it can't be guaranteed that they won't be part of <code>&lt;!</code>, <code>]]&gt;</code> or <code>&lt;/</code>. Earlier they were only escaped when it was known that they are part of these patterns, thus it was possible to assemble these patterns from two adjacent interpolations. Additionally, from now on <code>&lt;?</code> and <code>--&gt;</code> also count as dangerous patterns, and will trigger <code>&lt;</code> and <code>&gt;</code> escaping.</p></li>
<li><p>Bug fixed: The following string built-ins didn't coerce the numerical, date (and now the boolean) left-values to string, instead they threw a type error: contains, <code>index_of</code>, <code>last_index_of</code>, <code>left_pad</code>, <code>right_pad</code>, <code>matches</code>, <code>replace</code>, <code>split</code>, <code>new</code>. The other string built-ins already did this conversion for a long time; this was an accidental inconsistency.</p></li>
<li><p>Bug fixed: With the default arithmetic engine, it's now supported to compare infinite (positive or negative) with 0, to decide its sign.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p><code>BeansWrapper</code> introspection cache improvements:</p>
<ul>
<li><p>Added public API to <code>BeansWrapper</code> for clearing the class cache: <code>clearClassIntrospecitonCache()</code>, <code>removeFromClassIntrospectionCache(Class)</code></p></li>
<li><p>Significantly improved multi-core performance:</p>
<ul>
<li><p>Uses <code>ConcurrentHashMap</code> when running on Java 5 or later.</p></li>
<li><p>The cache won't block readers while introspecting a class after a cache miss</p></li>
<li><p>If multiple threads need to introspect the same class that's not in the cache yet, only one of them will do it, the others will wait for its results.</p></li>
</ul></li>
<li><p>Bug fix [<a href="https://sourceforge.net/p/freemarker/bugs/361/">361</a>]: There was a small chance of deadlock when class-reloading was detected. Locking was redesigned to prevent such oversights in the future.</p></li>
<li><p>The internal package-visible <code>freemarker.ext.beans</code> API was slightly changed as the result of internal cleanup. Nobody but the FreeMarker developers should define classes in that package, so it shouldn't break anything. But if somebody did some in-house hacks there, re-compile to see if it still works.</p></li>
</ul></li>
<li><p>Nameless templates (those directly created with <code>new Template(null,
              ...)</code> instead of loaded through <code>Configuration</code>) couldn't include or import other templates, and thrown a <code>NullPointerException</code> when they tried to. Now they resolve relative paths as if they were in the template root directory.</p></li>
<li><p>Bug fix: Regular expression built-ins and some logger libraries (most importantly Log4J) were unavailable on the Google App Engine platform. This fix is only present in the GAE-compatible build, 2.3.20-gae.</p></li>
<li><p>Added new method to <code>Configuration</code>: <code>CacheStorage getCacheStorage()</code></p></li>
<li><p>Added new methods to <code>Environment</code> to make comparisons among <code>TemplateModel</code>-s according the rules of the template language operators: <code>applyEqualsOperator</code>, <code>applyEqualsOperatorLenient</code>, <code>applyLessThanOperator</code>, <code>applyLessThanOrEqualsOperator</code>, <code>applyGreaterThanOperator</code>, <code>applyWithGreaterThanOrEqualsOperator</code></p></li>
<li><p>Added new method, <code>Environment.isInAttemptBlock()</code> to check if we are within an <code>#attempt</code> block. This can be useful for <code>TemplateExceptionHandler</code>-s, as then they don't need to print the error to the output since <code>#attempt</code> will roll it back anyway. This is already utilized by the built-in <code>TemplateExceptionHandler</code>-s (<code>DEBUG_HANDLER</code> and <code>HTML_DEBUG_HANDLER</code>).</p></li>
<li><p>Added convenience constructor <code>Template(String
              name, String sourceCode, Configuration cfg)</code>.</p></li>
<li><p><code>TemplateException</code>-s and <code>TemplateModelExcepton</code>-s now can have <code>Throwable</code> cause, not just <code>Exception</code> (it was an old oversight that somehow wasn't fixed so far).</p></li>
<li><p>Parsing error messages under the JBoss Tools FreeMarker IDE now doesn't contain the usual location line, so that the actual error description is immediately visible in the Eclipse “Problems” view. (It's a “hack” in FreeMarler itself; it tries to detect if it runs under the plugin and then changes its behavior.)</p></li>
<li><p>Mostly concerning tool (like IDE plugin) authors:</p>
<ul>
<li><p>The error message formats (what <code>Throwable.getMessage()</code> returns) were heavily changed for <code>TemplateException</code>-s, and somewhat for <code>ParseException</code>-s. It's unlikely that anybody depends on these, but if you tried to parse these messages, be aware of this.</p></li>
<li><p>Fixed bug where <code>ParseException</code> has contained 0 as line and column number for lexical errors. Now it contains the correct information.</p></li>
<li><p>Added <code>ParseException.getEditorMessage()</code>: As in IDE-s the error markers show the error location to the user already, the location should not be repeated in the error message. So in IDE-s you should use this method instead of <code>getMessage()</code>. (Under JBoss Tools: FreeMarker now <em>tries</em> to detect that it runs under the plugin, and then it already does this, except that it still shows the column number as that's missing from the error marker location.)</p></li>
<li><p>Added <code>ParseException.getTemplateName()</code></p></li>
<li><p>Added <code>Configuration.getSupportedBuiltInNames()</code>. As new built-ins (<code>expr?builtin_name</code>) are very often added to new FreeMarker versions, auto-completion or syntax highlighting should use this set instead of a fixed set of a names.</p></li>
<li><p>The format returned by <code>TemplateElement.getDescription()</code> was heavily changed. It's what FTL stack traces and maybe some outline views (tree-views) show. It was always for human reading (and till now was too inconsistent for anything else), so it's unlikely that this breaks anything.</p></li>
<li><p>There were some smaller changes in <code>freemarker.debug</code>, and it's expected that there will be more, so it was marked as experimental. As far as we know, nobody used it, so it shouldn't break anything.</p></li>
</ul></li>
<li><p>In <em>experimental status only</em>, but <code>freemarker.jar</code> is now an OSGi bundle (see <code>freemarker.jar/META-INF/MANIFEST.MF</code>). Depending on user feedback, the bundle description may change in the future. So please give feedback, especially if you are an OSGi expert!</p></li>
<li><p>Improved the HTML generated by <code>HTML_DEBUG_HANDLER</code> (the red-on-yellow-background error message). Most importantly, now it will word-wrap. Other changes are minor, like now it can break out of CDATA sections, or now it has less intense colors.</p></li>
<li><p>New <code>Template</code> method, <code>getActualTagSyntax()</code>: Tells if the template is using traditional or square-bracket syntax. As the syntax can be overridden in the template, also it's possibly decided by auto-detection, it wasn't trivial to it tell till now.</p></li>
<li><p>Added some utility methods that are useful for generating error messages in custom directives: <code>ClassUtil.getFTLTypeDescription(TemplateModel)</code>, <code>getShortClassName</code>, <code>getShortClassNameOfObject</code></p></li>
<li><p>Bug fix [<a href="https://sourceforge.net/p/freemarker/bugs/364/">364</a>]: <code>freemarker.template.EmptyMap</code> (which is passed to <code>TemplateDirectiveModel</code>-s if there are no parameters) now allows <code>remove(key)</code>, <code>clear()</code> and <code>putAll(anyEmptyMap)</code> as these do nothing anyway.</p></li>
<li><p>Bug fix [<a href="https://sourceforge.net/p/freemarker/bugs/375/">375</a>]: <code>NullPointerException</code> on IBM J9 VM (not on the Sun/Oracle implementation) in <code>BeansWrapper</code> when the Java implementation legally returns <code>null</code> for some <code>BeanInfo</code> getters.</p></li>
<li><p>Bug fix: Cloning a <code>Configuration</code> didn't deep-clone the data structures storing the <code>auto_imports</code> and <code>auto_includes</code> settings, hence possibly leading to aliasing problems.</p></li>
<li><p>Bug fix [<a href="https://sourceforge.net/p/freemarker/bugs/377/">377</a>]: After a failed method call the exception handler could fail in the rare occasion when <code>targetObject.toString()</code> fails, raising a runtime exception that not even the <code>attempt</code> directive will catch.</p></li>
<li><p>Bug fix [<a href="https://sourceforge.net/p/freemarker/bugs/391/">391</a>]: If a template name has contained <code>*</code> that was not the only character in the path step, it threw <code>NegativeArraySizeException</code> instead of <code>FileNotFoundException</code>.</p></li>
<li><p>With the default arithmetic engine, performance optimizations of comparison operations when some of the numbers is 0, and when the sign of the numbers differ.</p></li>
<li><p>Some smaller fixes in <code>TemplateElement.getCanonicalForm()</code>, also some quality improvements there.</p></li>
<li><p>Bug fixes in <code>classic_compatible</code> mode (this mode is to help migrating from FreeMarker 1), thanks to Information Mosaic:</p>
<ul>
<li><p>When a macro was called with a <code>null</code>/missing parameter value, it has caused error like in FreeMarker 2.3</p></li>
<li><p>When a hash literal contained reference to a <code>null</code>/missing variable, like in <code>{
                  'a': missingVar }</code>, it has caused an error like in 2.3</p></li>
<li><p>When a sequence literal contained reference to a <code>null</code>/missing variable, like in <code>[1, missingVar]</code>, it has caused an error like in 2.3</p></li>
<li><p>When a the left-side of the <code>.</code> (dot) or <code>[key]</code> operator was <code>null</code> or missing variable, like in <code>missingVar.subVar</code>, it has caused an error like in 2.3</p></li>
<li><p>When <code>BeanModel</code>-s are tried to be treated as strings, for most subclasses it has failed with type error, like in 2.3. In FreeMarker 1 all <code>BeanModel</code>-s were <code>TemplateScalarModel</code>-s, so it should succeed. The fix for this only works where FreeMarker <em>coerces</em> to string (string built-ins on the left-side and concatenation (<code>+</code>) and interpolation (<code>${...}</code>) do that), otherwise unfortunately it will still fail.</p></li>
<li><p>The <code>classic_compatible</code> setting now accepts value <code>2</code> along <code>true</code> (alias <code>1</code>) and <code>false</code> (alias <code>0</code>). <code>2</code> means <code>true</code> but with emulating bugs in early 2.x classic-compatibility mode. Currently this only affects how booleans are converted to string; with <code>1</code> it's always <code>&quot;true&quot;</code>/<code>&quot;&quot;</code>, but with <code>2</code> it's <code>&quot;true&quot;/&quot;false&quot;</code> for values wrapped by <code>BeansWrapper</code> as then <code>Boolean.toString()</code> prevails. Note that <code>someBoolean?string</code> will always consistently format the boolean according the <code>boolean_format</code> setting, just like in FreeMarker 2.3.</p></li>
</ul></li>
<li><p>Bug fix [<a href="https://sourceforge.net/p/freemarker/bugs/394/">394</a>]: When trying to access the optional Jython (or W3C DOM) classes has failed in <code>DefaultObjectWrapper</code> with an <code>Error</code>, rather than with an <code>Exception</code>, loading the <code>DefaultObjectWrapper</code> class itself has failed, instead of the Jython (or W3C DOM) support being disabled. From now in, it will survive any kind of <code>Throwable</code> there, and if the <code>Throwable</code> is not an <code>ClassNotFoundException</code>, it will also log the <code>Throwable</code>.</p></li>
<li><p>Improved the performance of <code>(thisVarIsMissing.foo)!default</code> and similar <em>parenthetical</em> existence operators and existence built-ins in the case when the <code>null</code>/missing variable is not the last step inside the parenthesis. In that case it's about 30 times faster now, measured on Java 6. In other cases (when all variables exists, or the the last step is missing) the performance is about the same (relatively fast) as before.</p></li>
<li><p>Added interface <code>freemarker.cache.CacheStorageWithGetSize</code> which allows querying the current number of cache entries in a <code>CacheStorage</code> that implements it. It's implemented by all out-of-the-box <code>CacheStorage</code> implementations. Also added <code>getStrongSize()</code> and <code>getSoftSize()</code> to <code>MRUCacheStorage</code>.</p></li>
<li><p>Version and build information changes:</p>
<ul>
<li><p>The form of the nightly build version numbers has changed to be Maven/JSR 277 compliant. What earlier was <code>2.3.19mod</code> is now something like <code>2.3.20-nightly_20130605T130506Z</code> (note how the last points to the target release version instead of the last release version).</p></li>
<li><p>The form of the Release Candidate and Preview version numbers where changed to be Maven/JSP 277 compliant: <code>2.4pre2</code> is now <code>2.4.0-pre02</code>, <code>2.4rc1</code> is now <code>2.4.0-rc01</code>.</p></li>
<li><p>Added new static method to <code>Configuration</code> to query build date: <code>getBuildDate()</code>. This is also printed by the main command line class.</p></li>
</ul></li>
<li><p>Various internal code cleanups.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Many JavaDoc improvements, mostly in the documentation of the basic (most frequently used) classes.</p></li>
<li><p>FreeMarker source code has moved to GitHub (<a href="???">https://github.com/freemarker/freemarker</a>), other project resources has remained on sourceforge.net.</p></li>
<li><p>Project structure cleanup, Ivy-based build script.</p></li>
</ul>
<h2 id="versions_2_3_19">2.3.19</h2>
<p>Date of release: 2012-02-29</p>
<p>Don't miss the <a href="#v2319secfix">security related changes</a>, they may affect your application!</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p><em>Attention</em>: The output of <a href="#ref_builtin_date_iso">ISO 8601 date/time formatting built-ins</a>, introduced in 2.3.17, was slightly changed. From now on, the time zone offset, when it's displayed and it isn't <code>Z</code>, always includes the minutes. For example, <code>15:30:15+02</code> becomes to <code>15:30:15+02:00</code> in the template output. Both formats are valid according to ISO 8601 (so anything that expects ISO 8601 date/times should continue working), but only the last format complies with the XML Schema date/time formats, hence this change.</p></li>
<li><p>New built-in for escaping inside JSON string literals: <a href="#ref_builtin_json_string"><code>json_string</code></a>.</p></li>
<li><p>Bugfix: Wrong <code>#</code> tags were printed as static text instead of causing parsing error if there was no correct <code>#</code> tag earlier in the same template. Since fixing this would not be 100% backward compatible, the old behavior has remained, unless you set the <code>incompatible_enhancements</code> setting (<code>Configuration.setIncompatibleEnhancements(String)</code>) to <code>&quot;2.3.19&quot;</code> or higher.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p><em>Attention</em>: This release contains two important security workarounds that unavoidably make it obvious how some applications can be exploited. <em>FreeMarker can't solve these issues on all configurations, so please read the details instead of just updating FreeMarker!</em> Also, these changes are not 100% backward compatible in theory, however it's not probable that they will break anything. The two changes are:</p>
<ul>
<li><p>The character with character code 0 (<code>\u0000</code>) is not allowed in template paths anymore. When a path contains it, FreeMarker behaves as if the template was not found.</p>
<p>This is to fix the security problem where a template path like <code>&quot;secret.txt\u0000.ftl&quot;</code> is used to bypass extension filtering in an application. FreeMarker itself doesn't care about the extension, but some applications decide based on the extension if they will delegate a path to FreeMarker. When they do with such a path, the C/C++ implementation behind the storage mechanism may sees the path as <code>&quot;secret.txt&quot;</code> as the 0 terminates the string in C/C++, and thus load a non-FTL file as a template, returning the file contents to the attacker.</p>
<p>Note that some HTTP servers, notably Tomcat and the Apache HTTP Server blocks URL-s where the URL contains 0 (<code>%00</code>) outside the query string, thus this wasn't exploitable there through such Web URL-s. Some other HTTP servers however, like Jetty, doesn't block such URL-s.</p></li>
<li><p><code>ClassTemplateLoader</code>, when it's created with base path <code>&quot;/&quot;</code> (like with <code>new ClassTemplateLoader(someClass, &quot;/&quot;)</code>), will not allow template paths that contain colon earlier than any <code>/</code>, and will act like if the template was not found in such case.</p>
<p>This is to fix the security problem where a template path like <code>&quot;file:/etc/secret&quot;</code> or <code>&quot;http://example.com/malware.ftl&quot;</code> is interpreted as a full URL by a <code>java.net.URLClassLoader</code> in the class-loader hierarchy, and thus allow loading files from these URL-s as templates. This is a quirk (or bug) of <code>java.net.URLClassLoader</code>, thus this problem only exists on systems that use such class-loaders.</p>
<p>Beware, some frameworks use their own <code>TemplateLoader</code> implementations, and if those are vulnerable, they will remain so after updating FreeMarker too! Note that this exploit only works if the class-loader hierarchy contains an <code>URLClassLoader</code> and the class-loader is used to load templates without adding any prefix before the template path (other than <code>&quot;/&quot;</code>).</p></li>
</ul>
<p>These security issues mostly only affect applications <em>where the user (the visitor) can supply arbitrary template paths to the application</em>. This is not the case with properly built MVC applications, as there only the MVC Controller can be addressed directly, and it's the Controller that specifies the template paths. But legacy MVC applications based on <a href="#pgui_misc_servlet_model2">JSP Model-2</a> often expose the MVC Views as public URL-s ending with <code>.ftl</code>, thus allowing the user to give arbitrary paths to FreeMarker. Such applications should be secured with a <code>security-constratint</code> in <code>web.xml</code> as shown in the <a href="#pgui_misc_servlet_model2">related Manual section</a>. This should be done regardless of the current security fixes.</p>
<p>In general, you should not allow users to specify arbitrary template paths, or if you do allow that, you should be extra careful with the <code>TemplateLoader</code> used.</p></li>
<li><p><code>Configuration</code> has new methods: <code>removeTemplateFromCache(...)</code>. This will remove the given template for the given locale from the cache, so it will be re-loaded regardless of the template update delay when it's next time requested.</p></li>
<li><p><code>BeansWrapper</code> ignores setter methods from now when introspecting classes. They weren't used anyway, so they unnecessarily caused &quot;<code>java.beans.IntrospectionException</code>: type mismatch between read and write methods&quot; errors.</p></li>
<li><p><code>TemplateClassResolver.SAFER_RESOLVER</code> now disallows creating <code>freemarker.template.utility.JythonRuntime</code> and <code>freemarker.template.utility.Execute</code>. This change affects the behavior of the <a href="#ref_builtin_new"><code>new</code> built-in</a> if FreeMarker was configured to use <code>SAFER_RESOLVER</code>, which is not the default until 2.4 and is hence improbable.</p></li>
<li><p>Bug fixed: Calling varargs methods now indeed works. (Earlier it only worked for overloaded methods.)</p></li>
<li><p>Bug fixed <a href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=1837697&amp;group_id=794&amp;atid=100794">[1837697]</a> <a href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=2831150&amp;group_id=794&amp;atid=100794">[2831150]</a> <a href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3039096&amp;group_id=794&amp;atid=100794">[3039096]</a> <a href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3165425&amp;group_id=794&amp;atid=100794">[3165425]</a>: Jython support now works with Jython 2.2 and 2.5.</p></li>
<li><p>Bug fixed <a href="https://sourceforge.net/tracker/index.php?func=detail&amp;aid=3325103&amp;group_id=794&amp;atid=100794">[3325103]</a>: <code>TemplateException</code>-s and <code>ParseException</code>-s are now serializable.</p></li>
</ul>
<h2 id="versions_2_3_18">2.3.18</h2>
<p>Date of release: 2011-05-21</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix <a href="https://sourceforge.net/tracker/?func=detail&amp;aid=3304568&amp;group_id=794&amp;atid=100794">[3304568]</a>: 2.3.17 didn't find TLD-s in <code>WEB-INF\lib\*.jar</code> unless they were explicitly pointed in the <code>web.xml</code> with a <code>taglib</code> element. This bug was introduced in 2.3.17.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Added <code>LICENSE.txt</code> and <code>NOTICE.txt</code> to <code>freemarker.jar</code> under <code>META-INF</code>.</p></li>
</ul>
<h2 id="versions_2_3_17">2.3.17</h2>
<p>Date of release: 2011-05-17</p>
<p>It's possibly urgent to update to this version because of a <a href="#v2317secfix">security fix</a>!</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p><code>?seq_index_of</code> and <code>?seq_last_index_of</code> now works on collections (<code>freemarker.template.TemplateCollectionModel</code>-s) too, not only on sequences (<code>freemarker.template.TemplateSequenceModel</code>-s).</p></li>
<li><p><code>?long</code> now works for date, date-time or time values, and returns the milliseconds since the epoch (as <code>java.util.Date.getTime()</code>).</p></li>
<li><p>To convert numbers (usually Java <code>long</code>-s) to date or date-time and time values, <code>?number_to_date</code>, <code>?number_to_time</code>, <code>?number_to_datetime</code> was added. <a href="#ref_builtin_numToDate">See more here...</a> (Unfortunately, <code>?date</code> and like can't be extended to support this due to backward compatibility issues.)</p></li>
<li><p>New built-ins to format numbers with ISO 8601 &quot;extended&quot; format regardless of the current date/time formatting settings, and even regardless of the current time zone setting. For example <code>${myTimeStamp?iso_utc}</code> will print something like <code>2010-05-16T23:05:45Z</code>. <a href="#ref_builtin_date_iso">See more here...</a></p></li>
<li><p>New <a href="#ref_specvar">special variable</a>, <code>now</code>. This returns the current date-time. Usage examples: &quot;<code>Page generated: ${.now}</code>&quot;, &quot;<code>Today is ${.now?date}</code>&quot;, &quot;<code>The
              current time is ${.now?time}</code>&quot;.</p></li>
<li><p><code>?sort</code> and <code>?sort_by</code> now supports sorting boolean values.</p></li>
<li><p>When using unsupported or unknown <a href="#ref_builtin_string_flags">string built-in flags</a>, FreeMarker will now <a href="#pgui_misc_logging">log</a> warnings (maximum 25 times per class-loader, to prevent flooding the log). It's certain that starting from FreeMarker 2.4 these will count as errors.</p></li>
<li><p>Bug fixed <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=3047201&amp;group_id=794">[3047201]</a>: Using regular expressions (like with <code>?match</code>) could cause lockup in multi-threaded environment, also memory leakage when using dynamically generated regular expressions.</p></li>
<li><p>Bug fixed: <code>?seq_contains</code>, <code>?seq_index_of</code> and <code>?seq_last_index_of</code> has failed with non-<code>java.util.List</code> <code>java.util.Collection</code>-s that are wrapped with pure <code>BeansWrapper</code> (not the <code>DefaultObjectWrapper</code>) as <code>TemplateSequenceModel</code>. (See also: <code>getSupportsIndexedAccess()</code> below)</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p><em>Security fix</em>: Using carefully crafted template names (template paths) that contain code point 0 (<code>'\u0000'</code>), it was possible to load files from outside the template root directory like if they were FreeMarker templates. The root of the problem is that the underlying native C/C++ part (which belongs to the Java platform or to the OS) interprets the 0 as the end of the string, while Java (and hence FreeMarker and the Servlet container) doesn't. Thus a path that looked safe for FreeMarker become unsafe on the lower level. The problem is present with all ways of loading templates by name (<code>Configuration.getTemplate(...)</code>, <code>&lt;#include
              ...&gt;</code>, <code>&lt;#import
              ...&gt;</code>).</p>
<p>You are not affected if you don't allow users to upload templates and also at least one of these stands:</p>
<ul>
<li><p>In your system users can't provide arbitrary strings as template names (template paths). For example, if users are only allowed to visit the URL-s that belong to the MVC Controller (like they can't visit <code>*.ftl</code>) then they can't suggest arbitrary template names.</p></li>
<li><p>The template names are part of the path in the Web page URL, and your webserver or Servlet container disallows URL-s that contain <code>%00</code>, or terminate the URL at it before passing it to the servlets.</p></li>
<li><p>You are using <code>FileTemplateLoader</code> and linking is not allowed in it (by default it isn't allowed).</p></li>
</ul></li>
<li><p>FreeMarker now can log its messages directly using SLF4J or Apache Commons Logging. However, it will not use these logger libraries automatically, until 2.4; <a href="#pgui_misc_logging">see more here...</a> But it's recommended to switch to SLF4J now.</p></li>
<li><p>New setting: <code>&quot;auto_flush&quot;</code>, <code>Configurable.setAutoFlush(boolean)</code>. Sets whether the output <code>Writer</code> is automatically flushed at the end of <code>Template.process(Object,
              Writer)</code> (and its overloads). The default is <code>true</code>, which corresponds to the earlier behavior. Using <code>false</code> is needed for example when a Web page is composed from several boxes (like portlets, GUI panels, etc.) that aren't inserted with <code>#include</code> (or with similar directives) into a master FreeMarker template, rather they are all processed with a separate <code>Template.process(...)</code> call. In a such scenario the automatic flushes would commit the HTTP response after each box, hence interfering with full-page buffering, and also possibly decreasing performance with too frequent and too early response buffer flushes.</p></li>
<li><p>Added new setting: <code>Configuration.setNewBuiltinClassResolver(TemplateClassResolver)</code>, or <code>new_builtin_class_resolver</code> property. This allows you to specify how the <a href="#ref_builtin_new"><code>new</code> built-in</a> (like in <code>&quot;com.example.SomeClass&quot;?new()</code>) resolves classes and which classes are accessible at all. If you are allowing not-so-much-trusted users to upload templates, you should be definitely interested; see the Java API docs of <code>freemarker.core.Configurable.setSetting</code> and <code>freemareker.template.Configuration.setNewBuiltinClassResolver</code>. Otherwise it's still recommended to set this to <code>TemplateClassResolver.SAFER_RESOLVER</code> (or <code>safer</code> if you are using properties), although that's not 100% backward compatible (see Java API docs) .</p></li>
<li><p>Added <code>freemarker.cache.NullCacheStorage</code>: Setting this as the cache storage in <code>Configuration</code> disables caching.</p></li>
<li><p>Added <code>getSupportsIndexedAccess()</code> to <code>freemarker.ext.beans.CollectionModel</code>, so one can check if <code>TemplateSequenceModel.get(int)</code> will work with a particular <code>CollectionModel</code> instance or not.</p></li>
<li><p>Bug fixed <a href="http://sourceforge.net/tracker/?func=detail&amp;aid=2992265&amp;group_id=794&amp;atid=100794">[2992265]</a>: JSP <code>FreeMarkerPageContext.include</code> behaved incorrectly.</p></li>
<li><p>Bug fixed: When using FreeMarker's JSP support with JSP tags that use <code>javax.servlet.jsp.PageContext.pushBody</code> (like some Stripes tags), <code>&quot;ArrayIndexOutOfBoundsException:
              -1&quot;</code> occurred inside <code>freemarker.ext.jsp.FreeMarkerPageContext.popWriter</code>.</p></li>
<li><p>Bug fixed <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=3033015&amp;group_id=794">[3033015]</a>: <code>AllHttpScopesHashModel</code> used <code>WrappingTemplateModel.getDefaultObjectWrapper()</code> for wrapping variables in the page scope, while used the user-specified <code>ObjectWrapper</code> for all other scopes (request, session, etc.). Now it uses the user-specified wrapper in the page scope as well.</p></li>
<li><p>Bug fixed <a href="https://sourceforge.net/tracker/?func=detail&amp;aid=3128073&amp;group_id=794&amp;atid=100794">[3128073]</a>: <code>HashAdapther.containsKey(...)</code> returned <code>true</code> for a key that doesn't exist when unwrapping the key has failed. As a side effect of the fix, <code>BeansWrapper.CAN_NOT_UNWRAP</code> is now private; earlier it was public by mistake.</p></li>
<li><p>Big fixed <a href="http://sourceforge.net/tracker/?func=detail&amp;aid=3151085&amp;group_id=794&amp;atid=100794">[3151085]</a>: <code>freemarker.jsp.TaglibFactory</code> didn't locate tld files properly. This fix gives better compliance with JSP specification for resolving and loading tld files.</p></li>
<li><p>Bug fixed: Unwrapping <code>null</code> with a <code>BeansWrapper</code> that had a custom null-model didn't result in <code>null</code>. Now both unwrapping <code>null</code> and the custom null-model gives <code>null</code>.</p></li>
<li><p>Log messages doesn't contain line-breaks (CR or LF) anymore and quote paths and other arbitrary text with Java string literal syntax that also escapes <code>&lt;</code> characters as <code>\u003C</code>. These address security concerns related to poor quality log appenders and buggy log readers. This change is mostly noticeable on template processing error entries, which will now quote the exception message. Note that how stack traces (the <code>Throwable</code> objects) are logged is still up to the logging framework you are using.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>The DTD-s and XSD-s that are included in <code>freemarker.jar</code> under <code>freemarker/ext/jsp</code> are now under Apache Software License, Version 2. This is also clarified in the <code>LICENSE.txt</code>. Earlier these files had no clear license terms.</p></li>
</ul>
<h2 id="versions_2_3_16">2.3.16</h2>
<p>Date of release: 2009-12-07</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Fixed a bug that caused incorrect unwrapping of sequences to Java arrays (<a href="https://sourceforge.net/tracker/?func=detail&amp;aid=2105310&amp;group_id=794&amp;atid=100794">See bug report</a>)</p></li>
<li><p>Fixed a bug that caused rounding of float and double values (<a href="https://sourceforge.net/tracker/?func=detail&amp;aid=2503124&amp;group_id=794&amp;atid=100794">See bug report</a>)</p></li>
<li><p>Created a new <code>freemarker.runtime.attempt</code> category and exceptions caught in <code>&lt;#attempt&gt;</code> blocks are logged into it at a DEBUG severity.</p></li>
<li><p>Fixing the (ages old) problem of <code>RhinoWrapper</code> not working with all versions of Rhino because of binary incompatible change of Rhino's <code>Undefined.instance</code>.</p></li>
<li><p>Fixed bug where <code>TextUtil.XMLEncNQG</code> didn't escape <code>]]&gt;</code> as <code>]]&amp;gt;</code>.</p></li>
<li><p>Fixed bug where the root directory couldn't be used as the template base directory, as <code>FileTemplateLoader</code> believed that the template is outside the base directory.</p></li>
<li><p>Macro names can no longer be changed through the API.</p></li>
<li><p>FreemarkerServlet now cooperates with Session Fixation Attack Protection in Spring Security, see <a href="https://sourceforge.net/projects/freemarker/forums/forum/2345/topic/3475868">forum discussion</a> for details.</p></li>
<li><p>Substantially improved performance of the <code>&lt;#return&gt;</code> directive.</p></li>
</ul>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Fixed bug where <code>anXMLNode.@@markup</code> and <code>@@nested_markup</code> didn't escape <code>]]&gt;</code> as <code>]]&amp;gt;</code>.</p></li>
</ul>
<h2 id="versions_2_3_15">2.3.15</h2>
<p>Date of release: 2008-12-16</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Bug fixed: Hash concatenation (like <code>hash1 +
              hash2</code>) shuffled the order of keys/values even if both hashes were ordered.</p></li>
<li><p>In web pages that are based on the <code>FreemarkerServlet</code>, you can now use <code>&lt;@include_page path=&quot;...&quot;/&gt;</code> to use servlet includes. See more <a href="#pgui_misc_servlet_include">here...</a></p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>The <code>BeansWrapper</code> can automatically detect that classes were reloaded by JavaRebel.</p></li>
<li><p>Fixed a bug that caused <code>null</code> to be returned from <code>Environment.getCurrentEnvironment()</code> while processing autoincludes and autoimports. (<a href="https://sourceforge.net/forum/message.php?msg_id=5531621">See bug report</a>)</p></li>
<li><p>Fixed a bug that caused <code>getObject(Object)</code> method on POJOs to not be recognized as a general get method.</p></li>
<li><p>Substantially improved performance of the <code>&lt;#break&gt;</code> directive.</p></li>
<li><p><code>DeepUnwrap</code> now unwraps custom null model of the current object wrapper into a Java <code>null</code>.</p></li>
</ul>
<h2 id="versions_2_3_14">2.3.14</h2>
<p>Date of release: 2008-09-01</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New built-in: <code>xhtml</code>. See more <a href="#ref_builtin_xhtml">here...</a></p></li>
<li><p>New special variable: <code>template_name</code>. See more <a href="#ref_specvar">here...</a></p></li>
<li><p>Now you can use the values of parameters as the defaults of other parameters, for example <code>&lt;#macro section
              title label=title&gt;</code>. In earlier versions it worked unreliably. There are no restriction regarding the order of parameters, like <code>&lt;#macro section label=title
              title&gt;</code> works too.</p></li>
<li><p>Added a new <a href="#ref_builtin_string_for_number">number format specifier</a>, <code>computer</code>. This uses the same formatting as <code>exp?c</code>.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>The constructor to <code>freemarker.ext.servlet.AllHttpScopesHashModel</code> is now public, allowing it to be reused in 3rd party web frameworks.</p></li>
<li><p>Bugfix: <code>freemarker.ext.beans.SimpleMapModel</code> (unlike either <code>freemarker.ext.beans.MapModel</code> or <code>freemarker.template.SimpleHash</code>) didn't allow lookup by <code>java.lang.Character</code> key when passed a single-character string as a key.</p></li>
<li><p>Bugfix: permissive unwrapping in <code>freemarker.template.utility.DeepUnwrap</code> class was not recursively permissive with elements of sequences and hashes.</p></li>
<li><p>Bugfix: <code>freemarker.ext.beans.MapModel</code> returns <code>BeansWrapper.wrap(null)</code> instead of <code>null</code> for <code>null</code> values explicitly bound into the map.</p></li>
<li><p>Bugfix: Fixed a subtle bug with property getters of classes implementing a type-parametrized interface.</p></li>
<li><p>Bug fixed: A further corner case of <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1939742&amp;group_id=794&amp;atid=100794">[1939742]</a>.</p></li>
</ul>
<h2 id="versions_2_3_13">2.3.13</h2>
<p>Date of release: 2008-05-05</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New built-ins for rounding numbers: <code>round</code>, <code>floor</code>, <code>ceiling</code>. See more <a href="#ref_builtin_rounding">here...</a></p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p><a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1898300&amp;group_id=794&amp;atid=350794">[1898300]</a>, <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1818742&amp;group_id=794&amp;atid=350794">[1818742]</a>, <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1780882&amp;group_id=794&amp;atid=350794">[1780882]</a>: Reworked template caching mechanism for radically improved concurrent performance, with help from Azul Systems engineers. (Achieved 20x speedup with Struts2 webapps on a 128-CPU Azul device compared to 2.3.12.) Also, template loading (including parsing) errors are now cached, improving performance in applications that often try to get missing templates.</p></li>
<li><p><a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1892546&amp;group_id=794&amp;atid=100794">[1892546]</a> Allow for custom <code>TemplateLoader</code> in <code>FreemarkerServlet</code>.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1725107&amp;group_id=794&amp;atid=100794">[1725107]</a> Using the FreeMarker JSP taglib support with Servlet 2.4 may generates XML validation warnings.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1939742&amp;group_id=794&amp;atid=100794">[1939742]</a> <code>ConcurrentModificationException</code> on accessing nonexistent <code>SimpleHash</code> entries in a loop</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1902012&amp;group_id=794&amp;atid=100794">[1902012]</a> <code>IteratorModel</code> eats exception causes</p></li>
<li><p>Bug fixed: <code>&lt;#assign
              x&gt;&lt;/#assign&gt;</code> (empty nested content) has caused <code>NullPointerException</code></p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1926150&amp;group_id=794&amp;atid=100794">[1926150]</a> <code>CachedTemplate</code> should be serializable</p></li>
</ul>
<h2 id="versions_2_3_12">2.3.12</h2>
<p>Date of release: 2008-02-03</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1857161&amp;group_id=794&amp;atid=100794">[1857161]</a> JSP <code>SimpleTag</code> support was broken in 2.3.11.</p></li>
<li><p>In the templates, now you can conveniently call Java methods that use the Java 5 varargs feature (variable-length argument lists). Also the overloaded-method chooser logic now considers vararg methods more intelligently.</p></li>
<li><p>Enum constants are now identified by their <code>name()</code> instead of by their <code>toString()</code> (because the latter can be overridden in subclasses). This doesn't affect the way enum constants are printed; of course that still uses <code>toString()</code>.</p></li>
<li><p>Messages in parser exceptions now display the name of the template.</p></li>
</ul>
<h2 id="versions_2_3_11">2.3.11</h2>
<p>Date of release: 2007-12-04</p>
<p>This release contains several performance and usability improvements.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1687248&amp;group_id=794&amp;atid=100794">[1687248]</a> <strong>Warning! This bugfix may breaks some templates!</strong> Fixed the bugs of the <a href="#ref_builtin_c"><code>c</code> built-in</a> (<code>?c</code>) that sometimes caused whole numbers to be formatted with “.0” at the end (like: 1.0), and caused numbers sometimes formatted to exponential form (like 4E-20). From now whole numbers will never use decimal dot (not even if the wrapped number is a <code>double</code>; remember, the template language knows only a single numerical type), and exponential form will never be used either. Also, the maximum number of digits after the decimal dot was limited to 16, so numbers smaller than 1E-16 will be shown as 0.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>FreeMarker now has much better JSP 2.0 and JSP 2.1 compliance. Most notably, the JSP 2.0 <code>SimpleTag</code> interface is now supported. Additionally, even when run in an environment that doesn't have its own JSP implementation, the FreeMarker JSP runtime will make available its own implementation of <code>JspFactory</code> and <code>JspEngineInfo</code> to tags when JSP 2.0 API JAR is available in classpath, as well as an implementation of <code>JspApplicationContext</code> when JSP 2.1 API JAR is available in classpath.</p></li>
<li><p>A new model interface, <code>TemplateDirectiveModel</code> provides an easier paradigm for implementing user-defined directives than <code>TemplateTransformModel</code> did previously. <code>TemplateTransformModel</code> will be deprecated.</p></li>
<li><p>FreeMarker now finds the Xalan-based XPath support included in Sun JRE/JDK 5 and 6, so no separate Xalan jar is required for the XPath support to work. (However, we recommend Jaxen over Xalan, as the FreeMarker XPath support is more complete with that. Of course for that the Jaxen jar is still needed.)</p></li>
<li><p>Wrapping performance of <code>BeansWrapper</code> has been significantly improved by eliminating repetitive execution of various class tests.</p>
<p><strong>Note for <code>BeansWrapper</code> customizers:</strong> subclasses of <code>BeansWrapper</code> that previously overrode <code>getInstance(Object, ModelFactory)</code> method should now instead override <code>getModelFactory(Class)</code> to take advantage of this improvement. Overriding the old method still works, but it will not take advantage of the performance improvement.</p></li>
<li><p>Memory footprint of a wrapper created by <code>BeansWrapper</code> has been reduced (by a size of one default-sized <code>HashMap</code>) until methods or indexed properties are accessed on it (simple properties can be accessed without increasing memory footprint).</p></li>
<li><p>Rhino objects can be used in templates as scalars, numbers, and booleans, following the JavaScript conversion semantics for these types.</p></li>
<li><p><code>.data_model</code> is now a <code>TemplatHashModelEx</code> when possible. This means that the list of the data-model variable names usually can be get with <code>.data_model?keys</code>.</p></li>
<li><p><code>FileTemplateLoader</code> can now optionally allow following symlinks that point out of the base directory. It is disabled by default for backward compatibility.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1670887&amp;group_id=794&amp;atid=100794">[1670887]</a> <code>TaglibFactory</code> taglib matching did not follow JSP 1.2 FCS.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1754320&amp;group_id=794&amp;atid=100794">[1754320]</a> Bug in <code>setXPathSupportClass</code> prevented plugging in a user-supplied <code>XPathSupport</code> implementation.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1803298&amp;group_id=794&amp;atid=100794">[1803298]</a> Parser error while parsing macro with loop variables</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1824122&amp;group_id=794&amp;atid=100794">[1824122]</a> Loading templates from JAR files could lead to leaking of file handles (due to a bug in the Java API implementation of Sun).</p></li>
<li><p>Bug fixed: Cached template is now removed from the cache if the re-loading of the modified template file fails, so no staled template is served.</p></li>
</ul>
<h3>Documentation changes</h3>
<ul>
<li><p>Substantial reworkings in the Template Authors's Guide (which was previously called Designer's Guide), especially in the Getting Started section.</p></li>
<li><p><code>#{...}</code> is documented as deprected construct from now.</p></li>
<li><p>The &quot;transform&quot; term is now removed from the documentation. Instead the more general &quot;user-defined directive&quot; term is used, which encompasses macros, <code>TemplateTransformModel</code>-s and the new <code>TemplateDirectiveModel</code>-s, which are just different ways of implementing user-defined directives.</p></li>
<li><p>Some more minor improvements in the Manual.</p></li>
</ul>
<h2 id="versions_2_3_10">2.3.10</h2>
<p>Date of release: 2007-04-20</p>
<p>This release contains several important bugfixes.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>[1589245] <code>MultiTemplateLoader</code> clears its internal cached data (used for optimizing subsequent lookups of the same template) when <code>Configuration.clearTemplateCache()</code> is invoked.</p></li>
<li><p>[1619257] A bug that caused an exception when <code>strict_bean_model</code> was used in a FreeMarker configuration <code>Properties</code> object or in the <code>&lt;#setting .../&gt;</code> directive has been fixed.</p></li>
<li><p>[1685176] A bug that caused <code>StackOverflowError</code> in certain interactions of garbage collector with MRU cache under Sun's Java 6 JVM has been fixed.</p></li>
<li><p>[1686955] When <code>ResourceBundleModel</code> constructs <code>MessageFormat</code> objects, it passes them its own locale. <a href="#beanswrapper_method">More info...</a></p></li>
<li><p>[1691432] A bug that caused <code>BeansWrapper.EXPOSE_SAFE</code> to be no safer than <code>BeansWrapper.EXPOSE_ALL</code> has been fixed.</p></li>
</ul>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>[1628550] You can now use <code>dateExp?string.full</code> for formatting dates using Java built-in format <code>java.util.Date.FULL</code> <a href="#ref_builtin_string_for_date">More info...</a></p></li>
</ul>
<h2 id="versions_2_3_9">2.3.9</h2>
<p>Date of release: 2007-01-23</p>
<p>This release contains support for accessing JDK 1.5 enums and public fields of classes from the templates through the BeansWrapper.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p><code>BeansWrapper</code> can now expose public fields of objects to the template if you call the <code>setExposeFields(true)</code> on it. <a href="#beanswrapper_hash">More info...</a></p></li>
<li><p><code>BeansWrapper</code> can now pass any sequence model to Java methods expecting a <code>java.util.Collection</code> or a native Java array (including primitive arrays). <a href="#beanswrapper_hash">More info...</a></p></li>
<li><p><code>BeansWrapper</code> can now pass any sequence and collection model to Java methods expecting a <code>java.lang.Iterable</code>. <a href="#beanswrapper_hash">More info...</a></p></li>
<li><p><code>BeansWrapper</code> can now unwrap numeric models into correct target types when passing to Java methods expecting a primitive or boxed number. Use of various <a href="#ref_builtins_expert">expert built-ins</a> to manually coerce the types becomes mostly unnecessary.</p></li>
<li><p>Fixed a bug where <code>BeansWrapper</code> would pass a <code>java.util.Collection</code> to a method expecting a <code>java.util.Set</code> in certain rare cases. <a href="#beanswrapper_hash">More info...</a></p></li>
<li><p>Support for JDK 1.5 enums in <code>BeansWrapper</code> and <code>DefaultObjectWrapper</code>. By calling the <code>getEnumModels()</code> method, you can retrieve a hash model that is keyed by class names and allows access to enumerated values. I.e. if you bind this hash model under name <code>enums</code> in the data-model, you can write expressions like <code>enums[&quot;java.math.RoundingMode&quot;].UP</code> in the template. The enum values can be used as scalars and support equality and inequality comparisons. <a href="#jdk_15_enums">More info...</a></p></li>
<li><p><code>freemarker.ext.rhino.RhinoWrapper</code> now correctly translates Rhino <code>Undefined</code> instance, <code>UniqueTag.NOT_FOUND</code>, and <code>UniqueTag.NULL</code> to FreeMarker undefined value.</p></li>
</ul>
<h2 id="versions_2_3_8">2.3.8</h2>
<p>Date of release: 2006-07-09</p>
<p>This release substantially improves the JSP 2.0 compatibility. (For those who have seen the same points in 2.3.7: Sorry, the version history was incorrect... those JSP 2.0 related changes were not in the release yet.)</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>JSP support improvement: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1326058&amp;group_id=794">[1326058]</a> Added support for <code>DynamicAttributes</code> (new in JSP 2.0)</p></li>
<li><p>JSP support improvement: Added support for <code>pushBody()</code>/<code>popBody()</code> in <code>FreemarkerPageContext</code></p></li>
<li><p>JSP support improvement: Added support for <code>getVariableResolver()</code> (new in JSP 2.0).</p></li>
<li><p>JSP support improvement: Added support for <code>include(String, boolean)</code> (new in JSP 2.0).</p></li>
<li><p>JSP support improvement: Added support for <code>getExpressionEvaluator()</code> (new in JSP 2.0). However, it will need Apache commons-el in the class path, or else this method will not work (it's optional). Note that EL support is not needed in principle, since FreeMarker has it's own expression language. But some custom JSP 2 tags may still want to use this method, after all it's in the JSP 2 API.</p></li>
</ul>
<h2 id="versions_2_3_7">2.3.7</h2>
<p>Date of release: 2006-06-23</p>
<p>This release, compared to 2.3.7 RC1, contains new operators for handling null/missing variables, , the <code>substring</code> built-in, and some more bugfixes. Note that 2.3.7 RC1 has a long change log, so you may want to <a href="#versions_2_3_7rc1">read that</a> too.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>The <code>seq_contains</code> built-in now handles <code>TemplateCollectionModel</code>-s as well.</p></li>
<li><p>Bug fixed: In 2.3.7 RC1 <code>FreemarkerServlet</code> has always died with <code>NullPointerException</code> during initialization.</p></li>
</ul>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>3 new operators were added for terser missing variable handling. These operators make the <code>default</code>, <code>exists</code> and <code>if_exists</code> built-ins deprecated. (The parser doesn't issue any warning messages when you use deprecated built-ins, and they are still working.):</p>
<ul>
<li><p><code>exp1!exp2</code> is near equivalent with <code>exp1?default(exp2)</code>, also <code>(exp1)!exp2</code> is near equivalent with <code>(exp1)?default(exp2)</code>. The only difference is that this new operator doesn't evaluate the <code>exp2</code> when the default value is not needed.</p></li>
<li><p><code>exp1!</code> is similar to <code>exp1?if_exists</code>, also <code>(exp1)!</code> is similar to <code>(exp1)?if_exists</code>. The difference is that with this new operator the default value is an empty string and an empty list and empty hash at the same time (multi-type variable), while with <code>if_exists</code> the default value was an empty string and an empty list and empty hash and boolean <code>false</code> and a transform that does nothing and ignores all parameters at the same time.</p></li>
<li><p><code>exp1??</code> is equivalent with <code>exp1?exists</code>, also <code>(exp1)??</code> is equivalent with with <code>(exp1)?exists</code>.</p></li>
</ul></li>
<li><p>New built-in: <code>exp?substring(from,
              toExclusive)</code>, also callable as <code>exp?substring(from)</code>. Getting substrings was possible for a long time like <code>myString[from..toInclusive]</code> and <code>myString[from..]</code>, but <code>myString?substring(from,
              toExclusive)</code> and <code>myString?substring(from)</code> has the advantage that it has an exclusive end, which is more practical. (Edit: Since 2.3.21 ranges are the preferred way again, as it has <code>myString[from..&lt;toExclusive]</code>.) Sequence (list) slices still has to be get with the old syntax, since <code>substring</code> only applies to strings. Please note that the “to” parameter is 1 greater with this new builtin, as it is an exclusive index. Further difference is that the <code>substring</code> built-in requires that the “from” index is less than or equal to the “to” index. So 0 length substrings are possible now, but not reversed substrings.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1487694&amp;group_id=794">[1487694]</a> malfunction when the <code>recover</code> directive has no nested content</p></li>
</ul>
<h2 id="versions_2_3_7rc1">2.3.7 RC1</h2>
<p>Date of release: 2006-04-27</p>
<p>This release contains many bugfixes and some <code>FreemarkerServlet</code> related improvements. It's a Release Candidate, which means that it shouldn't be used in production environment yet. We recommend this release for development, however. Please test it.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p><code>FreemarkerServlet</code> improvement: <code>AllHttpScopesHashModel</code> is now public, so you can add unlisted variables to the data-model.</p></li>
<li><p><code>FreemarkerServlet</code> improvement: When it throws a <code>ServletException</code>, the J2SE 1.4 cause exception is now set under J2SE 1.4.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1469275&amp;group_id=794">[1469275]</a> <code>NullPointerException</code> when using <code>BeansWrapper</code> with reloaded classes</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1449467&amp;group_id=794">[1449467]</a> <code>HttpSessionHashModel</code> is not <code>Serializable</code></p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1435113&amp;group_id=794">[1435113]</a> Error in <code>BeanWrapper</code> with indexed properties</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1411705&amp;group_id=794">[1411705]</a> Acquisition bug in <code>TemplateCache</code></p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1459699&amp;group_id=794&amp;atid=100794">[1459699]</a> Tag syntax can't set with <code>Configuration.setSetting(String,
              String)</code></p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1473403&amp;group_id=794">[1473403]</a> <code>ReturnInstruction.Return</code> should be public</p></li>
</ul>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1463664&amp;group_id=794">[1463664]</a>kup <code>[/#noparse]</code> is printed out</p></li>
</ul>
<h2 id="versions_2_3_6">2.3.6</h2>
<p>Date of release: 2006-03-15</p>
<p>Quick release that fixes a serious bug of 2.3.5, days after its release. So for the recently added new features please <a href="#versions_2_3_5">see the section of 2.3.5.</a></p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bug fixed: In FreeMarker 2.3.5 only, when you read a bean property for the second time, FreeMarker will say that it's missing (null).</p></li>
</ul>
<h2 id="versions_2_3_5">2.3.5</h2>
<p>Date of release: 2006-03-11</p>
<p><em>This release was withdrawn because of a serious bug in it. Please don't use it! Of course, all new features of it are included in FreeMarker 2.3.6.</em></p>
<p>A few new features and several bugfixes.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1435847&amp;group_id=794">[1435847]</a> Alternative syntax doesn't work for comments</p></li>
<li><p>Bug fixed: With the new square bracket syntax, the tag could be closed with <code>&gt;</code>. Now it can be closed with <code>]</code> only.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1324020&amp;group_id=794">[1324020]</a> <code>ParseException</code> with the <code>ftl</code> directive if it wasn't in its own line</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1404033&amp;group_id=794">[1404033]</a> <code>eval</code> built-in fails with hash concatenation</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>A new <code>Configuration</code> level setting, <code>tagSyntax</code> was added. This determines the syntax of the templates (angle bracket syntax VS <a href="#dgui_misc_alternativesyntax">square bracket syntax</a>) that has no <code>ftl</code> directive in it. So now you can choose to use the new square bracket syntax by default. However, the recommended is to use auto-detection (<code>yourConfig.setTagSyntax(Configuration.AUTO_DETECT_TAG_SYNTAX)</code>), because that will be the default starting from 2.4. Auto-detection chooses syntax based on the syntax of the first FreeMarker tag of the template (could be any FreeMarker tag, not just <code>ftl</code>). Note that as with the previous version, if a the template uses <code>ftl</code> directive, then the syntax of the <code>ftl</code> directive determines the syntax of the template, and the <code>tagSyntax</code> setting is ignored.</p></li>
<li><p>Now <code>BeansWrapper</code>, <code>DefaultObjectWrapper</code> and <code>SimpleObjectWrapper</code> support lookup with 1 character long strings in <code>Map</code>-s (like <code>myHash[&quot;a&quot;]</code>) that use <code>Character</code> keys. Simply, as a special case, when a hash lookup fails on a string that is 1 character long, it checks for the <code>Character</code> key in the underlying map. (Bug tracker entry <a href="http://sourceforge.net/tracker/?func=detail&amp;atid=100794&amp;aid=1299045&amp;group_id=794">[1299045]</a> FreeMarker doesn't support map lookup with Character keys.)</p></li>
<li><p>A new property, <code>strict</code> was added to <code>BeansWrapper</code>, <code>DefaultObjectWrapper</code> and <code>SimpleObjectWrapper</code>. If this property is <code>true</code> then an attempt to read a bean propertly in the template (like <code>myBean.aProperty</code>) that doesn't exist in the bean class (as opposed to just holding <code>null</code> value) will cause <code>InvalidPropertyException</code>, which can't be suppressed in the template (not even with <code>myBean.noSuchProperty?default('something')</code>). This way <code>?default('something')</code> and <code>?exists</code> and similar built-ins can be used to handle existing properties whose value is <code>null</code>, without the risk of hiding typos in the property names. Typos will always cause error. But mind you, it goes against the basic approach of FreeMarker, so use this feature only if you really know what are you doing.</p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1426227&amp;group_id=794&amp;atid=100794">[1426227]</a> <code>NullPointerException</code> in <code>printStackTrace(...)</code></p></li>
<li><p>Bug fixed: <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1386193&amp;group_id=794&amp;atid=100794">[1386193]</a> Division by zero in <code>ArithmeticEngine</code></p></li>
</ul>
<h2 id="versions_2_3_4">2.3.4</h2>
<p>Date of release: 2005-10-10</p>
<p>Some new features and bugfixes.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Now you can use <code>[</code> and <code>]</code> instead of <code>&lt;</code> and <code>&gt;</code> for the FreeMarker tags. For example you can write <code>[#if
              loggedIn]...[/#if]</code> and <code>[@myMacro /]</code>. <a href="#dgui_misc_alternativesyntax">More info...</a></p></li>
<li><p>Bugfix: the <code>has_content</code> built-in returned <code>false</code> for number, date and boolean values (if the value was not a multi-type value that is also a sequence or collection or hash or string). Now it always returns <code>true</code> for a number, date or boolean values (except if the value is also a sequence or collection or hash or string, because then it will be examined only like that).</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: the parameterless constructor of the <code>ClassTemplateLoader</code> didn't worked.</p></li>
<li><p>Bugfix: The Jython wrapper didn't wrapped <code>java.util.Date</code> objects well. Now it wraps them with <code>BeanWrapper</code> to <code>TemplateDateModel</code>.</p></li>
<li><p>Bugfix: the <code>include</code> directive was blamed when the included file had syntax error.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Minor Manual fixes.</p></li>
</ul>
<h2 id="versions_2_3_3">2.3.3</h2>
<p>Date of release: 2005-06-23</p>
<p>Some new features and lot of bugfixes.</p>
<p>Attention:</p>
<ul>
<li><p>If you are using the Log4J logging, from now at least Log4J 1.2 is required. This is because of incompatible changes in the Log4J API.</p></li>
<li><p>If you build FreeMarker yourself: from now at least JavaCC 3.2 (instead of JavaCC 2.1) and at least Ant 1.6.1 (instead of Ant 1.5.x) is required. This doesn't affect users who use the <code>freemarker.jar</code> comes with the distribution.</p></li>
</ul>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New built-in for formatting numbers for “computer audience” as opposed to human audience: <a href="#ref_builtin_c"><code>c</code></a>. It should be used for numbers that must use Java language formatting regardless of the number format and locale settings, like for a database record ID used as the part of an URL or as invisible field value in a HTML form, or for printing CSS/JavaScript numerical literals.</p></li>
<li><p>New built-in for the columnar/tabular displaying of sequences: <a href="#ref_builtin_chunk"><code>chunk</code></a>.</p></li>
<li><p>The <a href="#dgui_template_exp_seqenceop_slice">sequence slice</a> and substring operators now allow the omitting of the last index, in which case it defaults to the index of the last sequence item or character. Example: <code>products[2..]</code>. (Also, <a href="#dgui_template_exp_direct_seuqence">numerical range literals</a> now allow the omitting of the final number, in which case it defaults to infinity. Example: <code>5..</code>.)</p></li>
<li><p>Bugfix: <code>?replace</code> has worked forever if the string to replace was <code>&quot;&quot;</code>.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>New template loader: <code>freemarker.cache.StringTemplateLoader</code>. It uses a <code>Map</code> with <code>Strings</code> as its source of templates. See more in the JavaDoc.</p></li>
<li><p>Experimental Rhino support: FreeMarker now comes with an experimental object wrapper for Rhino (Java ECMAScript implementation): <code>freemarker.ext.rhino.RhinoWrapper</code></p></li>
<li><p>Some new utility methods for <code>SimpleXxx</code> classes: <code>SimpleHash.toMap()</code>, <code>SimpleSequence.toList()</code>.</p></li>
<li><p>Bugfix: FTL literals and any other <code>SimpleSequnce</code>-s, and <code>SimpleHash</code>-es now can be used as parameters to the FreeMarker-unaware Java methods that are exposed by <code>DefaultWrapper</code> or <code>BeansWrapper</code>. That is, the method parameters are automatically converted from <code>TemplateTypeModel</code>-s to <code>java.util.Map</code> and <code>java.util.List</code> respectively.</p></li>
<li><p>Bugfix: The JSP support now works in JSP 2 compliant containers as well. No, it doesn't support the new features of JSP 2 yet, it's just that the JSP 1.2 taglib support has not worked in JSP 2 containers.</p></li>
<li><p>Bugfix: The <code>Configuration.setOutputEncoding</code> and <code>setURLEscapingCharset</code> methods died with <code>NullPointerException</code> when you tried to set the setting value to <code>null</code>, which is legal for these settings.</p></li>
<li><p>Bugfix: <code>freemarker.template.utility.StringUtil.replace(...)</code> has worked forever if the string to replace was <code>&quot;&quot;</code>.</p></li>
<li><p>Bugfix: The Log4J logging was updated to be compatible with the upcoming Log4J 1.3. Note that now FreeMarker will need at least Log4J 1.2.</p></li>
<li><p>Bugfix: FreeMarker didn't built from the source code on J2SE 1.5, because of the introduction of the <code>enum</code> keyword.</p></li>
<li><p>Bugfix: The return value of <code>SimpleSequence.synchronizedWrapper()</code> was not properly synchronized. Same with <code>SimpleHash.synchronizedWrapper()</code>.</p></li>
<li><p>Bugfix: Problem with <code>BeansWrapper</code> and overridden bean methods/properties. (Details: bug-tracker entry <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1217661&amp;group_id=794&amp;atid=100794">#1217661</a> and <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1166533&amp;group_id=794&amp;atid=100794">#1166533</a>)</p></li>
<li><p>Bugfix: Can't access JSP taglibs if <code>Request</code> attribute is defined in the data-model (Details: bug-tracker entry <a href="http://sourceforge.net/tracker/index.php?func=detail&amp;aid=1202918&amp;group_id=794&amp;atid=100794">#1202918</a>).</p></li>
<li><p>Bugfix: Various minor parser glitches were fixed.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Manual improvements, especially in the FAQ.</p></li>
</ul>
<h2 id="versions_2_3_2">2.3.2</h2>
<p>Date of release: 2005-01-22</p>
<p>Bugfix release.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: If you use JSP taglibs in FreeMarker templates, FreeMarker possibly tried to get DTD-s from the Sun Web site because of a bug introduced with FreeMarker 2.3.1. This was a serious problem since if your server is offline or the Sun Web site becomes temporarily inaccessible the templates that are using JSP taglibs will possibly die with error.</p></li>
<li><p>Bugfix: The <code>DefaultObjectWrapper</code> has ignored the value of the <code>nullModel</code> property. (Note that it's discouraged to use a “null model”.)</p></li>
</ul>
<h2 id="versions_2_3_1">2.3.1</h2>
<p>Date of release: 2005-01-04</p>
<p>Maintenance (with some important new features) and bugfix release.</p>
<h3>Possible backward compatibility issue</h3>
<p>There is a bugfix that may affect the behavior of you Web application if you use JSP tags in FreeMarker templates: FreeMarker's implementation of <code>javax.servlet.jsp.PageContext.getSession()</code> was incorrect. The <code>getSession()</code> method is a convenience method by which the custom tag can get the current <code>HttpSession</code> object (possibly <code>null</code> if there is no session). Till now, if the session didn't existed then it has created it automatically, so it never returned <code>null</code>. This was a bug, so starting from 2.3.1 it never creates the session, just returns <code>null</code> if it doesn't exist. The old incorrect behavior could cause page rendering to fail if the method is called after the page is partially flushed. But beware, the old behavior has possibly hidden some bugs of the Web application, where it forgot to create the session, so with the new correct behavior you may face malfunction caused by previously cloaked bugs of the Web application. (It's the task of the MVC Controller to create the session, except if the JSP tag that needs a session is written so it creates it automatically, but then it doesn't expects that <code>getSession()</code> will do it.)</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New built-in: <a href="#ref_builtin_url"><code>url</code></a>. This built-in can be used for URL escaping. Note, however, that to use this built-in conveniently, the software that encapsulates FreeMarker has to be 2.3.1 aware (programmers will find more info bellow...).</p></li>
<li><p>New <a href="#ref_specvar">special variables</a>: <code>output_encoding</code> and <code>url_escaping_charset</code>. Note, however, that to use these, the software that encapsulates FreeMarker has to be 2.3.1 aware (programmers will find more info bellow...).</p></li>
<li><p>New built-ins for sequences: <a href="#ref_builtin_seq_contains"><code>seq_contains</code></a>, <a href="#ref_builtin_seq_index_of"><code>seq_index_of</code></a>, <a href="#ref_builtin_seq_last_index_of"><code>seq_last_index_of</code></a>.</p></li>
<li><p>New built-ins for strings: <a href="#ref_builtin_left_pad"><code>left_pad</code></a>, <a href="#ref_builtin_right_pad"><code>right_pad</code></a> and <a href="#ref_builtin_contains"><code>contains</code></a>.</p></li>
<li><p>New directive: <a href="#ref.directive.attempt"><code>attempt</code>/<code>recover</code></a></p></li>
<li><p>The <a href="#ref_builtin_js_string"><code>js_string</code> built-in</a> now escapes <code>&gt;</code> as <code>\&gt;</code> (to avoid <code>&lt;/script&gt;</code>).</p></li>
<li><p>The <code>sort</code> and <code>sort_by</code> built-ins now can sort by date values. Also, <code>sort_by</code> built-in now can sort by the subvarible of a subvariable of a subvariable... etc. for any level depth. (<a href="#ref_builtin_sort_by">Details...</a>)</p></li>
<li><p><code>freemarker.template.TemplateExceptionHandler.HTML_DEBUG_HANDLER</code> now prints more HTML-context-proof messages.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>New setting: <code>output_encoding</code>. This setting is used for informing FreeMarker about the charset that the enclosing software (as a Web application framework) uses for the output of FreeMarker. It's undefined by default, and although it is not strictly required to set it, the enclosing software should do so. This setting must be set if templates want to use the new <code>output_encoding</code> special variable, and possibly if they want to use the new <code>url</code> built-in. Note that the FreeMarker API allows you to set settings for each template execution individually (look at <code>Template.createProcessingEnvironment(...)</code>).</p></li>
<li><p>New setting: <code>url_escaping_charset</code>. This is the charset used for calculating the escaped parts (<code>%XX</code>) when you do URL escaping with the new <code>url</code> built-in. If it is not set, then the <code>url</code> built-in uses the value of the <code>output_encoding</code> setting, and if that's not set either, then the parameterless version of <code>url</code> built-in (<code>${foo?url}</code>) can't be used.</p></li>
<li><p>Using the singleton (static) <code>Configuration</code> instance is clearly a bad practice, so related methods are now deprecated, and the Manual was adjusted, and the <code>FreemarkerXmlTask</code> was updated as well.</p></li>
<li><p>The <code>freemarker.template.utility.Constants</code> class was added that contains various static final fields that store frequently used constant <code>TemplateModel</code> values, as <code>EMPTY_SEQUENCE</code>, <code>ZERO</code>, ...etc.</p></li>
<li><p>When using <code>SecurityManager</code> with FreeMarker, accessing system properties may caused AccessControlException. Now such exceptions are catched and logged with warning level, and the default value of the property is returned.</p></li>
<li><p>The needles <code>InvocationTargetException</code> is now removed from the exception cause trace in certain cases.</p></li>
<li><p>Added a dirty hack that prints <code>ServletException</code> root cause in <code>TemplateException</code>'s stack trace if that's the direct cause exception of the <code>TemplateException</code>, despite the poorly written <code>ServletException</code> class.</p></li>
<li><p>Bugfix: FreeMarker's implementation of <code>javax.servlet.jsp.PageContext.getSession()</code> was incorrect. The <code>getSession()</code> method is a convenience method by which the custom tag can get the current <code>HttpSession</code> object (possibly <code>null</code> if there is no session). Till now, if the session didn't existed then it has created it automatically, so it never returned <code>null</code>. This was a bug, so starting from 2.3.1 it never creates the session, just returns <code>null</code> if it doesn't exist. The old incorrect behavior could cause page rendering to fail if the method is called after the page is partially flushed. But beware, the old behavior has possibly hidden some bugs of the Web application, where it forgot to create the session, so with the new correct behavior you may face malfunction caused by previously cloaked bugs of the Web application. (It's the task of the MVC Controller to create the session, except if the JSP tag that needs a session is written so it creates it automatically, but then it doesn't expects that <code>getSession()</code> will do it.)</p></li>
<li><p>Bugfix: The <code>BeansWrapper</code> didn't always handled properly the case of a Java class having both a public static field and a public static method with the same name.</p></li>
<li><p>Bugfix: <code>SimpleMethodModel</code> had incorrectly propagate exceptions sometimes, causing null pointer exception.</p></li>
<li><p>Bugfix: The template execution may used outdated cached values when you have processed the same <code>Environment</code> for multiple times, and changed settings between the two processings. Note that this could happen only in single-thread environment, where such setting modifications are allowed.</p></li>
<li><p>Bugfix: Some of the string built-ins has died with <code>IndexOutOfBounds</code> exception if the template author has forgotten to specify required parameters. Now they die with more helpful error messages.</p></li>
<li><p>Bugfix: <code>freemarker.ext.dom.NodeModel.equals(...)</code> has died with null pointer exception if its argument was <code>null</code>.</p></li>
<li><p>Bugfix: The cause exception of <code>TemplateException</code>-s was sometimes printed twice in stack traces with J2SE 1.4 or later.</p></li>
<li><p>Bugfix: The <code>StringUtil.FTLStringLiteralEnc(String)</code> method was finished.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Fixes and improvements in the Manual and in the API JavaDoc.</p></li>
</ul>
<h3>The history of the releases before the final version</h3>
<h4>Differences between the preview release and final release</h4>
<ul>
<li><p>Added a dirty hack that prints <code>ServletException</code> root cause in <code>TemplateException</code>'s stack trace if that's the direct cause exception of the <code>TemplateException</code>, despite the poorly written <code>ServletException</code> class.</p></li>
<li><p>Bugfix: <code>freemarker.ext.dom.NodeModel.equals(...)</code> has died with null pointer exception if its argument was <code>null</code>.</p></li>
<li><p>Bugfix: The cause exception of <code>TemplateException</code>-s was sometimes printed twice in stack traces with J2SE 1.4 or later.</p></li>
<li><p>More minor improvements in the Manual.</p></li>
</ul>
<h2 id="versions_2_3">2.3</h2>
<p>Date of release: 2004-June-15</p>
<p>FreeMarker 2.3 introduces numerous little new features and quality improvements compared to the 2.2.x series. The most notable improvements are the ability to define functions (methods) in templates, the ability to interpolate variables in string literals, the support for a variable number of macro parameters, and the more intelligent default object wrapper. Although none of the improvements is a drastic change, the 2.3.x series is not backward compatible with the 2.2.x series (see the list below), so you may choose to use it for new projects only.</p>
<p>Probably the most “loudly promoted” new feature is the totally redesigned XML wrapper. With the new XML wrapper FreeMarker targets a new application domain, which is similar to the application domain of XSLT: transforming complex XML to whatever textual output. Although this subproject is young, it is definitely usable in practice. See the <a href="#xgui">XML Processing Guide</a> for more details.</p>
<h3>Non backward-compatible changes!</h3>
<ul>
<li><p>Since interpolations (<code>${...}</code> and <code>#{...}</code>) now work inside string literals, the character sequence <code>${</code> and <code>#{</code> in string literals are reserved for that. So if you have something like <code>&lt;#set x =
              &quot;${foo}&quot;&gt;</code>, then you have to replace it with <code>&lt;#set x = r&quot;${foo}&quot;&gt;</code> -- beware, escapes such as <code>\n</code> will not work in raw (<code>r</code>) strings.</p></li>
<li><p>The default (initial) value of the <code>strict_syntax</code> setting has been changed from <code>false</code> to <code>true</code>. When <code>strict_syntax</code> is <code>true</code>, tags with old syntax as <code>&lt;include
              &quot;foo.ftl&quot;&gt;</code> will be considered as static text (so they go to the output as-is, like HTML tags do), and not as FTL tags. Such tags have to be rewritten to <code>&lt;#include
              &quot;foo.ftl&quot;&gt;</code>, since only parts that starts with <code>&lt;#</code>, <code>&lt;/#</code>, <code>&lt;@</code>, or <code>&lt;/@</code> count as FTL tags. Or, to recover the old transitional behavior, where both legacy and new tag syntax was recognized, you have to explicitly set <code>strict_syntax</code> to <code>false</code>: <code>cfg.setStrictSyntaxMode(false)</code>. Also, for individual templates you can force the old behavior by starting the template with <code>&lt;#ftl
              strict_syntax=false&gt;</code>. (For more information about why strict syntax is better than old syntax <a href="#ref_depr_oldsyntax">read this...</a>)</p></li>
<li><p>Several classes were moved from the <code>freemarker.template</code> package, to the new <code>freemarker.core</code> package:</p>
<ul>
<li><p>&quot;Normal&quot; classes: <code>ArithmeticEngine</code>, <code>Configurable</code>, <em><code>Environment</code></em></p></li>
<li><p>Exceptions: <code>InvalidReferenceException</code>, <code>NonBooleanException</code>, <code>NonNumericalException</code>, <code>NonStringException</code>, <code>ParseException</code>, <code>StopException</code></p></li>
<li><p>Errors: <code>TokenMgrError</code></p></li>
</ul>
<p>The main reason of the splitting of <code>freemarker.template</code> package was that the amount of &quot;expert&quot; public classes and interfaces grows too much, as we introduce API-s for third-party tools, such as debugging API.</p></li>
<li><p><code>freemarker.template.TemplateMethodModel.exec</code> now returns <code>Object</code> instead of <code>TemplateModel</code>.</p></li>
<li><p>White-space stripping is now more aggressive as before: it always removes leading and trailing white-space if the line only contains FTL tags. (Earlier the white-space was not removed if the tag was <code>&lt;#include
              ...&gt;</code> or user-defined directive tag with empty directive syntax as <code>&lt;@myMacro/&gt;</code> (or its equivalents: <code>&lt;@myMacro&gt;&lt;/@myMacro&gt;</code> and <code>&lt;@myMacro&gt;&lt;/@&gt;</code>). Now white-space is removed in these cases as well.) Also, white-space sandwiched between two non-outputting elements, such as macro definitions, assignments, imports, or property settings, is now ignored. More information: <a href="#dgui_misc_whitespace_stripping">section_title</a></p></li>
<li><p>The <code>function</code> directive is now used for defining methods. You should replace <code>function</code> with <code>macro</code> in your old templates. Note, however, that old <code>function</code>-s will still work if you don't use the <code>return</code> directive in them, and you invoke them with the deprecated the <code>call</code> directive.</p></li>
<li><p>The expressions <code>as</code>, <code>in</code>, and <code>using</code> are now keywords in the template language and cannot be used as top-level variable names without square-bracket syntax. If, by some chance, you have top-level variables that use one of these names, you will have to rename them, or use the square-bracket syntax with the <code>.vars</code> special variable: <code>.vars[&quot;in&quot;]</code>.</p></li>
<li><p>The <code>?new</code> built-in, as it was implemented, was a security hole. Now, it only allows you to instantiate a java object that implements the <code>freemarker.template.TemplateModel</code> interface. If you want the functionality of the <code>?new</code> built-in as it existed in prior versions, make available an instance of the <code>freemarker.template.utility.ObjectConstructor</code> class to your template. (For example: <code>myDataModel.put(&quot;objConstructor&quot;, new
              ObjectConstructor());</code>, and then in the template you can do this: <code>&lt;#assign aList =
              objConstructor(&quot;java.util.ArrayList&quot;, 100)&gt;</code>)</p></li>
<li><p>Changes to the <code>FreemarkerServlet</code>:</p>
<ul>
<li><p>The <code>FreemarkerServlet</code> uses <code>ObjectWrapper.DEFAULT_WRAPPER</code> by default instead of <code>ObjectWrapper.BEANS_WRAPPER</code>. What this means is that, by default, objects of type <code>java.lang.String</code>, <code>java.lang.Number</code>, <code>java.util.List</code>, and <code>java.util.Map</code> will be wrapped as <code>TemplateModels</code> via the classes <code>SimpleScalar</code>, <code>SimpleNumber</code>, <code>SimpleSequence</code>, and <code>SimpleHash</code> respectively. Thus, the java methods on those objects will not be available. The default wrapper implementation in FreeMarker 2.3 automatically knows how to wrap Jython objects, and also wraps <code>org.w3c.dom.Node</code> objects into instances of <code>freemarker.ext.dom.NodeModel</code>.</p></li>
<li><p>The <code>FreemarkerServlet</code> base implementation no longer deduces the locale used for templates with <code>HttpRequest.getLocale()</code>. Rather, it simply delegates to the new protected method, <code>deduceLocale</code>. The default implementation of this method simply returns the value of configuration the <code>locale</code> setting.</p></li>
</ul></li>
</ul>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Interpolation in string literals. For convenience, interpolations are now supported in string literals. For example: <code>&lt;@message &quot;Hello ${user}!&quot; /&gt;</code> is the same as <code>&lt;@message &quot;Hello &quot; + user + &quot;!&quot;
              /&gt;</code></p></li>
<li><p>Raw string literals: In string literals prefixed with <code>r</code>, interpolations and escape sequences will not be interpreted as special tokens. For example: <code>r&quot;\n${x}&quot;</code> will be simply interpreted as the character sequence <code>'\'</code>, <code>'n'</code>, <code>'$'</code>, <code>'{'</code>, <code>'x'</code>, <code>'}'</code>, and not as line-feed and the value of the <code>x</code> variable.</p></li>
<li><p>Method variables can be defined in FTL, with the <a href="#ref.directive.function"><code>function</code></a> directive.</p></li>
<li><p>Support for a variable number of macro parameters. If the last parameter in a macro declaration ends with <code>...</code>, all extra parameters passed to the macro will be available via that parameter. For macros called with positional parameters, the parameter will be a sequence. For named parameters, the parameter will be a hash. Note that it all works with the new <code>function</code> directive as well.</p></li>
<li><p>A new header parameter, <code>strip_text</code>, that removes all top-level text from a template. This is useful for “include files” to suppress newlines that separate the macro definitions. See <a href="#ref.directive.ftl"><code>ftl</code> directive</a></p></li>
<li><p>New <a href="#ref_specvar">special variable</a>: <code>.vars</code>. This is useful to read top-level variables with square bracket syntax, for example <code>.vars[&quot;name-with-hyphens&quot;]</code> and <code>.vars[dynamicName]</code>.</p></li>
<li><p><code>macro</code> and assignment directives now accept arbitrary destination variable name with quoted syntax. For example: <code>&lt;#macro
              &quot;name-with-hyphens&quot;&gt;...</code> or <code>&lt;#assign &quot;foo bar&quot; = 123&gt;</code>.</p></li>
<li><p>The <code>?keys</code> and <code>?values</code> hash built-ins now return sequences. In practical terms this means you can access their sizes or retrieve their sub variables by index, and use all of the <a href="#ref_builtins_sequence">sequence built-ins</a>. (Note for the programmers: The <code>TemplateHashModelEx</code> interface has not been changed. Your old code will work. See the API documentation to see why.)</p></li>
<li><p>Existence built-ins (<code>?default</code>, <code>?exists</code>, etc.) are now working with sequence sub variables as well. Read the documentation of the <code>default</code> built-in for more information.</p></li>
<li><p>White-space stripping is now more aggressive as before: it always removes leading and trailing white-space if the line only contains FTL tags. (Earlier the white-space was not removed if the tag was <code>&lt;#include
              ...&gt;</code> or user-defined directive tag with empty directive syntax as <code>&lt;@myMacro/&gt;</code> (or its equivalents: <code>&lt;@myMacro&gt;&lt;/@myMacro&gt;</code> and <code>&lt;@myMacro&gt;&lt;/@&gt;</code>). Now white-space is removed in these cases as well.) Also, top-level white-space that separates macro definitions and/or assignments is now ignored. More information: <a href="#dgui_misc_whitespace_stripping">section_title</a></p></li>
<li><p>White-space stripping can be disabled for a single line with the <a href="#ref.directive.nt"><code>nt</code></a> directive (for No Trim).</p></li>
<li><p>Hashes can be concatenated using the <code>+</code> operator. The keys in the hash on the right-hand side take precedence.</p></li>
<li><p>New built-ins for Java and JavaScript string escaping: <a href="#ref_builtin_j_string">j_string</a> and <a href="#ref_builtin_js_string">js_string</a></p></li>
<li><p>The <code>replace</code> and <code>split</code> built-ins now support case-insensitive comparsion and regular expressions (J2SE 1.4+ only), and some other new options. More information can be found <a href="#ref_builtin_string_flags">here</a>.</p></li>
<li><p>New built-in for regular expression matching (J2SE 1.4+ only): <a href="#ref_builtin_matches"><code>matches</code></a></p></li>
<li><p>New built-in, <code>eval</code>, to evaluate a string as FTL expression. For example <code>&quot;1+2&quot;?eval</code> returns the number 3.</p></li>
<li><p>New built-ins for Java and JavaScript string escaping: <a href="#ref_builtin_j_string">j_string</a> and <a href="#ref_builtin_js_string">js_string</a></p></li>
<li><p>New special variables to read the value of the locale setting: <code>locale</code>, <code>lang</code>. See more <a href="#ref_specvar">in the reference...</a></p></li>
<li><p>New special variable to read the FreeMarker version number: <code>version</code>. See more <a href="#ref_specvar">in the reference...</a></p></li>
<li><p>Tree new directives, <code>recurse</code>, <code>visit</code> and <code>fallback</code>, were introduced to support declarative node-tree processing. These are meant to be used typically (though not exclusively) for processing XML input. Together with this, a new variable type has been introduced, the node type. See the <a href="#xgui_declarative">chapter on declarative XML processing</a> for more details.</p></li>
<li><p>The <code>?new</code> built-in, as it was implemented, was a security hole. Now, it only allows you to instantiate a java object that implements the <code>freemarker.template.TemplateModel</code> interface. If you want the functionality of the <code>?new</code> built-in as it existed in prior versions, make available an instance of the <code>freemarker.template.utility.ObjectConstructor</code> class to your template. (For example: <code>myDataModel.put(&quot;objConstructor&quot;, new
              ObjectConstructor());</code>, and then in the template you can do this: <code>&lt;#assign aList =
              objConstructor(&quot;java.util.ArrayList&quot;,
              100)&gt;</code>)</p></li>
<li><p>Variable names can contain <code>@</code> anywhere (without using quote-bracket syntax). For example: <code>&lt;#assign x@@@ = 123&gt;</code> is valid.</p></li>
<li><p>The expressions <code>as</code>, <code>in</code>, and <code>using</code> are now keywords in the template language and cannot be used as top-level variable names without square-bracket syntax (as <code>.vars[&quot;in&quot;]</code>).</p></li>
<li><p>New parameter to the <a href="#ref_directive_ftl"><code>ftl</code> directive</a>: <code>attributes</code>. The value of this attribute is a hash that associates arbitrary attributes (name-value pairs) to the template. The values of the attributes can be of any type (string, number, sequence... etc.). FreeMarker doesn't try to understand the meaning of the attributes. It's up to the application that encapsulates FreeMarker (as a Web application framework). Thus, the set of allowed attributes and their semantic is application (Web application framework) dependent.</p></li>
<li><p>Other minor quality improvements...</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Smarter default object wrapping: The default object wrapper is now <code>freemarker.template.DefaultObjectWrapper</code>, which falls back on wrapping arbitrary objects as beans using the <code>freemarker.ext.beans.BeansWrapper</code>. Also, it will wrap <code>org.w3c.dom.Node</code> objects with the new DOM wrapper. Also, it is aware of Jython objects, and will use <code>freemarker.ext.jython.JythonWrapper</code> if the object passed in is a Jython object. (We count it as a backward compatible change, since this new object wrapper wraps differently only those objects that the old wrapper was not able to wrap, so it has thrown exception.)</p></li>
<li><p><code>freemarker.template.TemplateMethodModel.exec</code> now returns <code>Object</code> instead of <code>TemplateModel</code>.</p></li>
<li><p>The default (initial) value of the <code>strict_syntax</code> setting has been changed from <code>false</code> to <code>true</code>. When <code>strict_syntax</code> is <code>true</code>, tags with old syntax as <code>&lt;include
              &quot;foo.ftl&quot;&gt;</code> will be considered as static text (so they go to the output as-is, like HTML tags do), and not as FTL tags. Such tags have to be rewritten to <code>&lt;#include
              &quot;foo.ftl&quot;&gt;</code>, since only parts that starts with <code>&lt;#</code>, <code>&lt;/#</code>, <code>&lt;@</code>, or <code>&lt;/@</code> count as FTL tags. Or, to recover the old transitional behavior, where both legacy and new tag syntax was recognized, you have to explicitly set <code>strict_syntax</code> to <code>false</code>: <code>cfg.setStrictSyntaxMode(false)</code>. Also, for individual templates you can force the old behavior by starting the template with <code>&lt;#ftl
              strict_syntax=false&gt;</code>. (For more information about why strict syntax is better than old syntax <a href="#ref_depr_oldsyntax">read this...</a>)</p></li>
<li><p>New <code>CacheStorage</code> implementation: <code>freemarker.cache.MruCacheStorage</code>. This cache storage implements a two-level Most Recently Used cache. In the first level, items are strongly referenced up to the specified maximum. When the maximum is exceeded, the least recently used item is moved into the second level cache, where they are softly referenced, up to another specified maximum. <code>freemarker.cache.SoftCachseStorage</code> and <code>StrongCachseStorage</code> are deprected, <code>MruCachseStorage</code> is used everywhere instead. The default cache storage is now an <code>MruCachseStorage</code> object with 0 strong size, and infinite soft size. <code>Configuration.setSetting</code> for <code>cache_storage</code> now understands string values as <code>&quot;strong:200, soft:2000&quot;</code>.</p></li>
<li><p>For <code>BeansWrapper</code> generated models, you can now use the <code>${obj.method(args)}</code> syntax to invoke methods whose return type is <code>void</code>. <code>void</code> methods now return <code>TemplateModel.NOTHING</code> as their return value.</p></li>
<li><p><code>freemarker.template.SimpleHash</code> now can wrap read-only <code>Map</code>-s, such as the map of HTTP request parameters in Servlet API.</p></li>
<li><p>The <code>TemplateNodeModel</code> interface was introduced to support recursive processing of trees of nodes. Typically, this will be used in relation to XML.</p></li>
<li><p>New package: <code>freemarker.ext.dom</code>. This contains the new XML wrapper, that supports the processing of XML documents using the visitor pattern (i.e. with <code>&lt;#visit ...&gt;</code> and similar directives), and to provide more convenient XML traversing as the legacy wrapper. See the <a href="#xgui">XML processing guide</a> for more details.</p></li>
<li><p>New package: <code>freemarker.core</code>. Classes used by mostly power-users was moved here from the <code>freemarker.template</code> package. The main reason of the splitting of <code>freemarker.template</code> package was that the amount of &quot;expert&quot; public classes and interfaces grows too much, as we introduce API-s for third-party tools, such as debugging API.</p></li>
<li><p>New package: <code>freemarker.debug</code>. This provides a debugging API, by which you can debug executing templates through network (RMI). You have to write the front-end (client), as the API is just the server side. For more information please read the JavaDoc of the <code>freemarker.debug</code> package.</p></li>
<li><p>You can query the FreeMarker version number with static method <code>Configuration.getVersionNumber()</code>. Also, the <code>Manifest.mf</code> included in <code>freemarker.jar</code> now contains the FreeMarker version number, furthermore, executing it with <code>java
              -jar freemarker.jar</code> will print the version number to the stdout.</p></li>
<li><p>Added a new protected <code>FreemarkerServlet</code> method: <code>Configuration
              getConfiguration()</code>.</p></li>
<li><p>Date support is now labeled as final. (It was experimental earlier.)</p></li>
<li><p>The <code>BeansWrapper</code> has been improved to prevent some security exceptions when introspecting.</p></li>
<li><p>Other minor quality improvements and extensions...</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Fixes and improvements in the Manual and in the API JavaDoc.</p></li>
</ul>
<h3>The history of the releases before the final version</h3>
<h4>Differences between the final release and Release Candidate 4</h4>
<ul>
<li><p>Added a new special variable to print the FreeMarker version number: <code>version</code>. See more <a href="#ref_specvar">in the reference...</a></p></li>
<li><p>Minor documentation fixes and improvements.</p></li>
</ul>
<h4>Differences between the Release Candidate 4 and Release Candidate 3</h4>
<ul>
<li><p>The <code>BeansWrapper</code> has been improved to prevent some security exceptions when introspecting.</p></li>
<li><p>The <code>FreemarkerXmlTask</code> has two new sub-tasks that can be used to prepare template execution with Jython scripts: <code>prepareModel</code> and <code>prepareEnvironment</code>. The <code>jython</code> sub-task is now deprecated, and does the same as <code>prepareEnvironment</code>. See the Java API documentation for more details.</p></li>
<li><p>New special variable to read the FreeMarker version number: <code>version</code>. See more <a href="#ref_specvar">in the reference...</a></p></li>
<li><p>Bugfix: Greater-than sign doesn't confuse the <code>eval</code> built-in anymore.</p></li>
<li><p>Bugfix: The <code>BeansWrapper</code> now wrapps the <code>null</code> return values of methods appropriately.</p></li>
<li><p>Bugfix: The <code>FreemarkerXmlTask</code> doesn't need Jython classes anymore, unless you really use Jython scripts. Several other bugfixes in the Jython related features.</p></li>
<li><p>Bugfix: If the template exception handler has ignored the exception, errors occurring in interpolations inside FTL tags (e.g. <code>&lt;#if &quot;foo${badVar}&quot; !=
                &quot;foobar&quot;&gt;</code>) were handled in the same way as errors occuring in interpolations outside FTL tags. Thus, the directive call was not skipped, and the problematic interpolation was replaced with an empty string. (This was inconsistent with the behavior of <code>&lt;#if
                &quot;foo&quot;+badVar != &quot;foobar&quot;&gt;</code>, which should be 100% equivalent with the previous example.)</p></li>
<li><p>Bugfix: The <code>FileTemplateLoader</code> is now more robust when it receives paths that are malformed according the native file system. In the earlier version such paths sometimes caused unexpected <code>IOException</code> that aborted the searching for the template in further <code>FileTemplateLoader</code>-s when you use the <code>MultiTemplateLoader</code>.</p></li>
</ul>
<h4>Differences between the Release Candidate 3 and Release Candidate 2</h4>
<ul>
<li><p>Bugfix: Fixing a fatal bug in the template cache that was introduced with the latest cache bugfix. The template cache has always reloaded the unchanged template when the update delay has been elapsed, until the template has been actually changed, in which case it has never reloaded the template anymore.</p></li>
</ul>
<h4>Differences between the Release Candidate 2 and Release Candidate 1</h4>
<ul>
<li><p>Bugfix: The template cache didn't reload the template when it was replaced with an older version.</p></li>
<li><p>API JavaDoc fix: date/time related classes/interfaces were marked as experimental. They are not experimental.</p></li>
<li><p>Minor site improvements.</p></li>
</ul>
<h4>Differences between the Release Candidate 1 and Preview 16 releases</h4>
<ul>
<li><p><em>Warning! Non-backward-compatible change!</em> The default (initial) value of the <code>strict_syntax</code> setting has been changed from <code>false</code> to <code>true</code>. When <code>strict_syntax</code> is <code>true</code>, tags with old syntax as <code>&lt;include
                &quot;foo.ftl&quot;&gt;</code> will be considered as static text (so they go to the output as-is, like HTML tags do), and not as FTL tags. Such tags have to be rewritten to <code>&lt;#include &quot;foo.ftl&quot;&gt;</code>, since only parts that starts with <code>&lt;#</code>, <code>&lt;/#</code>, <code>&lt;@</code>, or <code>&lt;/@</code> count as FTL tags. Or, to recover the old transitional behavior, where both legacy and new tag syntax was recognized, you have to explicitly set <code>strict_syntax</code> to <code>false</code>: <code>cfg.setStrictSyntaxMode(false)</code>. Also, for individual templates you can force the old behavior by starting the template with <code>&lt;#ftl
                strict_syntax=false&gt;</code>. (For more information about why strict syntax is better than old syntax <a href="#ref_depr_oldsyntax">read this...</a>)</p></li>
<li><p>New parameter to the <a href="#ref_directive_ftl"><code>ftl</code> directive</a>: <code>attributes</code>. The value of this attribute is a hash that associates arbitrary attributes (name-value pairs) to the template. The values of the attributes can be of any type (string, number, sequence... etc.). FreeMarker doesn't try to understand the meaning of the attributes. It's up to the application that encapsulates FreeMarker (as a Web application framework). Thus, the set of allowed attributes and their semantic is application (Web application framework) dependent.</p></li>
<li><p>Bugfix: <code>freemarker.template.utility.DeepUnwrap</code> unwrapped sequences to empty <code>ArrayList</code>-s.</p></li>
<li><p>Bugfix: If you included/imported a template with <code>*/</code> in path (acquisition), and that template in turn itself included/imported another template with <code>*/</code> in path, it may failed.</p></li>
<li><p>New methods to the <code>freemarker.core.Environment</code>: <code>importLib(Template loadedTemplate, java.lang.String
                namespace)</code>, <code>getTemplateForImporting(...)</code>, <code>getTemplateForInclusion(...)</code>.</p></li>
<li><p>Improvements in the <code>java.io.IOException</code> related error messages of the <code>include</code> and <code>import</code> directives.</p></li>
<li><p>Minor improvements in the documentation.</p></li>
</ul>
<h4>Differences between the Preview 16 and Preview 15 releases</h4>
<ul>
<li><p>New package: <code>freemarker.debug</code>. This provides a debugging API, by which you can debug executing templates through network (RMI). You have to write the front-end (client), as the API is just the server side. For more information please read the JavaDoc of the <code>freemarker.debug</code> package. (The debugging API is present for a while, just I forgot to announce it in the version history. Sorry for that.)</p></li>
<li><p>Bugfix: With the new XML wrapper, <code>@@markup</code> and similar special keys:</p>
<ul>
<li><p>have returned <code>&lt;foo&gt;&lt;/foo&gt;</code> for empty elements instead of <code>&lt;foo /&gt;</code>. Other than it was needlessly verbose, it has confused browsers if you generate HTML.</p></li>
<li><p>have showed the attributes that have no explicitly given value in the original document, just a default value coming form the DTD.</p></li>
<li><p>have forgot to put space before the system identifier in the <code>&lt;!DOCTYPE
                    ...&gt;</code>.</p></li>
</ul></li>
<li><p>Bugfix: XPath with Jaxen has died with <code>NullPointerException</code> if the context was an empty node set.</p></li>
<li><p>A bit more intelligent Xalan XPath error messages.</p></li>
<li><p>Revoked fallback-to-classloader logic from the template cache.</p></li>
<li><p>From now on, if no XPath engine is available, and the hash key in an XML query can't be interpreted without XPath, an error will tell this clearly, rather than silently returning undefined variable (null).</p></li>
<li><p>Bugfix: Some templates have caused the parser to die.</p></li>
<li><p>Some other minor improvements here and there...</p></li>
</ul>
<h4>Differences between the Preview 15 and Preview 14 releases</h4>
<ul>
<li><p>Bugfix: The new default template cache storage (<code>MruCacheStorage</code>) has started to continually fail with <code>NullPointerException</code> from a random point of time, usually when the memory usage was high in the JVM.</p></li>
<li><p>Bugfix: In error messages, when the quoted FTL directive had nested content, that was quoted as well, so the quotation could be very long and expose nested lines needlessly.</p></li>
</ul>
<h4>Differences between the Preview 14 and Preview 13 releases</h4>
<ul>
<li><p><code>freemarker.template.TemplateMethodModel.exec</code> now returns <code>Object</code> instead of <code>TemplateModel</code>.</p></li>
<li><p>Fixes and improvements for XPath with Jaxen (not Xalan). Non-node-set XPath expressions are now working. FreeMarker variables are accessible in XPath expressions with XPath variable references (e.g. <code>doc[&quot;book/chapter[title=$currentTitle]&quot;]</code>).</p></li>
<li><p><code>freemarker.cache.SoftCachseStorage</code> and <code>StrongCachseStorage</code> is deprected. The more flexible <code>MruCachseStorage</code> is used instead everywhere. The default cache storage is now an <code>MruCachseStorage</code> object with 0 strong size, and infinite soft size. <code>Configuration.setSetting</code> for <code>cache_storage</code> now understands string values as <code>&quot;strong:200, soft:2000&quot;</code>.</p></li>
<li><p>Bugfix: <code>freemarker.cache.MruCachseStorage</code> has died with <code>ClassCastException</code> sometimes.</p></li>
<li><p>New built-ins for Java and JavaScript string escaping: <a href="#ref_builtin_j_string">j_string</a> and <a href="#ref_builtin_js_string">js_string</a></p></li>
<li><p><code>freemarker.template.TemplateExceptionHandler.HTML_DEBUG_HANDLER</code> now prints more HTML-context-proof messages.</p></li>
<li><p>You can query the FreeMarker version number with static method <code>Configuration.getVersionNumber()</code>. Also, the <code>Manifest.mf</code> included in <code>freemarker.jar</code> now contains the FreeMarker version number, furthermore, executing it with <code>java
                -jar freemarker.jar</code> will print the version number to the stdout.</p></li>
<li><p>Added a new protected <code>FreemarkerServlet</code> method: <code>Configuration getConfiguration()</code>.</p></li>
<li><p>Bugfix: FreeMarker has frozen on empty conditional blocks in certain contexts.</p></li>
<li><p>Bugfix: Methods called twice on an object using the <code>list</code> directive, as <code>parent.getChildren()</code> with <code>&lt;#list parent.children as child&gt;
                ...&lt;/#list&gt;</code></p></li>
</ul>
<h4>Differences between the Preview 13 and Preview 12 releases</h4>
<ul>
<li><p>White-space stripping is now more aggressive as before: it always removes leading and trailing white-space if the line only contains FTL tags. (Earlier the white-space was not removed if the tag was <code>&lt;#include
                ...&gt;</code> or user-defined directive tag with empty directive syntax as <code>&lt;@myMacro/&gt;</code> (or its equivalents: <code>&lt;@myMacro&gt;&lt;/@myMacro&gt;</code> and <code>&lt;@myMacro&gt;&lt;/@&gt;</code>). Now white-space is removed in these cases as well.) Also, top-level white-space that separates macro definitions and/or assignments is now ignored. More information: <a href="#dgui_misc_whitespace_stripping">section_title</a></p></li>
<li><p>White-space stripping can be disabled for a single line with the <a href="#ref.directive.nt"><code>nt</code></a> directive (for No Trim).</p></li>
<li><p>A new directive for the declarative XML processing: <a href="#ref.directive.fallback"><code>fallback</code></a></p></li>
<li><p><code>freemarker.template.SimpleHash</code> now can wrap read-only <code>Map</code>-s, such as the map of HTTP request parameters in Servlet API.</p></li>
</ul>
<h4>Differences between the Preview 12 and Preview 11 releases</h4>
<p>The only change between this and the previous preview release is that Preview 11 had a bug where DOM trees would <em>never</em> be garbage-collected.</p>
<h4>Differences between the Preview 11 and Preview 10 releases</h4>
<ul>
<li><p>Many XML related changes. Some of them are incompatible with the previous preview releases! For a more detailed explanation of how XML related features now work, see: <a href="#xgui">part_title</a></p>
<ul>
<li><p>Attention! Attribute queries such as <code>foo.@bar</code> now return sequences (similarly to child element queries and XPath queries), not single nodes. Because of the rule with node sequences of size 1, it is still good to write <code>${foo.@bar}</code>, but built-ins such as <code>?exists</code>, <code>?if_exists</code> or <code>?default</code> don't work as before. For example, instead of <code>foo.@bar?default('black')</code>, you now have to write <code>foo.@bar[0]?default('black')</code>. So if you have used existence built-ins with attributes, you have to find those occurrences in the templates and add that <code>[0]</code>.</p></li>
<li><p>Attention! XML name-space handling has been totally reworked and is absolutely incompatible with pre 10. Don't worry about this if none of your XML input documents use you use <code>xmlns</code> attributes. Worry, though, if you have utilized the “loose mode”, where only the local name of elements were compared, because that's now gone. Sorry...</p></li>
<li><p>Attention! Special-keys <code>@@</code> and <code>@*</code> now return a sequence of attribute nodes instead of the hash of them.</p></li>
<li><p>Several hash keys are now working for node sequences that store multiple nodes. For example, to get the list of all <code>para</code> elements of all <code>chapter</code>-s, just write <code>doc.book.chapter.para</code>. Or, to get list of title attributes of all <code>chapter</code>-s write <code>doc.book.chapter.@title</code>.</p></li>
<li><p>New special hash keys: <code>**</code>, <code>@@start_tag</code>, <code>@@end_tag</code>, <code>@@attribute_markup</code>, <code>@@text</code>, <code>@@qname</code>.</p></li>
<li><p><code>?parent</code> for attribute nodes now returns the element node the attribute node belongs to.</p></li>
<li><p>You can use Jaxen instead of Xalan for XPath expressions, if you call the static <code>freemarker.ext.dom.NodeModel.useJaxenXPathSupport()</code> method once. We plan to use Jaxen automatically instead of Xalan if it is available, just the Jaxen support is not fully functional yet.</p></li>
</ul></li>
<li><p>New special variable: <code>.vars</code>. This is useful to read top-level variables with square bracket syntax, for example <code>.vars[&quot;name-with-hyphens&quot;]</code> and <code>.vars[dynamicName]</code>.</p></li>
<li><p>New built-in, <code>eval</code>, to evaluate a string as FTL expression. For example <code>&quot;1+2&quot;?eval</code> returns the number 3.</p></li>
<li><p><code>FreemarkerServlet</code> now uses the configuration's <code>locale</code> setting, rather than <code>Locale.getDefault()</code>, to set the locale of the templates. Also, the signature of the <code>deduceLocale</code> method has been changed.</p></li>
<li><p>We have a new (beta status) <code>CacheStorage</code> implementation: <code>freemarker.cache.MruCacheStorage</code>. This cache storage implements a two-level Most Recently Used cache. In the first level, items are strongly referenced up to the specified maximum. When the maximum is exceeded, the least recently used item is moved into the second level cache, where they are softly referenced, up to another specified maximum. You can plug to try it with <code>cfg.setCacheStorage(new
                freemarker.cache.MruCacheStorage(maxStrongSize,
                maxSoftSize))</code>.</p></li>
</ul>
<h4>Differences between the Preview 10 and Preview 9 releases</h4>
<ul>
<li><p>The special key <code>@@xmlns</code> was removed in favor of a new FTL directive for the same purpose, <code>&lt;#xmlns...&gt;</code>.</p></li>
<li><p>By default, the system is stricter about the use of namespace prefixes. In general, you must use a prefix to qualify subelements that are associated with an XML nampespace. You can do this with the new <code>&lt;#xmlns...&gt;</code> directive, but prefixes declared in the input XML doc will actually work with no declaration.</p></li>
<li><p>Introduced a new special key called <code>@@text</code> that returns all the text nodes contained (recursively) in an element all concatenated together.</p></li>
<li><p>Either Jaxen or Xalan can be used to provide XPath functionality. Prior versions only worked with Xalan.</p></li>
<li><p>The <code>FreemarkerServlet</code> uses <code>ObjectWrapper.DEFAULT_WRAPPER</code> by default instead of <code>ObjectWrapper.BEANS_WRAPPER</code>. What this means is that, by default, objects of type <code>java.lang.String</code>, <code>java.lang.Number</code>, <code>java.util.List</code>, and <code>java.util.Map</code> will be wrapped as <code>TemplateModels</code> via the classes <code>SimpleScalar</code>, <code>SimpleNumber</code>, <code>SimpleSequence</code>, and <code>SimpleHash</code> respectively. Thus, the java methods on those objects will not be available. The default wrapper implementation in FreeMarker 2.3 automatically knows how to wrap Jython objects, and also wraps <code>org.w3c.dom.Node</code> objects into instances of <code>freemarker.ext.dom.NodeModel</code>.</p></li>
<li><p>The <code>FreemarkerServlet</code> base implementation no longer deduces the locale to use from the HttpRequest.getLocale() hook. Rather, it simply delegates to a <code>deduceLocale()</code> hook that is overridable in subclasses. The base implementation simply uses <code>Locale.getDefault()</code></p></li>
</ul>
<h4>Differences between the Preview 9 and Preview 8 releases</h4>
<ul>
<li><p>Fixed bugs introduced with Preview 8: XPath, <code>@@markup</code> and <code>@@nested_markup</code> now works with the document node.</p></li>
</ul>
<h4>Differences between the Preview 8 and Preview 7 releases</h4>
<ul>
<li><p><code>macro</code> and assignment directives now accept arbitrary destination variable name with quoted syntax. For example: <code>&lt;#macro
                &quot;foo-bar&quot;&gt;...</code> or <code>&lt;#assign &quot;this+that&quot; = 123&gt;</code>. This is important, because XML element names can contain hyphen, and it was not possible to define a handler macro for those elements, till now.</p></li>
<li><p>Special key <code>@@content</code> was renamed to <code>@@nested_markup</code>.</p></li>
<li><p>Fixed outdated XML related Manual parts (that were outdated even in Preview 7).</p></li>
<li><p>Better parse-error messages.</p></li>
<li><p>Minor bugfixes here and there...</p></li>
</ul>
<h4>Differences between the Preview 7 and Preview 6 releases</h4>
<ul>
<li><p>Caching of XPath queries should lead to significant performance improvements for XML processing, at least when XPath is heavily used.</p></li>
<li><p>Refinements in handling of XML namespaces in the XML processing functionality. The new <code>strict_namespace_handling</code> setting introduced in 2.3pre6 was removed. A general-purpose solution was arrived at that should make that configuration setting unnecessary.</p></li>
<li><p>Special key <code>@xmlns</code> was renamed to @@xmlns. Reserved namespace prefix <code>default</code> was renamed to <code>@@default</code>.</p></li>
<li><p>The <code>ftl</code> directive now accepts non-string types.</p></li>
<li><p>New special keys were introduced for XML node wrappers in the freemarker.ext.dom package. The <code>@@markup</code> key returns the literal markup that make up that element and the <code>@@content</code> key returns all the element's markup excluding the opening and closing tags.</p></li>
<li><p>Minor bugfixes here and there...</p></li>
</ul>
<h4>Differences between the Preview 6 and Preview 5 releases</h4>
<ul>
<li><p>Existence built-ins (<code>?default</code>, <code>?exists</code>, etc.) now work with sequence sub variables as well. Read the <a href="#ref.directive.default">documentation of the <code>default</code> built-in</a> for more information.</p></li>
<li><p>The <code>matches</code> built-in now returns a sequence instead of a collection.</p></li>
<li><p>Refinements in handling of XML namespaces in the XML processing functionality. A new setting, <code>strict_namespace_handling</code> was introduced. If this is set (it is off by default) any node-handling macro used in with the visit/recurse machinery must be from a macro library that declares in its ftl header that it handles the namespace in question.</p></li>
<li><p>Minor bugfixes here and there...</p></li>
</ul>
<h4>Differences between the Preview 5 and Preview 4 releases</h4>
<ul>
<li><p>The <code>replace</code> and <code>split</code> built-ins now support case-insensitive comparison and regular expressions (J2SE 1.4+ only), and some other new options. More information can be found <a href="#ref_builtin_string_flags">here</a>.</p></li>
<li><p>New butilt-in for regular expression matching (J2SE 1.4+ only): <a href="#ref_builtin_matches"><code>matches</code></a></p></li>
<li><p>Minor bugfixes here and there...</p></li>
<li><p>Manual: More browser-safe HTML-s. More updated content.</p></li>
</ul>
<h4>Differences between the Preview 4 and Preview 3 releases</h4>
<ul>
<li><p>Bugfix: with multi-type variables, <code>+</code> operator overload for hash type had higher precedence than the precedence of some older overloads.</p></li>
<li><p>The API documentation was missing from the distribution <code>tar.gz</code>.</p></li>
</ul>
<h4>Differences between the Preview 3 and Preview 2 releases</h4>
<ul>
<li><p>XML processing: Many various bugfixes, especially with the declarative processing.</p></li>
<li><p>XML processing: the <code>namespace_uri</code> built-in, the <code>xmlnsuri</code> header parameter, and the <code>TemplateNodeModel.getNodeNamespace</code> method were renamed to <code>node_namespace</code> and <code>getNodeNamespace</code> respectively.</p></li>
<li><p>XML processing: Better documentation. Especially, note: <a href="#xgui">part_title</a></p></li>
<li><p>A new header parameter, <code>strip_text</code>, that removes all top-level text from a template. See <a href="#ref.directive.ftl"><code>ftl</code> directive</a></p></li>
<li><p>Support for a variable number of macro parameters. If the last parameter in a macro declaration ends with <code>...</code>, all extra parameters passed to the macro will be available via that parameter. For macros called with positional parameters, the parameter will be a sequence. For named parameters, the parameter will be a hash.</p></li>
<li><p>For <code>BeansWrapper</code> generated models, you can now use the <code>${obj.method(args)}</code> syntax to invoke methods whose return type is <code>void</code>. <code>void</code> methods now return <code>TemplateModel.NOTHING</code> as their return value.</p></li>
</ul>
<h4>Differences between the Preview 2 and Preview 1 releases</h4>
<ul>
<li><p>The <code>freemarker.ext.dom.NodeModel</code> API changed slightly. The <code>setDocumentBuilder()</code> method was changed to <code>setDocumentBuilderFactory()</code> because the older scheme was not thread-safe. The <code>stripComments</code> and <code>stripPIs</code> methods are renamed to The <code>removeComments</code> and <code>removePIs</code>, and are fixed now. A new method, <code>simplify</code> has been added.</p></li>
<li><p>The expressions <code>as</code>, <code>in</code>, and <code>using</code> are now keywords in the template language and cannot be used as top-level variable names without square-bracket syntax (as <code>.vars[&quot;in&quot;]</code>). If, by some chance, you have top-level variables that use one of these names, you will have to rename them (or use the square-bracket syntax). Sorry for the inconvenience.</p></li>
<li><p>The <code>?new</code> built-in, as it was implemented, was a security hole. Now, it only allows you to instantiate a java object that implements the <code>freemarker.template.TemplateModel</code> interface. If you want the functionality of the <code>?new</code> built-in as it existed in prior versions, make available an instance of the new <code>freemarker.template.utility.ObjectConstructor</code> class to your template.</p></li>
<li><p>The <code>&lt;#recurse&gt;</code> directive was broken. It did not work with a <code>using</code> clause. This is now fixed.</p></li>
</ul>
<h2 id="versions_2_2_8">2.2.8</h2>
<p>Date of release: 2004-June-15</p>
<p>Bugfix and maintenance release.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Added a new special variable to print the FreeMarker version number: <code>version</code>. See more <a href="#ref_specvar">in the reference...</a></p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>The <code>BeansWrapper</code> has been improved to prevent some security exceptions when introspecting.</p></li>
<li><p>Bugfix: The <code>FileTemplateLoader</code> is now more robust when it receives paths that are malformed according the native file system. In the earlier version such paths sometimes caused unexpected <code>IOException</code> that aborted the searching for the template in further <code>FileTemplateLoader</code>-s when you use the <code>MultiTemplateLoader</code>.</p></li>
<li><p>Some parts of the FreeMarker code has been marked as privileged code section, so you can grant extra privileges to FreeMarker when you use a security manager (this is a backporting from 2.3). See more <a href="#pgui_misc_secureenv">here...</a></p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Minor documentation fixes and improvements.</p></li>
</ul>
<h2 id="versions_2_2_7">2.2.7</h2>
<p>Date of release: 2004-March-17</p>
<p>Important bugfix release.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: Fixing a fatal bug in the template cache that was introduced with the latest cache “bugfix”. The template cache has always reloaded the unchanged template when the update delay has been elapsed, until the template has been actually changed, in which case it has never reloaded the template anymore.</p></li>
</ul>
<h2 id="versions_2_2_6">2.2.6</h2>
<p>Date of release: 2004-March-13</p>
<p>Maintenance and bugfix release. Some of improvements are back-portings from FreeMarker 2.3rc1.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New <a href="#ref_specvar">special variable</a>: <code>.vars</code>. This is useful to read top-level variables with square bracket syntax, for example <code>.vars[&quot;name-with-hyphens&quot;]</code> and <code>.vars[dynamicName]</code>.</p></li>
<li><p>New built-ins for Java and JavaScript string escaping: <a href="#ref_builtin_j_string">j_string</a> and <a href="#ref_builtin_js_string">js_string</a></p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: The template cache didn't reload the template when it was replaced with an older version.</p></li>
<li><p>Bugfix: <code>freemarker.template.utility.DeepUnwrap</code> unwrapped sequences to empty <code>ArrayList</code>-s.</p></li>
<li><p>Bugfix: In error messages, when the quoted FTL directive had nested content, that was quoted as well, so the quotation could be very long and expose nested lines needlessly.</p></li>
<li><p><code>freemarker.template.TemplateExceptionHandler.HTML_DEBUG_HANDLER</code> now prints more HTML-context-proof messages.</p></li>
<li><p>You can query the FreeMarker version number with static method <code>Configuration.getVersionNumber()</code>. Also, the <code>Manifest.mf</code> included in <code>freemarker.jar</code> now contains the FreeMarker version number, furthermore, executing it with <code>java
              -jar freemarker.jar</code> will print the version number to the stdout.</p></li>
<li><p>Date support is now labeled as final. (It was experimental earlier.) There was no change since FreeMarker 2.2.1.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Fixes and improvements in the Manual and in the API JavaDoc. The documentation now works with the Eclipse help plugin (accessible in the “Editor/IDE plugins” section of the FreeMarker Web page).</p></li>
<li><p>Minor site improvements.</p></li>
</ul>
<h2 id="versions_2_2_5">2.2.5</h2>
<p>Date of release: 2003-09-19</p>
<p>Maintenance and bugfix release.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Creating a <code>Configuration</code> instance using the default constructor no longer fails if the current directory is unreadable due to I/O problems, lack of security permissions, or any other exception.</p></li>
</ul>
<h2 id="versions_2_2_4">2.2.4</h2>
<p>Date of release: 2003-09-03</p>
<p>Maintenance and bugfix release.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Improvements to JSP taglib support. If some third party taglib didn't work for you with FreeMarker, maybe now it will.</p>
<ul>
<li><p>The JSP <code>PageContext</code> now implements <code>forward</code> and <code>include</code> methods.</p></li>
<li><p>Accepting <code>EVAL_PAGE</code> as an alias to <code>SKIP_BODY</code> in return values from <code>doStartTag</code>. It's a common bug in some widespread tag libraries, and now FreeMarker is less strict and accepts it.</p></li>
</ul></li>
<li><p>Fixes for some rare problems regarding namespaces of macros.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Minor improvements to the documentation.</p></li>
</ul>
<h2 id="versions_2_2_3">2.2.3</h2>
<p>Date of release: 2003-07-19</p>
<p>Bugfix release.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Added the <code>is_date</code> built-in.</p></li>
<li><p>Bugfix: Various <code>is_xxx</code> built-ins were returning <code>false</code> when applied to undefined expressions. Now they correctly fail on them.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: The JSP taglib support can now read JSP 1.2 compliant TLD XML files.</p></li>
<li><p>Bugfix: The JSP taglib support now emits more helpful exception messages when the specified TLD XML file is not found (previously it threw a <code>NullPointerException</code>).</p></li>
<li><p>Bugfix: The JSP taglib support now initializes a custom tag after its parent and page context is set as some tags expect them to be set when attribute setters are called.</p></li>
<li><p>Bugfix: The <code>BeansWrapper</code> could fail to analyze classes under very rare circumstances due to a premature storage optimization.</p></li>
</ul>
<h2 id="versions_2_2_2">2.2.2</h2>
<p>Date of release: 2003-05-02</p>
<p>Bugfix release.</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: The <code>_text</code> key of the <code>freemarker.ext.xml.NodeListModel</code> was not returning the text of the element when used with W3C DOM trees.</p></li>
<li><p>The classes are now built against JDK 1.2.2 classes, ensuring the binary compatibility of FreeMarker distribution with JDK 1.2.</p></li>
</ul>
<h2 id="versions_2_2_1">2.2.1</h2>
<p>Date of release: 2003-04-11</p>
<p>This version introduces important new features, such as the native FTL date/time type, and the auto-include and auto-import settings.</p>
<p>The date/time support is experimental, but we hope it will not substantially change. We would like to label it as final ASAP, so we urge everybody to send feedback on this topic to the mailing lists.</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>New scalar type: date. For more information read: <a href="#dgui_datamodel_scalar">section_title</a>, <a href="#dgui_datamodel_scalar">section_title</a>, <a href="#dgui_template_valueinserion_universal_date">interpolation</a>, <a href="#ref_builtin_string_for_date">?string built-in for dates</a></p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>New <code>TemplateModel</code> subinterface: <code>TemplateDateModel</code>. For more information read <a href="#pgui_datamodel_scalar">section_title</a></p></li>
<li><p>auto-include and auto-import: With these new configuration level settings, you can include and import commonly used templates (usually collection of macro definitions) at the top of all templates, without actually typing <code>&lt;#include
              ...&gt;</code> or <code>&lt;#import
              ...&gt;</code> into the templates again and again. For more information please read the Java API documentation of <code>Configuration</code></p></li>
<li><p>New template method: <code>createProcessingEnvironment</code>. This method makes it possible for you to do some special initialization on the <a href="#gloss.environment"><code>Environment</code></a> before template processing, or to read the environment after template processing. For more information please read the Java API documentation.</p></li>
<li><p>Changes to <code>freemarker.ext.beans</code> package: <code>BeanModel</code>, <code>MapModel</code>, and <code>ResourceModel</code> now implement <code>TemplateHashModelEx</code>.</p></li>
<li><p>Bugfix: <code>Configurable.setSettings(Properties)</code> didn't removed redundant spaces/tabs at the end of property values.</p></li>
</ul>
<h2 id="versions_2_2">2.2</h2>
<p>Date of release: 2003-03-27</p>
<p>This release introduces some really important new features. Unfortunately, evolution was painful again; we have a few non-backward compatible changes (see below). Also, for those of you awaiting desired native date/time type, sorry, it is still not here (because of some internal chaos in the team... stand by, it's coming).</p>
<h3>Non backward-compatible changes!</h3>
<ul>
<li><p>Macros are now plain variables. This means that if you are unlucky and you have both a macro and another variable with the same name, now the variable will overwrite the macro, so your old template will malfunction. If you have a collection of common macros, you should use the new <a href="#dgui_misc_namespace">namespace feature</a> to prevent accidental clashes with the variables used in the templates.</p></li>
<li><p>With the introduction of the new <a href="#dgui_misc_namespace">namespace support</a>, <code>global</code> and <code>assign</code> directives are no longer synonyms. <code>assign</code> creates a variable in the current <code>namespace</code>, while <code>global</code> creates variable that is visible from all namespaces (as if the variable would be in the data-model). Thus, the variable created with <code>assign</code> is more specific, and hides the variable of the same name created with <code>global</code>. As a result, if you use both <code>global</code> and <code>assign</code> mixed for the same variable in your templates, now they will malfunction. The solution is to search-and-replace all <code>global</code>s in your old templates with <code>assign</code>.</p></li>
<li><p>The reserved hash <code>root</code> no longer exists as a predefined variable (we no longer have reserved variables). Use <a href="#dgui_template_exp_var_special">special variable expressions</a> to achieve similar effects. However, we have no equivalent replacement for <code>root</code> because of the changes in the variable scopes caused by the introduction of namespaces. You may should use <code>.globals</code> or <code>.namespace</code>.</p></li>
<li><p>The <code>BeansWrapper</code> no longer exposes native Java arrays, booleans, numbers, enumerations, iterators, and resource bundles as <code>TemplateScalarModel</code>. This way, number objects wrapped through <code>BeansWrapper</code> are subject to FreeMarker's number formatting machinery. Also, booleans can be formatted using the <code>?string</code> built-in.</p></li>
<li><p>The signature of <code>Configuration.setServletContextForTemplateLoading</code> has been changed: the first parameter is now <code>Object</code> instead of <code>javax.servlet.ServletContext</code>. Thus, you have to recompile your classes that call this method. The change was required to prevent class-loading failure when <code>javax.servlet</code> classes are not available and you would not call this method.</p></li>
<li><p>This release introduces a <a href="#dgui_misc_whitespace">parse-time white-space remover</a> that strips some of the typical superfluous white-space around FreeMarker tags and comments. <em>This feature is on by default!</em> Most probably this will not cause problems if you generate white-space neutral output like HTML. But if it does cause undesirable reformatting in output you generate, you can disable it with <code>config.setWhitespaceStripping(false)</code>. Also, you can enable/disable it on a per-template basis with the new <a href="#ref.directive.ftl"><code>ftl</code></a> directive.</p></li>
<li><p>Some new directives were introduced: <code>nested</code>, <code>import</code>, <code>escape</code>, <code>noescape</code>, <code>t</code>, <code>rt</code>, <code>lt</code>. This means that if you are unlucky and the text of your template contains something like <code>&lt;nested&gt;</code>, then that will be misinterpreted as a directive. To prevent this kind of problem in the future, we recommend everybody to switch from the old syntax to the new syntax (“strict syntax”). The strict syntax will be the the default syntax starting from some of the later releases anyway. We plan to release a conversion tool for converting old templates. For more information please read: <a href="#ref_depr_oldsyntax">section_title</a></p></li>
<li><p>The data-model created by the <code>FreemarkerServlet</code> now uses automatic scope discovery, so writing <code>Application.attrName</code>, <code>Session.attrName</code>, <code>Request.attrName</code> is no longer mandatory; it's enough to write <code>attrName</code> (for more information <a href="#topic.servlet.scopeAttr">read this</a>). This may break an old template if that rely on the non-existence of certain top-level variables.</p></li>
<li><p><code>FreemarkerServlet</code> now uses the encoding of the template file for the output, unless you specify the encoding in the <code>ContentType</code> init-param, such as <code>text/html; charset=UTF-8</code>.</p></li>
<li><p>The format of template paths is now more restricted than before. The path must not use <code>/</code>, <code>./</code> and <code>../</code> and <code>://</code> with other meaning as they have in URL paths (or in UN*X paths). The characters <code>*</code> and <code>?</code> are reserved. Also, the template loader must not want paths starting with <code>/</code>. For more information please read: <a href="#pgui_config_templateloading">section_title</a></p></li>
<li><p>Till now <code>TemplateTransformModel.getWriter</code> has received null as parameter map if the transform was called without parameters. From now, it will receive an empty Map instead. Note that the previous API documentation didn't state that it always receives null if there are no parameters, so hopelessly only very few classes exploit this design mistake.</p></li>
</ul>
<h3>Changes in FTL (FreeMarker Template Language)</h3>
<ul>
<li><p>User-defined directives: Transform and macro call syntax has been unified; they can be called in the same way, as user-defined directives. This also means that macros support named parameters and nested content (like the -- now deprecated -- <code>transform</code> directive did). For example, if you have a macro called <code>sect</code>, you may call it via <code>&lt;@sect title=&quot;Blah&quot; style=&quot;modern&quot;&gt;Blah
              blah...&lt;/@sect&gt;</code>. For more information read: <a href="#dgui_misc_userdefdir">section_title</a></p></li>
<li><p>Macros are now plain variables. This significantly simplifies FreeMarker semantics, while providing more flexibility; for example you can pass macros as parameters to other macros and transforms. As for the problem of clashing commonly-used-macro and variable names, we provide a more powerful solution: namespaces.</p></li>
<li><p>Namespaces: Names-spaces are invaluable if you want to assemble collections (“libraries”) of macros and transforms (and other variables), and then use them in any template without worrying about accidental name clashes with the application specific and temporary variables, or with the variables of other collections you want to use in the same template. This is extremely important if FreeMarker users want to share their macro/transform collections. For more information read: <a href="#dgui_misc_namespace">section_title</a></p></li>
<li><p>With the introduction of namespaces our variable related terminology changed. As a result, <code>assign</code> is no longer synonymous with <code>global</code>. The <code>assign</code> directive has been undeprecated, and should be used instead of <code>global</code> almost everywhere. In the new approach <code>assign</code> creates variables in the current namespace, while <code>global</code> creates a variable that is visible from all namespaces (as if the variable were in the root of the data-model). A variable created with <code>assign</code> in the current namespace hides the variable of the same name that was created with <code>global</code>.</p></li>
<li><p><code>ftl</code> directive: With this directive you can give information about the template for FreeMarker, like the encoding (charset) of the template, the used FTL syntax variant, etc. Also, this directive helps you to write templates that are less dependent on FreeMarker configuration settings, also it helps third-party tools to identify and correctly parse FreeMarker templates. For more information see: <a href="#ref.directive.ftl"><code>ftl</code> directive</a></p></li>
<li><p>White-space stripping: FreeMarker now automatically removes some of the typical superfluous white-spaces around FreeMarker tags and comments, like the indentation spaces before- and line-break after <code>&lt;#if ...&gt;</code> tags. For more information read: <a href="#dgui_misc_whitespace_stripping">section_title</a></p></li>
<li><p>New directive to apply a common (&quot;escaping&quot;) expression to all interpolations in a block: <a href="#ref.directive.escape"><code>escape</code></a>. The name comes from the common usage of this directive for automatic HTML-escaping of interpolations.</p></li>
<li><p>The new and preferred way of number formatting with <code>string</code> built-in is <code>foo?string(format)</code>, instead of the less natural <code>foo?string[format]</code>.</p></li>
<li><p>The <code>string</code> built-in works for boolean values. For example: <code>${spamFilter?string(&quot;enabled&quot;,
              &quot;disabled&quot;)}</code>. For more information <a href="#ref_builtin_string_for_boolean">read the reference</a>.</p></li>
<li><p>The default strings for outputting boolean value using the <code>string</code> built-in can be set using the <code>boolean_format</code> setting.</p></li>
<li><p>Comments can be placed inside FTL tags and interpolations. For example: <code>&lt;#assign &lt;#-- a comment --&gt; x =
              3&gt;</code></p></li>
<li><p>All letters and numbers are enabled in variable names, also <code>$</code> is allowed (as in Java programming language). Thus you can use accents, Arabic letters, Chinese letters, etc.</p></li>
<li><p>String literals can be quoted with apostrophe-quote. <code>&quot;foo&quot;</code> and <code>'foo'</code> are equivalent.</p></li>
<li><p>New <a href="#ref_builtins_string">string built-ins</a>: <code>index_of</code>, <code>last_index_of</code>, <code>starts_with</code>, <code>ends_with</code>, <code>replace</code>, <code>split</code>, <code>chop_linebreak</code>, <code>uncap_first</code>.</p></li>
<li><p>New <a href="#ref_builtins_sequence">sequence built-ins</a>: <code>sort</code>, <code>sort_by</code>.</p></li>
<li><p>New built-ins for experts to check the type of a variable. See: <a href="#ref_builtin_isType"><code>is_...</code> built-ins</a></p></li>
<li><p>New built-in for experts to create a variable of certain Java <code>TemplateModel</code> implementation. See: <a href="#ref_builtin_new"><code>new</code> built-in</a></p></li>
<li><p>New built-in, <a href="#ref_builtin_namespace"><code>namespace</code></a>, to get the namespace of a macro.</p></li>
<li><p>New expression type: special variable expression. To prevent backward compatibility problems when we introduce new predefined variables, from now <a href="#dgui_template_exp_var_special">special variable expressions</a> are used to access them.</p></li>
<li><p>New directives: <code>t</code>, <code>rt</code> and <code>lt</code> directives allow you to do explicit white-space removal in extreme FTL applications. For more information read <a href="#ref.directive.t">the reference</a>.</p></li>
<li><p><code>assign</code>, <code>local</code> and <code>global</code> now can capture the output generated be the nested template fragment into the variable. This deprecates <code>capture_output</code> transform. More information: <a href="#ref.directive.assign">assign directive reference</a></p></li>
<li><p>Bulk assignments (as <code>&lt;#assign x=1, y=2,
              z=3&gt;</code>) no longer need colon to separate the assignments (as <code>&lt;#assign x=1 y=2 z=3&gt;</code>), although it is still allowed to preserve backward compatibility.</p></li>
<li><p>Path that contains <code>//:</code> is considered as absolute path.</p></li>
<li><p><code>include</code> and <code>transform</code> directives no longer need a semicolon to separate the template or transform name from the parameter list, although it is still allowed to preserve backward compatibility.</p></li>
<li><p><code>#</code>-less tag syntax is deprecated (but still working). That is, you should write <code>&lt;#directive
              ...&gt;</code> instead of <code>&lt;directive
              ...&gt;</code>, and <code>&lt;/#directive
              ...&gt;</code> instead of <code>&lt;/directive
              ...&gt;</code>. For more info read: <a href="#ref_depr_oldsyntax">section_title</a></p></li>
<li><p><code>foreach</code> is depreciated (but still working). Use <a href="#ref.directive.list"><code>list</code></a> instead.</p></li>
<li><p>Bugfix: Undefined variables in hash and sequence constructors (as <code>[a, b, c]</code>) didn't caused errors.</p></li>
<li><p>Bugfix: String concatenation had performance problem if there was multiple concatenations chained, as: <code>&quot;a&quot;+x+&quot;a&quot;+x+&quot;a&quot;+x+&quot;a&quot;+x+&quot;a&quot;+x</code>.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Arbitrary JSP custom tags can be used as FreeMarker transforms in <code>FreemarkerServlet</code>-driven templates. More information: <a href="#pgui_misc_servlet">section_title</a></p></li>
<li><p>Various improvements for <code>BeansWrapper</code>:</p>
<ul>
<li><p>The <code>BeansWrapper</code> no longer exposes arbitrary objects as <code>TemplateScalarModel</code>s, only <code>java.lang.String</code> and <code>Character</code> objects. This way, number objects wrapped through <code>BeansWrapper</code> are subject to FreeMarker's number formatting machinery. As a side effect, non-string and non-number objects that were previously accepted in equality and inequality operations (because they had a string representation) will now cause the engine to throw exception on comparison attempt.</p></li>
<li><p><code>java.lang.Character</code> objects are exposed as scalars through <code>BeansWrapper</code>.</p></li>
<li><p>Experimental feature: With the <code>setSimpleMapWrapper</code> method of <code>BeansWrapper</code> you can configure it to wrap <code>java.util.Map</code>-s as <code>TemplateHashModelEx</code>-s, and do not expose the methods of the object.</p></li>
</ul></li>
<li><p><code>TransformControl</code> interface (was experimental earlier): If the <code>Writer</code> returned by <code>TemplateTransformModel.getWriter</code> implements this interface, it can instruct the engine to skip or to repeat evaluation of the nested content, and gets notified about exceptions that are thrown during the nested content evaluation. Note that the <code>onStart</code> and <code>afterBody</code> methods now are allowed to throw <code>IOException</code>. For more information please read the API documentation.</p></li>
<li><p>Localized lookup can be disabled with the new <code>Configuration</code> methods: <code>set/getLocalizedLookup</code>, <code>clearTemplateCache</code></p></li>
<li><p>The new interface <code>freemarker.cache.CacheStorage</code> allows users to plug custom template caching strategies with the <code>cache_storage</code> setting. The core package now ships with two implementations: <code>SoftCacheStorage</code> and <code>StrongCacheStorage</code>. For more information read: <a href="#pgui_config_templateloading">section_title</a></p></li>
<li><p>You can set settings with string name and string value with the new <code>setSetting(String key, String
              value)</code> method of <code>Configurable</code> super-classes (as <code>Configuration</code>). Also you can load settings from <code>.properties</code> file with the <code>setSettings</code> method.</p></li>
<li><p>Other new <code>Configuration</code> methods: <code>clearTemplateCache</code>, <code>clearSharedVariables</code>, <code>getTemplateLoader</code>, and <code>clone</code>.</p></li>
<li><p>Changes to <code>TemplateTransformModel</code> interface: <code>getWriter</code> can throw <code>IOException</code>, and can return <code>null</code> if the transform does not support body content.</p></li>
<li><p>Till now <code>TemplateTransformModel.getWriter</code> has received null as parameter map if the transform was called without parameters. From now, it will receive an empty Map instead. Note that the previous API documentation didn't state that it always receives null if there are no parameters, so hopelessly only very few classes exploit this design mistake.</p></li>
<li><p>Various improvements for <code>FreemarkerServlet</code>:</p>
<ul>
<li><p>The data-model now uses automatic scope discovery, so writing <code>Application.attrName</code>, <code>Session.attrName</code>, <code>Request.attrName</code> is no longer mandatory; it's enough to write <code>attrName</code>. For more information <a href="#topic.servlet.scopeAttr">read this</a>.</p></li>
<li><p><code>FreemarkerServlet</code> now uses the encoding of the template file for the output, unless you specify the encoding in the <code>ContentType</code> init-param, such as <code>text/html;
                  charset=UTF-8</code>.</p></li>
<li><p>All <code>Configuration</code> level settings can by set with Servlet init-params (<code>template_exception_handler</code>, <code>locale</code>, <code>number_format</code>, etc.).</p></li>
<li><p>The object wrapper the servlet internally uses is now set as the default object wrapper for its <code>Configuration</code> instance.</p></li>
<li><p>It no longer forces session creation for requests that don't belong to an existing session, improving scalability.</p></li>
</ul></li>
<li><p>JDOM independent XML-wrapping: <code>freemarker.ext.xml.NodeListModel</code> is a re-implementation of <code>freemarker.ext.jdom.NodeListModel</code> that does not rely on JDOM; you don't need JDOM .jar anymore. The new <code>NodeListModel</code> automatically uses W3C DOM, dom4j, or JDOM, depending on which library is available (that is, depending on what object do you pass to its constructor).</p></li>
<li><p>Bugfix: <code>WebappTemplateLoader</code>: Template updating didn't worked correctly with Tomcat due the caching of resources. Now <code>WebappTemplateLoader</code> tries to access the resources directly as <code>File</code>, if it is possible, thus bypasses the caching.</p></li>
<li><p>Various bug-fixes for <code>FreemarkerServlet</code>:</p>
<ul>
<li><p>The servlet now loads the correct template if it was called through <code>RequestDispatcher.include</code>.</p></li>
<li><p>The caching of <code>HttpServletRequest</code> objects is now compliant with the servlet specification.</p></li>
<li><p><code>TemplateException</code>s was suppressed in certain situations resulting in half-rendered pages without error message.</p></li>
</ul></li>
<li><p>Bugfix: FreeMarker didn't work if the <code>javax.servlet</code> classes was not available, because <code>Configuration</code> explicitly referred to <code>javax.servlet.ServletContext</code>.</p></li>
<li><p>Bugfix: classes may were not found if they was available only in the <code>WEB-INF</code>, and FreeMarker tried to load the class dynamically.</p></li>
<li><p>Bugfix: the <code>Template</code> constructor (and thus <code>Configuration.getTemplate</code>) sometimes threw <code>TokenMgrError</code> (a non-checked exception) instead of <code>ParseException</code>.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>The Web application related examples has been replaced.</p></li>
</ul>
<h3>The history of the releases before the final version</h3>
<h4>Differences between the final and RC2 releases</h4>
<ul>
<li><p>You can load settings from <code>.properties</code> file with the <code>setSettings</code> method of <code>Configuration</code> and other <code>Configurable</code> subclasses.</p></li>
<li><p>New string built-in: <code>uncap_first</code></p></li>
<li><p>Bugfix: When exposing an XML document to a template and accessing it with XPath using Jaxen a <code>ClassCastException</code> has occurred.</p></li>
<li><p>Bugfix: The template cache has loaded templates with bad <code>Configuration</code> instance in certain situations if you use not the static default <code>Configuration</code> instance.</p></li>
</ul>
<h4>Differences between the RC2 and RC1 releases</h4>
<ul>
<li><p>Non backward compatible change!: <code>FreemarkerServlet</code> now uses the encoding of the template file for the output, unless you specify the encoding in the <code>ContentType</code> init-param, such as <code>text/html; charset=UTF-8</code>.</p></li>
<li><p>Non backward compatible change compared to RC1!: The <code>capture_output</code> transform creates variable in the current namespace (as <code>assign</code> directive) with the <code>var</code> parameter, not a global variable.</p></li>
<li><p>The new and preferred way of number formatting with <code>string</code> built-in is <code>foo?string(format)</code>, instead of the less natural <code>foo?string[format]</code>.</p></li>
<li><p>The <code>string</code> built-in works for boolean values. For example: <code>${spamFilter?string(&quot;enabled&quot;,
                &quot;disabled&quot;)}</code>. For more information <a href="#ref_builtin_string_for_boolean">read the reference</a>.</p></li>
<li><p>The default strings for outputting boolean value using the <code>string</code> built-in can be set using the <code>boolean_format</code> setting.</p></li>
<li><p>String literals can be quoted with apostrophe-quote. <code>&quot;foo&quot;</code> and <code>'foo'</code> are equivalent.</p></li>
<li><p>The new interface <code>freemarker.cache.CacheStorage</code> allows users to plug custom template caching strategies with the <code>cache_storage</code> setting. The core package now ships with two implementations: <code>SoftCacheStorage</code> and <code>StrongCacheStorage</code>. For more information read: <a href="#pgui_config_templateloading">section_title</a></p></li>
<li><p>You can set settings with string name and string value with the new <code>setSetting(String key, String
                value)</code> method of <code>Configurable</code> super-classes (as <code>Configuration</code>).</p></li>
<li><p>Other new <code>Configuration</code> methods: <code>getTemplateLoader</code>, <code>clone</code>.</p></li>
<li><p><code>assign</code>, <code>local</code> and <code>global</code> now can capture the output generated be the nested template fragment into the variable. This deprecates <code>capture_output</code> transform. More information: <a href="#ref.directive.assign">assign directive reference</a></p></li>
<li><p>Other new <code>Configuration</code> methods: <code>getTemplateLoader</code>, <code>clone</code>.</p></li>
<li><p>Changes to <code>TemplateTransformModel</code> interface: <code>getWriter</code> can throw <code>IOException</code>, and can return <code>null</code> if the transform does not support body content.</p></li>
<li><p>Till now <code>TemplateTransformModel.getWriter</code> has received null as parameter map if the transform was called without parameters. From now, it will receive an empty Map instead. Note that the previous API documentation didn't state that it always receives null if there are no parameters, so hopelessly only very few classes exploit this design mistake.</p></li>
<li><p>Changes to <code>TemplateControl</code> interface: <code>onStart</code> and <code>afterBody</code> methods are now allowed to throw <code>IOException</code>.</p></li>
<li><p>Path that contains <code>//:</code> is considered as absolute path.</p></li>
<li><p>New <a href="#ref_builtins_string">string built-ins</a>: <code>index_of</code>, <code>last_index_of</code>, <code>starts_with</code>, <code>ends_with</code>, <code>replace</code>, <code>split</code>, <code>chop_linebreak</code>.</p></li>
<li><p>New <a href="#ref_builtins_sequence">sequence built-ins</a>: <code>sort</code>, <code>sort_by</code>.</p></li>
<li><p>All <code>Configuration</code> level settings can by set with Servlet init-params (<code>template_exception_handler</code>, <code>locale</code>, <code>number_format</code>, etc.).</p></li>
<li><p>Bugfix: classes may were not found if they was available only in the <code>WEB-INF</code>, and FreeMarker tried to load the class dynamically.</p></li>
<li><p>Bugfix: <code>setLocalizedLookup(false)</code> of <code>Configuration</code> was overridden when you have called <code>setTemplateLoader</code>.</p></li>
<li><p>Bugfix: String concatenation had performance problem if there was multiple concatenations chained, as: <code>&quot;a&quot;+x+&quot;a&quot;+x+&quot;a&quot;+x+&quot;a&quot;+x+&quot;a&quot;+x</code>.</p></li>
<li><p>Bugfix: white-space stripping was not worked with tags spanning over multiple lines.</p></li>
<li><p>Bugfix: Removing several dependencies on JDK 1.3, so FreeMarker can be build for JDK 1.2.2.</p></li>
</ul>
<h4>Differences between the Preview 2 and RC1 releases</h4>
<ul>
<li><p><code>ftl</code> is now stricter, and does not allow custom parameters. To associate custom attributes to templates, we may add a new directive later, if there is a demand for it.</p></li>
<li><p><code>escape</code> directive does not affect numerical interpolations (<code>#{...}</code>) anymore, as it has caused errors with string escapes as <code>?html</code>.</p></li>
<li><p>The <code>normalizeName</code> method of <code>freemarker.cache.TemplateLoader</code> has been removed, because it has caused too many complications. Instead, normalization happens on a single point in the <code>TempateCache</code>. In consequence, FreeMarker is now stricter about the format of template paths, as things like <code>/../</code> are interpreted by the core.</p></li>
<li><p>Experimental feature: With the <code>setSimpleMapWrapper</code> method of <code>BeansWrapper</code> you can configure it to wrap <code>java.util.Map</code>-s as <code>TemplateHashModelEx</code>-s, and do not expose the methods of the object.</p></li>
<li><p>New <code>Configuration</code> methods: <code>set/getLocalizedLookup</code>, <code>clearTemplateCache</code>, <code>clearSharedVariables</code>.</p></li>
<li><p>More cleanups in the <code>Environment</code> API.</p></li>
<li><p>Better JSP standard compliance: JSP page-scope variables are the global variables that were created in the template (not the variables of the data-model).</p></li>
<li><p>JDOM independent XML-wrapping: <code>freemarker.ext.xml.NodeListModel</code> is a re-implementation of <code>freemarker.ext.jdom.NodeListModel</code> that does not rely on JDOM; you don't need JDOM .jar anymore. The new <code>NodeListModel</code> automatically uses W3C DOM, dom4j, or JDOM, depending on which library is available (that is, depending on what object do you pass to its constructor).</p></li>
<li><p>Bugfix: <code>WebappTemplateLoader</code>: Template updating didn't worked correctly with Tomcat due the caching of resources. Now <code>WebappTemplateLoader</code> tries to access the resources directly as <code>File</code>, if it is possible, thus bypasses the caching.</p></li>
<li><p>Bugfix: Templates loaded with <code>MultiTemplateLoader</code> subclasses was removed from the template cache after the template update delay has elapsed (5 seconds by default) even if the template file was unchanged. This can cause lot of extra load for a high-traffic server if you have many templates or if the template update delay was set to 0 second.</p></li>
<li><p>Bugfix: Undefined variables in hash and sequence constructors (as <code>[a, b, c]</code>) didn't caused errors.</p></li>
</ul>
<h4>Differences between the Preview 1 and Preview 2 releases</h4>
<ul>
<li><p>All 16-bit Unicode letters and numbers are allowed in identifiers, as well as the <code>$</code> character (as in Java programming language). Thus you can use accented letters, Arabic letters, Chinese letters, etc. as identifiers in templates</p></li>
<li><p>Macros now can create loop variables for the nested content. For more information <a href="#dgui_misc_userdefdir_loopvar">read this</a>.</p></li>
<li><p>New directives: <code>t</code>, <code>rt</code> and <code>lt</code> directives allow you to do explicit white-space removal in extreme FTL applications. For more information read <a href="#ref.directive.t">the reference</a>.</p></li>
<li><p>The syntax of assignment-with-namespace has changed from <code>&lt;#assign foo=123 namespace=myLib&gt;</code>) to <code>&lt;#assign foo=123 in myLib&gt;</code>, since the previous syntax was confusing because its similarity to a bulk-assignment.</p></li>
<li><p>Bulk assignments (as <code>&lt;#assign x=1, y=2,
                z=3&gt;</code>) no longer need colon to separate the assignments (as <code>&lt;#assign x=1 y=2
                z=3&gt;</code>), although it is still allowed to preserve backward compatibility.</p></li>
<li><p>Positional parameter passing is supported for macro calls as shorthand form of normal named parameter passing. For more details read <a href="#ref_directive_userDefined_positionalParam">read the reference</a>.</p></li>
<li><p>New built-in, <code>namespace</code>, to get the namespace of the currently executing macro.</p></li>
<li><p><code>TransformControl</code> interface (was experimental earlier): If the <code>Writer</code> returned by <code>TemplateTransformModel.getWriter</code> implements this interface, it can instruct the engine to skip or to repeat evaluation of the nested content, and gets notified about exceptions that are thrown during the nested content evaluation. For more information please read the API documentation.</p></li>
<li><p>Jython wrapper can now wrap arbitrary Java objects, not only <code>PyObject</code>-s. If an object is passed to the wrapper that is neither a <code>TemplateModel</code>, nor a <code>PyObject</code>, it is first coerced into a <code>PyObject</code> using Jython's own wrapping machinery, and then wrapped into a <code>TemplateModel</code> as any other <code>PyObject</code>.</p></li>
<li><p>Some cleanups in the <code>Environment</code> API.</p></li>
<li><p>The Web application related examples has been replaced.</p></li>
<li><p>Bugfix: Templates loaded with <code>URLTemplateLoader</code> subclasses was removed from the template cache after the template update delay has elapsed (5 seconds by default) even if the template file was unchanged. This can cause lot of extra load for a high-traffic server if you have many templates or if the template update delay was set to 0 second.</p></li>
<li><p>Bugfix: <code>FreeMarkerServlet</code> has thrown <code>ServletException</code> even if a debug <code>TemplateException</code> handler was in use (so you may got Error 500 page instead of debug information).</p></li>
</ul>
<h2 id="versions_2_1_5">2.1.5</h2>
<p>Date of release: 2003-02-08</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: Fixed a bug that forced the cache to frequently reload templates accessed through URL and multi template loaders: Templates loaded with <code>URLTemplateLoader</code> subclasses and <code>MultiTemplateLoader</code> was removed from the template cache after the template update delay has elapsed (5 seconds by default) even if the template file was unchanged. This can cause lot of extra load for a high-traffic server if you have many templates or if the template update delay was set to 0 second.)</p></li>
<li><p>Bugfix: Many anomalies in the <code>JythonWrapper</code> were resolved, making the integration with Jython much smoother: Jython wrapper can now wrap arbitrary Java objects, not only <code>PyObject</code>-s. If an object is passed to the wrapper that is neither a <code>TemplateModel</code>, nor a <code>PyObject</code>, it is first coerced into a <code>PyObject</code> using Jython's own wrapping machinery, and then wrapped into a <code>TemplateModel</code> as any other <code>PyObject</code>.</p></li>
</ul>
<h2 id="versions_2_1_4">2.1.4</h2>
<p>Date of release: 2002-12-26</p>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: Log4J is now found when automatically discovering the logging library to use.</p></li>
<li><p>Bugfix: An exception is no longer thrown in the static initializer of the <code>Configuration</code> if the directory specified in the <code>&quot;user.dir&quot;</code> system property is not readable.</p></li>
</ul>
<h2 id="versions_2_1_3">2.1.3</h2>
<p>Date of release: 2002-12-09</p>
<h3>Changes on the FTL side</h3>
<ul>
<li><p>Bugfix: <code>cap_first</code> built-in did what <code>double</code> built-in does.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>The official extension of FreeMarker template files is <code>ftl</code> from now, not <code>fm</code>. (This is the name of the template language; FTL, for FreeMarker Template Language.) Of course you can use any extensions, since FreeMarker does not deal with the file extension. But we recommend <code>ftl</code> extension as default.</p></li>
<li><p>Web application examples got tweaked again, as under JDK 1.4 a class in an explicit (named) package can no longer import classes from the default (unnamed) package. Our webapp example was using classes in the default package, they are now moved into named packages.</p></li>
</ul>
<h2 id="versions_2_1_2">2.1.2</h2>
<p>Date of release: 2002-11-28</p>
<h3>Changes in FTL (FreeMarker Template Language)</h3>
<ul>
<li><p><code>FreeMarkerServlet</code> now has a setting for the <code>Content-Type</code> header of the response, defaulting to <code>text/html</code>. Previously it set no content type, which made it not play nicely when integrated with software that expected it (i.e. OpenSymphony SiteMesh).</p></li>
<li><p><code>FreeMarkerServlet</code> now works correctly when mapped to an URL extension instead of URL path prefix.</p></li>
<li><p>You can emulate <code>include</code> directive call within Java code by calling <code>Environment.include(templateName,
              charset,
              parse)</code>.</p></li>
</ul>
<ul>
<li><p>Bugfix: When <code>Template.process()</code> was called from another template processing, it set <code>currentEnvironment</code> to null when it returned, thus crashed the parent template processing.</p></li>
<li><p>Bugfix: the <code>_descendant</code> key in JDOM support incorrectly left the document root element out of the result when applied to a Document node.</p></li>
<li><p>Bugfix: because we incorrectly assumed certain behavior of JDK 1.4 Beans introspector, calls to public interface methods on non-public classes that implement the interface were causing exceptions on JDK 1.4</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Various minor supplements to the manual.</p></li>
<li><p>Documentation HTML pages don't try to load the SourceForge logo from the Internet anymore.</p></li>
<li><p>The default ant target is <code>jar</code>, not <code>dist</code>.</p></li>
</ul>
<h2 id="versions_2_1_1">2.1.1</h2>
<p>Date of release: 2002-11-04</p>
<h3>Changes in FTL (FreeMarker Template Language)</h3>
<ul>
<li><p>Multi-type variables that are both string and number or string and date are now output using their number or date value instead of the string value when used in the <code>${...}</code> interpolation. This practically makes the string part of a string/number or a string/date variables useless.</p></li>
<li><p>Bugfix: operator “or” (<code>||</code>) worked wrongly when its left operand was a composite expression (e.g., the second <code>||</code> in <code>false ||
              true || false</code>; this was evaluated to <code>false</code>, but it should be <code>true</code>)</p></li>
<li><p>Bugfix: Less-than sign inside comments confused the FTL parser (e.g. <code>&lt;#-- blah &lt; blah --&gt;</code>); it commented out everything after the problematic comment.</p></li>
<li><p>Bugfix: Comparing two numerical constants (e.g. <code>3
              == 3</code>) caused internal error in the FTL parser, and aborted template processing with error.</p></li>
<li><p>Experimental date/time type support was removed, since it seems that this initial implementation was misguided. FreeMarker 2.2 will certainly support data/time.</p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p>Bugfix: <code>Number</code>s wrapped with <code>BEANS_WRAPPER</code> was displayed with the <code>toString()</code> method of wrapped object. Now they are rendered according to the <code>number_format</code> setting, because multi-type variables that are both string and number are now output using their number value instead of the string value.</p></li>
<li><p>Experimental date/time type support was removed, since it seems that this initial implementation was misguided. FreeMarker 2.2 will certainly support data/time.</p></li>
</ul>
<h2 id="versions_2_1">2.1</h2>
<p>Date of release: 2002-10-17</p>
<p>Templates and the Java API are <em>not</em> fully compatible with 2.0 releases. You will need to revisit existing code and templates, or use 2.1 for new projects only. Sorry for this inconvenience; FreeMarker has undergone some revolutionary changes since the 1.x series. We hope things will soon be sufficiently mature for us to offer (almost) backward-compatible releases. Note that there is a backward-compatibility flag that can be set via <code>Configuration.setClassicCompatible(true)</code> that causes the new FreeMarker to emulate most of FreeMarker 1.x's quirks.</p>
<h3>Changes in FTL (FreeMarker Template Language)</h3>
<ul>
<li><p>More strict, reveals accidental mistakes in the templates, prevents showing incorrect information when something went wrong:</p>
<ul>
<li><p>An attempt to access an undefined variable causes an error and aborts template processing (by default at least; see later). In earlier versions undefined variables were silently treated as empty (zero-length) strings. However, you can handle undefined variables in the template with some new built-ins. For example, <code>${foo?if_exists}</code> is equivalent with the <code>${foo}</code> of earlier versions. Another way of looking at this is that null values no longer exist from the viewpoint of a template designer. Anything referenced must be a defined variable.</p>
<p>Note however that the programmer can configure FreeMarker so that it ignores certain errors (say, undefined variables), and continues template processing by skipping the problematic part. This “loose” policy should be used only for sites that don't show critical information.</p></li>
<li><p>New variable type: <a href="#gloss.boolean">boolean</a>. Conditions in <code>if</code>/<code>elseif</code> and operands of logical operators (<code>&amp;&amp;</code>, <code>||</code>, <code>!</code>) must be booleans. Empty strings are no longer treated as a logical false.</p></li>
</ul></li>
<li><p>Local and global variables. More info: <a href="#dgui_misc_var">section_title</a></p>
<ul>
<li><p>Local variables for macros. You can create/replace local variables in macro definition bodies with the <a href="#ref.directive.local"><code>local</code> directive</a></p></li>
<li><p>You can create/replace global (non-local) variables with the <a href="#ref.directive.global"><code>global</code> directive</a></p></li>
</ul></li>
<li><p>The <a href="#ref.directive.include"><code>include</code></a> directive now by default treats the passed filename as being relative to the including template's path. To specify absolute template paths, you now have to prepend them with a slash.</p></li>
<li><p>The <a href="#ref.directive.include"><code>include</code></a> directive can now use the <em>acquisition algorithm</em> (familiar from the Zope system) to look up the template to include. Basically, if a template is not found where it is looked up first, it is looked up in parent directories. This is however not a default behavior, rather it is triggered by a new syntactic element.</p></li>
<li><p>Strict syntax mode: Allows you to generate arbitrary SGML (XML) without worrying about clashes with FreeMarker directives. For more information read: <a href="#ref_depr_oldsyntax">section_title</a></p></li>
<li><p>Terse comments: you can use <code>&lt;#--
              ... --&gt;</code> instead of <code>&lt;comment&gt;...&lt;/comment&gt;</code></p></li>
<li><p>Directive that you can use to change the locale (and other settings) inside the template: <a href="#ref.directive.setting"><code>setting</code></a></p></li>
<li><p>Directive to explicitly flush the output buffer: <a href="#ref.directive.flush"><code>flush</code></a></p></li>
<li><p>The top-level (root) hash is available via the variable <code>root</code>, which is now a reserved name.</p></li>
<li><p>The misnamed <code>function</code> directive has been renamed to <code>macro</code>.</p></li>
<li><p>String literals support various new <a href="#topic.escapeSequence">escape sequences</a>, including UNICODE escapes (<code>\xCODE</code>)</p></li>
<li><p>The <a href="#ref.directive.compress"><code>compress</code></a> directive is now more conservative in removing line breaks.</p></li>
<li><p>Built-in to capitalize the first word: <a href="#ref_builtin_cap_first"><code>cap_first</code></a></p></li>
<li><p>Built-in to generate on-the-fly templates: <a href="#ref_builtin_interpret"><code>interpret</code></a></p></li>
<li><p><a href="#ref.directive.stop"><code>stop</code></a> directive has an optional parameter to describe the reason of termination</p></li>
<li><p>Better error messages.</p></li>
<li><p>New variable type: date. <em>Date support is experimental. It can change substantially in the future. Keep this in mind if you use it.</em></p></li>
</ul>
<h3>Changes on the Java side</h3>
<ul>
<li><p><code>ObjectWrapper</code>: You can put non-<code>TemplateModel</code> objects directly into hashes, sequences and collections, and they will be automatically wrapped with the appropriate <code>TemplateModel</code> implementation. The API of objects that are exposed to templates (<code>SimpleXXX</code>) has been changed according to this, for example in <code>SimpleHash</code> the old <code>put(String key,
              TemplateModel value)</code> is now <code>put(String key,
              Object object)</code>. Also, you can pass any kind of object as data-model to <code>Template.process</code>. The alternative reflection based <code>ObjectWrapper</code> can expose the members of any Java object automatically for the designer. More information: <a href="#pgui_datamodel_objectWrapper">Object wrapping</a>, <a href="#pgui_misc_beanwrapper">Bean wrapper</a>, <a href="#pgui_misc_jythonwrapper">Jython wrapper</a>.</p></li>
<li><p>The <code>Configuration</code> object was introduced as a central point to hold all your FreeMarker-related global settings, as well as commonly used variables that you want to have available from any template. Also it encapsulates the template cache and can be used to load templates. For more information read <a href="#pgui_config">The Configuration</a>.</p></li>
<li><p><code>TemplateLoader</code>: pluggable template loader, separates caching from template loading</p></li>
<li><p><code>TemplateNumberModel</code>-s do not control their formatting anymore. They just store the data (i.e. a number). Number formatting is done by the FreeMarker core based on the <code>locale</code> and <code>number_format</code> settings. This logic applies to the new experimental date type as well.</p></li>
<li><p><code>TemplateBooleanModel</code> introduced: Only objects that implements this interface can be used as a boolean in true/false conditions. More info: <a href="#pgui_datamodel_scalar">section_title</a></p></li>
<li><p><code>TemplateDateModel</code> introduced: objects that implements this interface are recognized as dates and can be locale-sensitively formatted. <em>Date support is experimental in FreeMarker 2.1. It can change substantially in the future. Keep this in mind if you use it.</em></p></li>
<li><p>The <code>TemplateModelRoot</code> interface was deprecated. As of FreeMarker 2.1, you can simply use any instance of <code>TemplateHashModel</code> instead. This actually is due to a significant architectural change. Variables set or defined in a template are stored in a separate <code>Environment</code> object that only exists while the template is being rendered. Thus, the template doesn't modify the root hash.</p></li>
<li><p>Changes to transformations</p>
<ul>
<li><p>Completely rewritten <code>TemplateTransformModel</code> interface. More flexible, and does not impose output holding. More information: <a href="#pgui_datamodel_directive">section_title</a></p></li>
<li><p>The <code>transform</code> directive now takes an optional set of key/value pairs. <code>&lt;transform
                  myTransform;
                  key1=value1,
                  key2=value2
                  ...&gt;</code>. More information: <a href="#ref.directive.transform"><code>transform</code> directive</a></p></li>
<li><p>The transforms that ship with the FreeMarker core are now available by default to all templates - i.e. <code>&lt;transform html_escape&gt;</code> will invoke the <code>freemarker.template.utility.HtmlEscape</code> transform. More information: <a href="#pgui_config_sharedvariables">section_title</a></p></li>
</ul></li>
<li><p>User-defined <code>TemplateModel</code> objects now can access the runtime environment (read and set variables, get the current locale, etc.) using an <code>Environment</code> instance, which can be obtained by the static <code>Environment.getCurrentEnvironment()</code> method. As a result, <code>TemplateScalarModel.getAsString</code> has been changed: it has no locale parameter.</p></li>
<li><p><code>TemplateExceptionHandler</code>-s make it possible to define your own rules on what to do when a runtime error occurs (e.g. accessing a non existing variable) during template processing. For example, you can abort template processing (recommended for most sites), or skip the problematic statement and continue template processing (similar to old behavior). DebugMode has been removed, use <code>TemplateExceptionHandler.DEBUG_HANDLER</code> or <code>HTML_DEBUG_HANDLER</code> instead.</p></li>
<li><p>Logging: FreeMarker logs certain events (runtime errors for example). For more information read <a href="#pgui_misc_logging">section_title</a>.</p></li>
<li><p><code>SimpleIterator</code> was removed, but we provide a <code>TemplateCollectionModel</code> implementation: <code>SimpleCollection</code>.</p></li>
<li><p>Arithmetic engine is pluggable (<code>Configuration.setArithmeticEngine</code>). The core distribution comes with two engines: <code>ArithmeticEngine.BIGDECIMAL_ENGINE</code> (the default) that converts all numbers to <code>BigDecimal</code> and then operates on them, and <code>ArithmeticEngine.CONSERVATIVE_ENGINE</code> that uses (more-or-less) the widening conversions of Java language, instead of converting everything to <code>BigDecimal</code>.</p></li>
<li><p>Changes to <code>freemarker.ext.beans</code> package: The JavaBeans adapter layer has suffered several major changes. First, <code>BeansWrapper</code> is no longer a static utility class - you can now create instances of it, and every instance can have its own instance caching policy and security settings. These security settings are also new - you can now create JavaBeans wrappers that hide methods that are considered unsafe or inappropriate in a templating environment. By default, you can no longer call methods like <code>System.exit()</code> from the template (although you can manually turn off these safeguards). The <code>StaticModel</code> and <code>StaticModels</code> classes are gone; their functionality is now replaced with the <code>BeansWrapper.getStaticModels()</code> method.</p></li>
<li><p><code>freemarker.ext.jython</code> package: FreeMarker can now directly use Jython objects as data-models using the <a href="#pgui_misc_jythonwrapper">Jython wrapper</a>.</p></li>
<li><p>Changes to <code>freemarker.ext.jdom</code> package: The package now uses the <em>Jaxen</em> package instead of its predecessor, the <em>werken.xpath</em> package to evaluate XPath expressions. Since <em>Jaxen</em> is a successor to <em>werken.xpath</em>, this can be considered to be an upgrade. As a consequence, namespace prefixes are now recognized in XPath expressions and the overall XPath conformance is better.</p></li>
<li><p>Better error reporting: If the processing of a template is aborted by a <code>TemplateException</code> being thrown, or using a <code>&lt;#stop&gt;</code> directive, FreeMarker will now output an execution trace with line and column numbers relative to the template source.</p></li>
<li><p>The output is written to a simple <code>Writer</code>; no more <code>PrintWriter</code>. This redesign causes FreeMarker to no longer swallow <code>IOException</code>s during template processing.</p></li>
<li><p>Various API cleanups, primarily the removing of superfluous constructor and method overloads.</p></li>
</ul>
<h3>Other changes</h3>
<ul>
<li><p>Documentation has been rewritten from scratch</p></li>
</ul>
<h3>Differences between the RC1 and final release</h3>
<ul>
<li><p>Added the support for date models and locale-sensitive date formatting. <em>Date support is experimental in FreeMarker 2.1. It can change substantially in the future. Keep this in mind if you use it.</em></p></li>
<li><p>Added the <code>default</code> built-in which makes it possible to specify default values for undefined expressions.</p></li>
<li><p><code>SimpleIterator</code> has been removed, <code>SimpleCollection</code> has been introduced</p></li>
<li><p>Arithmetic engine is pluggable. The core now contains two arithmetic engines: <code>ArithmeticEngine.BIGDECIMAL_ENGINE</code> and <code>ArithmeticEngine.CONSERVATIVE_ENGINE</code>.</p></li>
<li><p><code>BeansWrapper</code> supports a new exposure level: <code>EXPOSE_NOTHING</code></p></li>
<li><p><code>Constants</code> interface was removed. <code>..._WRAPPER</code> constants have been moved from <code>Constants</code> to <code>ObjectWrapper</code>, <code>EMPTY_STRING</code> constant was moved to <code>TemplateScalarModel</code>, <code>NOTHING</code> constant was moved to <code>TemplateModel</code>, <code>TRUE</code> and <code>FALSE</code> constants were moved to <code>TemplateBooleanModel</code>.</p></li>
<li><p><code>JAVABEANS_WRAPPER</code> was renamed to <code>BEANS_WRAPPER</code></p></li>
<li><p><code>Configuration.get</code> and <code>put</code>, <code>putAll</code> were renamed to <code>getSharedVariable</code> and <code>setSharedVariable</code>, <code>setAllSharedVariables</code></p></li>
<li><p><code>Configuration.getClassicCompatibility</code>, <code>setClassicCompatibility</code> were renamed to <code>isClassicCompatible</code>, <code>setClassicCompatible</code></p></li>
<li><p><code>Template.process</code> method overloads with <code>useReflection</code> parameter was removed. But now we have <code>setObjectWrapper</code> method in the <code>Configuration</code>, so you can set the preferred root-object wrapper there.</p></li>
<li><p>Some superfluous method overloads were removed; these changes are backward compatible with RC1</p></li>
<li><p>Various minor JavaDoc and Manual improvements</p></li>
<li><p>Bugfix: <code>include</code> directive has calculated the base path of relative paths wrongly</p></li>
<li><p>Bugfix: We have accidentally used a J2SE 1.3 class, but FreeMarker 2.1 must able to run on J2SE 1.2</p></li>
</ul>
<h2 id="versions_2_01">2.01</h2>
<p>The main improvement is in error reporting. Now exceptions are much more informative since they come with complete line number and column information.</p>
<p>The only API change between 2.0 and 2.01 was the elimination of the CacheListener/CacheEvent API. Now, if the updating of a template file fails, the exception is thrown back to the caller to handle. If you want logging to occur when a template file is updated successfully, you can override the logFileUpdate() method in FileTemplateCache.</p>
<h2 id="versions_2_0">2.0</h2>
<p>FreeMarker 2.0 final was released on 18 April 2002. The changes with respect to the previous release, 2.0 RC3 are fairly minor.</p>
<h3>Bugfixes</h3>
<ul>
<li><p>There were a couple of bugs in handling null values, where Lazarus did not do the same thing as FreeMarker Classic. Traditionally, in FreeMarker, nulls were treated as being equivalent to an empty string in the appropriate context. At this point, to the best of our knowledge, there is backward compatibility with FreeMarker Classic in this respect.</p></li>
<li><p>Literal strings can now include line breaks. This was a backward compatibility issue with FreeMarker Classic that has been fixed.</p></li>
</ul>
<h3>Changes to the Template language</h3>
<ul>
<li><p>You can use the extra built-in of <code>myString?web_safe</code> to convert a string to its &quot;web-safe&quot; equivalent, where problematic characters such as '&lt;' are converted to &amp;lt;.</p></li>
<li><p>In displaying numbers with a fractional part, the rendering apparatus now respects the decimal separator of the template's locale, so that, for example, in continental Europe, you would see 1,1 and in the U.S. locale, 1.1.</p></li>
</ul>
<h3>Changes to the API</h3>
<ul>
<li><p>The <code>getAsString()</code> method in the <code>TemplateScalarModel</code> interface now takes a <code>java.util.Locale</code> as a parameter. For the most part, this is a hook for later use. In the default implementation, <code>SimpleScalar</code>, this parameter is unused. If you are implementing this interface yourself, your implementation may ignore the parameter. However, it will be appealing for certain implementations.</p></li>
<li><p>The constructors of <code>FileTemplateCache</code> have changed. If you are using an absolute directory on the file system as the location of your templates, you need to pass in an instance of <code>java.io.File</code> to indicate the location. If you use the constructors that take a string, this is taken to mean relative to the classloader classpath.</p></li>
</ul>
<h3>Miscellany</h3>
<p>The ant build script build.xml now contains a target that builds a .war file containing the Hello, World and Guestbook examples. It builds a fmexamples.war. For example, if you are using Tomcat in its out-of-the-box configuration, you would place this under &lt;TOMCAT_HOME&gt;/webapps and then you would use http://localhost:8080/fmexamples/servlet/hello and http://localhost:8080/fmexamples/servlet/guestbook for the Hello, World and Guestbook examples respectively.</p>
<h2 id="versions_2_0RC3">2.0 RC3</h2>
<p>FreeMarker 2.0 RC3 was released on 11 April 2002. This release was primarily devoted to fixing bugs that were reported in RC2.</p>
<h3>Bug Fixes</h3>
<ul>
<li><p>Variables defined in an &lt;include...&gt; were not available in the enclosing page. This has been fixed.</p></li>
<li><p>The JavaCC parser was not configured to handle Unicode input correctly. Now, Unicode support is working.</p></li>
<li><p>There was a bug when comparing a number with null. It should have returned false, but threw an exception instead. This has been fixed.</p></li>
</ul>
<h3>Changes to the Template Language</h3>
<ul>
<li><p>The syntax of the include directive has changed. To indicate an unparsed include file, you do as follows:</p>
<pre><code>&lt;include &quot;included.html&quot; ; parsed=&quot;n&quot; &gt;</code></pre>
<p>You can also indicate the encoding of the included file this way:</p>
<pre><code> &lt;include &quot;included.html&quot; ; encoding=&quot;ISO-8859-5&quot;&gt;</code></pre></li>
<li><p>The built-in myString?trim was added for trimming the leading and trailing white-space from strings.</p></li>
</ul>
<h3>API changes</h3>
<ul>
<li><p>The TemplateEventAdapter machinery was taken out. This was never set up in a very useful manner and we anticipate that version 2.1 will have more complete support for logging events.</p></li>
<li><p>The template caching mechanism was streamlined and simplified.</p></li>
<li><p>The FileTemplateCache can now be configured to load files relative to a class loader, using the Class.getResource() call. This allows templates to be bundled up in .jar files or in a .war file for easy deployment of web-based apps.</p></li>
</ul>
<h2 id="versions_2_0RC2">2.0 RC2</h2>
<p>FreeMarker 2.0 RC 2 was released on 4 April 2002. Here is a summary of changes wrt to the first release.</p>
<h3>Changes to Template Language</h3>
<ul>
<li><p>Certain built-in functionality is provided via a new operator, '?'. Thus, <code>myList?size</code> provides the number of elements in a list. Similarly, <code>myString?length</code> provides the length of a string, <code>myString?upper_case</code> puts the string all in capital letters, and <code>myHash?keys</code> provides a sequence containing the keys in the hash. See <a href="#ref_builtins">Built-in Reference</a> for list of all available built-ins.</p></li>
<li><p>Numerical comparisons can now be made using the &quot;natural&quot; operators &lt; and &gt; but there are also &quot;web-safe&quot; alternatives, such as <em>\lt</em> and <em>\gt</em>, since the use of these characters may confuse HTML editors and parsers. Note that these changed between rc1 and rc2, they now start with a backslash. A little asymmetry is the fact that if you use the natural greater-than or greater-than-or-equals operators (i.e. &gt; or &gt;=) the expression must be in parentheses. With any other operator, the parentheses are optional.</p></li>
<li><p>Within an iteration loop -- i.e. a <code>foreach</code> or a <code>list</code> block -- the current count in the loop is available as the special variable <code>index_count</code>. where index is the name of the variable in the iteration. A boolean variable called <code>index_has_next</code> is also defined that indicates whether there are any more items in the iteration after this one. Note that the index starts at zero, so you will often be adding one to it in practice.</p></li>
<li><p>The <code>&lt;#break&gt;</code> directive can now be used to break out of a <code>&lt;#foreach...&gt;</code> or a <code>&lt;list...&gt;</code> loop. (Prior to this version, it only worked within a switch-case block.) There is a new directive called <code>&lt;#stop&gt;</code> that, when encountered, simply halts processing of the template. This can be useful for debugging purposes.</p></li>
<li><p>When invoking java methods that have been exposed to the page, using the code in freemarker.ext.*, there are built-ins that allow you to indicate the numerical type that you wish to pass as the value. For instance, if you had two methods, one that takes an int and another that takes a long, and you wanted to pass in a value, you would have to specify which method. <code>myMethod(1?int)</code> or <code>myMethod(1?long)</code>. This is unnecessary if there is only one method of the given name.</p></li>
<li><p>Ranges can be used to get the sublist from a list or the substring of a string. For example: <code>myList[0..3]</code> will return items 0 through 3 of the list in question. Or, for example, you could get all the elements of the list except for the first and last ones via: <code>myList[1..(myList?size-2)]</code></p></li>
<li><p>Or we could get the first 6 characters of a string via <code>myString[0..5]</code></p></li>
<li><p>Lists can be concatenated using the '+' operator. Previously, this overloading of '+' only applied to strings.</p></li>
<li><p>An attempt to compare a number to a string now throws an exception, since it is indicative of a coding error. Note that there is a backward compatibility mode that can be set (see below) that loosens this up in order to be able to process legacy templates.</p></li>
</ul>
<h3>API Changes</h3>
<ul>
<li><p>The <code>TemplateSequenceModel</code> interface now has a <code>size()</code> method for getting the number of elements in the sequence in question.</p></li>
<li><p>The <code>TemplateModelIterator</code> interface now has a <code>hasNext()</code> method.</p></li>
<li><p>The default sequence and hash implementations, <code>freemarker.template.SimpleSequence</code> and <code>freemarker.template.SimpleHash</code> are now unsynchronized. If you need the methods to be synchronized, you can get a synchronized wrapper via the <code>synchronizedWrapper()</code> in either class.</p></li>
<li><p>The <code>freemarker.utility.ExtendedList</code> and <code>freemarker.utility.ExtendedHash</code> classes were removed, since all of the extra keys that it defined are now available using the appropriate '?' built-in operation, i.e. <code>myHash?keys</code> or <code>myList?size</code> or <code>myList?last</code>.</p></li>
<li><p>There is a method in <code>java.freemarker.Configuration</code> named <code>setDebugMode()</code> which allows you to decide whether stack traces are simply output to the web client (the best situation in development) or thrown back to the caller to be handled more gracefully (the best situation in production).</p></li>
<li><p>There is a flag that can be set to turn on a processing mode that is more backward-compatible with FreeMarker Classic. This is off by default, but you can set it via <code>Template.setClassicCompatibility(true)</code>. What this does is that it allows scalars to be treated as a single-item list in a list directive. Also, it allows somewhat more looseness about types. In FreeMarker 1.x, <code>&lt;#if
              x==&quot;1&quot;&gt;</code> and <code>&lt;#if x==1&gt;</code> were in fact equivalent. This meant that legacy templates might tend to be slack about this. If classic compatibility is not set, an attempt to compare the string &quot;1&quot; with the number 1 will result in an exception being thrown. (Note that it is preferable to get your templates working without the backward compatibility flag, since it usually will require only minor changes. However, for people with a lot of templates and no time to check over them, this flag may be of use.)</p></li>
</ul>
<h2 id="versions_2_0RC1">2.0 RC1</h2>
<p>The first public release of FreeMarker 2.0 was on 18 March 2002. Here is a summary of the changes in the Lazarus release, with respect to the last stable release of FreeMarker Classic.</p>
<p><em>NOTA BENE</em>:</p>
<p>Despite the changes delineated above, the Lazarus release is almost entirely backward-compatible with FreeMarker Classic. We believe that <em>most</em> existing code and templates that work under FreeMarker Classic will continue working under Lazarus, with at most minimal changes. In practice, the most common cases where legacy template code is broken will be where assumptions were made about numbers and strings being equivalent. Note that in FreeMarker 2, 2 + 2 does not result in &quot;22&quot;. The String &quot;1&quot; and the number 1 are entirely different animals and thus, any code will be broken if it relies on the boolean expression (&quot;1&quot;==1) being true. There is a &quot;classic compatibility mode&quot; that can be set via: <code>Template.setClassCompatibility()</code> that can be set so that Lazarus emulates some of the quirky behavior of FreeMarker Classic. However, any code that relied on the above &quot;features&quot; of FreeMarker classic really should be reworked. You are less likely to run into the other incompatibilities that are listed above. If you come across any other anomalies, please do tell us about them.</p>
<h3>Support for Numerical operations, both arithmetic and boolean, as well as numerical ranges.</h3>
<ul>
<li><p>Scalars can now be either strings or numbers. (In FreeMarker Classic all scalars were strings.) The basic operations allowed are addition, subtraction, multiplication, division, and modulus using the <code>+</code>, <code>-</code>, <code>*</code>, <code>/</code>, and <code>%</code> operators respectively. Arbitrary-precision arithmetic with integers and floating point numbers are provided. Though our goal is definitely to follow the principle of least surprise, for backward compatibility, the <code>+</code> operator still is used for string concatenation. If either the left hand side or the right hand side of <code>lhs + rhs</code> is non-numerical, we revert to interpreting this as string concatenation. Thus, in FreeMarker 2, 2+2 evaluates to the number 4, while any of &quot;2&quot;+2 or 2+&quot;2&quot; or &quot;2&quot;+&quot;2&quot; evaluate to the string &quot;22&quot;. In FreeMarker Classic, rather embarrassingly, all of the above, including 2+2, evaluated to the string &quot;22&quot;. An attempt to use any other arithmetic operator besides the <code>+</code> with non-numerical operands will cause an exception to be thrown.</p></li>
<li><p>Output of a numerical expression can be made explicit via the alternative <code>#{....}</code> syntax. If the expression within the curly parentheses does not evaluate to a numerical value, an exception is thrown. The older ${....} syntax can evaluate to either a number or a string. In general, if, for logical reasons, the output <em>must</em> be numerical, it is preferable to use the #{...} syntax, since it adds an extra sanity check. Note that if, by some miracle, the character sequence &quot;#{&quot; occurs in your template, you will have to use a workaround to prevent problems. (The &lt;noparse&gt; directive is one possibility.)</p></li>
<li><p>In this release, there is a facility for specifying the number of digits to show after the decimal point. The following code specifies to show at least 3 digits after the decimal point but not more than 6. This is optional. This option is only available if you use the #{...} syntax.</p>
<pre><code>#{foo + bar ; m3M6}  </code></pre>
<p>(Note that the above is something of a stopgap measure. Future releases will move toward supporting fully internationalization and localization of number and currency formatting.</p></li>
<li><p>Numerical expressions can be used in boolean expressions via the comparison operators: <code>lt</code>, <code>gt</code>, <code>lte</code>, and <code>gte</code>. In the web space, where FreeMarker is most used in practice, using the more natural operators such as &lt; and &gt; would tend to confuse HTML-oriented editors. An attempt to compare non-numerical expressions using these operators leads to a <code>TemplateException</code> being thrown. If, by some coincidence, you have variables named &quot;lt&quot;, &quot;gt&quot;, &quot;lte&quot;, or &quot;gte&quot;, you will have to change their names, since they are now keywords in the language.</p></li>
<li><p>Numerical ranges are supported.</p>
<pre><code>&lt;#list 1990..2001 as year&gt;
  blah blah in the year ${year} blah
&lt;/#list&gt; </code></pre>
<p>The left hand and right hand sides of the <code>..</code> operator must be numerical, or an exception is thrown. They also need not be literal numbers, but can be more complex expressions that evaluate to a numerical scalar value. Note that it is also possible to write a range that descends in value:</p>
<pre><code>&lt;#list 2001..1990 as year&gt;
  blah blah in the year ${year} blah blah
&lt;/#list&gt;  </code></pre></li>
</ul>
<h3>API Changes</h3>
<ul>
<li><p>The <code>TemplateNumberModel</code> interface and the <code>SimpleNumber</code> implementation were added to support exposing numerical values.</p></li>
<li><p>The <code>TemplateListModel</code> API in FreeMarker Classic had some design problems -- particularly in terms of supporting thread-safe code. It has been deprecated in favor of the following API's: <code>TemplateCollectionModel</code> and <code>TemplateSequenceModel</code>. The <code>SimpleList</code> class was refactored to implement the above interfaces (and paradoxically, does not implement the TemplateListModel interface.) Code that uses the deprecated <code>TemplateListModel</code> should be refactored.</p></li>
<li><p>The Expose Package by Attila Szegedi has been made an integral part of the FreeMarker distribution and is now under the freemarker.ext.* hierarchy. This package provides advanced models for representing arbitrary Java objects as template models, for representing XML documents as template models, as well as classes to facilitate the integration of FreeMarker with servlets and Ant.</p></li>
<li><p>In FreeMarker Classic, there were some utility classes such as <code>freemarker.template.utility.Addition</code> etcetera that existed as workarounds for the lack of numerical operations in FreeMarker. Those have been removed and will probably not be missed.</p></li>
<li><p>In FreeMarker Classic, the <code>SimpleScalar</code> object was mutable, it had a <code>setValue</code> method. This was fairly obviously a design mistake. Any code that relied on this must be refactored. Note that in this release, both <code>SimpleScalar</code> and the newly introduced <code>SimpleNumber</code> are both immutable and final.</p></li>
</ul>
<h3>Syntactical Miscellany</h3>
<ul>
<li><p>The if-elseif-else syntax was introduced. FreeMarker classic only had if-else. This construct should probably (in the opinion of the author of this document -- Revusky) be used in preference to switch-case since the switch-case with fall-through is a notoriously error-prone construct for most mortal men.</p></li>
<li><p>You can now do a multiple assignment in one &lt;assign...&gt; directive. For example: <code>&lt;assign x
              = 1, y = price*items, message=&quot;foo&quot;&gt;</code></p></li>
<li><p>A scalar will no longer be interpreted as a one-item list in a &lt;list...&gt; or &lt;#foreach...&gt; block. If you have code that relied on this feature, there is an easy workaround, since you can simply define a list literal with exactly one item.</p>
<pre><code> &lt;assign y=[x]&gt;
 and then...
 &lt;list y as item&gt;...&lt;/list&gt; </code></pre></li>
</ul>
<h1 id="app_install">Installing FreeMarker</h1>
install
<p>No real installation is needed. Simply ensure that <code>freemarker.jar</code> is somewhere where your Java application's class-loader will find it. In web application this usually means putting <code>freemarker.jar</code> into the <code>WEB-INF/lib</code> directory of your web application. (If you want to use FreeMarker with JSP Model-2 style (which also means that you can use custom JSP taglibs in the templates), some extra steps needed. For more information please see <a href="#pgui_misc_servlet">the chapter about servlets</a>.)</p>
<p>FreeMarker has no required dependencies. But to use certain <em>optional</em> FreeMarker features, the related party libraries have to be available for the class-loader:</p>
<ul>
<li><p>Jaxen (recommended, <a href="http://jaxen.org/">download here</a>) or Apache Xalan is needed for XML XPath support. Please use at least Jaxen 1.1-beta-8, not older versions! Apache Xalan classes are included in a package-relocated form in Sun/Oracle J2SE 1.4-1.8 (maybe later too), and FreeMarker will use those if it doesn't find Jaxen or Xalan elsewhere. But as Oracle can change these internal packages anytime, it's still recommended to use an external Jaxen or Xalan.</p></li>
<li><p>Obviously, <code>javax.servlet</code> classes are needed for <code>FreemarkerServlet</code>. Servlet version 2.2 or later is needed.</p></li>
<li><p>For the custom JSP taglib support, you will need JSP 2.0 API or later avilable. No JSP implementation is needed, just the API. This is already present in pretty much every servlet container. For more information please see <a href="#pgui_misc_servlet">the chapter about servlets</a>.</p></li>
<li><p>Jython 2.0 or later classes are needed for the Jython wrapper.</p></li>
<li><p>Pre-1.0 JDOM is needed for the long deprecated <code>freemarker.ext.jdom</code> package. (When it was created, there was no JDOM 1.0 yet.)</p></li>
</ul>
<h1 id="app_legal">Legal</h1>
<h2 id="app_license">License</h2>
license
<pre><code>                                 Apache License
                           Version 2.0, January 2004
                        http://www.apache.org/licenses/

   TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION

   1. Definitions.

      &quot;License&quot; shall mean the terms and conditions for use, reproduction,
      and distribution as defined by Sections 1 through 9 of this document.

      &quot;Licensor&quot; shall mean the copyright owner or entity authorized by
      the copyright owner that is granting the License.

      &quot;Legal Entity&quot; shall mean the union of the acting entity and all
      other entities that control, are controlled by, or are under common
      control with that entity. For the purposes of this definition,
      &quot;control&quot; means (i) the power, direct or indirect, to cause the
      direction or management of such entity, whether by contract or
      otherwise, or (ii) ownership of fifty percent (50%) or more of the
      outstanding shares, or (iii) beneficial ownership of such entity.

      &quot;You&quot; (or &quot;Your&quot;) shall mean an individual or Legal Entity
      exercising permissions granted by this License.

      &quot;Source&quot; form shall mean the preferred form for making modifications,
      including but not limited to software source code, documentation
      source, and configuration files.

      &quot;Object&quot; form shall mean any form resulting from mechanical
      transformation or translation of a Source form, including but
      not limited to compiled object code, generated documentation,
      and conversions to other media types.

      &quot;Work&quot; shall mean the work of authorship, whether in Source or
      Object form, made available under the License, as indicated by a
      copyright notice that is included in or attached to the work
      (an example is provided in the Appendix below).

      &quot;Derivative Works&quot; shall mean any work, whether in Source or Object
      form, that is based on (or derived from) the Work and for which the
      editorial revisions, annotations, elaborations, or other modifications
      represent, as a whole, an original work of authorship. For the purposes
      of this License, Derivative Works shall not include works that remain
      separable from, or merely link (or bind by name) to the interfaces of,
      the Work and Derivative Works thereof.

      &quot;Contribution&quot; shall mean any work of authorship, including
      the original version of the Work and any modifications or additions
      to that Work or Derivative Works thereof, that is intentionally
      submitted to Licensor for inclusion in the Work by the copyright owner
      or by an individual or Legal Entity authorized to submit on behalf of
      the copyright owner. For the purposes of this definition, &quot;submitted&quot;
      means any form of electronic, verbal, or written communication sent
      to the Licensor or its representatives, including but not limited to
      communication on electronic mailing lists, source code control systems,
      and issue tracking systems that are managed by, or on behalf of, the
      Licensor for the purpose of discussing and improving the Work, but
      excluding communication that is conspicuously marked or otherwise
      designated in writing by the copyright owner as &quot;Not a Contribution.&quot;

      &quot;Contributor&quot; shall mean Licensor and any individual or Legal Entity
      on behalf of whom a Contribution has been received by Licensor and
      subsequently incorporated within the Work.

   2. Grant of Copyright License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      copyright license to reproduce, prepare Derivative Works of,
      publicly display, publicly perform, sublicense, and distribute the
      Work and such Derivative Works in Source or Object form.

   3. Grant of Patent License. Subject to the terms and conditions of
      this License, each Contributor hereby grants to You a perpetual,
      worldwide, non-exclusive, no-charge, royalty-free, irrevocable
      (except as stated in this section) patent license to make, have made,
      use, offer to sell, sell, import, and otherwise transfer the Work,
      where such license applies only to those patent claims licensable
      by such Contributor that are necessarily infringed by their
      Contribution(s) alone or by combination of their Contribution(s)
      with the Work to which such Contribution(s) was submitted. If You
      institute patent litigation against any entity (including a
      cross-claim or counterclaim in a lawsuit) alleging that the Work
      or a Contribution incorporated within the Work constitutes direct
      or contributory patent infringement, then any patent licenses
      granted to You under this License for that Work shall terminate
      as of the date such litigation is filed.

   4. Redistribution. You may reproduce and distribute copies of the
      Work or Derivative Works thereof in any medium, with or without
      modifications, and in Source or Object form, provided that You
      meet the following conditions:

      (a) You must give any other recipients of the Work or
          Derivative Works a copy of this License; and

      (b) You must cause any modified files to carry prominent notices
          stating that You changed the files; and

      (c) You must retain, in the Source form of any Derivative Works
          that You distribute, all copyright, patent, trademark, and
          attribution notices from the Source form of the Work,
          excluding those notices that do not pertain to any part of
          the Derivative Works; and

      (d) If the Work includes a &quot;NOTICE&quot; text file as part of its
          distribution, then any Derivative Works that You distribute must
          include a readable copy of the attribution notices contained
          within such NOTICE file, excluding those notices that do not
          pertain to any part of the Derivative Works, in at least one
          of the following places: within a NOTICE text file distributed
          as part of the Derivative Works; within the Source form or
          documentation, if provided along with the Derivative Works; or,
          within a display generated by the Derivative Works, if and
          wherever such third-party notices normally appear. The contents
          of the NOTICE file are for informational purposes only and
          do not modify the License. You may add Your own attribution
          notices within Derivative Works that You distribute, alongside
          or as an addendum to the NOTICE text from the Work, provided
          that such additional attribution notices cannot be construed
          as modifying the License.

      You may add Your own copyright statement to Your modifications and
      may provide additional or different license terms and conditions
      for use, reproduction, or distribution of Your modifications, or
      for any such Derivative Works as a whole, provided Your use,
      reproduction, and distribution of the Work otherwise complies with
      the conditions stated in this License.

   5. Submission of Contributions. Unless You explicitly state otherwise,
      any Contribution intentionally submitted for inclusion in the Work
      by You to the Licensor shall be under the terms and conditions of
      this License, without any additional terms or conditions.
      Notwithstanding the above, nothing herein shall supersede or modify
      the terms of any separate license agreement you may have executed
      with Licensor regarding such Contributions.

   6. Trademarks. This License does not grant permission to use the trade
      names, trademarks, service marks, or product names of the Licensor,
      except as required for reasonable and customary use in describing the
      origin of the Work and reproducing the content of the NOTICE file.

   7. Disclaimer of Warranty. Unless required by applicable law or
      agreed to in writing, Licensor provides the Work (and each
      Contributor provides its Contributions) on an &quot;AS IS&quot; BASIS,
      WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
      implied, including, without limitation, any warranties or conditions
      of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
      PARTICULAR PURPOSE. You are solely responsible for determining the
      appropriateness of using or redistributing the Work and assume any
      risks associated with Your exercise of permissions under this License.

   8. Limitation of Liability. In no event and under no legal theory,
      whether in tort (including negligence), contract, or otherwise,
      unless required by applicable law (such as deliberate and grossly
      negligent acts) or agreed to in writing, shall any Contributor be
      liable to You for damages, including any direct, indirect, special,
      incidental, or consequential damages of any character arising as a
      result of this License or out of the use or inability to use the
      Work (including but not limited to damages for loss of goodwill,
      work stoppage, computer failure or malfunction, or any and all
      other commercial damages or losses), even if such Contributor
      has been advised of the possibility of such damages.

   9. Accepting Warranty or Additional Liability. While redistributing
      the Work or Derivative Works thereof, You may choose to offer,
      and charge a fee for, acceptance of support, warranty, indemnity,
      or other liability obligations and/or rights consistent with this
      License. However, in accepting such obligations, You may act only
      on Your own behalf and on Your sole responsibility, not on behalf
      of any other Contributor, and only if You agree to indemnify,
      defend, and hold each Contributor harmless for any liability
      incurred by, or claims asserted against, such Contributor by reason
      of your accepting any such warranty or additional liability.

   END OF TERMS AND CONDITIONS

   APPENDIX: How to apply the Apache License to your work.

      To apply the Apache License to your work, attach the following
      boilerplate notice, with the fields enclosed by brackets &quot;[]&quot;
      replaced with your own identifying information. (Don&#39;t include
      the brackets!)  The text should be enclosed in the appropriate
      comment syntax for the file format. We also recommend that a
      file or class name and description of purpose be included on the
      same &quot;printed page&quot; as the copyright notice for easier
      identification within third-party archives.

   Copyright [yyyy] [name of copyright owner]

   Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
   you may not use this file except in compliance with the License.
   You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

   Unless required by applicable law or agreed to in writing, software
   distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
   See the License for the specific language governing permissions and
   limitations under the License.

==============================================================================
END LICENSE


Historical notes
----------------

FreeMarker 1.x was released under the LGPL license. Later, by
community consensus, we have switched over to a BSD-style license. As
of FreeMarker 2.2pre1, the original author, Benjamin Geer, has
relinquished the copyright in behalf of Visigoth Software Society.

With FreeMarker 2.3.21 the license has changed to Apache License,
Version 2.0, and the owner has changed from Visigoth Software Society
to three of the FreeMarker 2.x developers, Attila Szegedi, Daniel
Dekany, and Jonathan Revusky.

After FreeMarker 2.3.24-pre01 (2015-09-02), the owner changes to the
Apache Software Foundation.</code></pre>
<h2 id="app_eccn">Export Control</h2>
<p>The FreeMarker source code doesn't include cryptography. Furthermore its binary (downloadable) forms don't include any cryptography software. Hence, FreeMarker has no Export Control Classification Number (ECCN). Where an ECCN should be filled, the label &quot;not subject to EAR&quot; could be used.</p>
<p>FreeMarker itself doesn't add any exporting limitations.</p>
<h1 id="gloss"></h1>
Start-tag
<p><a href="#gloss.tag">Tag</a>, which indicates that the following content is under the element, up to the <a href="#gloss.endTag">end-tag</a>. The start-tag may also specifies <a href="#gloss.attribute">attributes</a> for the element. An example of a start-tag: <code>&lt;body
        bgcolor=black&gt;</code></p>
Boolean
<p>This is a variable type. A boolean variable represents a logical true or false (yes or no). For example, if the visitor has been logged in or not. There are only two possible boolean values: <code>true</code> and <code>false</code>. Typically, you will use booleans with an <code>&lt;#if
        ...&gt;</code> directive when you want to display text based on some condition, say, you show a certain part of the page only for visitors who has logged in.</p>
Character
<p>A symbol that people use in writing. Examples of characters: Latin capital letter A (“A”), Latin small letter A (“a”), digit four (“4”), number sign (“#”), colon (“:”)</p>
Charset
<p>A charset is a rule (algorithm) for transforming a sequence of <a href="#gloss.character">characters</a> (text) to a sequence of bits (or in practice, to a sequence of bytes). Whenever a character sequence is stored on a digital media, or sent through a digital channel (network), a charset must be applied. Examples of charsets are ISO-8859-1, ISO-8859-6, Shift_JIS , UTF-8.</p>
<p>The capabilities of different charsers are different, that is, not all charsets can be used for all languages. For example ISO-8859-1 can't represent Arabic letters, but ISO-8859-6 can, however it can't represent the accented letters that that ISO-8859-1 can. Most charsets are highly restrictive regarding the allowed characters. UTF-8 allows virtually all possible characters, but most text editors can't handle it yet (2004).</p>
<p>When different software components exchange text (as the HTTP server and the browser, or the text editor you use for saving templates and FreeMarker who loads them), it's very important that they agree in the charset used for the binary encoding of the text. If they don't, then the binary data will be misinterpreted by the receiver (loader) component, which usually results in the distortion of the non-English letters.</p>
Output encoding
<p>Means output <a href="#gloss.charset">charset</a>. In the Java world the term “encoding” is commonly (mis)used as a synonym to charset.</p>
Template encoding
<p>Means template <a href="#gloss.charset">charset</a>. In the Java world the term “encoding” is commonly (mis)used as a synonym to charset.</p>
Collection
<p>A variable that (in conjunction with the <code>list</code> directive) can spit out a series of variables.</p>
Data-model
<p>Something that holds the information the template has to show (or use in some other ways) when the template processor assembles the output (e.g. a Web page). In FreeMarker this is best visualized as a tree.</p>
Directive
<p>Instructions to FreeMarker used in <a href="#gloss.FTL">FTL</a> <a href="#gloss.template">templates</a>. They are invoked by <a href="#gloss.FTLTag">FTL tags</a>.</p>
<p>See also .</p>
<p>See also .</p>
Element
<p>Elements are the most fundamental building pieces of <a href="#gloss.SGML">SGML</a> documents; an SGML document is basically a tree of elements. Example of elements used in HTML: body, head, title, p, h1, h2.</p>
End-tag
<p><a href="#gloss.tag">Tag</a>, which indicates that the following content is not under the element. Example: <code>&lt;/body&gt;</code>.</p>
<p>See also .</p>
Environment
<p>An <code>Environment</code> object stores the runtime state of a single template <a href="#gloss.templateProcessingJob">template processing job</a>. That is, for each <code>Template.process(...)</code> call, an <code>Environment</code> instance will be created, and then discarded when <code>process</code> returns. This object stores the set of temporary variables created by the template, the value of settings set by the template, the reference to the data-model root, etc. Everything that is needed to fulfill the template processing job.</p>
Extensible Markup Language
<p>A subset (restricted version) of <a href="#gloss.SGML">SGML</a>. This is less powerful than SGML, but it easier to learn and much easier to process with programs. If you are an HTML author: XML documents are similar to HTML documents, but the XML standard doesn't specify the usable elements. XML is a much more general-purpose thing than HTML. For example you can use XML to describe Web pages (like HTML) or to describe non-visual information like a phone book database.</p>
<p>See also SGML.</p>
FreeMarker Template Language
<p>Simple programming language designed to write text file templates, especially HTML templates.</p>
FTL
<p>See .</p>
FTL tag
<p><a href="#gloss.tag">Tag</a>-like text fragment used to invoke FreeMarker <a href="#gloss.directive">directives</a> in <a href="#gloss.FTL">FTL</a> <a href="#gloss.template">templates</a>. These are similar to HTML or XML tags at the first glance. The most prominent difference is that the tag name is started with <code>#</code> or <code>@</code>. Another important difference is that FTL tags do not use <a href="#gloss.attribute">attributes</a>, but a substantially different syntax to specify parameters. Examples of FTL tags: <code>&lt;#if newUser&gt;</code>, <code>&lt;/#if&gt;</code>, <code>&lt;@menuitem
        title=&quot;Projects&quot; link=&quot;projects.html&quot;/&gt;</code></p>
Function definition body
<p>The template fragment between the <code>&lt;#function
        ...&gt;</code> and <code>&lt;/#function&gt;</code>. This template fragment will be executed when you call the function (for example as <code>myFuction(1, 2)</code>).</p>
Hash
<p>A variable that acts as a container that stores sub variables that can be retrieved via a string that is a lookup name.</p>
<p>See also .</p>
Line break
<p>Line break is a special character (or a sequence of special characters) that causes a line breaking when you see the text as plain text (say, when you read the text with Windows notepad). Typically you type this character by hitting ENTER or RETURN key. The line break is represented with different characters on different platforms (to cause incompatibility and confusion...): “line feed” character on UNIX-es, “carriage return” character on Macintosh, “carriage return” + “line feed” (two characters!) on Windows and DOS. Note that line breaks in HTML do not have a visual effect when viewed in a browser; you must use markup such as <code>&lt;BR&gt;</code> for that. This manual never means <code>&lt;BR&gt;</code> when it says “line-break”.</p>
Macro definition body
<p>The template fragment between the <code>&lt;#macro
        ...&gt;</code> and <code>&lt;/#macro&gt;</code>. This template fragment will be executed when you call the macro (for example as <code>&lt;@myMacro/&gt;</code>).</p>
Markup output value
<p>A value with FTL type “markup output”. This type is related to <a href="#dgui_misc_autoescaping">auto-escaping mechanism</a>; you can <a href="#dgui_misc_autoescaping_movalues">read about this type there</a>. But in short, this is a value that stores text that's already in the output markup format (like HTML, XML, RTF, etc.), and hence must not be auto-escaped.</p>
Method
<p>A variable that calculates something based on parameters you give, and returns the result.</p>
MVC pattern
<p>MVC stands for Model View Controller. It's a design pattern started his life in the 70's as a framework developer by Trygve Reenskaug for Smalltalk, and was used primary for for UI-s (user interfaces). MVC considers three roles:</p>
<ul>
<li><p>Model: Model represents application (domain) specific information in a non-visual way. For example, an array of product objects in the memory of your computer is the part of the model.</p></li>
<li><p>View: View displays the model and provides UI. For example, it's the task of the view component to render the array of product objects to a HTML page.</p></li>
<li><p>Controller: The controller handles user input, modifies the model, and ensures that the view is updated when needed. For example it is the task of controller to take the incoming HTTP requests, parse the received parameters (forms), dispatch the requests to the proper business logic object, and chose the right template for the HTTP response.</p></li>
</ul>
<p>The most important thing for us when applying MVC for Web applications is the separation of View from the other two roles. This allows the separation of designers (HTML authors) from programmers. Designers deal with the visual aspects, programmers deal with the application logic and other technical issues; everybody works on what he is good at. Designers and programmers are less dependent on each other. Designers can change the appearance without programmers having to change or recompile the program.</p>
<p>For more information I recommend reading <a href="http://java.sun.com/blueprints/guidelines/designing_enterprise_applications_2e/web-tier/web-tier5.html">chapter 4.4</a> of Designing Enterprise Applications with the J2EE Platform blueprint.</p>
Parse-time error
<p>An error occurring during the template parsing phase, as opposed to the later template execution phase (see more explanation below). The presence of a such error prevents the execution of the whole template, even if the execution wouldn't use the part where the error is. This is seen as an advantage, as it helps early (before deployment, ideally in-editor) error detection.</p>
<p>A FreeMarker template is processed in two phases. First the <em>whole</em> template is analyzed syntactically, which is called parsing. The result of the parsing is a <code>Template</code> Java object, which is usually cached for fast reuse. Later, the already parsed template can be executed for unlimited times to produce output based on the content of a <a href="#gloss.dataModel">data-model</a>. Errors occurring during the parsing are called parse-time errors.</p>
Predefined directive
<p>Directive what is defined by FreeMarker, thus always available. Example of predefined directives: <code>if</code>, <code>list</code>, <code>include</code></p>
<p>See also .</p>
Scalar
<p>A scalar variable stores a single value. A scalar is either a string or a number or a date/time or a <a href="#gloss.boolean">boolean</a>.</p>
Sequence
<p>A sequence is a variable that contains a sequence of sub variables. The sequence's sub variables are accessible via numerical index, where the index of the very first object is 0, the index of the second objects is 1, the index of the third object is 2, etc.</p>
<p>See also .</p>
Regular expression
<p>A regular expression is a string that specifies a set of strings that matches it. For example, the regular expression <code>&quot;fo*&quot;</code> matches <code>&quot;f&quot;</code>, <code>&quot;fo&quot;</code>, <code>&quot;foo&quot;</code>, etc. Regular expressions are used in several languages and other tools. In FreeMarker, the usage of them is a “power user” option. So if you have never used them before, there is no need to worry about not being familiar with them. But if you are interested in regular expressions, you can find several Web pages and books about them. FreeMarker uses the variation of regular expressions described at: <a href="http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html" class="uri">http://docs.oracle.com/javase/7/docs/api/java/util/regex/Pattern.html</a></p>
SGML
<p>See .</p>
Standard Generalized Markup Language
<p>This is an international standard (ISO 8879) that specifies the rules for the creation of platform-independent markup languages. HTML is a markup language created with SGML. <a href="#gloss.XML">XML</a> is a subset (restricted version) of SGML.</p>
<p>See also XML.</p>
String
<p>A sequence of <a href="#gloss.character">characters</a> such as “m”, “o”, “u”, “s”, “e”.</p>
Tag
<p>Text fragment indicating the usage of an element in SGML. Examples of tags: <code>&lt;body bgcolor=black&gt;</code>, <code>&lt;/body&gt;</code></p>
<p>See also .</p>
<p>See also .</p>
Template
<p>A template is a text file with some special character sequences embedded into it. A template processor (e.g. FreeMarker) will interpret special character sequences and it outputs a more or less different text from the original text file, where the differences are often based on a <a href="#gloss.dataModel">data-model</a>. Thus, the original text acts as a template of the possible outputs.</p>
Template processing job
<p>A template processing job is the process during which FreeMarker merges the main (top-level) template with a data-model to produce the output. Because templates can <code>include</code> and <code>import</code> other templates, this may involves the processing of multiple templates, but those will all belong to the same template processing job, which was started with the processing of the main template. A template-processing job only exists for the short time period until the processing of the main template is finished, and then it vanishes with all the variables created during the process (variables created with <code>assign</code>, <code>macro</code>, <code>global</code>, etc. directives).</p>
Transform
<p>This term refers to user-defined directives that are implemetned with the now obsolete <code>TemplateTransformModel</code> Java interface. The feature was originally made for implementing output filters, hence the name.</p>
Thread-safe
<p>An object is thread-safe if it is safe to call its methods from multiple threads, even in parallel (i.e. multiple threads execute the methods of the object at the same time). Non-thread-safe objects may behave unpredictably in this situation, and generate wrong results, corrupt internal data structures, etc. Thread-safety is typically achieved in two ways with Java: with the usage <code>synchronized</code> statement (or <code>synchronized</code> methods), and with the immutability of encapsulated data (i.e. you can't modify the field after you have created the object).</p>
User-defined directive
<p>Directive that is not defined by the FreeMarker core, but by the user. These are typically application domain specific directives, like pull-down menu generation directives, HTML form handling directives.</p>
<p>See also .</p>
UCS
<p>This is international standard (ISO-10646) that defines a huge set of <a href="#gloss.character">characters</a> and assigns a unique number for each character (“!” is 33, ..., “A” is 61, “B” is 62, ..., Arabic letter hamza is 1569... etc.). This character set (not charset) contains almost all characters used today (Latin alphabet, Cyrillic alphabet, Chinese letters, etc.). The idea behind UCS is that we can specify any character with a unique number, not mater what the platform or the language is.</p>
<p>See also .</p>
Unicode
<p>De-facto standard developed by Unicode organization. It deals with the classification of the characters in <a href="#gloss.UCS">UCS</a> (which is letter, which is digit, which is uppercase, which is lowercase, etc.), and with other problems of processing text made from the characters of UCS (e.g. normalization).</p>
White-space
<p>Characters that are totally transparent but have impact on the visual appearance of the text. Examples of white-space characters: space, tab (horizontal and vertical), line breaks (CR and LF), form feed.</p>
<p>See also .</p>
XML
<p>See .</p>
Attribute
<p>In connection with <a href="#gloss.XML">XML</a> or HTML (or <a href="#gloss.SGML">SGML</a> in general), attributes are the named values associated with elements. For example, in <code>&lt;body bgcolor=black
        text=green&gt;...&lt;/body&gt;</code>, the attributes are <code>bgcolor=black</code> and <code>text=green</code>. On the left side of <code>=</code> is the name of the attribute, while on the right side is the value of the attribute. Note that in XML, the values must be quoted (for example: <code>&lt;body bgcolor=&quot;black&quot;
        text='green'&gt;</code>), while in HTML it is optional for certain values.</p>
<p>See also .</p>
Full-qualified name
<p>... of nodes (XML node or other FTL node variable): The full-qualified name of a node specifies not only the node name (<code>node?node_name</code>), but also the node namespace (<code>node?node_namespace</code>), this way it unambiguously identify a certain kind of node. The format of the full-qualified name is <code>nodeName</code> or <code>prefix:nodeName</code>. The prefix is shorthand to identify the node namespace (the a node namespace is usually specified with a long ugly URI). In FTL, prefixes are associated with the node namespaces with the <code>ns_prefixes</code> parameter of <a href="#ref.directive.ftl">the <code>ftl</code> directive</a>. In XML files, prefixes are associated with the node namespaces with the <code>xmlns:prefix</code> attributes. The lack of the prefix means that the node uses the default node namespace, if a default node namespace is defined; otherwise it means that the node does not belong to any node namespace. The default node namespace is defined in FTL by registering reserved prefix <code>D</code> with the <code>ns_prefixes</code> parameter of the <code>ftl</code> directive. In XML files it is defined with attribute <code>xmlns</code>.</p>
<p>... of Java classes: The full-qualified name of a Java class contains both the class name and the name of the package the class belongs to. This way it unambiguously specifies the class, regardless of the context. An example of full-qualifed class name: <code>java.util.Map</code> (as opposed to <code>Map</code>).</p>
</body>
</html>
